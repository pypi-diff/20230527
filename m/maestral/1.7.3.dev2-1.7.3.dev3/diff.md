# Comparing `tmp/maestral-1.7.3.dev2.tar.gz` & `tmp/maestral-1.7.3.dev3.tar.gz`

## filetype from file(1)

```diff
@@ -1 +1 @@
-gzip compressed data, was "maestral-1.7.3.dev2.tar", last modified: Sat May 13 10:12:55 2023, max compression
+gzip compressed data, was "maestral-1.7.3.dev3.tar", last modified: Sat May 27 20:59:37 2023, max compression
```

## Comparing `maestral-1.7.3.dev2.tar` & `maestral-1.7.3.dev3.tar`

### file list

```diff
@@ -1,66 +1,66 @@
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-05-13 10:12:55.055456 maestral-1.7.3.dev2/
--rw-r--r--   0 runner    (1001) docker     (123)     1076 2023-05-13 10:12:35.000000 maestral-1.7.3.dev2/LICENSE.txt
--rw-r--r--   0 runner    (1001) docker     (123)     8246 2023-05-13 10:12:55.055456 maestral-1.7.3.dev2/PKG-INFO
--rw-r--r--   0 runner    (1001) docker     (123)     7271 2023-05-13 10:12:35.000000 maestral-1.7.3.dev2/README.md
--rw-r--r--   0 runner    (1001) docker     (123)     2518 2023-05-13 10:12:35.000000 maestral-1.7.3.dev2/pyproject.toml
--rw-r--r--   0 runner    (1001) docker     (123)       38 2023-05-13 10:12:55.055456 maestral-1.7.3.dev2/setup.cfg
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-05-13 10:12:55.047456 maestral-1.7.3.dev2/src/
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-05-13 10:12:55.051456 maestral-1.7.3.dev2/src/maestral/
--rw-r--r--   0 runner    (1001) docker     (123)      228 2023-05-13 10:12:35.000000 maestral-1.7.3.dev2/src/maestral/__init__.py
--rw-r--r--   0 runner    (1001) docker     (123)       82 2023-05-13 10:12:35.000000 maestral-1.7.3.dev2/src/maestral/__main__.py
--rw-r--r--   0 runner    (1001) docker     (123)    12986 2023-05-13 10:12:35.000000 maestral-1.7.3.dev2/src/maestral/autostart.py
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-05-13 10:12:55.051456 maestral-1.7.3.dev2/src/maestral/cli/
--rw-r--r--   0 runner    (1001) docker     (123)      218 2023-05-13 10:12:35.000000 maestral-1.7.3.dev2/src/maestral/cli/__init__.py
--rw-r--r--   0 runner    (1001) docker     (123)    14787 2023-05-13 10:12:35.000000 maestral-1.7.3.dev2/src/maestral/cli/cli_core.py
--rw-r--r--   0 runner    (1001) docker     (123)    10518 2023-05-13 10:12:35.000000 maestral-1.7.3.dev2/src/maestral/cli/cli_info.py
--rwxr-xr-x   0 runner    (1001) docker     (123)     1925 2023-05-13 10:12:35.000000 maestral-1.7.3.dev2/src/maestral/cli/cli_main.py
--rw-r--r--   0 runner    (1001) docker     (123)    15396 2023-05-13 10:12:35.000000 maestral-1.7.3.dev2/src/maestral/cli/cli_maintenance.py
--rw-r--r--   0 runner    (1001) docker     (123)     5730 2023-05-13 10:12:35.000000 maestral-1.7.3.dev2/src/maestral/cli/cli_settings.py
--rw-r--r--   0 runner    (1001) docker     (123)     3222 2023-05-13 10:12:35.000000 maestral-1.7.3.dev2/src/maestral/cli/common.py
--rw-r--r--   0 runner    (1001) docker     (123)     7959 2023-05-13 10:12:35.000000 maestral-1.7.3.dev2/src/maestral/cli/core.py
--rw-r--r--   0 runner    (1001) docker     (123)     3387 2023-05-13 10:12:35.000000 maestral-1.7.3.dev2/src/maestral/cli/dialogs.py
--rw-r--r--   0 runner    (1001) docker     (123)     3417 2023-05-13 10:12:35.000000 maestral-1.7.3.dev2/src/maestral/cli/output.py
--rw-r--r--   0 runner    (1001) docker     (123)      477 2023-05-13 10:12:35.000000 maestral-1.7.3.dev2/src/maestral/cli/utils.py
--rw-r--r--   0 runner    (1001) docker     (123)    69578 2023-05-13 10:12:35.000000 maestral-1.7.3.dev2/src/maestral/client.py
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-05-13 10:12:55.055456 maestral-1.7.3.dev2/src/maestral/config/
--rw-r--r--   0 runner    (1001) docker     (123)     1718 2023-05-13 10:12:35.000000 maestral-1.7.3.dev2/src/maestral/config/__init__.py
--rw-r--r--   0 runner    (1001) docker     (123)     5859 2023-05-13 10:12:35.000000 maestral-1.7.3.dev2/src/maestral/config/main.py
--rw-r--r--   0 runner    (1001) docker     (123)    17864 2023-05-13 10:12:35.000000 maestral-1.7.3.dev2/src/maestral/config/user.py
--rw-r--r--   0 runner    (1001) docker     (123)     2289 2023-05-13 10:12:35.000000 maestral-1.7.3.dev2/src/maestral/constants.py
--rw-r--r--   0 runner    (1001) docker     (123)     3102 2023-05-13 10:12:35.000000 maestral-1.7.3.dev2/src/maestral/core.py
--rw-r--r--   0 runner    (1001) docker     (123)    21989 2023-05-13 10:12:35.000000 maestral-1.7.3.dev2/src/maestral/daemon.py
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-05-13 10:12:55.055456 maestral-1.7.3.dev2/src/maestral/database/
--rw-r--r--   0 runner    (1001) docker     (123)      170 2023-05-13 10:12:35.000000 maestral-1.7.3.dev2/src/maestral/database/__init__.py
--rw-r--r--   0 runner    (1001) docker     (123)     1187 2023-05-13 10:12:35.000000 maestral-1.7.3.dev2/src/maestral/database/core.py
--rw-r--r--   0 runner    (1001) docker     (123)    17525 2023-05-13 10:12:35.000000 maestral-1.7.3.dev2/src/maestral/database/orm.py
--rw-r--r--   0 runner    (1001) docker     (123)     4696 2023-05-13 10:12:35.000000 maestral-1.7.3.dev2/src/maestral/database/query.py
--rw-r--r--   0 runner    (1001) docker     (123)     2485 2023-05-13 10:12:35.000000 maestral-1.7.3.dev2/src/maestral/database/types.py
--rw-r--r--   0 runner    (1001) docker     (123)    33650 2023-05-13 10:12:35.000000 maestral-1.7.3.dev2/src/maestral/errorhandling.py
--rw-r--r--   0 runner    (1001) docker     (123)     7096 2023-05-13 10:12:35.000000 maestral-1.7.3.dev2/src/maestral/exceptions.py
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-05-13 10:12:55.055456 maestral-1.7.3.dev2/src/maestral/fsevents/
--rw-r--r--   0 runner    (1001) docker     (123)     1139 2023-05-13 10:12:35.000000 maestral-1.7.3.dev2/src/maestral/fsevents/__init__.py
--rw-r--r--   0 runner    (1001) docker     (123)     5465 2023-05-13 10:12:35.000000 maestral-1.7.3.dev2/src/maestral/fsevents/polling.py
--rw-r--r--   0 runner    (1001) docker     (123)     9847 2023-05-13 10:12:35.000000 maestral-1.7.3.dev2/src/maestral/keyring.py
--rw-r--r--   0 runner    (1001) docker     (123)     9041 2023-05-13 10:12:35.000000 maestral-1.7.3.dev2/src/maestral/logging.py
--rw-r--r--   0 runner    (1001) docker     (123)    63172 2023-05-13 10:12:35.000000 maestral-1.7.3.dev2/src/maestral/main.py
--rw-r--r--   0 runner    (1001) docker     (123)    29677 2023-05-13 10:12:35.000000 maestral-1.7.3.dev2/src/maestral/manager.py
--rw-r--r--   0 runner    (1001) docker     (123)    17790 2023-05-13 10:12:35.000000 maestral-1.7.3.dev2/src/maestral/models.py
--rw-r--r--   0 runner    (1001) docker     (123)     4669 2023-05-13 10:12:35.000000 maestral-1.7.3.dev2/src/maestral/notify.py
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-05-13 10:12:55.055456 maestral-1.7.3.dev2/src/maestral/resources/
--rw-r--r--   0 runner    (1001) docker     (123)        0 2023-05-13 10:12:35.000000 maestral-1.7.3.dev2/src/maestral/resources/__init__.py
--rw-r--r--   0 runner    (1001) docker     (123)   137001 2023-05-13 10:12:35.000000 maestral-1.7.3.dev2/src/maestral/resources/maestral.png
--rw-r--r--   0 runner    (1001) docker     (123)   147935 2023-05-13 10:12:35.000000 maestral-1.7.3.dev2/src/maestral/sync.py
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-05-13 10:12:55.055456 maestral-1.7.3.dev2/src/maestral/utils/
--rw-r--r--   0 runner    (1001) docker     (123)     3695 2023-05-13 10:12:35.000000 maestral-1.7.3.dev2/src/maestral/utils/__init__.py
--rw-r--r--   0 runner    (1001) docker     (123)     6874 2023-05-13 10:12:35.000000 maestral-1.7.3.dev2/src/maestral/utils/appdirs.py
--rw-r--r--   0 runner    (1001) docker     (123)     1445 2023-05-13 10:12:35.000000 maestral-1.7.3.dev2/src/maestral/utils/caches.py
--rw-r--r--   0 runner    (1001) docker     (123)     4462 2023-05-13 10:12:35.000000 maestral-1.7.3.dev2/src/maestral/utils/hashing.py
--rw-r--r--   0 runner    (1001) docker     (123)     7916 2023-05-13 10:12:35.000000 maestral-1.7.3.dev2/src/maestral/utils/integration.py
--rw-r--r--   0 runner    (1001) docker     (123)    18734 2023-05-13 10:12:35.000000 maestral-1.7.3.dev2/src/maestral/utils/path.py
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-05-13 10:12:55.051456 maestral-1.7.3.dev2/src/maestral.egg-info/
--rw-r--r--   0 runner    (1001) docker     (123)     8246 2023-05-13 10:12:55.000000 maestral-1.7.3.dev2/src/maestral.egg-info/PKG-INFO
--rw-r--r--   0 runner    (1001) docker     (123)     1520 2023-05-13 10:12:55.000000 maestral-1.7.3.dev2/src/maestral.egg-info/SOURCES.txt
--rw-r--r--   0 runner    (1001) docker     (123)        1 2023-05-13 10:12:55.000000 maestral-1.7.3.dev2/src/maestral.egg-info/dependency_links.txt
--rw-r--r--   0 runner    (1001) docker     (123)       47 2023-05-13 10:12:55.000000 maestral-1.7.3.dev2/src/maestral.egg-info/entry_points.txt
--rw-r--r--   0 runner    (1001) docker     (123)      727 2023-05-13 10:12:55.000000 maestral-1.7.3.dev2/src/maestral.egg-info/requires.txt
--rw-r--r--   0 runner    (1001) docker     (123)        9 2023-05-13 10:12:55.000000 maestral-1.7.3.dev2/src/maestral.egg-info/top_level.txt
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-05-27 20:59:37.980270 maestral-1.7.3.dev3/
+-rw-r--r--   0 runner    (1001) docker     (123)     1076 2023-05-27 20:59:15.000000 maestral-1.7.3.dev3/LICENSE.txt
+-rw-r--r--   0 runner    (1001) docker     (123)     8246 2023-05-27 20:59:37.980270 maestral-1.7.3.dev3/PKG-INFO
+-rw-r--r--   0 runner    (1001) docker     (123)     7271 2023-05-27 20:59:15.000000 maestral-1.7.3.dev3/README.md
+-rw-r--r--   0 runner    (1001) docker     (123)     2545 2023-05-27 20:59:15.000000 maestral-1.7.3.dev3/pyproject.toml
+-rw-r--r--   0 runner    (1001) docker     (123)       38 2023-05-27 20:59:37.980270 maestral-1.7.3.dev3/setup.cfg
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-05-27 20:59:37.964270 maestral-1.7.3.dev3/src/
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-05-27 20:59:37.972270 maestral-1.7.3.dev3/src/maestral/
+-rw-r--r--   0 runner    (1001) docker     (123)      228 2023-05-27 20:59:15.000000 maestral-1.7.3.dev3/src/maestral/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (123)       82 2023-05-27 20:59:15.000000 maestral-1.7.3.dev3/src/maestral/__main__.py
+-rw-r--r--   0 runner    (1001) docker     (123)    12986 2023-05-27 20:59:15.000000 maestral-1.7.3.dev3/src/maestral/autostart.py
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-05-27 20:59:37.976270 maestral-1.7.3.dev3/src/maestral/cli/
+-rw-r--r--   0 runner    (1001) docker     (123)      218 2023-05-27 20:59:15.000000 maestral-1.7.3.dev3/src/maestral/cli/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (123)    14787 2023-05-27 20:59:15.000000 maestral-1.7.3.dev3/src/maestral/cli/cli_core.py
+-rw-r--r--   0 runner    (1001) docker     (123)    10518 2023-05-27 20:59:15.000000 maestral-1.7.3.dev3/src/maestral/cli/cli_info.py
+-rwxr-xr-x   0 runner    (1001) docker     (123)     1925 2023-05-27 20:59:15.000000 maestral-1.7.3.dev3/src/maestral/cli/cli_main.py
+-rw-r--r--   0 runner    (1001) docker     (123)    15396 2023-05-27 20:59:15.000000 maestral-1.7.3.dev3/src/maestral/cli/cli_maintenance.py
+-rw-r--r--   0 runner    (1001) docker     (123)     5730 2023-05-27 20:59:15.000000 maestral-1.7.3.dev3/src/maestral/cli/cli_settings.py
+-rw-r--r--   0 runner    (1001) docker     (123)     3222 2023-05-27 20:59:15.000000 maestral-1.7.3.dev3/src/maestral/cli/common.py
+-rw-r--r--   0 runner    (1001) docker     (123)     7959 2023-05-27 20:59:15.000000 maestral-1.7.3.dev3/src/maestral/cli/core.py
+-rw-r--r--   0 runner    (1001) docker     (123)     3387 2023-05-27 20:59:15.000000 maestral-1.7.3.dev3/src/maestral/cli/dialogs.py
+-rw-r--r--   0 runner    (1001) docker     (123)     3417 2023-05-27 20:59:15.000000 maestral-1.7.3.dev3/src/maestral/cli/output.py
+-rw-r--r--   0 runner    (1001) docker     (123)      477 2023-05-27 20:59:15.000000 maestral-1.7.3.dev3/src/maestral/cli/utils.py
+-rw-r--r--   0 runner    (1001) docker     (123)    69578 2023-05-27 20:59:15.000000 maestral-1.7.3.dev3/src/maestral/client.py
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-05-27 20:59:37.976270 maestral-1.7.3.dev3/src/maestral/config/
+-rw-r--r--   0 runner    (1001) docker     (123)     1718 2023-05-27 20:59:15.000000 maestral-1.7.3.dev3/src/maestral/config/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (123)     5859 2023-05-27 20:59:15.000000 maestral-1.7.3.dev3/src/maestral/config/main.py
+-rw-r--r--   0 runner    (1001) docker     (123)    17864 2023-05-27 20:59:15.000000 maestral-1.7.3.dev3/src/maestral/config/user.py
+-rw-r--r--   0 runner    (1001) docker     (123)     2278 2023-05-27 20:59:15.000000 maestral-1.7.3.dev3/src/maestral/constants.py
+-rw-r--r--   0 runner    (1001) docker     (123)     3102 2023-05-27 20:59:15.000000 maestral-1.7.3.dev3/src/maestral/core.py
+-rw-r--r--   0 runner    (1001) docker     (123)    21989 2023-05-27 20:59:15.000000 maestral-1.7.3.dev3/src/maestral/daemon.py
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-05-27 20:59:37.976270 maestral-1.7.3.dev3/src/maestral/database/
+-rw-r--r--   0 runner    (1001) docker     (123)      170 2023-05-27 20:59:15.000000 maestral-1.7.3.dev3/src/maestral/database/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (123)     1187 2023-05-27 20:59:15.000000 maestral-1.7.3.dev3/src/maestral/database/core.py
+-rw-r--r--   0 runner    (1001) docker     (123)    17337 2023-05-27 20:59:15.000000 maestral-1.7.3.dev3/src/maestral/database/orm.py
+-rw-r--r--   0 runner    (1001) docker     (123)     4696 2023-05-27 20:59:15.000000 maestral-1.7.3.dev3/src/maestral/database/query.py
+-rw-r--r--   0 runner    (1001) docker     (123)     2485 2023-05-27 20:59:15.000000 maestral-1.7.3.dev3/src/maestral/database/types.py
+-rw-r--r--   0 runner    (1001) docker     (123)    33650 2023-05-27 20:59:15.000000 maestral-1.7.3.dev3/src/maestral/errorhandling.py
+-rw-r--r--   0 runner    (1001) docker     (123)     7096 2023-05-27 20:59:15.000000 maestral-1.7.3.dev3/src/maestral/exceptions.py
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-05-27 20:59:37.976270 maestral-1.7.3.dev3/src/maestral/fsevents/
+-rw-r--r--   0 runner    (1001) docker     (123)     1139 2023-05-27 20:59:15.000000 maestral-1.7.3.dev3/src/maestral/fsevents/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (123)     5465 2023-05-27 20:59:15.000000 maestral-1.7.3.dev3/src/maestral/fsevents/polling.py
+-rw-r--r--   0 runner    (1001) docker     (123)     9847 2023-05-27 20:59:15.000000 maestral-1.7.3.dev3/src/maestral/keyring.py
+-rw-r--r--   0 runner    (1001) docker     (123)     9041 2023-05-27 20:59:15.000000 maestral-1.7.3.dev3/src/maestral/logging.py
+-rw-r--r--   0 runner    (1001) docker     (123)    63332 2023-05-27 20:59:15.000000 maestral-1.7.3.dev3/src/maestral/main.py
+-rw-r--r--   0 runner    (1001) docker     (123)    29677 2023-05-27 20:59:15.000000 maestral-1.7.3.dev3/src/maestral/manager.py
+-rw-r--r--   0 runner    (1001) docker     (123)    17802 2023-05-27 20:59:15.000000 maestral-1.7.3.dev3/src/maestral/models.py
+-rw-r--r--   0 runner    (1001) docker     (123)     4669 2023-05-27 20:59:15.000000 maestral-1.7.3.dev3/src/maestral/notify.py
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-05-27 20:59:37.976270 maestral-1.7.3.dev3/src/maestral/resources/
+-rw-r--r--   0 runner    (1001) docker     (123)        0 2023-05-27 20:59:15.000000 maestral-1.7.3.dev3/src/maestral/resources/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (123)   137001 2023-05-27 20:59:15.000000 maestral-1.7.3.dev3/src/maestral/resources/maestral.png
+-rw-r--r--   0 runner    (1001) docker     (123)   150174 2023-05-27 20:59:15.000000 maestral-1.7.3.dev3/src/maestral/sync.py
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-05-27 20:59:37.980270 maestral-1.7.3.dev3/src/maestral/utils/
+-rw-r--r--   0 runner    (1001) docker     (123)     4059 2023-05-27 20:59:15.000000 maestral-1.7.3.dev3/src/maestral/utils/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (123)     6874 2023-05-27 20:59:15.000000 maestral-1.7.3.dev3/src/maestral/utils/appdirs.py
+-rw-r--r--   0 runner    (1001) docker     (123)     1445 2023-05-27 20:59:15.000000 maestral-1.7.3.dev3/src/maestral/utils/caches.py
+-rw-r--r--   0 runner    (1001) docker     (123)     4462 2023-05-27 20:59:15.000000 maestral-1.7.3.dev3/src/maestral/utils/hashing.py
+-rw-r--r--   0 runner    (1001) docker     (123)     7916 2023-05-27 20:59:15.000000 maestral-1.7.3.dev3/src/maestral/utils/integration.py
+-rw-r--r--   0 runner    (1001) docker     (123)    19290 2023-05-27 20:59:15.000000 maestral-1.7.3.dev3/src/maestral/utils/path.py
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-05-27 20:59:37.972270 maestral-1.7.3.dev3/src/maestral.egg-info/
+-rw-r--r--   0 runner    (1001) docker     (123)     8246 2023-05-27 20:59:37.000000 maestral-1.7.3.dev3/src/maestral.egg-info/PKG-INFO
+-rw-r--r--   0 runner    (1001) docker     (123)     1520 2023-05-27 20:59:37.000000 maestral-1.7.3.dev3/src/maestral.egg-info/SOURCES.txt
+-rw-r--r--   0 runner    (1001) docker     (123)        1 2023-05-27 20:59:37.000000 maestral-1.7.3.dev3/src/maestral.egg-info/dependency_links.txt
+-rw-r--r--   0 runner    (1001) docker     (123)       47 2023-05-27 20:59:37.000000 maestral-1.7.3.dev3/src/maestral.egg-info/entry_points.txt
+-rw-r--r--   0 runner    (1001) docker     (123)      754 2023-05-27 20:59:37.000000 maestral-1.7.3.dev3/src/maestral.egg-info/requires.txt
+-rw-r--r--   0 runner    (1001) docker     (123)        9 2023-05-27 20:59:37.000000 maestral-1.7.3.dev3/src/maestral.egg-info/top_level.txt
```

### Comparing `maestral-1.7.3.dev2/LICENSE.txt` & `maestral-1.7.3.dev3/LICENSE.txt`

 * *Files identical despite different names*

### Comparing `maestral-1.7.3.dev2/PKG-INFO` & `maestral-1.7.3.dev3/PKG-INFO`

 * *Files 0% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 Metadata-Version: 2.1
 Name: maestral
-Version: 1.7.3.dev2
+Version: 1.7.3.dev3
 Summary: Open-source Dropbox client for macOS and Linux.
 Author-email: Sam Schott <sam.schott@outlook.com>
 License: MIT
 Project-URL: Homepage, https://maestral.app
 Classifier: License :: OSI Approved :: MIT License
 Classifier: Operating System :: Unix
 Classifier: Programming Language :: Python
```

### Comparing `maestral-1.7.3.dev2/README.md` & `maestral-1.7.3.dev3/README.md`

 * *Files identical despite different names*

### Comparing `maestral-1.7.3.dev2/pyproject.toml` & `maestral-1.7.3.dev3/pyproject.toml`

 * *Files 6% similar despite different names*

```diff
@@ -1,14 +1,14 @@
 [build-system]
 requires = ["setuptools>=61.2", "build"]
 build-backend = "setuptools.build_meta"
 
 [project]
 name = "maestral"
-version = "1.7.3.dev2"
+version = "1.7.3.dev3"
 authors = [{name = "Sam Schott", email = "sam.schott@outlook.com"}]
 license = {text = "MIT"}
 description = "Open-source Dropbox client for macOS and Linux."
 classifiers = [
     "License :: OSI Approved :: MIT License",
     "Operating System :: Unix",
     "Programming Language :: Python",
@@ -45,16 +45,16 @@
 
 [project.readme]
 file = "README.md"
 content-type = "text/markdown"
 
 [project.optional-dependencies]
 gui = [
-    "maestral-qt>=1.7.3.dev2;sys_platform=='linux'",
-    "maestral-cocoa>=1.7.3.dev2;sys_platform=='darwin'",
+    "maestral-qt>=1.7.3.dev3;sys_platform=='linux'",
+    "maestral-cocoa>=1.7.3.dev3;sys_platform=='darwin'",
 ]
 syslog = ["systemd-python"]
 lint = [
     "black",
     "flake8",
     "flake8-pyproject",
     "mypy",
@@ -65,19 +65,19 @@
 test = [
     "pytest",
     "pytest-benchmark",
     "pytest-cov",
     "pytest-rerunfailures",
 ]
 docs = [
-    "sphinx",
-    "sphinxext-opengraph",
-    "sphinx-autoapi",
-    "sphinx-mdinclude",
-    "sphinx_rtd_theme",
+    "furo==2023.5.20",
+    "sphinx==7.0.1",
+    "sphinxext-opengraph==0.8.2",
+    "sphinx-autoapi==2.1.0",
+    "sphinx-mdinclude==0.5.3",
 ]
 dev = [
     "bump2version",
     "maestral[lint,test]",
 ]
 
 [project.scripts]
```

### Comparing `maestral-1.7.3.dev2/src/maestral/autostart.py` & `maestral-1.7.3.dev3/src/maestral/autostart.py`

 * *Files identical despite different names*

### Comparing `maestral-1.7.3.dev2/src/maestral/cli/cli_core.py` & `maestral-1.7.3.dev3/src/maestral/cli/cli_core.py`

 * *Files identical despite different names*

### Comparing `maestral-1.7.3.dev2/src/maestral/cli/cli_info.py` & `maestral-1.7.3.dev3/src/maestral/cli/cli_info.py`

 * *Files identical despite different names*

### Comparing `maestral-1.7.3.dev2/src/maestral/cli/cli_main.py` & `maestral-1.7.3.dev3/src/maestral/cli/cli_main.py`

 * *Files identical despite different names*

### Comparing `maestral-1.7.3.dev2/src/maestral/cli/cli_maintenance.py` & `maestral-1.7.3.dev3/src/maestral/cli/cli_maintenance.py`

 * *Files identical despite different names*

### Comparing `maestral-1.7.3.dev2/src/maestral/cli/cli_settings.py` & `maestral-1.7.3.dev3/src/maestral/cli/cli_settings.py`

 * *Files identical despite different names*

### Comparing `maestral-1.7.3.dev2/src/maestral/cli/common.py` & `maestral-1.7.3.dev3/src/maestral/cli/common.py`

 * *Files identical despite different names*

### Comparing `maestral-1.7.3.dev2/src/maestral/cli/core.py` & `maestral-1.7.3.dev3/src/maestral/cli/core.py`

 * *Files identical despite different names*

### Comparing `maestral-1.7.3.dev2/src/maestral/cli/dialogs.py` & `maestral-1.7.3.dev3/src/maestral/cli/dialogs.py`

 * *Files identical despite different names*

### Comparing `maestral-1.7.3.dev2/src/maestral/cli/output.py` & `maestral-1.7.3.dev3/src/maestral/cli/output.py`

 * *Files identical despite different names*

### Comparing `maestral-1.7.3.dev2/src/maestral/client.py` & `maestral-1.7.3.dev3/src/maestral/client.py`

 * *Files identical despite different names*

### Comparing `maestral-1.7.3.dev2/src/maestral/config/__init__.py` & `maestral-1.7.3.dev3/src/maestral/config/__init__.py`

 * *Files identical despite different names*

### Comparing `maestral-1.7.3.dev2/src/maestral/config/main.py` & `maestral-1.7.3.dev3/src/maestral/config/main.py`

 * *Files identical despite different names*

### Comparing `maestral-1.7.3.dev2/src/maestral/config/user.py` & `maestral-1.7.3.dev3/src/maestral/config/user.py`

 * *Files identical despite different names*

### Comparing `maestral-1.7.3.dev2/src/maestral/constants.py` & `maestral-1.7.3.dev3/src/maestral/constants.py`

 * *Files 0% similar despite different names*

```diff
@@ -1,15 +1,14 @@
 """
 This module provides constants used throughout the maestral, the GUI and CLI. It should
 be kept free of memory heavy imports.
 """
 
 # system imports
 import sys
-import sys
 import platform
 import pathlib
 from enum import Enum
 from importlib_metadata import metadata, PackageNotFoundError
 from typing import ContextManager
 
 try:
```

### Comparing `maestral-1.7.3.dev2/src/maestral/core.py` & `maestral-1.7.3.dev3/src/maestral/core.py`

 * *Files identical despite different names*

### Comparing `maestral-1.7.3.dev2/src/maestral/daemon.py` & `maestral-1.7.3.dev3/src/maestral/daemon.py`

 * *Files identical despite different names*

### Comparing `maestral-1.7.3.dev2/src/maestral/database/core.py` & `maestral-1.7.3.dev3/src/maestral/database/core.py`

 * *Files identical despite different names*

### Comparing `maestral-1.7.3.dev2/src/maestral/database/orm.py` & `maestral-1.7.3.dev3/src/maestral/database/orm.py`

 * *Files 1% similar despite different names*

```diff
@@ -244,32 +244,33 @@
         where_expressions_str = ", ".join(where_expressions)
         self._sql_update_template = "UPDATE {} SET {} WHERE {} = ?".format(
             self.table_name,
             where_expressions_str,
             self.pk_column.name,
         )
 
-        # Create table if required.
-        if not self._has_table():
-            self.create_table()
+        self.create_table_if_not_exists()
 
-    def create_table(self) -> None:
+    def create_table_if_not_exists(self) -> None:
         """Creates the table as defined by the model."""
         column_defs = [col.render_column() for col in self.model.__columns__]
         column_defs_str = ", ".join(column_defs)
-        sql = f"CREATE TABLE {self.table_name} ({column_defs_str});"
+        sql = f"CREATE TABLE IF NOT EXISTS {self.table_name} ({column_defs_str});"
 
         self.db.executescript(sql)
 
         for column in self.model.__columns__:
             if column.index:
-                idx_name = f"idx_{self.table_name}_{column.name}"
-                sql = f"CREATE INDEX {idx_name} ON {self.table_name} ({column.name});"
+                table_name_stripped = self.table_name.strip("'\"")
+                idx_name = f"idx_{table_name_stripped}_{column.name}"
+                sql = f"CREATE INDEX IF NOT EXISTS {idx_name} ON {self.table_name} ({column.name});"
                 self.db.executescript(sql)
 
+        self._did_create_table = True
+
     def clear_cache(self) -> None:
         """Clears our cache."""
         self._cache.clear()
 
     def delete(self, query: Query) -> None:
         clause, args = query.clause()
         sql = f"DELETE FROM {self.table_name} WHERE {clause}"
@@ -411,21 +412,15 @@
         counts = res.fetchone()
         return cast(int, counts[0])
 
     def clear(self) -> None:
         """Delete all rows from table."""
         self.db.execute(f"DROP TABLE {self.table_name}")
         self.clear_cache()
-        self.create_table()
-
-    def _has_table(self) -> bool:
-        """Checks if entity model already has a database table."""
-        sql = "SELECT name len FROM sqlite_master WHERE type = 'table' AND name = ?"
-        result = self.db.execute(sql, self.table_name.strip("'\""))
-        return bool(result.fetchall())
+        self.create_table_if_not_exists()
 
     def _get_primary_key(self, obj: M) -> SQLSafeType:
         """
         Returns the primary key value for a model object / row in the table.
 
         :param obj: Model instance which represents the row.
         :returns: Primary key for row.
```

### Comparing `maestral-1.7.3.dev2/src/maestral/database/query.py` & `maestral-1.7.3.dev3/src/maestral/database/query.py`

 * *Files identical despite different names*

### Comparing `maestral-1.7.3.dev2/src/maestral/database/types.py` & `maestral-1.7.3.dev3/src/maestral/database/types.py`

 * *Files identical despite different names*

### Comparing `maestral-1.7.3.dev2/src/maestral/errorhandling.py` & `maestral-1.7.3.dev3/src/maestral/errorhandling.py`

 * *Files identical despite different names*

### Comparing `maestral-1.7.3.dev2/src/maestral/exceptions.py` & `maestral-1.7.3.dev3/src/maestral/exceptions.py`

 * *Files identical despite different names*

### Comparing `maestral-1.7.3.dev2/src/maestral/fsevents/__init__.py` & `maestral-1.7.3.dev3/src/maestral/fsevents/__init__.py`

 * *Files identical despite different names*

### Comparing `maestral-1.7.3.dev2/src/maestral/fsevents/polling.py` & `maestral-1.7.3.dev3/src/maestral/fsevents/polling.py`

 * *Files identical despite different names*

### Comparing `maestral-1.7.3.dev2/src/maestral/keyring.py` & `maestral-1.7.3.dev3/src/maestral/keyring.py`

 * *Files identical despite different names*

### Comparing `maestral-1.7.3.dev2/src/maestral/logging.py` & `maestral-1.7.3.dev3/src/maestral/logging.py`

 * *Files identical despite different names*

### Comparing `maestral-1.7.3.dev2/src/maestral/main.py` & `maestral-1.7.3.dev3/src/maestral/main.py`

 * *Files 0% similar despite different names*

```diff
@@ -657,25 +657,31 @@
         """
         if not self.running:
             return FileStatus.Unwatched.value
 
         local_path = osp.realpath(local_path)
 
         try:
-            dbx_path = self.sync.to_dbx_path(local_path)
-            dbx_path_lower = self.sync.to_dbx_path_lower(local_path)
+            dbx_path_cased = self.sync.to_dbx_path(local_path)
         except ValueError:
             return FileStatus.Unwatched.value
 
-        node = self.sync.activity.get_node(dbx_path)
+        # Find any sync activity for the local path.
+        node = self.sync.activity.get_node(dbx_path_cased)
+
         if not node:
+            # Always return synced for the root folder in the absense of sync activity.
+            if dbx_path_cased == "/":
+                return FileStatus.Synced.value
+
             # Check if the path is in our index. If yes, it is fully synced, otherwise
             # it is unwatched.
-            if dbx_path_lower == "/" or self.sync.get_local_rev(dbx_path_lower):
+            if self.sync.get_index_entry_for_local_path(local_path):
                 return FileStatus.Synced.value
+
             return FileStatus.Unwatched.value
 
         # Return effective status of item and its children. Syncing items take
         # precedence over Failed which take precedence over Synced. Note that Up and
         # Down are mutually exclusive because they are performed in alternating cycles.
         file_status = FileStatus.Synced
```

### Comparing `maestral-1.7.3.dev2/src/maestral/manager.py` & `maestral-1.7.3.dev3/src/maestral/manager.py`

 * *Files identical despite different names*

### Comparing `maestral-1.7.3.dev2/src/maestral/models.py` & `maestral-1.7.3.dev3/src/maestral/models.py`

 * *Files 0% similar despite different names*

```diff
@@ -461,15 +461,15 @@
     dbx_path_lower = NonNullColumn(SqlPath(), primary_key=True)
     """
     Dropbox path of the item in lower case. This acts as a primary key for the SQLites
     database since there can only be one entry per case-insensitive Dropbox path.
     Corresponds to the path_lower field of Dropbox metadata.
     """
 
-    dbx_path_cased = NonNullColumn(SqlPath())
+    dbx_path_cased = NonNullColumn(SqlPath(), index=True)
     """
     Dropbox path of the item, correctly cased. Corresponds to the path_display field of
     Dropbox metadata.
     """
 
     dbx_id = NonNullColumn(SqlString())
     """The unique dropbox ID for the item."""
```

### Comparing `maestral-1.7.3.dev2/src/maestral/notify.py` & `maestral-1.7.3.dev3/src/maestral/notify.py`

 * *Files identical despite different names*

### Comparing `maestral-1.7.3.dev2/src/maestral/resources/maestral.png` & `maestral-1.7.3.dev3/src/maestral/resources/maestral.png`

 * *Files identical despite different names*

### Comparing `maestral-1.7.3.dev2/src/maestral/sync.py` & `maestral-1.7.3.dev3/src/maestral/sync.py`

 * *Files 2% similar despite different names*

```diff
@@ -1122,8125 +1122,8265 @@
 00004610: 6e6e 6563 7469 6f6e 203d 2073 716c 6974  nnection = sqlit
 00004620: 6533 2e63 6f6e 6e65 6374 2873 656c 662e  e3.connect(self.
 00004630: 5f64 625f 7061 7468 2c20 6368 6563 6b5f  _db_path, check_
 00004640: 7361 6d65 5f74 6872 6561 643d 4661 6c73  same_thread=Fals
 00004650: 6529 0a20 2020 2020 2020 2073 656c 662e  e).        self.
 00004660: 5f64 6220 3d20 4461 7461 6261 7365 2873  _db = Database(s
 00004670: 656c 662e 5f63 6f6e 6e65 6374 696f 6e29  elf._connection)
-00004680: 0a20 2020 2020 2020 2073 656c 662e 5f69  .        self._i
-00004690: 6e64 6578 5f74 6162 6c65 203d 204d 616e  ndex_table = Man
-000046a0: 6167 6572 2873 656c 662e 5f64 622c 2049  ager(self._db, I
-000046b0: 6e64 6578 456e 7472 7929 0a20 2020 2020  ndexEntry).     
-000046c0: 2020 2073 656c 662e 5f68 6973 746f 7279     self._history
-000046d0: 5f74 6162 6c65 203d 204d 616e 6167 6572  _table = Manager
-000046e0: 2873 656c 662e 5f64 622c 2053 796e 6345  (self._db, SyncE
-000046f0: 7665 6e74 290a 2020 2020 2020 2020 7365  vent).        se
-00004700: 6c66 2e5f 6861 7368 5f74 6162 6c65 203d  lf._hash_table =
-00004710: 204d 616e 6167 6572 2873 656c 662e 5f64   Manager(self._d
-00004720: 622c 2048 6173 6843 6163 6865 456e 7472  b, HashCacheEntr
-00004730: 7929 0a20 2020 2020 2020 2073 656c 662e  y).        self.
-00004740: 5f73 796e 635f 6572 726f 7273 5f74 6162  _sync_errors_tab
-00004750: 6c65 203d 204d 616e 6167 6572 2873 656c  le = Manager(sel
-00004760: 662e 5f64 622c 2053 796e 6345 7272 6f72  f._db, SyncError
-00004770: 456e 7472 7929 0a0a 2020 2020 2020 2020  Entry)..        
-00004780: 2320 4361 6368 6573 2e0a 2020 2020 2020  # Caches..      
-00004790: 2020 7365 6c66 2e5f 6361 7365 5f63 6f6e    self._case_con
-000047a0: 7665 7273 696f 6e5f 6361 6368 6520 3d20  version_cache = 
-000047b0: 4c52 5543 6163 6865 2863 6170 6163 6974  LRUCache(capacit
-000047c0: 793d 3530 3030 290a 2020 2020 2020 2020  y=5000).        
-000047d0: 7365 6c66 2e63 6c65 616e 5f63 6163 6865  self.clean_cache
-000047e0: 5f64 6972 2872 6169 7365 5f65 7272 6f72  _dir(raise_error
-000047f0: 3d46 616c 7365 290a 0a20 2020 2064 6566  =False)..    def
-00004800: 2072 656c 6f61 645f 6361 6368 6564 5f63   reload_cached_c
-00004810: 6f6e 6669 6728 7365 6c66 2920 2d3e 204e  onfig(self) -> N
-00004820: 6f6e 653a 0a20 2020 2020 2020 2022 2222  one:.        """
-00004830: 0a20 2020 2020 2020 2052 656c 6f61 6473  .        Reloads
-00004840: 2061 6c6c 2063 6f6e 6669 6720 616e 6420   all config and 
-00004850: 7374 6174 6520 7661 6c75 6573 2074 6861  state values tha
-00004860: 7420 6172 6520 6f74 6865 7277 6973 6520  t are otherwise 
-00004870: 6361 6368 6564 2062 7920 7468 6973 2063  cached by this c
-00004880: 6c61 7373 2066 6f72 0a20 2020 2020 2020  lass for.       
-00004890: 2066 6173 7465 7220 6163 6365 7373 2e20   faster access. 
-000048a0: 4361 6c6c 2074 6869 7320 6d65 7468 6f64  Call this method
-000048b0: 2069 6620 636f 6e66 6967 206f 7220 7374   if config or st
-000048c0: 6174 6520 7661 6c75 6573 2077 6865 7265  ate values where
-000048d0: 206d 6f64 6966 6965 640a 2020 2020 2020   modified.      
-000048e0: 2020 6469 7265 6374 6c79 2069 6e73 7465    directly inste
-000048f0: 6164 206f 6620 7573 696e 6720 3a63 6c61  ad of using :cla
-00004900: 7373 3a60 5379 6e63 456e 6769 6e65 6020  ss:`SyncEngine` 
-00004910: 4150 4973 2e0a 2020 2020 2020 2020 2222  APIs..        ""
-00004920: 220a 2020 2020 2020 2020 7365 6c66 2e5f  ".        self._
-00004930: 6472 6f70 626f 785f 7061 7468 3a20 7374  dropbox_path: st
-00004940: 7220 3d20 7365 6c66 2e5f 636f 6e66 2e67  r = self._conf.g
-00004950: 6574 2822 7379 6e63 222c 2022 7061 7468  et("sync", "path
-00004960: 2229 0a20 2020 2020 2020 2073 656c 662e  ").        self.
-00004970: 5f6d 6967 6e6f 7265 5f70 6174 683a 2073  _mignore_path: s
-00004980: 7472 203d 206f 7370 2e6a 6f69 6e28 7365  tr = osp.join(se
-00004990: 6c66 2e5f 6472 6f70 626f 785f 7061 7468  lf._dropbox_path
-000049a0: 2c20 4d49 474e 4f52 455f 4649 4c45 290a  , MIGNORE_FILE).
-000049b0: 2020 2020 2020 2020 7365 6c66 2e5f 6669          self._fi
-000049c0: 6c65 5f63 6163 6865 5f70 6174 683a 2073  le_cache_path: s
-000049d0: 7472 203d 206f 7370 2e6a 6f69 6e28 7365  tr = osp.join(se
-000049e0: 6c66 2e5f 6472 6f70 626f 785f 7061 7468  lf._dropbox_path
-000049f0: 2c20 4649 4c45 5f43 4143 4845 290a 0a20  , FILE_CACHE).. 
-00004a00: 2020 2020 2020 2073 656c 662e 5f65 7863         self._exc
-00004a10: 6c75 6465 645f 6974 656d 733a 206c 6973  luded_items: lis
-00004a20: 745b 7374 725d 203d 2073 656c 662e 5f63  t[str] = self._c
-00004a30: 6f6e 662e 6765 7428 2273 796e 6322 2c20  onf.get("sync", 
-00004a40: 2265 7863 6c75 6465 645f 6974 656d 7322  "excluded_items"
-00004a50: 290a 2020 2020 2020 2020 7365 6c66 2e5f  ).        self._
-00004a60: 6d61 785f 6370 755f 7065 7263 656e 743a  max_cpu_percent:
-00004a70: 2066 6c6f 6174 203d 2028 0a20 2020 2020   float = (.     
-00004a80: 2020 2020 2020 2073 656c 662e 5f63 6f6e         self._con
-00004a90: 662e 6765 7428 2273 796e 6322 2c20 226d  f.get("sync", "m
-00004aa0: 6178 5f63 7075 5f70 6572 6365 6e74 2229  ax_cpu_percent")
-00004ab0: 202a 2043 5055 5f43 4f52 455f 434f 554e   * CPU_CORE_COUN
-00004ac0: 540a 2020 2020 2020 2020 290a 2020 2020  T.        ).    
-00004ad0: 2020 2020 7365 6c66 2e5f 6c6f 6361 6c5f      self._local_
-00004ae0: 6375 7273 6f72 3a20 666c 6f61 7420 3d20  cursor: float = 
-00004af0: 7365 6c66 2e5f 7374 6174 652e 6765 7428  self._state.get(
-00004b00: 2273 796e 6322 2c20 226c 6173 7473 796e  "sync", "lastsyn
-00004b10: 6322 290a 0a20 2020 2020 2020 2073 656c  c")..        sel
-00004b20: 662e 5f69 735f 6673 5f63 6173 655f 7365  f._is_fs_case_se
-00004b30: 6e73 6974 6976 6520 3d20 7365 6c66 2e5f  nsitive = self._
-00004b40: 6368 6563 6b5f 6673 5f63 6173 655f 7365  check_fs_case_se
-00004b50: 6e73 6974 6976 6528 290a 0a20 2020 2020  nsitive()..     
-00004b60: 2020 2073 656c 662e 6c6f 6164 5f6d 6967     self.load_mig
-00004b70: 6e6f 7265 5f66 696c 6528 290a 0a20 2020  nore_file()..   
-00004b80: 2064 6566 205f 6368 6563 6b5f 6673 5f63   def _check_fs_c
-00004b90: 6173 655f 7365 6e73 6974 6976 6528 7365  ase_sensitive(se
-00004ba0: 6c66 2920 2d3e 2062 6f6f 6c3a 0a20 2020  lf) -> bool:.   
-00004bb0: 2020 2020 2074 7279 3a0a 2020 2020 2020       try:.      
-00004bc0: 2020 2020 2020 7265 7475 726e 2069 735f        return is_
-00004bd0: 6673 5f63 6173 655f 7365 6e73 6974 6976  fs_case_sensitiv
-00004be0: 6528 7365 6c66 2e5f 6472 6f70 626f 785f  e(self._dropbox_
-00004bf0: 7061 7468 290a 2020 2020 2020 2020 6578  path).        ex
-00004c00: 6365 7074 2028 4669 6c65 4e6f 7446 6f75  cept (FileNotFou
-00004c10: 6e64 4572 726f 722c 204e 6f74 4144 6972  ndError, NotADir
-00004c20: 6563 746f 7279 4572 726f 7229 3a0a 2020  ectoryError):.  
-00004c30: 2020 2020 2020 2020 2020 2320 4661 6c6c            # Fall
-00004c40: 2062 6163 6b20 746f 2074 6865 2061 7373   back to the ass
-00004c50: 756d 7074 696f 6e20 6f66 2061 2063 6173  umption of a cas
-00004c60: 652d 7365 6e73 6974 6976 6520 6669 6c65  e-sensitive file
-00004c70: 2073 7973 7465 6d2e 0a20 2020 2020 2020   system..       
-00004c80: 2020 2020 2072 6574 7572 6e20 5472 7565       return True
-00004c90: 0a0a 2020 2020 2320 3d3d 3d3d 2043 6f6e  ..    # ==== Con
-00004ca0: 6669 6720 6163 6365 7373 203d 3d3d 3d3d  fig access =====
-00004cb0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00004cc0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00004cd0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00004ce0: 3d3d 3d3d 3d3d 3d3d 3d3d 0a0a 2020 2020  ==========..    
-00004cf0: 4070 726f 7065 7274 790a 2020 2020 6465  @property.    de
-00004d00: 6620 6472 6f70 626f 785f 7061 7468 2873  f dropbox_path(s
-00004d10: 656c 6629 202d 3e20 7374 723a 0a20 2020  elf) -> str:.   
-00004d20: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
-00004d30: 2050 6174 6820 746f 206c 6f63 616c 2044   Path to local D
-00004d40: 726f 7062 6f78 2066 6f6c 6465 722c 2061  ropbox folder, a
-00004d50: 7320 6c6f 6164 6564 2066 726f 6d20 7468  s loaded from th
-00004d60: 6520 636f 6e66 6967 2066 696c 652e 2042  e config file. B
-00004d70: 6566 6f72 6520 6368 616e 6769 6e67 0a20  efore changing. 
-00004d80: 2020 2020 2020 203a 6174 7472 3a60 6472         :attr:`dr
-00004d90: 6f70 626f 785f 7061 7468 602c 206d 616b  opbox_path`, mak
-00004da0: 6520 7375 7265 2074 6861 7420 7379 6e63  e sure that sync
-00004db0: 696e 6720 6973 2070 6175 7365 642e 204d  ing is paused. M
-00004dc0: 6f76 6520 7468 6520 6472 6f70 626f 7820  ove the dropbox 
-00004dd0: 666f 6c64 6572 0a20 2020 2020 2020 2074  folder.        t
-00004de0: 6f20 7468 6520 6e65 7720 6c6f 6361 7469  o the new locati
-00004df0: 6f6e 2062 6566 6f72 6520 7265 7375 6d69  on before resumi
-00004e00: 6e67 2074 6865 2073 796e 632e 2043 6861  ng the sync. Cha
-00004e10: 6e67 6573 2061 7265 2073 6176 6564 2074  nges are saved t
-00004e20: 6f20 7468 6520 636f 6e66 6967 0a20 2020  o the config.   
-00004e30: 2020 2020 2066 696c 652e 0a20 2020 2020       file..     
-00004e40: 2020 2022 2222 0a20 2020 2020 2020 2072     """.        r
-00004e50: 6574 7572 6e20 7365 6c66 2e5f 6472 6f70  eturn self._drop
-00004e60: 626f 785f 7061 7468 0a0a 2020 2020 4064  box_path..    @d
-00004e70: 726f 7062 6f78 5f70 6174 682e 7365 7474  ropbox_path.sett
-00004e80: 6572 0a20 2020 2064 6566 2064 726f 7062  er.    def dropb
-00004e90: 6f78 5f70 6174 6828 7365 6c66 2c20 7061  ox_path(self, pa
-00004ea0: 7468 3a20 7374 7229 202d 3e20 4e6f 6e65  th: str) -> None
-00004eb0: 3a0a 2020 2020 2020 2020 2222 2253 6574  :.        """Set
-00004ec0: 7465 723a 2064 726f 7062 6f78 5f70 6174  ter: dropbox_pat
-00004ed0: 6822 2222 0a0a 2020 2020 2020 2020 7061  h"""..        pa
-00004ee0: 7468 203d 206f 7370 2e72 6561 6c70 6174  th = osp.realpat
-00004ef0: 6828 7061 7468 290a 0a20 2020 2020 2020  h(path)..       
-00004f00: 2077 6974 6820 7365 6c66 2e73 796e 635f   with self.sync_
-00004f10: 6c6f 636b 3a0a 2020 2020 2020 2020 2020  lock:.          
-00004f20: 2020 7365 6c66 2e5f 6472 6f70 626f 785f    self._dropbox_
-00004f30: 7061 7468 203d 2070 6174 680a 2020 2020  path = path.    
-00004f40: 2020 2020 2020 2020 7365 6c66 2e5f 6d69          self._mi
-00004f50: 676e 6f72 655f 7061 7468 203d 206f 7370  gnore_path = osp
-00004f60: 2e6a 6f69 6e28 7365 6c66 2e5f 6472 6f70  .join(self._drop
-00004f70: 626f 785f 7061 7468 2c20 4d49 474e 4f52  box_path, MIGNOR
-00004f80: 455f 4649 4c45 290a 2020 2020 2020 2020  E_FILE).        
-00004f90: 2020 2020 7365 6c66 2e5f 6669 6c65 5f63      self._file_c
-00004fa0: 6163 6865 5f70 6174 6820 3d20 6f73 702e  ache_path = osp.
-00004fb0: 6a6f 696e 2873 656c 662e 5f64 726f 7062  join(self._dropb
-00004fc0: 6f78 5f70 6174 682c 2046 494c 455f 4341  ox_path, FILE_CA
-00004fd0: 4348 4529 0a20 2020 2020 2020 2020 2020  CHE).           
-00004fe0: 2073 656c 662e 5f63 6f6e 662e 7365 7428   self._conf.set(
-00004ff0: 2273 796e 6322 2c20 2270 6174 6822 2c20  "sync", "path", 
-00005000: 7061 7468 290a 0a20 2020 2020 2020 2020  path)..         
-00005010: 2020 2073 656c 662e 5f69 735f 6673 5f63     self._is_fs_c
-00005020: 6173 655f 7365 6e73 6974 6976 6520 3d20  ase_sensitive = 
-00005030: 7365 6c66 2e5f 6368 6563 6b5f 6673 5f63  self._check_fs_c
-00005040: 6173 655f 7365 6e73 6974 6976 6528 290a  ase_sensitive().
-00005050: 0a20 2020 2040 7072 6f70 6572 7479 0a20  .    @property. 
-00005060: 2020 2064 6566 2069 735f 6673 5f63 6173     def is_fs_cas
-00005070: 655f 7365 6e73 6974 6976 6528 7365 6c66  e_sensitive(self
-00005080: 2920 2d3e 2062 6f6f 6c3a 0a20 2020 2020  ) -> bool:.     
-00005090: 2020 2022 2222 5768 6574 6865 7220 7468     """Whether th
-000050a0: 6520 6c6f 6361 6c20 4472 6f70 626f 7820  e local Dropbox 
-000050b0: 6469 7265 6374 6f72 7920 6c69 6573 206f  directory lies o
-000050c0: 6e20 6120 6361 7365 2d73 656e 7369 7469  n a case-sensiti
-000050d0: 7665 2066 696c 6520 7379 7374 656d 2e22  ve file system."
-000050e0: 2222 0a20 2020 2020 2020 2072 6574 7572  "".        retur
-000050f0: 6e20 7365 6c66 2e5f 6973 5f66 735f 6361  n self._is_fs_ca
-00005100: 7365 5f73 656e 7369 7469 7665 0a0a 2020  se_sensitive..  
-00005110: 2020 4070 726f 7065 7274 790a 2020 2020    @property.    
-00005120: 6465 6620 6461 7461 6261 7365 5f70 6174  def database_pat
-00005130: 6828 7365 6c66 2920 2d3e 2073 7472 3a0a  h(self) -> str:.
-00005140: 2020 2020 2020 2020 2222 2250 6174 6820          """Path 
-00005150: 5351 4c69 7465 2064 6174 6162 6173 652e  SQLite database.
-00005160: 2222 220a 2020 2020 2020 2020 7265 7475  """.        retu
-00005170: 726e 2073 656c 662e 5f64 625f 7061 7468  rn self._db_path
-00005180: 0a0a 2020 2020 4070 726f 7065 7274 790a  ..    @property.
-00005190: 2020 2020 6465 6620 6669 6c65 5f63 6163      def file_cac
-000051a0: 6865 5f70 6174 6828 7365 6c66 2920 2d3e  he_path(self) ->
-000051b0: 2073 7472 3a0a 2020 2020 2020 2020 2222   str:.        ""
-000051c0: 2250 6174 6820 746f 2063 6163 6865 2066  "Path to cache f
-000051d0: 6f6c 6465 7220 666f 7220 7465 6d70 6f72  older for tempor
-000051e0: 6172 7920 6669 6c65 7320 2872 6561 6420  ary files (read 
-000051f0: 6f6e 6c79 292e 2054 6865 2063 6163 6865  only). The cache
-00005200: 2066 6f6c 6465 720a 2020 2020 2020 2020   folder.        
-00005210: 272e 6d61 6573 7472 616c 2e63 6163 6865  '.maestral.cache
-00005220: 2720 6973 206c 6f63 6174 6564 2069 6e73  ' is located ins
-00005230: 6964 6520 7468 6520 6c6f 6361 6c20 4472  ide the local Dr
-00005240: 6f70 626f 7820 666f 6c64 6572 2074 6f20  opbox folder to 
-00005250: 7072 6576 656e 7420 6669 6c65 0a20 2020  prevent file.   
-00005260: 2020 2020 2074 7261 6e73 6665 7220 6265       transfer be
-00005270: 7477 6565 6e20 6469 6666 6572 656e 7420  tween different 
-00005280: 7061 7274 6974 696f 6e73 206f 7220 6472  partitions or dr
-00005290: 6976 6573 2064 7572 696e 6720 7379 6e63  ives during sync
-000052a0: 2e22 2222 0a20 2020 2020 2020 2072 6574  .""".        ret
-000052b0: 7572 6e20 7365 6c66 2e5f 6669 6c65 5f63  urn self._file_c
-000052c0: 6163 6865 5f70 6174 680a 0a20 2020 2040  ache_path..    @
-000052d0: 7072 6f70 6572 7479 0a20 2020 2064 6566  property.    def
-000052e0: 2065 7863 6c75 6465 645f 6974 656d 7328   excluded_items(
-000052f0: 7365 6c66 2920 2d3e 206c 6973 745b 7374  self) -> list[st
-00005300: 725d 3a0a 2020 2020 2020 2020 2222 224c  r]:.        """L
-00005310: 6973 7420 6f66 2061 6c6c 2066 696c 6573  ist of all files
-00005320: 2061 6e64 2066 6f6c 6465 7273 2065 7863   and folders exc
-00005330: 6c75 6465 6420 6672 6f6d 2073 796e 632e  luded from sync.
-00005340: 2043 6861 6e67 6573 2061 7265 2073 6176   Changes are sav
-00005350: 6564 2074 6f20 7468 650a 2020 2020 2020  ed to the.      
-00005360: 2020 636f 6e66 6967 2066 696c 652e 2049    config file. I
-00005370: 6620 6120 7061 7265 6e74 2066 6f6c 6465  f a parent folde
-00005380: 7220 6973 2065 7863 6c75 6465 642c 2069  r is excluded, i
-00005390: 7473 2063 6869 6c64 7265 6e20 7769 6c6c  ts children will
-000053a0: 2061 7574 6f6d 6174 6963 616c 6c79 2062   automatically b
-000053b0: 650a 2020 2020 2020 2020 7265 6d6f 7665  e.        remove
-000053c0: 6420 6672 6f6d 2074 6865 206c 6973 742e  d from the list.
-000053d0: 2049 6620 6f6e 6c79 2063 6869 6c64 7265   If only childre
-000053e0: 6e20 6172 6520 6769 7665 6e20 6275 7420  n are given but 
-000053f0: 6e6f 7420 7468 6520 7061 7265 6e74 2066  not the parent f
-00005400: 6f6c 6465 722c 2061 6e79 0a20 2020 2020  older, any.     
-00005410: 2020 206e 6577 2069 7465 6d73 2061 6464     new items add
-00005420: 6564 2074 6f20 7468 6520 7061 7265 6e74  ed to the parent
-00005430: 2077 696c 6c20 6265 2073 796e 6365 642e   will be synced.
-00005440: 2043 6861 6e67 6520 7468 6973 2070 726f   Change this pro
-00005450: 7065 7274 7920 2a62 6566 6f72 652a 0a20  perty *before*. 
-00005460: 2020 2020 2020 2064 6f77 6e6c 6f61 6469         downloadi
-00005470: 6e67 206e 6577 6c79 2069 6e63 6c75 6465  ng newly include
-00005480: 6420 6974 656d 7320 6f72 2064 656c 6574  d items or delet
-00005490: 696e 6720 6578 636c 7564 6564 2069 7465  ing excluded ite
-000054a0: 6d73 2e22 2222 0a20 2020 2020 2020 2072  ms.""".        r
-000054b0: 6574 7572 6e20 7365 6c66 2e5f 6578 636c  eturn self._excl
-000054c0: 7564 6564 5f69 7465 6d73 0a0a 2020 2020  uded_items..    
-000054d0: 4065 7863 6c75 6465 645f 6974 656d 732e  @excluded_items.
-000054e0: 7365 7474 6572 0a20 2020 2064 6566 2065  setter.    def e
-000054f0: 7863 6c75 6465 645f 6974 656d 7328 7365  xcluded_items(se
-00005500: 6c66 2c20 666f 6c64 6572 5f6c 6973 743a  lf, folder_list:
-00005510: 206c 6973 745b 7374 725d 2920 2d3e 204e   list[str]) -> N
-00005520: 6f6e 653a 0a20 2020 2020 2020 2022 2222  one:.        """
-00005530: 5365 7474 6572 3a20 6578 636c 7564 6564  Setter: excluded
-00005540: 5f69 7465 6d73 2222 220a 2020 2020 2020  _items""".      
-00005550: 2020 7769 7468 2073 656c 662e 7379 6e63    with self.sync
-00005560: 5f6c 6f63 6b3a 0a20 2020 2020 2020 2020  _lock:.         
-00005570: 2020 2063 6c65 616e 5f6c 6973 7420 3d20     clean_list = 
-00005580: 7365 6c66 2e63 6c65 616e 5f65 7863 6c75  self.clean_exclu
-00005590: 6465 645f 6974 656d 735f 6c69 7374 2866  ded_items_list(f
-000055a0: 6f6c 6465 725f 6c69 7374 290a 2020 2020  older_list).    
-000055b0: 2020 2020 2020 2020 7365 6c66 2e5f 6578          self._ex
-000055c0: 636c 7564 6564 5f69 7465 6d73 203d 2063  cluded_items = c
-000055d0: 6c65 616e 5f6c 6973 740a 2020 2020 2020  lean_list.      
-000055e0: 2020 2020 2020 7365 6c66 2e5f 636f 6e66        self._conf
-000055f0: 2e73 6574 2822 7379 6e63 222c 2022 6578  .set("sync", "ex
-00005600: 636c 7564 6564 5f69 7465 6d73 222c 2063  cluded_items", c
-00005610: 6c65 616e 5f6c 6973 7429 0a0a 2020 2020  lean_list)..    
-00005620: 4073 7461 7469 636d 6574 686f 640a 2020  @staticmethod.  
-00005630: 2020 6465 6620 636c 6561 6e5f 6578 636c    def clean_excl
-00005640: 7564 6564 5f69 7465 6d73 5f6c 6973 7428  uded_items_list(
-00005650: 666f 6c64 6572 5f6c 6973 743a 2043 6f6c  folder_list: Col
-00005660: 6c65 6374 696f 6e5b 7374 725d 2920 2d3e  lection[str]) ->
-00005670: 206c 6973 745b 7374 725d 3a0a 2020 2020   list[str]:.    
-00005680: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
-00005690: 5265 6d6f 7665 7320 616c 6c20 6475 706c  Removes all dupl
-000056a0: 6963 6174 6573 2061 6e64 2063 6869 6c64  icates and child
-000056b0: 7265 6e20 6f66 2065 7863 6c75 6465 6420  ren of excluded 
-000056c0: 6974 656d 7320 6672 6f6d 2074 6865 2065  items from the e
-000056d0: 7863 6c75 6465 6420 6974 656d 730a 2020  xcluded items.  
-000056e0: 2020 2020 2020 6c69 7374 2e20 4e6f 726d        list. Norm
-000056f0: 616c 6973 6573 2061 6c6c 2070 6174 6873  alises all paths
-00005700: 2074 6f20 6c6f 7765 7220 6361 7365 2e0a   to lower case..
-00005710: 0a20 2020 2020 2020 203a 7061 7261 6d20  .        :param 
-00005720: 666f 6c64 6572 5f6c 6973 743a 2044 726f  folder_list: Dro
-00005730: 7062 6f78 2070 6174 6873 2074 6f20 6578  pbox paths to ex
-00005740: 636c 7564 652e 0a20 2020 2020 2020 203a  clude..        :
-00005750: 7265 7475 726e 733a 2043 6c65 616e 6564  returns: Cleaned
-00005760: 2075 7020 6974 656d 732e 0a20 2020 2020   up items..     
-00005770: 2020 2022 2222 0a20 2020 2020 2020 2023     """.        #
-00005780: 2052 656d 6f76 6520 6475 706c 6963 6174   Remove duplicat
-00005790: 6520 656e 7472 6965 7320 6279 2063 7265  e entries by cre
-000057a0: 6174 696e 6720 7365 742c 2073 7472 6970  ating set, strip
-000057b0: 2074 7261 696c 696e 6720 272f 272e 0a20   trailing '/'.. 
-000057c0: 2020 2020 2020 2066 6f6c 6465 725f 7365         folder_se
-000057d0: 7420 3d20 7b6e 6f72 6d61 6c69 7a65 2866  t = {normalize(f
-000057e0: 292e 7273 7472 6970 2822 2f22 2920 666f  ).rstrip("/") fo
-000057f0: 7220 6620 696e 2066 6f6c 6465 725f 6c69  r f in folder_li
-00005800: 7374 7d0a 0a20 2020 2020 2020 2023 2052  st}..        # R
-00005810: 656d 6f76 6520 616c 6c20 6368 696c 6472  emove all childr
-00005820: 656e 206f 6620 6578 636c 7564 6564 2066  en of excluded f
-00005830: 6f6c 6465 7273 2e0a 2020 2020 2020 2020  olders..        
-00005840: 636c 6561 6e5f 6c69 7374 203d 206c 6973  clean_list = lis
-00005850: 7428 666f 6c64 6572 5f73 6574 290a 2020  t(folder_set).  
-00005860: 2020 2020 2020 666f 7220 666f 6c64 6572        for folder
-00005870: 2069 6e20 666f 6c64 6572 5f73 6574 3a0a   in folder_set:.
-00005880: 2020 2020 2020 2020 2020 2020 636c 6561              clea
-00005890: 6e5f 6c69 7374 203d 205b 6620 666f 7220  n_list = [f for 
-000058a0: 6620 696e 2063 6c65 616e 5f6c 6973 7420  f in clean_list 
-000058b0: 6966 206e 6f74 2069 735f 6368 696c 6428  if not is_child(
-000058c0: 662c 2066 6f6c 6465 7229 5d0a 0a20 2020  f, folder)]..   
-000058d0: 2020 2020 2072 6574 7572 6e20 636c 6561       return clea
-000058e0: 6e5f 6c69 7374 0a0a 2020 2020 4070 726f  n_list..    @pro
-000058f0: 7065 7274 790a 2020 2020 6465 6620 6d61  perty.    def ma
-00005900: 785f 6370 755f 7065 7263 656e 7428 7365  x_cpu_percent(se
-00005910: 6c66 2920 2d3e 2066 6c6f 6174 3a0a 2020  lf) -> float:.  
-00005920: 2020 2020 2020 2222 224d 6178 696d 756d        """Maximum
-00005930: 2043 5055 2075 7361 6765 2066 6f72 2070   CPU usage for p
-00005940: 6172 616c 6c65 6c20 646f 776e 6c6f 6164  arallel download
-00005950: 7320 6f72 2075 706c 6f61 6473 2069 6e20  s or uploads in 
-00005960: 7065 7263 656e 7420 6f66 2074 6865 2074  percent of the t
-00005970: 6f74 616c 0a20 2020 2020 2020 2061 7661  otal.        ava
-00005980: 696c 6162 6c65 2043 5055 2074 696d 6520  ilable CPU time 
-00005990: 7065 7220 636f 7265 2e20 496e 6469 7669  per core. Indivi
-000059a0: 6475 616c 2077 6f72 6b65 7273 2069 6e20  dual workers in 
-000059b0: 6120 7468 7265 6164 2070 6f6f 6c20 7769  a thread pool wi
-000059c0: 6c6c 2070 6175 7365 0a20 2020 2020 2020  ll pause.       
-000059d0: 2075 6e74 696c 2074 6865 2075 7361 6765   until the usage
-000059e0: 2064 726f 7073 2062 656c 6f77 2074 6869   drops below thi
-000059f0: 7320 7661 6c75 652e 2054 6173 6b73 2069  s value. Tasks i
-00005a00: 6e20 7468 6520 6d61 696e 2074 6872 6561  n the main threa
-00005a10: 6420 7375 6368 2061 730a 2020 2020 2020  d such as.      
-00005a20: 2020 696e 6465 7869 6e67 2066 696c 6520    indexing file 
-00005a30: 6368 616e 6765 7320 6d61 7920 7374 696c  changes may stil
-00005a40: 6c20 7573 6520 6d6f 7265 2043 5055 2074  l use more CPU t
-00005a50: 696d 652e 2053 6574 7469 6e67 2074 6869  ime. Setting thi
-00005a60: 7320 746f 2032 3030 2520 6d65 616e 730a  s to 200% means.
-00005a70: 2020 2020 2020 2020 7468 6174 2074 776f          that two
-00005a80: 2066 756c 6c20 6c6f 6769 6361 6c20 4350   full logical CP
-00005a90: 5520 636f 7265 2063 616e 2062 6520 7573  U core can be us
-00005aa0: 6564 2e22 2222 0a20 2020 2020 2020 2072  ed.""".        r
-00005ab0: 6574 7572 6e20 7365 6c66 2e5f 6d61 785f  eturn self._max_
-00005ac0: 6370 755f 7065 7263 656e 740a 0a20 2020  cpu_percent..   
-00005ad0: 2040 6d61 785f 6370 755f 7065 7263 656e   @max_cpu_percen
-00005ae0: 742e 7365 7474 6572 0a20 2020 2064 6566  t.setter.    def
-00005af0: 206d 6178 5f63 7075 5f70 6572 6365 6e74   max_cpu_percent
-00005b00: 2873 656c 662c 2070 6572 6365 6e74 3a20  (self, percent: 
-00005b10: 666c 6f61 7429 202d 3e20 4e6f 6e65 3a0a  float) -> None:.
-00005b20: 2020 2020 2020 2020 2222 2253 6574 7465          """Sette
-00005b30: 723a 206d 6178 5f63 7075 5f70 6572 6365  r: max_cpu_perce
-00005b40: 6e74 2e22 2222 0a20 2020 2020 2020 2073  nt.""".        s
-00005b50: 656c 662e 5f6d 6178 5f63 7075 5f70 6572  elf._max_cpu_per
-00005b60: 6365 6e74 203d 2070 6572 6365 6e74 0a20  cent = percent. 
-00005b70: 2020 2020 2020 2073 656c 662e 5f63 6f6e         self._con
-00005b80: 662e 7365 7428 2273 796e 6322 2c20 226d  f.set("sync", "m
-00005b90: 6178 5f63 7075 5f70 6572 6365 6e74 222c  ax_cpu_percent",
-00005ba0: 2070 6572 6365 6e74 202f 2f20 4350 555f   percent // CPU_
-00005bb0: 434f 5245 5f43 4f55 4e54 290a 0a20 2020  CORE_COUNT)..   
-00005bc0: 2023 203d 3d3d 3d20 5379 6e63 2073 7461   # ==== Sync sta
-00005bd0: 7465 203d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  te =============
-00005be0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00005bf0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00005c00: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00005c10: 3d3d 3d3d 3d0a 0a20 2020 2040 7072 6f70  =====..    @prop
-00005c20: 6572 7479 0a20 2020 2064 6566 2072 656d  erty.    def rem
-00005c30: 6f74 655f 6375 7273 6f72 2873 656c 6629  ote_cursor(self)
-00005c40: 202d 3e20 7374 723a 0a20 2020 2020 2020   -> str:.       
-00005c50: 2022 2222 4375 7273 6f72 2066 726f 6d20   """Cursor from 
-00005c60: 6c61 7374 2073 796e 6320 7769 7468 2072  last sync with r
-00005c70: 656d 6f74 6520 4472 6f70 626f 782e 2054  emote Dropbox. T
-00005c80: 6865 2076 616c 7565 2069 7320 7570 6461  he value is upda
-00005c90: 7465 6420 616e 6420 7361 7665 6420 746f  ted and saved to
-00005ca0: 0a20 2020 2020 2020 2074 6865 2063 6f6e  .        the con
-00005cb0: 6669 6720 6669 6c65 206f 6e20 6576 6572  fig file on ever
-00005cc0: 7920 7375 6363 6573 7366 756c 2064 6f77  y successful dow
-00005cd0: 6e6c 6f61 6420 6f66 2072 656d 6f74 6520  nload of remote 
-00005ce0: 6368 616e 6765 732e 2222 220a 2020 2020  changes.""".    
-00005cf0: 2020 2020 7265 7475 726e 2073 656c 662e      return self.
-00005d00: 5f73 7461 7465 2e67 6574 2822 7379 6e63  _state.get("sync
-00005d10: 222c 2022 6375 7273 6f72 2229 0a0a 2020  ", "cursor")..  
-00005d20: 2020 4072 656d 6f74 655f 6375 7273 6f72    @remote_cursor
-00005d30: 2e73 6574 7465 720a 2020 2020 6465 6620  .setter.    def 
-00005d40: 7265 6d6f 7465 5f63 7572 736f 7228 7365  remote_cursor(se
-00005d50: 6c66 2c20 6375 7273 6f72 3a20 7374 7229  lf, cursor: str)
-00005d60: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2020   -> None:.      
-00005d70: 2020 2222 2253 6574 7465 723a 206c 6173    """Setter: las
-00005d80: 745f 6375 7273 6f72 2222 220a 2020 2020  t_cursor""".    
-00005d90: 2020 2020 7769 7468 2073 656c 662e 7379      with self.sy
-00005da0: 6e63 5f6c 6f63 6b3a 0a20 2020 2020 2020  nc_lock:.       
-00005db0: 2020 2020 2073 656c 662e 5f73 7461 7465       self._state
-00005dc0: 2e73 6574 2822 7379 6e63 222c 2022 6375  .set("sync", "cu
-00005dd0: 7273 6f72 222c 2063 7572 736f 7229 0a0a  rsor", cursor)..
-00005de0: 2020 2020 2020 2020 7365 6c66 2e5f 6c6f          self._lo
-00005df0: 6767 6572 2e64 6562 7567 2822 5265 6d6f  gger.debug("Remo
-00005e00: 7465 2063 7572 736f 7220 7361 7665 643a  te cursor saved:
-00005e10: 2025 7322 2c20 6375 7273 6f72 290a 0a20   %s", cursor).. 
-00005e20: 2020 2040 7072 6f70 6572 7479 0a20 2020     @property.   
-00005e30: 2064 6566 206c 6f63 616c 5f63 7572 736f   def local_curso
-00005e40: 7228 7365 6c66 2920 2d3e 2066 6c6f 6174  r(self) -> float
-00005e50: 3a0a 2020 2020 2020 2020 2222 2254 696d  :.        """Tim
-00005e60: 6520 7374 616d 7020 6672 6f6d 206c 6173  e stamp from las
-00005e70: 7420 7379 6e63 2077 6974 6820 7265 6d6f  t sync with remo
-00005e80: 7465 2044 726f 7062 6f78 2e20 5468 6520  te Dropbox. The 
-00005e90: 7661 6c75 6520 6973 2075 7064 6174 6564  value is updated
-00005ea0: 2061 6e64 2073 6176 6564 0a20 2020 2020   and saved.     
-00005eb0: 2020 2074 6f20 7468 6520 636f 6e66 6967     to the config
-00005ec0: 2066 696c 6520 6f6e 2065 7665 7279 2073   file on every s
-00005ed0: 7563 6365 7373 6675 6c20 7570 6c6f 6164  uccessful upload
-00005ee0: 206f 6620 6c6f 6361 6c20 6368 616e 6765   of local change
-00005ef0: 732e 2222 220a 2020 2020 2020 2020 7265  s.""".        re
-00005f00: 7475 726e 2073 656c 662e 5f6c 6f63 616c  turn self._local
-00005f10: 5f63 7572 736f 720a 0a20 2020 2040 6c6f  _cursor..    @lo
-00005f20: 6361 6c5f 6375 7273 6f72 2e73 6574 7465  cal_cursor.sette
-00005f30: 720a 2020 2020 6465 6620 6c6f 6361 6c5f  r.    def local_
-00005f40: 6375 7273 6f72 2873 656c 662c 206c 6173  cursor(self, las
-00005f50: 745f 7379 6e63 3a20 666c 6f61 7429 202d  t_sync: float) -
-00005f60: 3e20 4e6f 6e65 3a0a 2020 2020 2020 2020  > None:.        
-00005f70: 2222 2253 6574 7465 723a 206c 6f63 616c  """Setter: local
-00005f80: 5f63 7572 736f 7222 2222 0a20 2020 2020  _cursor""".     
-00005f90: 2020 2077 6974 6820 7365 6c66 2e73 796e     with self.syn
-00005fa0: 635f 6c6f 636b 3a0a 2020 2020 2020 2020  c_lock:.        
-00005fb0: 2020 2020 7365 6c66 2e5f 6c6f 6361 6c5f      self._local_
-00005fc0: 6375 7273 6f72 203d 206c 6173 745f 7379  cursor = last_sy
-00005fd0: 6e63 0a20 2020 2020 2020 2020 2020 2073  nc.            s
-00005fe0: 656c 662e 5f73 7461 7465 2e73 6574 2822  elf._state.set("
-00005ff0: 7379 6e63 222c 2022 6c61 7374 7379 6e63  sync", "lastsync
-00006000: 222c 206c 6173 745f 7379 6e63 290a 0a20  ", last_sync).. 
-00006010: 2020 2020 2020 2073 656c 662e 5f6c 6f67         self._log
-00006020: 6765 722e 6465 6275 6728 224c 6f63 616c  ger.debug("Local
-00006030: 2063 7572 736f 7220 7361 7665 643a 2025   cursor saved: %
-00006040: 7322 2c20 6c61 7374 5f73 796e 6329 0a0a  s", last_sync)..
-00006050: 2020 2020 4070 726f 7065 7274 790a 2020      @property.  
-00006060: 2020 6465 6620 6c61 7374 5f63 6861 6e67    def last_chang
-00006070: 6528 7365 6c66 2920 2d3e 2066 6c6f 6174  e(self) -> float
-00006080: 3a0a 2020 2020 2020 2020 2222 2254 6865  :.        """The
-00006090: 2074 696d 6520 7374 616d 7020 6f66 2074   time stamp of t
-000060a0: 6865 206c 6173 7420 6669 6c65 2063 6861  he last file cha
-000060b0: 6e67 6520 6f72 2030 2e30 2069 6620 7468  nge or 0.0 if th
-000060c0: 6572 6520 6172 6520 6e6f 2066 696c 6520  ere are no file 
-000060d0: 6368 616e 6765 7320 696e 0a20 2020 2020  changes in.     
-000060e0: 2020 206f 7572 2068 6973 746f 7279 2e22     our history."
-000060f0: 2222 0a20 2020 2020 2020 2077 6974 6820  "".        with 
-00006100: 7365 6c66 2e5f 6461 7461 6261 7365 5f61  self._database_a
-00006110: 6363 6573 7328 293a 0a20 2020 2020 2020  ccess():.       
-00006120: 2020 2020 2072 6f77 203d 2073 656c 662e       row = self.
-00006130: 5f64 622e 6578 6563 7574 6528 2253 454c  _db.execute("SEL
-00006140: 4543 5420 4d41 5828 6c61 7374 5f73 796e  ECT MAX(last_syn
-00006150: 6329 2046 524f 4d20 2769 6e64 6578 2722  c) FROM 'index'"
-00006160: 292e 6665 7463 686f 6e65 2829 0a20 2020  ).fetchone().   
-00006170: 2020 2020 2020 2020 2069 6620 6e6f 7420           if not 
-00006180: 726f 773a 0a20 2020 2020 2020 2020 2020  row:.           
-00006190: 2020 2020 2072 6574 7572 6e20 302e 300a       return 0.0.
-000061a0: 2020 2020 2020 2020 2020 2020 7472 793a              try:
-000061b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000061c0: 2072 6574 7572 6e20 726f 775b 305d 206f   return row[0] o
-000061d0: 7220 302e 300a 2020 2020 2020 2020 2020  r 0.0.          
-000061e0: 2020 6578 6365 7074 2049 6e64 6578 4572    except IndexEr
-000061f0: 726f 723a 0a20 2020 2020 2020 2020 2020  ror:.           
-00006200: 2020 2020 2072 6574 7572 6e20 302e 300a       return 0.0.
-00006210: 0a20 2020 2040 7072 6f70 6572 7479 0a20  .    @property. 
-00006220: 2020 2064 6566 206c 6173 745f 7265 696e     def last_rein
-00006230: 6465 7828 7365 6c66 2920 2d3e 2066 6c6f  dex(self) -> flo
-00006240: 6174 3a0a 2020 2020 2020 2020 2222 2254  at:.        """T
-00006250: 696d 6520 7374 616d 7020 6f66 206c 6173  ime stamp of las
-00006260: 7420 6675 6c6c 2069 6e64 6578 696e 672e  t full indexing.
-00006270: 2054 6869 7320 6973 2075 7365 6420 746f   This is used to
-00006280: 2064 6574 6572 6d69 6e65 2077 6865 6e20   determine when 
-00006290: 7468 6520 6e65 7874 0a20 2020 2020 2020  the next.       
-000062a0: 2066 756c 6c20 696e 6465 7869 6e67 2073   full indexing s
-000062b0: 686f 756c 6420 7461 6b65 2070 6c61 6365  hould take place
-000062c0: 2e22 2222 0a20 2020 2020 2020 2072 6574  .""".        ret
-000062d0: 7572 6e20 7365 6c66 2e5f 7374 6174 652e  urn self._state.
-000062e0: 6765 7428 2273 796e 6322 2c20 226c 6173  get("sync", "las
-000062f0: 745f 7265 696e 6465 7822 290a 0a20 2020  t_reindex")..   
-00006300: 2064 6566 2067 6574 5f68 6973 746f 7279   def get_history
-00006310: 2873 656c 662c 2064 6278 5f70 6174 683a  (self, dbx_path:
-00006320: 2073 7472 207c 204e 6f6e 6520 3d20 4e6f   str | None = No
-00006330: 6e65 2920 2d3e 206c 6973 745b 5379 6e63  ne) -> list[Sync
-00006340: 4576 656e 745d 3a0a 2020 2020 2020 2020  Event]:.        
-00006350: 2222 2241 206c 6973 7420 6f66 2074 6865  """A list of the
-00006360: 206c 6173 7420 5379 6e63 4576 656e 7473   last SyncEvents
-00006370: 2069 6e20 6f75 7220 6869 7374 6f72 792e   in our history.
-00006380: 2048 6973 746f 7279 2077 696c 6c20 6265   History will be
-00006390: 206b 6570 7420 666f 7220 7468 650a 2020   kept for the.  
-000063a0: 2020 2020 2020 696e 7465 7276 616c 2073        interval s
-000063b0: 7065 6369 6669 6564 2062 7920 7468 6520  pecified by the 
-000063c0: 636f 6e66 6967 2076 616c 7565 2060 606b  config value ``k
-000063d0: 6565 705f 6869 7374 6f72 7960 6020 2864  eep_history`` (d
-000063e0: 6566 6175 6c74 7320 746f 2074 776f 2077  efaults to two w
-000063f0: 6565 6b73 290a 2020 2020 2020 2020 6275  eeks).        bu
-00006400: 7420 6174 206d 6f73 7420 312c 3030 3020  t at most 1,000 
-00006410: 6576 656e 7473 2077 696c 6c20 6265 206b  events will be k
-00006420: 6570 742e 2222 220a 2020 2020 2020 2020  ept.""".        
-00006430: 7769 7468 2073 656c 662e 5f64 6174 6162  with self._datab
-00006440: 6173 655f 6163 6365 7373 2829 3a0a 2020  ase_access():.  
-00006450: 2020 2020 2020 2020 2020 7175 6572 793a            query:
-00006460: 2051 7565 7279 0a20 2020 2020 2020 2020   Query.         
-00006470: 2020 2069 6620 6462 785f 7061 7468 2069     if dbx_path i
-00006480: 7320 4e6f 6e65 3a0a 2020 2020 2020 2020  s None:.        
-00006490: 2020 2020 2020 2020 7175 6572 7920 3d20          query = 
-000064a0: 416c 6c51 7565 7279 2829 0a20 2020 2020  AllQuery().     
-000064b0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-000064c0: 2020 2020 2020 2020 2020 2020 2071 7565               que
-000064d0: 7279 203d 204d 6174 6368 5175 6572 7928  ry = MatchQuery(
-000064e0: 5379 6e63 4576 656e 742e 6462 785f 7061  SyncEvent.dbx_pa
-000064f0: 7468 2c20 6462 785f 7061 7468 290a 0a20  th, dbx_path).. 
-00006500: 2020 2020 2020 2020 2020 206f 7264 6572             order
-00006510: 5f65 7870 7220 3d20 2249 464e 554c 4c28  _expr = "IFNULL(
-00006520: 6368 616e 6765 5f74 696d 652c 2073 796e  change_time, syn
-00006530: 635f 7469 6d65 2922 0a20 2020 2020 2020  c_time)".       
-00006540: 2020 2020 2073 796e 635f 6576 656e 7473       sync_events
-00006550: 203d 2073 656c 662e 5f68 6973 746f 7279   = self._history
-00006560: 5f74 6162 6c65 2e73 656c 6563 7428 7175  _table.select(qu
-00006570: 6572 792e 6f72 6465 725f 6279 286f 7264  ery.order_by(ord
-00006580: 6572 5f65 7870 7229 290a 2020 2020 2020  er_expr)).      
-00006590: 2020 2020 2020 7265 7475 726e 2073 796e        return syn
-000065a0: 635f 6576 656e 7473 0a0a 2020 2020 6465  c_events..    de
-000065b0: 6620 7265 7365 745f 7379 6e63 5f73 7461  f reset_sync_sta
-000065c0: 7465 2873 656c 6629 202d 3e20 4e6f 6e65  te(self) -> None
-000065d0: 3a0a 2020 2020 2020 2020 2222 2252 6573  :.        """Res
-000065e0: 6574 7320 616c 6c20 7361 7665 6420 7379  ets all saved sy
-000065f0: 6e63 2073 7461 7465 2e20 5365 7474 696e  nc state. Settin
-00006600: 6773 2061 7265 206e 6f74 2061 6666 6563  gs are not affec
-00006610: 7465 642e 2222 220a 2020 2020 2020 2020  ted.""".        
-00006620: 6966 2073 656c 662e 6275 7379 2829 3a0a  if self.busy():.
-00006630: 2020 2020 2020 2020 2020 2020 7261 6973              rais
-00006640: 6520 5275 6e74 696d 6545 7272 6f72 2822  e RuntimeError("
-00006650: 4361 6e6e 6f74 2072 6573 6574 2073 796e  Cannot reset syn
-00006660: 6320 7374 6174 6520 7768 696c 6520 7379  c state while sy
-00006670: 6e63 696e 672e 2229 0a0a 2020 2020 2020  ncing.")..      
-00006680: 2020 7769 7468 2073 656c 662e 5f64 6174    with self._dat
-00006690: 6162 6173 655f 6163 6365 7373 2829 3a0a  abase_access():.
-000066a0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-000066b0: 2e5f 696e 6465 785f 7461 626c 652e 636c  ._index_table.cl
-000066c0: 6561 7228 290a 2020 2020 2020 2020 2020  ear().          
-000066d0: 2020 7365 6c66 2e5f 6869 7374 6f72 795f    self._history_
-000066e0: 7461 626c 652e 636c 6561 7228 290a 2020  table.clear().  
-000066f0: 2020 2020 2020 2020 2020 7365 6c66 2e5f            self._
-00006700: 7379 6e63 5f65 7272 6f72 735f 7461 626c  sync_errors_tabl
-00006710: 652e 636c 6561 7228 290a 2020 2020 2020  e.clear().      
-00006720: 2020 2020 2020 7365 6c66 2e5f 6861 7368        self._hash
-00006730: 5f74 6162 6c65 2e63 6c65 6172 2829 0a0a  _table.clear()..
-00006740: 2020 2020 2020 2020 7365 6c66 2e5f 7374          self._st
-00006750: 6174 652e 7265 7365 745f 746f 5f64 6566  ate.reset_to_def
-00006760: 6175 6c74 7328 2273 796e 6322 290a 2020  aults("sync").  
-00006770: 2020 2020 2020 7365 6c66 2e72 656c 6f61        self.reloa
-00006780: 645f 6361 6368 6564 5f63 6f6e 6669 6728  d_cached_config(
-00006790: 290a 0a20 2020 2020 2020 2073 656c 662e  )..        self.
-000067a0: 5f6c 6f67 6765 722e 6465 6275 6728 2253  _logger.debug("S
-000067b0: 796e 6320 7374 6174 6520 7265 7365 7422  ync state reset"
-000067c0: 290a 0a20 2020 2023 203d 3d3d 3d20 5379  )..    # ==== Sy
-000067d0: 6e63 2065 7272 6f72 206d 616e 6167 656d  nc error managem
-000067e0: 656e 7420 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ent ============
-000067f0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00006800: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00006810: 3d3d 3d3d 3d3d 3d3d 3d3d 3d0a 0a20 2020  ===========..   
-00006820: 2040 7072 6f70 6572 7479 0a20 2020 2064   @property.    d
-00006830: 6566 2073 796e 635f 6572 726f 7273 2873  ef sync_errors(s
-00006840: 656c 6629 202d 3e20 6c69 7374 5b53 796e  elf) -> list[Syn
-00006850: 6345 7272 6f72 456e 7472 795d 3a0a 2020  cErrorEntry]:.  
-00006860: 2020 2020 2020 2222 2252 6574 7572 6e73        """Returns
-00006870: 2061 206c 6973 7420 6f66 2061 6c6c 2073   a list of all s
-00006880: 796e 6320 6572 726f 7273 2e22 2222 0a20  ync errors.""". 
-00006890: 2020 2020 2020 2077 6974 6820 7365 6c66         with self
-000068a0: 2e5f 6461 7461 6261 7365 5f61 6363 6573  ._database_acces
-000068b0: 7328 293a 0a20 2020 2020 2020 2020 2020  s():.           
-000068c0: 2072 6574 7572 6e20 7365 6c66 2e5f 7379   return self._sy
-000068d0: 6e63 5f65 7272 6f72 735f 7461 626c 652e  nc_errors_table.
-000068e0: 7365 6c65 6374 2841 6c6c 5175 6572 7928  select(AllQuery(
-000068f0: 2929 0a0a 2020 2020 4070 726f 7065 7274  ))..    @propert
-00006900: 790a 2020 2020 6465 6620 7570 6c6f 6164  y.    def upload
-00006910: 5f65 7272 6f72 7328 7365 6c66 2920 2d3e  _errors(self) ->
-00006920: 206c 6973 745b 5379 6e63 4572 726f 7245   list[SyncErrorE
-00006930: 6e74 7279 5d3a 0a20 2020 2020 2020 2022  ntry]:.        "
-00006940: 2222 5265 7475 726e 7320 6120 6c69 7374  ""Returns a list
-00006950: 206f 6620 616c 6c20 7570 6c6f 6164 2065   of all upload e
-00006960: 7272 6f72 732e 2222 220a 2020 2020 2020  rrors.""".      
-00006970: 2020 7769 7468 2073 656c 662e 5f64 6174    with self._dat
-00006980: 6162 6173 655f 6163 6365 7373 2829 3a0a  abase_access():.
-00006990: 2020 2020 2020 2020 2020 2020 7175 6572              quer
-000069a0: 7920 3d20 4d61 7463 6851 7565 7279 2853  y = MatchQuery(S
-000069b0: 796e 6345 7272 6f72 456e 7472 792e 6469  yncErrorEntry.di
-000069c0: 7265 6374 696f 6e2c 2053 796e 6344 6972  rection, SyncDir
-000069d0: 6563 7469 6f6e 2e55 7029 0a20 2020 2020  ection.Up).     
-000069e0: 2020 2020 2020 2072 6574 7572 6e20 7365         return se
-000069f0: 6c66 2e5f 7379 6e63 5f65 7272 6f72 735f  lf._sync_errors_
-00006a00: 7461 626c 652e 7365 6c65 6374 2871 7565  table.select(que
-00006a10: 7279 290a 0a20 2020 2040 7072 6f70 6572  ry)..    @proper
-00006a20: 7479 0a20 2020 2064 6566 2064 6f77 6e6c  ty.    def downl
-00006a30: 6f61 645f 6572 726f 7273 2873 656c 6629  oad_errors(self)
-00006a40: 202d 3e20 6c69 7374 5b53 796e 6345 7272   -> list[SyncErr
-00006a50: 6f72 456e 7472 795d 3a0a 2020 2020 2020  orEntry]:.      
-00006a60: 2020 2222 2252 6574 7572 6e73 2061 206c    """Returns a l
-00006a70: 6973 7420 6f66 2061 6c6c 2064 6f77 6e6c  ist of all downl
-00006a80: 6f61 6420 6572 726f 7273 2e22 2222 0a20  oad errors.""". 
-00006a90: 2020 2020 2020 2077 6974 6820 7365 6c66         with self
-00006aa0: 2e5f 6461 7461 6261 7365 5f61 6363 6573  ._database_acces
-00006ab0: 7328 293a 0a20 2020 2020 2020 2020 2020  s():.           
-00006ac0: 2071 7565 7279 203d 204d 6174 6368 5175   query = MatchQu
-00006ad0: 6572 7928 5379 6e63 4572 726f 7245 6e74  ery(SyncErrorEnt
-00006ae0: 7279 2e64 6972 6563 7469 6f6e 2c20 5379  ry.direction, Sy
-00006af0: 6e63 4469 7265 6374 696f 6e2e 446f 776e  ncDirection.Down
-00006b00: 290a 2020 2020 2020 2020 2020 2020 7265  ).            re
-00006b10: 7475 726e 2073 656c 662e 5f73 796e 635f  turn self._sync_
-00006b20: 6572 726f 7273 5f74 6162 6c65 2e73 656c  errors_table.sel
-00006b30: 6563 7428 7175 6572 7929 0a0a 2020 2020  ect(query)..    
-00006b40: 6465 6620 6861 735f 7379 6e63 5f65 7272  def has_sync_err
-00006b50: 6f72 7328 7365 6c66 2920 2d3e 2062 6f6f  ors(self) -> boo
-00006b60: 6c3a 0a20 2020 2020 2020 2022 2222 5265  l:.        """Re
-00006b70: 7475 726e 7320 6060 5472 7565 6060 2069  turns ``True`` i
-00006b80: 6e20 6361 7365 206f 6620 7379 6e63 2065  n case of sync e
-00006b90: 7272 6f72 732c 2060 6046 616c 7365 6060  rrors, ``False``
-00006ba0: 206f 7468 6572 7769 7365 2e22 2222 0a20   otherwise.""". 
-00006bb0: 2020 2020 2020 2077 6974 6820 7365 6c66         with self
-00006bc0: 2e5f 6461 7461 6261 7365 5f61 6363 6573  ._database_acces
-00006bd0: 7328 293a 0a20 2020 2020 2020 2020 2020  s():.           
-00006be0: 2072 6574 7572 6e20 7365 6c66 2e5f 7379   return self._sy
-00006bf0: 6e63 5f65 7272 6f72 735f 7461 626c 652e  nc_errors_table.
-00006c00: 636f 756e 7428 2920 3e20 300a 0a20 2020  count() > 0..   
-00006c10: 2064 6566 2073 796e 635f 6572 726f 7273   def sync_errors
-00006c20: 5f66 6f72 5f70 6174 6828 0a20 2020 2020  _for_path(.     
-00006c30: 2020 2073 656c 662c 2064 6278 5f70 6174     self, dbx_pat
-00006c40: 685f 6c6f 7765 723a 2073 7472 2c20 6469  h_lower: str, di
-00006c50: 7265 6374 696f 6e3a 2053 796e 6344 6972  rection: SyncDir
-00006c60: 6563 7469 6f6e 207c 204e 6f6e 6520 3d20  ection | None = 
-00006c70: 4e6f 6e65 0a20 2020 2029 202d 3e20 6c69  None.    ) -> li
-00006c80: 7374 5b53 796e 6345 7272 6f72 456e 7472  st[SyncErrorEntr
-00006c90: 795d 3a0a 2020 2020 2020 2020 2222 220a  y]:.        """.
-00006ca0: 2020 2020 2020 2020 5265 7475 726e 7320          Returns 
-00006cb0: 6120 6c69 7374 206f 6620 616c 6c20 7379  a list of all sy
-00006cc0: 6e63 2065 7272 6f72 7320 666f 7220 7468  nc errors for th
-00006cd0: 6520 6769 7665 6e20 7061 7468 2061 6e64  e given path and
-00006ce0: 2069 7473 2063 6869 6c64 7265 6e2e 0a0a   its children...
-00006cf0: 2020 2020 2020 2020 3a70 6172 616d 2064          :param d
-00006d00: 6278 5f70 6174 685f 6c6f 7765 723a 204e  bx_path_lower: N
-00006d10: 6f72 6d61 6c69 7365 6420 4472 6f70 626f  ormalised Dropbo
-00006d20: 7820 7061 7468 2e0a 2020 2020 2020 2020  x path..        
-00006d30: 3a70 6172 616d 2064 6972 6563 7469 6f6e  :param direction
-00006d40: 3a20 4469 7265 6374 696f 6e20 746f 2066  : Direction to f
-00006d50: 696c 7465 7220 7379 6e63 2065 7272 6f72  ilter sync error
-00006d60: 732e 2049 6620 6e6f 7420 6769 7665 6e2c  s. If not given,
-00006d70: 2062 6f74 6820 7570 6c6f 6164 0a20 2020   both upload.   
-00006d80: 2020 2020 2020 2020 2061 6e64 2064 6f77           and dow
-00006d90: 6e6c 6f61 6420 6572 726f 7273 2077 696c  nload errors wil
-00006da0: 6c20 6265 2072 6574 7572 6e65 642e 0a20  l be returned.. 
-00006db0: 2020 2020 2020 203a 7265 7475 726e 733a         :returns:
-00006dc0: 204c 6973 7420 6f66 2073 796e 6320 6572   List of sync er
-00006dd0: 726f 7273 2e0a 2020 2020 2020 2020 2222  rors..        ""
-00006de0: 220a 2020 2020 2020 2020 7769 7468 2073  ".        with s
-00006df0: 656c 662e 5f64 6174 6162 6173 655f 6163  elf._database_ac
-00006e00: 6365 7373 2829 3a0a 2020 2020 2020 2020  cess():.        
-00006e10: 2020 2020 7061 7468 5f74 7265 655f 7175      path_tree_qu
-00006e20: 6572 7920 3d20 5061 7468 5472 6565 5175  ery = PathTreeQu
-00006e30: 6572 7928 0a20 2020 2020 2020 2020 2020  ery(.           
-00006e40: 2020 2020 2053 796e 6345 7272 6f72 456e       SyncErrorEn
-00006e50: 7472 792e 6462 785f 7061 7468 5f6c 6f77  try.dbx_path_low
-00006e60: 6572 2c20 6462 785f 7061 7468 5f6c 6f77  er, dbx_path_low
-00006e70: 6572 0a20 2020 2020 2020 2020 2020 2029  er.            )
-00006e80: 0a0a 2020 2020 2020 2020 2020 2020 6966  ..            if
-00006e90: 2064 6972 6563 7469 6f6e 3a0a 2020 2020   direction:.    
-00006ea0: 2020 2020 2020 2020 2020 2020 6469 7265              dire
-00006eb0: 6374 696f 6e5f 7175 6572 7920 3d20 4d61  ction_query = Ma
-00006ec0: 7463 6851 7565 7279 2853 796e 6345 7272  tchQuery(SyncErr
-00006ed0: 6f72 456e 7472 792e 6469 7265 6374 696f  orEntry.directio
-00006ee0: 6e2c 2064 6972 6563 7469 6f6e 290a 2020  n, direction).  
-00006ef0: 2020 2020 2020 2020 2020 2020 2020 6a6f                jo
-00006f00: 696e 745f 7175 6572 7920 3d20 416e 6451  int_query = AndQ
-00006f10: 7565 7279 2870 6174 685f 7472 6565 5f71  uery(path_tree_q
-00006f20: 7565 7279 2c20 6469 7265 6374 696f 6e5f  uery, direction_
-00006f30: 7175 6572 7929 0a20 2020 2020 2020 2020  query).         
-00006f40: 2020 2020 2020 2065 7272 6f72 7320 3d20         errors = 
-00006f50: 7365 6c66 2e5f 7379 6e63 5f65 7272 6f72  self._sync_error
-00006f60: 735f 7461 626c 652e 7365 6c65 6374 286a  s_table.select(j
-00006f70: 6f69 6e74 5f71 7565 7279 290a 2020 2020  oint_query).    
-00006f80: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-00006f90: 2020 2020 2020 2020 2020 2020 2020 6572                er
-00006fa0: 726f 7273 203d 2073 656c 662e 5f73 796e  rors = self._syn
-00006fb0: 635f 6572 726f 7273 5f74 6162 6c65 2e73  c_errors_table.s
-00006fc0: 656c 6563 7428 7061 7468 5f74 7265 655f  elect(path_tree_
-00006fd0: 7175 6572 7929 0a0a 2020 2020 2020 2020  query)..        
-00006fe0: 2020 2020 7265 7475 726e 2065 7272 6f72      return error
-00006ff0: 730a 0a20 2020 2064 6566 2063 6c65 6172  s..    def clear
-00007000: 5f73 796e 635f 6572 726f 7273 5f66 6f72  _sync_errors_for
-00007010: 5f70 6174 6828 0a20 2020 2020 2020 2073  _path(.        s
-00007020: 656c 662c 2064 6278 5f70 6174 685f 6c6f  elf, dbx_path_lo
-00007030: 7765 723a 2073 7472 2c20 7265 6375 7273  wer: str, recurs
-00007040: 6976 653a 2062 6f6f 6c20 3d20 4661 6c73  ive: bool = Fals
-00007050: 650a 2020 2020 2920 2d3e 204e 6f6e 653a  e.    ) -> None:
-00007060: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
-00007070: 2020 2020 2043 6c65 6172 2061 6c6c 2073       Clear all s
-00007080: 796e 6320 6572 726f 7273 2066 6f72 2061  ync errors for a
-00007090: 2070 6174 6820 6166 7465 7220 6120 7375   path after a su
-000070a0: 6363 6573 7366 756c 2073 796e 6320 6576  ccessful sync ev
-000070b0: 656e 742e 0a0a 2020 2020 2020 2020 3a70  ent...        :p
-000070c0: 6172 616d 2064 6278 5f70 6174 685f 6c6f  aram dbx_path_lo
-000070d0: 7765 723a 204e 6f72 6d61 6c69 7365 6420  wer: Normalised 
-000070e0: 4472 6f70 626f 7820 7061 7468 2074 6f20  Dropbox path to 
-000070f0: 636c 6561 722e 0a20 2020 2020 2020 203a  clear..        :
-00007100: 7061 7261 6d20 7265 6375 7273 6976 653a  param recursive:
-00007110: 2057 6865 7468 6572 2074 6f20 636c 6561   Whether to clea
-00007120: 7220 7379 6e63 2065 7272 6f72 7320 666f  r sync errors fo
-00007130: 7220 6368 696c 6472 656e 206f 6620 7468  r children of th
-00007140: 6520 6769 7665 6e20 7061 7468 2e0a 2020  e given path..  
-00007150: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
-00007160: 2020 7769 7468 2073 656c 662e 5f64 6174    with self._dat
-00007170: 6162 6173 655f 6163 6365 7373 2829 3a0a  abase_access():.
-00007180: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-00007190: 2e5f 7379 6e63 5f65 7272 6f72 735f 7461  ._sync_errors_ta
-000071a0: 626c 652e 6465 6c65 7465 5f70 7269 6d61  ble.delete_prima
-000071b0: 7279 5f6b 6579 2864 6278 5f70 6174 685f  ry_key(dbx_path_
-000071c0: 6c6f 7765 7229 0a0a 2020 2020 2020 2020  lower)..        
-000071d0: 2020 2020 6966 2072 6563 7572 7369 7665      if recursive
-000071e0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-000071f0: 2020 7175 6572 7920 3d20 5061 7468 5472    query = PathTr
-00007200: 6565 5175 6572 7928 5379 6e63 4572 726f  eeQuery(SyncErro
-00007210: 7245 6e74 7279 2e64 6278 5f70 6174 685f  rEntry.dbx_path_
-00007220: 6c6f 7765 722c 2064 6278 5f70 6174 685f  lower, dbx_path_
-00007230: 6c6f 7765 7229 0a20 2020 2020 2020 2020  lower).         
-00007240: 2020 2020 2020 2073 656c 662e 5f73 796e         self._syn
-00007250: 635f 6572 726f 7273 5f74 6162 6c65 2e64  c_errors_table.d
-00007260: 656c 6574 6528 7175 6572 7929 0a0a 2020  elete(query)..  
-00007270: 2020 6465 6620 636c 6561 725f 7379 6e63    def clear_sync
-00007280: 5f65 7272 6f72 735f 6672 6f6d 5f65 7665  _errors_from_eve
-00007290: 6e74 2873 656c 662c 2065 7665 6e74 3a20  nt(self, event: 
-000072a0: 5379 6e63 4576 656e 7429 202d 3e20 4e6f  SyncEvent) -> No
-000072b0: 6e65 3a0a 2020 2020 2020 2020 2222 2243  ne:.        """C
-000072c0: 6c65 6172 7320 7379 6e63 2065 7272 6f72  lears sync error
-000072d0: 7320 636f 7272 6573 706f 6e64 696e 6720  s corresponding 
-000072e0: 746f 2061 2073 796e 6320 6576 656e 742e  to a sync event.
-000072f0: 2222 220a 2020 2020 2020 2020 7265 6375  """.        recu
-00007300: 7273 6976 6520 3d20 6576 656e 742e 6973  rsive = event.is
-00007310: 5f6d 6f76 6564 206f 7220 6576 656e 742e  _moved or event.
-00007320: 6973 5f64 656c 6574 6564 206f 7220 6576  is_deleted or ev
-00007330: 656e 742e 6973 5f66 696c 650a 0a20 2020  ent.is_file..   
-00007340: 2020 2020 2073 656c 662e 636c 6561 725f       self.clear_
-00007350: 7379 6e63 5f65 7272 6f72 735f 666f 725f  sync_errors_for_
-00007360: 7061 7468 2865 7665 6e74 2e64 6278 5f70  path(event.dbx_p
-00007370: 6174 685f 6c6f 7765 722c 2072 6563 7572  ath_lower, recur
-00007380: 7369 7665 290a 2020 2020 2020 2020 6966  sive).        if
-00007390: 2065 7665 6e74 2e64 6278 5f70 6174 685f   event.dbx_path_
-000073a0: 6672 6f6d 5f6c 6f77 6572 2069 7320 6e6f  from_lower is no
-000073b0: 7420 4e6f 6e65 3a0a 2020 2020 2020 2020  t None:.        
-000073c0: 2020 2020 7365 6c66 2e63 6c65 6172 5f73      self.clear_s
-000073d0: 796e 635f 6572 726f 7273 5f66 6f72 5f70  ync_errors_for_p
-000073e0: 6174 6828 6576 656e 742e 6462 785f 7061  ath(event.dbx_pa
-000073f0: 7468 5f66 726f 6d5f 6c6f 7765 722c 2072  th_from_lower, r
-00007400: 6563 7572 7369 7665 290a 0a20 2020 2023  ecursive)..    #
-00007410: 203d 3d3d 3d20 496e 6465 7820 6163 6365   ==== Index acce
-00007420: 7373 2061 6e64 206d 616e 6167 656d 656e  ss and managemen
-00007430: 7420 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  t ==============
-00007440: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00007450: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00007460: 3d3d 3d0a 0a20 2020 2064 6566 2067 6574  ===..    def get
-00007470: 5f69 6e64 6578 2873 656c 6629 202d 3e20  _index(self) -> 
-00007480: 6c69 7374 5b49 6e64 6578 456e 7472 795d  list[IndexEntry]
-00007490: 3a0a 2020 2020 2020 2020 2222 220a 2020  :.        """.  
-000074a0: 2020 2020 2020 5265 7475 726e 7320 6120        Returns a 
-000074b0: 636f 7079 206f 6620 7468 6520 6c6f 6361  copy of the loca
-000074c0: 6c20 696e 6465 7820 6f66 2073 796e 6365  l index of synce
-000074d0: 6420 6669 6c65 7320 616e 6420 666f 6c64  d files and fold
-000074e0: 6572 732e 0a0a 2020 2020 2020 2020 3a72  ers...        :r
-000074f0: 6574 7572 6e73 3a20 4c69 7374 206f 6620  eturns: List of 
-00007500: 696e 6465 7820 656e 7472 6965 732e 0a20  index entries.. 
-00007510: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
-00007520: 2020 2077 6974 6820 7365 6c66 2e5f 6461     with self._da
-00007530: 7461 6261 7365 5f61 6363 6573 7328 293a  tabase_access():
-00007540: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-00007550: 7572 6e20 7365 6c66 2e5f 696e 6465 785f  urn self._index_
-00007560: 7461 626c 652e 7365 6c65 6374 2841 6c6c  table.select(All
-00007570: 5175 6572 7928 2929 0a0a 2020 2020 6465  Query())..    de
-00007580: 6620 6765 745f 696e 6465 785f 656e 7472  f get_index_entr
-00007590: 7928 7365 6c66 2c20 6462 785f 7061 7468  y(self, dbx_path
-000075a0: 5f6c 6f77 6572 3a20 7374 7229 202d 3e20  _lower: str) -> 
-000075b0: 496e 6465 7845 6e74 7279 207c 204e 6f6e  IndexEntry | Non
-000075c0: 653a 0a20 2020 2020 2020 2022 2222 0a20  e:.        """. 
-000075d0: 2020 2020 2020 2047 6574 7320 7468 6520         Gets the 
-000075e0: 696e 6465 7820 656e 7472 7920 666f 7220  index entry for 
-000075f0: 7468 6520 6769 7665 6e20 4472 6f70 626f  the given Dropbo
-00007600: 7820 7061 7468 2e0a 0a20 2020 2020 2020  x path...       
-00007610: 203a 7061 7261 6d20 6462 785f 7061 7468   :param dbx_path
-00007620: 5f6c 6f77 6572 3a20 4e6f 726d 616c 697a  _lower: Normaliz
-00007630: 6564 206c 6f77 6572 2063 6173 6520 4472  ed lower case Dr
-00007640: 6f70 626f 7820 7061 7468 2e0a 2020 2020  opbox path..    
-00007650: 2020 2020 3a72 6574 7572 6e73 3a20 496e      :returns: In
-00007660: 6465 7820 656e 7472 7920 6f72 2060 604e  dex entry or ``N
-00007670: 6f6e 6560 6020 6966 206e 6f20 656e 7472  one`` if no entr
-00007680: 7920 6578 6973 7473 2066 6f72 2074 6865  y exists for the
-00007690: 2067 6976 656e 2070 6174 682e 0a20 2020   given path..   
-000076a0: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
-000076b0: 2077 6974 6820 7365 6c66 2e5f 6461 7461   with self._data
-000076c0: 6261 7365 5f61 6363 6573 7328 293a 0a20  base_access():. 
-000076d0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-000076e0: 6e20 7365 6c66 2e5f 696e 6465 785f 7461  n self._index_ta
-000076f0: 626c 652e 6765 7428 6462 785f 7061 7468  ble.get(dbx_path
-00007700: 5f6c 6f77 6572 290a 0a20 2020 2064 6566  _lower)..    def
-00007710: 2069 7465 725f 696e 6465 7828 7365 6c66   iter_index(self
-00007720: 2920 2d3e 2049 7465 7261 746f 725b 496e  ) -> Iterator[In
-00007730: 6465 7845 6e74 7279 5d3a 0a20 2020 2020  dexEntry]:.     
-00007740: 2020 2022 2222 0a20 2020 2020 2020 2052     """.        R
-00007750: 6574 7572 6e73 2061 6e20 6974 6572 6174  eturns an iterat
-00007760: 6f72 206f 7665 7220 7468 6520 6c6f 6361  or over the loca
-00007770: 6c20 696e 6465 7820 6f66 2073 796e 6365  l index of synce
-00007780: 6420 6669 6c65 7320 616e 6420 666f 6c64  d files and fold
-00007790: 6572 732e 0a0a 2020 2020 2020 2020 3a72  ers...        :r
-000077a0: 6574 7572 6e73 3a20 4974 6572 6174 6f72  eturns: Iterator
-000077b0: 206f 7665 7220 696e 6465 7820 656e 7472   over index entr
-000077c0: 6965 732e 0a20 2020 2020 2020 2022 2222  ies..        """
-000077d0: 0a20 2020 2020 2020 2077 6974 6820 7365  .        with se
-000077e0: 6c66 2e5f 6461 7461 6261 7365 5f61 6363  lf._database_acc
-000077f0: 6573 7328 293a 0a20 2020 2020 2020 2020  ess():.         
-00007800: 2020 2066 6f72 2065 6e74 7269 6573 2069     for entries i
-00007810: 6e20 7365 6c66 2e5f 696e 6465 785f 7461  n self._index_ta
-00007820: 626c 652e 7365 6c65 6374 5f69 7465 7228  ble.select_iter(
-00007830: 416c 6c51 7565 7279 2829 293a 0a20 2020  AllQuery()):.   
-00007840: 2020 2020 2020 2020 2020 2020 2079 6965               yie
-00007850: 6c64 2066 726f 6d20 656e 7472 6965 730a  ld from entries.
-00007860: 0a20 2020 2064 6566 2069 6e64 6578 5f63  .    def index_c
-00007870: 6f75 6e74 2873 656c 6629 202d 3e20 696e  ount(self) -> in
-00007880: 743a 0a20 2020 2020 2020 2022 2222 0a20  t:.        """. 
-00007890: 2020 2020 2020 2052 6574 7572 6e73 2074         Returns t
-000078a0: 6865 206e 756d 6265 7220 6f66 2069 7465  he number of ite
-000078b0: 6d73 2069 6e20 6f75 7220 696e 6465 7820  ms in our index 
-000078c0: 7769 7468 6f75 7420 6c6f 6164 696e 6720  without loading 
-000078d0: 616e 7920 6974 656d 732e 0a0a 2020 2020  any items...    
-000078e0: 2020 2020 3a72 6574 7572 6e73 3a20 4e75      :returns: Nu
-000078f0: 6d62 6572 206f 6620 696e 6465 7820 656e  mber of index en
-00007900: 7472 6965 732e 0a20 2020 2020 2020 2022  tries..        "
-00007910: 2222 0a20 2020 2020 2020 2077 6974 6820  "".        with 
-00007920: 7365 6c66 2e5f 6461 7461 6261 7365 5f61  self._database_a
-00007930: 6363 6573 7328 293a 0a20 2020 2020 2020  ccess():.       
-00007940: 2020 2020 2072 6574 7572 6e20 7365 6c66       return self
-00007950: 2e5f 696e 6465 785f 7461 626c 652e 636f  ._index_table.co
-00007960: 756e 7428 290a 0a20 2020 2064 6566 2067  unt()..    def g
-00007970: 6574 5f6c 6f63 616c 5f72 6576 2873 656c  et_local_rev(sel
-00007980: 662c 2064 6278 5f70 6174 685f 6c6f 7765  f, dbx_path_lowe
-00007990: 723a 2073 7472 2920 2d3e 2073 7472 207c  r: str) -> str |
-000079a0: 204e 6f6e 653a 0a20 2020 2020 2020 2022   None:.        "
-000079b0: 2222 0a20 2020 2020 2020 2047 6574 7320  "".        Gets 
-000079c0: 7265 7669 7369 6f6e 206e 756d 6265 7220  revision number 
-000079d0: 6f66 206c 6f63 616c 2066 696c 652e 0a0a  of local file...
-000079e0: 2020 2020 2020 2020 3a70 6172 616d 2064          :param d
-000079f0: 6278 5f70 6174 685f 6c6f 7765 723a 204e  bx_path_lower: N
-00007a00: 6f72 6d61 6c69 7a65 6420 6c6f 7765 7220  ormalized lower 
-00007a10: 6361 7365 2044 726f 7062 6f78 2070 6174  case Dropbox pat
-00007a20: 682e 0a20 2020 2020 2020 203a 7265 7475  h..        :retu
-00007a30: 726e 733a 2052 6576 6973 696f 6e20 6e75  rns: Revision nu
-00007a40: 6d62 6572 2061 7320 7374 7220 6f72 2060  mber as str or `
-00007a50: 604e 6f6e 6560 6020 6966 206e 6f20 6c6f  `None`` if no lo
-00007a60: 6361 6c20 7265 7669 7369 6f6e 206e 756d  cal revision num
-00007a70: 6265 7220 6861 730a 2020 2020 2020 2020  ber has.        
-00007a80: 2020 2020 6265 656e 2073 6176 6564 2e0a      been saved..
-00007a90: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
-00007aa0: 2020 2020 656e 7472 7920 3d20 7365 6c66      entry = self
-00007ab0: 2e67 6574 5f69 6e64 6578 5f65 6e74 7279  .get_index_entry
-00007ac0: 2864 6278 5f70 6174 685f 6c6f 7765 7229  (dbx_path_lower)
-00007ad0: 0a0a 2020 2020 2020 2020 6966 2065 6e74  ..        if ent
-00007ae0: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
-00007af0: 7265 7475 726e 2065 6e74 7279 2e72 6576  return entry.rev
-00007b00: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
-00007b10: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-00007b20: 6e20 4e6f 6e65 0a0a 2020 2020 6465 6620  n None..    def 
-00007b30: 6765 745f 6c61 7374 5f73 796e 6328 7365  get_last_sync(se
-00007b40: 6c66 2c20 6462 785f 7061 7468 5f6c 6f77  lf, dbx_path_low
-00007b50: 6572 3a20 7374 7229 202d 3e20 666c 6f61  er: str) -> floa
-00007b60: 743a 0a20 2020 2020 2020 2022 2222 0a20  t:.        """. 
-00007b70: 2020 2020 2020 2052 6574 7572 6e73 2074         Returns t
-00007b80: 6865 2074 696d 6573 7461 6d70 206f 6620  he timestamp of 
-00007b90: 6c61 7374 2073 796e 6320 666f 7220 616e  last sync for an
-00007ba0: 2069 6e64 6976 6964 7561 6c20 7061 7468   individual path
-00007bb0: 2e0a 0a20 2020 2020 2020 203a 7061 7261  ...        :para
-00007bc0: 6d20 6462 785f 7061 7468 5f6c 6f77 6572  m dbx_path_lower
-00007bd0: 3a20 4e6f 726d 616c 697a 6564 206c 6f77  : Normalized low
-00007be0: 6572 2063 6173 6520 4472 6f70 626f 7820  er case Dropbox 
-00007bf0: 7061 7468 2e0a 2020 2020 2020 2020 3a72  path..        :r
-00007c00: 6574 7572 6e73 3a20 5469 6d65 206f 6620  eturns: Time of 
-00007c10: 6c61 7374 2073 796e 632e 0a20 2020 2020  last sync..     
-00007c20: 2020 2022 2222 0a20 2020 2020 2020 2065     """.        e
-00007c30: 6e74 7279 203d 2073 656c 662e 6765 745f  ntry = self.get_
-00007c40: 696e 6465 785f 656e 7472 7928 6462 785f  index_entry(dbx_
-00007c50: 7061 7468 5f6c 6f77 6572 290a 0a20 2020  path_lower)..   
-00007c60: 2020 2020 2069 6620 656e 7472 793a 0a20       if entry:. 
-00007c70: 2020 2020 2020 2020 2020 206c 6173 745f             last_
-00007c80: 7379 6e63 203d 2065 6e74 7279 2e6c 6173  sync = entry.las
-00007c90: 745f 7379 6e63 206f 7220 302e 300a 2020  t_sync or 0.0.  
-00007ca0: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-00007cb0: 2020 2020 2020 2020 6c61 7374 5f73 796e          last_syn
-00007cc0: 6320 3d20 302e 300a 0a20 2020 2020 2020  c = 0.0..       
-00007cd0: 2072 6574 7572 6e20 6d61 7828 6c61 7374   return max(last
-00007ce0: 5f73 796e 632c 2073 656c 662e 6c6f 6361  _sync, self.loca
-00007cf0: 6c5f 6375 7273 6f72 290a 0a20 2020 2064  l_cursor)..    d
-00007d00: 6566 2075 7064 6174 655f 696e 6465 785f  ef update_index_
-00007d10: 6672 6f6d 5f73 796e 635f 6576 656e 7428  from_sync_event(
-00007d20: 7365 6c66 2c20 6576 656e 743a 2053 796e  self, event: Syn
-00007d30: 6345 7665 6e74 2920 2d3e 204e 6f6e 653a  cEvent) -> None:
-00007d40: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
-00007d50: 2020 2020 2055 7064 6174 6573 2074 6865       Updates the
-00007d60: 206c 6f63 616c 2069 6e64 6578 2066 726f   local index fro
-00007d70: 6d20 6120 5379 6e63 4576 656e 742e 0a0a  m a SyncEvent...
-00007d80: 2020 2020 2020 2020 3a70 6172 616d 2065          :param e
-00007d90: 7665 6e74 3a20 5379 6e63 4576 656e 7420  vent: SyncEvent 
-00007da0: 6672 6f6d 2064 6f77 6e6c 6f61 642e 0a20  from download.. 
-00007db0: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
-00007dc0: 2020 2069 6620 6576 656e 742e 6368 616e     if event.chan
-00007dd0: 6765 5f74 7970 6520 6973 206e 6f74 2043  ge_type is not C
-00007de0: 6861 6e67 6554 7970 652e 5265 6d6f 7665  hangeType.Remove
-00007df0: 6420 616e 6420 6e6f 7420 6576 656e 742e  d and not event.
-00007e00: 7265 763a 0a20 2020 2020 2020 2020 2020  rev:.           
-00007e10: 2072 6169 7365 2056 616c 7565 4572 726f   raise ValueErro
-00007e20: 7228 2252 6576 2072 6571 7569 7265 6420  r("Rev required 
-00007e30: 746f 2075 7064 6174 6520 696e 6465 7822  to update index"
-00007e40: 290a 0a20 2020 2020 2020 2064 6278 5f70  )..        dbx_p
-00007e50: 6174 685f 6c6f 7765 7220 3d20 6576 656e  ath_lower = even
-00007e60: 742e 6462 785f 7061 7468 5f6c 6f77 6572  t.dbx_path_lower
-00007e70: 0a0a 2020 2020 2020 2020 7769 7468 2073  ..        with s
-00007e80: 656c 662e 5f64 6174 6162 6173 655f 6163  elf._database_ac
-00007e90: 6365 7373 2829 3a0a 2020 2020 2020 2020  cess():.        
-00007ea0: 2020 2020 2320 5265 6d6f 7665 2061 6e79      # Remove any
-00007eb0: 2065 6e74 7269 6573 2066 6f72 2064 656c   entries for del
-00007ec0: 6574 6564 206f 7220 6d6f 7665 6420 6974  eted or moved it
-00007ed0: 656d 732e 0a0a 2020 2020 2020 2020 2020  ems...          
-00007ee0: 2020 6966 2065 7665 6e74 2e63 6861 6e67    if event.chang
-00007ef0: 655f 7479 7065 2069 7320 4368 616e 6765  e_type is Change
-00007f00: 5479 7065 2e52 656d 6f76 6564 3a0a 2020  Type.Removed:.  
-00007f10: 2020 2020 2020 2020 2020 2020 2020 7365                se
-00007f20: 6c66 2e72 656d 6f76 655f 6e6f 6465 5f66  lf.remove_node_f
-00007f30: 726f 6d5f 696e 6465 7828 6462 785f 7061  rom_index(dbx_pa
-00007f40: 7468 5f6c 6f77 6572 290a 2020 2020 2020  th_lower).      
-00007f50: 2020 2020 2020 656c 6966 2065 7665 6e74        elif event
-00007f60: 2e63 6861 6e67 655f 7479 7065 2069 7320  .change_type is 
-00007f70: 4368 616e 6765 5479 7065 2e4d 6f76 6564  ChangeType.Moved
-00007f80: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00007f90: 2020 6173 7365 7274 2065 7665 6e74 2e64    assert event.d
-00007fa0: 6278 5f70 6174 685f 6672 6f6d 5f6c 6f77  bx_path_from_low
-00007fb0: 6572 2069 7320 6e6f 7420 4e6f 6e65 0a20  er is not None. 
-00007fc0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-00007fd0: 656c 662e 7265 6d6f 7665 5f6e 6f64 655f  elf.remove_node_
-00007fe0: 6672 6f6d 5f69 6e64 6578 2865 7665 6e74  from_index(event
-00007ff0: 2e64 6278 5f70 6174 685f 6672 6f6d 5f6c  .dbx_path_from_l
-00008000: 6f77 6572 290a 0a20 2020 2020 2020 2020  ower)..         
-00008010: 2020 2023 2041 6464 206f 7220 7570 6461     # Add or upda
-00008020: 7465 2065 6e74 7269 6573 2066 6f72 2063  te entries for c
-00008030: 7265 6174 6564 206f 7220 6d6f 6469 6669  reated or modifi
-00008040: 6564 2069 7465 6d73 2e0a 0a20 2020 2020  ed items...     
-00008050: 2020 2020 2020 2069 6620 6576 656e 742e         if event.
-00008060: 6368 616e 6765 5f74 7970 6520 6973 206e  change_type is n
-00008070: 6f74 2043 6861 6e67 6554 7970 652e 5265  ot ChangeType.Re
-00008080: 6d6f 7665 643a 0a20 2020 2020 2020 2020  moved:.         
-00008090: 2020 2020 2020 2023 2043 7265 6174 6520         # Create 
-000080a0: 6f72 2075 7064 6174 6520 656e 7472 792e  or update entry.
-000080b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000080c0: 2065 6e74 7279 203d 2049 6e64 6578 456e   entry = IndexEn
-000080d0: 7472 7928 0a20 2020 2020 2020 2020 2020  try(.           
-000080e0: 2020 2020 2020 2020 2064 6278 5f70 6174           dbx_pat
-000080f0: 685f 6361 7365 643d 6576 656e 742e 6462  h_cased=event.db
-00008100: 785f 7061 7468 2c0a 2020 2020 2020 2020  x_path,.        
-00008110: 2020 2020 2020 2020 2020 2020 6462 785f              dbx_
-00008120: 7061 7468 5f6c 6f77 6572 3d64 6278 5f70  path_lower=dbx_p
-00008130: 6174 685f 6c6f 7765 722c 0a20 2020 2020  ath_lower,.     
-00008140: 2020 2020 2020 2020 2020 2020 2020 2064                 d
-00008150: 6278 5f69 643d 6576 656e 742e 6462 785f  bx_id=event.dbx_
-00008160: 6964 2c0a 2020 2020 2020 2020 2020 2020  id,.            
-00008170: 2020 2020 2020 2020 6974 656d 5f74 7970          item_typ
-00008180: 653d 6576 656e 742e 6974 656d 5f74 7970  e=event.item_typ
-00008190: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
-000081a0: 2020 2020 2020 206c 6173 745f 7379 6e63         last_sync
-000081b0: 3d73 656c 662e 5f67 6574 5f63 7469 6d65  =self._get_ctime
-000081c0: 2865 7665 6e74 2e6c 6f63 616c 5f70 6174  (event.local_pat
-000081d0: 6829 2c0a 2020 2020 2020 2020 2020 2020  h),.            
-000081e0: 2020 2020 2020 2020 7265 763d 6576 656e          rev=even
-000081f0: 742e 7265 762c 0a20 2020 2020 2020 2020  t.rev,.         
-00008200: 2020 2020 2020 2020 2020 2063 6f6e 7465             conte
-00008210: 6e74 5f68 6173 683d 6576 656e 742e 636f  nt_hash=event.co
-00008220: 6e74 656e 745f 6861 7368 2c0a 2020 2020  ntent_hash,.    
-00008230: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008240: 7379 6d6c 696e 6b5f 7461 7267 6574 3d65  symlink_target=e
-00008250: 7665 6e74 2e73 796d 6c69 6e6b 5f74 6172  vent.symlink_tar
-00008260: 6765 742c 0a20 2020 2020 2020 2020 2020  get,.           
-00008270: 2020 2020 2029 0a0a 2020 2020 2020 2020       )..        
-00008280: 2020 2020 2020 2020 7365 6c66 2e5f 696e          self._in
-00008290: 6465 785f 7461 626c 652e 7570 6461 7465  dex_table.update
-000082a0: 2865 6e74 7279 290a 0a20 2020 2064 6566  (entry)..    def
-000082b0: 2075 7064 6174 655f 696e 6465 785f 6672   update_index_fr
-000082c0: 6f6d 5f64 6278 5f6d 6574 6164 6174 6128  om_dbx_metadata(
-000082d0: 7365 6c66 2c20 6d64 3a20 4d65 7461 6461  self, md: Metada
-000082e0: 7461 2920 2d3e 204e 6f6e 653a 0a20 2020  ta) -> None:.   
-000082f0: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
-00008300: 2055 7064 6174 6573 2074 6865 206c 6f63   Updates the loc
-00008310: 616c 2069 6e64 6578 2066 726f 6d20 4472  al index from Dr
-00008320: 6f70 626f 7820 6d65 7461 6461 7461 2e0a  opbox metadata..
-00008330: 0a20 2020 2020 2020 203a 7061 7261 6d20  .        :param 
-00008340: 6d64 3a20 4472 6f70 626f 7820 6d65 7461  md: Dropbox meta
-00008350: 6461 7461 2e0a 2020 2020 2020 2020 2222  data..        ""
-00008360: 220a 2020 2020 2020 2020 7769 7468 2073  ".        with s
-00008370: 656c 662e 5f64 6174 6162 6173 655f 6163  elf._database_ac
-00008380: 6365 7373 2829 3a0a 2020 2020 2020 2020  cess():.        
-00008390: 2020 2020 6966 2069 7369 6e73 7461 6e63      if isinstanc
-000083a0: 6528 6d64 2c20 4465 6c65 7465 644d 6574  e(md, DeletedMet
-000083b0: 6164 6174 6129 3a0a 2020 2020 2020 2020  adata):.        
-000083c0: 2020 2020 2020 2020 7265 7475 726e 2073          return s
-000083d0: 656c 662e 7265 6d6f 7665 5f6e 6f64 655f  elf.remove_node_
-000083e0: 6672 6f6d 5f69 6e64 6578 286d 642e 7061  from_index(md.pa
-000083f0: 7468 5f6c 6f77 6572 290a 0a20 2020 2020  th_lower)..     
-00008400: 2020 2020 2020 2069 6620 6973 696e 7374         if isinst
-00008410: 616e 6365 286d 642c 2046 696c 654d 6574  ance(md, FileMet
-00008420: 6164 6174 6129 3a0a 2020 2020 2020 2020  adata):.        
-00008430: 2020 2020 2020 2020 7265 7620 3d20 6d64          rev = md
-00008440: 2e72 6576 0a20 2020 2020 2020 2020 2020  .rev.           
-00008450: 2020 2020 2068 6173 685f 7374 7220 3d20       hash_str = 
-00008460: 6d64 2e63 6f6e 7465 6e74 5f68 6173 680a  md.content_hash.
-00008470: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008480: 6974 656d 5f74 7970 6520 3d20 4974 656d  item_type = Item
-00008490: 5479 7065 2e46 696c 650a 2020 2020 2020  Type.File.      
-000084a0: 2020 2020 2020 2020 2020 7379 6d6c 696e            symlin
-000084b0: 6b5f 7461 7267 6574 203d 206d 642e 7379  k_target = md.sy
-000084c0: 6d6c 696e 6b5f 7461 7267 6574 0a20 2020  mlink_target.   
-000084d0: 2020 2020 2020 2020 2020 2020 206d 645f               md_
-000084e0: 6964 203d 206d 642e 6964 0a20 2020 2020  id = md.id.     
-000084f0: 2020 2020 2020 2065 6c69 6620 6973 696e         elif isin
-00008500: 7374 616e 6365 286d 642c 2046 6f6c 6465  stance(md, Folde
-00008510: 724d 6574 6164 6174 6129 3a0a 2020 2020  rMetadata):.    
-00008520: 2020 2020 2020 2020 2020 2020 7265 7620              rev 
-00008530: 3d20 2266 6f6c 6465 7222 0a20 2020 2020  = "folder".     
-00008540: 2020 2020 2020 2020 2020 2068 6173 685f             hash_
-00008550: 7374 7220 3d20 2266 6f6c 6465 7222 0a20  str = "folder". 
-00008560: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00008570: 7465 6d5f 7479 7065 203d 2049 7465 6d54  tem_type = ItemT
-00008580: 7970 652e 466f 6c64 6572 0a20 2020 2020  ype.Folder.     
-00008590: 2020 2020 2020 2020 2020 2073 796d 6c69             symli
-000085a0: 6e6b 5f74 6172 6765 7420 3d20 4e6f 6e65  nk_target = None
-000085b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000085c0: 206d 645f 6964 203d 206d 642e 6964 0a20   md_id = md.id. 
-000085d0: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
-000085e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000085f0: 2072 6169 7365 2052 756e 7469 6d65 4572   raise RuntimeEr
-00008600: 726f 7228 6622 556e 6b6e 6f77 6e20 6d65  ror(f"Unknown me
-00008610: 7461 6461 7461 2074 7970 653a 207b 6d64  tadata type: {md
-00008620: 7d22 290a 0a20 2020 2020 2020 2020 2020  }")..           
-00008630: 2023 2043 6f6e 7374 7275 6374 2063 6f72   # Construct cor
-00008640: 7265 6374 2064 6973 706c 6179 2070 6174  rect display pat
-00008650: 6820 6672 6f6d 2061 6e63 6573 746f 7273  h from ancestors
-00008660: 2e0a 2020 2020 2020 2020 2020 2020 6462  ..            db
-00008670: 785f 7061 7468 5f63 6173 6564 203d 2073  x_path_cased = s
-00008680: 656c 662e 636f 7272 6563 745f 6361 7365  elf.correct_case
-00008690: 286d 642e 7061 7468 5f64 6973 706c 6179  (md.path_display
-000086a0: 290a 0a20 2020 2020 2020 2020 2020 2023  )..            #
-000086b0: 2055 7064 6174 6520 6578 6973 7469 6e67   Update existing
-000086c0: 2065 6e74 7279 206f 7220 6372 6561 7465   entry or create
-000086d0: 206e 6577 2065 6e74 7279 2e0a 2020 2020   new entry..    
-000086e0: 2020 2020 2020 2020 656e 7472 7920 3d20          entry = 
-000086f0: 496e 6465 7845 6e74 7279 280a 2020 2020  IndexEntry(.    
-00008700: 2020 2020 2020 2020 2020 2020 6462 785f              dbx_
-00008710: 7061 7468 5f63 6173 6564 3d64 6278 5f70  path_cased=dbx_p
-00008720: 6174 685f 6361 7365 642c 0a20 2020 2020  ath_cased,.     
-00008730: 2020 2020 2020 2020 2020 2064 6278 5f70             dbx_p
-00008740: 6174 685f 6c6f 7765 723d 6d64 2e70 6174  ath_lower=md.pat
-00008750: 685f 6c6f 7765 722c 0a20 2020 2020 2020  h_lower,.       
-00008760: 2020 2020 2020 2020 2064 6278 5f69 643d           dbx_id=
-00008770: 6d64 5f69 642c 0a20 2020 2020 2020 2020  md_id,.         
-00008780: 2020 2020 2020 2069 7465 6d5f 7479 7065         item_type
-00008790: 3d69 7465 6d5f 7479 7065 2c0a 2020 2020  =item_type,.    
-000087a0: 2020 2020 2020 2020 2020 2020 6c61 7374              last
-000087b0: 5f73 796e 633d 4e6f 6e65 2c0a 2020 2020  _sync=None,.    
-000087c0: 2020 2020 2020 2020 2020 2020 7265 763d              rev=
-000087d0: 7265 762c 0a20 2020 2020 2020 2020 2020  rev,.           
-000087e0: 2020 2020 2063 6f6e 7465 6e74 5f68 6173       content_has
-000087f0: 683d 6861 7368 5f73 7472 2c0a 2020 2020  h=hash_str,.    
-00008800: 2020 2020 2020 2020 2020 2020 7379 6d6c              syml
-00008810: 696e 6b5f 7461 7267 6574 3d73 796d 6c69  ink_target=symli
-00008820: 6e6b 5f74 6172 6765 742c 0a20 2020 2020  nk_target,.     
-00008830: 2020 2020 2020 2029 0a0a 2020 2020 2020         )..      
-00008840: 2020 2020 2020 7365 6c66 2e5f 696e 6465        self._inde
-00008850: 785f 7461 626c 652e 7570 6461 7465 2865  x_table.update(e
-00008860: 6e74 7279 290a 0a20 2020 2064 6566 2072  ntry)..    def r
-00008870: 656d 6f76 655f 6e6f 6465 5f66 726f 6d5f  emove_node_from_
-00008880: 696e 6465 7828 7365 6c66 2c20 6462 785f  index(self, dbx_
-00008890: 7061 7468 5f6c 6f77 6572 3a20 7374 7229  path_lower: str)
-000088a0: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2020   -> None:.      
-000088b0: 2020 2222 220a 2020 2020 2020 2020 5265    """.        Re
-000088c0: 6d6f 7665 7320 616e 7920 6c6f 6361 6c20  moves any local 
-000088d0: 696e 6465 7820 656e 7472 6965 7320 666f  index entries fo
-000088e0: 7220 7468 6520 6769 7665 6e20 7061 7468  r the given path
-000088f0: 2061 6e64 2061 6c6c 2069 7473 2063 6869   and all its chi
-00008900: 6c64 7265 6e2e 0a0a 2020 2020 2020 2020  ldren...        
-00008910: 3a70 6172 616d 2064 6278 5f70 6174 685f  :param dbx_path_
-00008920: 6c6f 7765 723a 204e 6f72 6d61 6c69 7a65  lower: Normalize
-00008930: 6420 6c6f 7765 7220 6361 7365 2044 726f  d lower case Dro
-00008940: 7062 6f78 2070 6174 682e 0a20 2020 2020  pbox path..     
-00008950: 2020 2022 2222 0a20 2020 2020 2020 2077     """.        w
-00008960: 6974 6820 7365 6c66 2e5f 6461 7461 6261  ith self._databa
-00008970: 7365 5f61 6363 6573 7328 293a 0a20 2020  se_access():.   
-00008980: 2020 2020 2020 2020 2071 7565 7279 203d           query =
-00008990: 2050 6174 6854 7265 6551 7565 7279 2849   PathTreeQuery(I
-000089a0: 6e64 6578 456e 7472 792e 6462 785f 7061  ndexEntry.dbx_pa
-000089b0: 7468 5f6c 6f77 6572 2c20 6462 785f 7061  th_lower, dbx_pa
-000089c0: 7468 5f6c 6f77 6572 290a 2020 2020 2020  th_lower).      
-000089d0: 2020 2020 2020 7365 6c66 2e5f 696e 6465        self._inde
-000089e0: 785f 7461 626c 652e 6465 6c65 7465 2871  x_table.delete(q
-000089f0: 7565 7279 290a 0a20 2020 2023 203d 3d3d  uery)..    # ===
-00008a00: 3d20 436f 6e74 656e 7420 6861 7368 696e  = Content hashin
-00008a10: 6720 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  g ==============
-00008a20: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00008a30: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00008a40: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d0a  ===============.
-00008a50: 0a20 2020 2064 6566 2067 6574 5f6c 6f63  .    def get_loc
-00008a60: 616c 5f68 6173 6828 7365 6c66 2c20 6c6f  al_hash(self, lo
-00008a70: 6361 6c5f 7061 7468 3a20 7374 7229 202d  cal_path: str) -
-00008a80: 3e20 7374 7220 7c20 4e6f 6e65 3a0a 2020  > str | None:.  
-00008a90: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
-00008aa0: 2020 436f 6d70 7574 6573 2063 6f6e 7465    Computes conte
-00008ab0: 6e74 2068 6173 6820 6f66 2061 206c 6f63  nt hash of a loc
-00008ac0: 616c 2066 696c 652e 0a0a 2020 2020 2020  al file...      
-00008ad0: 2020 3a70 6172 616d 206c 6f63 616c 5f70    :param local_p
-00008ae0: 6174 683a 2041 6273 6f6c 7574 6520 7061  ath: Absolute pa
-00008af0: 7468 206f 6e20 6c6f 6361 6c20 6472 6976  th on local driv
-00008b00: 652e 0a20 2020 2020 2020 203a 7265 7475  e..        :retu
-00008b10: 726e 733a 2043 6f6e 7465 6e74 2068 6173  rns: Content has
-00008b20: 6820 746f 2063 6f6d 7061 7265 2077 6974  h to compare wit
-00008b30: 6820 4472 6f70 626f 7827 7320 636f 6e74  h Dropbox's cont
-00008b40: 656e 7420 6861 7368 2c20 6f72 2027 666f  ent hash, or 'fo
-00008b50: 6c64 6572 2720 6966 0a20 2020 2020 2020  lder' if.       
-00008b60: 2020 2020 2074 6865 2070 6174 6820 706f       the path po
-00008b70: 696e 7473 2074 6f20 6120 6469 7265 6374  ints to a direct
-00008b80: 6f72 792e 2060 604e 6f6e 6560 6020 6966  ory. ``None`` if
-00008b90: 2074 6865 7265 2069 7320 6e6f 7468 696e   there is nothin
-00008ba0: 6720 6174 2074 6865 2070 6174 682e 0a20  g at the path.. 
-00008bb0: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
-00008bc0: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
-00008bd0: 2020 2020 7374 6174 203d 206f 732e 6c73      stat = os.ls
-00008be0: 7461 7428 6c6f 6361 6c5f 7061 7468 290a  tat(local_path).
-00008bf0: 2020 2020 2020 2020 6578 6365 7074 2028          except (
-00008c00: 4669 6c65 4e6f 7446 6f75 6e64 4572 726f  FileNotFoundErro
-00008c10: 722c 204e 6f74 4144 6972 6563 746f 7279  r, NotADirectory
-00008c20: 4572 726f 7229 3a0a 2020 2020 2020 2020  Error):.        
-00008c30: 2020 2020 2320 5265 6d6f 7665 2061 6c6c      # Remove all
-00008c40: 2063 6163 6865 2065 6e74 7269 6573 2066   cache entries f
-00008c50: 6f72 206c 6f63 616c 5f70 6174 6820 616e  or local_path an
-00008c60: 6420 7265 7475 726e 204e 6f6e 652e 0a20  d return None.. 
-00008c70: 2020 2020 2020 2020 2020 2077 6974 6820             with 
-00008c80: 7365 6c66 2e5f 6461 7461 6261 7365 5f61  self._database_a
-00008c90: 6363 6573 7328 293a 0a20 2020 2020 2020  ccess():.       
-00008ca0: 2020 2020 2020 2020 2071 7565 7279 203d           query =
-00008cb0: 204d 6174 6368 5175 6572 7928 4861 7368   MatchQuery(Hash
-00008cc0: 4361 6368 6545 6e74 7279 2e6c 6f63 616c  CacheEntry.local
-00008cd0: 5f70 6174 682c 206c 6f63 616c 5f70 6174  _path, local_pat
-00008ce0: 6829 0a20 2020 2020 2020 2020 2020 2020  h).             
-00008cf0: 2020 2073 656c 662e 5f68 6173 685f 7461     self._hash_ta
-00008d00: 626c 652e 6465 6c65 7465 2871 7565 7279  ble.delete(query
-00008d10: 290a 2020 2020 2020 2020 2020 2020 7265  ).            re
-00008d20: 7475 726e 204e 6f6e 650a 2020 2020 2020  turn None.      
-00008d30: 2020 6578 6365 7074 204f 5345 7272 6f72    except OSError
-00008d40: 2061 7320 6572 723a 0a20 2020 2020 2020   as err:.       
-00008d50: 2020 2020 2069 6620 6572 722e 6572 726e       if err.errn
-00008d60: 6f20 3d3d 2065 7272 6e6f 2e45 4e41 4d45  o == errno.ENAME
-00008d70: 544f 4f4c 4f4e 473a 0a20 2020 2020 2020  TOOLONG:.       
-00008d80: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-00008d90: 4e6f 6e65 0a20 2020 2020 2020 2020 2020  None.           
-00008da0: 2072 6169 7365 206f 735f 746f 5f6d 6165   raise os_to_mae
-00008db0: 7374 7261 6c5f 6572 726f 7228 6572 7229  stral_error(err)
-00008dc0: 0a0a 2020 2020 2020 2020 6966 2053 5f49  ..        if S_I
-00008dd0: 5344 4952 2873 7461 742e 7374 5f6d 6f64  SDIR(stat.st_mod
-00008de0: 6529 3a0a 2020 2020 2020 2020 2020 2020  e):.            
-00008df0: 7265 7475 726e 2022 666f 6c64 6572 220a  return "folder".
-00008e00: 0a20 2020 2020 2020 206d 7469 6d65 3a20  .        mtime: 
-00008e10: 666c 6f61 7420 7c20 4e6f 6e65 203d 2073  float | None = s
-00008e20: 7461 742e 7374 5f6d 7469 6d65 0a0a 2020  tat.st_mtime..  
-00008e30: 2020 2020 2020 7769 7468 2073 656c 662e        with self.
-00008e40: 5f64 6174 6162 6173 655f 6163 6365 7373  _database_access
-00008e50: 2829 3a0a 2020 2020 2020 2020 2020 2020  ():.            
-00008e60: 2320 4368 6563 6b20 6361 6368 6520 666f  # Check cache fo
-00008e70: 7220 616e 2075 702d 746f 2d64 6174 6520  r an up-to-date 
-00008e80: 636f 6e74 656e 7420 6861 7368 2061 6e64  content hash and
-00008e90: 2072 6574 7572 6e20 6966 2069 7420 6578   return if it ex
-00008ea0: 6973 7473 2e0a 2020 2020 2020 2020 2020  ists..          
-00008eb0: 2020 6361 6368 655f 656e 7472 7920 3d20    cache_entry = 
-00008ec0: 7365 6c66 2e5f 6861 7368 5f74 6162 6c65  self._hash_table
-00008ed0: 2e67 6574 2873 7461 742e 7374 5f69 6e6f  .get(stat.st_ino
-00008ee0: 290a 0a20 2020 2020 2020 2020 2020 2069  )..            i
-00008ef0: 6620 6361 6368 655f 656e 7472 7920 616e  f cache_entry an
-00008f00: 6420 6361 6368 655f 656e 7472 792e 6d74  d cache_entry.mt
-00008f10: 696d 6520 3d3d 206d 7469 6d65 3a0a 2020  ime == mtime:.  
-00008f20: 2020 2020 2020 2020 2020 2020 2020 7265                re
-00008f30: 7475 726e 2063 6163 6865 5f65 6e74 7279  turn cache_entry
-00008f40: 2e68 6173 685f 7374 720a 0a20 2020 2020  .hash_str..     
-00008f50: 2020 2077 6974 6820 636f 6e76 6572 745f     with convert_
-00008f60: 6170 695f 6572 726f 7273 286c 6f63 616c  api_errors(local
-00008f70: 5f70 6174 683d 6c6f 6361 6c5f 7061 7468  _path=local_path
-00008f80: 293a 0a20 2020 2020 2020 2020 2020 2068  ):.            h
-00008f90: 6173 685f 7374 722c 206d 7469 6d65 203d  ash_str, mtime =
-00008fa0: 2063 6f6e 7465 6e74 5f68 6173 6828 6c6f   content_hash(lo
-00008fb0: 6361 6c5f 7061 7468 290a 0a20 2020 2020  cal_path)..     
-00008fc0: 2020 2073 656c 662e 5f73 6176 655f 6c6f     self._save_lo
-00008fd0: 6361 6c5f 6861 7368 2873 7461 742e 7374  cal_hash(stat.st
-00008fe0: 5f69 6e6f 2c20 6c6f 6361 6c5f 7061 7468  _ino, local_path
-00008ff0: 2c20 6861 7368 5f73 7472 2c20 6d74 696d  , hash_str, mtim
-00009000: 6529 0a0a 2020 2020 2020 2020 7265 7475  e)..        retu
-00009010: 726e 2068 6173 685f 7374 720a 0a20 2020  rn hash_str..   
-00009020: 2064 6566 205f 7361 7665 5f6c 6f63 616c   def _save_local
-00009030: 5f68 6173 6828 0a20 2020 2020 2020 2073  _hash(.        s
-00009040: 656c 662c 0a20 2020 2020 2020 2069 6e6f  elf,.        ino
-00009050: 6465 3a20 696e 742c 0a20 2020 2020 2020  de: int,.       
-00009060: 206c 6f63 616c 5f70 6174 683a 2073 7472   local_path: str
-00009070: 2c0a 2020 2020 2020 2020 6861 7368 5f73  ,.        hash_s
-00009080: 7472 3a20 7374 7220 7c20 4e6f 6e65 2c0a  tr: str | None,.
-00009090: 2020 2020 2020 2020 6d74 696d 653a 2066          mtime: f
-000090a0: 6c6f 6174 207c 204e 6f6e 652c 0a20 2020  loat | None,.   
-000090b0: 2029 202d 3e20 4e6f 6e65 3a0a 2020 2020   ) -> None:.    
-000090c0: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
-000090d0: 5361 7665 2074 6865 2063 6f6e 7465 6e74  Save the content
-000090e0: 2068 6173 6820 666f 7220 6120 6669 6c65   hash for a file
-000090f0: 2069 6e20 6f75 7220 6361 6368 652e 0a0a   in our cache...
-00009100: 2020 2020 2020 2020 3a70 6172 616d 2069          :param i
-00009110: 6e6f 6465 3a20 496e 6f64 6520 6f66 2074  node: Inode of t
-00009120: 6865 2066 696c 652e 0a20 2020 2020 2020  he file..       
-00009130: 203a 7061 7261 6d20 6c6f 6361 6c5f 7061   :param local_pa
-00009140: 7468 3a20 4162 736f 6c75 7465 2070 6174  th: Absolute pat
-00009150: 6820 6f6e 206c 6f63 616c 2064 7269 7665  h on local drive
-00009160: 2e0a 2020 2020 2020 2020 3a70 6172 616d  ..        :param
-00009170: 2068 6173 685f 7374 723a 2048 6173 6820   hash_str: Hash 
-00009180: 7374 7269 6e67 2074 6f20 7361 7665 2e20  string to save. 
-00009190: 4966 204e 6f6e 652c 2074 6865 2065 7869  If None, the exi
-000091a0: 7374 696e 6720 6361 6368 6520 656e 7472  sting cache entr
-000091b0: 7920 7769 6c6c 2062 650a 2020 2020 2020  y will be.      
-000091c0: 2020 2020 2020 6465 6c65 7465 642e 0a20        deleted.. 
-000091d0: 2020 2020 2020 203a 7061 7261 6d20 6d74         :param mt
-000091e0: 696d 653a 204d 7469 6d65 206f 6620 7468  ime: Mtime of th
-000091f0: 6520 6669 6c65 2077 6865 6e20 7468 6520  e file when the 
-00009200: 6861 7368 2077 6173 2063 6f6d 7075 7465  hash was compute
-00009210: 642e 0a20 2020 2020 2020 2022 2222 0a20  d..        """. 
-00009220: 2020 2020 2020 2077 6974 6820 7365 6c66         with self
-00009230: 2e5f 6461 7461 6261 7365 5f61 6363 6573  ._database_acces
-00009240: 7328 293a 0a20 2020 2020 2020 2020 2020  s():.           
-00009250: 2069 6620 6861 7368 5f73 7472 3a0a 2020   if hash_str:.  
-00009260: 2020 2020 2020 2020 2020 2020 2020 6361                ca
-00009270: 6368 655f 656e 7472 7920 3d20 4861 7368  che_entry = Hash
-00009280: 4361 6368 6545 6e74 7279 280a 2020 2020  CacheEntry(.    
-00009290: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000092a0: 696e 6f64 653d 696e 6f64 652c 0a20 2020  inode=inode,.   
-000092b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000092c0: 206c 6f63 616c 5f70 6174 683d 6c6f 6361   local_path=loca
-000092d0: 6c5f 7061 7468 2c0a 2020 2020 2020 2020  l_path,.        
-000092e0: 2020 2020 2020 2020 2020 2020 6861 7368              hash
-000092f0: 5f73 7472 3d68 6173 685f 7374 722c 0a20  _str=hash_str,. 
-00009300: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009310: 2020 206d 7469 6d65 3d6d 7469 6d65 2c0a     mtime=mtime,.
-00009320: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009330: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00009340: 2020 7365 6c66 2e5f 6861 7368 5f74 6162    self._hash_tab
-00009350: 6c65 2e75 7064 6174 6528 6361 6368 655f  le.update(cache_
-00009360: 656e 7472 7929 0a0a 2020 2020 2020 2020  entry)..        
-00009370: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-00009380: 2020 2020 2020 2020 2020 7365 6c66 2e5f            self._
-00009390: 6861 7368 5f74 6162 6c65 2e64 656c 6574  hash_table.delet
-000093a0: 655f 7072 696d 6172 795f 6b65 7928 696e  e_primary_key(in
-000093b0: 6f64 6529 0a0a 2020 2020 2320 3d3d 3d3d  ode)..    # ====
-000093c0: 204d 6967 6e6f 7265 206d 616e 6167 656d   Mignore managem
-000093d0: 656e 7420 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ent ============
-000093e0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-000093f0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00009400: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 0a0a  ==============..
-00009410: 2020 2020 4070 726f 7065 7274 790a 2020      @property.  
-00009420: 2020 6465 6620 6d69 676e 6f72 655f 7061    def mignore_pa
-00009430: 7468 2873 656c 6629 202d 3e20 7374 723a  th(self) -> str:
-00009440: 0a20 2020 2020 2020 2022 2222 5061 7468  .        """Path
-00009450: 2074 6f20 6d69 676e 6f72 6520 6669 6c65   to mignore file
-00009460: 206f 6e20 6c6f 6361 6c20 6472 6976 6520   on local drive 
-00009470: 2872 6561 6420 6f6e 6c79 292e 2222 220a  (read only).""".
-00009480: 2020 2020 2020 2020 7265 7475 726e 2073          return s
-00009490: 656c 662e 5f6d 6967 6e6f 7265 5f70 6174  elf._mignore_pat
-000094a0: 680a 0a20 2020 2040 7072 6f70 6572 7479  h..    @property
-000094b0: 0a20 2020 2064 6566 206d 6967 6e6f 7265  .    def mignore
-000094c0: 5f72 756c 6573 2873 656c 6629 202d 3e20  _rules(self) -> 
-000094d0: 5061 7468 5370 6563 3a0a 2020 2020 2020  PathSpec:.      
-000094e0: 2020 2222 224c 6973 7420 6f66 206d 6967    """List of mig
-000094f0: 6e6f 7265 2072 756c 6573 2066 6f6c 6c6f  nore rules follo
-00009500: 7769 6e67 2067 6974 2077 696c 646d 6174  wing git wildmat
-00009510: 6368 2073 796e 7461 7820 2872 6561 6420  ch syntax (read 
-00009520: 6f6e 6c79 292e 2222 220a 2020 2020 2020  only).""".      
-00009530: 2020 7265 7475 726e 2073 656c 662e 5f6d    return self._m
-00009540: 6967 6e6f 7265 5f72 756c 6573 0a0a 2020  ignore_rules..  
-00009550: 2020 6465 6620 6c6f 6164 5f6d 6967 6e6f    def load_migno
-00009560: 7265 5f66 696c 6528 7365 6c66 2920 2d3e  re_file(self) ->
-00009570: 204e 6f6e 653a 0a20 2020 2020 2020 2022   None:.        "
-00009580: 2222 0a20 2020 2020 2020 204c 6f61 6473  "".        Loads
-00009590: 2072 756c 6573 2066 726f 6d20 6d69 676e   rules from mign
-000095a0: 6f72 6520 6669 6c65 2e20 4e6f 2072 756c  ore file. No rul
-000095b0: 6573 2061 7265 206c 6f61 6465 6420 6966  es are loaded if
-000095c0: 2074 6865 2066 696c 6520 646f 6573 0a20   the file does. 
-000095d0: 2020 2020 2020 206e 6f74 2065 7869 7374         not exist
-000095e0: 206f 7220 6361 6e6e 6f74 2062 6520 7265   or cannot be re
-000095f0: 6164 2e0a 0a20 2020 2020 2020 203a 7265  ad...        :re
-00009600: 7475 726e 733a 2050 6174 6853 7065 6320  turns: PathSpec 
-00009610: 696e 7374 616e 6365 2077 6974 6820 6967  instance with ig
-00009620: 6e6f 7265 2070 6174 7465 726e 732e 0a20  nore patterns.. 
-00009630: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
-00009640: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
-00009650: 2020 2020 7769 7468 206f 7065 6e28 7365      with open(se
-00009660: 6c66 2e6d 6967 6e6f 7265 5f70 6174 6829  lf.mignore_path)
-00009670: 2061 7320 663a 0a20 2020 2020 2020 2020   as f:.         
-00009680: 2020 2020 2020 2073 7065 6320 3d20 662e         spec = f.
-00009690: 7265 6164 2829 0a20 2020 2020 2020 2065  read().        e
-000096a0: 7863 6570 7420 4f53 4572 726f 7220 6173  xcept OSError as
-000096b0: 2065 7272 3a0a 2020 2020 2020 2020 2020   err:.          
-000096c0: 2020 7365 6c66 2e5f 6c6f 6767 6572 2e64    self._logger.d
-000096d0: 6562 7567 2822 436f 756c 6420 6e6f 7420  ebug("Could not 
-000096e0: 6c6f 6164 206d 6967 6e6f 7265 2072 756c  load mignore rul
-000096f0: 6573 3a20 2573 222c 2065 7272 2e73 7472  es: %s", err.str
-00009700: 6572 726f 7229 0a20 2020 2020 2020 2020  error).         
-00009710: 2020 2073 7065 6320 3d20 2222 0a0a 2020     spec = ""..  
-00009720: 2020 2020 2020 7365 6c66 2e5f 6d69 676e        self._mign
-00009730: 6f72 655f 7275 6c65 7320 3d20 5061 7468  ore_rules = Path
-00009740: 5370 6563 2e66 726f 6d5f 6c69 6e65 7328  Spec.from_lines(
-00009750: 2267 6974 7769 6c64 6d61 7463 6822 2c20  "gitwildmatch", 
-00009760: 7370 6563 2e73 706c 6974 6c69 6e65 7328  spec.splitlines(
-00009770: 2929 0a0a 2020 2020 2320 3d3d 3d3d 2048  ))..    # ==== H
-00009780: 656c 7065 7220 6675 6e63 7469 6f6e 7320  elper functions 
-00009790: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-000097a0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-000097b0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-000097c0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 0a0a 2020  ============..  
-000097d0: 2020 6465 6620 656e 7375 7265 5f64 726f    def ensure_dro
-000097e0: 7062 6f78 5f66 6f6c 6465 725f 7072 6573  pbox_folder_pres
-000097f0: 656e 7428 7365 6c66 2920 2d3e 204e 6f6e  ent(self) -> Non
-00009800: 653a 0a20 2020 2020 2020 2022 2222 0a20  e:.        """. 
-00009810: 2020 2020 2020 2043 6865 636b 7320 6966         Checks if
-00009820: 2074 6865 2044 726f 7062 6f78 2066 6f6c   the Dropbox fol
-00009830: 6465 7220 7374 696c 6c20 6578 6973 7473  der still exists
-00009840: 2077 6865 7265 2077 6520 6578 7065 6374   where we expect
-00009850: 2069 7420 746f 2062 652e 0a0a 2020 2020   it to be...    
-00009860: 2020 2020 3a72 6169 7365 7320 4e6f 4472      :raises NoDr
-00009870: 6f70 626f 7844 6972 4572 726f 723a 2057  opboxDirError: W
-00009880: 6865 6e20 6c6f 6361 6c20 4472 6f70 626f  hen local Dropbo
-00009890: 7820 6469 7265 6374 6f72 7920 646f 6573  x directory does
-000098a0: 206e 6f74 2065 7869 7374 2e0a 2020 2020   not exist..    
-000098b0: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
-000098c0: 6578 6365 7074 696f 6e20 3d20 4e6f 4472  exception = NoDr
-000098d0: 6f70 626f 7844 6972 4572 726f 7228 0a20  opboxDirError(. 
-000098e0: 2020 2020 2020 2020 2020 2022 4472 6f70             "Drop
-000098f0: 626f 7820 666f 6c64 6572 206d 6973 7369  box folder missi
-00009900: 6e67 222c 0a20 2020 2020 2020 2020 2020  ng",.           
-00009910: 2022 506c 6561 7365 206d 6f76 6520 7468   "Please move th
-00009920: 6520 4472 6f70 626f 7820 666f 6c64 6572  e Dropbox folder
-00009930: 2062 6163 6b20 746f 2069 7473 206f 7269   back to its ori
-00009940: 6769 6e61 6c20 6c6f 6361 7469 6f6e 2022  ginal location "
-00009950: 0a20 2020 2020 2020 2020 2020 2022 6f72  .            "or
-00009960: 2072 6573 7461 7274 204d 6165 7374 7261   restart Maestra
-00009970: 6c20 746f 2073 6574 2075 7020 6120 6e65  l to set up a ne
-00009980: 7720 666f 6c64 6572 2e22 2c0a 2020 2020  w folder.",.    
-00009990: 2020 2020 290a 0a20 2020 2020 2020 2069      )..        i
-000099a0: 6620 6e6f 7420 6973 6469 7228 7365 6c66  f not isdir(self
-000099b0: 2e64 726f 7062 6f78 5f70 6174 6829 3a0a  .dropbox_path):.
-000099c0: 2020 2020 2020 2020 2020 2020 7261 6973              rais
-000099d0: 6520 6578 6365 7074 696f 6e0a 0a20 2020  e exception..   
-000099e0: 2020 2020 2023 2049 6620 7468 6520 6669       # If the fi
-000099f0: 6c65 2073 7973 7465 6d20 6973 206e 6f74  le system is not
-00009a00: 2063 6173 652d 7365 6e73 6974 6976 6520   case-sensitive 
-00009a10: 6275 7420 7072 6573 6572 7669 6e67 2c20  but preserving, 
-00009a20: 6120 7061 7468 2077 6869 6368 2077 6173  a path which was
-00009a30: 0a20 2020 2020 2020 2023 2072 656e 616d  .        # renam
-00009a40: 6564 2077 6974 6820 6120 6361 7365 2063  ed with a case c
-00009a50: 6861 6e67 6520 6f6e 6c79 2077 696c 6c20  hange only will 
-00009a60: 7374 696c 6c20 6578 6973 7420 6174 2074  still exist at t
-00009a70: 6865 206f 6c64 206c 6f63 6174 696f 6e2e  he old location.
-00009a80: 2057 650a 2020 2020 2020 2020 2320 7468   We.        # th
-00009a90: 6572 6566 6f72 6520 6578 706c 6963 6974  erefore explicit
-00009aa0: 6c79 2063 6865 636b 2066 6f72 2063 6173  ly check for cas
-00009ab0: 6520 6368 616e 6765 7320 6865 7265 2e0a  e changes here..
-00009ac0: 2020 2020 2020 2020 6966 206e 6f74 2073          if not s
-00009ad0: 656c 662e 6973 5f66 735f 6361 7365 5f73  elf.is_fs_case_s
-00009ae0: 656e 7369 7469 7665 3a0a 2020 2020 2020  ensitive:.      
-00009af0: 2020 2020 2020 7472 793a 0a20 2020 2020        try:.     
-00009b00: 2020 2020 2020 2020 2020 2063 6173 6564             cased
-00009b10: 5f70 6174 6820 3d20 746f 5f65 7869 7374  _path = to_exist
-00009b20: 696e 675f 756e 6e6f 726d 616c 697a 6564  ing_unnormalized
-00009b30: 5f70 6174 6828 7365 6c66 2e64 726f 7062  _path(self.dropb
-00009b40: 6f78 5f70 6174 6829 0a20 2020 2020 2020  ox_path).       
-00009b50: 2020 2020 2065 7863 6570 7420 2846 696c       except (Fil
-00009b60: 654e 6f74 466f 756e 6445 7272 6f72 2c20  eNotFoundError, 
-00009b70: 4e6f 7441 4469 7265 6374 6f72 7945 7272  NotADirectoryErr
-00009b80: 6f72 293a 0a20 2020 2020 2020 2020 2020  or):.           
-00009b90: 2020 2020 2072 6169 7365 2065 7863 6570       raise excep
-00009ba0: 7469 6f6e 0a0a 2020 2020 2020 2020 2020  tion..          
-00009bb0: 2020 6966 2063 6173 6564 5f70 6174 6820    if cased_path 
-00009bc0: 213d 2073 656c 662e 6472 6f70 626f 785f  != self.dropbox_
-00009bd0: 7061 7468 3a0a 2020 2020 2020 2020 2020  path:.          
-00009be0: 2020 2020 2020 7469 746c 6520 3d20 2244        title = "D
-00009bf0: 726f 7062 6f78 2066 6f6c 6465 7220 7265  ropbox folder re
-00009c00: 6e61 6d65 6422 0a20 2020 2020 2020 2020  named".         
-00009c10: 2020 2020 2020 206d 7367 203d 2028 0a20         msg = (. 
-00009c20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009c30: 2020 2022 506c 6561 7365 206d 6f76 6520     "Please move 
-00009c40: 7468 6520 4472 6f70 626f 7820 666f 6c64  the Dropbox fold
-00009c50: 6572 2062 6163 6b20 746f 2069 7473 206f  er back to its o
-00009c60: 7269 6769 6e61 6c20 6c6f 6361 7469 6f6e  riginal location
-00009c70: 2022 0a20 2020 2020 2020 2020 2020 2020   ".             
-00009c80: 2020 2020 2020 2022 6f72 2072 6573 7461         "or resta
-00009c90: 7274 204d 6165 7374 7261 6c20 746f 2073  rt Maestral to s
-00009ca0: 6574 2075 7020 6120 6e65 7720 666f 6c64  et up a new fold
-00009cb0: 6572 2e22 0a20 2020 2020 2020 2020 2020  er.".           
-00009cc0: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
-00009cd0: 2020 2020 2020 2072 6169 7365 204e 6f44         raise NoD
-00009ce0: 726f 7062 6f78 4469 7245 7272 6f72 2874  ropboxDirError(t
-00009cf0: 6974 6c65 2c20 6d73 6729 0a0a 2020 2020  itle, msg)..    
-00009d00: 6465 6620 656e 7375 7265 5f63 6163 6865  def ensure_cache
-00009d10: 5f64 6972 5f70 7265 7365 6e74 2873 656c  _dir_present(sel
-00009d20: 6629 202d 3e20 4e6f 6e65 3a0a 2020 2020  f) -> None:.    
-00009d30: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
-00009d40: 4368 6563 6b73 2066 6f72 206f 7220 6372  Checks for or cr
-00009d50: 6561 7465 7320 6120 6469 7265 6374 6f72  eates a director
-00009d60: 7920 6174 203a 6174 7472 3a60 6669 6c65  y at :attr:`file
-00009d70: 5f63 6163 6865 5f70 6174 6860 2e0a 0a20  _cache_path`... 
-00009d80: 2020 2020 2020 203a 7261 6973 6573 2043         :raises C
-00009d90: 6163 6865 4469 7245 7272 6f72 3a20 5768  acheDirError: Wh
-00009da0: 656e 206c 6f63 616c 2063 6163 6865 2064  en local cache d
-00009db0: 6972 6563 746f 7279 2063 616e 6e6f 7420  irectory cannot 
-00009dc0: 6265 2063 7265 6174 6564 2e0a 2020 2020  be created..    
-00009dd0: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
-00009de0: 7265 7472 6965 7320 3d20 300a 2020 2020  retries = 0.    
-00009df0: 2020 2020 6d61 785f 7265 7472 6965 7320      max_retries 
-00009e00: 3d20 3130 0a0a 2020 2020 2020 2020 7768  = 10..        wh
-00009e10: 696c 6520 6e6f 7420 6973 6469 7228 7365  ile not isdir(se
-00009e20: 6c66 2e66 696c 655f 6361 6368 655f 7061  lf.file_cache_pa
-00009e30: 7468 293a 0a20 2020 2020 2020 2020 2020  th):.           
-00009e40: 2074 7279 3a0a 2020 2020 2020 2020 2020   try:.          
-00009e50: 2020 2020 2020 2320 5468 6973 2077 696c        # This wil
-00009e60: 6c20 7261 6973 6520 4669 6c65 4578 6973  l raise FileExis
-00009e70: 7473 4572 726f 7220 6966 2066 696c 655f  tsError if file_
-00009e80: 6361 6368 655f 7061 7468 0a20 2020 2020  cache_path.     
-00009e90: 2020 2020 2020 2020 2020 2023 2065 7869             # exi
-00009ea0: 7374 7320 6275 7420 6973 2061 2066 696c  sts but is a fil
-00009eb0: 6520 696e 7374 6561 6420 6f66 2061 2064  e instead of a d
-00009ec0: 6972 6563 746f 7279 2e0a 2020 2020 2020  irectory..      
-00009ed0: 2020 2020 2020 2020 2020 6f73 2e6d 616b            os.mak
-00009ee0: 6564 6972 7328 7365 6c66 2e66 696c 655f  edirs(self.file_
-00009ef0: 6361 6368 655f 7061 7468 2c20 6578 6973  cache_path, exis
-00009f00: 745f 6f6b 3d54 7275 6529 0a20 2020 2020  t_ok=True).     
-00009f10: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-00009f20: 6e0a 2020 2020 2020 2020 2020 2020 6578  n.            ex
-00009f30: 6365 7074 2046 696c 6545 7869 7374 7345  cept FileExistsE
-00009f40: 7272 6f72 3a0a 2020 2020 2020 2020 2020  rror:.          
-00009f50: 2020 2020 2020 2320 5265 6d6f 7665 2074        # Remove t
-00009f60: 6865 2066 696c 6520 7468 6174 2773 2069  he file that's i
-00009f70: 6e20 6f75 7220 7761 792c 2072 6574 7279  n our way, retry
-00009f80: 2063 7265 6174 696f 6e2e 0a20 2020 2020   creation..     
-00009f90: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-00009fa0: 636c 6561 6e5f 6361 6368 655f 6469 7228  clean_cache_dir(
-00009fb0: 290a 2020 2020 2020 2020 2020 2020 6578  ).            ex
-00009fc0: 6365 7074 204e 6f74 4144 6972 6563 746f  cept NotADirecto
-00009fd0: 7279 4572 726f 723a 0a20 2020 2020 2020  ryError:.       
-00009fe0: 2020 2020 2020 2020 2023 2045 6e73 7572           # Ensur
-00009ff0: 6520 7468 6174 2070 6172 656e 7420 6469  e that parent di
-0000a000: 7265 6374 6f72 6965 7320 6578 6973 7420  rectories exist 
-0000a010: 6173 2065 7870 6563 7465 642e 0a20 2020  as expected..   
-0000a020: 2020 2020 2020 2020 2020 2020 2073 656c               sel
-0000a030: 662e 656e 7375 7265 5f64 726f 7062 6f78  f.ensure_dropbox
-0000a040: 5f66 6f6c 6465 725f 7072 6573 656e 7428  _folder_present(
-0000a050: 290a 2020 2020 2020 2020 2020 2020 6578  ).            ex
-0000a060: 6365 7074 204f 5345 7272 6f72 2061 7320  cept OSError as 
-0000a070: 6572 723a 0a20 2020 2020 2020 2020 2020  err:.           
-0000a080: 2020 2020 2072 6169 7365 2043 6163 6865       raise Cache
-0000a090: 4469 7245 7272 6f72 280a 2020 2020 2020  DirError(.      
-0000a0a0: 2020 2020 2020 2020 2020 2020 2020 6622                f"
-0000a0b0: 4361 6e6e 6f74 2063 7265 6174 6520 6361  Cannot create ca
-0000a0c0: 6368 6520 6469 7265 6374 6f72 793a 207b  che directory: {
-0000a0d0: 6572 722e 7374 7265 7272 6f72 7d22 2c0a  err.strerror}",.
-0000a0e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a0f0: 2020 2020 2250 6c65 6173 6520 6368 6563      "Please chec
-0000a100: 6b20 6966 2079 6f75 2068 6176 6520 7772  k if you have wr
-0000a110: 6974 6520 7065 726d 6973 7369 6f6e 7320  ite permissions 
-0000a120: 666f 7220 220a 2020 2020 2020 2020 2020  for ".          
-0000a130: 2020 2020 2020 2020 2020 6622 7b73 656c            f"{sel
-0000a140: 662e 5f66 696c 655f 6361 6368 655f 7061  f._file_cache_pa
-0000a150: 7468 7d2e 222c 0a20 2020 2020 2020 2020  th}.",.         
-0000a160: 2020 2020 2020 2029 0a0a 2020 2020 2020         )..      
-0000a170: 2020 2020 2020 6966 2072 6574 7269 6573        if retries
-0000a180: 203e 206d 6178 5f72 6574 7269 6573 3a0a   > max_retries:.
-0000a190: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a1a0: 7261 6973 6520 4361 6368 6544 6972 4572  raise CacheDirEr
-0000a1b0: 726f 7228 0a20 2020 2020 2020 2020 2020  ror(.           
-0000a1c0: 2020 2020 2020 2020 2022 4361 6e6e 6f74           "Cannot
-0000a1d0: 2063 7265 6174 6520 6361 6368 6520 6469   create cache di
-0000a1e0: 7265 6374 6f72 7922 2c0a 2020 2020 2020  rectory",.      
-0000a1f0: 2020 2020 2020 2020 2020 2020 2020 2245                "E
-0000a200: 7863 6565 6465 6420 6d61 7869 6d75 6d20  xceeded maximum 
-0000a210: 6e75 6d62 6572 206f 6620 7265 7472 6965  number of retrie
-0000a220: 7322 2c0a 2020 2020 2020 2020 2020 2020  s",.            
-0000a230: 2020 2020 290a 0a20 2020 2020 2020 2020      )..         
-0000a240: 2020 2074 696d 652e 736c 6565 7028 302e     time.sleep(0.
-0000a250: 3031 290a 2020 2020 2020 2020 2020 2020  01).            
-0000a260: 7265 7472 6965 7320 2b3d 2031 0a0a 2020  retries += 1..  
-0000a270: 2020 6465 6620 636c 6561 6e5f 6361 6368    def clean_cach
-0000a280: 655f 6469 7228 7365 6c66 2c20 7261 6973  e_dir(self, rais
-0000a290: 655f 6572 726f 723a 2062 6f6f 6c20 3d20  e_error: bool = 
-0000a2a0: 5472 7565 2920 2d3e 204e 6f6e 653a 0a20  True) -> None:. 
-0000a2b0: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
-0000a2c0: 2020 2052 656d 6f76 6573 2061 6c6c 2069     Removes all i
-0000a2d0: 7465 6d73 2069 6e20 7468 6520 6361 6368  tems in the cach
-0000a2e0: 6520 6469 7265 6374 6f72 792e 0a0a 2020  e directory...  
-0000a2f0: 2020 2020 2020 3a70 6172 616d 2072 6169        :param rai
-0000a300: 7365 5f65 7272 6f72 3a20 5768 6574 6865  se_error: Whethe
-0000a310: 7220 6572 726f 7273 2073 686f 756c 6420  r errors should 
-0000a320: 6265 2072 6169 7365 6420 6f72 206f 6e6c  be raised or onl
-0000a330: 7920 6c6f 6767 6564 2e0a 2020 2020 2020  y logged..      
-0000a340: 2020 2222 220a 2020 2020 2020 2020 7769    """.        wi
-0000a350: 7468 2073 656c 662e 7379 6e63 5f6c 6f63  th self.sync_loc
-0000a360: 6b3a 0a20 2020 2020 2020 2020 2020 2074  k:.            t
-0000a370: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
-0000a380: 2020 2020 6465 6c65 7465 2873 656c 662e      delete(self.
-0000a390: 5f66 696c 655f 6361 6368 655f 7061 7468  _file_cache_path
-0000a3a0: 2c20 7261 6973 655f 6572 726f 723d 5472  , raise_error=Tr
-0000a3b0: 7565 290a 2020 2020 2020 2020 2020 2020  ue).            
-0000a3c0: 6578 6365 7074 2028 4669 6c65 4e6f 7446  except (FileNotF
-0000a3d0: 6f75 6e64 4572 726f 722c 2049 7341 4469  oundError, IsADi
-0000a3e0: 7265 6374 6f72 7945 7272 6f72 293a 0a20  rectoryError):. 
-0000a3f0: 2020 2020 2020 2020 2020 2020 2020 2070                 p
-0000a400: 6173 730a 2020 2020 2020 2020 2020 2020  ass.            
-0000a410: 6578 6365 7074 204f 5345 7272 6f72 2061  except OSError a
-0000a420: 7320 6572 723a 0a20 2020 2020 2020 2020  s err:.         
-0000a430: 2020 2020 2020 2065 7863 203d 2043 6163         exc = Cac
-0000a440: 6865 4469 7245 7272 6f72 280a 2020 2020  heDirError(.    
-0000a450: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a460: 6622 4361 6e6e 6f74 2063 7265 6174 6520  f"Cannot create 
-0000a470: 6361 6368 6520 6469 7265 6374 6f72 793a  cache directory:
-0000a480: 207b 6572 722e 7374 7265 7272 6f72 7d22   {err.strerror}"
-0000a490: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0000a4a0: 2020 2020 2020 2250 6c65 6173 6520 6368        "Please ch
-0000a4b0: 6563 6b20 6966 2079 6f75 2068 6176 6520  eck if you have 
-0000a4c0: 7772 6974 6520 7065 726d 6973 7369 6f6e  write permission
-0000a4d0: 7320 666f 7220 220a 2020 2020 2020 2020  s for ".        
-0000a4e0: 2020 2020 2020 2020 2020 2020 6622 7b73              f"{s
-0000a4f0: 656c 662e 5f66 696c 655f 6361 6368 655f  elf._file_cache_
-0000a500: 7061 7468 7d2e 222c 0a20 2020 2020 2020  path}.",.       
-0000a510: 2020 2020 2020 2020 2029 0a0a 2020 2020           )..    
-0000a520: 2020 2020 2020 2020 2020 2020 6966 2072              if r
-0000a530: 6169 7365 5f65 7272 6f72 3a0a 2020 2020  aise_error:.    
-0000a540: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a550: 7261 6973 6520 6578 630a 0a20 2020 2020  raise exc..     
-0000a560: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-0000a570: 5f6c 6f67 6765 722e 6572 726f 7228 6578  _logger.error(ex
-0000a580: 632e 7469 746c 652c 2065 7863 5f69 6e66  c.title, exc_inf
-0000a590: 6f3d 6578 635f 696e 666f 5f74 7570 6c65  o=exc_info_tuple
-0000a5a0: 2865 7863 2929 0a20 2020 2020 2020 2020  (exc)).         
-0000a5b0: 2020 2020 2020 2069 6620 7365 6c66 2e64         if self.d
-0000a5c0: 6573 6b74 6f70 5f6e 6f74 6966 6965 723a  esktop_notifier:
-0000a5d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000a5e0: 2020 2020 2073 656c 662e 6465 736b 746f       self.deskto
-0000a5f0: 705f 6e6f 7469 6669 6572 2e6e 6f74 6966  p_notifier.notif
-0000a600: 7928 0a20 2020 2020 2020 2020 2020 2020  y(.             
-0000a610: 2020 2020 2020 2020 2020 2065 7863 2e74             exc.t
-0000a620: 6974 6c65 2c20 6578 632e 6d65 7373 6167  itle, exc.messag
-0000a630: 652c 206c 6576 656c 3d6e 6f74 6966 792e  e, level=notify.
-0000a640: 4552 524f 520a 2020 2020 2020 2020 2020  ERROR.          
-0000a650: 2020 2020 2020 2020 2020 290a 0a20 2020            )..   
-0000a660: 2064 6566 205f 6e65 775f 746d 705f 6669   def _new_tmp_fi
-0000a670: 6c65 2873 656c 6629 202d 3e20 7374 723a  le(self) -> str:
-0000a680: 0a20 2020 2020 2020 2022 2222 4372 6561  .        """Crea
-0000a690: 7465 7320 6120 6e65 7720 7465 6d70 6f72  tes a new tempor
-0000a6a0: 6172 7920 6669 6c65 2069 6e20 6f75 7220  ary file in our 
-0000a6b0: 6361 6368 6520 6469 7265 6374 6f72 7920  cache directory 
-0000a6c0: 616e 6420 7265 7475 726e 7320 6974 7320  and returns its 
-0000a6d0: 7061 7468 2e22 2222 0a20 2020 2020 2020  path.""".       
-0000a6e0: 2073 656c 662e 656e 7375 7265 5f63 6163   self.ensure_cac
-0000a6f0: 6865 5f64 6972 5f70 7265 7365 6e74 2829  he_dir_present()
-0000a700: 0a20 2020 2020 2020 2074 7279 3a0a 2020  .        try:.  
-0000a710: 2020 2020 2020 2020 2020 7769 7468 204e            with N
-0000a720: 616d 6564 5465 6d70 6f72 6172 7946 696c  amedTemporaryFil
-0000a730: 6528 6469 723d 7365 6c66 2e66 696c 655f  e(dir=self.file_
-0000a740: 6361 6368 655f 7061 7468 2c20 6465 6c65  cache_path, dele
-0000a750: 7465 3d46 616c 7365 2920 6173 2066 3a0a  te=False) as f:.
-0000a760: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a770: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
-0000a780: 2020 2020 2020 2020 206f 732e 6368 6d6f           os.chmo
-0000a790: 6428 662e 6669 6c65 6e6f 2829 2c20 306f  d(f.fileno(), 0o
-0000a7a0: 3636 3620 2620 7e75 6d61 736b 290a 2020  666 & ~umask).  
-0000a7b0: 2020 2020 2020 2020 2020 2020 2020 6578                ex
-0000a7c0: 6365 7074 204f 5345 7272 6f72 2061 7320  cept OSError as 
-0000a7d0: 6572 723a 0a20 2020 2020 2020 2020 2020  err:.           
-0000a7e0: 2020 2020 2020 2020 2023 2043 616e 206f           # Can o
-0000a7f0: 6363 7572 206f 6e20 6669 6c65 2073 7973  ccur on file sys
-0000a800: 7465 6d27 7320 7468 6174 2064 6f6e 2774  tem's that don't
-0000a810: 2073 7570 706f 7274 2050 4f53 4958 2070   support POSIX p
-0000a820: 6572 6d69 7373 696f 6e73 0a20 2020 2020  ermissions.     
-0000a830: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-0000a840: 2073 7563 6820 6173 204e 5446 5320 6d6f   such as NTFS mo
-0000a850: 756e 7465 6420 7769 7468 6f75 7420 7468  unted without th
-0000a860: 6520 7065 726d 6973 7369 6f6e 7320 6f70  e permissions op
-0000a870: 7469 6f6e 2e0a 2020 2020 2020 2020 2020  tion..          
-0000a880: 2020 2020 2020 2020 2020 7365 6c66 2e5f            self._
-0000a890: 6c6f 6767 6572 2e64 6562 7567 2822 4361  logger.debug("Ca
-0000a8a0: 6e6e 6f74 2073 6574 2070 6572 6d69 7373  nnot set permiss
-0000a8b0: 696f 6e73 3a20 2573 222c 2065 7272 2e73  ions: %s", err.s
-0000a8c0: 7472 6572 726f 7229 0a20 2020 2020 2020  trerror).       
-0000a8d0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-0000a8e0: 662e 6e61 6d65 0a20 2020 2020 2020 2065  f.name.        e
-0000a8f0: 7863 6570 7420 4f53 4572 726f 7220 6173  xcept OSError as
-0000a900: 2065 7272 3a0a 2020 2020 2020 2020 2020   err:.          
-0000a910: 2020 7261 6973 6520 4361 6368 6544 6972    raise CacheDir
-0000a920: 4572 726f 7228 0a20 2020 2020 2020 2020  Error(.         
-0000a930: 2020 2020 2020 2066 2243 616e 6e6f 7420         f"Cannot 
-0000a940: 6372 6561 7465 2063 6163 6865 2064 6972  create cache dir
-0000a950: 6563 746f 7279 3a20 7b65 7272 2e73 7472  ectory: {err.str
-0000a960: 6572 726f 727d 222c 0a20 2020 2020 2020  error}",.       
-0000a970: 2020 2020 2020 2020 2022 506c 6561 7365           "Please
-0000a980: 2063 6865 636b 2069 6620 796f 7520 6861   check if you ha
-0000a990: 7665 2077 7269 7465 2070 6572 6d69 7373  ve write permiss
-0000a9a0: 696f 6e73 2066 6f72 2022 0a20 2020 2020  ions for ".     
-0000a9b0: 2020 2020 2020 2020 2020 2066 227b 7365             f"{se
-0000a9c0: 6c66 2e5f 6669 6c65 5f63 6163 6865 5f70  lf._file_cache_p
-0000a9d0: 6174 687d 2e22 2c0a 2020 2020 2020 2020  ath}.",.        
-0000a9e0: 2020 2020 290a 0a20 2020 2064 6566 2063      )..    def c
-0000a9f0: 6f72 7265 6374 5f63 6173 6528 7365 6c66  orrect_case(self
-0000aa00: 2c20 6462 785f 7061 7468 3a20 7374 7229  , dbx_path: str)
-0000aa10: 202d 3e20 7374 723a 0a20 2020 2020 2020   -> str:.       
-0000aa20: 2022 2222 0a20 2020 2020 2020 2043 6f6e   """.        Con
-0000aa30: 7665 7274 7320 6120 4472 6f70 626f 7820  verts a Dropbox 
-0000aa40: 7061 7468 2077 6974 6820 636f 7272 6563  path with correc
-0000aa50: 746c 7920 6361 7365 6420 6261 7365 6e61  tly cased basena
-0000aa60: 6d65 2074 6f20 6120 6675 6c6c 7920 6361  me to a fully ca
-0000aa70: 7365 6420 7061 7468 2e0a 2020 2020 2020  sed path..      
-0000aa80: 2020 5468 6973 2069 7320 7573 6566 756c    This is useful
-0000aa90: 2062 6563 6175 7365 2074 6865 2044 726f   because the Dro
-0000aaa0: 7062 6f78 2041 5049 2067 7561 7261 6e74  pbox API guarant
-0000aab0: 6565 7320 7468 6520 636f 7272 6563 7420  ees the correct 
-0000aac0: 6361 7369 6e67 2066 6f72 2074 6865 0a20  casing for the. 
-0000aad0: 2020 2020 2020 2062 6173 656e 616d 6520         basename 
-0000aae0: 6f6e 6c79 2e20 496e 2070 7261 6374 6963  only. In practic
-0000aaf0: 652c 2063 6173 696e 6720 6f66 2070 6172  e, casing of par
-0000ab00: 656e 7420 6469 7265 6374 6f72 6965 7320  ent directories 
-0000ab10: 6973 206f 6674 656e 2069 6e63 6f72 7265  is often incorre
-0000ab20: 6374 2e0a 2020 2020 2020 2020 5468 6973  ct..        This
-0000ab30: 206d 6574 686f 6420 7265 7472 6965 7665   method retrieve
-0000ab40: 7320 7468 6520 636f 7272 6563 7420 6361  s the correct ca
-0000ab50: 7369 6e67 206f 6620 616c 6c20 616e 6365  sing of all ance
-0000ab60: 7374 6f72 7320 696e 2074 6865 2070 6174  stors in the pat
-0000ab70: 682c 2065 6974 6865 720a 2020 2020 2020  h, either.      
-0000ab80: 2020 6672 6f6d 206f 7572 2063 6163 6865    from our cache
-0000ab90: 2c20 6f75 7220 6461 7461 6261 7365 2c20  , our database, 
-0000aba0: 6f72 2066 726f 6d20 4472 6f70 626f 7820  or from Dropbox 
-0000abb0: 7365 7276 6572 732e 0a0a 2020 2020 2020  servers...      
-0000abc0: 2020 5065 7266 6f72 6d61 6e63 6520 6d61    Performance ma
-0000abd0: 7920 7661 7279 2073 6967 6e69 6669 6361  y vary significa
-0000abe0: 6e74 6c79 2077 6974 6820 7468 6520 6e75  ntly with the nu
-0000abf0: 6d62 6572 206f 6620 7061 7265 6e74 2066  mber of parent f
-0000ac00: 6f6c 6465 7273 2061 6e64 2074 6865 0a20  olders and the. 
-0000ac10: 2020 2020 2020 206d 6574 686f 6420 7573         method us
-0000ac20: 6564 2074 6f20 7265 736f 6c76 6520 7468  ed to resolve th
-0000ac30: 6520 6361 7369 6e67 206f 6620 616c 6c20  e casing of all 
-0000ac40: 7061 7265 6e74 2064 6972 6563 746f 7279  parent directory
-0000ac50: 206e 616d 6573 3a0a 0a20 2020 2020 2020   names:..       
-0000ac60: 2031 2920 4966 2074 6865 2070 6172 656e   1) If the paren
-0000ac70: 7420 6469 7265 6374 6f72 7920 6973 2061  t directory is a
-0000ac80: 6c72 6561 6479 2069 6e20 6f75 7220 6361  lready in our ca
-0000ac90: 6368 652c 2070 6572 666f 726d 616e 6365  che, performance
-0000aca0: 2069 7320 4f28 3129 2e0a 2020 2020 2020   is O(1)..      
-0000acb0: 2020 3229 2049 6620 7468 6520 7061 7265    2) If the pare
-0000acc0: 6e74 2064 6972 6563 746f 7279 2069 7320  nt directory is 
-0000acd0: 616c 7265 6164 7920 696e 206f 7572 2073  already in our s
-0000ace0: 796e 6320 696e 6465 782c 2070 6572 666f  ync index, perfo
-0000acf0: 726d 616e 6365 2069 7320 736c 6f77 6572  rmance is slower
-0000ad00: 0a20 2020 2020 2020 2020 2020 6265 6361  .           beca
-0000ad10: 7573 6520 6974 2072 6571 7569 7265 7320  use it requires 
-0000ad20: 6120 7371 6c69 7465 2071 7565 7279 2062  a sqlite query b
-0000ad30: 7574 2073 7469 6c6c 204f 2831 292e 0a20  ut still O(1).. 
-0000ad40: 2020 2020 2020 2033 2920 4966 2074 6865         3) If the
-0000ad50: 2070 6172 656e 7420 6469 7265 6374 6f72   parent director
-0000ad60: 7920 6973 2075 6e6b 6e6f 776e 2074 6f20  y is unknown to 
-0000ad70: 7573 2c20 6974 7320 6d65 7461 6461 7461  us, its metadata
-0000ad80: 2028 696e 636c 7564 696e 6720 7468 6520   (including the 
-0000ad90: 636f 7272 6563 740a 2020 2020 2020 2020  correct.        
-0000ada0: 2020 2063 6173 696e 6720 6f66 2064 6972     casing of dir
-0000adb0: 6563 746f 7279 2773 2062 6173 656e 616d  ectory's basenam
-0000adc0: 6529 2069 7320 7175 6572 6965 6420 6672  e) is queried fr
-0000add0: 6f6d 2044 726f 7062 6f78 2e20 5468 6973  om Dropbox. This
-0000ade0: 2069 7320 7573 6564 2074 6f0a 2020 2020   is used to.    
-0000adf0: 2020 2020 2020 2063 6f6e 7374 7275 6374         construct
-0000ae00: 2061 2063 6f72 7265 6374 6c79 2063 6173   a correctly cas
-0000ae10: 6564 2070 6174 6820 6279 2063 616c 6c69  ed path by calli
-0000ae20: 6e67 203a 6d65 7468 3a60 636f 7272 6563  ng :meth:`correc
-0000ae30: 745f 6361 7365 6020 6167 6169 6e2e 2041  t_case` again. A
-0000ae40: 740a 2020 2020 2020 2020 2020 2062 6573  t.           bes
-0000ae50: 742c 2070 6572 666f 726d 616e 6365 2077  t, performance w
-0000ae60: 696c 6c20 6265 206f 6620 4f28 3229 2069  ill be of O(2) i
-0000ae70: 6620 7468 6520 7061 7265 6e74 2064 6972  f the parent dir
-0000ae80: 6563 746f 7279 2069 7320 6b6e 6f77 6e20  ectory is known 
-0000ae90: 746f 2075 732c 2061 740a 2020 2020 2020  to us, at.      
-0000aea0: 2020 2020 2077 6f72 7374 2069 7420 7769       worst it wi
-0000aeb0: 6c6c 2062 6520 6f66 206f 7264 6572 204f  ll be of order O
-0000aec0: 286e 2920 696e 766f 6c76 696e 6720 7175  (n) involving qu
-0000aed0: 6572 6965 7320 746f 2044 726f 7062 6f78  eries to Dropbox
-0000aee0: 2073 6572 7665 7273 2066 6f72 2065 6163   servers for eac
-0000aef0: 680a 2020 2020 2020 2020 2020 2070 6172  h.           par
-0000af00: 656e 7420 6469 7265 6374 6f72 792e 0a0a  ent directory...
-0000af10: 2020 2020 2020 2020 5768 656e 2063 616c          When cal
-0000af20: 6c69 6e67 203a 6d65 7468 3a60 636f 7272  ling :meth:`corr
-0000af30: 6563 745f 6361 7365 6020 7265 7065 6174  ect_case` repeat
-0000af40: 6564 6c79 2066 6f72 2070 6174 6873 2066  edly for paths f
-0000af50: 726f 6d20 7468 6520 7361 6d65 2074 7265  rom the same tre
-0000af60: 652c 2069 7420 6973 0a20 2020 2020 2020  e, it is.       
-0000af70: 2074 6865 7265 666f 7265 2062 6573 7420   therefore best 
-0000af80: 746f 2064 6f20 736f 2069 6e20 6869 6572  to do so in hier
-0000af90: 6172 6368 6963 616c 206f 7264 6572 2e0a  archical order..
-0000afa0: 0a20 2020 2020 2020 203a 7061 7261 6d20  .        :param 
-0000afb0: 6462 785f 7061 7468 3a20 4472 6f70 626f  dbx_path: Dropbo
-0000afc0: 7820 7061 7468 2077 6974 6820 636f 7272  x path with corr
-0000afd0: 6563 746c 7920 6361 7365 6420 6261 7365  ectly cased base
-0000afe0: 6e61 6d65 2c20 6173 2070 726f 7669 6465  name, as provide
-0000aff0: 6420 6279 0a20 2020 2020 2020 2020 2020  d by.           
-0000b000: 203a 6174 7472 3a60 6472 6f70 626f 782e   :attr:`dropbox.
-0000b010: 6669 6c65 732e 4d65 7461 6461 7461 2e70  files.Metadata.p
-0000b020: 6174 685f 6469 7370 6c61 7960 206f 720a  ath_display` or.
-0000b030: 2020 2020 2020 2020 2020 2020 3a61 7474              :att
-0000b040: 723a 6064 726f 7062 6f78 2e66 696c 6573  r:`dropbox.files
-0000b050: 2e4d 6574 6164 6174 612e 6e61 6d65 602e  .Metadata.name`.
-0000b060: 0a20 2020 2020 2020 203a 7265 7475 726e  .        :return
-0000b070: 733a 2043 6f72 7265 6374 6c79 2063 6173  s: Correctly cas
-0000b080: 6564 2044 726f 7062 6f78 2070 6174 682e  ed Dropbox path.
-0000b090: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
-0000b0a0: 2020 2020 2064 6278 5f70 6174 685f 6c6f       dbx_path_lo
-0000b0b0: 7765 7220 3d20 6e6f 726d 616c 697a 6528  wer = normalize(
-0000b0c0: 6462 785f 7061 7468 290a 0a20 2020 2020  dbx_path)..     
-0000b0d0: 2020 2064 6972 6e61 6d65 2c20 6261 7365     dirname, base
-0000b0e0: 6e61 6d65 203d 206f 7370 2e73 706c 6974  name = osp.split
-0000b0f0: 2864 6278 5f70 6174 6829 0a20 2020 2020  (dbx_path).     
-0000b100: 2020 2064 6972 6e61 6d65 5f6c 6f77 6572     dirname_lower
-0000b110: 203d 206f 7370 2e64 6972 6e61 6d65 2864   = osp.dirname(d
-0000b120: 6278 5f70 6174 685f 6c6f 7765 7229 0a0a  bx_path_lower)..
-0000b130: 2020 2020 2020 2020 6469 726e 616d 655f          dirname_
-0000b140: 6361 7365 6420 3d20 7365 6c66 2e5f 636f  cased = self._co
-0000b150: 7272 6563 745f 6361 7365 5f68 656c 7065  rrect_case_helpe
-0000b160: 7228 6469 726e 616d 652c 2064 6972 6e61  r(dirname, dirna
-0000b170: 6d65 5f6c 6f77 6572 290a 2020 2020 2020  me_lower).      
-0000b180: 2020 7061 7468 5f63 6173 6564 203d 206f    path_cased = o
-0000b190: 7370 2e6a 6f69 6e28 6469 726e 616d 655f  sp.join(dirname_
-0000b1a0: 6361 7365 642c 2062 6173 656e 616d 6529  cased, basename)
-0000b1b0: 0a0a 2020 2020 2020 2020 2320 4164 6420  ..        # Add 
-0000b1c0: 6f75 7220 7265 7375 6c74 2074 6f20 7468  our result to th
-0000b1d0: 6520 6361 6368 652e 0a20 2020 2020 2020  e cache..       
-0000b1e0: 2073 656c 662e 5f63 6173 655f 636f 6e76   self._case_conv
-0000b1f0: 6572 7369 6f6e 5f63 6163 6865 2e70 7574  ersion_cache.put
-0000b200: 2864 6278 5f70 6174 685f 6c6f 7765 722c  (dbx_path_lower,
-0000b210: 2070 6174 685f 6361 7365 6429 0a0a 2020   path_cased)..  
-0000b220: 2020 2020 2020 7265 7475 726e 2070 6174        return pat
-0000b230: 685f 6361 7365 640a 0a20 2020 2064 6566  h_cased..    def
-0000b240: 205f 636f 7272 6563 745f 6361 7365 5f68   _correct_case_h
-0000b250: 656c 7065 7228 7365 6c66 2c20 6462 785f  elper(self, dbx_
-0000b260: 7061 7468 3a20 7374 722c 2064 6278 5f70  path: str, dbx_p
-0000b270: 6174 685f 6c6f 7765 723a 2073 7472 2920  ath_lower: str) 
-0000b280: 2d3e 2073 7472 3a0a 2020 2020 2020 2020  -> str:.        
-0000b290: 2222 220a 2020 2020 2020 2020 3a70 6172  """.        :par
-0000b2a0: 616d 2064 6278 5f70 6174 683a 2055 6e63  am dbx_path: Unc
-0000b2b0: 6173 6564 206f 7220 7261 6e64 6f6d 6c79  ased or randomly
-0000b2c0: 2063 6173 6564 2044 726f 7062 6f78 2070   cased Dropbox p
-0000b2d0: 6174 682e 0a20 2020 2020 2020 203a 7061  ath..        :pa
-0000b2e0: 7261 6d20 6462 785f 7061 7468 5f6c 6f77  ram dbx_path_low
-0000b2f0: 6572 3a20 4e6f 726d 616c 697a 6564 2066  er: Normalized f
-0000b300: 756c 6c79 206c 6f77 6572 2063 6173 6564  ully lower cased
-0000b310: 2044 726f 7062 6f78 2070 6174 682e 0a20   Dropbox path.. 
-0000b320: 2020 2020 2020 203a 7265 7475 726e 733a         :returns:
-0000b330: 2043 6f72 7265 6374 6c79 2063 6173 6564   Correctly cased
-0000b340: 2044 726f 7062 6f78 2070 6174 682e 0a20   Dropbox path.. 
-0000b350: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
-0000b360: 2020 2023 2043 6865 636b 2066 6f72 2072     # Check for r
-0000b370: 6f6f 7420 666f 6c64 6572 2e0a 2020 2020  oot folder..    
-0000b380: 2020 2020 6966 2064 6278 5f70 6174 6820      if dbx_path 
-0000b390: 3d3d 2022 2f22 3a0a 2020 2020 2020 2020  == "/":.        
-0000b3a0: 2020 2020 7265 7475 726e 2064 6278 5f70      return dbx_p
-0000b3b0: 6174 680a 0a20 2020 2020 2020 2023 2043  ath..        # C
-0000b3c0: 6865 636b 2069 6e20 6f75 7220 636f 6e76  heck in our conv
-0000b3d0: 6572 7369 6f6e 2063 6163 6865 2e0a 2020  ersion cache..  
-0000b3e0: 2020 2020 2020 6462 785f 7061 7468 5f63        dbx_path_c
-0000b3f0: 6173 6564 203d 2073 656c 662e 5f63 6173  ased = self._cas
-0000b400: 655f 636f 6e76 6572 7369 6f6e 5f63 6163  e_conversion_cac
-0000b410: 6865 2e67 6574 2864 6278 5f70 6174 685f  he.get(dbx_path_
-0000b420: 6c6f 7765 7229 0a0a 2020 2020 2020 2020  lower)..        
-0000b430: 6966 2064 6278 5f70 6174 685f 6361 7365  if dbx_path_case
-0000b440: 643a 0a20 2020 2020 2020 2020 2020 2072  d:.            r
-0000b450: 6574 7572 6e20 6462 785f 7061 7468 5f63  eturn dbx_path_c
-0000b460: 6173 6564 0a0a 2020 2020 2020 2020 2320  ased..        # 
-0000b470: 5472 7920 746f 2067 6574 2063 6173 696e  Try to get casin
-0000b480: 6720 6672 6f6d 206f 7572 2069 6e64 6578  g from our index
-0000b490: 2c20 7468 6973 2069 7320 736c 6f77 6572  , this is slower
-0000b4a0: 2e0a 2020 2020 2020 2020 7769 7468 2073  ..        with s
-0000b4b0: 656c 662e 5f64 6174 6162 6173 655f 6163  elf._database_ac
-0000b4c0: 6365 7373 2829 3a0a 2020 2020 2020 2020  cess():.        
-0000b4d0: 2020 2020 656e 7472 7920 3d20 7365 6c66      entry = self
-0000b4e0: 2e67 6574 5f69 6e64 6578 5f65 6e74 7279  .get_index_entry
-0000b4f0: 2864 6278 5f70 6174 685f 6c6f 7765 7229  (dbx_path_lower)
-0000b500: 0a0a 2020 2020 2020 2020 6966 2065 6e74  ..        if ent
-0000b510: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
-0000b520: 6462 785f 7061 7468 5f63 6173 6564 203d  dbx_path_cased =
-0000b530: 2065 6e74 7279 2e64 6278 5f70 6174 685f   entry.dbx_path_
-0000b540: 6361 7365 640a 2020 2020 2020 2020 656c  cased.        el
-0000b550: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-0000b560: 2320 4661 6c6c 2062 6163 6b20 746f 2071  # Fall back to q
-0000b570: 7565 7279 696e 6720 6672 6f6d 2073 6572  uerying from ser
-0000b580: 7665 722e 0a20 2020 2020 2020 2020 2020  ver..           
-0000b590: 206d 6420 3d20 7365 6c66 2e63 6c69 656e   md = self.clien
-0000b5a0: 742e 6765 745f 6d65 7461 6461 7461 2864  t.get_metadata(d
-0000b5b0: 6278 5f70 6174 6829 0a20 2020 2020 2020  bx_path).       
-0000b5c0: 2020 2020 2069 6620 6d64 3a0a 2020 2020       if md:.    
-0000b5d0: 2020 2020 2020 2020 2020 2020 2320 5265              # Re
-0000b5e0: 6375 7273 6520 6f76 6572 2070 6172 656e  curse over paren
-0000b5f0: 7420 6469 7265 6374 6f72 6965 732e 0a20  t directories.. 
-0000b600: 2020 2020 2020 2020 2020 2020 2020 2064                 d
-0000b610: 6278 5f70 6174 685f 6361 7365 6420 3d20  bx_path_cased = 
-0000b620: 7365 6c66 2e63 6f72 7265 6374 5f63 6173  self.correct_cas
-0000b630: 6528 6d64 2e70 6174 685f 6469 7370 6c61  e(md.path_displa
-0000b640: 7929 0a20 2020 2020 2020 2020 2020 2065  y).            e
-0000b650: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-0000b660: 2020 2020 2023 2047 6976 6520 7570 2e0a       # Give up..
-0000b670: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b680: 6462 785f 7061 7468 5f63 6173 6564 203d  dbx_path_cased =
-0000b690: 2064 6278 5f70 6174 680a 0a20 2020 2020   dbx_path..     
-0000b6a0: 2020 2023 2041 6464 206f 7572 2072 6573     # Add our res
-0000b6b0: 756c 7420 746f 2074 6865 2063 6163 6865  ult to the cache
-0000b6c0: 2e0a 2020 2020 2020 2020 7365 6c66 2e5f  ..        self._
-0000b6d0: 6361 7365 5f63 6f6e 7665 7273 696f 6e5f  case_conversion_
-0000b6e0: 6361 6368 652e 7075 7428 6462 785f 7061  cache.put(dbx_pa
-0000b6f0: 7468 5f6c 6f77 6572 2c20 6462 785f 7061  th_lower, dbx_pa
-0000b700: 7468 5f63 6173 6564 290a 0a20 2020 2020  th_cased)..     
-0000b710: 2020 2072 6574 7572 6e20 6462 785f 7061     return dbx_pa
-0000b720: 7468 5f63 6173 6564 0a0a 2020 2020 6465  th_cased..    de
-0000b730: 6620 746f 5f64 6278 5f70 6174 6828 7365  f to_dbx_path(se
-0000b740: 6c66 2c20 6c6f 6361 6c5f 7061 7468 3a20  lf, local_path: 
-0000b750: 7374 7229 202d 3e20 7374 723a 0a20 2020  str) -> str:.   
-0000b760: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
-0000b770: 2043 6f6e 7665 7274 7320 6120 6c6f 6361   Converts a loca
-0000b780: 6c20 7061 7468 2074 6f20 6120 7061 7468  l path to a path
-0000b790: 2072 656c 6174 6976 6520 746f 2074 6865   relative to the
-0000b7a0: 2044 726f 7062 6f78 2066 6f6c 6465 722e   Dropbox folder.
-0000b7b0: 2043 6173 696e 6720 6f66 2074 6865 0a20   Casing of the. 
-0000b7c0: 2020 2020 2020 2067 6976 656e 2060 606c         given ``l
-0000b7d0: 6f63 616c 5f70 6174 6860 6020 7769 6c6c  ocal_path`` will
-0000b7e0: 2062 6520 7072 6573 6572 7665 642e 0a0a   be preserved...
-0000b7f0: 2020 2020 2020 2020 3a70 6172 616d 206c          :param l
-0000b800: 6f63 616c 5f70 6174 683a 2041 6273 6f6c  ocal_path: Absol
-0000b810: 7574 6520 7061 7468 206f 6e20 6c6f 6361  ute path on loca
-0000b820: 6c20 6472 6976 652e 0a20 2020 2020 2020  l drive..       
-0000b830: 203a 7265 7475 726e 733a 2052 656c 6174   :returns: Relat
-0000b840: 6976 6520 7061 7468 2077 6974 6820 7265  ive path with re
-0000b850: 7370 6563 7420 746f 2044 726f 7062 6f78  spect to Dropbox
-0000b860: 2066 6f6c 6465 722e 0a20 2020 2020 2020   folder..       
-0000b870: 203a 7261 6973 6573 2056 616c 7565 4572   :raises ValueEr
-0000b880: 726f 723a 2057 6865 6e20 7468 6520 7061  ror: When the pa
-0000b890: 7468 206c 6965 7320 6f75 7473 6964 6520  th lies outside 
-0000b8a0: 7468 6520 6c6f 6361 6c20 4472 6f70 626f  the local Dropbo
-0000b8b0: 7820 666f 6c64 6572 2e0a 2020 2020 2020  x folder..      
-0000b8c0: 2020 2222 220a 2020 2020 2020 2020 6966    """.        if
-0000b8d0: 206e 6f74 2069 735f 6571 7561 6c5f 6f72   not is_equal_or
-0000b8e0: 5f63 6869 6c64 286c 6f63 616c 5f70 6174  _child(local_pat
-0000b8f0: 682c 2073 656c 662e 6472 6f70 626f 785f  h, self.dropbox_
-0000b900: 7061 7468 293a 0a20 2020 2020 2020 2020  path):.         
-0000b910: 2020 2072 6169 7365 2056 616c 7565 4572     raise ValueEr
-0000b920: 726f 7228 6627 227b 6c6f 6361 6c5f 7061  ror(f'"{local_pa
-0000b930: 7468 7d22 2069 7320 6e6f 7420 696e 2022  th}" is not in "
-0000b940: 7b73 656c 662e 6472 6f70 626f 785f 7061  {self.dropbox_pa
-0000b950: 7468 7d22 2729 0a20 2020 2020 2020 2072  th}"').        r
-0000b960: 6574 7572 6e20 222f 2220 2b20 7265 6d6f  eturn "/" + remo
-0000b970: 7665 7072 6566 6978 286c 6f63 616c 5f70  veprefix(local_p
-0000b980: 6174 682c 2073 656c 662e 6472 6f70 626f  ath, self.dropbo
-0000b990: 785f 7061 7468 292e 6c73 7472 6970 2822  x_path).lstrip("
-0000b9a0: 2f22 290a 0a20 2020 2064 6566 2074 6f5f  /")..    def to_
-0000b9b0: 6462 785f 7061 7468 5f6c 6f77 6572 2873  dbx_path_lower(s
-0000b9c0: 656c 662c 206c 6f63 616c 5f70 6174 683a  elf, local_path:
-0000b9d0: 2073 7472 2920 2d3e 2073 7472 3a0a 2020   str) -> str:.  
-0000b9e0: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
-0000b9f0: 2020 436f 6e76 6572 7473 2061 206c 6f63    Converts a loc
-0000ba00: 616c 2070 6174 6820 746f 2061 2070 6174  al path to a pat
-0000ba10: 6820 7265 6c61 7469 7665 2074 6f20 7468  h relative to th
-0000ba20: 6520 4472 6f70 626f 7820 666f 6c64 6572  e Dropbox folder
-0000ba30: 2e20 5468 6520 7061 7468 2077 696c 6c20  . The path will 
-0000ba40: 6265 0a20 2020 2020 2020 206e 6f72 6d61  be.        norma
-0000ba50: 6c69 7a65 6420 6173 206f 6e20 4472 6f70  lized as on Drop
-0000ba60: 626f 7820 7365 7276 6572 7320 286c 6f77  box servers (low
-0000ba70: 6572 2063 6173 6520 616e 6420 736f 6d65  er case and some
-0000ba80: 2061 6464 6974 696f 6e61 6c0a 2020 2020   additional.    
-0000ba90: 2020 2020 6e6f 726d 616c 6973 6174 696f      normalisatio
-0000baa0: 6e73 292e 0a0a 2020 2020 2020 2020 3a70  ns)...        :p
-0000bab0: 6172 616d 206c 6f63 616c 5f70 6174 683a  aram local_path:
-0000bac0: 2041 6273 6f6c 7574 6520 7061 7468 206f   Absolute path o
-0000bad0: 6e20 6c6f 6361 6c20 6472 6976 652e 0a20  n local drive.. 
-0000bae0: 2020 2020 2020 203a 7265 7475 726e 733a         :returns:
-0000baf0: 2052 656c 6174 6976 6520 7061 7468 2077   Relative path w
-0000bb00: 6974 6820 7265 7370 6563 7420 746f 2044  ith respect to D
-0000bb10: 726f 7062 6f78 2066 6f6c 6465 722e 0a20  ropbox folder.. 
-0000bb20: 2020 2020 2020 203a 7261 6973 6573 2056         :raises V
-0000bb30: 616c 7565 4572 726f 723a 2057 6865 6e20  alueError: When 
-0000bb40: 7468 6520 7061 7468 206c 6965 7320 6f75  the path lies ou
-0000bb50: 7473 6964 6520 7468 6520 6c6f 6361 6c20  tside the local 
-0000bb60: 4472 6f70 626f 7820 666f 6c64 6572 2e0a  Dropbox folder..
-0000bb70: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
-0000bb80: 2020 2020 7265 7475 726e 206e 6f72 6d61      return norma
-0000bb90: 6c69 7a65 2873 656c 662e 746f 5f64 6278  lize(self.to_dbx
-0000bba0: 5f70 6174 6828 6c6f 6361 6c5f 7061 7468  _path(local_path
-0000bbb0: 2929 0a0a 2020 2020 6465 6620 746f 5f6c  ))..    def to_l
-0000bbc0: 6f63 616c 5f70 6174 685f 6672 6f6d 5f63  ocal_path_from_c
-0000bbd0: 6173 6564 2873 656c 662c 2064 6278 5f70  ased(self, dbx_p
-0000bbe0: 6174 685f 6361 7365 643a 2073 7472 2920  ath_cased: str) 
-0000bbf0: 2d3e 2073 7472 3a0a 2020 2020 2020 2020  -> str:.        
-0000bc00: 2222 220a 2020 2020 2020 2020 436f 6e76  """.        Conv
-0000bc10: 6572 7473 2061 2063 6f72 7265 6374 6c79  erts a correctly
-0000bc20: 2063 6173 6564 2044 726f 7062 6f78 2070   cased Dropbox p
-0000bc30: 6174 6820 746f 2074 6865 2063 6f72 7265  ath to the corre
-0000bc40: 7370 6f6e 6469 6e67 206c 6f63 616c 2070  sponding local p
-0000bc50: 6174 682e 2054 6869 7320 6973 0a20 2020  ath. This is.   
-0000bc60: 2020 2020 206d 6f72 6520 6566 6669 6369       more effici
-0000bc70: 656e 7420 7468 616e 203a 6d65 7468 3a60  ent than :meth:`
-0000bc80: 746f 5f6c 6f63 616c 5f70 6174 6860 2077  to_local_path` w
-0000bc90: 6869 6368 2061 6363 6570 7473 2075 6e63  hich accepts unc
-0000bca0: 6173 6564 2070 6174 6873 2e0a 0a20 2020  ased paths...   
-0000bcb0: 2020 2020 203a 7061 7261 6d20 6462 785f       :param dbx_
-0000bcc0: 7061 7468 5f63 6173 6564 3a20 5061 7468  path_cased: Path
-0000bcd0: 2072 656c 6174 6976 6520 746f 2044 726f   relative to Dro
-0000bce0: 7062 6f78 2066 6f6c 6465 722c 2063 6f72  pbox folder, cor
-0000bcf0: 7265 6374 6c79 2063 6173 6564 2e0a 2020  rectly cased..  
-0000bd00: 2020 2020 2020 3a72 6574 7572 6e73 3a20        :returns: 
-0000bd10: 436f 7272 6573 706f 6e64 696e 6720 6c6f  Corresponding lo
-0000bd20: 6361 6c20 7061 7468 206f 6e20 6472 6976  cal path on driv
-0000bd30: 652e 0a20 2020 2020 2020 2022 2222 0a20  e..        """. 
-0000bd40: 2020 2020 2020 2072 6574 7572 6e20 6622         return f"
-0000bd50: 7b73 656c 662e 6472 6f70 626f 785f 7061  {self.dropbox_pa
-0000bd60: 7468 7d7b 6462 785f 7061 7468 5f63 6173  th}{dbx_path_cas
-0000bd70: 6564 7d22 0a0a 2020 2020 6465 6620 746f  ed}"..    def to
-0000bd80: 5f6c 6f63 616c 5f70 6174 6828 7365 6c66  _local_path(self
-0000bd90: 2c20 6462 785f 7061 7468 3a20 7374 7229  , dbx_path: str)
-0000bda0: 202d 3e20 7374 723a 0a20 2020 2020 2020   -> str:.       
-0000bdb0: 2022 2222 0a20 2020 2020 2020 2043 6f6e   """.        Con
-0000bdc0: 7665 7274 7320 6120 4472 6f70 626f 7820  verts a Dropbox 
-0000bdd0: 7061 7468 2074 6f20 7468 6520 636f 7272  path to the corr
-0000bde0: 6573 706f 6e64 696e 6720 6c6f 6361 6c20  esponding local 
-0000bdf0: 7061 7468 2e20 4f6e 6c79 2074 6865 2062  path. Only the b
-0000be00: 6173 656e 616d 6520 6d75 7374 0a20 2020  asename must.   
-0000be10: 2020 2020 2062 6520 636f 7272 6563 746c       be correctl
-0000be20: 7920 6361 7365 642c 2061 7320 6775 6172  y cased, as guar
-0000be30: 616e 7465 6564 2062 7920 7468 6520 4472  anteed by the Dr
-0000be40: 6f70 626f 7820 4150 4920 666f 7220 7468  opbox API for th
-0000be50: 6520 6060 6469 7370 6c61 795f 7061 7468  e ``display_path
-0000be60: 6060 0a20 2020 2020 2020 2061 7474 7269  ``.        attri
-0000be70: 6275 7465 206f 6620 6669 6c65 206f 7220  bute of file or 
-0000be80: 666f 6c64 6572 206d 6574 6164 6174 612e  folder metadata.
-0000be90: 0a0a 2020 2020 2020 2020 5468 6973 206d  ..        This m
-0000bea0: 6574 686f 6420 736c 6f77 6572 2074 6861  ethod slower tha
-0000beb0: 6e20 3a6d 6574 683a 6074 6f5f 6c6f 6361  n :meth:`to_loca
-0000bec0: 6c5f 7061 7468 5f66 726f 6d5f 6361 7365  l_path_from_case
-0000bed0: 6460 2e0a 0a20 2020 2020 2020 203a 7061  d`...        :pa
-0000bee0: 7261 6d20 6462 785f 7061 7468 3a20 5061  ram dbx_path: Pa
-0000bef0: 7468 2072 656c 6174 6976 6520 746f 2044  th relative to D
-0000bf00: 726f 7062 6f78 2066 6f6c 6465 722c 206d  ropbox folder, m
-0000bf10: 7573 7420 6265 2063 6f72 7265 6374 6c79  ust be correctly
-0000bf20: 2063 6173 6564 2069 6e20 6974 730a 2020   cased in its.  
-0000bf30: 2020 2020 2020 2020 2020 6261 7365 6e61            basena
-0000bf40: 6d65 2e0a 2020 2020 2020 2020 3a72 6574  me..        :ret
-0000bf50: 7572 6e73 3a20 436f 7272 6573 706f 6e64  urns: Correspond
-0000bf60: 696e 6720 6c6f 6361 6c20 7061 7468 206f  ing local path o
-0000bf70: 6e20 6472 6976 652e 0a20 2020 2020 2020  n drive..       
-0000bf80: 2022 2222 0a20 2020 2020 2020 2064 6278   """.        dbx
-0000bf90: 5f70 6174 685f 6361 7365 6420 3d20 7365  _path_cased = se
-0000bfa0: 6c66 2e63 6f72 7265 6374 5f63 6173 6528  lf.correct_case(
-0000bfb0: 6462 785f 7061 7468 290a 2020 2020 2020  dbx_path).      
-0000bfc0: 2020 7265 7475 726e 2066 227b 7365 6c66    return f"{self
-0000bfd0: 2e64 726f 7062 6f78 5f70 6174 687d 7b64  .dropbox_path}{d
-0000bfe0: 6278 5f70 6174 685f 6361 7365 647d 220a  bx_path_cased}".
-0000bff0: 0a20 2020 2064 6566 2069 735f 6578 636c  .    def is_excl
-0000c000: 7564 6564 2873 656c 662c 2070 6174 683a  uded(self, path:
-0000c010: 2073 7472 2920 2d3e 2062 6f6f 6c3a 0a20   str) -> bool:. 
-0000c020: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
-0000c030: 2020 2043 6865 636b 7320 6966 2061 2066     Checks if a f
-0000c040: 696c 6520 6973 2065 7863 6c75 6465 6420  ile is excluded 
-0000c050: 6672 6f6d 2073 796e 632e 2043 6572 7461  from sync. Certa
-0000c060: 696e 2066 696c 6520 6e61 6d65 7320 6172  in file names ar
-0000c070: 6520 616c 7761 7973 2065 7863 6c75 6465  e always exclude
-0000c080: 640a 2020 2020 2020 2020 6672 6f6d 2073  d.        from s
-0000c090: 796e 6369 6e67 2c20 666f 6c6c 6f77 696e  yncing, followin
-0000c0a0: 6720 7468 6520 4472 6f70 626f 7820 7375  g the Dropbox su
-0000c0b0: 7070 6f72 7420 6172 7469 636c 653a 0a0a  pport article:..
-0000c0c0: 2020 2020 2020 2020 6874 7470 733a 2f2f          https://
-0000c0d0: 6865 6c70 2e64 726f 7062 6f78 2e63 6f6d  help.dropbox.com
-0000c0e0: 2f69 6e73 7461 6c6c 732d 696e 7465 6772  /installs-integr
-0000c0f0: 6174 696f 6e73 2f73 796e 632d 7570 6c6f  ations/sync-uplo
-0000c100: 6164 732f 6669 6c65 732d 6e6f 742d 7379  ads/files-not-sy
-0000c110: 6e63 696e 670a 0a20 2020 2020 2020 2054  ncing..        T
-0000c120: 6869 7320 696e 636c 7564 6573 2066 696c  his includes fil
-0000c130: 6520 7379 7374 656d 2066 696c 6573 2073  e system files s
-0000c140: 7563 6820 6173 2027 6465 736b 746f 702e  uch as 'desktop.
-0000c150: 696e 6927 2061 6e64 2027 2e44 535f 5374  ini' and '.DS_St
-0000c160: 6f72 6527 2061 6e64 2073 6f6d 650a 2020  ore' and some.  
-0000c170: 2020 2020 2020 7465 6d70 6f72 6172 7920        temporary 
-0000c180: 6669 6c65 7320 6173 2077 656c 6c20 6173  files as well as
-0000c190: 2063 6163 6865 7320 7573 6564 2062 7920   caches used by 
-0000c1a0: 4472 6f70 626f 7820 6f72 204d 6165 7374  Dropbox or Maest
-0000c1b0: 7261 6c2e 2060 6973 5f65 7863 6c75 6465  ral. `is_exclude
-0000c1c0: 6460 0a20 2020 2020 2020 2061 6363 6570  d`.        accep
-0000c1d0: 7473 2062 6f74 6820 6c6f 6361 6c20 616e  ts both local an
-0000c1e0: 6420 4472 6f70 626f 7820 7061 7468 732e  d Dropbox paths.
-0000c1f0: 0a0a 2020 2020 2020 2020 3a70 6172 616d  ..        :param
-0000c200: 2070 6174 683a 2043 616e 2062 6520 616e   path: Can be an
-0000c210: 2061 6273 6f6c 7574 6520 7061 7468 2c20   absolute path, 
-0000c220: 6120 7061 7468 2072 656c 6174 6976 6520  a path relative 
-0000c230: 746f 2074 6865 2044 726f 7062 6f78 2066  to the Dropbox f
-0000c240: 6f6c 6465 7220 6f72 0a20 2020 2020 2020  older or.       
-0000c250: 2020 2020 206a 7573 7420 6120 6669 6c65       just a file
-0000c260: 206e 616d 652e 2044 6f65 7320 6e6f 7420   name. Does not 
-0000c270: 6e65 6564 2074 6f20 6265 206e 6f72 6d61  need to be norma
-0000c280: 6c69 7a65 642e 0a20 2020 2020 2020 203a  lized..        :
-0000c290: 7265 7475 726e 733a 2057 6865 7468 6572  returns: Whether
-0000c2a0: 2074 6865 2070 6174 6820 6973 2065 7863   the path is exc
-0000c2b0: 6c75 6465 6420 6672 6f6d 2073 796e 6369  luded from synci
-0000c2c0: 6e67 2e0a 2020 2020 2020 2020 2222 220a  ng..        """.
-0000c2d0: 2020 2020 2020 2020 6469 726e 616d 652c          dirname,
-0000c2e0: 2062 6173 656e 616d 6520 3d20 6f73 702e   basename = osp.
-0000c2f0: 7370 6c69 7428 7061 7468 290a 0a20 2020  split(path)..   
-0000c300: 2020 2020 2023 2049 7320 696e 2065 7863       # Is in exc
-0000c310: 6c75 6465 6420 6669 6c65 733f 0a20 2020  luded files?.   
-0000c320: 2020 2020 2069 6620 6261 7365 6e61 6d65       if basename
-0000c330: 2069 6e20 4558 434c 5544 4544 5f46 494c   in EXCLUDED_FIL
-0000c340: 455f 4e41 4d45 533a 0a20 2020 2020 2020  E_NAMES:.       
-0000c350: 2020 2020 2072 6574 7572 6e20 5472 7565       return True
-0000c360: 0a0a 2020 2020 2020 2020 2320 4973 2069  ..        # Is i
-0000c370: 6e20 6578 636c 7564 6564 2064 6972 733f  n excluded dirs?
-0000c380: 0a20 2020 2020 2020 2074 7279 3a0a 2020  .        try:.  
-0000c390: 2020 2020 2020 2020 2020 6462 785f 6469            dbx_di
-0000c3a0: 726e 616d 6520 3d20 7365 6c66 2e74 6f5f  rname = self.to_
-0000c3b0: 6462 785f 7061 7468 2864 6972 6e61 6d65  dbx_path(dirname
-0000c3c0: 290a 2020 2020 2020 2020 6578 6365 7074  ).        except
-0000c3d0: 2056 616c 7565 4572 726f 723a 0a20 2020   ValueError:.   
-0000c3e0: 2020 2020 2020 2020 2023 2050 6174 6820           # Path 
-0000c3f0: 6973 2061 6c72 6561 6479 2072 656c 6174  is already relat
-0000c400: 6976 6520 746f 2044 726f 7062 6f78 2e0a  ive to Dropbox..
-0000c410: 2020 2020 2020 2020 2020 2020 6462 785f              dbx_
-0000c420: 6469 726e 616d 6520 3d20 6469 726e 616d  dirname = dirnam
-0000c430: 650a 0a20 2020 2020 2020 2072 6f6f 745f  e..        root_
-0000c440: 6469 7220 3d20 6e65 7874 2869 7465 7228  dir = next(iter(
-0000c450: 7061 7274 2066 6f72 2070 6172 7420 696e  part for part in
-0000c460: 2064 6278 5f64 6972 6e61 6d65 2e73 706c   dbx_dirname.spl
-0000c470: 6974 2822 2f22 2c20 3229 2069 6620 7061  it("/", 2) if pa
-0000c480: 7274 292c 2022 2229 0a0a 2020 2020 2020  rt), "")..      
-0000c490: 2020 6966 2072 6f6f 745f 6469 7220 696e    if root_dir in
-0000c4a0: 2045 5843 4c55 4445 445f 4449 525f 4e41   EXCLUDED_DIR_NA
-0000c4b0: 4d45 533a 0a20 2020 2020 2020 2020 2020  MES:.           
-0000c4c0: 2072 6574 7572 6e20 5472 7565 0a0a 2020   return True..  
-0000c4d0: 2020 2020 2020 2320 4973 2074 656d 706f        # Is tempo
-0000c4e0: 7261 7279 2066 696c 653f 0a20 2020 2020  rary file?.     
-0000c4f0: 2020 2069 6620 227e 2220 696e 2062 6173     if "~" in bas
-0000c500: 656e 616d 653a 0a20 2020 2020 2020 2020  ename:.         
-0000c510: 2020 2023 2031 2920 4f66 6669 6365 2074     # 1) Office t
-0000c520: 656d 706f 7261 7279 2066 696c 6573 0a20  emporary files. 
-0000c530: 2020 2020 2020 2020 2020 2069 6620 6261             if ba
-0000c540: 7365 6e61 6d65 2e73 7461 7274 7377 6974  sename.startswit
-0000c550: 6828 227e 2422 293a 0a20 2020 2020 2020  h("~$"):.       
-0000c560: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-0000c570: 5472 7565 0a20 2020 2020 2020 2020 2020  True.           
-0000c580: 2069 6620 6261 7365 6e61 6d65 2e73 7461   if basename.sta
-0000c590: 7274 7377 6974 6828 222e 7e22 293a 0a20  rtswith(".~"):. 
-0000c5a0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-0000c5b0: 6574 7572 6e20 5472 7565 0a20 2020 2020  eturn True.     
-0000c5c0: 2020 2020 2020 2023 2032 2920 4f74 6865         # 2) Othe
-0000c5d0: 7220 7465 6d70 6f72 6172 7920 6669 6c65  r temporary file
-0000c5e0: 730a 2020 2020 2020 2020 2020 2020 6966  s.            if
-0000c5f0: 2062 6173 656e 616d 652e 7374 6172 7473   basename.starts
-0000c600: 7769 7468 2822 7e22 2920 616e 6420 6261  with("~") and ba
-0000c610: 7365 6e61 6d65 2e65 6e64 7377 6974 6828  sename.endswith(
-0000c620: 222e 746d 7022 293a 0a20 2020 2020 2020  ".tmp"):.       
-0000c630: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-0000c640: 5472 7565 0a0a 2020 2020 2020 2020 7265  True..        re
-0000c650: 7475 726e 2046 616c 7365 0a0a 2020 2020  turn False..    
-0000c660: 6465 6620 6973 5f65 7863 6c75 6465 645f  def is_excluded_
-0000c670: 6279 5f75 7365 7228 7365 6c66 2c20 6462  by_user(self, db
-0000c680: 785f 7061 7468 5f6c 6f77 6572 3a20 7374  x_path_lower: st
-0000c690: 7229 202d 3e20 626f 6f6c 3a0a 2020 2020  r) -> bool:.    
-0000c6a0: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
-0000c6b0: 4368 6563 6b20 6966 2066 696c 6520 6861  Check if file ha
-0000c6c0: 7320 6265 656e 2065 7863 6c75 6465 6420  s been excluded 
-0000c6d0: 7468 726f 7567 6820 2273 656c 6563 7469  through "selecti
-0000c6e0: 7665 2073 796e 6322 2062 7920 7468 6520  ve sync" by the 
-0000c6f0: 7573 6572 2e0a 0a20 2020 2020 2020 203a  user...        :
-0000c700: 7061 7261 6d20 6462 785f 7061 7468 5f6c  param dbx_path_l
-0000c710: 6f77 6572 3a20 4e6f 726d 616c 6973 6564  ower: Normalised
-0000c720: 206c 6f77 6572 2063 6173 6520 4472 6f70   lower case Drop
-0000c730: 626f 7820 7061 7468 2e0a 2020 2020 2020  box path..      
-0000c740: 2020 3a72 6574 7572 6e73 3a20 5768 6574    :returns: Whet
-0000c750: 6865 7220 7468 6520 7061 7468 2069 7320  her the path is 
-0000c760: 6578 636c 7564 6564 2066 726f 6d20 646f  excluded from do
-0000c770: 776e 6c6f 6164 2073 796e 6369 6e67 2062  wnload syncing b
-0000c780: 7920 7468 6520 7573 6572 2e0a 2020 2020  y the user..    
-0000c790: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
-0000c7a0: 7265 7475 726e 2061 6e79 2869 735f 6571  return any(is_eq
-0000c7b0: 7561 6c5f 6f72 5f63 6869 6c64 2864 6278  ual_or_child(dbx
-0000c7c0: 5f70 6174 685f 6c6f 7765 722c 2070 2920  _path_lower, p) 
-0000c7d0: 666f 7220 7020 696e 2073 656c 662e 6578  for p in self.ex
-0000c7e0: 636c 7564 6564 5f69 7465 6d73 290a 0a20  cluded_items).. 
-0000c7f0: 2020 2064 6566 2069 735f 6d69 676e 6f72     def is_mignor
-0000c800: 6528 7365 6c66 2c20 6576 656e 743a 2053  e(self, event: S
-0000c810: 796e 6345 7665 6e74 2920 2d3e 2062 6f6f  yncEvent) -> boo
-0000c820: 6c3a 0a20 2020 2020 2020 2022 2222 0a20  l:.        """. 
-0000c830: 2020 2020 2020 2043 6865 636b 2069 6620         Check if 
-0000c840: 6c6f 6361 6c20 6669 6c65 2063 6861 6e67  local file chang
-0000c850: 6520 6861 7320 6265 656e 2065 7863 6c75  e has been exclu
-0000c860: 6465 6420 6279 2061 206d 6967 6e6f 7265  ded by a mignore
-0000c870: 2070 6174 7465 726e 2e0a 0a20 2020 2020   pattern...     
-0000c880: 2020 203a 7061 7261 6d20 6576 656e 743a     :param event:
-0000c890: 2053 796e 6345 7665 6e74 2066 6f72 206c   SyncEvent for l
-0000c8a0: 6f63 616c 2066 696c 6520 6576 656e 742e  ocal file event.
-0000c8b0: 0a20 2020 2020 2020 203a 7265 7475 726e  .        :return
-0000c8c0: 733a 2057 6865 7468 6572 2074 6865 2070  s: Whether the p
-0000c8d0: 6174 6820 6973 2065 7863 6c75 6465 6420  ath is excluded 
-0000c8e0: 6672 6f6d 2075 706c 6f61 6420 7379 6e63  from upload sync
-0000c8f0: 696e 6720 6279 2074 6865 2075 7365 722e  ing by the user.
-0000c900: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
-0000c910: 2020 2020 2069 6620 6c65 6e28 7365 6c66       if len(self
-0000c920: 2e6d 6967 6e6f 7265 5f72 756c 6573 2e70  .mignore_rules.p
-0000c930: 6174 7465 726e 7329 203d 3d20 303a 0a20  atterns) == 0:. 
-0000c940: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-0000c950: 6e20 4661 6c73 650a 0a20 2020 2020 2020  n False..       
-0000c960: 2072 6574 7572 6e20 7365 6c66 2e5f 6973   return self._is
-0000c970: 5f6d 6967 6e6f 7265 5f70 6174 6828 0a20  _mignore_path(. 
-0000c980: 2020 2020 2020 2020 2020 2065 7665 6e74             event
-0000c990: 2e64 6278 5f70 6174 682c 2069 735f 6469  .dbx_path, is_di
-0000c9a0: 723d 6576 656e 742e 6973 5f64 6972 6563  r=event.is_direc
-0000c9b0: 746f 7279 0a20 2020 2020 2020 2029 2061  tory.        ) a
-0000c9c0: 6e64 206e 6f74 2073 656c 662e 6765 745f  nd not self.get_
-0000c9d0: 6c6f 6361 6c5f 7265 7628 6576 656e 742e  local_rev(event.
-0000c9e0: 6462 785f 7061 7468 5f6c 6f77 6572 290a  dbx_path_lower).
-0000c9f0: 0a20 2020 2064 6566 205f 6973 5f6d 6967  .    def _is_mig
-0000ca00: 6e6f 7265 5f70 6174 6828 7365 6c66 2c20  nore_path(self, 
-0000ca10: 6462 785f 7061 7468 3a20 7374 722c 2069  dbx_path: str, i
-0000ca20: 735f 6469 723a 2062 6f6f 6c20 3d20 4661  s_dir: bool = Fa
-0000ca30: 6c73 6529 202d 3e20 626f 6f6c 3a0a 2020  lse) -> bool:.  
-0000ca40: 2020 2020 2020 7265 6c61 7469 7665 5f70        relative_p
-0000ca50: 6174 6820 3d20 6462 785f 7061 7468 2e6c  ath = dbx_path.l
-0000ca60: 7374 7269 7028 222f 2229 0a0a 2020 2020  strip("/")..    
-0000ca70: 2020 2020 6966 2069 735f 6469 723a 0a20      if is_dir:. 
-0000ca80: 2020 2020 2020 2020 2020 2072 656c 6174             relat
-0000ca90: 6976 655f 7061 7468 203d 2066 227b 7265  ive_path = f"{re
-0000caa0: 6c61 7469 7665 5f70 6174 687d 2f22 0a20  lative_path}/". 
-0000cab0: 2020 2020 2020 2072 6574 7572 6e20 7365         return se
-0000cac0: 6c66 2e6d 6967 6e6f 7265 5f72 756c 6573  lf.mignore_rules
-0000cad0: 2e6d 6174 6368 5f66 696c 6528 7265 6c61  .match_file(rela
-0000cae0: 7469 7665 5f70 6174 6829 0a0a 2020 2020  tive_path)..    
-0000caf0: 6465 6620 5f73 6c6f 775f 646f 776e 2873  def _slow_down(s
-0000cb00: 656c 6629 202d 3e20 4e6f 6e65 3a0a 2020  elf) -> None:.  
-0000cb10: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
-0000cb20: 2020 5061 7573 6573 2069 6620 4350 5520    Pauses if CPU 
-0000cb30: 7573 6167 6520 6973 2074 6f6f 2068 6967  usage is too hig
-0000cb40: 6820 6966 2063 616c 6c65 6420 6672 6f6d  h if called from
-0000cb50: 206f 6e65 206f 6620 6f75 7220 7468 7265   one of our thre
-0000cb60: 6164 2070 6f6f 6c73 2e0a 2020 2020 2020  ad pools..      
-0000cb70: 2020 2222 220a 2020 2020 2020 2020 6966    """.        if
-0000cb80: 2073 656c 662e 5f6d 6178 5f63 7075 5f70   self._max_cpu_p
-0000cb90: 6572 6365 6e74 203d 3d20 3130 3020 2a20  ercent == 100 * 
-0000cba0: 4350 555f 434f 5245 5f43 4f55 4e54 3a0a  CPU_CORE_COUNT:.
-0000cbb0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-0000cbc0: 726e 0a0a 2020 2020 2020 2020 6370 755f  rn..        cpu_
-0000cbd0: 7573 6167 6520 3d20 6370 755f 7573 6167  usage = cpu_usag
-0000cbe0: 655f 7065 7263 656e 7428 290a 0a20 2020  e_percent()..   
-0000cbf0: 2020 2020 2069 6620 6370 755f 7573 6167       if cpu_usag
-0000cc00: 6520 3e20 7365 6c66 2e5f 6d61 785f 6370  e > self._max_cp
-0000cc10: 755f 7065 7263 656e 743a 0a20 2020 2020  u_percent:.     
-0000cc20: 2020 2020 2020 2074 6872 6561 645f 6e61         thread_na
-0000cc30: 6d65 203d 2063 7572 7265 6e74 5f74 6872  me = current_thr
-0000cc40: 6561 6428 292e 6e61 6d65 0a20 2020 2020  ead().name.     
-0000cc50: 2020 2020 2020 2073 656c 662e 5f6c 6f67         self._log
-0000cc60: 6765 722e 6465 6275 6728 6622 7b74 6872  ger.debug(f"{thr
-0000cc70: 6561 645f 6e61 6d65 7d3a 207b 6370 755f  ead_name}: {cpu_
-0000cc80: 7573 6167 657d 2520 4350 5520 7573 6167  usage}% CPU usag
-0000cc90: 6520 2d20 7468 726f 7474 6c69 6e67 2229  e - throttling")
-0000cca0: 0a0a 2020 2020 2020 2020 2020 2020 7768  ..            wh
-0000ccb0: 696c 6520 6370 755f 7573 6167 6520 3e20  ile cpu_usage > 
-0000ccc0: 7365 6c66 2e5f 6d61 785f 6370 755f 7065  self._max_cpu_pe
-0000ccd0: 7263 656e 743a 0a20 2020 2020 2020 2020  rcent:.         
-0000cce0: 2020 2020 2020 2063 7075 5f75 7361 6765         cpu_usage
-0000ccf0: 203d 2063 7075 5f75 7361 6765 5f70 6572   = cpu_usage_per
-0000cd00: 6365 6e74 2830 2e35 202b 2032 202a 2072  cent(0.5 + 2 * r
-0000cd10: 616e 646f 6d2e 7261 6e64 6f6d 2829 290a  andom.random()).
-0000cd20: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-0000cd30: 662e 5f6c 6f67 6765 722e 6465 6275 6728  f._logger.debug(
-0000cd40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000cd50: 2066 227b 7468 7265 6164 5f6e 616d 657d   f"{thread_name}
-0000cd60: 3a20 7b63 7075 5f75 7361 6765 7d25 2043  : {cpu_usage}% C
-0000cd70: 5055 2075 7361 6765 202d 2065 6e64 2074  PU usage - end t
-0000cd80: 6872 6f74 746c 696e 6722 0a20 2020 2020  hrottling".     
-0000cd90: 2020 2020 2020 2029 0a0a 2020 2020 6465         )..    de
-0000cda0: 6620 6361 6e63 656c 5f73 796e 6328 7365  f cancel_sync(se
-0000cdb0: 6c66 2920 2d3e 204e 6f6e 653a 0a20 2020  lf) -> None:.   
-0000cdc0: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
-0000cdd0: 2052 6169 7365 7320 6120 3a65 7863 3a60   Raises a :exc:`
-0000cde0: 6d61 6573 7472 616c 2e65 7863 6570 7469  maestral.excepti
-0000cdf0: 6f6e 732e 4361 6e63 656c 6c65 6445 7272  ons.CancelledErr
-0000ce00: 6f72 6020 696e 2061 6c6c 2073 796e 6320  or` in all sync 
-0000ce10: 7468 7265 6164 7320 616e 6420 7761 6974  threads and wait
-0000ce20: 730a 2020 2020 2020 2020 666f 7220 7468  s.        for th
-0000ce30: 656d 2074 6f20 7368 7574 2064 6f77 6e2e  em to shut down.
-0000ce40: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
-0000ce50: 2020 2020 2073 656c 662e 5f63 616e 6365       self._cance
-0000ce60: 6c5f 7265 7175 6573 7465 642e 7365 7428  l_requested.set(
-0000ce70: 290a 0a20 2020 2020 2020 2023 2057 6169  )..        # Wai
-0000ce80: 7420 756e 7469 6c20 7765 2063 616e 2061  t until we can a
-0000ce90: 6371 7569 7265 2074 6865 2073 796e 6320  cquire the sync 
-0000cea0: 6c6f 636b 203d 3e20 7765 2061 7265 2069  lock => we are i
-0000ceb0: 646c 652e 0a20 2020 2020 2020 2073 656c  dle..        sel
-0000cec0: 662e 7379 6e63 5f6c 6f63 6b2e 6163 7175  f.sync_lock.acqu
-0000ced0: 6972 6528 290a 2020 2020 2020 2020 7365  ire().        se
-0000cee0: 6c66 2e73 796e 635f 6c6f 636b 2e72 656c  lf.sync_lock.rel
-0000cef0: 6561 7365 2829 0a0a 2020 2020 2020 2020  ease()..        
-0000cf00: 7365 6c66 2e5f 6361 6e63 656c 5f72 6571  self._cancel_req
-0000cf10: 7565 7374 6564 2e63 6c65 6172 2829 0a0a  uested.clear()..
-0000cf20: 2020 2020 2020 2020 7365 6c66 2e5f 6c6f          self._lo
-0000cf30: 6767 6572 2e69 6e66 6f28 2253 796e 6320  gger.info("Sync 
-0000cf40: 6162 6f72 7465 6422 290a 0a20 2020 2064  aborted")..    d
-0000cf50: 6566 2062 7573 7928 7365 6c66 2920 2d3e  ef busy(self) ->
-0000cf60: 2062 6f6f 6c3a 0a20 2020 2020 2020 2022   bool:.        "
-0000cf70: 2222 0a20 2020 2020 2020 2043 6865 636b  "".        Check
-0000cf80: 7320 6966 2077 6520 6172 6520 6375 7272  s if we are curr
-0000cf90: 656e 746c 7920 7379 6e63 696e 672e 0a0a  ently syncing...
-0000cfa0: 2020 2020 2020 2020 3a72 6574 7572 6e73          :returns
-0000cfb0: 3a20 6060 5472 7565 6060 2069 6620 3a61  : ``True`` if :a
-0000cfc0: 7474 723a 6073 796e 635f 6c6f 636b 6020  ttr:`sync_lock` 
-0000cfd0: 6361 6e6e 6f74 2062 6520 6163 7175 6972  cannot be acquir
-0000cfe0: 6564 2c20 6060 4661 6c73 6560 6020 6f74  ed, ``False`` ot
-0000cff0: 6865 7277 6973 652e 0a20 2020 2020 2020  herwise..       
-0000d000: 2022 2222 0a20 2020 2020 2020 2069 646c   """.        idl
-0000d010: 6520 3d20 7365 6c66 2e73 796e 635f 6c6f  e = self.sync_lo
-0000d020: 636b 2e61 6371 7569 7265 2862 6c6f 636b  ck.acquire(block
-0000d030: 696e 673d 4661 6c73 6529 0a20 2020 2020  ing=False).     
-0000d040: 2020 2069 6620 6964 6c65 3a0a 2020 2020     if idle:.    
-0000d050: 2020 2020 2020 2020 7365 6c66 2e73 796e          self.syn
-0000d060: 635f 6c6f 636b 2e72 656c 6561 7365 2829  c_lock.release()
-0000d070: 0a0a 2020 2020 2020 2020 7265 7475 726e  ..        return
-0000d080: 206e 6f74 2069 646c 650a 0a20 2020 2064   not idle..    d
-0000d090: 6566 205f 6861 6e64 6c65 5f73 796e 635f  ef _handle_sync_
-0000d0a0: 6572 726f 7228 7365 6c66 2c20 6572 723a  error(self, err:
-0000d0b0: 2053 796e 6345 7272 6f72 2c20 6469 7265   SyncError, dire
-0000d0c0: 6374 696f 6e3a 2053 796e 6344 6972 6563  ction: SyncDirec
-0000d0d0: 7469 6f6e 2920 2d3e 204e 6f6e 653a 0a20  tion) -> None:. 
-0000d0e0: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
-0000d0f0: 2020 2048 616e 646c 6573 2061 2073 796e     Handles a syn
-0000d100: 6320 6572 726f 722e 2046 696c 6c73 206f  c error. Fills o
-0000d110: 7574 2061 6e79 206d 6973 7369 6e67 2070  ut any missing p
-0000d120: 6174 6820 696e 666f 726d 6174 696f 6e20  ath information 
-0000d130: 616e 6420 6164 6473 2074 6865 2065 7272  and adds the err
-0000d140: 6f72 0a20 2020 2020 2020 2074 6f20 7468  or.        to th
-0000d150: 6520 7065 7273 6973 7465 6e74 2073 7461  e persistent sta
-0000d160: 7465 2066 6f72 206c 6174 6572 2072 6573  te for later res
-0000d170: 796e 632e 0a0a 2020 2020 2020 2020 3a70  ync...        :p
-0000d180: 6172 616d 2065 7272 3a20 5468 6520 7379  aram err: The sy
-0000d190: 6e63 2065 7272 6f72 2074 6f20 6861 6e64  nc error to hand
-0000d1a0: 6c65 2e0a 2020 2020 2020 2020 3a70 6172  le..        :par
-0000d1b0: 616d 2064 6972 6563 7469 6f6e 3a20 5468  am direction: Th
-0000d1c0: 6520 7379 6e63 2064 6972 6563 7469 6f6e  e sync direction
-0000d1d0: 2028 7570 206f 7220 646f 776e 2920 666f   (up or down) fo
-0000d1e0: 7220 7768 6963 6820 7468 6520 6572 726f  r which the erro
-0000d1f0: 7220 6f63 6375 7272 6564 2e0a 2020 2020  r occurred..    
-0000d200: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
-0000d210: 2320 4669 6c6c 2069 6e20 6d69 7373 696e  # Fill in missin
-0000d220: 6720 6462 785f 7061 7468 206f 7220 6c6f  g dbx_path or lo
-0000d230: 6361 6c5f 7061 7468 2e0a 2020 2020 2020  cal_path..      
-0000d240: 2020 6966 2065 7272 2e64 6278 5f70 6174    if err.dbx_pat
-0000d250: 6820 616e 6420 6e6f 7420 6572 722e 6c6f  h and not err.lo
-0000d260: 6361 6c5f 7061 7468 3a0a 2020 2020 2020  cal_path:.      
-0000d270: 2020 2020 2020 6572 722e 6c6f 6361 6c5f        err.local_
-0000d280: 7061 7468 203d 2073 656c 662e 746f 5f6c  path = self.to_l
-0000d290: 6f63 616c 5f70 6174 685f 6672 6f6d 5f63  ocal_path_from_c
-0000d2a0: 6173 6564 2865 7272 2e64 6278 5f70 6174  ased(err.dbx_pat
-0000d2b0: 6829 0a20 2020 2020 2020 2069 6620 6572  h).        if er
-0000d2c0: 722e 6c6f 6361 6c5f 7061 7468 2061 6e64  r.local_path and
-0000d2d0: 206e 6f74 2065 7272 2e64 6278 5f70 6174   not err.dbx_pat
-0000d2e0: 683a 0a20 2020 2020 2020 2020 2020 2065  h:.            e
-0000d2f0: 7272 2e64 6278 5f70 6174 6820 3d20 7365  rr.dbx_path = se
-0000d300: 6c66 2e74 6f5f 6462 785f 7061 7468 2865  lf.to_dbx_path(e
-0000d310: 7272 2e6c 6f63 616c 5f70 6174 6829 0a0a  rr.local_path)..
-0000d320: 2020 2020 2020 2020 2320 4669 6c6c 2069          # Fill i
-0000d330: 6e20 6d69 7373 696e 6720 6462 785f 7061  n missing dbx_pa
-0000d340: 7468 5f66 726f 6d20 6f72 206c 6f63 616c  th_from or local
-0000d350: 5f70 6174 685f 6672 6f6d 2e0a 2020 2020  _path_from..    
-0000d360: 2020 2020 6966 2065 7272 2e64 6278 5f70      if err.dbx_p
-0000d370: 6174 685f 6672 6f6d 2061 6e64 206e 6f74  ath_from and not
-0000d380: 2065 7272 2e6c 6f63 616c 5f70 6174 685f   err.local_path_
-0000d390: 6672 6f6d 3a0a 2020 2020 2020 2020 2020  from:.          
-0000d3a0: 2020 6572 722e 6c6f 6361 6c5f 7061 7468    err.local_path
-0000d3b0: 5f66 726f 6d20 3d20 7365 6c66 2e74 6f5f  _from = self.to_
-0000d3c0: 6c6f 6361 6c5f 7061 7468 5f66 726f 6d5f  local_path_from_
-0000d3d0: 6361 7365 6428 6572 722e 6462 785f 7061  cased(err.dbx_pa
-0000d3e0: 7468 5f66 726f 6d29 0a20 2020 2020 2020  th_from).       
-0000d3f0: 2069 6620 6572 722e 6c6f 6361 6c5f 7061   if err.local_pa
-0000d400: 7468 5f66 726f 6d20 616e 6420 6e6f 7420  th_from and not 
-0000d410: 6572 722e 6462 785f 7061 7468 5f66 726f  err.dbx_path_fro
-0000d420: 6d3a 0a20 2020 2020 2020 2020 2020 2065  m:.            e
-0000d430: 7272 2e64 6278 5f70 6174 685f 6672 6f6d  rr.dbx_path_from
-0000d440: 203d 2073 656c 662e 746f 5f64 6278 5f70   = self.to_dbx_p
-0000d450: 6174 6828 6572 722e 6c6f 6361 6c5f 7061  ath(err.local_pa
-0000d460: 7468 5f66 726f 6d29 0a0a 2020 2020 2020  th_from)..      
-0000d470: 2020 6966 206e 6f74 2065 7272 2e64 6278    if not err.dbx
-0000d480: 5f70 6174 683a 0a20 2020 2020 2020 2020  _path:.         
-0000d490: 2020 2072 6169 7365 2056 616c 7565 4572     raise ValueEr
-0000d4a0: 726f 7228 2253 796e 6320 6572 726f 7220  ror("Sync error 
-0000d4b0: 6861 7320 616e 2075 6e6b 6e6f 776e 2070  has an unknown p
-0000d4c0: 6174 6822 290a 0a20 2020 2020 2020 2070  ath")..        p
-0000d4d0: 7269 6e74 6162 6c65 5f66 696c 655f 6e61  rintable_file_na
-0000d4e0: 6d65 203d 2073 616e 6974 697a 655f 7374  me = sanitize_st
-0000d4f0: 7269 6e67 286f 7370 2e62 6173 656e 616d  ring(osp.basenam
-0000d500: 6528 6572 722e 6462 785f 7061 7468 2929  e(err.dbx_path))
-0000d510: 0a0a 2020 2020 2020 2020 7365 6c66 2e5f  ..        self._
-0000d520: 6c6f 6767 6572 2e69 6e66 6f28 2243 6f75  logger.info("Cou
-0000d530: 6c64 206e 6f74 2073 796e 6320 2573 222c  ld not sync %s",
-0000d540: 2070 7269 6e74 6162 6c65 5f66 696c 655f   printable_file_
-0000d550: 6e61 6d65 2c20 6578 635f 696e 666f 3d54  name, exc_info=T
-0000d560: 7275 6529 0a0a 2020 2020 2020 2020 6465  rue)..        de
-0000d570: 6620 6361 6c6c 6261 636b 2829 202d 3e20  f callback() -> 
-0000d580: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
-0000d590: 2020 6966 2065 7272 2e6c 6f63 616c 5f70    if err.local_p
-0000d5a0: 6174 683a 0a20 2020 2020 2020 2020 2020  ath:.           
-0000d5b0: 2020 2020 2063 6c69 636b 2e6c 6175 6e63       click.launc
-0000d5c0: 6828 6572 722e 6c6f 6361 6c5f 7061 7468  h(err.local_path
-0000d5d0: 2c20 6c6f 6361 7465 3d54 7275 6529 0a20  , locate=True). 
-0000d5e0: 2020 2020 2020 2020 2020 2065 6c69 6620             elif 
-0000d5f0: 6572 722e 6462 785f 7061 7468 3a0a 2020  err.dbx_path:.  
-0000d600: 2020 2020 2020 2020 2020 2020 2020 7572                ur
-0000d610: 6c5f 7061 7468 203d 2075 726c 6c69 622e  l_path = urllib.
-0000d620: 7061 7273 652e 7175 6f74 6528 6572 722e  parse.quote(err.
-0000d630: 6462 785f 7061 7468 290a 2020 2020 2020  dbx_path).      
-0000d640: 2020 2020 2020 2020 2020 636c 6963 6b2e            click.
-0000d650: 6c61 756e 6368 2866 2268 7474 7073 3a2f  launch(f"https:/
-0000d660: 2f77 7777 2e64 726f 7062 6f78 2e63 6f6d  /www.dropbox.com
-0000d670: 2f70 7265 7669 6577 7b75 726c 5f70 6174  /preview{url_pat
-0000d680: 687d 2229 0a0a 2020 2020 2020 2020 6966  h}")..        if
-0000d690: 2073 656c 662e 6465 736b 746f 705f 6e6f   self.desktop_no
-0000d6a0: 7469 6669 6572 3a0a 2020 2020 2020 2020  tifier:.        
-0000d6b0: 2020 2020 7365 6c66 2e64 6573 6b74 6f70      self.desktop
-0000d6c0: 5f6e 6f74 6966 6965 722e 6e6f 7469 6679  _notifier.notify
-0000d6d0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-0000d6e0: 2020 2253 796e 6320 6572 726f 7222 2c0a    "Sync error",.
-0000d6f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d700: 6622 436f 756c 6420 6e6f 7420 7b64 6972  f"Could not {dir
-0000d710: 6563 7469 6f6e 2e76 616c 7565 7d6c 6f61  ection.value}loa
-0000d720: 6420 7b70 7269 6e74 6162 6c65 5f66 696c  d {printable_fil
-0000d730: 655f 6e61 6d65 7d22 2c0a 2020 2020 2020  e_name}",.      
-0000d740: 2020 2020 2020 2020 2020 6c65 7665 6c3d            level=
-0000d750: 6e6f 7469 6679 2e53 594e 4349 5353 5545  notify.SYNCISSUE
-0000d760: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0000d770: 2020 6163 7469 6f6e 733d 7b22 5368 6f77    actions={"Show
-0000d780: 223a 2063 616c 6c62 6163 6b7d 2c0a 2020  ": callback},.  
-0000d790: 2020 2020 2020 2020 2020 2020 2020 6f6e                on
-0000d7a0: 5f63 6c69 636b 3d63 616c 6c62 6163 6b2c  _click=callback,
-0000d7b0: 0a20 2020 2020 2020 2020 2020 2029 0a0a  .            )..
-0000d7c0: 2020 2020 2020 2020 2320 5361 7665 2073          # Save s
-0000d7d0: 796e 6320 6572 726f 7273 2074 6f20 7265  ync errors to re
-0000d7e0: 7472 7920 6c61 7465 722e 0a0a 2020 2020  try later...    
-0000d7f0: 2020 2020 6462 785f 7061 7468 5f6c 6f77      dbx_path_low
-0000d800: 6572 203d 206e 6f72 6d61 6c69 7a65 2865  er = normalize(e
-0000d810: 7272 2e64 6278 5f70 6174 6829 0a20 2020  rr.dbx_path).   
-0000d820: 2020 2020 2069 6620 6572 722e 6462 785f       if err.dbx_
-0000d830: 7061 7468 5f66 726f 6d3a 0a20 2020 2020  path_from:.     
-0000d840: 2020 2020 2020 2064 6278 5f70 6174 685f         dbx_path_
-0000d850: 6672 6f6d 5f6c 6f77 6572 203d 206e 6f72  from_lower = nor
-0000d860: 6d61 6c69 7a65 2865 7272 2e64 6278 5f70  malize(err.dbx_p
-0000d870: 6174 685f 6672 6f6d 290a 2020 2020 2020  ath_from).      
-0000d880: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-0000d890: 2020 2020 6462 785f 7061 7468 5f66 726f      dbx_path_fro
-0000d8a0: 6d5f 6c6f 7765 7220 3d20 4e6f 6e65 0a0a  m_lower = None..
-0000d8b0: 2020 2020 2020 2020 7769 7468 2073 656c          with sel
-0000d8c0: 662e 5f64 6174 6162 6173 655f 6163 6365  f._database_acce
-0000d8d0: 7373 2829 3a0a 2020 2020 2020 2020 2020  ss():.          
-0000d8e0: 2020 7365 6c66 2e5f 7379 6e63 5f65 7272    self._sync_err
-0000d8f0: 6f72 735f 7461 626c 652e 7570 6461 7465  ors_table.update
-0000d900: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-0000d910: 2020 5379 6e63 4572 726f 7245 6e74 7279    SyncErrorEntry
-0000d920: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-0000d930: 2020 2020 2020 6462 785f 7061 7468 3d65        dbx_path=e
-0000d940: 7272 2e64 6278 5f70 6174 682c 0a20 2020  rr.dbx_path,.   
-0000d950: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d960: 2064 6278 5f70 6174 685f 6c6f 7765 723d   dbx_path_lower=
-0000d970: 6462 785f 7061 7468 5f6c 6f77 6572 2c0a  dbx_path_lower,.
-0000d980: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d990: 2020 2020 6462 785f 7061 7468 5f66 726f      dbx_path_fro
-0000d9a0: 6d3d 6572 722e 6462 785f 7061 7468 5f66  m=err.dbx_path_f
-0000d9b0: 726f 6d2c 0a20 2020 2020 2020 2020 2020  rom,.           
-0000d9c0: 2020 2020 2020 2020 2064 6278 5f70 6174           dbx_pat
-0000d9d0: 685f 6672 6f6d 5f6c 6f77 6572 3d64 6278  h_from_lower=dbx
-0000d9e0: 5f70 6174 685f 6672 6f6d 5f6c 6f77 6572  _path_from_lower
-0000d9f0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0000da00: 2020 2020 2020 6c6f 6361 6c5f 7061 7468        local_path
-0000da10: 3d65 7272 2e6c 6f63 616c 5f70 6174 682c  =err.local_path,
-0000da20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000da30: 2020 2020 206c 6f63 616c 5f70 6174 685f       local_path_
-0000da40: 6672 6f6d 3d65 7272 2e6c 6f63 616c 5f70  from=err.local_p
-0000da50: 6174 685f 6672 6f6d 2c0a 2020 2020 2020  ath_from,.      
-0000da60: 2020 2020 2020 2020 2020 2020 2020 6469                di
-0000da70: 7265 6374 696f 6e3d 6469 7265 6374 696f  rection=directio
-0000da80: 6e2c 0a20 2020 2020 2020 2020 2020 2020  n,.             
-0000da90: 2020 2020 2020 2074 6974 6c65 3d65 7272         title=err
-0000daa0: 2e74 6974 6c65 2c0a 2020 2020 2020 2020  .title,.        
-0000dab0: 2020 2020 2020 2020 2020 2020 6d65 7373              mess
-0000dac0: 6167 653d 6572 722e 6d65 7373 6167 652c  age=err.message,
-0000dad0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000dae0: 2020 2020 2074 7970 653d 6572 722e 5f5f       type=err.__
-0000daf0: 636c 6173 735f 5f2e 5f5f 6e61 6d65 5f5f  class__.__name__
-0000db00: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0000db10: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
-0000db20: 290a 0a20 2020 2040 636f 6e74 6578 746d  )..    @contextm
-0000db30: 616e 6167 6572 0a20 2020 2064 6566 205f  anager.    def _
-0000db40: 6461 7461 6261 7365 5f61 6363 6573 7328  database_access(
-0000db50: 7365 6c66 2c20 7261 6973 655f 6572 726f  self, raise_erro
-0000db60: 723a 2062 6f6f 6c20 3d20 5472 7565 2920  r: bool = True) 
-0000db70: 2d3e 2049 7465 7261 746f 725b 4e6f 6e65  -> Iterator[None
-0000db80: 5d3a 0a20 2020 2020 2020 2022 2222 0a20  ]:.        """. 
-0000db90: 2020 2020 2020 2041 2063 6f6e 7465 7874         A context
-0000dba0: 206d 616e 6167 6572 2074 6f20 7379 6e63   manager to sync
-0000dbb0: 6872 6f6e 6973 6573 2061 6363 6573 7320  hronises access 
-0000dbc0: 746f 2074 6865 2053 514c 6974 6520 6461  to the SQLite da
-0000dbd0: 7461 6261 7365 2e20 4361 7463 6865 730a  tabase. Catches.
-0000dbe0: 2020 2020 2020 2020 6578 6365 7074 696f          exceptio
-0000dbf0: 6e73 2072 6169 7365 6420 6279 2073 716c  ns raised by sql
-0000dc00: 6974 6533 2061 6e64 2063 6f6e 7665 7274  ite3 and convert
-0000dc10: 7320 7468 656d 2074 6f20 6120 4d61 6573  s them to a Maes
-0000dc20: 7472 616c 4170 6945 7272 6f72 2069 6620  tralApiError if 
-0000dc30: 7765 206b 6e6f 770a 2020 2020 2020 2020  we know.        
-0000dc40: 686f 7720 746f 2068 616e 646c 6520 7468  how to handle th
-0000dc50: 656d 2e0a 0a20 2020 2020 2020 203a 7061  em...        :pa
-0000dc60: 7261 6d20 7261 6973 655f 6572 726f 723a  ram raise_error:
-0000dc70: 2057 6865 7468 6572 2065 7272 6f72 7320   Whether errors 
-0000dc80: 7368 6f75 6c64 2062 6520 7261 6973 6564  should be raised
-0000dc90: 206f 7220 6c6f 6767 6564 2e0a 2020 2020   or logged..    
-0000dca0: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
-0000dcb0: 7469 746c 6520 3d20 2222 0a20 2020 2020  title = "".     
-0000dcc0: 2020 206d 7367 203d 2022 220a 2020 2020     msg = "".    
-0000dcd0: 2020 2020 6e65 775f 6578 6320 3d20 4e6f      new_exc = No
-0000dce0: 6e65 0a0a 2020 2020 2020 2020 7472 793a  ne..        try:
-0000dcf0: 0a20 2020 2020 2020 2020 2020 2077 6974  .            wit
-0000dd00: 6820 7365 6c66 2e5f 6462 5f6c 6f63 6b3a  h self._db_lock:
-0000dd10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000dd20: 2079 6965 6c64 0a20 2020 2020 2020 2065   yield.        e
-0000dd30: 7863 6570 7420 7371 6c69 7465 332e 4f70  xcept sqlite3.Op
-0000dd40: 6572 6174 696f 6e61 6c45 7272 6f72 2061  erationalError a
-0000dd50: 7320 6578 633a 0a20 2020 2020 2020 2020  s exc:.         
-0000dd60: 2020 2074 6974 6c65 203d 2022 4461 7461     title = "Data
-0000dd70: 6261 7365 2074 7261 6e73 6163 7469 6f6e  base transaction
-0000dd80: 2065 7272 6f72 220a 2020 2020 2020 2020   error".        
-0000dd90: 2020 2020 6d73 6720 3d20 280a 2020 2020      msg = (.    
-0000dda0: 2020 2020 2020 2020 2020 2020 6627 5468              f'Th
-0000ddb0: 6520 696e 6465 7820 6669 6c65 2061 7420  e index file at 
-0000ddc0: 227b 7365 6c66 2e5f 6462 5f70 6174 687d  "{self._db_path}
-0000ddd0: 2220 6361 6e6e 6f74 2062 6520 7265 6164  " cannot be read
-0000dde0: 2e20 270a 2020 2020 2020 2020 2020 2020  . '.            
-0000ddf0: 2020 2020 2250 6c65 6173 6520 6368 6563      "Please chec
-0000de00: 6b20 7468 6174 2079 6f75 2068 6176 6520  k that you have 
-0000de10: 7375 6666 6963 6965 6e74 2070 6572 6d69  sufficient permi
-0000de20: 7373 696f 6e73 2061 6e64 2022 0a20 2020  ssions and ".   
-0000de30: 2020 2020 2020 2020 2020 2020 2022 7265               "re
-0000de40: 6275 696c 6420 7468 6520 696e 6465 7820  build the index 
-0000de50: 6966 206e 6563 6573 7361 7279 2e22 0a20  if necessary.". 
-0000de60: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
-0000de70: 2020 2020 2020 2020 206e 6577 5f65 7863           new_exc
-0000de80: 203d 2044 6174 6162 6173 6545 7272 6f72   = DatabaseError
-0000de90: 2874 6974 6c65 2c20 6d73 6729 2e77 6974  (title, msg).wit
-0000dea0: 685f 7472 6163 6562 6163 6b28 6578 632e  h_traceback(exc.
-0000deb0: 5f5f 7472 6163 6562 6163 6b5f 5f29 0a20  __traceback__). 
-0000dec0: 2020 2020 2020 2065 7863 6570 7420 7371         except sq
-0000ded0: 6c69 7465 332e 496e 7465 6772 6974 7945  lite3.IntegrityE
-0000dee0: 7272 6f72 2061 7320 6578 633a 0a20 2020  rror as exc:.   
-0000def0: 2020 2020 2020 2020 2074 6974 6c65 203d           title =
-0000df00: 2022 4461 7461 6261 7365 2069 6e74 6567   "Database integ
-0000df10: 7269 7479 2065 7272 6f72 220a 2020 2020  rity error".    
-0000df20: 2020 2020 2020 2020 6d73 6720 3d20 2250          msg = "P
-0000df30: 6c65 6173 6520 7265 6275 696c 6420 7468  lease rebuild th
-0000df40: 6520 696e 6465 7820 746f 2063 6f6e 7469  e index to conti
-0000df50: 6e75 6520 7379 6e63 696e 672e 220a 2020  nue syncing.".  
-0000df60: 2020 2020 2020 2020 2020 6e65 775f 6578            new_ex
-0000df70: 6320 3d20 4461 7461 6261 7365 4572 726f  c = DatabaseErro
-0000df80: 7228 7469 746c 652c 206d 7367 292e 7769  r(title, msg).wi
-0000df90: 7468 5f74 7261 6365 6261 636b 2865 7863  th_traceback(exc
-0000dfa0: 2e5f 5f74 7261 6365 6261 636b 5f5f 290a  .__traceback__).
-0000dfb0: 2020 2020 2020 2020 6578 6365 7074 2073          except s
-0000dfc0: 716c 6974 6533 2e44 6174 6162 6173 6545  qlite3.DatabaseE
-0000dfd0: 7272 6f72 2061 7320 6578 633a 0a20 2020  rror as exc:.   
-0000dfe0: 2020 2020 2020 2020 2074 6974 6c65 203d           title =
-0000dff0: 2022 4461 7461 6261 7365 2074 7261 6e73   "Database trans
-0000e000: 6163 7469 6f6e 2065 7272 6f72 220a 2020  action error".  
-0000e010: 2020 2020 2020 2020 2020 6d73 6720 3d20            msg = 
-0000e020: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-0000e030: 2020 2250 6c65 6173 6520 7265 7374 6172    "Please restar
-0000e040: 7420 4d61 6573 7472 616c 2074 6f20 636f  t Maestral to co
-0000e050: 6e74 696e 7565 2073 796e 6369 6e67 2e20  ntinue syncing. 
-0000e060: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
-0000e070: 2020 2252 6562 7569 6c64 2074 6865 2069    "Rebuild the i
-0000e080: 6e64 6578 2069 6620 7468 6973 2069 7373  ndex if this iss
-0000e090: 7565 2070 6572 7369 7374 732e 220a 2020  ue persists.".  
-0000e0a0: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
-0000e0b0: 2020 2020 2020 2020 6e65 775f 6578 6320          new_exc 
-0000e0c0: 3d20 4461 7461 6261 7365 4572 726f 7228  = DatabaseError(
-0000e0d0: 7469 746c 652c 206d 7367 292e 7769 7468  title, msg).with
-0000e0e0: 5f74 7261 6365 6261 636b 2865 7863 2e5f  _traceback(exc._
-0000e0f0: 5f74 7261 6365 6261 636b 5f5f 290a 0a20  _traceback__).. 
-0000e100: 2020 2020 2020 2069 6620 6e65 775f 6578         if new_ex
-0000e110: 633a 0a20 2020 2020 2020 2020 2020 2069  c:.            i
-0000e120: 6620 7261 6973 655f 6572 726f 723a 0a20  f raise_error:. 
-0000e130: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-0000e140: 6169 7365 206e 6577 5f65 7863 0a20 2020  aise new_exc.   
-0000e150: 2020 2020 2020 2020 2073 656c 662e 5f6c           self._l
-0000e160: 6f67 6765 722e 6572 726f 7228 7469 746c  ogger.error(titl
-0000e170: 652c 2065 7863 5f69 6e66 6f3d 6578 635f  e, exc_info=exc_
-0000e180: 696e 666f 5f74 7570 6c65 286e 6577 5f65  info_tuple(new_e
-0000e190: 7863 2929 0a20 2020 2020 2020 2020 2020  xc)).           
-0000e1a0: 2069 6620 7365 6c66 2e64 6573 6b74 6f70   if self.desktop
-0000e1b0: 5f6e 6f74 6966 6965 723a 0a20 2020 2020  _notifier:.     
-0000e1c0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-0000e1d0: 6465 736b 746f 705f 6e6f 7469 6669 6572  desktop_notifier
-0000e1e0: 2e6e 6f74 6966 7928 7469 746c 652c 206d  .notify(title, m
-0000e1f0: 7367 2c20 6c65 7665 6c3d 6e6f 7469 6679  sg, level=notify
-0000e200: 2e45 5252 4f52 290a 0a20 2020 2064 6566  .ERROR)..    def
-0000e210: 205f 636c 6561 725f 6361 6368 6573 2873   _clear_caches(s
-0000e220: 656c 6629 202d 3e20 4e6f 6e65 3a0a 2020  elf) -> None:.  
-0000e230: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
-0000e240: 2020 4672 6565 7320 6d65 6d6f 7279 2062    Frees memory b
-0000e250: 7920 636c 6561 7269 6e67 2069 6e74 6572  y clearing inter
-0000e260: 6e61 6c20 6361 6368 6573 2e0a 2020 2020  nal caches..    
-0000e270: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
-0000e280: 7365 6c66 2e5f 6361 7365 5f63 6f6e 7665  self._case_conve
-0000e290: 7273 696f 6e5f 6361 6368 652e 636c 6561  rsion_cache.clea
-0000e2a0: 7228 290a 2020 2020 2020 2020 7365 6c66  r().        self
-0000e2b0: 2e66 735f 6576 656e 7473 2e65 7870 6972  .fs_events.expir
-0000e2c0: 655f 6967 6e6f 7265 645f 6576 656e 7473  e_ignored_events
-0000e2d0: 2829 0a0a 2020 2020 6465 6620 5f73 796e  ()..    def _syn
-0000e2e0: 635f 6576 656e 745f 6672 6f6d 5f66 735f  c_event_from_fs_
-0000e2f0: 6576 656e 7428 7365 6c66 2c20 6673 5f65  event(self, fs_e
-0000e300: 7665 6e74 3a20 4669 6c65 5379 7374 656d  vent: FileSystem
-0000e310: 4576 656e 7429 202d 3e20 5379 6e63 4576  Event) -> SyncEv
-0000e320: 656e 743a 0a20 2020 2020 2020 2072 6574  ent:.        ret
-0000e330: 7572 6e20 5379 6e63 4576 656e 742e 6672  urn SyncEvent.fr
-0000e340: 6f6d 5f66 696c 655f 7379 7374 656d 5f65  om_file_system_e
-0000e350: 7665 6e74 2866 735f 6576 656e 742c 2073  vent(fs_event, s
-0000e360: 656c 6629 0a0a 2020 2020 6465 6620 5f73  elf)..    def _s
-0000e370: 796e 635f 6576 656e 7473 5f66 726f 6d5f  ync_events_from_
-0000e380: 6673 5f65 7665 6e74 7328 0a20 2020 2020  fs_events(.     
-0000e390: 2020 2073 656c 662c 2066 735f 6576 656e     self, fs_even
-0000e3a0: 7473 3a20 436f 6c6c 6563 7469 6f6e 5b46  ts: Collection[F
-0000e3b0: 696c 6553 7973 7465 6d45 7665 6e74 5d0a  ileSystemEvent].
-0000e3c0: 2020 2020 2920 2d3e 206c 6973 745b 5379      ) -> list[Sy
-0000e3d0: 6e63 4576 656e 745d 3a0a 2020 2020 2020  ncEvent]:.      
-0000e3e0: 2020 2222 2243 6f6e 7665 7274 206c 6f63    """Convert loc
-0000e3f0: 616c 2066 696c 6520 7379 7374 656d 2065  al file system e
-0000e400: 7665 6e74 7320 746f 2073 796e 6320 6576  vents to sync ev
-0000e410: 656e 7473 2e20 5468 6973 2069 7320 646f  ents. This is do
-0000e420: 6e65 2069 6e20 6120 7468 7265 6164 0a20  ne in a thread. 
-0000e430: 2020 2020 2020 2070 6f6f 6c20 746f 2070         pool to p
-0000e440: 6172 616c 6c65 6c69 7a65 2063 6f6e 7465  arallelize conte
-0000e450: 6e74 2068 6173 6869 6e67 2e22 2222 0a20  nt hashing.""". 
-0000e460: 2020 2020 2020 2072 6573 203d 2064 6f5f         res = do_
-0000e470: 7061 7261 6c6c 656c 280a 2020 2020 2020  parallel(.      
-0000e480: 2020 2020 2020 7365 6c66 2e5f 7379 6e63        self._sync
-0000e490: 5f65 7665 6e74 5f66 726f 6d5f 6673 5f65  _event_from_fs_e
-0000e4a0: 7665 6e74 2c0a 2020 2020 2020 2020 2020  vent,.          
-0000e4b0: 2020 6673 5f65 7665 6e74 732c 0a20 2020    fs_events,.   
-0000e4c0: 2020 2020 2020 2020 2074 6872 6561 645f           thread_
-0000e4d0: 6e61 6d65 5f70 7265 6669 783d 226d 6165  name_prefix="mae
-0000e4e0: 7374 7261 6c2d 6c6f 6361 6c2d 696e 6465  stral-local-inde
-0000e4f0: 7865 7222 2c0a 2020 2020 2020 2020 290a  xer",.        ).
-0000e500: 2020 2020 2020 2020 7265 7475 726e 206c          return l
-0000e510: 6973 7428 7265 7329 0a0a 2020 2020 2320  ist(res)..    # 
-0000e520: 3d3d 3d3d 2055 706c 6f61 6420 7379 6e63  ==== Upload sync
-0000e530: 203d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d   ===============
-0000e540: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0000e550: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0000e560: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0000e570: 3d3d 0a0a 2020 2020 6465 6620 7570 6c6f  ==..    def uplo
-0000e580: 6164 5f6c 6f63 616c 5f63 6861 6e67 6573  ad_local_changes
-0000e590: 5f77 6869 6c65 5f69 6e61 6374 6976 6528  _while_inactive(
-0000e5a0: 7365 6c66 2920 2d3e 204e 6f6e 653a 0a20  self) -> None:. 
-0000e5b0: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
-0000e5c0: 2020 2043 6f6c 6c65 6374 7320 6368 616e     Collects chan
-0000e5d0: 6765 7320 7768 696c 6520 7379 6e63 2068  ges while sync h
-0000e5e0: 6173 206e 6f74 2062 6565 6e20 7275 6e6e  as not been runn
-0000e5f0: 696e 6720 616e 6420 7570 6c6f 6164 7320  ing and uploads 
-0000e600: 7468 656d 2074 6f20 4472 6f70 626f 782e  them to Dropbox.
-0000e610: 0a20 2020 2020 2020 2043 616c 6c20 7468  .        Call th
-0000e620: 6973 206d 6574 686f 6420 7768 656e 2072  is method when r
-0000e630: 6573 756d 696e 6720 7379 6e63 2e0a 2020  esuming sync..  
-0000e640: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
-0000e650: 2020 7769 7468 2073 656c 662e 7379 6e63    with self.sync
-0000e660: 5f6c 6f63 6b3a 0a20 2020 2020 2020 2020  _lock:.         
-0000e670: 2020 2023 2044 656c 6574 6520 7570 6c6f     # Delete uplo
-0000e680: 6164 2073 796e 6320 6572 726f 7273 2062  ad sync errors b
-0000e690: 6566 6f72 6520 7374 6172 7469 6e67 2069  efore starting i
-0000e6a0: 6e64 6578 696e 672e 2054 6869 7320 7072  ndexing. This pr
-0000e6b0: 6576 656e 7473 2065 7272 6f72 730a 2020  events errors.  
-0000e6c0: 2020 2020 2020 2020 2020 2320 6672 6f6d            # from
-0000e6d0: 206e 6f77 2064 656c 6574 6564 206f 7220   now deleted or 
-0000e6e0: 6967 6e6f 7265 6420 282e 6d69 676e 6f72  ignored (.mignor
-0000e6f0: 6529 2069 7465 6d73 2066 726f 6d20 6c69  e) items from li
-0000e700: 6e67 6572 696e 6720 6f6e 2e20 416c 6c20  ngering on. All 
-0000e710: 6f74 6865 720a 2020 2020 2020 2020 2020  other.          
-0000e720: 2020 2320 7379 6e63 2065 7272 6f72 7320    # sync errors 
-0000e730: 7769 6c6c 2062 6520 7265 7472 6965 6420  will be retried 
-0000e740: 6175 746f 6d61 7469 6361 6c6c 7920 6279  automatically by
-0000e750: 2063 6f6d 7061 7269 6e67 206c 6f63 616c   comparing local
-0000e760: 2069 7465 6d73 2061 6761 696e 7374 0a20   items against. 
-0000e770: 2020 2020 2020 2020 2020 2023 206f 7572             # our
-0000e780: 2069 6e64 6578 2e0a 2020 2020 2020 2020   index..        
-0000e790: 2020 2020 7365 6c66 2e5f 6c6f 6767 6572      self._logger
-0000e7a0: 2e64 6562 7567 2822 5072 756e 696e 6720  .debug("Pruning 
-0000e7b0: 7379 6e63 2065 7272 6f72 7322 290a 0a20  sync errors").. 
-0000e7c0: 2020 2020 2020 2020 2020 2077 6974 6820             with 
-0000e7d0: 7365 6c66 2e5f 6461 7461 6261 7365 5f61  self._database_a
-0000e7e0: 6363 6573 7328 293a 0a20 2020 2020 2020  ccess():.       
-0000e7f0: 2020 2020 2020 2020 2071 7565 7279 203d           query =
-0000e800: 204d 6174 6368 5175 6572 7928 5379 6e63   MatchQuery(Sync
-0000e810: 4572 726f 7245 6e74 7279 2e64 6972 6563  ErrorEntry.direc
-0000e820: 7469 6f6e 2c20 5379 6e63 4469 7265 6374  tion, SyncDirect
-0000e830: 696f 6e2e 5570 290a 2020 2020 2020 2020  ion.Up).        
-0000e840: 2020 2020 2020 2020 7365 6c66 2e5f 7379          self._sy
-0000e850: 6e63 5f65 7272 6f72 735f 7461 626c 652e  nc_errors_table.
-0000e860: 6465 6c65 7465 2871 7565 7279 290a 0a20  delete(query).. 
-0000e870: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-0000e880: 5f6c 6f67 6765 722e 696e 666f 2822 496e  _logger.info("In
-0000e890: 6465 7869 6e67 206c 6f63 616c 2063 6861  dexing local cha
-0000e8a0: 6e67 6573 2e2e 2e22 290a 0a20 2020 2020  nges...")..     
-0000e8b0: 2020 2020 2020 2074 7279 3a0a 2020 2020         try:.    
-0000e8c0: 2020 2020 2020 2020 2020 2020 6576 656e              even
-0000e8d0: 7473 2c20 6c6f 6361 6c5f 6375 7273 6f72  ts, local_cursor
-0000e8e0: 203d 2073 656c 662e 5f67 6574 5f6c 6f63   = self._get_loc
-0000e8f0: 616c 5f63 6861 6e67 6573 5f77 6869 6c65  al_changes_while
-0000e900: 5f69 6e61 6374 6976 6528 290a 2020 2020  _inactive().    
-0000e910: 2020 2020 2020 2020 6578 6365 7074 204f          except O
-0000e920: 5345 7272 6f72 2061 7320 6572 723a 0a20  SError as err:. 
-0000e930: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-0000e940: 6620 6572 722e 6669 6c65 6e61 6d65 203d  f err.filename =
-0000e950: 3d20 7365 6c66 2e64 726f 7062 6f78 5f70  = self.dropbox_p
-0000e960: 6174 683a 0a20 2020 2020 2020 2020 2020  ath:.           
-0000e970: 2020 2020 2020 2020 2073 656c 662e 656e           self.en
-0000e980: 7375 7265 5f64 726f 7062 6f78 5f66 6f6c  sure_dropbox_fol
-0000e990: 6465 725f 7072 6573 656e 7428 290a 0a20  der_present().. 
-0000e9a0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-0000e9b0: 6169 7365 206f 735f 746f 5f6d 6165 7374  aise os_to_maest
-0000e9c0: 7261 6c5f 6572 726f 7228 6572 7229 0a0a  ral_error(err)..
-0000e9d0: 2020 2020 2020 2020 2020 2020 6576 656e              even
-0000e9e0: 7473 203d 2073 656c 662e 5f63 6c65 616e  ts = self._clean
-0000e9f0: 5f6c 6f63 616c 5f65 7665 6e74 7328 6576  _local_events(ev
-0000ea00: 656e 7473 290a 0a20 2020 2020 2020 2020  ents)..         
-0000ea10: 2020 2073 796e 635f 6576 656e 7473 203d     sync_events =
-0000ea20: 2073 656c 662e 5f73 796e 635f 6576 656e   self._sync_even
-0000ea30: 7473 5f66 726f 6d5f 6673 5f65 7665 6e74  ts_from_fs_event
-0000ea40: 7328 6576 656e 7473 290a 2020 2020 2020  s(events).      
-0000ea50: 2020 2020 2020 6465 6c20 6576 656e 7473        del events
-0000ea60: 0a0a 2020 2020 2020 2020 2020 2020 6966  ..            if
-0000ea70: 206c 656e 2873 796e 635f 6576 656e 7473   len(sync_events
-0000ea80: 2920 3e20 303a 0a20 2020 2020 2020 2020  ) > 0:.         
-0000ea90: 2020 2020 2020 2073 656c 662e 6170 706c         self.appl
-0000eaa0: 795f 6c6f 6361 6c5f 6368 616e 6765 7328  y_local_changes(
-0000eab0: 7379 6e63 5f65 7665 6e74 7329 0a20 2020  sync_events).   
-0000eac0: 2020 2020 2020 2020 2020 2020 2073 656c               sel
-0000ead0: 662e 5f6c 6f67 6765 722e 6465 6275 6728  f._logger.debug(
-0000eae0: 2255 706c 6f61 6465 6420 6c6f 6361 6c20  "Uploaded local 
-0000eaf0: 6368 616e 6765 7320 7768 696c 6520 696e  changes while in
-0000eb00: 6163 7469 7665 2229 0a20 2020 2020 2020  active").       
-0000eb10: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-0000eb20: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-0000eb30: 5f6c 6f67 6765 722e 6465 6275 6728 224e  _logger.debug("N
-0000eb40: 6f20 6c6f 6361 6c20 6368 616e 6765 7320  o local changes 
-0000eb50: 7768 696c 6520 696e 6163 7469 7665 2229  while inactive")
-0000eb60: 0a0a 2020 2020 2020 2020 2020 2020 6465  ..            de
-0000eb70: 6c20 7379 6e63 5f65 7665 6e74 730a 2020  l sync_events.  
-0000eb80: 2020 2020 2020 2020 2020 6763 2e63 6f6c            gc.col
-0000eb90: 6c65 6374 2829 0a0a 2020 2020 2020 2020  lect()..        
-0000eba0: 2020 2020 7365 6c66 2e6c 6f63 616c 5f63      self.local_c
-0000ebb0: 7572 736f 7220 3d20 6c6f 6361 6c5f 6375  ursor = local_cu
-0000ebc0: 7273 6f72 0a0a 2020 2020 2020 2020 2020  rsor..          
-0000ebd0: 2020 7365 6c66 2e5f 636c 6561 725f 6361    self._clear_ca
-0000ebe0: 6368 6573 2829 0a0a 2020 2020 6465 6620  ches()..    def 
-0000ebf0: 5f67 6574 5f6c 6f63 616c 5f63 6861 6e67  _get_local_chang
-0000ec00: 6573 5f77 6869 6c65 5f69 6e61 6374 6976  es_while_inactiv
-0000ec10: 6528 7365 6c66 2920 2d3e 2074 7570 6c65  e(self) -> tuple
-0000ec20: 5b6c 6973 745b 4669 6c65 5379 7374 656d  [list[FileSystem
-0000ec30: 4576 656e 745d 2c20 666c 6f61 745d 3a0a  Event], float]:.
-0000ec40: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
-0000ec50: 2020 2020 5265 7472 6965 7665 7320 616c      Retrieves al
-0000ec60: 6c20 6c6f 6361 6c20 6368 616e 6765 7320  l local changes 
-0000ec70: 7369 6e63 6520 7468 6520 6c61 7374 2073  since the last s
-0000ec80: 796e 6320 6279 2070 6572 666f 726d 696e  ync by performin
-0000ec90: 6720 6120 6675 6c6c 2073 6361 6e20 6f66  g a full scan of
-0000eca0: 2074 6865 0a20 2020 2020 2020 206c 6f63   the.        loc
-0000ecb0: 616c 2066 6f6c 6465 722e 2043 6861 6e67  al folder. Chang
-0000ecc0: 6573 2061 7265 2064 6574 6563 7465 6420  es are detected 
-0000ecd0: 6279 2063 6f6d 7061 7269 6e67 2074 6865  by comparing the
-0000ece0: 206e 6577 2064 6972 6563 746f 7279 2073   new directory s
-0000ecf0: 6e61 7073 686f 7420 746f 0a20 2020 2020  napshot to.     
-0000ed00: 2020 206f 7572 2069 6e64 6578 2e0a 0a20     our index... 
-0000ed10: 2020 2020 2020 2041 6464 6564 2069 7465         Added ite
-0000ed20: 6d73 3a20 4172 6520 7072 6573 656e 7420  ms: Are present 
-0000ed30: 696e 2074 6865 2073 6e61 7073 686f 7420  in the snapshot 
-0000ed40: 6275 7420 6e6f 7420 696e 206f 7572 2069  but not in our i
-0000ed50: 6e64 6578 2e0a 2020 2020 2020 2020 4465  ndex..        De
-0000ed60: 6c65 7465 6420 6974 656d 733a 2041 7265  leted items: Are
-0000ed70: 2070 7265 7365 6e74 2069 6e20 6f75 7220   present in our 
-0000ed80: 696e 6465 7820 6275 7420 6e6f 7420 696e  index but not in
-0000ed90: 2074 6865 2073 6e61 7073 686f 742e 0a20   the snapshot.. 
-0000eda0: 2020 2020 2020 204d 6f64 6966 6965 6420         Modified 
-0000edb0: 6974 656d 733a 2041 7265 2070 7265 7365  items: Are prese
-0000edc0: 6e74 2069 6e20 626f 7468 2062 7574 2068  nt in both but h
-0000edd0: 6176 6520 6120 6d74 696d 6520 6e65 7765  ave a mtime newe
-0000ede0: 7220 7468 616e 2074 6865 206c 6173 7420  r than the last 
-0000edf0: 7379 6e63 2e0a 0a20 2020 2020 2020 204e  sync...        N
-0000ee00: 6f74 6520 7468 6174 2074 6865 2063 6c69  ote that the cli
-0000ee10: 656e 7420 7365 7473 206d 7469 6d65 7320  ent sets mtimes 
-0000ee20: 666f 7220 6669 6c65 7320 6578 706c 6963  for files explic
-0000ee30: 6974 6c79 2062 7574 206e 6576 6572 2074  itly but never t
-0000ee40: 6f20 6120 7661 6c75 6520 696e 0a20 2020  o a value in.   
-0000ee50: 2020 2020 2074 6865 2066 7574 7572 652e       the future.
-0000ee60: 206d 7469 6d65 203e 206c 6173 745f 7379   mtime > last_sy
-0000ee70: 6e63 2074 6865 7265 666f 7265 2069 6e64  nc therefore ind
-0000ee80: 6963 6174 6573 2061 2072 6563 656e 7420  icates a recent 
-0000ee90: 636f 6e74 656e 7420 6368 616e 6765 2e20  content change. 
-0000eea0: 5765 2064 6f0a 2020 2020 2020 2020 6e6f  We do.        no
-0000eeb0: 7420 7573 6520 7468 6520 6374 696d 6520  t use the ctime 
-0000eec0: 6865 7265 2074 6f20 6176 6f69 6420 7265  here to avoid re
-0000eed0: 7379 6e63 696e 6720 7468 6520 656e 7469  syncing the enti
-0000eee0: 7265 2066 6f6c 6465 7220 6166 7465 7220  re folder after 
-0000eef0: 6974 2068 6173 2062 6565 6e0a 2020 2020  it has been.    
-0000ef00: 2020 2020 6d6f 7665 6420 286d 6f76 696e      moved (movin
-0000ef10: 6720 6265 7477 6565 6e20 7061 7274 6974  g between partit
-0000ef20: 696f 6e73 2061 6e64 206f 6e20 736f 6d65  ions and on some
-0000ef30: 2066 696c 6520 7379 7374 656d 7320 6361   file systems ca
-0000ef40: 6e20 6368 616e 6765 2074 6865 2063 7469  n change the cti
-0000ef50: 6d65 292e 0a0a 2020 2020 2020 2020 3a72  me)...        :r
-0000ef60: 6574 7572 6e73 3a20 5475 706c 6520 636f  eturns: Tuple co
-0000ef70: 6e74 6169 6e69 6e67 206c 6f63 616c 2066  ntaining local f
-0000ef80: 696c 6520 7379 7374 656d 2065 7665 6e74  ile system event
-0000ef90: 7320 616e 6420 6120 6375 7273 6f72 202f  s and a cursor /
-0000efa0: 2074 696d 6573 7461 6d70 0a20 2020 2020   timestamp.     
-0000efb0: 2020 2020 2020 2066 6f72 2074 6865 2063         for the c
-0000efc0: 6861 6e67 6573 2e0a 2020 2020 2020 2020  hanges..        
-0000efd0: 2222 220a 2020 2020 2020 2020 6368 616e  """.        chan
-0000efe0: 6765 7320 3d20 5b5d 0a20 2020 2020 2020  ges = [].       
-0000eff0: 2073 6e61 7073 686f 745f 7469 6d65 203d   snapshot_time =
-0000f000: 2074 696d 652e 7469 6d65 2829 0a0a 2020   time.time()..  
-0000f010: 2020 2020 2020 2320 4765 7420 6d6f 6469        # Get modi
-0000f020: 6669 6564 206f 7220 6164 6465 6420 6974  fied or added it
-0000f030: 656d 732e 0a20 2020 2020 2020 2066 6f72  ems..        for
-0000f040: 2070 6174 682c 2073 7461 7420 696e 2077   path, stat in w
-0000f050: 616c 6b28 7365 6c66 2e64 726f 7062 6f78  alk(self.dropbox
-0000f060: 5f70 6174 682c 2073 656c 662e 5f73 6361  _path, self._sca
-0000f070: 6e64 6972 5f77 6974 685f 6967 6e6f 7265  ndir_with_ignore
-0000f080: 293a 0a20 2020 2020 2020 2020 2020 2069  ):.            i
-0000f090: 735f 6469 7220 3d20 535f 4953 4449 5228  s_dir = S_ISDIR(
-0000f0a0: 7374 6174 2e73 745f 6d6f 6465 290a 2020  stat.st_mode).  
-0000f0b0: 2020 2020 2020 2020 2020 6462 785f 7061            dbx_pa
-0000f0c0: 7468 5f6c 6f77 6572 203d 2073 656c 662e  th_lower = self.
-0000f0d0: 746f 5f64 6278 5f70 6174 685f 6c6f 7765  to_dbx_path_lowe
-0000f0e0: 7228 7061 7468 290a 2020 2020 2020 2020  r(path).        
-0000f0f0: 2020 2020 696e 6465 785f 656e 7472 7920      index_entry 
-0000f100: 3d20 7365 6c66 2e67 6574 5f69 6e64 6578  = self.get_index
-0000f110: 5f65 6e74 7279 2864 6278 5f70 6174 685f  _entry(dbx_path_
-0000f120: 6c6f 7765 7229 0a0a 2020 2020 2020 2020  lower)..        
-0000f130: 2020 2020 6966 2069 6e64 6578 5f65 6e74      if index_ent
-0000f140: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
-0000f150: 2020 2020 6973 5f6e 6577 203d 2046 616c      is_new = Fal
-0000f160: 7365 0a20 2020 2020 2020 2020 2020 2020  se.             
-0000f170: 2020 206c 6173 745f 7379 6e63 203d 2069     last_sync = i
-0000f180: 6e64 6578 5f65 6e74 7279 2e6c 6173 745f  ndex_entry.last_
-0000f190: 7379 6e63 206f 7220 302e 300a 2020 2020  sync or 0.0.    
-0000f1a0: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-0000f1b0: 2020 2020 2020 2020 2020 2020 2020 6973                is
-0000f1c0: 5f6e 6577 203d 2054 7275 650a 2020 2020  _new = True.    
-0000f1d0: 2020 2020 2020 2020 2020 2020 6c61 7374              last
-0000f1e0: 5f73 796e 6320 3d20 302e 300a 0a20 2020  _sync = 0.0..   
-0000f1f0: 2020 2020 2020 2020 206c 6173 745f 7379           last_sy
-0000f200: 6e63 203d 206d 6178 286c 6173 745f 7379  nc = max(last_sy
-0000f210: 6e63 2c20 7365 6c66 2e6c 6f63 616c 5f63  nc, self.local_c
-0000f220: 7572 736f 7229 0a0a 2020 2020 2020 2020  ursor)..        
-0000f230: 2020 2020 2320 4368 6563 6b20 6966 2069      # Check if i
-0000f240: 7465 6d20 7761 7320 6372 6561 7465 6420  tem was created 
-0000f250: 6f72 206d 6f64 6966 6965 6420 7369 6e63  or modified sinc
-0000f260: 6520 7468 6520 6c61 7374 2073 796e 632c  e the last sync,
-0000f270: 0a20 2020 2020 2020 2020 2020 2023 2062  .            # b
-0000f280: 7574 2062 6566 6f72 6520 7765 2073 7461  ut before we sta
-0000f290: 7274 6564 2074 6865 2046 696c 6545 7665  rted the FileEve
-0000f2a0: 6e74 4861 6e64 6c65 7220 287e 736e 6170  ntHandler (~snap
-0000f2b0: 7368 6f74 5f74 696d 6529 2e0a 0a20 2020  shot_time)...   
-0000f2c0: 2020 2020 2020 2020 206d 7469 6d65 5f63           mtime_c
-0000f2d0: 6865 636b 203d 2073 6e61 7073 686f 745f  heck = snapshot_
-0000f2e0: 7469 6d65 203e 2073 7461 742e 7374 5f6d  time > stat.st_m
-0000f2f0: 7469 6d65 203e 206c 6173 745f 7379 6e63  time > last_sync
-0000f300: 0a0a 2020 2020 2020 2020 2020 2020 2320  ..            # 
-0000f310: 416c 7761 7973 2075 706c 6f61 6420 756e  Always upload un
-0000f320: 7472 6163 6b65 6420 6974 656d 732c 2063  tracked items, c
-0000f330: 6865 636b 206d 7469 6d65 206f 6620 7472  heck mtime of tr
-0000f340: 6163 6b65 6420 6974 656d 732e 0a20 2020  acked items..   
-0000f350: 2020 2020 2020 2020 2069 735f 6d6f 6469           is_modi
-0000f360: 6669 6564 203d 206d 7469 6d65 5f63 6865  fied = mtime_che
-0000f370: 636b 2061 6e64 206e 6f74 2069 735f 6e65  ck and not is_ne
-0000f380: 770a 0a20 2020 2020 2020 2020 2020 2065  w..            e
-0000f390: 7665 6e74 3a20 4669 6c65 5379 7374 656d  vent: FileSystem
-0000f3a0: 4576 656e 740a 2020 2020 2020 2020 2020  Event.          
-0000f3b0: 2020 6576 656e 7430 3a20 4669 6c65 5379    event0: FileSy
-0000f3c0: 7374 656d 4576 656e 740a 2020 2020 2020  stemEvent.      
-0000f3d0: 2020 2020 2020 6576 656e 7431 3a20 4669        event1: Fi
-0000f3e0: 6c65 5379 7374 656d 4576 656e 740a 0a20  leSystemEvent.. 
-0000f3f0: 2020 2020 2020 2020 2020 2069 6620 6973             if is
-0000f400: 5f6e 6577 3a0a 2020 2020 2020 2020 2020  _new:.          
-0000f410: 2020 2020 2020 6966 2069 735f 6469 723a        if is_dir:
-0000f420: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000f430: 2020 2020 2065 7665 6e74 203d 2044 6972       event = Dir
-0000f440: 4372 6561 7465 6445 7665 6e74 2870 6174  CreatedEvent(pat
-0000f450: 6829 0a20 2020 2020 2020 2020 2020 2020  h).             
-0000f460: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-0000f470: 2020 2020 2020 2020 2020 2020 2065 7665               eve
-0000f480: 6e74 203d 2046 696c 6543 7265 6174 6564  nt = FileCreated
-0000f490: 4576 656e 7428 7061 7468 290a 2020 2020  Event(path).    
-0000f4a0: 2020 2020 2020 2020 2020 2020 6368 616e              chan
-0000f4b0: 6765 732e 6170 7065 6e64 2865 7665 6e74  ges.append(event
-0000f4c0: 290a 0a20 2020 2020 2020 2020 2020 2065  )..            e
-0000f4d0: 6c69 6620 6973 5f6d 6f64 6966 6965 643a  lif is_modified:
-0000f4e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000f4f0: 2069 6620 6973 5f64 6972 2061 6e64 2069   if is_dir and i
-0000f500: 6e64 6578 5f65 6e74 7279 2e69 735f 6469  ndex_entry.is_di
-0000f510: 7265 6374 6f72 793a 2020 2320 7479 7065  rectory:  # type
-0000f520: 3a20 6967 6e6f 7265 0a20 2020 2020 2020  : ignore.       
-0000f530: 2020 2020 2020 2020 2020 2020 2023 2057               # W
-0000f540: 6520 646f 6e27 7420 656d 6974 2060 4469  e don't emit `Di
-0000f550: 724d 6f64 6966 6965 6445 7665 6e74 6073  rModifiedEvent`s
-0000f560: 2e0a 2020 2020 2020 2020 2020 2020 2020  ..              
-0000f570: 2020 2020 2020 7061 7373 0a20 2020 2020        pass.     
-0000f580: 2020 2020 2020 2020 2020 2065 6c69 6620             elif 
-0000f590: 6e6f 7420 6973 5f64 6972 2061 6e64 206e  not is_dir and n
-0000f5a0: 6f74 2069 6e64 6578 5f65 6e74 7279 2e69  ot index_entry.i
-0000f5b0: 735f 6469 7265 6374 6f72 793a 2020 2320  s_directory:  # 
-0000f5c0: 7479 7065 3a20 6967 6e6f 7265 0a20 2020  type: ignore.   
-0000f5d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f5e0: 2065 7665 6e74 203d 2046 696c 654d 6f64   event = FileMod
-0000f5f0: 6966 6965 6445 7665 6e74 2870 6174 6829  ifiedEvent(path)
-0000f600: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000f610: 2020 2020 2063 6861 6e67 6573 2e61 7070       changes.app
-0000f620: 656e 6428 6576 656e 7429 0a20 2020 2020  end(event).     
-0000f630: 2020 2020 2020 2020 2020 2065 6c69 6620             elif 
-0000f640: 6973 5f64 6972 3a0a 2020 2020 2020 2020  is_dir:.        
-0000f650: 2020 2020 2020 2020 2020 2020 6576 656e              even
-0000f660: 7430 203d 2046 696c 6544 656c 6574 6564  t0 = FileDeleted
-0000f670: 4576 656e 7428 7061 7468 290a 2020 2020  Event(path).    
-0000f680: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f690: 6576 656e 7431 203d 2044 6972 4372 6561  event1 = DirCrea
-0000f6a0: 7465 6445 7665 6e74 2870 6174 6829 0a20  tedEvent(path). 
-0000f6b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f6c0: 2020 2063 6861 6e67 6573 202b 3d20 5b65     changes += [e
-0000f6d0: 7665 6e74 302c 2065 7665 6e74 315d 0a20  vent0, event1]. 
-0000f6e0: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-0000f6f0: 6c69 6620 6e6f 7420 6973 5f64 6972 3a0a  lif not is_dir:.
-0000f700: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f710: 2020 2020 6576 656e 7430 203d 2044 6972      event0 = Dir
-0000f720: 4465 6c65 7465 6445 7665 6e74 2870 6174  DeletedEvent(pat
-0000f730: 6829 0a20 2020 2020 2020 2020 2020 2020  h).             
-0000f740: 2020 2020 2020 2065 7665 6e74 3120 3d20         event1 = 
-0000f750: 4669 6c65 4372 6561 7465 6445 7665 6e74  FileCreatedEvent
-0000f760: 2870 6174 6829 0a20 2020 2020 2020 2020  (path).         
-0000f770: 2020 2020 2020 2020 2020 2063 6861 6e67             chang
-0000f780: 6573 202b 3d20 5b65 7665 6e74 302c 2065  es += [event0, e
-0000f790: 7665 6e74 315d 0a0a 2020 2020 2020 2020  vent1]..        
-0000f7a0: 2320 4765 7420 6465 6c65 7465 6420 6974  # Get deleted it
-0000f7b0: 656d 732e 0a20 2020 2020 2020 2066 6f72  ems..        for
-0000f7c0: 2065 6e74 7279 2069 6e20 7365 6c66 2e69   entry in self.i
-0000f7d0: 7465 725f 696e 6465 7828 293a 0a20 2020  ter_index():.   
-0000f7e0: 2020 2020 2020 2020 206c 6f63 616c 5f70           local_p
-0000f7f0: 6174 6820 3d20 7365 6c66 2e74 6f5f 6c6f  ath = self.to_lo
-0000f800: 6361 6c5f 7061 7468 5f66 726f 6d5f 6361  cal_path_from_ca
-0000f810: 7365 6428 656e 7472 792e 6462 785f 7061  sed(entry.dbx_pa
-0000f820: 7468 5f63 6173 6564 290a 2020 2020 2020  th_cased).      
-0000f830: 2020 2020 2020 6973 5f6d 6967 6e6f 7265        is_mignore
-0000f840: 203d 2073 656c 662e 5f69 735f 6d69 676e   = self._is_mign
-0000f850: 6f72 655f 7061 7468 2865 6e74 7279 2e64  ore_path(entry.d
-0000f860: 6278 5f70 6174 685f 6361 7365 642c 2065  bx_path_cased, e
-0000f870: 6e74 7279 2e69 735f 6469 7265 6374 6f72  ntry.is_director
-0000f880: 7929 0a0a 2020 2020 2020 2020 2020 2020  y)..            
-0000f890: 6966 2069 735f 6d69 676e 6f72 6520 6f72  if is_mignore or
-0000f8a0: 206e 6f74 2065 7869 7374 7328 6c6f 6361   not exists(loca
-0000f8b0: 6c5f 7061 7468 293a 0a20 2020 2020 2020  l_path):.       
-0000f8c0: 2020 2020 2020 2020 2069 6620 656e 7472           if entr
-0000f8d0: 792e 6973 5f64 6972 6563 746f 7279 3a0a  y.is_directory:.
-0000f8e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f8f0: 2020 2020 6576 656e 7420 3d20 4469 7244      event = DirD
-0000f900: 656c 6574 6564 4576 656e 7428 6c6f 6361  eletedEvent(loca
-0000f910: 6c5f 7061 7468 290a 2020 2020 2020 2020  l_path).        
-0000f920: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-0000f930: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f940: 2020 6576 656e 7420 3d20 4669 6c65 4465    event = FileDe
-0000f950: 6c65 7465 6445 7665 6e74 286c 6f63 616c  letedEvent(local
-0000f960: 5f70 6174 6829 0a20 2020 2020 2020 2020  _path).         
-0000f970: 2020 2020 2020 2063 6861 6e67 6573 2e61         changes.a
-0000f980: 7070 656e 6428 6576 656e 7429 0a0a 2020  ppend(event)..  
-0000f990: 2020 2020 2020 2320 456e 7375 7265 2074        # Ensure t
-0000f9a0: 6861 7420 7468 6520 6c6f 6361 6c20 4472  hat the local Dr
-0000f9b0: 6f70 626f 7820 666f 6c64 6572 2073 7469  opbox folder sti
-0000f9c0: 6c6c 2065 7869 7374 7320 6265 666f 7265  ll exists before
-0000f9d0: 2072 6574 7572 6e69 6e67 2063 6861 6e67   returning chang
-0000f9e0: 6573 2e0a 2020 2020 2020 2020 2320 5468  es..        # Th
-0000f9f0: 6973 2070 7265 7665 6e74 7320 6120 6465  is prevents a de
-0000fa00: 6c65 7469 6f6e 206f 6620 7468 6520 4472  letion of the Dr
-0000fa10: 6f70 626f 7820 666f 6c64 6572 2066 726f  opbox folder fro
-0000fa20: 6d20 6265 696e 6720 696e 636f 7272 6563  m being incorrec
-0000fa30: 746c 790a 2020 2020 2020 2020 2320 7072  tly.        # pr
-0000fa40: 6f63 6573 7365 6420 6173 2069 6e64 6976  ocessed as indiv
-0000fa50: 6964 7561 6c20 6669 6c65 2064 656c 6574  idual file delet
-0000fa60: 696f 6e73 2e0a 2020 2020 2020 2020 7365  ions..        se
-0000fa70: 6c66 2e65 6e73 7572 655f 6472 6f70 626f  lf.ensure_dropbo
-0000fa80: 785f 666f 6c64 6572 5f70 7265 7365 6e74  x_folder_present
-0000fa90: 2829 0a0a 2020 2020 2020 2020 6475 7261  ()..        dura
-0000faa0: 7469 6f6e 203d 2074 696d 652e 7469 6d65  tion = time.time
-0000fab0: 2829 202d 2073 6e61 7073 686f 745f 7469  () - snapshot_ti
-0000fac0: 6d65 0a20 2020 2020 2020 2073 656c 662e  me.        self.
-0000fad0: 5f6c 6f67 6765 722e 6465 6275 6728 224c  _logger.debug("L
-0000fae0: 6f63 616c 2069 6e64 6578 696e 6720 636f  ocal indexing co
-0000faf0: 6d70 6c65 7465 6420 696e 2025 7320 7365  mpleted in %s se
-0000fb00: 6322 2c20 726f 756e 6428 6475 7261 7469  c", round(durati
-0000fb10: 6f6e 2c20 3429 290a 2020 2020 2020 2020  on, 4)).        
-0000fb20: 7365 6c66 2e5f 6c6f 6767 6572 2e64 6562  self._logger.deb
-0000fb30: 7567 2822 5265 7472 6965 7665 6420 6c6f  ug("Retrieved lo
-0000fb40: 6361 6c20 6368 616e 6765 733a 5c6e 2573  cal changes:\n%s
-0000fb50: 222c 2070 665f 7265 7072 2863 6861 6e67  ", pf_repr(chang
-0000fb60: 6573 2929 0a0a 2020 2020 2020 2020 7265  es))..        re
-0000fb70: 7475 726e 2063 6861 6e67 6573 2c20 736e  turn changes, sn
-0000fb80: 6170 7368 6f74 5f74 696d 650a 0a20 2020  apshot_time..   
-0000fb90: 2064 6566 2077 6169 745f 666f 725f 6c6f   def wait_for_lo
-0000fba0: 6361 6c5f 6368 616e 6765 7328 7365 6c66  cal_changes(self
-0000fbb0: 2c20 7469 6d65 6f75 743a 2066 6c6f 6174  , timeout: float
-0000fbc0: 203d 2034 3029 202d 3e20 626f 6f6c 3a0a   = 40) -> bool:.
-0000fbd0: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
-0000fbe0: 2020 2020 426c 6f63 6b73 2075 6e74 696c      Blocks until
-0000fbf0: 206c 6f63 616c 2063 6861 6e67 6573 2061   local changes a
-0000fc00: 7265 2061 7661 696c 6162 6c65 2e0a 0a20  re available... 
-0000fc10: 2020 2020 2020 203a 7061 7261 6d20 7469         :param ti
-0000fc20: 6d65 6f75 743a 204d 6178 696d 756d 2074  meout: Maximum t
-0000fc30: 696d 6520 696e 2073 6563 6f6e 6473 2074  ime in seconds t
-0000fc40: 6f20 7761 6974 2e0a 2020 2020 2020 2020  o wait..        
-0000fc50: 3a72 6574 7572 6e73 3a20 6060 5472 7565  :returns: ``True
-0000fc60: 6060 2069 6620 6368 616e 6765 7320 6172  `` if changes ar
-0000fc70: 6520 6176 6169 6c61 626c 652c 2060 6046  e available, ``F
-0000fc80: 616c 7365 6060 206f 7468 6572 7769 7365  alse`` otherwise
-0000fc90: 2e0a 2020 2020 2020 2020 2222 220a 2020  ..        """.  
-0000fca0: 2020 2020 2020 7365 6c66 2e5f 6c6f 6767        self._logg
-0000fcb0: 6572 2e64 6562 7567 280a 2020 2020 2020  er.debug(.      
-0000fcc0: 2020 2020 2020 2257 6169 7469 6e67 2066        "Waiting f
-0000fcd0: 6f72 206c 6f63 616c 2063 6861 6e67 6573  or local changes
-0000fce0: 2073 696e 6365 2063 7572 736f 723a 2025   since cursor: %
-0000fcf0: 7322 2c20 7365 6c66 2e6c 6f63 616c 5f63  s", self.local_c
-0000fd00: 7572 736f 720a 2020 2020 2020 2020 290a  ursor.        ).
-0000fd10: 2020 2020 2020 2020 7265 7475 726e 2073          return s
-0000fd20: 656c 662e 6673 5f65 7665 6e74 732e 7761  elf.fs_events.wa
-0000fd30: 6974 5f66 6f72 5f65 7665 6e74 2874 696d  it_for_event(tim
-0000fd40: 656f 7574 290a 0a20 2020 2064 6566 2075  eout)..    def u
-0000fd50: 706c 6f61 645f 7379 6e63 5f63 7963 6c65  pload_sync_cycle
-0000fd60: 2873 656c 6629 202d 3e20 4e6f 6e65 3a0a  (self) -> None:.
-0000fd70: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
-0000fd80: 2020 2020 5065 7266 6f72 6d73 2061 2066      Performs a f
-0000fd90: 756c 6c20 7570 6c6f 6164 2073 796e 6320  ull upload sync 
-0000fda0: 6379 636c 6520 6279 2063 616c 6c69 6e67  cycle by calling
-0000fdb0: 2069 6e20 6f72 6465 723a 0a0a 2020 2020   in order:..    
-0000fdc0: 2020 2020 2020 2020 3129 203a 6d65 7468          1) :meth
-0000fdd0: 3a60 6c69 7374 5f6c 6f63 616c 5f63 6861  :`list_local_cha
-0000fde0: 6e67 6573 600a 2020 2020 2020 2020 2020  nges`.          
-0000fdf0: 2020 3229 203a 6d65 7468 3a60 6170 706c    2) :meth:`appl
-0000fe00: 795f 6c6f 6361 6c5f 6368 616e 6765 7360  y_local_changes`
-0000fe10: 0a0a 2020 2020 2020 2020 4861 6e64 6c65  ..        Handle
-0000fe20: 7320 7570 6461 7469 6e67 2074 6865 206c  s updating the l
-0000fe30: 6f63 616c 2063 7572 736f 7220 666f 7220  ocal cursor for 
-0000fe40: 796f 752e 2049 6620 6d6f 6e69 746f 7269  you. If monitori
-0000fe50: 6e67 2066 6f72 206c 6f63 616c 2066 696c  ng for local fil
-0000fe60: 6520 6576 656e 7473 0a20 2020 2020 2020  e events.       
-0000fe70: 2077 6173 2069 6e74 6572 7275 7074 6564   was interrupted
-0000fe80: 2c20 6361 6c6c 203a 6d65 7468 3a60 7570  , call :meth:`up
-0000fe90: 6c6f 6164 5f6c 6f63 616c 5f63 6861 6e67  load_local_chang
-0000fea0: 6573 5f77 6869 6c65 5f69 6e61 6374 6976  es_while_inactiv
-0000feb0: 6560 2069 6e73 7465 6164 2e0a 2020 2020  e` instead..    
-0000fec0: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
-0000fed0: 7769 7468 2073 656c 662e 7379 6e63 5f6c  with self.sync_l
-0000fee0: 6f63 6b3a 0a20 2020 2020 2020 2020 2020  ock:.           
-0000fef0: 2063 6861 6e67 6573 2c20 6375 7273 6f72   changes, cursor
-0000ff00: 203d 2073 656c 662e 6c69 7374 5f6c 6f63   = self.list_loc
-0000ff10: 616c 5f63 6861 6e67 6573 2829 0a20 2020  al_changes().   
-0000ff20: 2020 2020 2020 2020 2073 656c 662e 6170           self.ap
-0000ff30: 706c 795f 6c6f 6361 6c5f 6368 616e 6765  ply_local_change
-0000ff40: 7328 6368 616e 6765 7329 0a0a 2020 2020  s(changes)..    
-0000ff50: 2020 2020 2020 2020 636f 6e66 6c69 6374          conflict
-0000ff60: 7320 3d20 5b65 2066 6f72 2065 2069 6e20  s = [e for e in 
-0000ff70: 6368 616e 6765 7320 6966 2065 2e73 7461  changes if e.sta
-0000ff80: 7475 7320 6973 2053 796e 6353 7461 7475  tus is SyncStatu
-0000ff90: 732e 436f 6e66 6c69 6374 5d0a 2020 2020  s.Conflict].    
-0000ffa0: 2020 2020 2020 2020 7365 6c66 2e6e 6f74          self.not
-0000ffb0: 6966 795f 7573 6572 2863 6f6e 666c 6963  ify_user(conflic
-0000ffc0: 7473 290a 0a20 2020 2020 2020 2020 2020  ts)..           
-0000ffd0: 2073 656c 662e 6c6f 6361 6c5f 6375 7273   self.local_curs
-0000ffe0: 6f72 203d 2063 7572 736f 720a 0a20 2020  or = cursor..   
-0000fff0: 2020 2020 2020 2020 2023 2046 7265 6520           # Free 
-00010000: 6d65 6d6f 7279 2065 6172 6c79 2074 6f20  memory early to 
-00010010: 7072 6576 656e 7420 6672 6167 6d65 6e74  prevent fragment
-00010020: 6174 696f 6e2e 0a20 2020 2020 2020 2020  ation..         
-00010030: 2020 2064 656c 2063 6861 6e67 6573 0a20     del changes. 
-00010040: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-00010050: 5f63 6c65 6172 5f63 6163 6865 7328 290a  _clear_caches().
-00010060: 2020 2020 2020 2020 2020 2020 6763 2e63              gc.c
-00010070: 6f6c 6c65 6374 2829 0a0a 2020 2020 2020  ollect()..      
-00010080: 2020 2020 2020 6966 2073 656c 662e 5f63        if self._c
-00010090: 616e 6365 6c5f 7265 7175 6573 7465 642e  ancel_requested.
-000100a0: 6973 5f73 6574 2829 3a0a 2020 2020 2020  is_set():.      
-000100b0: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
-000100c0: 4361 6e63 656c 6c65 6445 7272 6f72 2822  CancelledError("
-000100d0: 5379 6e63 2063 616e 6365 6c6c 6564 2229  Sync cancelled")
-000100e0: 0a0a 2020 2020 6465 6620 6c69 7374 5f6c  ..    def list_l
-000100f0: 6f63 616c 5f63 6861 6e67 6573 2873 656c  ocal_changes(sel
-00010100: 662c 2064 656c 6179 3a20 666c 6f61 7420  f, delay: float 
-00010110: 3d20 3129 202d 3e20 7475 706c 655b 6c69  = 1) -> tuple[li
-00010120: 7374 5b53 796e 6345 7665 6e74 5d2c 2066  st[SyncEvent], f
-00010130: 6c6f 6174 5d3a 0a20 2020 2020 2020 2022  loat]:.        "
-00010140: 2222 0a20 2020 2020 2020 2052 6574 7572  "".        Retur
-00010150: 6e73 2061 206c 6973 7420 6f66 206c 6f63  ns a list of loc
-00010160: 616c 2063 6861 6e67 6573 2077 6974 6820  al changes with 
-00010170: 6174 206d 6f73 7420 6f6e 6520 656e 7472  at most one entr
-00010180: 7920 7065 7220 7061 7468 2e0a 0a20 2020  y per path...   
-00010190: 2020 2020 203a 7061 7261 6d20 6465 6c61       :param dela
-000101a0: 793a 2044 656c 6179 2069 6e20 7365 6320  y: Delay in sec 
-000101b0: 746f 2077 6169 7420 666f 7220 7375 6273  to wait for subs
-000101c0: 6571 7565 6e74 2063 6861 6e67 6573 2062  equent changes b
-000101d0: 6566 6f72 6520 7265 7475 726e 696e 672e  efore returning.
-000101e0: 0a20 2020 2020 2020 203a 7265 7475 726e  .        :return
-000101f0: 733a 2028 6c69 7374 206f 6620 7379 6e63  s: (list of sync
-00010200: 2074 696d 6573 2065 7665 6e74 732c 2074   times events, t
-00010210: 696d 655f 7374 616d 7029 0a20 2020 2020  ime_stamp).     
-00010220: 2020 2022 2222 0a20 2020 2020 2020 2065     """.        e
-00010230: 7665 6e74 7320 3d20 5b5d 0a20 2020 2020  vents = [].     
-00010240: 2020 206c 6f63 616c 5f63 7572 736f 7220     local_cursor 
-00010250: 3d20 7469 6d65 2e74 696d 6528 290a 0a20  = time.time().. 
-00010260: 2020 2020 2020 2023 204b 6565 7020 636f         # Keep co
-00010270: 6c6c 6563 7469 6e67 2065 7665 6e74 7320  llecting events 
-00010280: 756e 7469 6c20 6964 6c65 2066 6f72 2060  until idle for `
-00010290: 6465 6c61 7960 2e0a 2020 2020 2020 2020  delay`..        
-000102a0: 7768 696c 6520 5472 7565 3a0a 2020 2020  while True:.    
-000102b0: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
-000102c0: 2020 2020 2020 2020 2020 2020 2065 7665               eve
-000102d0: 6e74 203d 2073 656c 662e 6673 5f65 7665  nt = self.fs_eve
-000102e0: 6e74 732e 6c6f 6361 6c5f 6669 6c65 5f65  nts.local_file_e
-000102f0: 7665 6e74 5f71 7565 7565 2e67 6574 2874  vent_queue.get(t
-00010300: 696d 656f 7574 3d64 656c 6179 290a 2020  imeout=delay).  
-00010310: 2020 2020 2020 2020 2020 2020 2020 6576                ev
-00010320: 656e 7473 2e61 7070 656e 6428 6576 656e  ents.append(even
-00010330: 7429 0a20 2020 2020 2020 2020 2020 2020  t).             
-00010340: 2020 206c 6f63 616c 5f63 7572 736f 7220     local_cursor 
-00010350: 3d20 7469 6d65 2e74 696d 6528 290a 2020  = time.time().  
-00010360: 2020 2020 2020 2020 2020 6578 6365 7074            except
-00010370: 2045 6d70 7479 3a0a 2020 2020 2020 2020   Empty:.        
-00010380: 2020 2020 2020 2020 6272 6561 6b0a 0a20          break.. 
-00010390: 2020 2020 2020 2073 656c 662e 5f6c 6f67         self._log
-000103a0: 6765 722e 6465 6275 6728 2252 6574 7269  ger.debug("Retri
-000103b0: 6576 6564 206c 6f63 616c 2066 696c 6520  eved local file 
-000103c0: 6576 656e 7473 3a5c 6e25 7322 2c20 7066  events:\n%s", pf
-000103d0: 5f72 6570 7228 6576 656e 7473 2929 0a0a  _repr(events))..
-000103e0: 2020 2020 2020 2020 6576 656e 7473 203d          events =
-000103f0: 2073 656c 662e 5f63 6c65 616e 5f6c 6f63   self._clean_loc
-00010400: 616c 5f65 7665 6e74 7328 6576 656e 7473  al_events(events
-00010410: 290a 2020 2020 2020 2020 7379 6e63 5f65  ).        sync_e
-00010420: 7665 6e74 7320 3d20 7365 6c66 2e5f 7379  vents = self._sy
-00010430: 6e63 5f65 7665 6e74 735f 6672 6f6d 5f66  nc_events_from_f
-00010440: 735f 6576 656e 7473 2865 7665 6e74 7329  s_events(events)
-00010450: 0a0a 2020 2020 2020 2020 2320 4672 6565  ..        # Free
-00010460: 206d 656d 6f72 7920 6561 726c 7920 746f   memory early to
-00010470: 2070 7265 7665 6e74 2066 7261 676d 656e   prevent fragmen
-00010480: 7461 7469 6f6e 2e0a 2020 2020 2020 2020  tation..        
-00010490: 6465 6c20 6576 656e 7473 0a20 2020 2020  del events.     
-000104a0: 2020 2067 632e 636f 6c6c 6563 7428 290a     gc.collect().
-000104b0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-000104c0: 7379 6e63 5f65 7665 6e74 732c 206c 6f63  sync_events, loc
-000104d0: 616c 5f63 7572 736f 720a 0a20 2020 2064  al_cursor..    d
-000104e0: 6566 2061 7070 6c79 5f6c 6f63 616c 5f63  ef apply_local_c
-000104f0: 6861 6e67 6573 280a 2020 2020 2020 2020  hanges(.        
-00010500: 7365 6c66 2c20 7379 6e63 5f65 7665 6e74  self, sync_event
-00010510: 733a 2043 6f6c 6c65 6374 696f 6e5b 5379  s: Collection[Sy
-00010520: 6e63 4576 656e 745d 0a20 2020 2029 202d  ncEvent].    ) -
-00010530: 3e20 6c69 7374 5b53 796e 6345 7665 6e74  > list[SyncEvent
-00010540: 5d3a 0a20 2020 2020 2020 2022 2222 0a20  ]:.        """. 
-00010550: 2020 2020 2020 2041 7070 6c69 6573 206c         Applies l
-00010560: 6f63 616c 6c79 2064 6574 6563 7465 6420  ocally detected 
-00010570: 6368 616e 6765 7320 746f 2074 6865 2072  changes to the r
-00010580: 656d 6f74 6520 4472 6f70 626f 782e 2043  emote Dropbox. C
-00010590: 6861 6e67 6573 2077 6869 6368 2073 686f  hanges which sho
-000105a0: 756c 6420 6265 0a20 2020 2020 2020 2069  uld be.        i
-000105b0: 676e 6f72 6564 2028 6d69 676e 6f72 6520  gnored (mignore 
-000105c0: 6f72 2061 6c77 6179 7320 6967 6e6f 7265  or always ignore
-000105d0: 6420 6669 6c65 7329 2061 7265 2073 6b69  d files) are ski
-000105e0: 7070 6564 2e0a 0a20 2020 2020 2020 203a  pped...        :
-000105f0: 7061 7261 6d20 7379 6e63 5f65 7665 6e74  param sync_event
-00010600: 733a 204c 6973 7420 6f66 206c 6f63 616c  s: List of local
-00010610: 2066 696c 6520 7379 7374 656d 2065 7665   file system eve
-00010620: 6e74 732e 0a20 2020 2020 2020 2022 2222  nts..        """
-00010630: 0a20 2020 2020 2020 2072 6573 756c 7473  .        results
-00010640: 3a20 6c69 7374 5b53 796e 6345 7665 6e74  : list[SyncEvent
-00010650: 5d20 3d20 5b5d 0a0a 2020 2020 2020 2020  ] = []..        
-00010660: 6966 206c 656e 2873 796e 635f 6576 656e  if len(sync_even
-00010670: 7473 2920 3d3d 2030 3a0a 2020 2020 2020  ts) == 0:.      
-00010680: 2020 2020 2020 7265 7475 726e 2072 6573        return res
-00010690: 756c 7473 0a0a 2020 2020 2020 2020 2320  ults..        # 
-000106a0: 536f 7274 2061 6c6c 2073 796e 6320 6576  Sort all sync ev
-000106b0: 656e 7473 2069 6e74 6f20 6465 6c65 7465  ents into delete
-000106c0: 642c 2064 6972 5f6d 6f76 6564 2061 6e64  d, dir_moved and
-000106d0: 206f 7468 6572 2e20 4469 7363 6172 6420   other. Discard 
-000106e0: 6974 656d 730a 2020 2020 2020 2020 2320  items.        # 
-000106f0: 7768 6963 6820 6172 6520 6578 636c 7564  which are exclud
-00010700: 6564 2062 7920 6d69 676e 6f72 6520 6f72  ed by mignore or
-00010710: 2074 6865 2069 6e74 6572 6e61 6c20 6578   the internal ex
-00010720: 636c 7573 696f 6e20 6c69 7374 2e20 4465  clusion list. De
-00010730: 6c65 7465 6420 616e 640a 2020 2020 2020  leted and.      
-00010740: 2020 2320 6469 725f 6d6f 7665 6420 6576    # dir_moved ev
-00010750: 656e 7473 2077 696c 6c20 6e65 7665 7220  ents will never 
-00010760: 6265 206e 6573 7465 6420 2877 6520 6861  be nested (we ha
-00010770: 7665 2061 6c72 6561 6479 2063 6f6d 6269  ve already combi
-00010780: 6e65 6420 7375 6368 206e 6573 7465 640a  ned such nested.
-00010790: 2020 2020 2020 2020 2320 6576 656e 7473          # events
-000107a0: 2920 6275 7420 616c 6c20 6f74 6865 7220  ) but all other 
-000107b0: 6576 656e 7473 206d 6967 6874 2062 652e  events might be.
-000107c0: 2057 6520 6f72 6465 7220 616e 6420 6170   We order and ap
-000107d0: 706c 7920 7468 656d 2068 6965 7261 7263  ply them hierarc
-000107e0: 6869 6361 6c6c 792e 0a0a 2020 2020 2020  hically...      
-000107f0: 2020 6465 6c65 7465 643a 206c 6973 745b    deleted: list[
-00010800: 5379 6e63 4576 656e 745d 203d 205b 5d0a  SyncEvent] = [].
-00010810: 2020 2020 2020 2020 6469 725f 6d6f 7665          dir_move
-00010820: 643a 206c 6973 745b 5379 6e63 4576 656e  d: list[SyncEven
-00010830: 745d 203d 205b 5d0a 2020 2020 2020 2020  t] = [].        
-00010840: 6f74 6865 723a 2064 6566 6175 6c74 6469  other: defaultdi
-00010850: 6374 5b69 6e74 2c20 6c69 7374 5b53 796e  ct[int, list[Syn
-00010860: 6345 7665 6e74 5d5d 203d 2064 6566 6175  cEvent]] = defau
-00010870: 6c74 6469 6374 286c 6973 7429 0a0a 2020  ltdict(list)..  
-00010880: 2020 2020 2020 666f 7220 6576 656e 7420        for event 
-00010890: 696e 2073 796e 635f 6576 656e 7473 3a0a  in sync_events:.
-000108a0: 2020 2020 2020 2020 2020 2020 6966 2073              if s
-000108b0: 656c 662e 6973 5f65 7863 6c75 6465 6428  elf.is_excluded(
-000108c0: 6576 656e 742e 6c6f 6361 6c5f 7061 7468  event.local_path
-000108d0: 2920 6f72 2073 656c 662e 6973 5f6d 6967  ) or self.is_mig
-000108e0: 6e6f 7265 2865 7665 6e74 293a 0a20 2020  nore(event):.   
-000108f0: 2020 2020 2020 2020 2020 2020 2063 6f6e               con
-00010900: 7469 6e75 650a 0a20 2020 2020 2020 2020  tinue..         
-00010910: 2020 2069 6620 6576 656e 742e 6973 5f64     if event.is_d
-00010920: 656c 6574 6564 3a0a 2020 2020 2020 2020  eleted:.        
-00010930: 2020 2020 2020 2020 6465 6c65 7465 642e          deleted.
-00010940: 6170 7065 6e64 2865 7665 6e74 290a 2020  append(event).  
-00010950: 2020 2020 2020 2020 2020 656c 6966 2065            elif e
-00010960: 7665 6e74 2e69 735f 6469 7265 6374 6f72  vent.is_director
-00010970: 7920 616e 6420 6576 656e 742e 6973 5f6d  y and event.is_m
-00010980: 6f76 6564 3a0a 2020 2020 2020 2020 2020  oved:.          
-00010990: 2020 2020 2020 6469 725f 6d6f 7665 642e        dir_moved.
-000109a0: 6170 7065 6e64 2865 7665 6e74 290a 2020  append(event).  
-000109b0: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
-000109c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000109d0: 6c65 7665 6c20 3d20 6576 656e 742e 6462  level = event.db
-000109e0: 785f 7061 7468 2e63 6f75 6e74 2822 2f22  x_path.count("/"
-000109f0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00010a00: 2020 6f74 6865 725b 6c65 7665 6c5d 2e61    other[level].a
-00010a10: 7070 656e 6428 6576 656e 7429 0a0a 2020  ppend(event)..  
-00010a20: 2020 2020 2020 2020 2020 2320 486f 7573            # Hous
-00010a30: 656b 6565 7069 6e67 2e0a 2020 2020 2020  ekeeping..      
-00010a40: 2020 2020 2020 7365 6c66 2e61 6374 6976        self.activ
-00010a50: 6974 792e 6164 6428 6576 656e 7429 0a0a  ity.add(event)..
-00010a60: 2020 2020 2020 2020 7365 6c66 2e5f 6c6f          self._lo
-00010a70: 6767 6572 2e64 6562 7567 2822 4669 6c74  gger.debug("Filt
-00010a80: 6572 6564 2064 656c 6574 6564 2065 7665  ered deleted eve
-00010a90: 6e74 733a 5c6e 2573 222c 2070 665f 7265  nts:\n%s", pf_re
-00010aa0: 7072 2864 656c 6574 6564 2929 0a20 2020  pr(deleted)).   
-00010ab0: 2020 2020 2073 656c 662e 5f6c 6f67 6765       self._logge
-00010ac0: 722e 6465 6275 6728 2246 696c 7465 7265  r.debug("Filtere
-00010ad0: 6420 6469 7220 6d6f 7665 6420 6576 656e  d dir moved even
-00010ae0: 7473 3a5c 6e25 7322 2c20 7066 5f72 6570  ts:\n%s", pf_rep
-00010af0: 7228 6469 725f 6d6f 7665 6429 290a 2020  r(dir_moved)).  
-00010b00: 2020 2020 2020 7365 6c66 2e5f 6c6f 6767        self._logg
-00010b10: 6572 2e64 6562 7567 2822 4669 6c74 6572  er.debug("Filter
-00010b20: 6564 206f 7468 6572 2065 7665 6e74 733a  ed other events:
-00010b30: 5c6e 2573 222c 2070 665f 7265 7072 286f  \n%s", pf_repr(o
-00010b40: 7468 6572 2929 0a0a 2020 2020 2020 2020  ther))..        
-00010b50: 2320 4170 706c 7920 6465 6c65 7465 6420  # Apply deleted 
-00010b60: 6576 656e 7473 2066 6972 7374 2c20 666f  events first, fo
-00010b70: 6c64 6572 206d 6f76 6564 2065 7665 6e74  lder moved event
-00010b80: 7320 7365 636f 6e64 2e0a 2020 2020 2020  s second..      
-00010b90: 2020 2320 4e65 6974 6865 7220 6576 656e    # Neither even
-00010ba0: 7420 7479 7065 2072 6571 7569 7265 7320  t type requires 
-00010bb0: 616e 2061 6374 7561 6c20 7570 6c6f 6164  an actual upload
-00010bc0: 2e0a 2020 2020 2020 2020 6966 2064 656c  ..        if del
-00010bd0: 6574 6564 3a0a 2020 2020 2020 2020 2020  eted:.          
-00010be0: 2020 7365 6c66 2e5f 6c6f 6767 6572 2e69    self._logger.i
-00010bf0: 6e66 6f28 2255 706c 6f61 6469 6e67 2064  nfo("Uploading d
-00010c00: 656c 6574 696f 6e73 2e2e 2e22 290a 0a20  eletions...").. 
-00010c10: 2020 2020 2020 2072 6573 203d 2064 6f5f         res = do_
-00010c20: 7061 7261 6c6c 656c 280a 2020 2020 2020  parallel(.      
-00010c30: 2020 2020 2020 7365 6c66 2e5f 6372 6561        self._crea
-00010c40: 7465 5f72 656d 6f74 655f 656e 7472 792c  te_remote_entry,
-00010c50: 0a20 2020 2020 2020 2020 2020 2064 656c  .            del
-00010c60: 6574 6564 2c0a 2020 2020 2020 2020 2020  eted,.          
-00010c70: 2020 6f6e 5f70 726f 6772 6573 733d 6c61    on_progress=la
-00010c80: 6d62 6461 2078 2c20 793a 2073 656c 662e  mbda x, y: self.
-00010c90: 5f6c 6f67 6765 722e 696e 666f 2866 2244  _logger.info(f"D
-00010ca0: 656c 6574 696e 6720 7b78 7d2f 7b79 7d22  eleting {x}/{y}"
-00010cb0: 292c 0a20 2020 2020 2020 2020 2020 2074  ),.            t
-00010cc0: 6872 6561 645f 6e61 6d65 5f70 7265 6669  hread_name_prefi
-00010cd0: 783d 226d 6165 7374 7261 6c2d 7570 6c6f  x="maestral-uplo
-00010ce0: 6164 2d70 6f6f 6c22 2c0a 2020 2020 2020  ad-pool",.      
-00010cf0: 2020 290a 2020 2020 2020 2020 7265 7375    ).        resu
-00010d00: 6c74 732e 6578 7465 6e64 2872 6573 290a  lts.extend(res).
-00010d10: 0a20 2020 2020 2020 2069 6620 6469 725f  .        if dir_
-00010d20: 6d6f 7665 643a 0a20 2020 2020 2020 2020  moved:.         
-00010d30: 2020 2073 656c 662e 5f6c 6f67 6765 722e     self._logger.
-00010d40: 696e 666f 2822 4d6f 7669 6e67 2066 6f6c  info("Moving fol
-00010d50: 6465 7273 2e2e 2e22 290a 0a20 2020 2020  ders...")..     
-00010d60: 2020 2066 6f72 2065 7665 6e74 2069 6e20     for event in 
-00010d70: 6469 725f 6d6f 7665 643a 0a20 2020 2020  dir_moved:.     
-00010d80: 2020 2020 2020 2073 656c 662e 5f6c 6f67         self._log
-00010d90: 6765 722e 696e 666f 2866 224d 6f76 696e  ger.info(f"Movin
-00010da0: 6720 7b65 7665 6e74 2e64 6278 5f70 6174  g {event.dbx_pat
-00010db0: 685f 6672 6f6d 7d22 290a 2020 2020 2020  h_from}").      
-00010dc0: 2020 2020 2020 7220 3d20 7365 6c66 2e5f        r = self._
-00010dd0: 6372 6561 7465 5f72 656d 6f74 655f 656e  create_remote_en
-00010de0: 7472 7928 6576 656e 7429 0a20 2020 2020  try(event).     
-00010df0: 2020 2020 2020 2072 6573 756c 7473 2e61         results.a
-00010e00: 7070 656e 6428 7229 0a0a 2020 2020 2020  ppend(r)..      
-00010e10: 2020 2320 4170 706c 7920 6f74 6865 7220    # Apply other 
-00010e20: 6576 656e 7473 2069 6e20 7061 7261 6c6c  events in parall
-00010e30: 656c 2c20 7072 6f63 6573 7369 6e67 2065  el, processing e
-00010e40: 6163 6820 6869 6572 6172 6368 7920 6c65  ach hierarchy le
-00010e50: 7665 6c20 7375 6363 6573 7369 7665 6c79  vel successively
-00010e60: 2e0a 2020 2020 2020 2020 666f 7220 6c65  ..        for le
-00010e70: 7665 6c20 696e 2073 6f72 7465 6428 6f74  vel in sorted(ot
-00010e80: 6865 7229 3a0a 2020 2020 2020 2020 2020  her):.          
-00010e90: 2020 7265 7320 3d20 646f 5f70 6172 616c    res = do_paral
-00010ea0: 6c65 6c28 0a20 2020 2020 2020 2020 2020  lel(.           
-00010eb0: 2020 2020 2073 656c 662e 5f63 7265 6174       self._creat
-00010ec0: 655f 7265 6d6f 7465 5f65 6e74 7279 2c0a  e_remote_entry,.
-00010ed0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010ee0: 6f74 6865 725b 6c65 7665 6c5d 2c0a 2020  other[level],.  
-00010ef0: 2020 2020 2020 2020 2020 2020 2020 6f6e                on
-00010f00: 5f70 726f 6772 6573 733d 6c61 6d62 6461  _progress=lambda
-00010f10: 2078 2c20 793a 2073 656c 662e 5f6c 6f67   x, y: self._log
-00010f20: 6765 722e 696e 666f 2866 2253 796e 6369  ger.info(f"Synci
-00010f30: 6e67 20e2 8691 207b 787d 2f7b 797d 2229  ng ... {x}/{y}")
-00010f40: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00010f50: 2020 7468 7265 6164 5f6e 616d 655f 7072    thread_name_pr
-00010f60: 6566 6978 3d22 6d61 6573 7472 616c 2d75  efix="maestral-u
-00010f70: 706c 6f61 642d 706f 6f6c 222c 0a20 2020  pload-pool",.   
-00010f80: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
-00010f90: 2020 2020 2020 2072 6573 756c 7473 2e65         results.e
-00010fa0: 7874 656e 6428 7265 7329 0a0a 2020 2020  xtend(res)..    
-00010fb0: 2020 2020 7365 6c66 2e5f 636c 6561 6e5f      self._clean_
-00010fc0: 6869 7374 6f72 7928 290a 0a20 2020 2020  history()..     
-00010fd0: 2020 2072 6574 7572 6e20 7265 7375 6c74     return result
-00010fe0: 730a 0a20 2020 2064 6566 205f 636c 6561  s..    def _clea
-00010ff0: 6e5f 6c6f 6361 6c5f 6576 656e 7473 280a  n_local_events(.
-00011000: 2020 2020 2020 2020 7365 6c66 2c20 6576          self, ev
-00011010: 656e 7473 3a20 436f 6c6c 6563 7469 6f6e  ents: Collection
-00011020: 5b46 696c 6553 7973 7465 6d45 7665 6e74  [FileSystemEvent
-00011030: 5d0a 2020 2020 2920 2d3e 206c 6973 745b  ].    ) -> list[
-00011040: 4669 6c65 5379 7374 656d 4576 656e 745d  FileSystemEvent]
-00011050: 3a0a 2020 2020 2020 2020 2222 220a 2020  :.        """.  
-00011060: 2020 2020 2020 5461 6b65 7320 6c6f 6361        Takes loca
-00011070: 6c20 6669 6c65 2065 7665 6e74 7320 616e  l file events an
-00011080: 6420 636c 6561 6e73 2074 6865 6d20 7570  d cleans them up
-00011090: 2061 7320 666f 6c6c 6f77 733a 0a0a 2020   as follows:..  
-000110a0: 2020 2020 2020 3129 204b 6565 7020 6f6e        1) Keep on
-000110b0: 6c79 2061 2073 696e 676c 6520 6576 656e  ly a single even
-000110c0: 7420 7065 7220 7061 7468 2c20 756e 6c65  t per path, unle
-000110d0: 7373 2074 6865 2069 7465 6d20 7479 7065  ss the item type
-000110e0: 2063 6861 6e67 6564 2028 652e 672e 2c20   changed (e.g., 
-000110f0: 6672 6f6d 0a20 2020 2020 2020 2020 2020  from.           
-00011100: 6669 6c65 2074 6f20 666f 6c64 6572 292e  file to folder).
-00011110: 0a20 2020 2020 2020 2032 2920 436f 6c6c  .        2) Coll
-00011120: 6170 7365 7320 6d6f 7665 6420 616e 6420  apses moved and 
-00011130: 6465 6c65 7465 6420 6576 656e 7473 206f  deleted events o
-00011140: 6620 666f 6c64 6572 7320 7769 7468 2074  f folders with t
-00011150: 686f 7365 206f 6620 7468 6569 7220 6368  hose of their ch
-00011160: 696c 6472 656e 2e0a 0a20 2020 2020 2020  ildren...       
-00011170: 2054 6865 206f 7264 6572 206f 6620 6576   The order of ev
-00011180: 656e 7473 2077 696c 6c20 6265 2070 7265  ents will be pre
-00011190: 7365 7276 6564 2061 6363 6f72 6469 6e67  served according
-000111a0: 2074 6f20 7468 6520 6669 7273 7420 6576   to the first ev
-000111b0: 656e 7420 7265 6769 7374 6572 6564 0a20  ent registered. 
-000111c0: 2020 2020 2020 2066 6f72 2074 6861 7420         for that 
-000111d0: 7061 7468 2e0a 0a20 2020 2020 2020 203a  path...        :
-000111e0: 7061 7261 6d20 6576 656e 7473 3a20 4974  param events: It
-000111f0: 6572 6162 6c65 206f 6620 3a63 6c61 7373  erable of :class
-00011200: 3a60 7761 7463 6864 6f67 2e46 696c 6553  :`watchdog.FileS
-00011210: 7973 7465 6d45 7665 6e74 602e 0a20 2020  ystemEvent`..   
-00011220: 2020 2020 203a 7265 7475 726e 733a 204c       :returns: L
-00011230: 6973 7420 6f66 203a 636c 6173 733a 6077  ist of :class:`w
-00011240: 6174 6368 646f 672e 4669 6c65 5379 7374  atchdog.FileSyst
-00011250: 656d 4576 656e 7460 2e0a 2020 2020 2020  emEvent`..      
-00011260: 2020 2222 220a 2020 2020 2020 2020 2320    """.        # 
-00011270: 434f 4d42 494e 4520 4556 454e 5453 2054  COMBINE EVENTS T
-00011280: 4f20 4f4e 4520 4556 454e 5420 5045 5220  O ONE EVENT PER 
-00011290: 5041 5448 0a0a 2020 2020 2020 2020 2320  PATH..        # 
-000112a0: 4d6f 7665 2065 7665 6e74 7320 6172 6520  Move events are 
-000112b0: 6469 6666 6963 756c 7420 746f 2063 6f6d  difficult to com
-000112c0: 6269 6e65 2077 6974 6820 6f74 6865 7220  bine with other 
-000112d0: 6576 656e 7420 7479 7065 732c 2077 6520  event types, we 
-000112e0: 7370 6c69 7420 7468 656d 0a20 2020 2020  split them.     
-000112f0: 2020 2023 2069 6e74 6f20 6465 6c65 7465     # into delete
-00011300: 6420 616e 6420 6372 6561 7465 6420 6576  d and created ev
-00011310: 656e 7473 2061 6e64 2072 6563 6f6d 6269  ents and recombi
-00011320: 6e65 2074 6865 6d20 6c61 7465 7220 6966  ne them later if
-00011330: 206e 6569 7468 6572 2074 6865 2073 6f75   neither the sou
-00011340: 7263 650a 2020 2020 2020 2020 2320 6f66  rce.        # of
-00011350: 2074 6865 2064 6573 7469 6e61 7469 6f6e   the destination
-00011360: 2070 6174 6820 6f66 2068 6173 206f 7468   path of has oth
-00011370: 6572 2065 7665 6e74 7320 6173 736f 6369  er events associ
-00011380: 6174 6564 2077 6974 6820 6974 206f 7220  ated with it or 
-00011390: 6973 2065 7863 6c75 6465 640a 2020 2020  is excluded.    
-000113a0: 2020 2020 2320 6672 6f6d 2073 796e 632e      # from sync.
-000113b0: 0a0a 2020 2020 2020 2020 2320 6d61 7070  ..        # mapp
-000113c0: 696e 6720 6f66 2070 6174 6820 2d3e 2065  ing of path -> e
-000113d0: 7665 6e74 2068 6973 746f 7279 0a20 2020  vent history.   
-000113e0: 2020 2020 2065 7665 6e74 735f 666f 725f       events_for_
-000113f0: 7061 7468 3a20 6465 6661 756c 7464 6963  path: defaultdic
-00011400: 745b 7374 722c 206c 6973 745b 4669 6c65  t[str, list[File
-00011410: 5379 7374 656d 4576 656e 745d 5d20 3d20  SystemEvent]] = 
-00011420: 6465 6661 756c 7464 6963 7428 6c69 7374  defaultdict(list
-00011430: 290a 0a20 2020 2020 2020 2023 206d 6170  )..        # map
-00011440: 7069 6e67 206f 6620 736f 7572 6365 2064  ping of source d
-00011450: 656c 6574 696f 6e20 6576 656e 7420 2d3e  eletion event ->
-00011460: 2064 6573 7469 6e61 7469 6f6e 2063 7265   destination cre
-00011470: 6174 696f 6e20 6576 656e 740a 2020 2020  ation event.    
-00011480: 2020 2020 6d6f 7665 645f 6672 6f6d 5f74      moved_from_t
-00011490: 6f3a 2064 6963 745b 4669 6c65 5379 7374  o: dict[FileSyst
-000114a0: 656d 4576 656e 742c 2046 696c 6553 7973  emEvent, FileSys
-000114b0: 7465 6d45 7665 6e74 5d20 3d20 7b7d 0a20  temEvent] = {}. 
-000114c0: 2020 2020 2020 206d 6f76 6564 5f65 7665         moved_eve
-000114d0: 6e74 735f 746f 5f72 6563 6f6d 6269 6e65  nts_to_recombine
-000114e0: 3a20 6c69 7374 5b46 696c 6553 7973 7465  : list[FileSyste
-000114f0: 6d45 7665 6e74 5d20 3d20 5b5d 0a0a 2020  mEvent] = []..  
-00011500: 2020 2020 2020 666f 7220 6576 656e 7420        for event 
-00011510: 696e 2065 7665 6e74 733a 0a20 2020 2020  in events:.     
-00011520: 2020 2020 2020 2069 6620 6973 5f6d 6f76         if is_mov
-00011530: 6564 2865 7665 6e74 293a 0a20 2020 2020  ed(event):.     
-00011540: 2020 2020 2020 2020 2020 2064 656c 6574             delet
-00011550: 6564 2c20 6372 6561 7465 6420 3d20 7370  ed, created = sp
-00011560: 6c69 745f 6d6f 7665 645f 6576 656e 7428  lit_moved_event(
-00011570: 6576 656e 7429 0a20 2020 2020 2020 2020  event).         
-00011580: 2020 2020 2020 206d 6f76 6564 5f66 726f         moved_fro
-00011590: 6d5f 746f 5b64 656c 6574 6564 5d20 3d20  m_to[deleted] = 
-000115a0: 6372 6561 7465 640a 0a20 2020 2020 2020  created..       
-000115b0: 2020 2020 2020 2020 2065 7665 6e74 735f           events_
-000115c0: 666f 725f 7061 7468 5b64 656c 6574 6564  for_path[deleted
-000115d0: 2e73 7263 5f70 6174 685d 2e61 7070 656e  .src_path].appen
-000115e0: 6428 6465 6c65 7465 6429 0a20 2020 2020  d(deleted).     
-000115f0: 2020 2020 2020 2020 2020 2065 7665 6e74             event
-00011600: 735f 666f 725f 7061 7468 5b63 7265 6174  s_for_path[creat
-00011610: 6564 2e73 7263 5f70 6174 685d 2e61 7070  ed.src_path].app
-00011620: 656e 6428 6372 6561 7465 6429 0a20 2020  end(created).   
-00011630: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
-00011640: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-00011650: 7665 6e74 735f 666f 725f 7061 7468 5b65  vents_for_path[e
-00011660: 7665 6e74 2e73 7263 5f70 6174 685d 2e61  vent.src_path].a
-00011670: 7070 656e 6428 6576 656e 7429 0a0a 2020  ppend(event)..  
-00011680: 2020 2020 2020 2320 466f 7220 6576 6572        # For ever
-00011690: 7920 7061 7468 2c20 6b65 6570 206f 6e6c  y path, keep onl
-000116a0: 7920 6120 7369 6e67 6c65 2065 7665 6e74  y a single event
-000116b0: 2077 6869 6368 2072 6570 7265 7365 6e74   which represent
-000116c0: 7320 616c 6c20 6368 616e 6765 732c 0a20  s all changes,. 
-000116d0: 2020 2020 2020 2023 2075 6e6c 6573 7320         # unless 
-000116e0: 7765 2064 6561 6c20 7769 7468 2061 2074  we deal with a t
-000116f0: 7970 6520 6368 616e 6765 2e0a 2020 2020  ype change..    
-00011700: 2020 2020 666f 7220 7061 7468 2069 6e20      for path in 
-00011710: 6c69 7374 2865 7665 6e74 735f 666f 725f  list(events_for_
-00011720: 7061 7468 293a 0a20 2020 2020 2020 2020  path):.         
-00011730: 2020 2065 7665 6e74 7320 3d20 6576 656e     events = even
-00011740: 7473 5f66 6f72 5f70 6174 685b 7061 7468  ts_for_path[path
-00011750: 5d0a 0a20 2020 2020 2020 2020 2020 2069  ]..            i
-00011760: 6620 6c65 6e28 6576 656e 7473 2920 3d3d  f len(events) ==
-00011770: 2031 3a0a 2020 2020 2020 2020 2020 2020   1:.            
-00011780: 2020 2020 6576 656e 7420 3d20 6576 656e      event = even
-00011790: 7473 5b30 5d0a 2020 2020 2020 2020 2020  ts[0].          
-000117a0: 2020 2020 2020 2320 4d61 726b 206d 6f76        # Mark mov
-000117b0: 6564 2065 7665 6e74 7320 6966 2074 6865  ed events if the
-000117c0: 7265 2069 7320 6120 7369 6e67 6c65 2065  re is a single e
-000117d0: 7665 6e74 206f 6e6c 7920 6174 2074 6865  vent only at the
-000117e0: 2073 7263 0a20 2020 2020 2020 2020 2020   src.           
-000117f0: 2020 2020 2023 2061 6e64 2064 6573 7420       # and dest 
-00011800: 7061 7468 732c 2074 6f20 6265 2072 6563  paths, to be rec
-00011810: 6f6d 6269 6e65 6420 6c61 7465 722e 0a20  ombined later.. 
-00011820: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00011830: 6620 6576 656e 7420 696e 206d 6f76 6564  f event in moved
-00011840: 5f66 726f 6d5f 746f 3a0a 2020 2020 2020  _from_to:.      
-00011850: 2020 2020 2020 2020 2020 2020 2020 6465                de
-00011860: 7374 5f70 6174 6820 3d20 6d6f 7665 645f  st_path = moved_
-00011870: 6672 6f6d 5f74 6f5b 6576 656e 745d 2e73  from_to[event].s
-00011880: 7263 5f70 6174 680a 2020 2020 2020 2020  rc_path.        
-00011890: 2020 2020 2020 2020 2020 2020 6966 206c              if l
-000118a0: 656e 2865 7665 6e74 735f 666f 725f 7061  en(events_for_pa
-000118b0: 7468 5b64 6573 745f 7061 7468 5d29 203d  th[dest_path]) =
-000118c0: 3d20 313a 0a20 2020 2020 2020 2020 2020  = 1:.           
-000118d0: 2020 2020 2020 2020 2020 2020 206d 6f76               mov
-000118e0: 6564 5f65 7665 6e74 735f 746f 5f72 6563  ed_events_to_rec
-000118f0: 6f6d 6269 6e65 2e61 7070 656e 6428 6576  ombine.append(ev
-00011900: 656e 7429 0a0a 2020 2020 2020 2020 2020  ent)..          
-00011910: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-00011920: 2020 2020 2020 2020 2320 436f 756e 7420          # Count 
-00011930: 686f 7720 6f66 7465 6e20 7468 6520 6669  how often the fi
-00011940: 6c65 202f 2066 6f6c 6465 7220 7761 7320  le / folder was 
-00011950: 6372 6561 7465 6420 7673 2064 656c 6574  created vs delet
-00011960: 6564 2e0a 2020 2020 2020 2020 2020 2020  ed..            
-00011970: 2020 2020 2320 5265 6d65 6d62 6572 2069      # Remember i
-00011980: 6620 6974 2077 6173 2066 6972 7374 2063  f it was first c
-00011990: 7265 6174 6564 206f 7220 6465 6c65 7465  reated or delete
-000119a0: 642e 0a0a 2020 2020 2020 2020 2020 2020  d...            
-000119b0: 2020 2020 6e5f 6372 6561 7465 6420 3d20      n_created = 
-000119c0: 300a 2020 2020 2020 2020 2020 2020 2020  0.              
-000119d0: 2020 6e5f 6465 6c65 7465 6420 3d20 300a    n_deleted = 0.
-000119e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000119f0: 2066 6972 7374 5f63 7265 6174 6564 5f69   first_created_i
-00011a00: 6e64 6578 203d 202d 310a 2020 2020 2020  ndex = -1.      
-00011a10: 2020 2020 2020 2020 2020 6669 7273 745f            first_
-00011a20: 6465 6c65 7465 645f 696e 6465 7820 3d20  deleted_index = 
-00011a30: 2d31 0a0a 2020 2020 2020 2020 2020 2020  -1..            
-00011a40: 2020 2020 666f 7220 6920 696e 2072 6576      for i in rev
-00011a50: 6572 7365 6428 7261 6e67 6528 6c65 6e28  ersed(range(len(
-00011a60: 6576 656e 7473 2929 293a 0a20 2020 2020  events))):.     
-00011a70: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-00011a80: 7665 6e74 203d 2065 7665 6e74 735b 695d  vent = events[i]
-00011a90: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
-00011aa0: 2020 2020 2020 6966 2069 735f 6372 6561        if is_crea
-00011ab0: 7465 6428 6576 656e 7429 3a0a 2020 2020  ted(event):.    
-00011ac0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011ad0: 2020 2020 6e5f 6372 6561 7465 6420 2b3d      n_created +=
-00011ae0: 2031 0a20 2020 2020 2020 2020 2020 2020   1.             
-00011af0: 2020 2020 2020 2020 2020 2066 6972 7374             first
-00011b00: 5f63 7265 6174 6564 5f69 6e64 6578 203d  _created_index =
-00011b10: 2069 0a0a 2020 2020 2020 2020 2020 2020   i..            
-00011b20: 2020 2020 2020 2020 6966 2069 735f 6465          if is_de
-00011b30: 6c65 7465 6428 6576 656e 7429 3a0a 2020  leted(event):.  
-00011b40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011b50: 2020 2020 2020 6e5f 6465 6c65 7465 6420        n_deleted 
-00011b60: 2b3d 2031 0a20 2020 2020 2020 2020 2020  += 1.           
-00011b70: 2020 2020 2020 2020 2020 2020 2066 6972               fir
-00011b80: 7374 5f64 656c 6574 6564 5f69 6e64 6578  st_deleted_index
-00011b90: 203d 2069 0a0a 2020 2020 2020 2020 2020   = i..          
-00011ba0: 2020 2020 2020 6966 206e 5f63 7265 6174        if n_creat
-00011bb0: 6564 203e 206e 5f64 656c 6574 6564 3a20  ed > n_deleted: 
-00011bc0: 2023 2049 7465 6d20 7761 7320 6372 6561   # Item was crea
-00011bd0: 7465 642e 0a20 2020 2020 2020 2020 2020  ted..           
-00011be0: 2020 2020 2020 2020 2069 6620 6576 656e           if even
-00011bf0: 7473 5b2d 315d 2e69 735f 6469 7265 6374  ts[-1].is_direct
-00011c00: 6f72 793a 0a20 2020 2020 2020 2020 2020  ory:.           
-00011c10: 2020 2020 2020 2020 2020 2020 2065 7665               eve
-00011c20: 6e74 735f 666f 725f 7061 7468 5b70 6174  nts_for_path[pat
-00011c30: 685d 203d 205b 4469 7243 7265 6174 6564  h] = [DirCreated
-00011c40: 4576 656e 7428 7061 7468 295d 0a20 2020  Event(path)].   
-00011c50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011c60: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-00011c70: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-00011c80: 7665 6e74 735f 666f 725f 7061 7468 5b70  vents_for_path[p
-00011c90: 6174 685d 203d 205b 4669 6c65 4372 6561  ath] = [FileCrea
-00011ca0: 7465 6445 7665 6e74 2870 6174 6829 5d0a  tedEvent(path)].
-00011cb0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00011cc0: 2065 6c69 6620 6e5f 6372 6561 7465 6420   elif n_created 
-00011cd0: 3c20 6e5f 6465 6c65 7465 643a 2020 2320  < n_deleted:  # 
-00011ce0: 4974 656d 2077 6173 2064 656c 6574 6564  Item was deleted
-00011cf0: 2e0a 2020 2020 2020 2020 2020 2020 2020  ..              
-00011d00: 2020 2020 2020 6966 2065 7665 6e74 735b        if events[
-00011d10: 305d 2e69 735f 6469 7265 6374 6f72 793a  0].is_directory:
-00011d20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00011d30: 2020 2020 2020 2020 2065 7665 6e74 735f           events_
-00011d40: 666f 725f 7061 7468 5b70 6174 685d 203d  for_path[path] =
-00011d50: 205b 4469 7244 656c 6574 6564 4576 656e   [DirDeletedEven
-00011d60: 7428 7061 7468 295d 0a20 2020 2020 2020  t(path)].       
-00011d70: 2020 2020 2020 2020 2020 2020 2065 6c73               els
-00011d80: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-00011d90: 2020 2020 2020 2020 2020 2065 7665 6e74             event
-00011da0: 735f 666f 725f 7061 7468 5b70 6174 685d  s_for_path[path]
-00011db0: 203d 205b 4669 6c65 4465 6c65 7465 6445   = [FileDeletedE
-00011dc0: 7665 6e74 2870 6174 6829 5d0a 0a20 2020  vent(path)]..   
-00011dd0: 2020 2020 2020 2020 2020 2020 2065 6c73               els
-00011de0: 653a 2020 2320 5361 6d65 206e 756d 6265  e:  # Same numbe
-00011df0: 7220 6f66 2064 656c 6574 6564 2061 6e64  r of deleted and
-00011e00: 2063 7265 6174 6564 2065 7665 6e74 732e   created events.
-00011e10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00011e20: 2020 2020 2069 6620 6e5f 6372 6561 7465       if n_create
-00011e30: 6420 3d3d 2030 206f 7220 6669 7273 745f  d == 0 or first_
-00011e40: 6465 6c65 7465 645f 696e 6465 7820 3c20  deleted_index < 
-00011e50: 6669 7273 745f 6372 6561 7465 645f 696e  first_created_in
-00011e60: 6465 783a 0a20 2020 2020 2020 2020 2020  dex:.           
-00011e70: 2020 2020 2020 2020 2020 2020 2023 2049               # I
-00011e80: 7465 6d20 7761 7320 6d6f 6469 6669 6564  tem was modified
-00011e90: 2e0a 2020 2020 2020 2020 2020 2020 2020  ..              
-00011ea0: 2020 2020 2020 2020 2020 6966 2065 7665            if eve
-00011eb0: 6e74 735b 305d 2e69 735f 6469 7265 6374  nts[0].is_direct
-00011ec0: 6f72 7920 616e 6420 6576 656e 7473 5b2d  ory and events[-
-00011ed0: 315d 2e69 735f 6469 7265 6374 6f72 793a  1].is_directory:
-00011ee0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00011ef0: 2020 2020 2020 2020 2020 2020 2023 2042               # B
-00011f00: 6f74 6820 6669 7273 7420 616e 6420 6c61  oth first and la
-00011f10: 7374 2065 7665 6e74 7320 6172 6520 6672  st events are fr
-00011f20: 6f6d 2066 6f6c 6465 7273 2e0a 2020 2020  om folders..    
-00011f30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011f40: 2020 2020 2020 2020 6576 656e 7473 5f66          events_f
-00011f50: 6f72 5f70 6174 685b 7061 7468 5d20 3d20  or_path[path] = 
-00011f60: 5b44 6972 4d6f 6469 6669 6564 4576 656e  [DirModifiedEven
-00011f70: 7428 7061 7468 295d 0a20 2020 2020 2020  t(path)].       
-00011f80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011f90: 2065 6c69 6620 6e6f 7420 6576 656e 7473   elif not events
-00011fa0: 5b30 5d2e 6973 5f64 6972 6563 746f 7279  [0].is_directory
-00011fb0: 2061 6e64 206e 6f74 2065 7665 6e74 735b   and not events[
-00011fc0: 2d31 5d2e 6973 5f64 6972 6563 746f 7279  -1].is_directory
-00011fd0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00011fe0: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-00011ff0: 426f 7468 2066 6972 7374 2061 6e64 206c  Both first and l
-00012000: 6173 7420 6576 656e 7473 2061 7265 2066  ast events are f
-00012010: 726f 6d20 6669 6c65 732e 0a20 2020 2020  rom files..     
-00012020: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012030: 2020 2020 2020 2065 7665 6e74 735f 666f         events_fo
-00012040: 725f 7061 7468 5b70 6174 685d 203d 205b  r_path[path] = [
-00012050: 4669 6c65 4d6f 6469 6669 6564 4576 656e  FileModifiedEven
-00012060: 7428 7061 7468 295d 0a20 2020 2020 2020  t(path)].       
-00012070: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012080: 2065 6c69 6620 6576 656e 7473 5b30 5d2e   elif events[0].
-00012090: 6973 5f64 6972 6563 746f 7279 3a0a 2020  is_directory:.  
-000120a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000120b0: 2020 2020 2020 2020 2020 2320 5479 7065            # Type
-000120c0: 2063 6861 6e67 6520 666f 6c64 6572 202d   change folder -
-000120d0: 3e20 6669 6c65 2e0a 2020 2020 2020 2020  > file..        
-000120e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000120f0: 2020 2020 6576 656e 7473 5f66 6f72 5f70      events_for_p
-00012100: 6174 685b 7061 7468 5d20 3d20 5b0a 2020  ath[path] = [.  
-00012110: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012120: 2020 2020 2020 2020 2020 2020 2020 4469                Di
-00012130: 7244 656c 6574 6564 4576 656e 7428 7061  rDeletedEvent(pa
-00012140: 7468 292c 0a20 2020 2020 2020 2020 2020  th),.           
-00012150: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012160: 2020 2020 2046 696c 6543 7265 6174 6564       FileCreated
-00012170: 4576 656e 7428 7061 7468 292c 0a20 2020  Event(path),.   
-00012180: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012190: 2020 2020 2020 2020 205d 0a20 2020 2020           ].     
-000121a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000121b0: 2020 2065 6c69 6620 6576 656e 7473 5b2d     elif events[-
-000121c0: 315d 2e69 735f 6469 7265 6374 6f72 793a  1].is_directory:
-000121d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000121e0: 2020 2020 2020 2020 2020 2020 2023 2054               # T
-000121f0: 7970 6520 6368 616e 6765 2066 696c 6520  ype change file 
-00012200: 2d3e 2066 6f6c 6465 722e 0a20 2020 2020  -> folder..     
-00012210: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012220: 2020 2020 2020 2065 7665 6e74 735f 666f         events_fo
-00012230: 725f 7061 7468 5b70 6174 685d 203d 205b  r_path[path] = [
-00012240: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00012250: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012260: 2046 696c 6544 656c 6574 6564 4576 656e   FileDeletedEven
-00012270: 7428 7061 7468 292c 0a20 2020 2020 2020  t(path),.       
-00012280: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012290: 2020 2020 2020 2020 2044 6972 4372 6561           DirCrea
-000122a0: 7465 6445 7665 6e74 2870 6174 6829 2c0a  tedEvent(path),.
-000122b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000122c0: 2020 2020 2020 2020 2020 2020 5d0a 2020              ].  
-000122d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000122e0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-000122f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012300: 2320 4974 656d 2077 6173 206c 696b 656c  # Item was likel
-00012310: 7920 6f6e 6c79 2074 656d 706f 7261 7279  y only temporary
-00012320: 2e20 5765 2073 7469 6c6c 2074 7269 6767  . We still trigg
-00012330: 6572 2061 2072 6573 6361 6e20 6f66 0a20  er a rescan of. 
-00012340: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012350: 2020 2020 2020 2023 2074 6865 2070 6174         # the pat
-00012360: 6820 6265 6361 7573 6520 736f 6d65 2061  h because some a
-00012370: 746f 6d69 6320 6d6f 6469 6669 6361 7469  tomic modificati
-00012380: 6f6e 7320 6d61 7920 6265 2072 6570 6f72  ons may be repor
-00012390: 7465 6420 6173 0a20 2020 2020 2020 2020  ted as.         
-000123a0: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-000123b0: 206f 7574 2d6f 662d 6f72 6465 7220 6372   out-of-order cr
-000123c0: 6561 7465 6420 616e 6420 6465 6c65 7465  eated and delete
-000123d0: 6420 6576 656e 7473 206f 6e20 6d61 634f  d events on macO
-000123e0: 532e 0a20 2020 2020 2020 2020 2020 2020  S..             
-000123f0: 2020 2020 2020 2020 2020 2064 656c 2065             del e
-00012400: 7665 6e74 735f 666f 725f 7061 7468 5b70  vents_for_path[p
-00012410: 6174 685d 0a20 2020 2020 2020 2020 2020  ath].           
-00012420: 2020 2020 2020 2020 2020 2020 2073 656c               sel
-00012430: 662e 7265 7363 616e 2870 6174 6829 0a0a  f.rescan(path)..
-00012440: 2020 2020 2020 2020 2320 5265 636f 6d62          # Recomb
-00012450: 696e 6520 6d6f 7665 6420 6576 656e 7473  ine moved events
-00012460: 2069 6620 7765 2068 6176 6520 7265 7461   if we have reta
-00012470: 696e 6564 2062 6f74 6820 7369 6465 7320  ined both sides 
-00012480: 6f66 2065 7665 6e74 2064 7572 696e 6720  of event during 
-00012490: 7468 650a 2020 2020 2020 2020 2320 6162  the.        # ab
-000124a0: 6f76 6520 636f 6e73 6f6c 6964 6174 696f  ove consolidatio
-000124b0: 6e2e 0a20 2020 2020 2020 2066 6f72 2073  n..        for s
-000124c0: 7263 5f65 7665 6e74 2069 6e20 6d6f 7665  rc_event in move
-000124d0: 645f 6576 656e 7473 5f74 6f5f 7265 636f  d_events_to_reco
-000124e0: 6d62 696e 653a 0a20 2020 2020 2020 2020  mbine:.         
-000124f0: 2020 2073 7263 5f70 6174 6820 3d20 7372     src_path = sr
-00012500: 635f 6576 656e 742e 7372 635f 7061 7468  c_event.src_path
-00012510: 0a20 2020 2020 2020 2020 2020 2064 6573  .            des
-00012520: 745f 7061 7468 203d 206d 6f76 6564 5f66  t_path = moved_f
-00012530: 726f 6d5f 746f 5b73 7263 5f65 7665 6e74  rom_to[src_event
-00012540: 5d2e 7372 635f 7061 7468 0a0a 2020 2020  ].src_path..    
-00012550: 2020 2020 2020 2020 6e65 775f 6576 656e          new_even
-00012560: 743a 2044 6972 4d6f 7665 6445 7665 6e74  t: DirMovedEvent
-00012570: 207c 2046 696c 654d 6f76 6564 4576 656e   | FileMovedEven
-00012580: 740a 0a20 2020 2020 2020 2020 2020 2069  t..            i
-00012590: 6620 7372 635f 6576 656e 742e 6973 5f64  f src_event.is_d
-000125a0: 6972 6563 746f 7279 3a0a 2020 2020 2020  irectory:.      
-000125b0: 2020 2020 2020 2020 2020 6e65 775f 6576            new_ev
-000125c0: 656e 7420 3d20 4469 724d 6f76 6564 4576  ent = DirMovedEv
-000125d0: 656e 7428 7372 635f 7061 7468 2c20 6465  ent(src_path, de
-000125e0: 7374 5f70 6174 6829 0a20 2020 2020 2020  st_path).       
-000125f0: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-00012600: 2020 2020 2020 2020 2020 206e 6577 5f65             new_e
-00012610: 7665 6e74 203d 2046 696c 654d 6f76 6564  vent = FileMoved
-00012620: 4576 656e 7428 7372 635f 7061 7468 2c20  Event(src_path, 
-00012630: 6465 7374 5f70 6174 6829 0a0a 2020 2020  dest_path)..    
-00012640: 2020 2020 2020 2020 2320 4f6e 6c79 2072          # Only r
-00012650: 6563 6f6d 6269 6e65 2065 7665 6e74 7320  ecombine events 
-00012660: 6966 206e 6569 7468 6572 2068 6173 2061  if neither has a
-00012670: 6e20 6578 636c 7564 6564 2070 6174 683a  n excluded path:
-00012680: 2057 6520 7761 6e74 2074 6f0a 2020 2020   We want to.    
-00012690: 2020 2020 2020 2020 2320 7472 6561 7420          # treat 
-000126a0: 7265 6e61 6d69 6e67 2066 726f 6d20 2f20  renaming from / 
-000126b0: 746f 2061 6e20 6578 636c 7564 6564 2070  to an excluded p
-000126c0: 6174 6820 6173 2061 2063 7265 6174 696f  ath as a creatio
-000126d0: 6e20 2f20 6465 6c65 7469 6f6e 2c0a 2020  n / deletion,.  
-000126e0: 2020 2020 2020 2020 2020 2320 7265 7370            # resp
-000126f0: 6563 7469 7665 6c79 2e0a 2020 2020 2020  ectively..      
-00012700: 2020 2020 2020 6966 206e 6f74 2073 656c        if not sel
-00012710: 662e 5f73 686f 756c 645f 7370 6c69 745f  f._should_split_
-00012720: 6578 636c 7564 6564 286e 6577 5f65 7665  excluded(new_eve
-00012730: 6e74 293a 0a20 2020 2020 2020 2020 2020  nt):.           
-00012740: 2020 2020 2064 656c 2065 7665 6e74 735f       del events_
-00012750: 666f 725f 7061 7468 5b73 7263 5f70 6174  for_path[src_pat
-00012760: 685d 0a20 2020 2020 2020 2020 2020 2020  h].             
-00012770: 2020 2065 7665 6e74 735f 666f 725f 7061     events_for_pa
-00012780: 7468 5b64 6573 745f 7061 7468 5d20 3d20  th[dest_path] = 
-00012790: 5b6e 6577 5f65 7665 6e74 5d0a 0a20 2020  [new_event]..   
-000127a0: 2020 2020 2023 2041 7420 7468 6973 2070       # At this p
-000127b0: 6f69 6e74 2c20 6065 7665 6e74 735f 666f  oint, `events_fo
-000127c0: 725f 7061 7468 6020 7769 6c6c 2063 6f6e  r_path` will con
-000127d0: 7461 696e 2061 2073 696e 676c 6520 6576  tain a single ev
-000127e0: 656e 7420 7065 7220 7061 7468 206f 720a  ent per path or.
-000127f0: 2020 2020 2020 2020 2320 6578 6163 746c          # exactl
-00012800: 7920 7477 6f20 6576 656e 7473 2028 6465  y two events (de
-00012810: 6c65 7465 6420 616e 6420 6372 6561 7465  leted and create
-00012820: 6429 2069 6e20 6361 7365 206f 6620 6120  d) in case of a 
-00012830: 7479 7065 2063 6861 6e67 652e 0a0a 2020  type change...  
-00012840: 2020 2020 2020 2320 434f 4d42 494e 4520        # COMBINE 
-00012850: 4d4f 5645 4420 414e 4420 4445 4c45 5445  MOVED AND DELETE
-00012860: 4420 4556 454e 5453 204f 4620 464f 4c44  D EVENTS OF FOLD
-00012870: 4552 5320 414e 4420 5448 4549 5220 4348  ERS AND THEIR CH
-00012880: 494c 4452 454e 2049 4e54 4f20 4f4e 4520  ILDREN INTO ONE 
-00012890: 4556 454e 540a 0a20 2020 2020 2020 2023  EVENT..        #
-000128a0: 2041 766f 6964 206e 6573 7465 6420 6974   Avoid nested it
-000128b0: 6572 6174 696f 6e73 206f 7665 7220 616c  erations over al
-000128c0: 6c20 6576 656e 7473 2068 6572 652c 2074  l events here, t
-000128d0: 6865 7920 6172 6520 6f6e 2074 6865 206f  hey are on the o
-000128e0: 7264 6572 206f 6620 4f28 6e5e 3229 0a20  rder of O(n^2). 
-000128f0: 2020 2020 2020 2023 2077 6869 6368 2062         # which b
-00012900: 6563 6f6d 6573 2063 6f73 746c 7920 7768  ecomes costly wh
-00012910: 656e 2074 6865 2075 7365 7220 6d6f 7665  en the user move
-00012920: 7320 6f72 2064 656c 6574 6573 2066 6f6c  s or deletes fol
-00012930: 6465 7220 7769 7468 2061 206c 6172 6765  der with a large
-00012940: 206e 756d 6265 720a 2020 2020 2020 2020   number.        
-00012950: 2320 6f66 2063 6869 6c64 7265 6e2e 2042  # of children. B
-00012960: 656e 6368 6d61 726b 3a20 6169 6d20 746f  enchmark: aim to
-00012970: 2073 7461 7920 6265 6c6f 7720 3120 7365   stay below 1 se
-00012980: 6320 666f 7220 3230 2c30 3030 206e 6573  c for 20,000 nes
-00012990: 7465 6420 6576 656e 7473 206f 6e0a 2020  ted events on.  
-000129a0: 2020 2020 2020 2320 7265 7072 6573 656e        # represen
-000129b0: 7461 7469 7665 206c 6170 746f 7020 5043  tative laptop PC
-000129c0: 732e 0a0a 2020 2020 2020 2020 2320 3029  s...        # 0)
-000129d0: 2043 6f6c 6c65 6374 2061 6c6c 206d 6f76   Collect all mov
-000129e0: 6564 2061 6e64 2064 656c 6574 6564 2065  ed and deleted e
-000129f0: 7665 6e74 7320 696e 2073 6574 732e 0a0a  vents in sets...
-00012a00: 2020 2020 2020 2020 6469 725f 6d6f 7665          dir_move
-00012a10: 645f 7061 7468 733a 2073 6574 5b74 7570  d_paths: set[tup
-00012a20: 6c65 5b73 7472 2c20 7374 725d 5d20 3d20  le[str, str]] = 
-00012a30: 7365 7428 290a 2020 2020 2020 2020 6469  set().        di
-00012a40: 725f 6465 6c65 7465 645f 7061 7468 733a  r_deleted_paths:
-00012a50: 2073 6574 5b73 7472 5d20 3d20 7365 7428   set[str] = set(
-00012a60: 290a 0a20 2020 2020 2020 2066 6f72 2065  )..        for e
-00012a70: 7665 6e74 7320 696e 2065 7665 6e74 735f  vents in events_
-00012a80: 666f 725f 7061 7468 2e76 616c 7565 7328  for_path.values(
-00012a90: 293a 0a20 2020 2020 2020 2020 2020 2065  ):.            e
-00012aa0: 7665 6e74 203d 2065 7665 6e74 735b 305d  vent = events[0]
-00012ab0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-00012ac0: 6973 696e 7374 616e 6365 2865 7665 6e74  isinstance(event
-00012ad0: 2c20 4469 724d 6f76 6564 4576 656e 7429  , DirMovedEvent)
-00012ae0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00012af0: 2020 6469 725f 6d6f 7665 645f 7061 7468    dir_moved_path
-00012b00: 732e 6164 6428 2865 7665 6e74 2e73 7263  s.add((event.src
-00012b10: 5f70 6174 682c 2065 7665 6e74 2e64 6573  _path, event.des
-00012b20: 745f 7061 7468 2929 0a20 2020 2020 2020  t_path)).       
-00012b30: 2020 2020 2065 6c69 6620 6973 696e 7374       elif isinst
-00012b40: 616e 6365 2865 7665 6e74 2c20 4469 7244  ance(event, DirD
-00012b50: 656c 6574 6564 4576 656e 7429 3a0a 2020  eletedEvent):.  
-00012b60: 2020 2020 2020 2020 2020 2020 2020 6469                di
-00012b70: 725f 6465 6c65 7465 645f 7061 7468 732e  r_deleted_paths.
-00012b80: 6164 6428 6576 656e 742e 7372 635f 7061  add(event.src_pa
-00012b90: 7468 290a 0a20 2020 2020 2020 2023 2031  th)..        # 1
-00012ba0: 2920 436f 6d62 696e 6520 6d6f 7665 6420  ) Combine moved 
-00012bb0: 6576 656e 7473 206f 6620 666f 6c64 6572  events of folder
-00012bc0: 7320 616e 6420 7468 6569 7220 6368 696c  s and their chil
-00012bd0: 6472 656e 2069 6e74 6f20 6f6e 6520 6576  dren into one ev
-00012be0: 656e 742e 0a0a 2020 2020 2020 2020 6966  ent...        if
-00012bf0: 206c 656e 2864 6972 5f6d 6f76 6564 5f70   len(dir_moved_p
-00012c00: 6174 6873 2920 3e20 303a 0a20 2020 2020  aths) > 0:.     
-00012c10: 2020 2020 2020 2063 6869 6c64 5f6d 6f76         child_mov
-00012c20: 6564 5f64 7374 5f70 6174 6873 3a20 7365  ed_dst_paths: se
-00012c30: 745b 7374 725d 203d 2073 6574 2829 0a0a  t[str] = set()..
-00012c40: 2020 2020 2020 2020 2020 2020 2320 466f              # Fo
-00012c50: 7220 6561 6368 2065 7665 6e74 2c20 6368  r each event, ch
-00012c60: 6563 6b20 6966 2069 7420 6973 2061 2063  eck if it is a c
-00012c70: 6869 6c64 206f 6620 6120 6d6f 7665 6420  hild of a moved 
-00012c80: 6576 656e 7420 6469 7363 6172 6420 6974  event discard it
-00012c90: 2069 6620 7965 732e 0a20 2020 2020 2020   if yes..       
-00012ca0: 2020 2020 2066 6f72 2065 7665 6e74 7320       for events 
-00012cb0: 696e 2065 7665 6e74 735f 666f 725f 7061  in events_for_pa
-00012cc0: 7468 2e76 616c 7565 7328 293a 0a20 2020  th.values():.   
-00012cd0: 2020 2020 2020 2020 2020 2020 2065 7665               eve
-00012ce0: 6e74 203d 2065 7665 6e74 735b 305d 0a20  nt = events[0]. 
-00012cf0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00012d00: 6620 6973 5f6d 6f76 6564 2865 7665 6e74  f is_moved(event
-00012d10: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-00012d20: 2020 2020 2020 2064 6972 6e61 6d65 7320         dirnames 
-00012d30: 3d20 280a 2020 2020 2020 2020 2020 2020  = (.            
-00012d40: 2020 2020 2020 2020 2020 2020 6f73 702e              osp.
-00012d50: 6469 726e 616d 6528 6576 656e 742e 7372  dirname(event.sr
-00012d60: 635f 7061 7468 292c 0a20 2020 2020 2020  c_path),.       
-00012d70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012d80: 206f 7370 2e64 6972 6e61 6d65 2865 7665   osp.dirname(eve
-00012d90: 6e74 2e64 6573 745f 7061 7468 292c 0a20  nt.dest_path),. 
-00012da0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012db0: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
-00012dc0: 2020 2020 2020 2020 2069 6620 6469 726e           if dirn
-00012dd0: 616d 6573 2069 6e20 6469 725f 6d6f 7665  ames in dir_move
-00012de0: 645f 7061 7468 733a 0a20 2020 2020 2020  d_paths:.       
-00012df0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012e00: 2063 6869 6c64 5f6d 6f76 6564 5f64 7374   child_moved_dst
-00012e10: 5f70 6174 6873 2e61 6464 2865 7665 6e74  _paths.add(event
-00012e20: 2e64 6573 745f 7061 7468 290a 0a20 2020  .dest_path)..   
-00012e30: 2020 2020 2020 2020 2066 6f72 2070 6174           for pat
-00012e40: 6820 696e 2063 6869 6c64 5f6d 6f76 6564  h in child_moved
-00012e50: 5f64 7374 5f70 6174 6873 3a0a 2020 2020  _dst_paths:.    
-00012e60: 2020 2020 2020 2020 2020 2020 6465 6c20              del 
-00012e70: 6576 656e 7473 5f66 6f72 5f70 6174 685b  events_for_path[
-00012e80: 7061 7468 5d0a 0a20 2020 2020 2020 2023  path]..        #
-00012e90: 2032 2920 436f 6d62 696e 6520 6465 6c65   2) Combine dele
-00012ea0: 7465 6420 6576 656e 7473 206f 6620 666f  ted events of fo
-00012eb0: 6c64 6572 7320 616e 6420 7468 6569 7220  lders and their 
-00012ec0: 6368 696c 6472 656e 2074 6f20 6f6e 6520  children to one 
-00012ed0: 6576 656e 742e 0a0a 2020 2020 2020 2020  event...        
-00012ee0: 6966 206c 656e 2864 6972 5f64 656c 6574  if len(dir_delet
-00012ef0: 6564 5f70 6174 6873 2920 3e20 303a 0a20  ed_paths) > 0:. 
-00012f00: 2020 2020 2020 2020 2020 2063 6869 6c64             child
-00012f10: 5f64 656c 6574 6564 5f70 6174 6873 3a20  _deleted_paths: 
-00012f20: 7365 745b 7374 725d 203d 2073 6574 2829  set[str] = set()
-00012f30: 0a0a 2020 2020 2020 2020 2020 2020 666f  ..            fo
-00012f40: 7220 6576 656e 7473 2069 6e20 6576 656e  r events in even
-00012f50: 7473 5f66 6f72 5f70 6174 682e 7661 6c75  ts_for_path.valu
-00012f60: 6573 2829 3a0a 2020 2020 2020 2020 2020  es():.          
-00012f70: 2020 2020 2020 6576 656e 7420 3d20 6576        event = ev
-00012f80: 656e 7473 5b30 5d0a 2020 2020 2020 2020  ents[0].        
-00012f90: 2020 2020 2020 2020 6966 2069 735f 6465          if is_de
-00012fa0: 6c65 7465 6428 6576 656e 7429 3a0a 2020  leted(event):.  
-00012fb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012fc0: 2020 6469 726e 616d 6520 3d20 6f73 702e    dirname = osp.
-00012fd0: 6469 726e 616d 6528 6576 656e 742e 7372  dirname(event.sr
-00012fe0: 635f 7061 7468 290a 2020 2020 2020 2020  c_path).        
-00012ff0: 2020 2020 2020 2020 2020 2020 6966 2064              if d
-00013000: 6972 6e61 6d65 2069 6e20 6469 725f 6465  irname in dir_de
-00013010: 6c65 7465 645f 7061 7468 733a 0a20 2020  leted_paths:.   
-00013020: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013030: 2020 2020 2063 6869 6c64 5f64 656c 6574       child_delet
-00013040: 6564 5f70 6174 6873 2e61 6464 2865 7665  ed_paths.add(eve
-00013050: 6e74 2e73 7263 5f70 6174 6829 0a0a 2020  nt.src_path)..  
-00013060: 2020 2020 2020 2020 2020 666f 7220 7061            for pa
-00013070: 7468 2069 6e20 6368 696c 645f 6465 6c65  th in child_dele
-00013080: 7465 645f 7061 7468 733a 0a20 2020 2020  ted_paths:.     
-00013090: 2020 2020 2020 2020 2020 2064 656c 2065             del e
-000130a0: 7665 6e74 735f 666f 725f 7061 7468 5b70  vents_for_path[p
-000130b0: 6174 685d 0a0a 2020 2020 2020 2020 2320  ath]..        # 
-000130c0: 5052 4550 4152 4520 5245 5455 524e 2056  PREPARE RETURN V
-000130d0: 414c 5545 2041 4e44 2046 5245 4520 4d45  ALUE AND FREE ME
-000130e0: 4d4f 5259 0a0a 2020 2020 2020 2020 636c  MORY..        cl
-000130f0: 6561 6e65 645f 6576 656e 7473 203d 205b  eaned_events = [
-00013100: 5d0a 0a20 2020 2020 2020 2066 6f72 2065  ]..        for e
-00013110: 7665 6e74 7320 696e 2065 7665 6e74 735f  vents in events_
-00013120: 666f 725f 7061 7468 2e76 616c 7565 7328  for_path.values(
-00013130: 293a 0a20 2020 2020 2020 2020 2020 2063  ):.            c
-00013140: 6c65 616e 6564 5f65 7665 6e74 732e 6578  leaned_events.ex
-00013150: 7465 6e64 2865 7665 6e74 7329 0a0a 2020  tend(events)..  
-00013160: 2020 2020 2020 2320 4672 6565 206d 656d        # Free mem
-00013170: 6f72 7920 6561 726c 7920 746f 2070 7265  ory early to pre
-00013180: 7665 6e74 2066 7261 676d 656e 7461 7469  vent fragmentati
-00013190: 6f6e 2e0a 2020 2020 2020 2020 6465 6c20  on..        del 
-000131a0: 6576 656e 7473 5f66 6f72 5f70 6174 680a  events_for_path.
-000131b0: 2020 2020 2020 2020 6465 6c20 6d6f 7665          del move
-000131c0: 645f 6672 6f6d 5f74 6f0a 2020 2020 2020  d_from_to.      
-000131d0: 2020 6465 6c20 6d6f 7665 645f 6576 656e    del moved_even
-000131e0: 7473 5f74 6f5f 7265 636f 6d62 696e 650a  ts_to_recombine.
-000131f0: 2020 2020 2020 2020 6465 6c20 6469 725f          del dir_
-00013200: 6d6f 7665 645f 7061 7468 730a 2020 2020  moved_paths.    
-00013210: 2020 2020 6465 6c20 6469 725f 6465 6c65      del dir_dele
-00013220: 7465 645f 7061 7468 730a 2020 2020 2020  ted_paths.      
-00013230: 2020 6763 2e63 6f6c 6c65 6374 2829 0a0a    gc.collect()..
-00013240: 2020 2020 2020 2020 7265 7475 726e 2063          return c
-00013250: 6c65 616e 6564 5f65 7665 6e74 730a 0a20  leaned_events.. 
-00013260: 2020 2064 6566 205f 7368 6f75 6c64 5f73     def _should_s
-00013270: 706c 6974 5f65 7863 6c75 6465 6428 7365  plit_excluded(se
-00013280: 6c66 2c20 6576 656e 743a 2046 696c 654d  lf, event: FileM
-00013290: 6f76 6564 4576 656e 7420 7c20 4469 724d  ovedEvent | DirM
-000132a0: 6f76 6564 4576 656e 7429 202d 3e20 626f  ovedEvent) -> bo
-000132b0: 6f6c 3a0a 2020 2020 2020 2020 6462 785f  ol:.        dbx_
-000132c0: 7372 635f 7061 7468 203d 2073 656c 662e  src_path = self.
-000132d0: 746f 5f64 6278 5f70 6174 6828 6576 656e  to_dbx_path(even
-000132e0: 742e 7372 635f 7061 7468 290a 2020 2020  t.src_path).    
-000132f0: 2020 2020 6462 785f 6465 7374 5f70 6174      dbx_dest_pat
-00013300: 6820 3d20 7365 6c66 2e74 6f5f 6462 785f  h = self.to_dbx_
-00013310: 7061 7468 2865 7665 6e74 2e64 6573 745f  path(event.dest_
-00013320: 7061 7468 290a 0a20 2020 2020 2020 2069  path)..        i
-00013330: 6620 280a 2020 2020 2020 2020 2020 2020  f (.            
-00013340: 7365 6c66 2e69 735f 6578 636c 7564 6564  self.is_excluded
-00013350: 2865 7665 6e74 2e73 7263 5f70 6174 6829  (event.src_path)
-00013360: 0a20 2020 2020 2020 2020 2020 206f 7220  .            or 
-00013370: 7365 6c66 2e69 735f 6578 636c 7564 6564  self.is_excluded
-00013380: 2865 7665 6e74 2e64 6573 745f 7061 7468  (event.dest_path
-00013390: 290a 2020 2020 2020 2020 2020 2020 6f72  ).            or
-000133a0: 2073 656c 662e 6973 5f65 7863 6c75 6465   self.is_exclude
-000133b0: 645f 6279 5f75 7365 7228 6e6f 726d 616c  d_by_user(normal
-000133c0: 697a 6528 6462 785f 7372 635f 7061 7468  ize(dbx_src_path
-000133d0: 2929 0a20 2020 2020 2020 2020 2020 206f  )).            o
-000133e0: 7220 7365 6c66 2e69 735f 6578 636c 7564  r self.is_exclud
-000133f0: 6564 5f62 795f 7573 6572 286e 6f72 6d61  ed_by_user(norma
-00013400: 6c69 7a65 2864 6278 5f64 6573 745f 7061  lize(dbx_dest_pa
-00013410: 7468 2929 0a20 2020 2020 2020 2029 3a0a  th)).        ):.
-00013420: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-00013430: 726e 2054 7275 650a 0a20 2020 2020 2020  rn True..       
-00013440: 2065 6c69 6620 6c65 6e28 7365 6c66 2e6d   elif len(self.m
-00013450: 6967 6e6f 7265 5f72 756c 6573 2e70 6174  ignore_rules.pat
-00013460: 7465 726e 7329 203d 3d20 303a 0a20 2020  terns) == 0:.   
-00013470: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-00013480: 4661 6c73 650a 2020 2020 2020 2020 656c  False.        el
-00013490: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-000134a0: 7372 635f 6973 5f6d 6967 6e6f 7265 203d  src_is_mignore =
-000134b0: 2073 656c 662e 5f69 735f 6d69 676e 6f72   self._is_mignor
-000134c0: 655f 7061 7468 2864 6278 5f73 7263 5f70  e_path(dbx_src_p
-000134d0: 6174 682c 2065 7665 6e74 2e69 735f 6469  ath, event.is_di
-000134e0: 7265 6374 6f72 7929 0a20 2020 2020 2020  rectory).       
-000134f0: 2020 2020 2064 6573 745f 6973 5f6d 6967       dest_is_mig
-00013500: 6e6f 7265 203d 2073 656c 662e 5f69 735f  nore = self._is_
-00013510: 6d69 676e 6f72 655f 7061 7468 2864 6278  mignore_path(dbx
-00013520: 5f64 6573 745f 7061 7468 2c20 6576 656e  _dest_path, even
-00013530: 742e 6973 5f64 6972 6563 746f 7279 290a  t.is_directory).
-00013540: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-00013550: 7572 6e20 7372 635f 6973 5f6d 6967 6e6f  urn src_is_migno
-00013560: 7265 206f 7220 6465 7374 5f69 735f 6d69  re or dest_is_mi
-00013570: 676e 6f72 650a 0a20 2020 2064 6566 205f  gnore..    def _
-00013580: 6861 6e64 6c65 5f6e 6f72 6d61 6c69 7a61  handle_normaliza
-00013590: 7469 6f6e 5f63 6f6e 666c 6963 7428 7365  tion_conflict(se
-000135a0: 6c66 2c20 6576 656e 743a 2053 796e 6345  lf, event: SyncE
-000135b0: 7665 6e74 2920 2d3e 2062 6f6f 6c3a 0a20  vent) -> bool:. 
-000135c0: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
-000135d0: 2020 2043 6865 636b 7320 666f 7220 6f74     Checks for ot
-000135e0: 6865 7220 6974 656d 7320 696e 2074 6865  her items in the
-000135f0: 2073 616d 6520 6469 7265 6374 6f72 7920   same directory 
-00013600: 7769 7468 2061 2064 6966 6665 7265 6e74  with a different
-00013610: 206e 616d 6520 6275 7420 7468 6520 7361   name but the sa
-00013620: 6d65 0a20 2020 2020 2020 206e 6f72 6d61  me.        norma
-00013630: 6c69 7a61 7469 6f6e 2e0a 0a20 2020 2020  lization...     
-00013640: 2020 203a 7061 7261 6d20 6576 656e 743a     :param event:
-00013650: 2053 796e 6345 7665 6e74 2066 6f72 206c   SyncEvent for l
-00013660: 6f63 616c 2063 7265 6174 6564 206f 7220  ocal created or 
-00013670: 6d6f 7665 6420 6576 656e 742e 0a20 2020  moved event..   
-00013680: 2020 2020 203a 7265 7475 726e 733a 2057       :returns: W
-00013690: 6865 7468 6572 2061 2063 6173 6520 636f  hether a case co
-000136a0: 6e66 6c69 6374 2077 6173 2064 6574 6563  nflict was detec
-000136b0: 7465 6420 616e 6420 6861 6e64 6c65 642e  ted and handled.
-000136c0: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
-000136d0: 2020 2020 2069 6620 6e6f 7420 2865 7665       if not (eve
-000136e0: 6e74 2e69 735f 6164 6465 6420 6f72 2065  nt.is_added or e
-000136f0: 7665 6e74 2e69 735f 6d6f 7665 6429 3a0a  vent.is_moved):.
-00013700: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-00013710: 726e 2046 616c 7365 0a0a 2020 2020 2020  rn False..      
-00013720: 2020 6469 726e 616d 652c 2062 6173 656e    dirname, basen
-00013730: 616d 6520 3d20 6f73 702e 7370 6c69 7428  ame = osp.split(
-00013740: 6576 656e 742e 6c6f 6361 6c5f 7061 7468  event.local_path
-00013750: 290a 2020 2020 2020 2020 6571 7569 7661  ).        equiva
-00013760: 6c65 6e74 5f70 6174 6873 203d 2067 6574  lent_paths = get
-00013770: 5f65 7869 7374 696e 675f 6571 7569 7661  _existing_equiva
-00013780: 6c65 6e74 5f70 6174 6873 2862 6173 656e  lent_paths(basen
-00013790: 616d 652c 2072 6f6f 743d 6469 726e 616d  ame, root=dirnam
-000137a0: 6529 0a0a 2020 2020 2020 2020 6966 206c  e)..        if l
-000137b0: 656e 2865 7175 6976 616c 656e 745f 7061  en(equivalent_pa
-000137c0: 7468 7329 203e 2031 3a0a 2020 2020 2020  ths) > 1:.      
-000137d0: 2020 2020 2020 2320 5765 2068 6176 6520        # We have 
-000137e0: 6469 6666 6572 656e 7420 6669 6c65 206e  different file n
-000137f0: 616d 6573 2074 6861 7420 776f 756c 6420  ames that would 
-00013800: 6d61 7020 746f 2074 6865 2073 616d 6520  map to the same 
-00013810: 6e6f 726d 616c 697a 6564 2070 6174 6821  normalized path!
-00013820: 0a0a 2020 2020 2020 2020 2020 2020 636f  ..            co
-00013830: 6e66 6c69 6374 5f70 6174 6820 3d20 6e65  nflict_path = ne
-00013840: 7874 2870 2066 6f72 2070 2069 6e20 6571  xt(p for p in eq
-00013850: 7569 7661 6c65 6e74 5f70 6174 6873 2069  uivalent_paths i
-00013860: 6620 7020 213d 2065 7665 6e74 2e6c 6f63  f p != event.loc
-00013870: 616c 5f70 6174 6829 0a0a 2020 2020 2020  al_path)..      
-00013880: 2020 2020 2020 2320 4368 6563 6b20 6966        # Check if
-00013890: 2077 6520 6861 7665 2061 2063 6173 6520   we have a case 
-000138a0: 636f 6e66 6c69 6374 206f 7220 6120 756e  conflict or a un
-000138b0: 6963 6f64 6520 636f 6e66 6c69 6374 2e0a  icode conflict..
-000138c0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-000138d0: 6e6f 726d 616c 697a 655f 6361 7365 2865  normalize_case(e
-000138e0: 7665 6e74 2e6c 6f63 616c 5f70 6174 6829  vent.local_path)
-000138f0: 203d 3d20 6e6f 726d 616c 697a 655f 6361   == normalize_ca
-00013900: 7365 2863 6f6e 666c 6963 745f 7061 7468  se(conflict_path
-00013910: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-00013920: 2020 2073 7566 6669 7820 3d20 2263 6173     suffix = "cas
-00013930: 6520 636f 6e66 6c69 6374 220a 2020 2020  e conflict".    
-00013940: 2020 2020 2020 2020 656c 6966 206e 6f72          elif nor
-00013950: 6d61 6c69 7a65 5f75 6e69 636f 6465 2865  malize_unicode(e
-00013960: 7665 6e74 2e6c 6f63 616c 5f70 6174 6829  vent.local_path)
-00013970: 203d 3d20 6e6f 726d 616c 697a 655f 6361   == normalize_ca
-00013980: 7365 2863 6f6e 666c 6963 745f 7061 7468  se(conflict_path
-00013990: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-000139a0: 2020 2073 7566 6669 7820 3d20 2275 6e69     suffix = "uni
-000139b0: 636f 6465 2063 6f6e 666c 6963 7422 0a20  code conflict". 
-000139c0: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
-000139d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000139e0: 2073 7566 6669 7820 3d20 226e 6f72 6d61   suffix = "norma
-000139f0: 6c69 7a61 7469 6f6e 2063 6f6e 666c 6963  lization conflic
-00013a00: 7422 0a0a 2020 2020 2020 2020 2020 2020  t"..            
-00013a10: 6c6f 6361 6c5f 7061 7468 5f63 6320 3d20  local_path_cc = 
-00013a20: 6765 6e65 7261 7465 5f63 635f 6e61 6d65  generate_cc_name
-00013a30: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-00013a40: 2020 6576 656e 742e 6c6f 6361 6c5f 7061    event.local_pa
-00013a50: 7468 2c0a 2020 2020 2020 2020 2020 2020  th,.            
-00013a60: 2020 2020 7375 6666 6978 3d73 7566 6669      suffix=suffi
-00013a70: 782c 0a20 2020 2020 2020 2020 2020 2029  x,.            )
-00013a80: 0a0a 2020 2020 2020 2020 2020 2020 6576  ..            ev
-00013a90: 656e 745f 636c 7320 3d20 4469 724d 6f76  ent_cls = DirMov
-00013aa0: 6564 4576 656e 7420 6966 2069 7364 6972  edEvent if isdir
-00013ab0: 2865 7665 6e74 2e6c 6f63 616c 5f70 6174  (event.local_pat
-00013ac0: 6829 2065 6c73 6520 4669 6c65 4d6f 7665  h) else FileMove
-00013ad0: 6445 7665 6e74 0a20 2020 2020 2020 2020  dEvent.         
-00013ae0: 2020 2077 6974 6820 7365 6c66 2e66 735f     with self.fs_
-00013af0: 6576 656e 7473 2e69 676e 6f72 6528 6576  events.ignore(ev
-00013b00: 656e 745f 636c 7328 6576 656e 742e 6c6f  ent_cls(event.lo
-00013b10: 6361 6c5f 7061 7468 2c20 6c6f 6361 6c5f  cal_path, local_
-00013b20: 7061 7468 5f63 6329 293a 0a20 2020 2020  path_cc)):.     
-00013b30: 2020 2020 2020 2020 2020 2077 6974 6820             with 
-00013b40: 636f 6e76 6572 745f 6170 695f 6572 726f  convert_api_erro
-00013b50: 7273 2829 3a0a 2020 2020 2020 2020 2020  rs():.          
-00013b60: 2020 2020 2020 2020 2020 6d6f 7665 2865            move(e
-00013b70: 7665 6e74 2e6c 6f63 616c 5f70 6174 682c  vent.local_path,
-00013b80: 206c 6f63 616c 5f70 6174 685f 6363 2c20   local_path_cc, 
-00013b90: 7261 6973 655f 6572 726f 723d 5472 7565  raise_error=True
-00013ba0: 290a 0a20 2020 2020 2020 2020 2020 2020  )..             
-00013bb0: 2020 2073 656c 662e 7265 7363 616e 286c     self.rescan(l
-00013bc0: 6f63 616c 5f70 6174 685f 6363 290a 0a20  ocal_path_cc).. 
-00013bd0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-00013be0: 5f6c 6f67 6765 722e 696e 666f 280a 2020  _logger.info(.  
-00013bf0: 2020 2020 2020 2020 2020 2020 2020 274e                'N
-00013c00: 6f72 6d61 6c69 7a61 7469 6f6e 2063 6f6e  ormalization con
-00013c10: 666c 6963 743a 2072 656e 616d 6564 2022  flict: renamed "
-00013c20: 2573 2220 746f 2022 2573 2227 2c0a 2020  %s" to "%s"',.  
-00013c30: 2020 2020 2020 2020 2020 2020 2020 6576                ev
-00013c40: 656e 742e 6c6f 6361 6c5f 7061 7468 2c0a  ent.local_path,.
-00013c50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013c60: 6c6f 6361 6c5f 7061 7468 5f63 632c 0a20  local_path_cc,. 
-00013c70: 2020 2020 2020 2020 2020 2029 0a0a 2020             )..  
-00013c80: 2020 2020 2020 2020 2020 7265 7475 726e            return
-00013c90: 2054 7275 650a 2020 2020 2020 2020 656c   True.        el
-00013ca0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-00013cb0: 7265 7475 726e 2046 616c 7365 0a0a 2020  return False..  
-00013cc0: 2020 6465 6620 5f68 616e 646c 655f 7365    def _handle_se
-00013cd0: 6c65 6374 6976 655f 7379 6e63 5f63 6f6e  lective_sync_con
-00013ce0: 666c 6963 7428 7365 6c66 2c20 6576 656e  flict(self, even
-00013cf0: 743a 2053 796e 6345 7665 6e74 2920 2d3e  t: SyncEvent) ->
-00013d00: 2062 6f6f 6c3a 0a20 2020 2020 2020 2022   bool:.        "
-00013d10: 2222 0a20 2020 2020 2020 2043 6865 636b  "".        Check
-00013d20: 7320 666f 7220 6974 656d 7320 696e 2074  s for items in t
-00013d30: 6865 206c 6f63 616c 2064 6972 6563 746f  he local directo
-00013d40: 7279 2077 6974 6820 7361 6d65 2070 6174  ry with same pat
-00013d50: 6820 6173 2061 6e20 6974 656d 2077 6869  h as an item whi
-00013d60: 6368 2069 730a 2020 2020 2020 2020 6578  ch is.        ex
-00013d70: 636c 7564 6564 2062 7920 7365 6c65 6374  cluded by select
-00013d80: 6976 6520 7379 6e63 2e20 5265 6e61 6d65  ive sync. Rename
-00013d90: 7320 6974 656d 7320 6966 206e 6563 6573  s items if neces
-00013da0: 7361 7279 2e0a 0a20 2020 2020 2020 203a  sary...        :
-00013db0: 7061 7261 6d20 6576 656e 743a 2053 796e  param event: Syn
-00013dc0: 6345 7665 6e74 2066 6f72 206c 6f63 616c  cEvent for local
-00013dd0: 2063 7265 6174 6564 206f 7220 6d6f 7665   created or move
-00013de0: 6420 6576 656e 742e 0a20 2020 2020 2020  d event..       
-00013df0: 203a 7265 7475 726e 733a 2057 6865 7468   :returns: Wheth
-00013e00: 6572 2061 2073 656c 6563 7469 7665 2073  er a selective s
-00013e10: 796e 6320 636f 6e66 6c69 6374 2077 6173  ync conflict was
-00013e20: 2064 6574 6563 7465 6420 616e 6420 6861   detected and ha
-00013e30: 6e64 6c65 642e 0a20 2020 2020 2020 2022  ndled..        "
-00013e40: 2222 0a20 2020 2020 2020 2069 6620 6e6f  "".        if no
-00013e50: 7420 2865 7665 6e74 2e69 735f 6164 6465  t (event.is_adde
-00013e60: 6420 6f72 2065 7665 6e74 2e69 735f 6d6f  d or event.is_mo
-00013e70: 7665 6429 3a0a 2020 2020 2020 2020 2020  ved):.          
-00013e80: 2020 7265 7475 726e 2046 616c 7365 0a0a    return False..
-00013e90: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
-00013ea0: 6973 5f65 7863 6c75 6465 645f 6279 5f75  is_excluded_by_u
-00013eb0: 7365 7228 6576 656e 742e 6462 785f 7061  ser(event.dbx_pa
-00013ec0: 7468 5f6c 6f77 6572 293a 0a20 2020 2020  th_lower):.     
-00013ed0: 2020 2020 2020 206c 6f63 616c 5f70 6174         local_pat
-00013ee0: 685f 6363 203d 2067 656e 6572 6174 655f  h_cc = generate_
-00013ef0: 6363 5f6e 616d 6528 0a20 2020 2020 2020  cc_name(.       
-00013f00: 2020 2020 2020 2020 2065 7665 6e74 2e6c           event.l
-00013f10: 6f63 616c 5f70 6174 682c 0a20 2020 2020  ocal_path,.     
-00013f20: 2020 2020 2020 2020 2020 2073 7566 6669             suffi
-00013f30: 783d 2273 656c 6563 7469 7665 2073 796e  x="selective syn
-00013f40: 6320 636f 6e66 6c69 6374 222c 0a20 2020  c conflict",.   
-00013f50: 2020 2020 2020 2020 2029 0a0a 2020 2020           )..    
-00013f60: 2020 2020 2020 2020 6576 656e 745f 636c          event_cl
-00013f70: 7320 3d20 4469 724d 6f76 6564 4576 656e  s = DirMovedEven
-00013f80: 7420 6966 2069 7364 6972 2865 7665 6e74  t if isdir(event
-00013f90: 2e6c 6f63 616c 5f70 6174 6829 2065 6c73  .local_path) els
-00013fa0: 6520 4669 6c65 4d6f 7665 6445 7665 6e74  e FileMovedEvent
-00013fb0: 0a20 2020 2020 2020 2020 2020 2077 6974  .            wit
-00013fc0: 6820 7365 6c66 2e66 735f 6576 656e 7473  h self.fs_events
-00013fd0: 2e69 676e 6f72 6528 6576 656e 745f 636c  .ignore(event_cl
-00013fe0: 7328 6576 656e 742e 6c6f 6361 6c5f 7061  s(event.local_pa
-00013ff0: 7468 2c20 6c6f 6361 6c5f 7061 7468 5f63  th, local_path_c
-00014000: 6329 293a 0a20 2020 2020 2020 2020 2020  c)):.           
-00014010: 2020 2020 2077 6974 6820 636f 6e76 6572       with conver
-00014020: 745f 6170 695f 6572 726f 7273 2829 3a0a  t_api_errors():.
-00014030: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014040: 2020 2020 6d6f 7665 2865 7665 6e74 2e6c      move(event.l
-00014050: 6f63 616c 5f70 6174 682c 206c 6f63 616c  ocal_path, local
-00014060: 5f70 6174 685f 6363 2c20 7261 6973 655f  _path_cc, raise_
-00014070: 6572 726f 723d 5472 7565 290a 0a20 2020  error=True)..   
-00014080: 2020 2020 2020 2020 2020 2020 2073 656c               sel
-00014090: 662e 7265 7363 616e 286c 6f63 616c 5f70  f.rescan(local_p
-000140a0: 6174 685f 6363 290a 0a20 2020 2020 2020  ath_cc)..       
-000140b0: 2020 2020 2073 656c 662e 5f6c 6f67 6765       self._logge
-000140c0: 722e 696e 666f 280a 2020 2020 2020 2020  r.info(.        
-000140d0: 2020 2020 2020 2020 2753 656c 6563 7469          'Selecti
-000140e0: 7665 2073 796e 6320 636f 6e66 6c69 6374  ve sync conflict
-000140f0: 3a20 7265 6e61 6d65 6420 2225 7322 2074  : renamed "%s" t
-00014100: 6f20 2225 7322 272c 0a20 2020 2020 2020  o "%s"',.       
-00014110: 2020 2020 2020 2020 2065 7665 6e74 2e6c           event.l
-00014120: 6f63 616c 5f70 6174 682c 0a20 2020 2020  ocal_path,.     
-00014130: 2020 2020 2020 2020 2020 206c 6f63 616c             local
-00014140: 5f70 6174 685f 6363 2c0a 2020 2020 2020  _path_cc,.      
-00014150: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-00014160: 2020 2020 7265 7475 726e 2054 7275 650a      return True.
-00014170: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-00014180: 2020 2020 2020 2020 2020 7265 7475 726e            return
-00014190: 2046 616c 7365 0a0a 2020 2020 6465 6620   False..    def 
-000141a0: 5f63 7265 6174 655f 7265 6d6f 7465 5f65  _create_remote_e
-000141b0: 6e74 7279 2873 656c 662c 2065 7665 6e74  ntry(self, event
-000141c0: 3a20 5379 6e63 4576 656e 7429 202d 3e20  : SyncEvent) -> 
-000141d0: 5379 6e63 4576 656e 743a 0a20 2020 2020  SyncEvent:.     
-000141e0: 2020 2022 2222 0a20 2020 2020 2020 2041     """.        A
-000141f0: 7070 6c69 6573 2061 206c 6f63 616c 2066  pplies a local f
-00014200: 696c 6520 7379 7374 656d 2065 7665 6e74  ile system event
-00014210: 2074 6f20 7468 6520 7265 6d6f 7465 2044   to the remote D
-00014220: 726f 7062 6f78 2061 6e64 2063 6c65 6172  ropbox and clear
-00014230: 7320 616e 7920 6578 6973 7469 6e67 0a20  s any existing. 
-00014240: 2020 2020 2020 2073 796e 6320 6572 726f         sync erro
-00014250: 7273 2062 656c 6f6e 6769 6e67 2074 6f20  rs belonging to 
-00014260: 7468 6174 2070 6174 682e 2041 6e79 203a  that path. Any :
-00014270: 6578 633a 606d 6165 7374 7261 6c2e 6578  exc:`maestral.ex
-00014280: 6365 7074 696f 6e2e 5379 6e63 4572 726f  ception.SyncErro
-00014290: 7260 2077 696c 6c0a 2020 2020 2020 2020  r` will.        
-000142a0: 6265 2063 6175 6768 7420 616e 6420 6c6f  be caught and lo
-000142b0: 6767 6564 2061 7320 6170 7072 6f70 7269  gged as appropri
-000142c0: 6174 652e 0a0a 2020 2020 2020 2020 5468  ate...        Th
-000142d0: 6973 206d 6574 686f 6420 616c 7761 7973  is method always
-000142e0: 2075 7365 7320 6120 6e65 7720 636f 7079   uses a new copy
-000142f0: 206f 6620 636c 6965 6e74 2061 6e64 2063   of client and c
-00014300: 6c6f 7365 7320 7468 6520 6e65 7477 6f72  loses the networ
-00014310: 6b20 7365 7373 696f 6e0a 2020 2020 2020  k session.      
-00014320: 2020 6166 7465 7277 6172 6473 2e0a 0a20    afterwards... 
-00014330: 2020 2020 2020 203a 7061 7261 6d20 6576         :param ev
-00014340: 656e 743a 2053 796e 6345 7665 6e74 2066  ent: SyncEvent f
-00014350: 6f72 206c 6f63 616c 2066 696c 6520 6576  or local file ev
-00014360: 656e 742e 0a20 2020 2020 2020 203a 7265  ent..        :re
-00014370: 7475 726e 733a 2053 796e 6345 7665 6e74  turns: SyncEvent
-00014380: 2077 6974 6820 7570 6461 7465 6420 7374   with updated st
-00014390: 6174 7573 2e0a 2020 2020 2020 2020 2222  atus..        ""
-000143a0: 220a 2020 2020 2020 2020 6966 2073 656c  ".        if sel
-000143b0: 662e 5f63 616e 6365 6c5f 7265 7175 6573  f._cancel_reques
-000143c0: 7465 642e 6973 5f73 6574 2829 3a0a 2020  ted.is_set():.  
-000143d0: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
-000143e0: 4361 6e63 656c 6c65 6445 7272 6f72 2822  CancelledError("
-000143f0: 5379 6e63 2063 616e 6365 6c6c 6564 2229  Sync cancelled")
-00014400: 0a0a 2020 2020 2020 2020 7365 6c66 2e5f  ..        self._
-00014410: 736c 6f77 5f64 6f77 6e28 290a 0a20 2020  slow_down()..   
-00014420: 2020 2020 2065 7665 6e74 2e73 7461 7475       event.statu
-00014430: 7320 3d20 5379 6e63 5374 6174 7573 2e53  s = SyncStatus.S
-00014440: 796e 6369 6e67 0a0a 2020 2020 2020 2020  yncing..        
-00014450: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
-00014460: 2069 6620 6576 656e 742e 6973 5f66 696c   if event.is_fil
-00014470: 6520 616e 6420 2865 7665 6e74 2e69 735f  e and (event.is_
-00014480: 6164 6465 6420 6f72 2065 7665 6e74 2e69  added or event.i
-00014490: 735f 6368 616e 6765 6429 3a0a 2020 2020  s_changed):.    
-000144a0: 2020 2020 2020 2020 2020 2020 7374 6174              stat
-000144b0: 7573 203d 2073 656c 662e 5f6f 6e5f 6c6f  us = self._on_lo
-000144c0: 6361 6c5f 6669 6c65 5f6d 6f64 6966 6965  cal_file_modifie
-000144d0: 6428 6576 656e 7429 0a20 2020 2020 2020  d(event).       
-000144e0: 2020 2020 2065 6c69 6620 6576 656e 742e       elif event.
-000144f0: 6973 5f64 6972 6563 746f 7279 2061 6e64  is_directory and
-00014500: 2065 7665 6e74 2e69 735f 6164 6465 643a   event.is_added:
-00014510: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00014520: 2073 7461 7475 7320 3d20 7365 6c66 2e5f   status = self._
-00014530: 6f6e 5f6c 6f63 616c 5f66 6f6c 6465 725f  on_local_folder_
-00014540: 6372 6561 7465 6428 6576 656e 7429 0a20  created(event). 
-00014550: 2020 2020 2020 2020 2020 2065 6c69 6620             elif 
-00014560: 6576 656e 742e 6973 5f6d 6f76 6564 3a0a  event.is_moved:.
-00014570: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014580: 7374 6174 7573 203d 2073 656c 662e 5f6f  status = self._o
-00014590: 6e5f 6c6f 6361 6c5f 6d6f 7665 6428 6576  n_local_moved(ev
-000145a0: 656e 7429 0a20 2020 2020 2020 2020 2020  ent).           
-000145b0: 2065 6c69 6620 6576 656e 742e 6973 5f64   elif event.is_d
-000145c0: 656c 6574 6564 3a0a 2020 2020 2020 2020  eleted:.        
-000145d0: 2020 2020 2020 2020 7374 6174 7573 203d          status =
-000145e0: 2073 656c 662e 5f6f 6e5f 6c6f 6361 6c5f   self._on_local_
-000145f0: 6465 6c65 7465 6428 6576 656e 7429 0a20  deleted(event). 
-00014600: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
-00014610: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00014620: 2073 7461 7475 7320 3d20 5379 6e63 5374   status = SyncSt
-00014630: 6174 7573 2e53 6b69 7070 6564 0a0a 2020  atus.Skipped..  
-00014640: 2020 2020 2020 2020 2020 6576 656e 742e            event.
-00014650: 7374 6174 7573 203d 2073 7461 7475 730a  status = status.
-00014660: 0a20 2020 2020 2020 2065 7863 6570 7420  .        except 
-00014670: 5379 6e63 4572 726f 7220 6173 2065 7272  SyncError as err
-00014680: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
-00014690: 6c66 2e5f 6861 6e64 6c65 5f73 796e 635f  lf._handle_sync_
-000146a0: 6572 726f 7228 6572 722c 2064 6972 6563  error(err, direc
-000146b0: 7469 6f6e 3d53 796e 6344 6972 6563 7469  tion=SyncDirecti
-000146c0: 6f6e 2e55 7029 0a20 2020 2020 2020 2020  on.Up).         
-000146d0: 2020 2065 7665 6e74 2e73 7461 7475 7320     event.status 
-000146e0: 3d20 5379 6e63 5374 6174 7573 2e46 6169  = SyncStatus.Fai
-000146f0: 6c65 640a 2020 2020 2020 2020 656c 7365  led.        else
-00014700: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
-00014710: 6c66 2e63 6c65 6172 5f73 796e 635f 6572  lf.clear_sync_er
-00014720: 726f 7273 5f66 726f 6d5f 6576 656e 7428  rors_from_event(
-00014730: 6576 656e 7429 0a20 2020 2020 2020 2020  event).         
-00014740: 2020 2073 656c 662e 6163 7469 7669 7479     self.activity
-00014750: 2e64 6973 6361 7264 2865 7665 6e74 290a  .discard(event).
-00014760: 0a20 2020 2020 2020 2023 2041 6464 2065  .        # Add e
-00014770: 7665 6e74 7320 746f 2068 6973 746f 7279  vents to history
-00014780: 2064 6174 6162 6173 652e 0a20 2020 2020   database..     
-00014790: 2020 2069 6620 6576 656e 742e 7374 6174     if event.stat
-000147a0: 7573 203d 3d20 5379 6e63 5374 6174 7573  us == SyncStatus
-000147b0: 2e44 6f6e 653a 0a20 2020 2020 2020 2020  .Done:.         
-000147c0: 2020 2077 6974 6820 7365 6c66 2e5f 6461     with self._da
-000147d0: 7461 6261 7365 5f61 6363 6573 7328 293a  tabase_access():
-000147e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000147f0: 2073 656c 662e 5f68 6973 746f 7279 5f74   self._history_t
-00014800: 6162 6c65 2e73 6176 6528 6576 656e 7429  able.save(event)
-00014810: 0a0a 2020 2020 2020 2020 7265 7475 726e  ..        return
-00014820: 2065 7665 6e74 0a0a 2020 2020 4073 7461   event..    @sta
-00014830: 7469 636d 6574 686f 640a 2020 2020 6465  ticmethod.    de
-00014840: 6620 5f77 6169 745f 666f 725f 6372 6561  f _wait_for_crea
-00014850: 7469 6f6e 286c 6f63 616c 5f70 6174 683a  tion(local_path:
-00014860: 2073 7472 2920 2d3e 204e 6f6e 653a 0a20   str) -> None:. 
-00014870: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
-00014880: 2020 2057 6169 7420 666f 7220 6120 6669     Wait for a fi
-00014890: 6c65 2061 7420 6120 7061 7468 2074 6f20  le at a path to 
-000148a0: 6265 2063 7265 6174 6564 206f 7220 6d6f  be created or mo
-000148b0: 6469 6669 6564 2e0a 0a20 2020 2020 2020  dified...       
-000148c0: 203a 7061 7261 6d20 6c6f 6361 6c5f 7061   :param local_pa
-000148d0: 7468 3a20 4162 736f 6c75 7465 2070 6174  th: Absolute pat
-000148e0: 6820 746f 2066 696c 6520 6f6e 2064 7269  h to file on dri
-000148f0: 7665 2e0a 2020 2020 2020 2020 2222 220a  ve..        """.
-00014900: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
-00014910: 2020 2020 2020 2020 2077 6869 6c65 2054           while T
-00014920: 7275 653a 0a20 2020 2020 2020 2020 2020  rue:.           
-00014930: 2020 2020 2073 697a 6531 203d 2067 6574       size1 = get
-00014940: 7369 7a65 286c 6f63 616c 5f70 6174 6829  size(local_path)
-00014950: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00014960: 2074 696d 652e 736c 6565 7028 302e 3229   time.sleep(0.2)
-00014970: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00014980: 2073 697a 6532 203d 2067 6574 7369 7a65   size2 = getsize
-00014990: 286c 6f63 616c 5f70 6174 6829 0a20 2020  (local_path).   
-000149a0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-000149b0: 7369 7a65 3120 3d3d 2073 697a 6532 3a0a  size1 == size2:.
-000149c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000149d0: 2020 2020 7265 7475 726e 0a20 2020 2020      return.     
-000149e0: 2020 2065 7863 6570 7420 4f53 4572 726f     except OSErro
-000149f0: 723a 0a20 2020 2020 2020 2020 2020 2072  r:.            r
-00014a00: 6574 7572 6e0a 0a20 2020 2064 6566 205f  eturn..    def _
-00014a10: 6f6e 5f6c 6f63 616c 5f6d 6f76 6564 2873  on_local_moved(s
-00014a20: 656c 662c 2065 7665 6e74 3a20 5379 6e63  elf, event: Sync
-00014a30: 4576 656e 7429 202d 3e20 5379 6e63 5374  Event) -> SyncSt
-00014a40: 6174 7573 3a0a 2020 2020 2020 2020 2222  atus:.        ""
-00014a50: 220a 2020 2020 2020 2020 4361 6c6c 2077  ".        Call w
-00014a60: 6865 6e20 6120 6c6f 6361 6c20 6974 656d  hen a local item
-00014a70: 2069 7320 6d6f 7665 642e 0a0a 2020 2020   is moved...    
-00014a80: 2020 2020 4b65 6570 2069 6e20 6d69 6e64      Keep in mind
-00014a90: 2074 6861 7420 7765 206d 6179 2062 6520   that we may be 
-00014aa0: 6d6f 7669 6e67 2061 2077 686f 6c65 2074  moving a whole t
-00014ab0: 7265 6520 6f66 2069 7465 6d73 2e20 4275  ree of items. Bu
-00014ac0: 7420 6974 7320 6265 7474 6572 2064 6561  t its better dea
-00014ad0: 6c0a 2020 2020 2020 2020 7769 7468 2074  l.        with t
-00014ae0: 6865 2063 6f6d 706c 6578 6974 7920 7468  he complexity th
-00014af0: 616e 2074 6f20 6465 6c65 7465 2061 6e64  an to delete and
-00014b00: 2072 652d 7570 6c6f 6164 696e 6720 6576   re-uploading ev
-00014b10: 6572 7974 6869 6e67 2e20 5468 616e 6b66  erything. Thankf
-00014b20: 756c 6c79 2c20 696e 0a20 2020 2020 2020  ully, in.       
-00014b30: 2063 6173 6520 6f66 2064 6972 6563 746f   case of directo
-00014b40: 7269 6573 2c20 7765 2061 6c77 6179 7320  ries, we always 
-00014b50: 7072 6f63 6573 7320 7468 6520 746f 702d  process the top-
-00014b60: 6c65 7665 6c20 6669 7273 742e 2054 7279  level first. Try
-00014b70: 696e 6720 746f 206d 6f76 6520 7468 650a  ing to move the.
-00014b80: 2020 2020 2020 2020 6368 696c 6472 656e          children
-00014b90: 2077 696c 6c20 7468 656e 2062 6520 6465   will then be de
-00014ba0: 6c65 6761 7465 6420 746f 2060 6f6e 5f63  legated to `on_c
-00014bb0: 7265 6174 6560 2028 6265 6361 7573 6520  reate` (because 
-00014bc0: 7468 6520 6f6c 6420 6974 656d 206e 6f20  the old item no 
-00014bd0: 6c6f 6e67 6572 0a20 2020 2020 2020 206c  longer.        l
-00014be0: 6976 6573 206f 6e20 4472 6f70 626f 7829  ives on Dropbox)
-00014bf0: 2061 6e64 2074 6861 7420 776f 6e27 7420   and that won't 
-00014c00: 7570 6c6f 6164 2061 6e79 7468 696e 6720  upload anything 
-00014c10: 6265 6361 7573 6520 6669 6c65 2063 6f6e  because file con
-00014c20: 7465 6e74 7320 6861 7665 0a20 2020 2020  tents have.     
-00014c30: 2020 2072 656d 6169 6e65 6420 7468 6520     remained the 
-00014c40: 7361 6d65 2e0a 0a20 2020 2020 2020 203a  same...        :
-00014c50: 7061 7261 6d20 6576 656e 743a 2053 796e  param event: Syn
-00014c60: 6345 7665 6e74 2066 6f72 206c 6f63 616c  cEvent for local
-00014c70: 206d 6f76 6564 2065 7665 6e74 2e0a 2020   moved event..  
-00014c80: 2020 2020 2020 3a72 6574 7572 6e73 3a20        :returns: 
-00014c90: 4d65 7461 6461 7461 2066 6f72 2063 7265  Metadata for cre
-00014ca0: 6174 6564 2072 656d 6f74 6520 6974 656d  ated remote item
-00014cb0: 2061 7420 6465 7374 696e 6174 696f 6e2e   at destination.
-00014cc0: 0a20 2020 2020 2020 203a 7261 6973 6573  .        :raises
-00014cd0: 204d 6165 7374 7261 6c41 7069 4572 726f   MaestralApiErro
-00014ce0: 723a 2046 6f72 2061 6e79 2069 7373 7565  r: For any issue
-00014cf0: 7320 7768 656e 2073 796e 6369 6e67 2074  s when syncing t
-00014d00: 6865 2069 7465 6d2e 0a20 2020 2020 2020  he item..       
-00014d10: 2022 2222 0a20 2020 2020 2020 2063 6865   """.        che
-00014d20: 636b 5f63 6861 6e67 655f 7479 7065 2865  ck_change_type(e
-00014d30: 7665 6e74 2c20 7b43 6861 6e67 6554 7970  vent, {ChangeTyp
-00014d40: 652e 4d6f 7665 647d 290a 2020 2020 2020  e.Moved}).      
-00014d50: 2020 6368 6563 6b5f 656e 636f 6469 6e67    check_encoding
-00014d60: 2865 7665 6e74 2e6c 6f63 616c 5f70 6174  (event.local_pat
-00014d70: 6829 0a0a 2020 2020 2020 2020 6966 2065  h)..        if e
-00014d80: 7665 6e74 2e6c 6f63 616c 5f70 6174 685f  vent.local_path_
-00014d90: 6672 6f6d 203d 3d20 7365 6c66 2e64 726f  from == self.dro
-00014da0: 7062 6f78 5f70 6174 683a 0a20 2020 2020  pbox_path:.     
-00014db0: 2020 2020 2020 2073 656c 662e 656e 7375         self.ensu
-00014dc0: 7265 5f64 726f 7062 6f78 5f66 6f6c 6465  re_dropbox_folde
-00014dd0: 725f 7072 6573 656e 7428 290a 0a20 2020  r_present()..   
-00014de0: 2020 2020 2069 6620 7365 6c66 2e5f 6861       if self._ha
-00014df0: 6e64 6c65 5f73 656c 6563 7469 7665 5f73  ndle_selective_s
-00014e00: 796e 635f 636f 6e66 6c69 6374 2865 7665  ync_conflict(eve
-00014e10: 6e74 293a 0a20 2020 2020 2020 2020 2020  nt):.           
-00014e20: 2072 6574 7572 6e20 5379 6e63 5374 6174   return SyncStat
-00014e30: 7573 2e53 6b69 7070 6564 0a20 2020 2020  us.Skipped.     
-00014e40: 2020 2069 6620 7365 6c66 2e5f 6861 6e64     if self._hand
-00014e50: 6c65 5f6e 6f72 6d61 6c69 7a61 7469 6f6e  le_normalization
-00014e60: 5f63 6f6e 666c 6963 7428 6576 656e 7429  _conflict(event)
-00014e70: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
-00014e80: 7475 726e 2053 796e 6353 7461 7475 732e  turn SyncStatus.
-00014e90: 536b 6970 7065 640a 0a20 2020 2020 2020  Skipped..       
-00014ea0: 2064 6278 5f70 6174 685f 6672 6f6d 203d   dbx_path_from =
-00014eb0: 2063 6173 7428 7374 722c 2065 7665 6e74   cast(str, event
-00014ec0: 2e64 6278 5f70 6174 685f 6672 6f6d 290a  .dbx_path_from).
-00014ed0: 0a20 2020 2020 2020 2023 2049 6620 6120  .        # If a 
-00014ee0: 6669 6c65 2061 7420 7468 6520 6465 7374  file at the dest
-00014ef0: 696e 6174 696f 6e20 7368 6f75 6c64 2062  ination should b
-00014f00: 6520 7265 706c 6163 6564 2c20 7265 6d6f  e replaced, remo
-00014f10: 7665 2069 7420 6669 7273 742c 2062 7574  ve it first, but
-00014f20: 206f 6e6c 7920 6966 0a20 2020 2020 2020   only if.       
-00014f30: 2023 2069 7473 2072 6576 206d 6174 6368   # its rev match
-00014f40: 6573 2074 6865 2072 6576 206f 6620 7468  es the rev of th
-00014f50: 6520 6c6f 6361 6c20 6f76 6572 7772 6974  e local overwrit
-00014f60: 7465 6e20 6669 6c65 2e0a 2020 2020 2020  ten file..      
-00014f70: 2020 2320 5468 6520 4472 6f70 626f 7820    # The Dropbox 
-00014f80: 4150 4920 646f 6573 206e 6f74 2061 6c6c  API does not all
-00014f90: 6f77 206f 7665 7277 7269 7469 6e67 2061  ow overwriting a
-00014fa0: 2064 6573 7469 6e61 7469 6f6e 2066 696c   destination fil
-00014fb0: 6520 6475 7269 6e67 2061 206d 6f76 652e  e during a move.
-00014fc0: 0a20 2020 2020 2020 206c 6f63 616c 5f65  .        local_e
-00014fd0: 6e74 7279 203d 2073 656c 662e 6765 745f  ntry = self.get_
-00014fe0: 696e 6465 785f 656e 7472 7928 6576 656e  index_entry(even
-00014ff0: 742e 6462 785f 7061 7468 5f6c 6f77 6572  t.dbx_path_lower
-00015000: 290a 0a20 2020 2020 2020 2069 6620 6c6f  )..        if lo
-00015010: 6361 6c5f 656e 7472 7920 616e 6420 6c6f  cal_entry and lo
-00015020: 6361 6c5f 656e 7472 792e 6973 5f66 696c  cal_entry.is_fil
-00015030: 653a 0a20 2020 2020 2020 2020 2020 2074  e:.            t
-00015040: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
-00015050: 2020 2020 7365 6c66 2e63 6c69 656e 742e      self.client.
-00015060: 7265 6d6f 7665 280a 2020 2020 2020 2020  remove(.        
-00015070: 2020 2020 2020 2020 2020 2020 6c6f 6361              loca
-00015080: 6c5f 656e 7472 792e 6462 785f 7061 7468  l_entry.dbx_path
-00015090: 5f6c 6f77 6572 2c20 7061 7265 6e74 5f72  _lower, parent_r
-000150a0: 6576 3d6c 6f63 616c 5f65 6e74 7279 2e72  ev=local_entry.r
-000150b0: 6576 0a20 2020 2020 2020 2020 2020 2020  ev.             
-000150c0: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
-000150d0: 2065 7863 6570 7420 284e 6f74 466f 756e   except (NotFoun
-000150e0: 6445 7272 6f72 2c20 4669 6c65 436f 6e66  dError, FileConf
-000150f0: 6c69 6374 4572 726f 7229 3a0a 2020 2020  lictError):.    
-00015100: 2020 2020 2020 2020 2020 2020 7061 7373              pass
-00015110: 0a20 2020 2020 2020 2020 2020 2065 6c73  .            els
-00015120: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-00015130: 2020 2073 656c 662e 5f6c 6f67 6765 722e     self._logger.
-00015140: 6465 6275 6728 0a20 2020 2020 2020 2020  debug(.         
-00015150: 2020 2020 2020 2020 2020 2027 5265 706c             'Repl
-00015160: 6163 696e 6720 6578 6973 7469 6e67 2066  acing existing f
-00015170: 696c 6520 2225 7322 2062 7920 6d6f 7665  ile "%s" by move
-00015180: 272c 206c 6f63 616c 5f65 6e74 7279 2e64  ', local_entry.d
-00015190: 6278 5f70 6174 685f 6c6f 7765 720a 2020  bx_path_lower.  
-000151a0: 2020 2020 2020 2020 2020 2020 2020 290a                ).
-000151b0: 0a20 2020 2020 2020 2023 2050 6572 666f  .        # Perfo
-000151c0: 726d 2074 6865 206d 6f76 652e 0a20 2020  rm the move..   
-000151d0: 2020 2020 2074 7279 3a0a 2020 2020 2020       try:.      
-000151e0: 2020 2020 2020 6d64 5f74 6f5f 6e65 7720        md_to_new 
-000151f0: 3d20 7365 6c66 2e63 6c69 656e 742e 6d6f  = self.client.mo
-00015200: 7665 2864 6278 5f70 6174 685f 6672 6f6d  ve(dbx_path_from
-00015210: 2c20 6576 656e 742e 6462 785f 7061 7468  , event.dbx_path
-00015220: 2c20 6175 746f 7265 6e61 6d65 3d54 7275  , autorename=Tru
-00015230: 6529 0a20 2020 2020 2020 2065 7863 6570  e).        excep
-00015240: 7420 4e6f 7446 6f75 6e64 4572 726f 723a  t NotFoundError:
-00015250: 0a20 2020 2020 2020 2020 2020 2023 2049  .            # I
-00015260: 6620 6e6f 7420 6f6e 2044 726f 7062 6f78  f not on Dropbox
-00015270: 2c20 652e 672e 2c20 6265 6361 7573 6520  , e.g., because 
-00015280: 6974 7320 6f6c 6420 6e61 6d65 2077 6173  its old name was
-00015290: 2069 6e76 616c 6964 2c0a 2020 2020 2020   invalid,.      
-000152a0: 2020 2020 2020 2320 6372 6561 7465 2069        # create i
-000152b0: 7420 696e 7374 6561 6420 6f66 206d 6f76  t instead of mov
-000152c0: 696e 6720 6974 2e0a 2020 2020 2020 2020  ing it..        
-000152d0: 2020 2020 7365 6c66 2e5f 6c6f 6767 6572      self._logger
-000152e0: 2e64 6562 7567 280a 2020 2020 2020 2020  .debug(.        
-000152f0: 2020 2020 2020 2020 2743 6f75 6c64 206e          'Could n
-00015300: 6f74 206d 6f76 6520 2225 7322 202d 3e20  ot move "%s" -> 
-00015310: 2225 7322 206f 6e20 4472 6f70 626f 782c  "%s" on Dropbox,
-00015320: 2073 6f75 7263 6520 646f 6573 206e 6f74   source does not
-00015330: 2065 7869 7374 732e 2027 0a20 2020 2020   exists. '.     
-00015340: 2020 2020 2020 2020 2020 2027 4372 6561             'Crea
-00015350: 7469 6e67 2022 2573 2220 696e 7374 6561  ting "%s" instea
-00015360: 6427 2c0a 2020 2020 2020 2020 2020 2020  d',.            
-00015370: 2020 2020 6576 656e 742e 6462 785f 7061      event.dbx_pa
-00015380: 7468 5f66 726f 6d2c 0a20 2020 2020 2020  th_from,.       
-00015390: 2020 2020 2020 2020 2065 7665 6e74 2e64           event.d
-000153a0: 6278 5f70 6174 682c 0a20 2020 2020 2020  bx_path,.       
-000153b0: 2020 2020 2020 2020 2065 7665 6e74 2e64           event.d
-000153c0: 6278 5f70 6174 682c 0a20 2020 2020 2020  bx_path,.       
-000153d0: 2020 2020 2029 0a0a 2020 2020 2020 2020       )..        
-000153e0: 2020 2020 7365 6c66 2e72 6573 6361 6e28      self.rescan(
-000153f0: 6576 656e 742e 6c6f 6361 6c5f 7061 7468  event.local_path
-00015400: 290a 2020 2020 2020 2020 2020 2020 7265  ).            re
-00015410: 7475 726e 2053 796e 6353 7461 7475 732e  turn SyncStatus.
-00015420: 536b 6970 7065 640a 0a20 2020 2020 2020  Skipped..       
-00015430: 2061 7373 6572 7420 6576 656e 742e 6462   assert event.db
-00015440: 785f 7061 7468 5f66 726f 6d5f 6c6f 7765  x_path_from_lowe
-00015450: 7220 6973 206e 6f74 204e 6f6e 650a 2020  r is not None.  
-00015460: 2020 2020 2020 7365 6c66 2e72 656d 6f76        self.remov
-00015470: 655f 6e6f 6465 5f66 726f 6d5f 696e 6465  e_node_from_inde
-00015480: 7828 6576 656e 742e 6462 785f 7061 7468  x(event.dbx_path
-00015490: 5f66 726f 6d5f 6c6f 7765 7229 0a0a 2020  _from_lower)..  
-000154a0: 2020 2020 2020 6966 2073 656c 662e 5f68        if self._h
-000154b0: 616e 646c 655f 7570 6c6f 6164 5f63 6f6e  andle_upload_con
-000154c0: 666c 6963 7428 6d64 5f74 6f5f 6e65 772c  flict(md_to_new,
-000154d0: 2065 7665 6e74 293a 0a20 2020 2020 2020   event):.       
-000154e0: 2020 2020 2073 7461 7475 7320 3d20 5379       status = Sy
-000154f0: 6e63 5374 6174 7573 2e43 6f6e 666c 6963  ncStatus.Conflic
-00015500: 740a 2020 2020 2020 2020 656c 7365 3a0a  t.        else:.
-00015510: 2020 2020 2020 2020 2020 2020 7374 6174              stat
-00015520: 7573 203d 2053 796e 6353 7461 7475 732e  us = SyncStatus.
-00015530: 446f 6e65 0a20 2020 2020 2020 2020 2020  Done.           
-00015540: 2073 656c 662e 5f6c 6f67 6765 722e 6465   self._logger.de
-00015550: 6275 6728 0a20 2020 2020 2020 2020 2020  bug(.           
-00015560: 2020 2020 2027 4d6f 7665 6420 2225 7322       'Moved "%s"
-00015570: 2074 6f20 2225 7322 206f 6e20 4472 6f70   to "%s" on Drop
-00015580: 626f 7827 2c20 6462 785f 7061 7468 5f66  box', dbx_path_f
-00015590: 726f 6d2c 2065 7665 6e74 2e64 6278 5f70  rom, event.dbx_p
-000155a0: 6174 680a 2020 2020 2020 2020 2020 2020  ath.            
-000155b0: 290a 2020 2020 2020 2020 7365 6c66 2e5f  ).        self._
-000155c0: 7570 6461 7465 5f69 6e64 6578 5f72 6563  update_index_rec
-000155d0: 7572 7369 7665 286d 645f 746f 5f6e 6577  ursive(md_to_new
-000155e0: 290a 0a20 2020 2020 2020 2072 6574 7572  )..        retur
-000155f0: 6e20 7374 6174 7573 0a0a 2020 2020 6465  n status..    de
-00015600: 6620 5f75 7064 6174 655f 696e 6465 785f  f _update_index_
-00015610: 7265 6375 7273 6976 6528 7365 6c66 2c20  recursive(self, 
-00015620: 6d64 3a20 4d65 7461 6461 7461 2920 2d3e  md: Metadata) ->
-00015630: 204e 6f6e 653a 0a20 2020 2020 2020 2073   None:.        s
-00015640: 656c 662e 7570 6461 7465 5f69 6e64 6578  elf.update_index
-00015650: 5f66 726f 6d5f 6462 785f 6d65 7461 6461  _from_dbx_metada
-00015660: 7461 286d 6429 0a0a 2020 2020 2020 2020  ta(md)..        
-00015670: 6966 2069 7369 6e73 7461 6e63 6528 6d64  if isinstance(md
-00015680: 2c20 466f 6c64 6572 4d65 7461 6461 7461  , FolderMetadata
-00015690: 293a 0a20 2020 2020 2020 2020 2020 2072  ):.            r
-000156a0: 6573 756c 7420 3d20 7365 6c66 2e63 6c69  esult = self.cli
-000156b0: 656e 742e 6c69 7374 5f66 6f6c 6465 7228  ent.list_folder(
-000156c0: 6d64 2e70 6174 685f 6c6f 7765 722c 2072  md.path_lower, r
-000156d0: 6563 7572 7369 7665 3d54 7275 6529 0a20  ecursive=True). 
-000156e0: 2020 2020 2020 2020 2020 2066 6f72 206d             for m
-000156f0: 6420 696e 2072 6573 756c 742e 656e 7472  d in result.entr
-00015700: 6965 733a 0a20 2020 2020 2020 2020 2020  ies:.           
-00015710: 2020 2020 2073 656c 662e 7570 6461 7465       self.update
-00015720: 5f69 6e64 6578 5f66 726f 6d5f 6462 785f  _index_from_dbx_
-00015730: 6d65 7461 6461 7461 286d 6429 0a0a 2020  metadata(md)..  
-00015740: 2020 6465 6620 5f6f 6e5f 6c6f 6361 6c5f    def _on_local_
-00015750: 6669 6c65 5f6d 6f64 6966 6965 6428 7365  file_modified(se
-00015760: 6c66 2c20 6576 656e 743a 2053 796e 6345  lf, event: SyncE
-00015770: 7665 6e74 2920 2d3e 2053 796e 6353 7461  vent) -> SyncSta
-00015780: 7475 733a 0a20 2020 2020 2020 2022 2222  tus:.        """
-00015790: 0a20 2020 2020 2020 2043 616c 6c20 7768  .        Call wh
-000157a0: 656e 2061 206c 6f63 616c 2066 696c 6520  en a local file 
-000157b0: 6973 2063 7265 6174 6564 206f 7220 6d6f  is created or mo
-000157c0: 6469 6669 6564 2e0a 0a20 2020 2020 2020  dified...       
-000157d0: 203a 7061 7261 6d20 6576 656e 743a 2053   :param event: S
-000157e0: 796e 6345 7665 6e74 2063 6f72 7265 7370  yncEvent corresp
-000157f0: 6f6e 6469 6e67 2074 6f20 6c6f 6361 6c20  onding to local 
-00015800: 6372 6561 7465 6420 6576 656e 742e 0a20  created event.. 
-00015810: 2020 2020 2020 203a 7265 7475 726e 733a         :returns:
-00015820: 204d 6574 6164 6174 6120 666f 7220 6372   Metadata for cr
-00015830: 6561 7465 6420 6974 656d 206f 7220 4e6f  eated item or No
-00015840: 6e65 2069 6620 6e6f 2072 656d 6f74 6520  ne if no remote 
-00015850: 6974 656d 2069 7320 6372 6561 7465 642e  item is created.
-00015860: 0a20 2020 2020 2020 203a 7261 6973 6573  .        :raises
-00015870: 204d 6165 7374 7261 6c41 7069 4572 726f   MaestralApiErro
-00015880: 723a 2046 6f72 2061 6e79 2069 7373 7565  r: For any issue
-00015890: 7320 7768 656e 2073 796e 6369 6e67 2074  s when syncing t
-000158a0: 6865 2069 7465 6d2e 0a20 2020 2020 2020  he item..       
-000158b0: 203a 7261 6973 6573 2056 616c 7565 4572   :raises ValueEr
-000158c0: 726f 723a 2049 6620 7468 6520 4368 616e  ror: If the Chan
-000158d0: 6765 5479 7065 2069 7320 6e6f 7420 4164  geType is not Ad
-000158e0: 6465 6420 6f72 204d 6f64 6966 6965 642e  ded or Modified.
-000158f0: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
-00015900: 2020 2020 2063 6865 636b 5f63 6861 6e67       check_chang
-00015910: 655f 7479 7065 2865 7665 6e74 2c20 7b43  e_type(event, {C
-00015920: 6861 6e67 6554 7970 652e 4164 6465 642c  hangeType.Added,
-00015930: 2043 6861 6e67 6554 7970 652e 4d6f 6469   ChangeType.Modi
-00015940: 6669 6564 7d29 0a20 2020 2020 2020 2063  fied}).        c
-00015950: 6865 636b 5f65 6e63 6f64 696e 6728 6576  heck_encoding(ev
-00015960: 656e 742e 6c6f 6361 6c5f 7061 7468 290a  ent.local_path).
-00015970: 0a20 2020 2020 2020 2069 6620 7365 6c66  .        if self
-00015980: 2e5f 6861 6e64 6c65 5f73 656c 6563 7469  ._handle_selecti
-00015990: 7665 5f73 796e 635f 636f 6e66 6c69 6374  ve_sync_conflict
-000159a0: 2865 7665 6e74 293a 0a20 2020 2020 2020  (event):.       
-000159b0: 2020 2020 2072 6574 7572 6e20 5379 6e63       return Sync
-000159c0: 5374 6174 7573 2e43 6f6e 666c 6963 740a  Status.Conflict.
-000159d0: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
-000159e0: 5f68 616e 646c 655f 6e6f 726d 616c 697a  _handle_normaliz
-000159f0: 6174 696f 6e5f 636f 6e66 6c69 6374 2865  ation_conflict(e
-00015a00: 7665 6e74 293a 0a20 2020 2020 2020 2020  vent):.         
-00015a10: 2020 2072 6574 7572 6e20 5379 6e63 5374     return SyncSt
-00015a20: 6174 7573 2e43 6f6e 666c 6963 740a 0a20  atus.Conflict.. 
-00015a30: 2020 2020 2020 2073 656c 662e 5f77 6169         self._wai
-00015a40: 745f 666f 725f 6372 6561 7469 6f6e 2865  t_for_creation(e
-00015a50: 7665 6e74 2e6c 6f63 616c 5f70 6174 6829  vent.local_path)
-00015a60: 0a0a 2020 2020 2020 2020 2320 4368 6563  ..        # Chec
-00015a70: 6b20 6966 2069 7465 6d20 616c 7265 6164  k if item alread
-00015a80: 7920 6578 6973 7473 2077 6974 6820 6964  y exists with id
-00015a90: 656e 7469 6361 6c20 636f 6e74 656e 742e  entical content.
-00015aa0: 0a20 2020 2020 2020 2069 6620 6e6f 7420  .        if not 
-00015ab0: 7365 6c66 2e5f 6368 6563 6b5f 7265 7175  self._check_requ
-00015ac0: 6972 6573 5f75 706c 6f61 6428 6576 656e  ires_upload(even
-00015ad0: 7429 3a0a 2020 2020 2020 2020 2020 2020  t):.            
-00015ae0: 7265 7475 726e 2053 796e 6353 7461 7475  return SyncStatu
-00015af0: 732e 536b 6970 7065 640a 0a20 2020 2020  s.Skipped..     
-00015b00: 2020 206c 6f63 616c 5f65 6e74 7279 203d     local_entry =
-00015b10: 2073 656c 662e 6765 745f 696e 6465 785f   self.get_index_
-00015b20: 656e 7472 7928 6576 656e 742e 6462 785f  entry(event.dbx_
-00015b30: 7061 7468 5f6c 6f77 6572 290a 2020 2020  path_lower).    
-00015b40: 2020 2020 6c6f 6361 6c5f 7265 763a 2073      local_rev: s
-00015b50: 7472 207c 204e 6f6e 6520 3d20 4e6f 6e65  tr | None = None
-00015b60: 0a0a 2020 2020 2020 2020 6966 206e 6f74  ..        if not
-00015b70: 206c 6f63 616c 5f65 6e74 7279 3a0a 2020   local_entry:.  
-00015b80: 2020 2020 2020 2020 2020 2320 4669 6c65            # File
-00015b90: 2069 7320 6e65 7720 746f 2075 732c 206c   is new to us, l
-00015ba0: 6574 2044 726f 7062 6f78 2072 656e 616d  et Dropbox renam
-00015bb0: 6520 6974 2069 6620 736f 6d65 7468 696e  e it if somethin
-00015bc0: 6720 6973 2069 6e20 7468 6520 7761 792e  g is in the way.
-00015bd0: 0a20 2020 2020 2020 2020 2020 206d 6f64  .            mod
-00015be0: 6520 3d20 5772 6974 654d 6f64 652e 4164  e = WriteMode.Ad
-00015bf0: 640a 2020 2020 2020 2020 2020 2020 6576  d.            ev
-00015c00: 656e 742e 6368 616e 6765 5f74 7970 6520  ent.change_type 
-00015c10: 3d20 4368 616e 6765 5479 7065 2e41 6464  = ChangeType.Add
-00015c20: 6564 0a20 2020 2020 2020 2065 6c69 6620  ed.        elif 
-00015c30: 6c6f 6361 6c5f 656e 7472 792e 6973 5f64  local_entry.is_d
-00015c40: 6972 6563 746f 7279 3a0a 2020 2020 2020  irectory:.      
-00015c50: 2020 2020 2020 2320 5472 7920 746f 206f        # Try to o
-00015c60: 7665 7277 7269 7465 2074 6865 2064 6573  verwrite the des
-00015c70: 7469 6e61 7469 6f6e 2c20 7468 6973 2077  tination, this w
-00015c80: 696c 6c20 6661 696c 2e2e 2e0a 2020 2020  ill fail....    
-00015c90: 2020 2020 2020 2020 6d6f 6465 203d 2057          mode = W
-00015ca0: 7269 7465 4d6f 6465 2e4f 7665 7277 7269  riteMode.Overwri
-00015cb0: 7465 0a20 2020 2020 2020 2065 6c73 653a  te.        else:
-00015cc0: 0a20 2020 2020 2020 2020 2020 2023 2046  .            # F
-00015cd0: 696c 6520 6861 7320 6265 656e 206d 6f64  ile has been mod
-00015ce0: 6966 6965 642c 2075 7064 6174 6520 7265  ified, update re
-00015cf0: 6d6f 7465 2069 6620 6d61 7463 6869 6e67  mote if matching
-00015d00: 2072 6576 2c0a 2020 2020 2020 2020 2020   rev,.          
-00015d10: 2020 2320 6372 6561 7465 2063 6f6e 666c    # create confl
-00015d20: 6963 7420 6f74 6865 7277 6973 652e 0a20  ict otherwise.. 
-00015d30: 2020 2020 2020 2020 2020 206d 6f64 6520             mode 
-00015d40: 3d20 5772 6974 654d 6f64 652e 5570 6461  = WriteMode.Upda
-00015d50: 7465 0a20 2020 2020 2020 2020 2020 2065  te.            e
-00015d60: 7665 6e74 2e63 6861 6e67 655f 7479 7065  vent.change_type
-00015d70: 203d 2043 6861 6e67 6554 7970 652e 4d6f   = ChangeType.Mo
-00015d80: 6469 6669 6564 0a20 2020 2020 2020 2020  dified.         
-00015d90: 2020 206c 6f63 616c 5f72 6576 203d 206c     local_rev = l
-00015da0: 6f63 616c 5f65 6e74 7279 2e72 6576 0a0a  ocal_entry.rev..
-00015db0: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
-00015dc0: 2020 2020 2020 2020 2077 6974 6820 7365           with se
-00015dd0: 6c66 2e5f 7061 7261 6c6c 656c 5f75 705f  lf._parallel_up_
-00015de0: 7365 6d61 7068 6f72 653a 0a20 2020 2020  semaphore:.     
-00015df0: 2020 2020 2020 2020 2020 206d 645f 6e65             md_ne
-00015e00: 7720 3d20 7365 6c66 2e63 6c69 656e 742e  w = self.client.
-00015e10: 7570 6c6f 6164 280a 2020 2020 2020 2020  upload(.        
-00015e20: 2020 2020 2020 2020 2020 2020 6576 656e              even
-00015e30: 742e 6c6f 6361 6c5f 7061 7468 2c0a 2020  t.local_path,.  
-00015e40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015e50: 2020 6576 656e 742e 6462 785f 7061 7468    event.dbx_path
-00015e60: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00015e70: 2020 2020 2020 6175 746f 7265 6e61 6d65        autorename
-00015e80: 3d54 7275 652c 0a20 2020 2020 2020 2020  =True,.         
-00015e90: 2020 2020 2020 2020 2020 2077 7269 7465             write
-00015ea0: 5f6d 6f64 653d 6d6f 6465 2c0a 2020 2020  _mode=mode,.    
-00015eb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015ec0: 7570 6461 7465 5f72 6576 3d6c 6f63 616c  update_rev=local
-00015ed0: 5f72 6576 2c0a 2020 2020 2020 2020 2020  _rev,.          
-00015ee0: 2020 2020 2020 2020 2020 7379 6e63 5f65            sync_e
-00015ef0: 7665 6e74 3d65 7665 6e74 2c0a 2020 2020  vent=event,.    
-00015f00: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
-00015f10: 2020 2020 2020 6578 6365 7074 2028 4e6f        except (No
-00015f20: 7446 6f75 6e64 4572 726f 722c 204e 6f74  tFoundError, Not
-00015f30: 4146 6f6c 6465 7245 7272 6f72 2c20 4973  AFolderError, Is
-00015f40: 4146 6f6c 6465 7245 7272 6f72 293a 0a20  AFolderError):. 
-00015f50: 2020 2020 2020 2020 2020 2023 204e 6f74             # Not
-00015f60: 653a 204e 6f74 4146 6f6c 6465 7245 7272  e: NotAFolderErr
-00015f70: 6f72 2063 616e 2062 6520 7261 6973 6564  or can be raised
-00015f80: 2077 6865 6e20 6120 7061 7265 6e74 2069   when a parent i
-00015f90: 6e20 7468 6520 6c6f 6361 6c20 7061 7468  n the local path
-00015fa0: 0a20 2020 2020 2020 2020 2020 2023 2072  .            # r
-00015fb0: 6566 6572 7320 746f 2061 2066 696c 6520  efers to a file 
-00015fc0: 696e 7374 6561 6420 6f66 2061 2066 6f6c  instead of a fol
-00015fd0: 6465 722e 0a20 2020 2020 2020 2020 2020  der..           
-00015fe0: 2073 656c 662e 5f6c 6f67 6765 722e 6465   self._logger.de
-00015ff0: 6275 6728 0a20 2020 2020 2020 2020 2020  bug(.           
-00016000: 2020 2020 2027 436f 756c 6420 6e6f 7420       'Could not 
-00016010: 7570 6c6f 6164 2022 2573 223a 2074 6865  upload "%s": the
-00016020: 2066 696c 6520 646f 6573 206e 6f74 2065   file does not e
-00016030: 7869 7374 272c 2065 7665 6e74 2e6c 6f63  xist', event.loc
-00016040: 616c 5f70 6174 680a 2020 2020 2020 2020  al_path.        
-00016050: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
-00016060: 2020 7265 7475 726e 2053 796e 6353 7461    return SyncSta
-00016070: 7475 732e 536b 6970 7065 640a 2020 2020  tus.Skipped.    
-00016080: 2020 2020 6578 6365 7074 2044 6174 6143      except DataC
-00016090: 6861 6e67 6564 4572 726f 723a 0a20 2020  hangedError:.   
-000160a0: 2020 2020 2020 2020 2073 656c 662e 5f6c           self._l
-000160b0: 6f67 6765 722e 6465 6275 6728 0a20 2020  ogger.debug(.   
-000160c0: 2020 2020 2020 2020 2020 2020 2027 436f               'Co
-000160d0: 756c 6420 6e6f 7420 7570 6c6f 6164 2022  uld not upload "
-000160e0: 2573 223a 2074 6865 2066 696c 6520 7761  %s": the file wa
-000160f0: 7320 6d6f 6469 6669 6564 2064 7572 696e  s modified durin
-00016100: 6720 7570 6c6f 6164 272c 0a20 2020 2020  g upload',.     
-00016110: 2020 2020 2020 2020 2020 2065 7665 6e74             event
-00016120: 2e6c 6f63 616c 5f70 6174 682c 0a20 2020  .local_path,.   
-00016130: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
-00016140: 2020 2020 2020 2072 6574 7572 6e20 5379         return Sy
-00016150: 6e63 5374 6174 7573 2e53 6b69 7070 6564  ncStatus.Skipped
-00016160: 0a0a 2020 2020 2020 2020 6966 2073 656c  ..        if sel
-00016170: 662e 5f68 616e 646c 655f 7570 6c6f 6164  f._handle_upload
-00016180: 5f63 6f6e 666c 6963 7428 6d64 5f6e 6577  _conflict(md_new
-00016190: 2c20 6576 656e 7429 3a0a 2020 2020 2020  , event):.      
-000161a0: 2020 2020 2020 7374 6174 7573 203d 2053        status = S
-000161b0: 796e 6353 7461 7475 732e 436f 6e66 6c69  yncStatus.Confli
-000161c0: 6374 0a20 2020 2020 2020 2065 6c73 653a  ct.        else:
-000161d0: 0a20 2020 2020 2020 2020 2020 2073 7461  .            sta
-000161e0: 7475 7320 3d20 5379 6e63 5374 6174 7573  tus = SyncStatus
-000161f0: 2e44 6f6e 650a 2020 2020 2020 2020 2020  .Done.          
-00016200: 2020 6966 2065 7665 6e74 2e63 6861 6e67    if event.chang
-00016210: 655f 7479 7065 2069 7320 4368 616e 6765  e_type is Change
-00016220: 5479 7065 2e41 6464 6564 3a0a 2020 2020  Type.Added:.    
-00016230: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-00016240: 2e5f 6c6f 6767 6572 2e64 6562 7567 2827  ._logger.debug('
-00016250: 4372 6561 7465 6420 2225 7322 206f 6e20  Created "%s" on 
-00016260: 4472 6f70 626f 7827 2c20 6576 656e 742e  Dropbox', event.
-00016270: 6462 785f 7061 7468 290a 2020 2020 2020  dbx_path).      
-00016280: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-00016290: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-000162a0: 2e5f 6c6f 6767 6572 2e64 6562 7567 2827  ._logger.debug('
-000162b0: 5570 6c6f 6164 6564 206d 6f64 6966 6965  Uploaded modifie
-000162c0: 6420 2225 7322 2074 6f20 4472 6f70 626f  d "%s" to Dropbo
-000162d0: 7827 2c20 6576 656e 742e 6462 785f 7061  x', event.dbx_pa
-000162e0: 7468 290a 0a20 2020 2020 2020 2073 656c  th)..        sel
-000162f0: 662e 7570 6461 7465 5f69 6e64 6578 5f66  f.update_index_f
-00016300: 726f 6d5f 6462 785f 6d65 7461 6461 7461  rom_dbx_metadata
-00016310: 286d 645f 6e65 7729 0a0a 2020 2020 2020  (md_new)..      
-00016320: 2020 7265 7475 726e 2073 7461 7475 730a    return status.
-00016330: 0a20 2020 2064 6566 205f 6f6e 5f6c 6f63  .    def _on_loc
-00016340: 616c 5f66 6f6c 6465 725f 6372 6561 7465  al_folder_create
-00016350: 6428 7365 6c66 2c20 6576 656e 743a 2053  d(self, event: S
-00016360: 796e 6345 7665 6e74 2920 2d3e 2053 796e  yncEvent) -> Syn
-00016370: 6353 7461 7475 733a 0a20 2020 2020 2020  cStatus:.       
-00016380: 2022 2222 0a20 2020 2020 2020 2043 616c   """.        Cal
-00016390: 6c20 7768 656e 2061 206c 6f63 616c 2066  l when a local f
-000163a0: 6f6c 6465 7220 6973 2063 7265 6174 6564  older is created
-000163b0: 2e0a 0a20 2020 2020 2020 203a 7061 7261  ...        :para
-000163c0: 6d20 6576 656e 743a 2053 796e 6345 7665  m event: SyncEve
-000163d0: 6e74 2063 6f72 7265 7370 6f6e 6469 6e67  nt corresponding
-000163e0: 2074 6f20 6c6f 6361 6c20 6372 6561 7465   to local create
-000163f0: 6420 6576 656e 742e 0a20 2020 2020 2020  d event..       
-00016400: 203a 7265 7475 726e 733a 204d 6574 6164   :returns: Metad
-00016410: 6174 6120 666f 7220 6372 6561 7465 6420  ata for created 
-00016420: 6974 656d 206f 7220 4e6f 6e65 2069 6620  item or None if 
-00016430: 6e6f 2072 656d 6f74 6520 6974 656d 2069  no remote item i
-00016440: 7320 6372 6561 7465 642e 0a20 2020 2020  s created..     
-00016450: 2020 203a 7261 6973 6573 204d 6165 7374     :raises Maest
-00016460: 7261 6c41 7069 4572 726f 723a 2046 6f72  ralApiError: For
-00016470: 2061 6e79 2069 7373 7565 7320 7768 656e   any issues when
-00016480: 2073 796e 6369 6e67 2074 6865 2069 7465   syncing the ite
-00016490: 6d2e 0a20 2020 2020 2020 2022 2222 0a20  m..        """. 
-000164a0: 2020 2020 2020 2063 6865 636b 5f63 6861         check_cha
-000164b0: 6e67 655f 7479 7065 2865 7665 6e74 2c20  nge_type(event, 
-000164c0: 7b43 6861 6e67 6554 7970 652e 4164 6465  {ChangeType.Adde
-000164d0: 647d 290a 2020 2020 2020 2020 6368 6563  d}).        chec
-000164e0: 6b5f 656e 636f 6469 6e67 2865 7665 6e74  k_encoding(event
-000164f0: 2e6c 6f63 616c 5f70 6174 6829 0a0a 2020  .local_path)..  
-00016500: 2020 2020 2020 6966 2073 656c 662e 5f68        if self._h
-00016510: 616e 646c 655f 7365 6c65 6374 6976 655f  andle_selective_
-00016520: 7379 6e63 5f63 6f6e 666c 6963 7428 6576  sync_conflict(ev
-00016530: 656e 7429 3a0a 2020 2020 2020 2020 2020  ent):.          
-00016540: 2020 7265 7475 726e 2053 796e 6353 7461    return SyncSta
-00016550: 7475 732e 436f 6e66 6c69 6374 0a20 2020  tus.Conflict.   
-00016560: 2020 2020 2069 6620 7365 6c66 2e5f 6861       if self._ha
-00016570: 6e64 6c65 5f6e 6f72 6d61 6c69 7a61 7469  ndle_normalizati
-00016580: 6f6e 5f63 6f6e 666c 6963 7428 6576 656e  on_conflict(even
-00016590: 7429 3a0a 2020 2020 2020 2020 2020 2020  t):.            
-000165a0: 7265 7475 726e 2053 796e 6353 7461 7475  return SyncStatu
-000165b0: 732e 436f 6e66 6c69 6374 0a0a 2020 2020  s.Conflict..    
-000165c0: 2020 2020 7365 6c66 2e5f 7761 6974 5f66      self._wait_f
-000165d0: 6f72 5f63 7265 6174 696f 6e28 6576 656e  or_creation(even
-000165e0: 742e 6c6f 6361 6c5f 7061 7468 290a 0a20  t.local_path).. 
-000165f0: 2020 2020 2020 2074 7279 3a0a 2020 2020         try:.    
-00016600: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
-00016610: 636c 6965 6e74 2e69 735f 7465 616d 5f73  client.is_team_s
-00016620: 7061 6365 2061 6e64 2065 7665 6e74 2e64  pace and event.d
-00016630: 6278 5f70 6174 682e 636f 756e 7428 222f  bx_path.count("/
-00016640: 2229 203d 3d20 313a 0a20 2020 2020 2020  ") == 1:.       
-00016650: 2020 2020 2020 2020 206d 645f 6e65 7720           md_new 
-00016660: 3d20 7365 6c66 2e63 6c69 656e 742e 7368  = self.client.sh
-00016670: 6172 655f 6469 7228 6576 656e 742e 6462  are_dir(event.db
-00016680: 785f 7061 7468 290a 0a20 2020 2020 2020  x_path)..       
-00016690: 2020 2020 2020 2020 2069 6620 6e6f 7420           if not 
-000166a0: 6d64 5f6e 6577 3a0a 2020 2020 2020 2020  md_new:.        
-000166b0: 2020 2020 2020 2020 2020 2020 2320 5265              # Re
-000166c0: 6d6f 7465 2066 6f6c 6465 7220 6861 7320  mote folder has 
-000166d0: 6265 656e 2064 656c 6574 6564 2061 6674  been deleted aft
-000166e0: 6572 2063 7265 6174 696e 672e 2052 6566  er creating. Ref
-000166f0: 6c65 6374 2063 6861 6e67 6573 0a20 2020  lect changes.   
+00004680: 0a0a 2020 2020 2020 2020 7472 793a 0a20  ..        try:. 
+00004690: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+000046a0: 5f63 7265 6174 655f 6f72 5f6c 6f61 645f  _create_or_load_
+000046b0: 6462 2829 0a20 2020 2020 2020 2065 7863  db().        exc
+000046c0: 6570 7420 4461 7461 6261 7365 4572 726f  ept DatabaseErro
+000046d0: 723a 0a20 2020 2020 2020 2020 2020 2023  r:.            #
+000046e0: 2052 6561 6469 6e67 2074 6162 6c65 7320   Reading tables 
+000046f0: 6d61 7920 6661 696c 2069 6620 7468 6520  may fail if the 
+00004700: 4442 2077 6173 2063 6f72 7275 7074 6564  DB was corrupted
+00004710: 2e20 5468 6973 2073 686f 756c 6420 6861  . This should ha
+00004720: 7070 656e 2076 6572 790a 2020 2020 2020  ppen very.      
+00004730: 2020 2020 2020 2320 7261 7265 6c79 2c20        # rarely, 
+00004740: 7365 6520 6874 7470 733a 2f2f 7371 6c69  see https://sqli
+00004750: 7465 2e6f 7267 2f68 6f77 746f 636f 7272  te.org/howtocorr
+00004760: 7570 742e 6874 6d6c 2e20 4174 7465 6d70  upt.html. Attemp
+00004770: 7420 746f 2072 6563 6f76 6572 2062 790a  t to recover by.
+00004780: 2020 2020 2020 2020 2020 2020 2320 6465              # de
+00004790: 6c65 7469 6e67 2044 4220 616e 6420 7265  leting DB and re
+000047a0: 7365 7474 696e 6720 7379 6e63 2073 7461  setting sync sta
+000047b0: 7465 2074 6f20 7472 6967 6765 7220 7265  te to trigger re
+000047c0: 696e 6465 7869 6e67 2e0a 0a20 2020 2020  indexing...     
+000047d0: 2020 2020 2020 2073 656c 662e 5f6c 6f67         self._log
+000047e0: 6765 722e 7761 726e 696e 6728 2244 6174  ger.warning("Dat
+000047f0: 6162 6173 6520 6572 726f 722c 2072 6573  abase error, res
+00004800: 6574 7469 6e67 2073 796e 6320 7374 6174  etting sync stat
+00004810: 6522 290a 0a20 2020 2020 2020 2020 2020  e")..           
+00004820: 2073 656c 662e 7265 7365 745f 7379 6e63   self.reset_sync
+00004830: 5f73 7461 7465 2829 0a20 2020 2020 2020  _state().       
+00004840: 2020 2020 2064 656c 6574 6528 7365 6c66       delete(self
+00004850: 2e5f 6462 5f70 6174 6829 0a0a 2020 2020  ._db_path)..    
+00004860: 2020 2020 2020 2020 7365 6c66 2e5f 6372          self._cr
+00004870: 6561 7465 5f6f 725f 6c6f 6164 5f64 6228  eate_or_load_db(
+00004880: 290a 0a20 2020 2020 2020 2023 2043 6163  )..        # Cac
+00004890: 6865 732e 0a20 2020 2020 2020 2073 656c  hes..        sel
+000048a0: 662e 5f63 6173 655f 636f 6e76 6572 7369  f._case_conversi
+000048b0: 6f6e 5f63 6163 6865 203d 204c 5255 4361  on_cache = LRUCa
+000048c0: 6368 6528 6361 7061 6369 7479 3d35 3030  che(capacity=500
+000048d0: 3029 0a20 2020 2020 2020 2073 656c 662e  0).        self.
+000048e0: 636c 6561 6e5f 6361 6368 655f 6469 7228  clean_cache_dir(
+000048f0: 7261 6973 655f 6572 726f 723d 4661 6c73  raise_error=Fals
+00004900: 6529 0a0a 2020 2020 6465 6620 5f63 7265  e)..    def _cre
+00004910: 6174 655f 6f72 5f6c 6f61 645f 6462 2873  ate_or_load_db(s
+00004920: 656c 6629 202d 3e20 4e6f 6e65 3a0a 2020  elf) -> None:.  
+00004930: 2020 2020 2020 7769 7468 2073 656c 662e        with self.
+00004940: 5f64 6174 6162 6173 655f 6163 6365 7373  _database_access
+00004950: 2829 3a0a 2020 2020 2020 2020 2020 2020  ():.            
+00004960: 7365 6c66 2e5f 696e 6465 785f 7461 626c  self._index_tabl
+00004970: 6520 3d20 4d61 6e61 6765 7228 7365 6c66  e = Manager(self
+00004980: 2e5f 6462 2c20 496e 6465 7845 6e74 7279  ._db, IndexEntry
+00004990: 290a 2020 2020 2020 2020 2020 2020 7365  ).            se
+000049a0: 6c66 2e5f 6869 7374 6f72 795f 7461 626c  lf._history_tabl
+000049b0: 6520 3d20 4d61 6e61 6765 7228 7365 6c66  e = Manager(self
+000049c0: 2e5f 6462 2c20 5379 6e63 4576 656e 7429  ._db, SyncEvent)
+000049d0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+000049e0: 662e 5f68 6173 685f 7461 626c 6520 3d20  f._hash_table = 
+000049f0: 4d61 6e61 6765 7228 7365 6c66 2e5f 6462  Manager(self._db
+00004a00: 2c20 4861 7368 4361 6368 6545 6e74 7279  , HashCacheEntry
+00004a10: 290a 2020 2020 2020 2020 2020 2020 7365  ).            se
+00004a20: 6c66 2e5f 7379 6e63 5f65 7272 6f72 735f  lf._sync_errors_
+00004a30: 7461 626c 6520 3d20 4d61 6e61 6765 7228  table = Manager(
+00004a40: 7365 6c66 2e5f 6462 2c20 5379 6e63 4572  self._db, SyncEr
+00004a50: 726f 7245 6e74 7279 290a 0a20 2020 2064  rorEntry)..    d
+00004a60: 6566 2072 656c 6f61 645f 6361 6368 6564  ef reload_cached
+00004a70: 5f63 6f6e 6669 6728 7365 6c66 2920 2d3e  _config(self) ->
+00004a80: 204e 6f6e 653a 0a20 2020 2020 2020 2022   None:.        "
+00004a90: 2222 0a20 2020 2020 2020 2052 656c 6f61  "".        Reloa
+00004aa0: 6473 2061 6c6c 2063 6f6e 6669 6720 616e  ds all config an
+00004ab0: 6420 7374 6174 6520 7661 6c75 6573 2074  d state values t
+00004ac0: 6861 7420 6172 6520 6f74 6865 7277 6973  hat are otherwis
+00004ad0: 6520 6361 6368 6564 2062 7920 7468 6973  e cached by this
+00004ae0: 2063 6c61 7373 2066 6f72 0a20 2020 2020   class for.     
+00004af0: 2020 2066 6173 7465 7220 6163 6365 7373     faster access
+00004b00: 2e20 4361 6c6c 2074 6869 7320 6d65 7468  . Call this meth
+00004b10: 6f64 2069 6620 636f 6e66 6967 206f 7220  od if config or 
+00004b20: 7374 6174 6520 7661 6c75 6573 2077 6865  state values whe
+00004b30: 7265 206d 6f64 6966 6965 640a 2020 2020  re modified.    
+00004b40: 2020 2020 6469 7265 6374 6c79 2069 6e73      directly ins
+00004b50: 7465 6164 206f 6620 7573 696e 6720 3a63  tead of using :c
+00004b60: 6c61 7373 3a60 5379 6e63 456e 6769 6e65  lass:`SyncEngine
+00004b70: 6020 4150 4973 2e0a 2020 2020 2020 2020  ` APIs..        
+00004b80: 2222 220a 2020 2020 2020 2020 7365 6c66  """.        self
+00004b90: 2e5f 6472 6f70 626f 785f 7061 7468 3a20  ._dropbox_path: 
+00004ba0: 7374 7220 3d20 7365 6c66 2e5f 636f 6e66  str = self._conf
+00004bb0: 2e67 6574 2822 7379 6e63 222c 2022 7061  .get("sync", "pa
+00004bc0: 7468 2229 0a20 2020 2020 2020 2073 656c  th").        sel
+00004bd0: 662e 5f6d 6967 6e6f 7265 5f70 6174 683a  f._mignore_path:
+00004be0: 2073 7472 203d 206f 7370 2e6a 6f69 6e28   str = osp.join(
+00004bf0: 7365 6c66 2e5f 6472 6f70 626f 785f 7061  self._dropbox_pa
+00004c00: 7468 2c20 4d49 474e 4f52 455f 4649 4c45  th, MIGNORE_FILE
+00004c10: 290a 2020 2020 2020 2020 7365 6c66 2e5f  ).        self._
+00004c20: 6669 6c65 5f63 6163 6865 5f70 6174 683a  file_cache_path:
+00004c30: 2073 7472 203d 206f 7370 2e6a 6f69 6e28   str = osp.join(
+00004c40: 7365 6c66 2e5f 6472 6f70 626f 785f 7061  self._dropbox_pa
+00004c50: 7468 2c20 4649 4c45 5f43 4143 4845 290a  th, FILE_CACHE).
+00004c60: 0a20 2020 2020 2020 2073 656c 662e 5f65  .        self._e
+00004c70: 7863 6c75 6465 645f 6974 656d 733a 206c  xcluded_items: l
+00004c80: 6973 745b 7374 725d 203d 2073 656c 662e  ist[str] = self.
+00004c90: 5f63 6f6e 662e 6765 7428 2273 796e 6322  _conf.get("sync"
+00004ca0: 2c20 2265 7863 6c75 6465 645f 6974 656d  , "excluded_item
+00004cb0: 7322 290a 2020 2020 2020 2020 7365 6c66  s").        self
+00004cc0: 2e5f 6d61 785f 6370 755f 7065 7263 656e  ._max_cpu_percen
+00004cd0: 743a 2066 6c6f 6174 203d 2028 0a20 2020  t: float = (.   
+00004ce0: 2020 2020 2020 2020 2073 656c 662e 5f63           self._c
+00004cf0: 6f6e 662e 6765 7428 2273 796e 6322 2c20  onf.get("sync", 
+00004d00: 226d 6178 5f63 7075 5f70 6572 6365 6e74  "max_cpu_percent
+00004d10: 2229 202a 2043 5055 5f43 4f52 455f 434f  ") * CPU_CORE_CO
+00004d20: 554e 540a 2020 2020 2020 2020 290a 2020  UNT.        ).  
+00004d30: 2020 2020 2020 7365 6c66 2e5f 6c6f 6361        self._loca
+00004d40: 6c5f 6375 7273 6f72 3a20 666c 6f61 7420  l_cursor: float 
+00004d50: 3d20 7365 6c66 2e5f 7374 6174 652e 6765  = self._state.ge
+00004d60: 7428 2273 796e 6322 2c20 226c 6173 7473  t("sync", "lasts
+00004d70: 796e 6322 290a 0a20 2020 2020 2020 2073  ync")..        s
+00004d80: 656c 662e 5f69 735f 6673 5f63 6173 655f  elf._is_fs_case_
+00004d90: 7365 6e73 6974 6976 6520 3d20 7365 6c66  sensitive = self
+00004da0: 2e5f 6368 6563 6b5f 6673 5f63 6173 655f  ._check_fs_case_
+00004db0: 7365 6e73 6974 6976 6528 290a 0a20 2020  sensitive()..   
+00004dc0: 2020 2020 2073 656c 662e 6c6f 6164 5f6d       self.load_m
+00004dd0: 6967 6e6f 7265 5f66 696c 6528 290a 0a20  ignore_file().. 
+00004de0: 2020 2064 6566 205f 6368 6563 6b5f 6673     def _check_fs
+00004df0: 5f63 6173 655f 7365 6e73 6974 6976 6528  _case_sensitive(
+00004e00: 7365 6c66 2920 2d3e 2062 6f6f 6c3a 0a20  self) -> bool:. 
+00004e10: 2020 2020 2020 2074 7279 3a0a 2020 2020         try:.    
+00004e20: 2020 2020 2020 2020 7265 7475 726e 2069          return i
+00004e30: 735f 6673 5f63 6173 655f 7365 6e73 6974  s_fs_case_sensit
+00004e40: 6976 6528 7365 6c66 2e5f 6472 6f70 626f  ive(self._dropbo
+00004e50: 785f 7061 7468 290a 2020 2020 2020 2020  x_path).        
+00004e60: 6578 6365 7074 2028 4669 6c65 4e6f 7446  except (FileNotF
+00004e70: 6f75 6e64 4572 726f 722c 204e 6f74 4144  oundError, NotAD
+00004e80: 6972 6563 746f 7279 4572 726f 7229 3a0a  irectoryError):.
+00004e90: 2020 2020 2020 2020 2020 2020 2320 4661              # Fa
+00004ea0: 6c6c 2062 6163 6b20 746f 2074 6865 2061  ll back to the a
+00004eb0: 7373 756d 7074 696f 6e20 6f66 2061 2063  ssumption of a c
+00004ec0: 6173 652d 7365 6e73 6974 6976 6520 6669  ase-sensitive fi
+00004ed0: 6c65 2073 7973 7465 6d2e 0a20 2020 2020  le system..     
+00004ee0: 2020 2020 2020 2072 6574 7572 6e20 5472         return Tr
+00004ef0: 7565 0a0a 2020 2020 2320 3d3d 3d3d 2043  ue..    # ==== C
+00004f00: 6f6e 6669 6720 6163 6365 7373 203d 3d3d  onfig access ===
+00004f10: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00004f20: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00004f30: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00004f40: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 0a0a 2020  ============..  
+00004f50: 2020 4070 726f 7065 7274 790a 2020 2020    @property.    
+00004f60: 6465 6620 6472 6f70 626f 785f 7061 7468  def dropbox_path
+00004f70: 2873 656c 6629 202d 3e20 7374 723a 0a20  (self) -> str:. 
+00004f80: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
+00004f90: 2020 2050 6174 6820 746f 206c 6f63 616c     Path to local
+00004fa0: 2044 726f 7062 6f78 2066 6f6c 6465 722c   Dropbox folder,
+00004fb0: 2061 7320 6c6f 6164 6564 2066 726f 6d20   as loaded from 
+00004fc0: 7468 6520 636f 6e66 6967 2066 696c 652e  the config file.
+00004fd0: 2042 6566 6f72 6520 6368 616e 6769 6e67   Before changing
+00004fe0: 0a20 2020 2020 2020 203a 6174 7472 3a60  .        :attr:`
+00004ff0: 6472 6f70 626f 785f 7061 7468 602c 206d  dropbox_path`, m
+00005000: 616b 6520 7375 7265 2074 6861 7420 7379  ake sure that sy
+00005010: 6e63 696e 6720 6973 2070 6175 7365 642e  ncing is paused.
+00005020: 204d 6f76 6520 7468 6520 6472 6f70 626f   Move the dropbo
+00005030: 7820 666f 6c64 6572 0a20 2020 2020 2020  x folder.       
+00005040: 2074 6f20 7468 6520 6e65 7720 6c6f 6361   to the new loca
+00005050: 7469 6f6e 2062 6566 6f72 6520 7265 7375  tion before resu
+00005060: 6d69 6e67 2074 6865 2073 796e 632e 2043  ming the sync. C
+00005070: 6861 6e67 6573 2061 7265 2073 6176 6564  hanges are saved
+00005080: 2074 6f20 7468 6520 636f 6e66 6967 0a20   to the config. 
+00005090: 2020 2020 2020 2066 696c 652e 0a20 2020         file..   
+000050a0: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
+000050b0: 2072 6574 7572 6e20 7365 6c66 2e5f 6472   return self._dr
+000050c0: 6f70 626f 785f 7061 7468 0a0a 2020 2020  opbox_path..    
+000050d0: 4064 726f 7062 6f78 5f70 6174 682e 7365  @dropbox_path.se
+000050e0: 7474 6572 0a20 2020 2064 6566 2064 726f  tter.    def dro
+000050f0: 7062 6f78 5f70 6174 6828 7365 6c66 2c20  pbox_path(self, 
+00005100: 7061 7468 3a20 7374 7229 202d 3e20 4e6f  path: str) -> No
+00005110: 6e65 3a0a 2020 2020 2020 2020 2222 2253  ne:.        """S
+00005120: 6574 7465 723a 2064 726f 7062 6f78 5f70  etter: dropbox_p
+00005130: 6174 6822 2222 0a0a 2020 2020 2020 2020  ath"""..        
+00005140: 7061 7468 203d 206f 7370 2e72 6561 6c70  path = osp.realp
+00005150: 6174 6828 7061 7468 290a 0a20 2020 2020  ath(path)..     
+00005160: 2020 2077 6974 6820 7365 6c66 2e73 796e     with self.syn
+00005170: 635f 6c6f 636b 3a0a 2020 2020 2020 2020  c_lock:.        
+00005180: 2020 2020 7365 6c66 2e5f 6472 6f70 626f      self._dropbo
+00005190: 785f 7061 7468 203d 2070 6174 680a 2020  x_path = path.  
+000051a0: 2020 2020 2020 2020 2020 7365 6c66 2e5f            self._
+000051b0: 6d69 676e 6f72 655f 7061 7468 203d 206f  mignore_path = o
+000051c0: 7370 2e6a 6f69 6e28 7365 6c66 2e5f 6472  sp.join(self._dr
+000051d0: 6f70 626f 785f 7061 7468 2c20 4d49 474e  opbox_path, MIGN
+000051e0: 4f52 455f 4649 4c45 290a 2020 2020 2020  ORE_FILE).      
+000051f0: 2020 2020 2020 7365 6c66 2e5f 6669 6c65        self._file
+00005200: 5f63 6163 6865 5f70 6174 6820 3d20 6f73  _cache_path = os
+00005210: 702e 6a6f 696e 2873 656c 662e 5f64 726f  p.join(self._dro
+00005220: 7062 6f78 5f70 6174 682c 2046 494c 455f  pbox_path, FILE_
+00005230: 4341 4348 4529 0a20 2020 2020 2020 2020  CACHE).         
+00005240: 2020 2073 656c 662e 5f63 6f6e 662e 7365     self._conf.se
+00005250: 7428 2273 796e 6322 2c20 2270 6174 6822  t("sync", "path"
+00005260: 2c20 7061 7468 290a 0a20 2020 2020 2020  , path)..       
+00005270: 2020 2020 2073 656c 662e 5f69 735f 6673       self._is_fs
+00005280: 5f63 6173 655f 7365 6e73 6974 6976 6520  _case_sensitive 
+00005290: 3d20 7365 6c66 2e5f 6368 6563 6b5f 6673  = self._check_fs
+000052a0: 5f63 6173 655f 7365 6e73 6974 6976 6528  _case_sensitive(
+000052b0: 290a 0a20 2020 2040 7072 6f70 6572 7479  )..    @property
+000052c0: 0a20 2020 2064 6566 2069 735f 6673 5f63  .    def is_fs_c
+000052d0: 6173 655f 7365 6e73 6974 6976 6528 7365  ase_sensitive(se
+000052e0: 6c66 2920 2d3e 2062 6f6f 6c3a 0a20 2020  lf) -> bool:.   
+000052f0: 2020 2020 2022 2222 5768 6574 6865 7220       """Whether 
+00005300: 7468 6520 6c6f 6361 6c20 4472 6f70 626f  the local Dropbo
+00005310: 7820 6469 7265 6374 6f72 7920 6c69 6573  x directory lies
+00005320: 206f 6e20 6120 6361 7365 2d73 656e 7369   on a case-sensi
+00005330: 7469 7665 2066 696c 6520 7379 7374 656d  tive file system
+00005340: 2e22 2222 0a20 2020 2020 2020 2072 6574  .""".        ret
+00005350: 7572 6e20 7365 6c66 2e5f 6973 5f66 735f  urn self._is_fs_
+00005360: 6361 7365 5f73 656e 7369 7469 7665 0a0a  case_sensitive..
+00005370: 2020 2020 4070 726f 7065 7274 790a 2020      @property.  
+00005380: 2020 6465 6620 6461 7461 6261 7365 5f70    def database_p
+00005390: 6174 6828 7365 6c66 2920 2d3e 2073 7472  ath(self) -> str
+000053a0: 3a0a 2020 2020 2020 2020 2222 2250 6174  :.        """Pat
+000053b0: 6820 5351 4c69 7465 2064 6174 6162 6173  h SQLite databas
+000053c0: 652e 2222 220a 2020 2020 2020 2020 7265  e.""".        re
+000053d0: 7475 726e 2073 656c 662e 5f64 625f 7061  turn self._db_pa
+000053e0: 7468 0a0a 2020 2020 4070 726f 7065 7274  th..    @propert
+000053f0: 790a 2020 2020 6465 6620 6669 6c65 5f63  y.    def file_c
+00005400: 6163 6865 5f70 6174 6828 7365 6c66 2920  ache_path(self) 
+00005410: 2d3e 2073 7472 3a0a 2020 2020 2020 2020  -> str:.        
+00005420: 2222 2250 6174 6820 746f 2063 6163 6865  """Path to cache
+00005430: 2066 6f6c 6465 7220 666f 7220 7465 6d70   folder for temp
+00005440: 6f72 6172 7920 6669 6c65 7320 2872 6561  orary files (rea
+00005450: 6420 6f6e 6c79 292e 2054 6865 2063 6163  d only). The cac
+00005460: 6865 2066 6f6c 6465 720a 2020 2020 2020  he folder.      
+00005470: 2020 272e 6d61 6573 7472 616c 2e63 6163    '.maestral.cac
+00005480: 6865 2720 6973 206c 6f63 6174 6564 2069  he' is located i
+00005490: 6e73 6964 6520 7468 6520 6c6f 6361 6c20  nside the local 
+000054a0: 4472 6f70 626f 7820 666f 6c64 6572 2074  Dropbox folder t
+000054b0: 6f20 7072 6576 656e 7420 6669 6c65 0a20  o prevent file. 
+000054c0: 2020 2020 2020 2074 7261 6e73 6665 7220         transfer 
+000054d0: 6265 7477 6565 6e20 6469 6666 6572 656e  between differen
+000054e0: 7420 7061 7274 6974 696f 6e73 206f 7220  t partitions or 
+000054f0: 6472 6976 6573 2064 7572 696e 6720 7379  drives during sy
+00005500: 6e63 2e22 2222 0a20 2020 2020 2020 2072  nc.""".        r
+00005510: 6574 7572 6e20 7365 6c66 2e5f 6669 6c65  eturn self._file
+00005520: 5f63 6163 6865 5f70 6174 680a 0a20 2020  _cache_path..   
+00005530: 2040 7072 6f70 6572 7479 0a20 2020 2064   @property.    d
+00005540: 6566 2065 7863 6c75 6465 645f 6974 656d  ef excluded_item
+00005550: 7328 7365 6c66 2920 2d3e 206c 6973 745b  s(self) -> list[
+00005560: 7374 725d 3a0a 2020 2020 2020 2020 2222  str]:.        ""
+00005570: 224c 6973 7420 6f66 2061 6c6c 2066 696c  "List of all fil
+00005580: 6573 2061 6e64 2066 6f6c 6465 7273 2065  es and folders e
+00005590: 7863 6c75 6465 6420 6672 6f6d 2073 796e  xcluded from syn
+000055a0: 632e 2043 6861 6e67 6573 2061 7265 2073  c. Changes are s
+000055b0: 6176 6564 2074 6f20 7468 650a 2020 2020  aved to the.    
+000055c0: 2020 2020 636f 6e66 6967 2066 696c 652e      config file.
+000055d0: 2049 6620 6120 7061 7265 6e74 2066 6f6c   If a parent fol
+000055e0: 6465 7220 6973 2065 7863 6c75 6465 642c  der is excluded,
+000055f0: 2069 7473 2063 6869 6c64 7265 6e20 7769   its children wi
+00005600: 6c6c 2061 7574 6f6d 6174 6963 616c 6c79  ll automatically
+00005610: 2062 650a 2020 2020 2020 2020 7265 6d6f   be.        remo
+00005620: 7665 6420 6672 6f6d 2074 6865 206c 6973  ved from the lis
+00005630: 742e 2049 6620 6f6e 6c79 2063 6869 6c64  t. If only child
+00005640: 7265 6e20 6172 6520 6769 7665 6e20 6275  ren are given bu
+00005650: 7420 6e6f 7420 7468 6520 7061 7265 6e74  t not the parent
+00005660: 2066 6f6c 6465 722c 2061 6e79 0a20 2020   folder, any.   
+00005670: 2020 2020 206e 6577 2069 7465 6d73 2061       new items a
+00005680: 6464 6564 2074 6f20 7468 6520 7061 7265  dded to the pare
+00005690: 6e74 2077 696c 6c20 6265 2073 796e 6365  nt will be synce
+000056a0: 642e 2043 6861 6e67 6520 7468 6973 2070  d. Change this p
+000056b0: 726f 7065 7274 7920 2a62 6566 6f72 652a  roperty *before*
+000056c0: 0a20 2020 2020 2020 2064 6f77 6e6c 6f61  .        downloa
+000056d0: 6469 6e67 206e 6577 6c79 2069 6e63 6c75  ding newly inclu
+000056e0: 6465 6420 6974 656d 7320 6f72 2064 656c  ded items or del
+000056f0: 6574 696e 6720 6578 636c 7564 6564 2069  eting excluded i
+00005700: 7465 6d73 2e22 2222 0a20 2020 2020 2020  tems.""".       
+00005710: 2072 6574 7572 6e20 7365 6c66 2e5f 6578   return self._ex
+00005720: 636c 7564 6564 5f69 7465 6d73 0a0a 2020  cluded_items..  
+00005730: 2020 4065 7863 6c75 6465 645f 6974 656d    @excluded_item
+00005740: 732e 7365 7474 6572 0a20 2020 2064 6566  s.setter.    def
+00005750: 2065 7863 6c75 6465 645f 6974 656d 7328   excluded_items(
+00005760: 7365 6c66 2c20 666f 6c64 6572 5f6c 6973  self, folder_lis
+00005770: 743a 206c 6973 745b 7374 725d 2920 2d3e  t: list[str]) ->
+00005780: 204e 6f6e 653a 0a20 2020 2020 2020 2022   None:.        "
+00005790: 2222 5365 7474 6572 3a20 6578 636c 7564  ""Setter: exclud
+000057a0: 6564 5f69 7465 6d73 2222 220a 2020 2020  ed_items""".    
+000057b0: 2020 2020 7769 7468 2073 656c 662e 7379      with self.sy
+000057c0: 6e63 5f6c 6f63 6b3a 0a20 2020 2020 2020  nc_lock:.       
+000057d0: 2020 2020 2063 6c65 616e 5f6c 6973 7420       clean_list 
+000057e0: 3d20 7365 6c66 2e63 6c65 616e 5f65 7863  = self.clean_exc
+000057f0: 6c75 6465 645f 6974 656d 735f 6c69 7374  luded_items_list
+00005800: 2866 6f6c 6465 725f 6c69 7374 290a 2020  (folder_list).  
+00005810: 2020 2020 2020 2020 2020 7365 6c66 2e5f            self._
+00005820: 6578 636c 7564 6564 5f69 7465 6d73 203d  excluded_items =
+00005830: 2063 6c65 616e 5f6c 6973 740a 2020 2020   clean_list.    
+00005840: 2020 2020 2020 2020 7365 6c66 2e5f 636f          self._co
+00005850: 6e66 2e73 6574 2822 7379 6e63 222c 2022  nf.set("sync", "
+00005860: 6578 636c 7564 6564 5f69 7465 6d73 222c  excluded_items",
+00005870: 2063 6c65 616e 5f6c 6973 7429 0a0a 2020   clean_list)..  
+00005880: 2020 4073 7461 7469 636d 6574 686f 640a    @staticmethod.
+00005890: 2020 2020 6465 6620 636c 6561 6e5f 6578      def clean_ex
+000058a0: 636c 7564 6564 5f69 7465 6d73 5f6c 6973  cluded_items_lis
+000058b0: 7428 666f 6c64 6572 5f6c 6973 743a 2043  t(folder_list: C
+000058c0: 6f6c 6c65 6374 696f 6e5b 7374 725d 2920  ollection[str]) 
+000058d0: 2d3e 206c 6973 745b 7374 725d 3a0a 2020  -> list[str]:.  
+000058e0: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
+000058f0: 2020 5265 6d6f 7665 7320 616c 6c20 6475    Removes all du
+00005900: 706c 6963 6174 6573 2061 6e64 2063 6869  plicates and chi
+00005910: 6c64 7265 6e20 6f66 2065 7863 6c75 6465  ldren of exclude
+00005920: 6420 6974 656d 7320 6672 6f6d 2074 6865  d items from the
+00005930: 2065 7863 6c75 6465 6420 6974 656d 730a   excluded items.
+00005940: 2020 2020 2020 2020 6c69 7374 2e20 4e6f          list. No
+00005950: 726d 616c 6973 6573 2061 6c6c 2070 6174  rmalises all pat
+00005960: 6873 2074 6f20 6c6f 7765 7220 6361 7365  hs to lower case
+00005970: 2e0a 0a20 2020 2020 2020 203a 7061 7261  ...        :para
+00005980: 6d20 666f 6c64 6572 5f6c 6973 743a 2044  m folder_list: D
+00005990: 726f 7062 6f78 2070 6174 6873 2074 6f20  ropbox paths to 
+000059a0: 6578 636c 7564 652e 0a20 2020 2020 2020  exclude..       
+000059b0: 203a 7265 7475 726e 733a 2043 6c65 616e   :returns: Clean
+000059c0: 6564 2075 7020 6974 656d 732e 0a20 2020  ed up items..   
+000059d0: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
+000059e0: 2023 2052 656d 6f76 6520 6475 706c 6963   # Remove duplic
+000059f0: 6174 6520 656e 7472 6965 7320 6279 2063  ate entries by c
+00005a00: 7265 6174 696e 6720 7365 742c 2073 7472  reating set, str
+00005a10: 6970 2074 7261 696c 696e 6720 272f 272e  ip trailing '/'.
+00005a20: 0a20 2020 2020 2020 2066 6f6c 6465 725f  .        folder_
+00005a30: 7365 7420 3d20 7b6e 6f72 6d61 6c69 7a65  set = {normalize
+00005a40: 2866 292e 7273 7472 6970 2822 2f22 2920  (f).rstrip("/") 
+00005a50: 666f 7220 6620 696e 2066 6f6c 6465 725f  for f in folder_
+00005a60: 6c69 7374 7d0a 0a20 2020 2020 2020 2023  list}..        #
+00005a70: 2052 656d 6f76 6520 616c 6c20 6368 696c   Remove all chil
+00005a80: 6472 656e 206f 6620 6578 636c 7564 6564  dren of excluded
+00005a90: 2066 6f6c 6465 7273 2e0a 2020 2020 2020   folders..      
+00005aa0: 2020 636c 6561 6e5f 6c69 7374 203d 206c    clean_list = l
+00005ab0: 6973 7428 666f 6c64 6572 5f73 6574 290a  ist(folder_set).
+00005ac0: 2020 2020 2020 2020 666f 7220 666f 6c64          for fold
+00005ad0: 6572 2069 6e20 666f 6c64 6572 5f73 6574  er in folder_set
+00005ae0: 3a0a 2020 2020 2020 2020 2020 2020 636c  :.            cl
+00005af0: 6561 6e5f 6c69 7374 203d 205b 6620 666f  ean_list = [f fo
+00005b00: 7220 6620 696e 2063 6c65 616e 5f6c 6973  r f in clean_lis
+00005b10: 7420 6966 206e 6f74 2069 735f 6368 696c  t if not is_chil
+00005b20: 6428 662c 2066 6f6c 6465 7229 5d0a 0a20  d(f, folder)].. 
+00005b30: 2020 2020 2020 2072 6574 7572 6e20 636c         return cl
+00005b40: 6561 6e5f 6c69 7374 0a0a 2020 2020 4070  ean_list..    @p
+00005b50: 726f 7065 7274 790a 2020 2020 6465 6620  roperty.    def 
+00005b60: 6d61 785f 6370 755f 7065 7263 656e 7428  max_cpu_percent(
+00005b70: 7365 6c66 2920 2d3e 2066 6c6f 6174 3a0a  self) -> float:.
+00005b80: 2020 2020 2020 2020 2222 224d 6178 696d          """Maxim
+00005b90: 756d 2043 5055 2075 7361 6765 2066 6f72  um CPU usage for
+00005ba0: 2070 6172 616c 6c65 6c20 646f 776e 6c6f   parallel downlo
+00005bb0: 6164 7320 6f72 2075 706c 6f61 6473 2069  ads or uploads i
+00005bc0: 6e20 7065 7263 656e 7420 6f66 2074 6865  n percent of the
+00005bd0: 2074 6f74 616c 0a20 2020 2020 2020 2061   total.        a
+00005be0: 7661 696c 6162 6c65 2043 5055 2074 696d  vailable CPU tim
+00005bf0: 6520 7065 7220 636f 7265 2e20 496e 6469  e per core. Indi
+00005c00: 7669 6475 616c 2077 6f72 6b65 7273 2069  vidual workers i
+00005c10: 6e20 6120 7468 7265 6164 2070 6f6f 6c20  n a thread pool 
+00005c20: 7769 6c6c 2070 6175 7365 0a20 2020 2020  will pause.     
+00005c30: 2020 2075 6e74 696c 2074 6865 2075 7361     until the usa
+00005c40: 6765 2064 726f 7073 2062 656c 6f77 2074  ge drops below t
+00005c50: 6869 7320 7661 6c75 652e 2054 6173 6b73  his value. Tasks
+00005c60: 2069 6e20 7468 6520 6d61 696e 2074 6872   in the main thr
+00005c70: 6561 6420 7375 6368 2061 730a 2020 2020  ead such as.    
+00005c80: 2020 2020 696e 6465 7869 6e67 2066 696c      indexing fil
+00005c90: 6520 6368 616e 6765 7320 6d61 7920 7374  e changes may st
+00005ca0: 696c 6c20 7573 6520 6d6f 7265 2043 5055  ill use more CPU
+00005cb0: 2074 696d 652e 2053 6574 7469 6e67 2074   time. Setting t
+00005cc0: 6869 7320 746f 2032 3030 2520 6d65 616e  his to 200% mean
+00005cd0: 730a 2020 2020 2020 2020 7468 6174 2074  s.        that t
+00005ce0: 776f 2066 756c 6c20 6c6f 6769 6361 6c20  wo full logical 
+00005cf0: 4350 5520 636f 7265 2063 616e 2062 6520  CPU core can be 
+00005d00: 7573 6564 2e22 2222 0a20 2020 2020 2020  used.""".       
+00005d10: 2072 6574 7572 6e20 7365 6c66 2e5f 6d61   return self._ma
+00005d20: 785f 6370 755f 7065 7263 656e 740a 0a20  x_cpu_percent.. 
+00005d30: 2020 2040 6d61 785f 6370 755f 7065 7263     @max_cpu_perc
+00005d40: 656e 742e 7365 7474 6572 0a20 2020 2064  ent.setter.    d
+00005d50: 6566 206d 6178 5f63 7075 5f70 6572 6365  ef max_cpu_perce
+00005d60: 6e74 2873 656c 662c 2070 6572 6365 6e74  nt(self, percent
+00005d70: 3a20 666c 6f61 7429 202d 3e20 4e6f 6e65  : float) -> None
+00005d80: 3a0a 2020 2020 2020 2020 2222 2253 6574  :.        """Set
+00005d90: 7465 723a 206d 6178 5f63 7075 5f70 6572  ter: max_cpu_per
+00005da0: 6365 6e74 2e22 2222 0a20 2020 2020 2020  cent.""".       
+00005db0: 2073 656c 662e 5f6d 6178 5f63 7075 5f70   self._max_cpu_p
+00005dc0: 6572 6365 6e74 203d 2070 6572 6365 6e74  ercent = percent
+00005dd0: 0a20 2020 2020 2020 2073 656c 662e 5f63  .        self._c
+00005de0: 6f6e 662e 7365 7428 2273 796e 6322 2c20  onf.set("sync", 
+00005df0: 226d 6178 5f63 7075 5f70 6572 6365 6e74  "max_cpu_percent
+00005e00: 222c 2070 6572 6365 6e74 202f 2f20 4350  ", percent // CP
+00005e10: 555f 434f 5245 5f43 4f55 4e54 290a 0a20  U_CORE_COUNT).. 
+00005e20: 2020 2023 203d 3d3d 3d20 5379 6e63 2073     # ==== Sync s
+00005e30: 7461 7465 203d 3d3d 3d3d 3d3d 3d3d 3d3d  tate ===========
+00005e40: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00005e50: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00005e60: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00005e70: 3d3d 3d3d 3d3d 3d0a 0a20 2020 2040 7072  =======..    @pr
+00005e80: 6f70 6572 7479 0a20 2020 2064 6566 2072  operty.    def r
+00005e90: 656d 6f74 655f 6375 7273 6f72 2873 656c  emote_cursor(sel
+00005ea0: 6629 202d 3e20 7374 723a 0a20 2020 2020  f) -> str:.     
+00005eb0: 2020 2022 2222 4375 7273 6f72 2066 726f     """Cursor fro
+00005ec0: 6d20 6c61 7374 2073 796e 6320 7769 7468  m last sync with
+00005ed0: 2072 656d 6f74 6520 4472 6f70 626f 782e   remote Dropbox.
+00005ee0: 2054 6865 2076 616c 7565 2069 7320 7570   The value is up
+00005ef0: 6461 7465 6420 616e 6420 7361 7665 6420  dated and saved 
+00005f00: 746f 0a20 2020 2020 2020 2074 6865 2063  to.        the c
+00005f10: 6f6e 6669 6720 6669 6c65 206f 6e20 6576  onfig file on ev
+00005f20: 6572 7920 7375 6363 6573 7366 756c 2064  ery successful d
+00005f30: 6f77 6e6c 6f61 6420 6f66 2072 656d 6f74  ownload of remot
+00005f40: 6520 6368 616e 6765 732e 2222 220a 2020  e changes.""".  
+00005f50: 2020 2020 2020 7265 7475 726e 2073 656c        return sel
+00005f60: 662e 5f73 7461 7465 2e67 6574 2822 7379  f._state.get("sy
+00005f70: 6e63 222c 2022 6375 7273 6f72 2229 0a0a  nc", "cursor")..
+00005f80: 2020 2020 4072 656d 6f74 655f 6375 7273      @remote_curs
+00005f90: 6f72 2e73 6574 7465 720a 2020 2020 6465  or.setter.    de
+00005fa0: 6620 7265 6d6f 7465 5f63 7572 736f 7228  f remote_cursor(
+00005fb0: 7365 6c66 2c20 6375 7273 6f72 3a20 7374  self, cursor: st
+00005fc0: 7229 202d 3e20 4e6f 6e65 3a0a 2020 2020  r) -> None:.    
+00005fd0: 2020 2020 2222 2253 6574 7465 723a 206c      """Setter: l
+00005fe0: 6173 745f 6375 7273 6f72 2222 220a 2020  ast_cursor""".  
+00005ff0: 2020 2020 2020 7769 7468 2073 656c 662e        with self.
+00006000: 7379 6e63 5f6c 6f63 6b3a 0a20 2020 2020  sync_lock:.     
+00006010: 2020 2020 2020 2073 656c 662e 5f73 7461         self._sta
+00006020: 7465 2e73 6574 2822 7379 6e63 222c 2022  te.set("sync", "
+00006030: 6375 7273 6f72 222c 2063 7572 736f 7229  cursor", cursor)
+00006040: 0a0a 2020 2020 2020 2020 7365 6c66 2e5f  ..        self._
+00006050: 6c6f 6767 6572 2e64 6562 7567 2822 5265  logger.debug("Re
+00006060: 6d6f 7465 2063 7572 736f 7220 7361 7665  mote cursor save
+00006070: 643a 2025 7322 2c20 6375 7273 6f72 290a  d: %s", cursor).
+00006080: 0a20 2020 2040 7072 6f70 6572 7479 0a20  .    @property. 
+00006090: 2020 2064 6566 206c 6f63 616c 5f63 7572     def local_cur
+000060a0: 736f 7228 7365 6c66 2920 2d3e 2066 6c6f  sor(self) -> flo
+000060b0: 6174 3a0a 2020 2020 2020 2020 2222 2254  at:.        """T
+000060c0: 696d 6520 7374 616d 7020 6672 6f6d 206c  ime stamp from l
+000060d0: 6173 7420 7379 6e63 2077 6974 6820 7265  ast sync with re
+000060e0: 6d6f 7465 2044 726f 7062 6f78 2e20 5468  mote Dropbox. Th
+000060f0: 6520 7661 6c75 6520 6973 2075 7064 6174  e value is updat
+00006100: 6564 2061 6e64 2073 6176 6564 0a20 2020  ed and saved.   
+00006110: 2020 2020 2074 6f20 7468 6520 636f 6e66       to the conf
+00006120: 6967 2066 696c 6520 6f6e 2065 7665 7279  ig file on every
+00006130: 2073 7563 6365 7373 6675 6c20 7570 6c6f   successful uplo
+00006140: 6164 206f 6620 6c6f 6361 6c20 6368 616e  ad of local chan
+00006150: 6765 732e 2222 220a 2020 2020 2020 2020  ges.""".        
+00006160: 7265 7475 726e 2073 656c 662e 5f6c 6f63  return self._loc
+00006170: 616c 5f63 7572 736f 720a 0a20 2020 2040  al_cursor..    @
+00006180: 6c6f 6361 6c5f 6375 7273 6f72 2e73 6574  local_cursor.set
+00006190: 7465 720a 2020 2020 6465 6620 6c6f 6361  ter.    def loca
+000061a0: 6c5f 6375 7273 6f72 2873 656c 662c 206c  l_cursor(self, l
+000061b0: 6173 745f 7379 6e63 3a20 666c 6f61 7429  ast_sync: float)
+000061c0: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2020   -> None:.      
+000061d0: 2020 2222 2253 6574 7465 723a 206c 6f63    """Setter: loc
+000061e0: 616c 5f63 7572 736f 7222 2222 0a20 2020  al_cursor""".   
+000061f0: 2020 2020 2077 6974 6820 7365 6c66 2e73       with self.s
+00006200: 796e 635f 6c6f 636b 3a0a 2020 2020 2020  ync_lock:.      
+00006210: 2020 2020 2020 7365 6c66 2e5f 6c6f 6361        self._loca
+00006220: 6c5f 6375 7273 6f72 203d 206c 6173 745f  l_cursor = last_
+00006230: 7379 6e63 0a20 2020 2020 2020 2020 2020  sync.           
+00006240: 2073 656c 662e 5f73 7461 7465 2e73 6574   self._state.set
+00006250: 2822 7379 6e63 222c 2022 6c61 7374 7379  ("sync", "lastsy
+00006260: 6e63 222c 206c 6173 745f 7379 6e63 290a  nc", last_sync).
+00006270: 0a20 2020 2020 2020 2073 656c 662e 5f6c  .        self._l
+00006280: 6f67 6765 722e 6465 6275 6728 224c 6f63  ogger.debug("Loc
+00006290: 616c 2063 7572 736f 7220 7361 7665 643a  al cursor saved:
+000062a0: 2025 7322 2c20 6c61 7374 5f73 796e 6329   %s", last_sync)
+000062b0: 0a0a 2020 2020 4070 726f 7065 7274 790a  ..    @property.
+000062c0: 2020 2020 6465 6620 6c61 7374 5f63 6861      def last_cha
+000062d0: 6e67 6528 7365 6c66 2920 2d3e 2066 6c6f  nge(self) -> flo
+000062e0: 6174 3a0a 2020 2020 2020 2020 2222 2254  at:.        """T
+000062f0: 6865 2074 696d 6520 7374 616d 7020 6f66  he time stamp of
+00006300: 2074 6865 206c 6173 7420 6669 6c65 2063   the last file c
+00006310: 6861 6e67 6520 6f72 2030 2e30 2069 6620  hange or 0.0 if 
+00006320: 7468 6572 6520 6172 6520 6e6f 2066 696c  there are no fil
+00006330: 6520 6368 616e 6765 7320 696e 0a20 2020  e changes in.   
+00006340: 2020 2020 206f 7572 2068 6973 746f 7279       our history
+00006350: 2e22 2222 0a20 2020 2020 2020 2077 6974  .""".        wit
+00006360: 6820 7365 6c66 2e5f 6461 7461 6261 7365  h self._database
+00006370: 5f61 6363 6573 7328 293a 0a20 2020 2020  _access():.     
+00006380: 2020 2020 2020 2072 6f77 203d 2073 656c         row = sel
+00006390: 662e 5f64 622e 6578 6563 7574 6528 2253  f._db.execute("S
+000063a0: 454c 4543 5420 4d41 5828 6c61 7374 5f73  ELECT MAX(last_s
+000063b0: 796e 6329 2046 524f 4d20 2769 6e64 6578  ync) FROM 'index
+000063c0: 2722 292e 6665 7463 686f 6e65 2829 0a20  '").fetchone(). 
+000063d0: 2020 2020 2020 2020 2020 2069 6620 6e6f             if no
+000063e0: 7420 726f 773a 0a20 2020 2020 2020 2020  t row:.         
+000063f0: 2020 2020 2020 2072 6574 7572 6e20 302e         return 0.
+00006400: 300a 2020 2020 2020 2020 2020 2020 7472  0.            tr
+00006410: 793a 0a20 2020 2020 2020 2020 2020 2020  y:.             
+00006420: 2020 2072 6574 7572 6e20 726f 775b 305d     return row[0]
+00006430: 206f 7220 302e 300a 2020 2020 2020 2020   or 0.0.        
+00006440: 2020 2020 6578 6365 7074 2049 6e64 6578      except Index
+00006450: 4572 726f 723a 0a20 2020 2020 2020 2020  Error:.         
+00006460: 2020 2020 2020 2072 6574 7572 6e20 302e         return 0.
+00006470: 300a 0a20 2020 2040 7072 6f70 6572 7479  0..    @property
+00006480: 0a20 2020 2064 6566 206c 6173 745f 7265  .    def last_re
+00006490: 696e 6465 7828 7365 6c66 2920 2d3e 2066  index(self) -> f
+000064a0: 6c6f 6174 3a0a 2020 2020 2020 2020 2222  loat:.        ""
+000064b0: 2254 696d 6520 7374 616d 7020 6f66 206c  "Time stamp of l
+000064c0: 6173 7420 6675 6c6c 2069 6e64 6578 696e  ast full indexin
+000064d0: 672e 2054 6869 7320 6973 2075 7365 6420  g. This is used 
+000064e0: 746f 2064 6574 6572 6d69 6e65 2077 6865  to determine whe
+000064f0: 6e20 7468 6520 6e65 7874 0a20 2020 2020  n the next.     
+00006500: 2020 2066 756c 6c20 696e 6465 7869 6e67     full indexing
+00006510: 2073 686f 756c 6420 7461 6b65 2070 6c61   should take pla
+00006520: 6365 2e22 2222 0a20 2020 2020 2020 2072  ce.""".        r
+00006530: 6574 7572 6e20 7365 6c66 2e5f 7374 6174  eturn self._stat
+00006540: 652e 6765 7428 2273 796e 6322 2c20 226c  e.get("sync", "l
+00006550: 6173 745f 7265 696e 6465 7822 290a 0a20  ast_reindex").. 
+00006560: 2020 2064 6566 2067 6574 5f68 6973 746f     def get_histo
+00006570: 7279 2873 656c 662c 2064 6278 5f70 6174  ry(self, dbx_pat
+00006580: 683a 2073 7472 207c 204e 6f6e 6520 3d20  h: str | None = 
+00006590: 4e6f 6e65 2920 2d3e 206c 6973 745b 5379  None) -> list[Sy
+000065a0: 6e63 4576 656e 745d 3a0a 2020 2020 2020  ncEvent]:.      
+000065b0: 2020 2222 2241 206c 6973 7420 6f66 2074    """A list of t
+000065c0: 6865 206c 6173 7420 5379 6e63 4576 656e  he last SyncEven
+000065d0: 7473 2069 6e20 6f75 7220 6869 7374 6f72  ts in our histor
+000065e0: 792e 2048 6973 746f 7279 2077 696c 6c20  y. History will 
+000065f0: 6265 206b 6570 7420 666f 7220 7468 650a  be kept for the.
+00006600: 2020 2020 2020 2020 696e 7465 7276 616c          interval
+00006610: 2073 7065 6369 6669 6564 2062 7920 7468   specified by th
+00006620: 6520 636f 6e66 6967 2076 616c 7565 2060  e config value `
+00006630: 606b 6565 705f 6869 7374 6f72 7960 6020  `keep_history`` 
+00006640: 2864 6566 6175 6c74 7320 746f 2074 776f  (defaults to two
+00006650: 2077 6565 6b73 290a 2020 2020 2020 2020   weeks).        
+00006660: 6275 7420 6174 206d 6f73 7420 312c 3030  but at most 1,00
+00006670: 3020 6576 656e 7473 2077 696c 6c20 6265  0 events will be
+00006680: 206b 6570 742e 2222 220a 2020 2020 2020   kept.""".      
+00006690: 2020 7769 7468 2073 656c 662e 5f64 6174    with self._dat
+000066a0: 6162 6173 655f 6163 6365 7373 2829 3a0a  abase_access():.
+000066b0: 2020 2020 2020 2020 2020 2020 7175 6572              quer
+000066c0: 793a 2051 7565 7279 0a20 2020 2020 2020  y: Query.       
+000066d0: 2020 2020 2069 6620 6462 785f 7061 7468       if dbx_path
+000066e0: 2069 7320 4e6f 6e65 3a0a 2020 2020 2020   is None:.      
+000066f0: 2020 2020 2020 2020 2020 7175 6572 7920            query 
+00006700: 3d20 416c 6c51 7565 7279 2829 0a20 2020  = AllQuery().   
+00006710: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
+00006720: 2020 2020 2020 2020 2020 2020 2020 2071                 q
+00006730: 7565 7279 203d 204d 6174 6368 5175 6572  uery = MatchQuer
+00006740: 7928 5379 6e63 4576 656e 742e 6462 785f  y(SyncEvent.dbx_
+00006750: 7061 7468 2c20 6462 785f 7061 7468 290a  path, dbx_path).
+00006760: 0a20 2020 2020 2020 2020 2020 206f 7264  .            ord
+00006770: 6572 5f65 7870 7220 3d20 2249 464e 554c  er_expr = "IFNUL
+00006780: 4c28 6368 616e 6765 5f74 696d 652c 2073  L(change_time, s
+00006790: 796e 635f 7469 6d65 2922 0a20 2020 2020  ync_time)".     
+000067a0: 2020 2020 2020 2073 796e 635f 6576 656e         sync_even
+000067b0: 7473 203d 2073 656c 662e 5f68 6973 746f  ts = self._histo
+000067c0: 7279 5f74 6162 6c65 2e73 656c 6563 7428  ry_table.select(
+000067d0: 7175 6572 792e 6f72 6465 725f 6279 286f  query.order_by(o
+000067e0: 7264 6572 5f65 7870 7229 290a 2020 2020  rder_expr)).    
+000067f0: 2020 2020 2020 2020 7265 7475 726e 2073          return s
+00006800: 796e 635f 6576 656e 7473 0a0a 2020 2020  ync_events..    
+00006810: 6465 6620 7265 7365 745f 7379 6e63 5f73  def reset_sync_s
+00006820: 7461 7465 2873 656c 6629 202d 3e20 4e6f  tate(self) -> No
+00006830: 6e65 3a0a 2020 2020 2020 2020 2222 2252  ne:.        """R
+00006840: 6573 6574 7320 616c 6c20 7361 7665 6420  esets all saved 
+00006850: 7379 6e63 2073 7461 7465 2e20 5365 7474  sync state. Sett
+00006860: 696e 6773 2061 7265 206e 6f74 2061 6666  ings are not aff
+00006870: 6563 7465 642e 2222 220a 2020 2020 2020  ected.""".      
+00006880: 2020 6966 2073 656c 662e 6275 7379 2829    if self.busy()
+00006890: 3a0a 2020 2020 2020 2020 2020 2020 7261  :.            ra
+000068a0: 6973 6520 5275 6e74 696d 6545 7272 6f72  ise RuntimeError
+000068b0: 2822 4361 6e6e 6f74 2072 6573 6574 2073  ("Cannot reset s
+000068c0: 796e 6320 7374 6174 6520 7768 696c 6520  ync state while 
+000068d0: 7379 6e63 696e 672e 2229 0a0a 2020 2020  syncing.")..    
+000068e0: 2020 2020 7769 7468 2073 656c 662e 5f64      with self._d
+000068f0: 6174 6162 6173 655f 6163 6365 7373 2829  atabase_access()
+00006900: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
+00006910: 6c66 2e5f 696e 6465 785f 7461 626c 652e  lf._index_table.
+00006920: 636c 6561 7228 290a 2020 2020 2020 2020  clear().        
+00006930: 2020 2020 7365 6c66 2e5f 6869 7374 6f72      self._histor
+00006940: 795f 7461 626c 652e 636c 6561 7228 290a  y_table.clear().
+00006950: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+00006960: 2e5f 7379 6e63 5f65 7272 6f72 735f 7461  ._sync_errors_ta
+00006970: 626c 652e 636c 6561 7228 290a 2020 2020  ble.clear().    
+00006980: 2020 2020 2020 2020 7365 6c66 2e5f 6861          self._ha
+00006990: 7368 5f74 6162 6c65 2e63 6c65 6172 2829  sh_table.clear()
+000069a0: 0a0a 2020 2020 2020 2020 7365 6c66 2e5f  ..        self._
+000069b0: 7374 6174 652e 7265 7365 745f 746f 5f64  state.reset_to_d
+000069c0: 6566 6175 6c74 7328 2273 796e 6322 290a  efaults("sync").
+000069d0: 2020 2020 2020 2020 7365 6c66 2e72 656c          self.rel
+000069e0: 6f61 645f 6361 6368 6564 5f63 6f6e 6669  oad_cached_confi
+000069f0: 6728 290a 0a20 2020 2020 2020 2073 656c  g()..        sel
+00006a00: 662e 5f6c 6f67 6765 722e 6465 6275 6728  f._logger.debug(
+00006a10: 2253 796e 6320 7374 6174 6520 7265 7365  "Sync state rese
+00006a20: 7422 290a 0a20 2020 2023 203d 3d3d 3d20  t")..    # ==== 
+00006a30: 5379 6e63 2065 7272 6f72 206d 616e 6167  Sync error manag
+00006a40: 656d 656e 7420 3d3d 3d3d 3d3d 3d3d 3d3d  ement ==========
+00006a50: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00006a60: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00006a70: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d0a 0a20  =============.. 
+00006a80: 2020 2040 7072 6f70 6572 7479 0a20 2020     @property.   
+00006a90: 2064 6566 2073 796e 635f 6572 726f 7273   def sync_errors
+00006aa0: 2873 656c 6629 202d 3e20 6c69 7374 5b53  (self) -> list[S
+00006ab0: 796e 6345 7272 6f72 456e 7472 795d 3a0a  yncErrorEntry]:.
+00006ac0: 2020 2020 2020 2020 2222 2252 6574 7572          """Retur
+00006ad0: 6e73 2061 206c 6973 7420 6f66 2061 6c6c  ns a list of all
+00006ae0: 2073 796e 6320 6572 726f 7273 2e22 2222   sync errors."""
+00006af0: 0a20 2020 2020 2020 2077 6974 6820 7365  .        with se
+00006b00: 6c66 2e5f 6461 7461 6261 7365 5f61 6363  lf._database_acc
+00006b10: 6573 7328 293a 0a20 2020 2020 2020 2020  ess():.         
+00006b20: 2020 2072 6574 7572 6e20 7365 6c66 2e5f     return self._
+00006b30: 7379 6e63 5f65 7272 6f72 735f 7461 626c  sync_errors_tabl
+00006b40: 652e 7365 6c65 6374 2841 6c6c 5175 6572  e.select(AllQuer
+00006b50: 7928 2929 0a0a 2020 2020 4070 726f 7065  y())..    @prope
+00006b60: 7274 790a 2020 2020 6465 6620 7570 6c6f  rty.    def uplo
+00006b70: 6164 5f65 7272 6f72 7328 7365 6c66 2920  ad_errors(self) 
+00006b80: 2d3e 206c 6973 745b 5379 6e63 4572 726f  -> list[SyncErro
+00006b90: 7245 6e74 7279 5d3a 0a20 2020 2020 2020  rEntry]:.       
+00006ba0: 2022 2222 5265 7475 726e 7320 6120 6c69   """Returns a li
+00006bb0: 7374 206f 6620 616c 6c20 7570 6c6f 6164  st of all upload
+00006bc0: 2065 7272 6f72 732e 2222 220a 2020 2020   errors.""".    
+00006bd0: 2020 2020 7769 7468 2073 656c 662e 5f64      with self._d
+00006be0: 6174 6162 6173 655f 6163 6365 7373 2829  atabase_access()
+00006bf0: 3a0a 2020 2020 2020 2020 2020 2020 7175  :.            qu
+00006c00: 6572 7920 3d20 4d61 7463 6851 7565 7279  ery = MatchQuery
+00006c10: 2853 796e 6345 7272 6f72 456e 7472 792e  (SyncErrorEntry.
+00006c20: 6469 7265 6374 696f 6e2c 2053 796e 6344  direction, SyncD
+00006c30: 6972 6563 7469 6f6e 2e55 7029 0a20 2020  irection.Up).   
+00006c40: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+00006c50: 7365 6c66 2e5f 7379 6e63 5f65 7272 6f72  self._sync_error
+00006c60: 735f 7461 626c 652e 7365 6c65 6374 2871  s_table.select(q
+00006c70: 7565 7279 290a 0a20 2020 2040 7072 6f70  uery)..    @prop
+00006c80: 6572 7479 0a20 2020 2064 6566 2064 6f77  erty.    def dow
+00006c90: 6e6c 6f61 645f 6572 726f 7273 2873 656c  nload_errors(sel
+00006ca0: 6629 202d 3e20 6c69 7374 5b53 796e 6345  f) -> list[SyncE
+00006cb0: 7272 6f72 456e 7472 795d 3a0a 2020 2020  rrorEntry]:.    
+00006cc0: 2020 2020 2222 2252 6574 7572 6e73 2061      """Returns a
+00006cd0: 206c 6973 7420 6f66 2061 6c6c 2064 6f77   list of all dow
+00006ce0: 6e6c 6f61 6420 6572 726f 7273 2e22 2222  nload errors."""
+00006cf0: 0a20 2020 2020 2020 2077 6974 6820 7365  .        with se
+00006d00: 6c66 2e5f 6461 7461 6261 7365 5f61 6363  lf._database_acc
+00006d10: 6573 7328 293a 0a20 2020 2020 2020 2020  ess():.         
+00006d20: 2020 2071 7565 7279 203d 204d 6174 6368     query = Match
+00006d30: 5175 6572 7928 5379 6e63 4572 726f 7245  Query(SyncErrorE
+00006d40: 6e74 7279 2e64 6972 6563 7469 6f6e 2c20  ntry.direction, 
+00006d50: 5379 6e63 4469 7265 6374 696f 6e2e 446f  SyncDirection.Do
+00006d60: 776e 290a 2020 2020 2020 2020 2020 2020  wn).            
+00006d70: 7265 7475 726e 2073 656c 662e 5f73 796e  return self._syn
+00006d80: 635f 6572 726f 7273 5f74 6162 6c65 2e73  c_errors_table.s
+00006d90: 656c 6563 7428 7175 6572 7929 0a0a 2020  elect(query)..  
+00006da0: 2020 6465 6620 6861 735f 7379 6e63 5f65    def has_sync_e
+00006db0: 7272 6f72 7328 7365 6c66 2920 2d3e 2062  rrors(self) -> b
+00006dc0: 6f6f 6c3a 0a20 2020 2020 2020 2022 2222  ool:.        """
+00006dd0: 5265 7475 726e 7320 6060 5472 7565 6060  Returns ``True``
+00006de0: 2069 6e20 6361 7365 206f 6620 7379 6e63   in case of sync
+00006df0: 2065 7272 6f72 732c 2060 6046 616c 7365   errors, ``False
+00006e00: 6060 206f 7468 6572 7769 7365 2e22 2222  `` otherwise."""
+00006e10: 0a20 2020 2020 2020 2077 6974 6820 7365  .        with se
+00006e20: 6c66 2e5f 6461 7461 6261 7365 5f61 6363  lf._database_acc
+00006e30: 6573 7328 293a 0a20 2020 2020 2020 2020  ess():.         
+00006e40: 2020 2072 6574 7572 6e20 7365 6c66 2e5f     return self._
+00006e50: 7379 6e63 5f65 7272 6f72 735f 7461 626c  sync_errors_tabl
+00006e60: 652e 636f 756e 7428 2920 3e20 300a 0a20  e.count() > 0.. 
+00006e70: 2020 2064 6566 2073 796e 635f 6572 726f     def sync_erro
+00006e80: 7273 5f66 6f72 5f70 6174 6828 0a20 2020  rs_for_path(.   
+00006e90: 2020 2020 2073 656c 662c 2064 6278 5f70       self, dbx_p
+00006ea0: 6174 685f 6c6f 7765 723a 2073 7472 2c20  ath_lower: str, 
+00006eb0: 6469 7265 6374 696f 6e3a 2053 796e 6344  direction: SyncD
+00006ec0: 6972 6563 7469 6f6e 207c 204e 6f6e 6520  irection | None 
+00006ed0: 3d20 4e6f 6e65 0a20 2020 2029 202d 3e20  = None.    ) -> 
+00006ee0: 6c69 7374 5b53 796e 6345 7272 6f72 456e  list[SyncErrorEn
+00006ef0: 7472 795d 3a0a 2020 2020 2020 2020 2222  try]:.        ""
+00006f00: 220a 2020 2020 2020 2020 5265 7475 726e  ".        Return
+00006f10: 7320 6120 6c69 7374 206f 6620 616c 6c20  s a list of all 
+00006f20: 7379 6e63 2065 7272 6f72 7320 666f 7220  sync errors for 
+00006f30: 7468 6520 6769 7665 6e20 7061 7468 2061  the given path a
+00006f40: 6e64 2069 7473 2063 6869 6c64 7265 6e2e  nd its children.
+00006f50: 0a0a 2020 2020 2020 2020 3a70 6172 616d  ..        :param
+00006f60: 2064 6278 5f70 6174 685f 6c6f 7765 723a   dbx_path_lower:
+00006f70: 204e 6f72 6d61 6c69 7365 6420 4472 6f70   Normalised Drop
+00006f80: 626f 7820 7061 7468 2e0a 2020 2020 2020  box path..      
+00006f90: 2020 3a70 6172 616d 2064 6972 6563 7469    :param directi
+00006fa0: 6f6e 3a20 4469 7265 6374 696f 6e20 746f  on: Direction to
+00006fb0: 2066 696c 7465 7220 7379 6e63 2065 7272   filter sync err
+00006fc0: 6f72 732e 2049 6620 6e6f 7420 6769 7665  ors. If not give
+00006fd0: 6e2c 2062 6f74 6820 7570 6c6f 6164 0a20  n, both upload. 
+00006fe0: 2020 2020 2020 2020 2020 2061 6e64 2064             and d
+00006ff0: 6f77 6e6c 6f61 6420 6572 726f 7273 2077  ownload errors w
+00007000: 696c 6c20 6265 2072 6574 7572 6e65 642e  ill be returned.
+00007010: 0a20 2020 2020 2020 203a 7265 7475 726e  .        :return
+00007020: 733a 204c 6973 7420 6f66 2073 796e 6320  s: List of sync 
+00007030: 6572 726f 7273 2e0a 2020 2020 2020 2020  errors..        
+00007040: 2222 220a 2020 2020 2020 2020 7769 7468  """.        with
+00007050: 2073 656c 662e 5f64 6174 6162 6173 655f   self._database_
+00007060: 6163 6365 7373 2829 3a0a 2020 2020 2020  access():.      
+00007070: 2020 2020 2020 7061 7468 5f74 7265 655f        path_tree_
+00007080: 7175 6572 7920 3d20 5061 7468 5472 6565  query = PathTree
+00007090: 5175 6572 7928 0a20 2020 2020 2020 2020  Query(.         
+000070a0: 2020 2020 2020 2053 796e 6345 7272 6f72         SyncError
+000070b0: 456e 7472 792e 6462 785f 7061 7468 5f6c  Entry.dbx_path_l
+000070c0: 6f77 6572 2c20 6462 785f 7061 7468 5f6c  ower, dbx_path_l
+000070d0: 6f77 6572 0a20 2020 2020 2020 2020 2020  ower.           
+000070e0: 2029 0a0a 2020 2020 2020 2020 2020 2020   )..            
+000070f0: 6966 2064 6972 6563 7469 6f6e 3a0a 2020  if direction:.  
+00007100: 2020 2020 2020 2020 2020 2020 2020 6469                di
+00007110: 7265 6374 696f 6e5f 7175 6572 7920 3d20  rection_query = 
+00007120: 4d61 7463 6851 7565 7279 2853 796e 6345  MatchQuery(SyncE
+00007130: 7272 6f72 456e 7472 792e 6469 7265 6374  rrorEntry.direct
+00007140: 696f 6e2c 2064 6972 6563 7469 6f6e 290a  ion, direction).
+00007150: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007160: 6a6f 696e 745f 7175 6572 7920 3d20 416e  joint_query = An
+00007170: 6451 7565 7279 2870 6174 685f 7472 6565  dQuery(path_tree
+00007180: 5f71 7565 7279 2c20 6469 7265 6374 696f  _query, directio
+00007190: 6e5f 7175 6572 7929 0a20 2020 2020 2020  n_query).       
+000071a0: 2020 2020 2020 2020 2065 7272 6f72 7320           errors 
+000071b0: 3d20 7365 6c66 2e5f 7379 6e63 5f65 7272  = self._sync_err
+000071c0: 6f72 735f 7461 626c 652e 7365 6c65 6374  ors_table.select
+000071d0: 286a 6f69 6e74 5f71 7565 7279 290a 2020  (joint_query).  
+000071e0: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
+000071f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007200: 6572 726f 7273 203d 2073 656c 662e 5f73  errors = self._s
+00007210: 796e 635f 6572 726f 7273 5f74 6162 6c65  ync_errors_table
+00007220: 2e73 656c 6563 7428 7061 7468 5f74 7265  .select(path_tre
+00007230: 655f 7175 6572 7929 0a0a 2020 2020 2020  e_query)..      
+00007240: 2020 2020 2020 7265 7475 726e 2065 7272        return err
+00007250: 6f72 730a 0a20 2020 2064 6566 2063 6c65  ors..    def cle
+00007260: 6172 5f73 796e 635f 6572 726f 7273 5f66  ar_sync_errors_f
+00007270: 6f72 5f70 6174 6828 0a20 2020 2020 2020  or_path(.       
+00007280: 2073 656c 662c 2064 6278 5f70 6174 685f   self, dbx_path_
+00007290: 6c6f 7765 723a 2073 7472 2c20 7265 6375  lower: str, recu
+000072a0: 7273 6976 653a 2062 6f6f 6c20 3d20 4661  rsive: bool = Fa
+000072b0: 6c73 650a 2020 2020 2920 2d3e 204e 6f6e  lse.    ) -> Non
+000072c0: 653a 0a20 2020 2020 2020 2022 2222 0a20  e:.        """. 
+000072d0: 2020 2020 2020 2043 6c65 6172 2061 6c6c         Clear all
+000072e0: 2073 796e 6320 6572 726f 7273 2066 6f72   sync errors for
+000072f0: 2061 2070 6174 6820 6166 7465 7220 6120   a path after a 
+00007300: 7375 6363 6573 7366 756c 2073 796e 6320  successful sync 
+00007310: 6576 656e 742e 0a0a 2020 2020 2020 2020  event...        
+00007320: 3a70 6172 616d 2064 6278 5f70 6174 685f  :param dbx_path_
+00007330: 6c6f 7765 723a 204e 6f72 6d61 6c69 7365  lower: Normalise
+00007340: 6420 4472 6f70 626f 7820 7061 7468 2074  d Dropbox path t
+00007350: 6f20 636c 6561 722e 0a20 2020 2020 2020  o clear..       
+00007360: 203a 7061 7261 6d20 7265 6375 7273 6976   :param recursiv
+00007370: 653a 2057 6865 7468 6572 2074 6f20 636c  e: Whether to cl
+00007380: 6561 7220 7379 6e63 2065 7272 6f72 7320  ear sync errors 
+00007390: 666f 7220 6368 696c 6472 656e 206f 6620  for children of 
+000073a0: 7468 6520 6769 7665 6e20 7061 7468 2e0a  the given path..
+000073b0: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
+000073c0: 2020 2020 7769 7468 2073 656c 662e 5f64      with self._d
+000073d0: 6174 6162 6173 655f 6163 6365 7373 2829  atabase_access()
+000073e0: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
+000073f0: 6c66 2e5f 7379 6e63 5f65 7272 6f72 735f  lf._sync_errors_
+00007400: 7461 626c 652e 6465 6c65 7465 5f70 7269  table.delete_pri
+00007410: 6d61 7279 5f6b 6579 2864 6278 5f70 6174  mary_key(dbx_pat
+00007420: 685f 6c6f 7765 7229 0a0a 2020 2020 2020  h_lower)..      
+00007430: 2020 2020 2020 6966 2072 6563 7572 7369        if recursi
+00007440: 7665 3a0a 2020 2020 2020 2020 2020 2020  ve:.            
+00007450: 2020 2020 7175 6572 7920 3d20 5061 7468      query = Path
+00007460: 5472 6565 5175 6572 7928 5379 6e63 4572  TreeQuery(SyncEr
+00007470: 726f 7245 6e74 7279 2e64 6278 5f70 6174  rorEntry.dbx_pat
+00007480: 685f 6c6f 7765 722c 2064 6278 5f70 6174  h_lower, dbx_pat
+00007490: 685f 6c6f 7765 7229 0a20 2020 2020 2020  h_lower).       
+000074a0: 2020 2020 2020 2020 2073 656c 662e 5f73           self._s
+000074b0: 796e 635f 6572 726f 7273 5f74 6162 6c65  ync_errors_table
+000074c0: 2e64 656c 6574 6528 7175 6572 7929 0a0a  .delete(query)..
+000074d0: 2020 2020 6465 6620 636c 6561 725f 7379      def clear_sy
+000074e0: 6e63 5f65 7272 6f72 735f 6672 6f6d 5f65  nc_errors_from_e
+000074f0: 7665 6e74 2873 656c 662c 2065 7665 6e74  vent(self, event
+00007500: 3a20 5379 6e63 4576 656e 7429 202d 3e20  : SyncEvent) -> 
+00007510: 4e6f 6e65 3a0a 2020 2020 2020 2020 2222  None:.        ""
+00007520: 2243 6c65 6172 7320 7379 6e63 2065 7272  "Clears sync err
+00007530: 6f72 7320 636f 7272 6573 706f 6e64 696e  ors correspondin
+00007540: 6720 746f 2061 2073 796e 6320 6576 656e  g to a sync even
+00007550: 742e 2222 220a 2020 2020 2020 2020 7265  t.""".        re
+00007560: 6375 7273 6976 6520 3d20 6576 656e 742e  cursive = event.
+00007570: 6973 5f6d 6f76 6564 206f 7220 6576 656e  is_moved or even
+00007580: 742e 6973 5f64 656c 6574 6564 206f 7220  t.is_deleted or 
+00007590: 6576 656e 742e 6973 5f66 696c 650a 0a20  event.is_file.. 
+000075a0: 2020 2020 2020 2073 656c 662e 636c 6561         self.clea
+000075b0: 725f 7379 6e63 5f65 7272 6f72 735f 666f  r_sync_errors_fo
+000075c0: 725f 7061 7468 2865 7665 6e74 2e64 6278  r_path(event.dbx
+000075d0: 5f70 6174 685f 6c6f 7765 722c 2072 6563  _path_lower, rec
+000075e0: 7572 7369 7665 290a 2020 2020 2020 2020  ursive).        
+000075f0: 6966 2065 7665 6e74 2e64 6278 5f70 6174  if event.dbx_pat
+00007600: 685f 6672 6f6d 5f6c 6f77 6572 2069 7320  h_from_lower is 
+00007610: 6e6f 7420 4e6f 6e65 3a0a 2020 2020 2020  not None:.      
+00007620: 2020 2020 2020 7365 6c66 2e63 6c65 6172        self.clear
+00007630: 5f73 796e 635f 6572 726f 7273 5f66 6f72  _sync_errors_for
+00007640: 5f70 6174 6828 6576 656e 742e 6462 785f  _path(event.dbx_
+00007650: 7061 7468 5f66 726f 6d5f 6c6f 7765 722c  path_from_lower,
+00007660: 2072 6563 7572 7369 7665 290a 0a20 2020   recursive)..   
+00007670: 2023 203d 3d3d 3d20 496e 6465 7820 6163   # ==== Index ac
+00007680: 6365 7373 2061 6e64 206d 616e 6167 656d  cess and managem
+00007690: 656e 7420 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ent ============
+000076a0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+000076b0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+000076c0: 3d3d 3d3d 3d0a 0a20 2020 2064 6566 2067  =====..    def g
+000076d0: 6574 5f69 6e64 6578 2873 656c 6629 202d  et_index(self) -
+000076e0: 3e20 6c69 7374 5b49 6e64 6578 456e 7472  > list[IndexEntr
+000076f0: 795d 3a0a 2020 2020 2020 2020 2222 220a  y]:.        """.
+00007700: 2020 2020 2020 2020 5265 7475 726e 7320          Returns 
+00007710: 6120 636f 7079 206f 6620 7468 6520 6c6f  a copy of the lo
+00007720: 6361 6c20 696e 6465 7820 6f66 2073 796e  cal index of syn
+00007730: 6365 6420 6669 6c65 7320 616e 6420 666f  ced files and fo
+00007740: 6c64 6572 732e 0a0a 2020 2020 2020 2020  lders...        
+00007750: 3a72 6574 7572 6e73 3a20 4c69 7374 206f  :returns: List o
+00007760: 6620 696e 6465 7820 656e 7472 6965 732e  f index entries.
+00007770: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
+00007780: 2020 2020 2077 6974 6820 7365 6c66 2e5f       with self._
+00007790: 6461 7461 6261 7365 5f61 6363 6573 7328  database_access(
+000077a0: 293a 0a20 2020 2020 2020 2020 2020 2072  ):.            r
+000077b0: 6574 7572 6e20 7365 6c66 2e5f 696e 6465  eturn self._inde
+000077c0: 785f 7461 626c 652e 7365 6c65 6374 2841  x_table.select(A
+000077d0: 6c6c 5175 6572 7928 2929 0a0a 2020 2020  llQuery())..    
+000077e0: 6465 6620 6765 745f 696e 6465 785f 656e  def get_index_en
+000077f0: 7472 7928 7365 6c66 2c20 6462 785f 7061  try(self, dbx_pa
+00007800: 7468 5f6c 6f77 6572 3a20 7374 7229 202d  th_lower: str) -
+00007810: 3e20 496e 6465 7845 6e74 7279 207c 204e  > IndexEntry | N
+00007820: 6f6e 653a 0a20 2020 2020 2020 2022 2222  one:.        """
+00007830: 0a20 2020 2020 2020 2047 6574 7320 7468  .        Gets th
+00007840: 6520 696e 6465 7820 656e 7472 7920 666f  e index entry fo
+00007850: 7220 7468 6520 6769 7665 6e20 4472 6f70  r the given Drop
+00007860: 626f 7820 7061 7468 2e0a 0a20 2020 2020  box path...     
+00007870: 2020 203a 7061 7261 6d20 6462 785f 7061     :param dbx_pa
+00007880: 7468 5f6c 6f77 6572 3a20 4e6f 726d 616c  th_lower: Normal
+00007890: 697a 6564 206c 6f77 6572 2063 6173 6520  ized lower case 
+000078a0: 4472 6f70 626f 7820 7061 7468 2e0a 2020  Dropbox path..  
+000078b0: 2020 2020 2020 3a72 6574 7572 6e73 3a20        :returns: 
+000078c0: 496e 6465 7820 656e 7472 7920 6f72 2060  Index entry or `
+000078d0: 604e 6f6e 6560 6020 6966 206e 6f20 656e  `None`` if no en
+000078e0: 7472 7920 6578 6973 7473 2066 6f72 2074  try exists for t
+000078f0: 6865 2067 6976 656e 2070 6174 682e 0a20  he given path.. 
+00007900: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
+00007910: 2020 2077 6974 6820 7365 6c66 2e5f 6461     with self._da
+00007920: 7461 6261 7365 5f61 6363 6573 7328 293a  tabase_access():
+00007930: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+00007940: 7572 6e20 7365 6c66 2e5f 696e 6465 785f  urn self._index_
+00007950: 7461 626c 652e 6765 7428 6462 785f 7061  table.get(dbx_pa
+00007960: 7468 5f6c 6f77 6572 290a 0a20 2020 2064  th_lower)..    d
+00007970: 6566 2067 6574 5f69 6e64 6578 5f65 6e74  ef get_index_ent
+00007980: 7279 5f66 6f72 5f6c 6f63 616c 5f70 6174  ry_for_local_pat
+00007990: 6828 7365 6c66 2c20 6c6f 6361 6c5f 7061  h(self, local_pa
+000079a0: 7468 3a20 7374 7229 202d 3e20 496e 6465  th: str) -> Inde
+000079b0: 7845 6e74 7279 207c 204e 6f6e 653a 0a20  xEntry | None:. 
+000079c0: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
+000079d0: 2020 2047 6574 7320 7468 6520 696e 6465     Gets the inde
+000079e0: 7820 656e 7472 7920 666f 7220 7468 6520  x entry for the 
+000079f0: 6769 7665 6e20 6c6f 6361 6c20 7061 7468  given local path
+00007a00: 2e20 456e 7375 7265 7320 7468 6174 2074  . Ensures that t
+00007a10: 6865 2069 6e64 6578 2065 6e74 7279 2068  he index entry h
+00007a20: 6173 0a20 2020 2020 2020 2074 6865 2063  as.        the c
+00007a30: 6f72 7265 6374 2063 6173 696e 672e 0a0a  orrect casing...
+00007a40: 2020 2020 2020 2020 3a70 6172 616d 206c          :param l
+00007a50: 6f63 616c 5f70 6174 683a 204c 6f63 616c  ocal_path: Local
+00007a60: 2070 6174 6820 6173 2072 6574 7572 6e65   path as returne
+00007a70: 6420 6279 2066 696c 6520 7379 7374 656d  d by file system
+00007a80: 2041 5049 732e 0a20 2020 2020 2020 203a   APIs..        :
+00007a90: 7265 7475 726e 733a 2049 6e64 6578 2065  returns: Index e
+00007aa0: 6e74 7279 206f 7220 6060 4e6f 6e65 6060  ntry or ``None``
+00007ab0: 2069 6620 6e6f 2065 6e74 7279 2065 7869   if no entry exi
+00007ac0: 7374 7320 666f 7220 7468 6520 6769 7665  sts for the give
+00007ad0: 6e20 7061 7468 2e0a 2020 2020 2020 2020  n path..        
+00007ae0: 2222 220a 2020 2020 2020 2020 6462 785f  """.        dbx_
+00007af0: 7061 7468 5f63 6173 6564 203d 2073 656c  path_cased = sel
+00007b00: 662e 746f 5f64 6278 5f70 6174 6828 6c6f  f.to_dbx_path(lo
+00007b10: 6361 6c5f 7061 7468 290a 2020 2020 2020  cal_path).      
+00007b20: 2020 6462 785f 7061 7468 5f6c 6f77 6572    dbx_path_lower
+00007b30: 203d 2073 656c 662e 746f 5f64 6278 5f70   = self.to_dbx_p
+00007b40: 6174 685f 6c6f 7765 7228 6c6f 6361 6c5f  ath_lower(local_
+00007b50: 7061 7468 290a 0a20 2020 2020 2020 2069  path)..        i
+00007b60: 6e64 6578 5f65 6e74 7279 203d 2073 656c  ndex_entry = sel
+00007b70: 662e 6765 745f 696e 6465 785f 656e 7472  f.get_index_entr
+00007b80: 7928 6462 785f 7061 7468 5f6c 6f77 6572  y(dbx_path_lower
+00007b90: 290a 0a20 2020 2020 2020 2069 6620 6e6f  )..        if no
+00007ba0: 7420 696e 6465 785f 656e 7472 793a 0a20  t index_entry:. 
+00007bb0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+00007bc0: 6e20 4e6f 6e65 0a0a 2020 2020 2020 2020  n None..        
+00007bd0: 6966 2069 6e64 6578 5f65 6e74 7279 2e64  if index_entry.d
+00007be0: 6278 5f70 6174 685f 6361 7365 6420 3d3d  bx_path_cased ==
+00007bf0: 2064 6278 5f70 6174 685f 6361 7365 643a   dbx_path_cased:
+00007c00: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+00007c10: 7572 6e20 696e 6465 785f 656e 7472 790a  urn index_entry.
+00007c20: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+00007c30: 4e6f 6e65 0a0a 2020 2020 6465 6620 6974  None..    def it
+00007c40: 6572 5f69 6e64 6578 2873 656c 6629 202d  er_index(self) -
+00007c50: 3e20 4974 6572 6174 6f72 5b49 6e64 6578  > Iterator[Index
+00007c60: 456e 7472 795d 3a0a 2020 2020 2020 2020  Entry]:.        
+00007c70: 2222 220a 2020 2020 2020 2020 5265 7475  """.        Retu
+00007c80: 726e 7320 616e 2069 7465 7261 746f 7220  rns an iterator 
+00007c90: 6f76 6572 2074 6865 206c 6f63 616c 2069  over the local i
+00007ca0: 6e64 6578 206f 6620 7379 6e63 6564 2066  ndex of synced f
+00007cb0: 696c 6573 2061 6e64 2066 6f6c 6465 7273  iles and folders
+00007cc0: 2e0a 0a20 2020 2020 2020 203a 7265 7475  ...        :retu
+00007cd0: 726e 733a 2049 7465 7261 746f 7220 6f76  rns: Iterator ov
+00007ce0: 6572 2069 6e64 6578 2065 6e74 7269 6573  er index entries
+00007cf0: 2e0a 2020 2020 2020 2020 2222 220a 2020  ..        """.  
+00007d00: 2020 2020 2020 7769 7468 2073 656c 662e        with self.
+00007d10: 5f64 6174 6162 6173 655f 6163 6365 7373  _database_access
+00007d20: 2829 3a0a 2020 2020 2020 2020 2020 2020  ():.            
+00007d30: 666f 7220 656e 7472 6965 7320 696e 2073  for entries in s
+00007d40: 656c 662e 5f69 6e64 6578 5f74 6162 6c65  elf._index_table
+00007d50: 2e73 656c 6563 745f 6974 6572 2841 6c6c  .select_iter(All
+00007d60: 5175 6572 7928 2929 3a0a 2020 2020 2020  Query()):.      
+00007d70: 2020 2020 2020 2020 2020 7969 656c 6420            yield 
+00007d80: 6672 6f6d 2065 6e74 7269 6573 0a0a 2020  from entries..  
+00007d90: 2020 6465 6620 696e 6465 785f 636f 756e    def index_coun
+00007da0: 7428 7365 6c66 2920 2d3e 2069 6e74 3a0a  t(self) -> int:.
+00007db0: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
+00007dc0: 2020 2020 5265 7475 726e 7320 7468 6520      Returns the 
+00007dd0: 6e75 6d62 6572 206f 6620 6974 656d 7320  number of items 
+00007de0: 696e 206f 7572 2069 6e64 6578 2077 6974  in our index wit
+00007df0: 686f 7574 206c 6f61 6469 6e67 2061 6e79  hout loading any
+00007e00: 2069 7465 6d73 2e0a 0a20 2020 2020 2020   items...       
+00007e10: 203a 7265 7475 726e 733a 204e 756d 6265   :returns: Numbe
+00007e20: 7220 6f66 2069 6e64 6578 2065 6e74 7269  r of index entri
+00007e30: 6573 2e0a 2020 2020 2020 2020 2222 220a  es..        """.
+00007e40: 2020 2020 2020 2020 7769 7468 2073 656c          with sel
+00007e50: 662e 5f64 6174 6162 6173 655f 6163 6365  f._database_acce
+00007e60: 7373 2829 3a0a 2020 2020 2020 2020 2020  ss():.          
+00007e70: 2020 7265 7475 726e 2073 656c 662e 5f69    return self._i
+00007e80: 6e64 6578 5f74 6162 6c65 2e63 6f75 6e74  ndex_table.count
+00007e90: 2829 0a0a 2020 2020 6465 6620 6765 745f  ()..    def get_
+00007ea0: 6c6f 6361 6c5f 7265 7628 7365 6c66 2c20  local_rev(self, 
+00007eb0: 6462 785f 7061 7468 5f6c 6f77 6572 3a20  dbx_path_lower: 
+00007ec0: 7374 7229 202d 3e20 7374 7220 7c20 4e6f  str) -> str | No
+00007ed0: 6e65 3a0a 2020 2020 2020 2020 2222 220a  ne:.        """.
+00007ee0: 2020 2020 2020 2020 4765 7473 2072 6576          Gets rev
+00007ef0: 6973 696f 6e20 6e75 6d62 6572 206f 6620  ision number of 
+00007f00: 6c6f 6361 6c20 6669 6c65 2e0a 0a20 2020  local file...   
+00007f10: 2020 2020 203a 7061 7261 6d20 6462 785f       :param dbx_
+00007f20: 7061 7468 5f6c 6f77 6572 3a20 4e6f 726d  path_lower: Norm
+00007f30: 616c 697a 6564 206c 6f77 6572 2063 6173  alized lower cas
+00007f40: 6520 4472 6f70 626f 7820 7061 7468 2e0a  e Dropbox path..
+00007f50: 2020 2020 2020 2020 3a72 6574 7572 6e73          :returns
+00007f60: 3a20 5265 7669 7369 6f6e 206e 756d 6265  : Revision numbe
+00007f70: 7220 6173 2073 7472 206f 7220 6060 4e6f  r as str or ``No
+00007f80: 6e65 6060 2069 6620 6e6f 206c 6f63 616c  ne`` if no local
+00007f90: 2072 6576 6973 696f 6e20 6e75 6d62 6572   revision number
+00007fa0: 2068 6173 0a20 2020 2020 2020 2020 2020   has.           
+00007fb0: 2062 6565 6e20 7361 7665 642e 0a20 2020   been saved..   
+00007fc0: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
+00007fd0: 2065 6e74 7279 203d 2073 656c 662e 6765   entry = self.ge
+00007fe0: 745f 696e 6465 785f 656e 7472 7928 6462  t_index_entry(db
+00007ff0: 785f 7061 7468 5f6c 6f77 6572 290a 0a20  x_path_lower).. 
+00008000: 2020 2020 2020 2069 6620 656e 7472 793a         if entry:
+00008010: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+00008020: 7572 6e20 656e 7472 792e 7265 760a 2020  urn entry.rev.  
+00008030: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+00008040: 2020 2020 2020 2020 7265 7475 726e 204e          return N
+00008050: 6f6e 650a 0a20 2020 2064 6566 2067 6574  one..    def get
+00008060: 5f6c 6173 745f 7379 6e63 2873 656c 662c  _last_sync(self,
+00008070: 2064 6278 5f70 6174 685f 6c6f 7765 723a   dbx_path_lower:
+00008080: 2073 7472 2920 2d3e 2066 6c6f 6174 3a0a   str) -> float:.
+00008090: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
+000080a0: 2020 2020 5265 7475 726e 7320 7468 6520      Returns the 
+000080b0: 7469 6d65 7374 616d 7020 6f66 206c 6173  timestamp of las
+000080c0: 7420 7379 6e63 2066 6f72 2061 6e20 696e  t sync for an in
+000080d0: 6469 7669 6475 616c 2070 6174 682e 0a0a  dividual path...
+000080e0: 2020 2020 2020 2020 3a70 6172 616d 2064          :param d
+000080f0: 6278 5f70 6174 685f 6c6f 7765 723a 204e  bx_path_lower: N
+00008100: 6f72 6d61 6c69 7a65 6420 6c6f 7765 7220  ormalized lower 
+00008110: 6361 7365 2044 726f 7062 6f78 2070 6174  case Dropbox pat
+00008120: 682e 0a20 2020 2020 2020 203a 7265 7475  h..        :retu
+00008130: 726e 733a 2054 696d 6520 6f66 206c 6173  rns: Time of las
+00008140: 7420 7379 6e63 2e0a 2020 2020 2020 2020  t sync..        
+00008150: 2222 220a 2020 2020 2020 2020 656e 7472  """.        entr
+00008160: 7920 3d20 7365 6c66 2e67 6574 5f69 6e64  y = self.get_ind
+00008170: 6578 5f65 6e74 7279 2864 6278 5f70 6174  ex_entry(dbx_pat
+00008180: 685f 6c6f 7765 7229 0a0a 2020 2020 2020  h_lower)..      
+00008190: 2020 6966 2065 6e74 7279 3a0a 2020 2020    if entry:.    
+000081a0: 2020 2020 2020 2020 6c61 7374 5f73 796e          last_syn
+000081b0: 6320 3d20 656e 7472 792e 6c61 7374 5f73  c = entry.last_s
+000081c0: 796e 6320 6f72 2030 2e30 0a20 2020 2020  ync or 0.0.     
+000081d0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+000081e0: 2020 2020 206c 6173 745f 7379 6e63 203d       last_sync =
+000081f0: 2030 2e30 0a0a 2020 2020 2020 2020 7265   0.0..        re
+00008200: 7475 726e 206d 6178 286c 6173 745f 7379  turn max(last_sy
+00008210: 6e63 2c20 7365 6c66 2e6c 6f63 616c 5f63  nc, self.local_c
+00008220: 7572 736f 7229 0a0a 2020 2020 6465 6620  ursor)..    def 
+00008230: 7570 6461 7465 5f69 6e64 6578 5f66 726f  update_index_fro
+00008240: 6d5f 7379 6e63 5f65 7665 6e74 2873 656c  m_sync_event(sel
+00008250: 662c 2065 7665 6e74 3a20 5379 6e63 4576  f, event: SyncEv
+00008260: 656e 7429 202d 3e20 4e6f 6e65 3a0a 2020  ent) -> None:.  
+00008270: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
+00008280: 2020 5570 6461 7465 7320 7468 6520 6c6f    Updates the lo
+00008290: 6361 6c20 696e 6465 7820 6672 6f6d 2061  cal index from a
+000082a0: 2053 796e 6345 7665 6e74 2e0a 0a20 2020   SyncEvent...   
+000082b0: 2020 2020 203a 7061 7261 6d20 6576 656e       :param even
+000082c0: 743a 2053 796e 6345 7665 6e74 2066 726f  t: SyncEvent fro
+000082d0: 6d20 646f 776e 6c6f 6164 2e0a 2020 2020  m download..    
+000082e0: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
+000082f0: 6966 2065 7665 6e74 2e63 6861 6e67 655f  if event.change_
+00008300: 7479 7065 2069 7320 6e6f 7420 4368 616e  type is not Chan
+00008310: 6765 5479 7065 2e52 656d 6f76 6564 2061  geType.Removed a
+00008320: 6e64 206e 6f74 2065 7665 6e74 2e72 6576  nd not event.rev
+00008330: 3a0a 2020 2020 2020 2020 2020 2020 7261  :.            ra
+00008340: 6973 6520 5661 6c75 6545 7272 6f72 2822  ise ValueError("
+00008350: 5265 7620 7265 7175 6972 6564 2074 6f20  Rev required to 
+00008360: 7570 6461 7465 2069 6e64 6578 2229 0a0a  update index")..
+00008370: 2020 2020 2020 2020 6462 785f 7061 7468          dbx_path
+00008380: 5f6c 6f77 6572 203d 2065 7665 6e74 2e64  _lower = event.d
+00008390: 6278 5f70 6174 685f 6c6f 7765 720a 0a20  bx_path_lower.. 
+000083a0: 2020 2020 2020 2077 6974 6820 7365 6c66         with self
+000083b0: 2e5f 6461 7461 6261 7365 5f61 6363 6573  ._database_acces
+000083c0: 7328 293a 0a20 2020 2020 2020 2020 2020  s():.           
+000083d0: 2023 2052 656d 6f76 6520 616e 7920 656e   # Remove any en
+000083e0: 7472 6965 7320 666f 7220 6465 6c65 7465  tries for delete
+000083f0: 6420 6f72 206d 6f76 6564 2069 7465 6d73  d or moved items
+00008400: 2e0a 0a20 2020 2020 2020 2020 2020 2069  ...            i
+00008410: 6620 6576 656e 742e 6368 616e 6765 5f74  f event.change_t
+00008420: 7970 6520 6973 2043 6861 6e67 6554 7970  ype is ChangeTyp
+00008430: 652e 5265 6d6f 7665 643a 0a20 2020 2020  e.Removed:.     
+00008440: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+00008450: 7265 6d6f 7665 5f6e 6f64 655f 6672 6f6d  remove_node_from
+00008460: 5f69 6e64 6578 2864 6278 5f70 6174 685f  _index(dbx_path_
+00008470: 6c6f 7765 7229 0a20 2020 2020 2020 2020  lower).         
+00008480: 2020 2065 6c69 6620 6576 656e 742e 6368     elif event.ch
+00008490: 616e 6765 5f74 7970 6520 6973 2043 6861  ange_type is Cha
+000084a0: 6e67 6554 7970 652e 4d6f 7665 643a 0a20  ngeType.Moved:. 
+000084b0: 2020 2020 2020 2020 2020 2020 2020 2061                 a
+000084c0: 7373 6572 7420 6576 656e 742e 6462 785f  ssert event.dbx_
+000084d0: 7061 7468 5f66 726f 6d5f 6c6f 7765 7220  path_from_lower 
+000084e0: 6973 206e 6f74 204e 6f6e 650a 2020 2020  is not None.    
+000084f0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+00008500: 2e72 656d 6f76 655f 6e6f 6465 5f66 726f  .remove_node_fro
+00008510: 6d5f 696e 6465 7828 6576 656e 742e 6462  m_index(event.db
+00008520: 785f 7061 7468 5f66 726f 6d5f 6c6f 7765  x_path_from_lowe
+00008530: 7229 0a0a 2020 2020 2020 2020 2020 2020  r)..            
+00008540: 2320 4164 6420 6f72 2075 7064 6174 6520  # Add or update 
+00008550: 656e 7472 6965 7320 666f 7220 6372 6561  entries for crea
+00008560: 7465 6420 6f72 206d 6f64 6966 6965 6420  ted or modified 
+00008570: 6974 656d 732e 0a0a 2020 2020 2020 2020  items...        
+00008580: 2020 2020 6966 2065 7665 6e74 2e63 6861      if event.cha
+00008590: 6e67 655f 7479 7065 2069 7320 6e6f 7420  nge_type is not 
+000085a0: 4368 616e 6765 5479 7065 2e52 656d 6f76  ChangeType.Remov
+000085b0: 6564 3a0a 2020 2020 2020 2020 2020 2020  ed:.            
+000085c0: 2020 2020 2320 4372 6561 7465 206f 7220      # Create or 
+000085d0: 7570 6461 7465 2065 6e74 7279 2e0a 2020  update entry..  
+000085e0: 2020 2020 2020 2020 2020 2020 2020 656e                en
+000085f0: 7472 7920 3d20 496e 6465 7845 6e74 7279  try = IndexEntry
+00008600: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00008610: 2020 2020 2020 6462 785f 7061 7468 5f63        dbx_path_c
+00008620: 6173 6564 3d65 7665 6e74 2e64 6278 5f70  ased=event.dbx_p
+00008630: 6174 682c 0a20 2020 2020 2020 2020 2020  ath,.           
+00008640: 2020 2020 2020 2020 2064 6278 5f70 6174           dbx_pat
+00008650: 685f 6c6f 7765 723d 6462 785f 7061 7468  h_lower=dbx_path
+00008660: 5f6c 6f77 6572 2c0a 2020 2020 2020 2020  _lower,.        
+00008670: 2020 2020 2020 2020 2020 2020 6462 785f              dbx_
+00008680: 6964 3d65 7665 6e74 2e64 6278 5f69 642c  id=event.dbx_id,
+00008690: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000086a0: 2020 2020 2069 7465 6d5f 7479 7065 3d65       item_type=e
+000086b0: 7665 6e74 2e69 7465 6d5f 7479 7065 2c0a  vent.item_type,.
+000086c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000086d0: 2020 2020 6c61 7374 5f73 796e 633d 7365      last_sync=se
+000086e0: 6c66 2e5f 6765 745f 6374 696d 6528 6576  lf._get_ctime(ev
+000086f0: 656e 742e 6c6f 6361 6c5f 7061 7468 292c  ent.local_path),
+00008700: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00008710: 2020 2020 2072 6576 3d65 7665 6e74 2e72       rev=event.r
+00008720: 6576 2c0a 2020 2020 2020 2020 2020 2020  ev,.            
+00008730: 2020 2020 2020 2020 636f 6e74 656e 745f          content_
+00008740: 6861 7368 3d65 7665 6e74 2e63 6f6e 7465  hash=event.conte
+00008750: 6e74 5f68 6173 682c 0a20 2020 2020 2020  nt_hash,.       
+00008760: 2020 2020 2020 2020 2020 2020 2073 796d               sym
+00008770: 6c69 6e6b 5f74 6172 6765 743d 6576 656e  link_target=even
+00008780: 742e 7379 6d6c 696e 6b5f 7461 7267 6574  t.symlink_target
+00008790: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+000087a0: 2020 290a 0a20 2020 2020 2020 2020 2020    )..           
+000087b0: 2020 2020 2073 656c 662e 5f69 6e64 6578       self._index
+000087c0: 5f74 6162 6c65 2e75 7064 6174 6528 656e  _table.update(en
+000087d0: 7472 7929 0a0a 2020 2020 6465 6620 7570  try)..    def up
+000087e0: 6461 7465 5f69 6e64 6578 5f66 726f 6d5f  date_index_from_
+000087f0: 6462 785f 6d65 7461 6461 7461 2873 656c  dbx_metadata(sel
+00008800: 662c 206d 643a 204d 6574 6164 6174 6129  f, md: Metadata)
+00008810: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2020   -> None:.      
+00008820: 2020 2222 220a 2020 2020 2020 2020 5570    """.        Up
+00008830: 6461 7465 7320 7468 6520 6c6f 6361 6c20  dates the local 
+00008840: 696e 6465 7820 6672 6f6d 2044 726f 7062  index from Dropb
+00008850: 6f78 206d 6574 6164 6174 612e 0a0a 2020  ox metadata...  
+00008860: 2020 2020 2020 3a70 6172 616d 206d 643a        :param md:
+00008870: 2044 726f 7062 6f78 206d 6574 6164 6174   Dropbox metadat
+00008880: 612e 0a20 2020 2020 2020 2022 2222 0a20  a..        """. 
+00008890: 2020 2020 2020 2077 6974 6820 7365 6c66         with self
+000088a0: 2e5f 6461 7461 6261 7365 5f61 6363 6573  ._database_acces
+000088b0: 7328 293a 0a20 2020 2020 2020 2020 2020  s():.           
+000088c0: 2069 6620 6973 696e 7374 616e 6365 286d   if isinstance(m
+000088d0: 642c 2044 656c 6574 6564 4d65 7461 6461  d, DeletedMetada
+000088e0: 7461 293a 0a20 2020 2020 2020 2020 2020  ta):.           
+000088f0: 2020 2020 2072 6574 7572 6e20 7365 6c66       return self
+00008900: 2e72 656d 6f76 655f 6e6f 6465 5f66 726f  .remove_node_fro
+00008910: 6d5f 696e 6465 7828 6d64 2e70 6174 685f  m_index(md.path_
+00008920: 6c6f 7765 7229 0a0a 2020 2020 2020 2020  lower)..        
+00008930: 2020 2020 6966 2069 7369 6e73 7461 6e63      if isinstanc
+00008940: 6528 6d64 2c20 4669 6c65 4d65 7461 6461  e(md, FileMetada
+00008950: 7461 293a 0a20 2020 2020 2020 2020 2020  ta):.           
+00008960: 2020 2020 2072 6576 203d 206d 642e 7265       rev = md.re
+00008970: 760a 2020 2020 2020 2020 2020 2020 2020  v.              
+00008980: 2020 6861 7368 5f73 7472 203d 206d 642e    hash_str = md.
+00008990: 636f 6e74 656e 745f 6861 7368 0a20 2020  content_hash.   
+000089a0: 2020 2020 2020 2020 2020 2020 2069 7465               ite
+000089b0: 6d5f 7479 7065 203d 2049 7465 6d54 7970  m_type = ItemTyp
+000089c0: 652e 4669 6c65 0a20 2020 2020 2020 2020  e.File.         
+000089d0: 2020 2020 2020 2073 796d 6c69 6e6b 5f74         symlink_t
+000089e0: 6172 6765 7420 3d20 6d64 2e73 796d 6c69  arget = md.symli
+000089f0: 6e6b 5f74 6172 6765 740a 2020 2020 2020  nk_target.      
+00008a00: 2020 2020 2020 2020 2020 6d64 5f69 6420            md_id 
+00008a10: 3d20 6d64 2e69 640a 2020 2020 2020 2020  = md.id.        
+00008a20: 2020 2020 656c 6966 2069 7369 6e73 7461      elif isinsta
+00008a30: 6e63 6528 6d64 2c20 466f 6c64 6572 4d65  nce(md, FolderMe
+00008a40: 7461 6461 7461 293a 0a20 2020 2020 2020  tadata):.       
+00008a50: 2020 2020 2020 2020 2072 6576 203d 2022           rev = "
+00008a60: 666f 6c64 6572 220a 2020 2020 2020 2020  folder".        
+00008a70: 2020 2020 2020 2020 6861 7368 5f73 7472          hash_str
+00008a80: 203d 2022 666f 6c64 6572 220a 2020 2020   = "folder".    
+00008a90: 2020 2020 2020 2020 2020 2020 6974 656d              item
+00008aa0: 5f74 7970 6520 3d20 4974 656d 5479 7065  _type = ItemType
+00008ab0: 2e46 6f6c 6465 720a 2020 2020 2020 2020  .Folder.        
+00008ac0: 2020 2020 2020 2020 7379 6d6c 696e 6b5f          symlink_
+00008ad0: 7461 7267 6574 203d 204e 6f6e 650a 2020  target = None.  
+00008ae0: 2020 2020 2020 2020 2020 2020 2020 6d64                md
+00008af0: 5f69 6420 3d20 6d64 2e69 640a 2020 2020  _id = md.id.    
+00008b00: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+00008b10: 2020 2020 2020 2020 2020 2020 2020 7261                ra
+00008b20: 6973 6520 5275 6e74 696d 6545 7272 6f72  ise RuntimeError
+00008b30: 2866 2255 6e6b 6e6f 776e 206d 6574 6164  (f"Unknown metad
+00008b40: 6174 6120 7479 7065 3a20 7b6d 647d 2229  ata type: {md}")
+00008b50: 0a0a 2020 2020 2020 2020 2020 2020 2320  ..            # 
+00008b60: 436f 6e73 7472 7563 7420 636f 7272 6563  Construct correc
+00008b70: 7420 6469 7370 6c61 7920 7061 7468 2066  t display path f
+00008b80: 726f 6d20 616e 6365 7374 6f72 732e 0a20  rom ancestors.. 
+00008b90: 2020 2020 2020 2020 2020 2064 6278 5f70             dbx_p
+00008ba0: 6174 685f 6361 7365 6420 3d20 7365 6c66  ath_cased = self
+00008bb0: 2e63 6f72 7265 6374 5f63 6173 6528 6d64  .correct_case(md
+00008bc0: 2e70 6174 685f 6469 7370 6c61 7929 0a0a  .path_display)..
+00008bd0: 2020 2020 2020 2020 2020 2020 2320 5570              # Up
+00008be0: 6461 7465 2065 7869 7374 696e 6720 656e  date existing en
+00008bf0: 7472 7920 6f72 2063 7265 6174 6520 6e65  try or create ne
+00008c00: 7720 656e 7472 792e 0a20 2020 2020 2020  w entry..       
+00008c10: 2020 2020 2065 6e74 7279 203d 2049 6e64       entry = Ind
+00008c20: 6578 456e 7472 7928 0a20 2020 2020 2020  exEntry(.       
+00008c30: 2020 2020 2020 2020 2064 6278 5f70 6174           dbx_pat
+00008c40: 685f 6361 7365 643d 6462 785f 7061 7468  h_cased=dbx_path
+00008c50: 5f63 6173 6564 2c0a 2020 2020 2020 2020  _cased,.        
+00008c60: 2020 2020 2020 2020 6462 785f 7061 7468          dbx_path
+00008c70: 5f6c 6f77 6572 3d6d 642e 7061 7468 5f6c  _lower=md.path_l
+00008c80: 6f77 6572 2c0a 2020 2020 2020 2020 2020  ower,.          
+00008c90: 2020 2020 2020 6462 785f 6964 3d6d 645f        dbx_id=md_
+00008ca0: 6964 2c0a 2020 2020 2020 2020 2020 2020  id,.            
+00008cb0: 2020 2020 6974 656d 5f74 7970 653d 6974      item_type=it
+00008cc0: 656d 5f74 7970 652c 0a20 2020 2020 2020  em_type,.       
+00008cd0: 2020 2020 2020 2020 206c 6173 745f 7379           last_sy
+00008ce0: 6e63 3d4e 6f6e 652c 0a20 2020 2020 2020  nc=None,.       
+00008cf0: 2020 2020 2020 2020 2072 6576 3d72 6576           rev=rev
+00008d00: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00008d10: 2020 636f 6e74 656e 745f 6861 7368 3d68    content_hash=h
+00008d20: 6173 685f 7374 722c 0a20 2020 2020 2020  ash_str,.       
+00008d30: 2020 2020 2020 2020 2073 796d 6c69 6e6b           symlink
+00008d40: 5f74 6172 6765 743d 7379 6d6c 696e 6b5f  _target=symlink_
+00008d50: 7461 7267 6574 2c0a 2020 2020 2020 2020  target,.        
+00008d60: 2020 2020 290a 0a20 2020 2020 2020 2020      )..         
+00008d70: 2020 2073 656c 662e 5f69 6e64 6578 5f74     self._index_t
+00008d80: 6162 6c65 2e75 7064 6174 6528 656e 7472  able.update(entr
+00008d90: 7929 0a0a 2020 2020 6465 6620 7265 6d6f  y)..    def remo
+00008da0: 7665 5f6e 6f64 655f 6672 6f6d 5f69 6e64  ve_node_from_ind
+00008db0: 6578 2873 656c 662c 2064 6278 5f70 6174  ex(self, dbx_pat
+00008dc0: 685f 6c6f 7765 723a 2073 7472 2920 2d3e  h_lower: str) ->
+00008dd0: 204e 6f6e 653a 0a20 2020 2020 2020 2022   None:.        "
+00008de0: 2222 0a20 2020 2020 2020 2052 656d 6f76  "".        Remov
+00008df0: 6573 2061 6e79 206c 6f63 616c 2069 6e64  es any local ind
+00008e00: 6578 2065 6e74 7269 6573 2066 6f72 2074  ex entries for t
+00008e10: 6865 2067 6976 656e 2070 6174 6820 616e  he given path an
+00008e20: 6420 616c 6c20 6974 7320 6368 696c 6472  d all its childr
+00008e30: 656e 2e0a 0a20 2020 2020 2020 203a 7061  en...        :pa
+00008e40: 7261 6d20 6462 785f 7061 7468 5f6c 6f77  ram dbx_path_low
+00008e50: 6572 3a20 4e6f 726d 616c 697a 6564 206c  er: Normalized l
+00008e60: 6f77 6572 2063 6173 6520 4472 6f70 626f  ower case Dropbo
+00008e70: 7820 7061 7468 2e0a 2020 2020 2020 2020  x path..        
+00008e80: 2222 220a 2020 2020 2020 2020 7769 7468  """.        with
+00008e90: 2073 656c 662e 5f64 6174 6162 6173 655f   self._database_
+00008ea0: 6163 6365 7373 2829 3a0a 2020 2020 2020  access():.      
+00008eb0: 2020 2020 2020 7175 6572 7920 3d20 5061        query = Pa
+00008ec0: 7468 5472 6565 5175 6572 7928 496e 6465  thTreeQuery(Inde
+00008ed0: 7845 6e74 7279 2e64 6278 5f70 6174 685f  xEntry.dbx_path_
+00008ee0: 6c6f 7765 722c 2064 6278 5f70 6174 685f  lower, dbx_path_
+00008ef0: 6c6f 7765 7229 0a20 2020 2020 2020 2020  lower).         
+00008f00: 2020 2073 656c 662e 5f69 6e64 6578 5f74     self._index_t
+00008f10: 6162 6c65 2e64 656c 6574 6528 7175 6572  able.delete(quer
+00008f20: 7929 0a0a 2020 2020 2320 3d3d 3d3d 2043  y)..    # ==== C
+00008f30: 6f6e 7465 6e74 2068 6173 6869 6e67 203d  ontent hashing =
+00008f40: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00008f50: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00008f60: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00008f70: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 0a0a 2020  ============..  
+00008f80: 2020 6465 6620 6765 745f 6c6f 6361 6c5f    def get_local_
+00008f90: 6861 7368 2873 656c 662c 206c 6f63 616c  hash(self, local
+00008fa0: 5f70 6174 683a 2073 7472 2920 2d3e 2073  _path: str) -> s
+00008fb0: 7472 207c 204e 6f6e 653a 0a20 2020 2020  tr | None:.     
+00008fc0: 2020 2022 2222 0a20 2020 2020 2020 2043     """.        C
+00008fd0: 6f6d 7075 7465 7320 636f 6e74 656e 7420  omputes content 
+00008fe0: 6861 7368 206f 6620 6120 6c6f 6361 6c20  hash of a local 
+00008ff0: 6669 6c65 2e0a 0a20 2020 2020 2020 203a  file...        :
+00009000: 7061 7261 6d20 6c6f 6361 6c5f 7061 7468  param local_path
+00009010: 3a20 4162 736f 6c75 7465 2070 6174 6820  : Absolute path 
+00009020: 6f6e 206c 6f63 616c 2064 7269 7665 2e0a  on local drive..
+00009030: 2020 2020 2020 2020 3a72 6574 7572 6e73          :returns
+00009040: 3a20 436f 6e74 656e 7420 6861 7368 2074  : Content hash t
+00009050: 6f20 636f 6d70 6172 6520 7769 7468 2044  o compare with D
+00009060: 726f 7062 6f78 2773 2063 6f6e 7465 6e74  ropbox's content
+00009070: 2068 6173 682c 206f 7220 2766 6f6c 6465   hash, or 'folde
+00009080: 7227 2069 660a 2020 2020 2020 2020 2020  r' if.          
+00009090: 2020 7468 6520 7061 7468 2070 6f69 6e74    the path point
+000090a0: 7320 746f 2061 2064 6972 6563 746f 7279  s to a directory
+000090b0: 2e20 6060 4e6f 6e65 6060 2069 6620 7468  . ``None`` if th
+000090c0: 6572 6520 6973 206e 6f74 6869 6e67 2061  ere is nothing a
+000090d0: 7420 7468 6520 7061 7468 2e0a 2020 2020  t the path..    
+000090e0: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
+000090f0: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
+00009100: 2073 7461 7420 3d20 6f73 2e6c 7374 6174   stat = os.lstat
+00009110: 286c 6f63 616c 5f70 6174 6829 0a20 2020  (local_path).   
+00009120: 2020 2020 2065 7863 6570 7420 2846 696c       except (Fil
+00009130: 654e 6f74 466f 756e 6445 7272 6f72 2c20  eNotFoundError, 
+00009140: 4e6f 7441 4469 7265 6374 6f72 7945 7272  NotADirectoryErr
+00009150: 6f72 293a 0a20 2020 2020 2020 2020 2020  or):.           
+00009160: 2023 2052 656d 6f76 6520 616c 6c20 6361   # Remove all ca
+00009170: 6368 6520 656e 7472 6965 7320 666f 7220  che entries for 
+00009180: 6c6f 6361 6c5f 7061 7468 2061 6e64 2072  local_path and r
+00009190: 6574 7572 6e20 4e6f 6e65 2e0a 2020 2020  eturn None..    
+000091a0: 2020 2020 2020 2020 7769 7468 2073 656c          with sel
+000091b0: 662e 5f64 6174 6162 6173 655f 6163 6365  f._database_acce
+000091c0: 7373 2829 3a0a 2020 2020 2020 2020 2020  ss():.          
+000091d0: 2020 2020 2020 7175 6572 7920 3d20 4d61        query = Ma
+000091e0: 7463 6851 7565 7279 2848 6173 6843 6163  tchQuery(HashCac
+000091f0: 6865 456e 7472 792e 6c6f 6361 6c5f 7061  heEntry.local_pa
+00009200: 7468 2c20 6c6f 6361 6c5f 7061 7468 290a  th, local_path).
+00009210: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009220: 7365 6c66 2e5f 6861 7368 5f74 6162 6c65  self._hash_table
+00009230: 2e64 656c 6574 6528 7175 6572 7929 0a20  .delete(query). 
+00009240: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+00009250: 6e20 4e6f 6e65 0a20 2020 2020 2020 2065  n None.        e
+00009260: 7863 6570 7420 4f53 4572 726f 7220 6173  xcept OSError as
+00009270: 2065 7272 3a0a 2020 2020 2020 2020 2020   err:.          
+00009280: 2020 6966 2065 7272 2e65 7272 6e6f 203d    if err.errno =
+00009290: 3d20 6572 726e 6f2e 454e 414d 4554 4f4f  = errno.ENAMETOO
+000092a0: 4c4f 4e47 3a0a 2020 2020 2020 2020 2020  LONG:.          
+000092b0: 2020 2020 2020 7265 7475 726e 204e 6f6e        return Non
+000092c0: 650a 2020 2020 2020 2020 2020 2020 7261  e.            ra
+000092d0: 6973 6520 6f73 5f74 6f5f 6d61 6573 7472  ise os_to_maestr
+000092e0: 616c 5f65 7272 6f72 2865 7272 290a 0a20  al_error(err).. 
+000092f0: 2020 2020 2020 2069 6620 535f 4953 4449         if S_ISDI
+00009300: 5228 7374 6174 2e73 745f 6d6f 6465 293a  R(stat.st_mode):
+00009310: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+00009320: 7572 6e20 2266 6f6c 6465 7222 0a0a 2020  urn "folder"..  
+00009330: 2020 2020 2020 6d74 696d 653a 2066 6c6f        mtime: flo
+00009340: 6174 207c 204e 6f6e 6520 3d20 7374 6174  at | None = stat
+00009350: 2e73 745f 6d74 696d 650a 0a20 2020 2020  .st_mtime..     
+00009360: 2020 2077 6974 6820 7365 6c66 2e5f 6461     with self._da
+00009370: 7461 6261 7365 5f61 6363 6573 7328 293a  tabase_access():
+00009380: 0a20 2020 2020 2020 2020 2020 2023 2043  .            # C
+00009390: 6865 636b 2063 6163 6865 2066 6f72 2061  heck cache for a
+000093a0: 6e20 7570 2d74 6f2d 6461 7465 2063 6f6e  n up-to-date con
+000093b0: 7465 6e74 2068 6173 6820 616e 6420 7265  tent hash and re
+000093c0: 7475 726e 2069 6620 6974 2065 7869 7374  turn if it exist
+000093d0: 732e 0a20 2020 2020 2020 2020 2020 2063  s..            c
+000093e0: 6163 6865 5f65 6e74 7279 203d 2073 656c  ache_entry = sel
+000093f0: 662e 5f68 6173 685f 7461 626c 652e 6765  f._hash_table.ge
+00009400: 7428 7374 6174 2e73 745f 696e 6f29 0a0a  t(stat.st_ino)..
+00009410: 2020 2020 2020 2020 2020 2020 6966 2063              if c
+00009420: 6163 6865 5f65 6e74 7279 2061 6e64 2063  ache_entry and c
+00009430: 6163 6865 5f65 6e74 7279 2e6d 7469 6d65  ache_entry.mtime
+00009440: 203d 3d20 6d74 696d 653a 0a20 2020 2020   == mtime:.     
+00009450: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+00009460: 6e20 6361 6368 655f 656e 7472 792e 6861  n cache_entry.ha
+00009470: 7368 5f73 7472 0a0a 2020 2020 2020 2020  sh_str..        
+00009480: 7769 7468 2063 6f6e 7665 7274 5f61 7069  with convert_api
+00009490: 5f65 7272 6f72 7328 6c6f 6361 6c5f 7061  _errors(local_pa
+000094a0: 7468 3d6c 6f63 616c 5f70 6174 6829 3a0a  th=local_path):.
+000094b0: 2020 2020 2020 2020 2020 2020 6861 7368              hash
+000094c0: 5f73 7472 2c20 6d74 696d 6520 3d20 636f  _str, mtime = co
+000094d0: 6e74 656e 745f 6861 7368 286c 6f63 616c  ntent_hash(local
+000094e0: 5f70 6174 6829 0a0a 2020 2020 2020 2020  _path)..        
+000094f0: 7365 6c66 2e5f 7361 7665 5f6c 6f63 616c  self._save_local
+00009500: 5f68 6173 6828 7374 6174 2e73 745f 696e  _hash(stat.st_in
+00009510: 6f2c 206c 6f63 616c 5f70 6174 682c 2068  o, local_path, h
+00009520: 6173 685f 7374 722c 206d 7469 6d65 290a  ash_str, mtime).
+00009530: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+00009540: 6861 7368 5f73 7472 0a0a 2020 2020 6465  hash_str..    de
+00009550: 6620 5f73 6176 655f 6c6f 6361 6c5f 6861  f _save_local_ha
+00009560: 7368 280a 2020 2020 2020 2020 7365 6c66  sh(.        self
+00009570: 2c0a 2020 2020 2020 2020 696e 6f64 653a  ,.        inode:
+00009580: 2069 6e74 2c0a 2020 2020 2020 2020 6c6f   int,.        lo
+00009590: 6361 6c5f 7061 7468 3a20 7374 722c 0a20  cal_path: str,. 
+000095a0: 2020 2020 2020 2068 6173 685f 7374 723a         hash_str:
+000095b0: 2073 7472 207c 204e 6f6e 652c 0a20 2020   str | None,.   
+000095c0: 2020 2020 206d 7469 6d65 3a20 666c 6f61       mtime: floa
+000095d0: 7420 7c20 4e6f 6e65 2c0a 2020 2020 2920  t | None,.    ) 
+000095e0: 2d3e 204e 6f6e 653a 0a20 2020 2020 2020  -> None:.       
+000095f0: 2022 2222 0a20 2020 2020 2020 2053 6176   """.        Sav
+00009600: 6520 7468 6520 636f 6e74 656e 7420 6861  e the content ha
+00009610: 7368 2066 6f72 2061 2066 696c 6520 696e  sh for a file in
+00009620: 206f 7572 2063 6163 6865 2e0a 0a20 2020   our cache...   
+00009630: 2020 2020 203a 7061 7261 6d20 696e 6f64       :param inod
+00009640: 653a 2049 6e6f 6465 206f 6620 7468 6520  e: Inode of the 
+00009650: 6669 6c65 2e0a 2020 2020 2020 2020 3a70  file..        :p
+00009660: 6172 616d 206c 6f63 616c 5f70 6174 683a  aram local_path:
+00009670: 2041 6273 6f6c 7574 6520 7061 7468 206f   Absolute path o
+00009680: 6e20 6c6f 6361 6c20 6472 6976 652e 0a20  n local drive.. 
+00009690: 2020 2020 2020 203a 7061 7261 6d20 6861         :param ha
+000096a0: 7368 5f73 7472 3a20 4861 7368 2073 7472  sh_str: Hash str
+000096b0: 696e 6720 746f 2073 6176 652e 2049 6620  ing to save. If 
+000096c0: 4e6f 6e65 2c20 7468 6520 6578 6973 7469  None, the existi
+000096d0: 6e67 2063 6163 6865 2065 6e74 7279 2077  ng cache entry w
+000096e0: 696c 6c20 6265 0a20 2020 2020 2020 2020  ill be.         
+000096f0: 2020 2064 656c 6574 6564 2e0a 2020 2020     deleted..    
+00009700: 2020 2020 3a70 6172 616d 206d 7469 6d65      :param mtime
+00009710: 3a20 4d74 696d 6520 6f66 2074 6865 2066  : Mtime of the f
+00009720: 696c 6520 7768 656e 2074 6865 2068 6173  ile when the has
+00009730: 6820 7761 7320 636f 6d70 7574 6564 2e0a  h was computed..
+00009740: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
+00009750: 2020 2020 7769 7468 2073 656c 662e 5f64      with self._d
+00009760: 6174 6162 6173 655f 6163 6365 7373 2829  atabase_access()
+00009770: 3a0a 2020 2020 2020 2020 2020 2020 6966  :.            if
+00009780: 2068 6173 685f 7374 723a 0a20 2020 2020   hash_str:.     
+00009790: 2020 2020 2020 2020 2020 2063 6163 6865             cache
+000097a0: 5f65 6e74 7279 203d 2048 6173 6843 6163  _entry = HashCac
+000097b0: 6865 456e 7472 7928 0a20 2020 2020 2020  heEntry(.       
+000097c0: 2020 2020 2020 2020 2020 2020 2069 6e6f               ino
+000097d0: 6465 3d69 6e6f 6465 2c0a 2020 2020 2020  de=inode,.      
+000097e0: 2020 2020 2020 2020 2020 2020 2020 6c6f                lo
+000097f0: 6361 6c5f 7061 7468 3d6c 6f63 616c 5f70  cal_path=local_p
+00009800: 6174 682c 0a20 2020 2020 2020 2020 2020  ath,.           
+00009810: 2020 2020 2020 2020 2068 6173 685f 7374           hash_st
+00009820: 723d 6861 7368 5f73 7472 2c0a 2020 2020  r=hash_str,.    
+00009830: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009840: 6d74 696d 653d 6d74 696d 652c 0a20 2020  mtime=mtime,.   
+00009850: 2020 2020 2020 2020 2020 2020 2029 0a20               ). 
+00009860: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00009870: 656c 662e 5f68 6173 685f 7461 626c 652e  elf._hash_table.
+00009880: 7570 6461 7465 2863 6163 6865 5f65 6e74  update(cache_ent
+00009890: 7279 290a 0a20 2020 2020 2020 2020 2020  ry)..           
+000098a0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+000098b0: 2020 2020 2020 2073 656c 662e 5f68 6173         self._has
+000098c0: 685f 7461 626c 652e 6465 6c65 7465 5f70  h_table.delete_p
+000098d0: 7269 6d61 7279 5f6b 6579 2869 6e6f 6465  rimary_key(inode
+000098e0: 290a 0a20 2020 2023 203d 3d3d 3d20 4d69  )..    # ==== Mi
+000098f0: 676e 6f72 6520 6d61 6e61 6765 6d65 6e74  gnore management
+00009900: 203d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d   ===============
+00009910: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00009920: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00009930: 3d3d 3d3d 3d3d 3d3d 3d3d 3d0a 0a20 2020  ===========..   
+00009940: 2040 7072 6f70 6572 7479 0a20 2020 2064   @property.    d
+00009950: 6566 206d 6967 6e6f 7265 5f70 6174 6828  ef mignore_path(
+00009960: 7365 6c66 2920 2d3e 2073 7472 3a0a 2020  self) -> str:.  
+00009970: 2020 2020 2020 2222 2250 6174 6820 746f        """Path to
+00009980: 206d 6967 6e6f 7265 2066 696c 6520 6f6e   mignore file on
+00009990: 206c 6f63 616c 2064 7269 7665 2028 7265   local drive (re
+000099a0: 6164 206f 6e6c 7929 2e22 2222 0a20 2020  ad only).""".   
+000099b0: 2020 2020 2072 6574 7572 6e20 7365 6c66       return self
+000099c0: 2e5f 6d69 676e 6f72 655f 7061 7468 0a0a  ._mignore_path..
+000099d0: 2020 2020 4070 726f 7065 7274 790a 2020      @property.  
+000099e0: 2020 6465 6620 6d69 676e 6f72 655f 7275    def mignore_ru
+000099f0: 6c65 7328 7365 6c66 2920 2d3e 2050 6174  les(self) -> Pat
+00009a00: 6853 7065 633a 0a20 2020 2020 2020 2022  hSpec:.        "
+00009a10: 2222 4c69 7374 206f 6620 6d69 676e 6f72  ""List of mignor
+00009a20: 6520 7275 6c65 7320 666f 6c6c 6f77 696e  e rules followin
+00009a30: 6720 6769 7420 7769 6c64 6d61 7463 6820  g git wildmatch 
+00009a40: 7379 6e74 6178 2028 7265 6164 206f 6e6c  syntax (read onl
+00009a50: 7929 2e22 2222 0a20 2020 2020 2020 2072  y).""".        r
+00009a60: 6574 7572 6e20 7365 6c66 2e5f 6d69 676e  eturn self._mign
+00009a70: 6f72 655f 7275 6c65 730a 0a20 2020 2064  ore_rules..    d
+00009a80: 6566 206c 6f61 645f 6d69 676e 6f72 655f  ef load_mignore_
+00009a90: 6669 6c65 2873 656c 6629 202d 3e20 4e6f  file(self) -> No
+00009aa0: 6e65 3a0a 2020 2020 2020 2020 2222 220a  ne:.        """.
+00009ab0: 2020 2020 2020 2020 4c6f 6164 7320 7275          Loads ru
+00009ac0: 6c65 7320 6672 6f6d 206d 6967 6e6f 7265  les from mignore
+00009ad0: 2066 696c 652e 204e 6f20 7275 6c65 7320   file. No rules 
+00009ae0: 6172 6520 6c6f 6164 6564 2069 6620 7468  are loaded if th
+00009af0: 6520 6669 6c65 2064 6f65 730a 2020 2020  e file does.    
+00009b00: 2020 2020 6e6f 7420 6578 6973 7420 6f72      not exist or
+00009b10: 2063 616e 6e6f 7420 6265 2072 6561 642e   cannot be read.
+00009b20: 0a0a 2020 2020 2020 2020 3a72 6574 7572  ..        :retur
+00009b30: 6e73 3a20 5061 7468 5370 6563 2069 6e73  ns: PathSpec ins
+00009b40: 7461 6e63 6520 7769 7468 2069 676e 6f72  tance with ignor
+00009b50: 6520 7061 7474 6572 6e73 2e0a 2020 2020  e patterns..    
+00009b60: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
+00009b70: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
+00009b80: 2077 6974 6820 6f70 656e 2873 656c 662e   with open(self.
+00009b90: 6d69 676e 6f72 655f 7061 7468 2920 6173  mignore_path) as
+00009ba0: 2066 3a0a 2020 2020 2020 2020 2020 2020   f:.            
+00009bb0: 2020 2020 7370 6563 203d 2066 2e72 6561      spec = f.rea
+00009bc0: 6428 290a 2020 2020 2020 2020 6578 6365  d().        exce
+00009bd0: 7074 204f 5345 7272 6f72 2061 7320 6572  pt OSError as er
+00009be0: 723a 0a20 2020 2020 2020 2020 2020 2073  r:.            s
+00009bf0: 656c 662e 5f6c 6f67 6765 722e 6465 6275  elf._logger.debu
+00009c00: 6728 2243 6f75 6c64 206e 6f74 206c 6f61  g("Could not loa
+00009c10: 6420 6d69 676e 6f72 6520 7275 6c65 733a  d mignore rules:
+00009c20: 2025 7322 2c20 6572 722e 7374 7265 7272   %s", err.strerr
+00009c30: 6f72 290a 2020 2020 2020 2020 2020 2020  or).            
+00009c40: 7370 6563 203d 2022 220a 0a20 2020 2020  spec = ""..     
+00009c50: 2020 2073 656c 662e 5f6d 6967 6e6f 7265     self._mignore
+00009c60: 5f72 756c 6573 203d 2050 6174 6853 7065  _rules = PathSpe
+00009c70: 632e 6672 6f6d 5f6c 696e 6573 2822 6769  c.from_lines("gi
+00009c80: 7477 696c 646d 6174 6368 222c 2073 7065  twildmatch", spe
+00009c90: 632e 7370 6c69 746c 696e 6573 2829 290a  c.splitlines()).
+00009ca0: 0a20 2020 2023 203d 3d3d 3d20 4865 6c70  .    # ==== Help
+00009cb0: 6572 2066 756e 6374 696f 6e73 203d 3d3d  er functions ===
+00009cc0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00009cd0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00009ce0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00009cf0: 3d3d 3d3d 3d3d 3d3d 3d0a 0a20 2020 2064  =========..    d
+00009d00: 6566 2065 6e73 7572 655f 6472 6f70 626f  ef ensure_dropbo
+00009d10: 785f 666f 6c64 6572 5f70 7265 7365 6e74  x_folder_present
+00009d20: 2873 656c 6629 202d 3e20 4e6f 6e65 3a0a  (self) -> None:.
+00009d30: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
+00009d40: 2020 2020 4368 6563 6b73 2069 6620 7468      Checks if th
+00009d50: 6520 4472 6f70 626f 7820 666f 6c64 6572  e Dropbox folder
+00009d60: 2073 7469 6c6c 2065 7869 7374 7320 7768   still exists wh
+00009d70: 6572 6520 7765 2065 7870 6563 7420 6974  ere we expect it
+00009d80: 2074 6f20 6265 2e0a 0a20 2020 2020 2020   to be...       
+00009d90: 203a 7261 6973 6573 204e 6f44 726f 7062   :raises NoDropb
+00009da0: 6f78 4469 7245 7272 6f72 3a20 5768 656e  oxDirError: When
+00009db0: 206c 6f63 616c 2044 726f 7062 6f78 2064   local Dropbox d
+00009dc0: 6972 6563 746f 7279 2064 6f65 7320 6e6f  irectory does no
+00009dd0: 7420 6578 6973 742e 0a20 2020 2020 2020  t exist..       
+00009de0: 2022 2222 0a20 2020 2020 2020 2065 7863   """.        exc
+00009df0: 6570 7469 6f6e 203d 204e 6f44 726f 7062  eption = NoDropb
+00009e00: 6f78 4469 7245 7272 6f72 280a 2020 2020  oxDirError(.    
+00009e10: 2020 2020 2020 2020 2244 726f 7062 6f78          "Dropbox
+00009e20: 2066 6f6c 6465 7220 6d69 7373 696e 6722   folder missing"
+00009e30: 2c0a 2020 2020 2020 2020 2020 2020 2250  ,.            "P
+00009e40: 6c65 6173 6520 6d6f 7665 2074 6865 2044  lease move the D
+00009e50: 726f 7062 6f78 2066 6f6c 6465 7220 6261  ropbox folder ba
+00009e60: 636b 2074 6f20 6974 7320 6f72 6967 696e  ck to its origin
+00009e70: 616c 206c 6f63 6174 696f 6e20 220a 2020  al location ".  
+00009e80: 2020 2020 2020 2020 2020 226f 7220 7265            "or re
+00009e90: 7374 6172 7420 4d61 6573 7472 616c 2074  start Maestral t
+00009ea0: 6f20 7365 7420 7570 2061 206e 6577 2066  o set up a new f
+00009eb0: 6f6c 6465 722e 222c 0a20 2020 2020 2020  older.",.       
+00009ec0: 2029 0a0a 2020 2020 2020 2020 6966 206e   )..        if n
+00009ed0: 6f74 2069 7364 6972 2873 656c 662e 6472  ot isdir(self.dr
+00009ee0: 6f70 626f 785f 7061 7468 293a 0a20 2020  opbox_path):.   
+00009ef0: 2020 2020 2020 2020 2072 6169 7365 2065           raise e
+00009f00: 7863 6570 7469 6f6e 0a0a 2020 2020 2020  xception..      
+00009f10: 2020 2320 4966 2074 6865 2066 696c 6520    # If the file 
+00009f20: 7379 7374 656d 2069 7320 6e6f 7420 6361  system is not ca
+00009f30: 7365 2d73 656e 7369 7469 7665 2062 7574  se-sensitive but
+00009f40: 2070 7265 7365 7276 696e 672c 2061 2070   preserving, a p
+00009f50: 6174 6820 7768 6963 6820 7761 730a 2020  ath which was.  
+00009f60: 2020 2020 2020 2320 7265 6e61 6d65 6420        # renamed 
+00009f70: 7769 7468 2061 2063 6173 6520 6368 616e  with a case chan
+00009f80: 6765 206f 6e6c 7920 7769 6c6c 2073 7469  ge only will sti
+00009f90: 6c6c 2065 7869 7374 2061 7420 7468 6520  ll exist at the 
+00009fa0: 6f6c 6420 6c6f 6361 7469 6f6e 2e20 5765  old location. We
+00009fb0: 0a20 2020 2020 2020 2023 2074 6865 7265  .        # there
+00009fc0: 666f 7265 2065 7870 6c69 6369 746c 7920  fore explicitly 
+00009fd0: 6368 6563 6b20 666f 7220 6361 7365 2063  check for case c
+00009fe0: 6861 6e67 6573 2068 6572 652e 0a20 2020  hanges here..   
+00009ff0: 2020 2020 2069 6620 6e6f 7420 7365 6c66       if not self
+0000a000: 2e69 735f 6673 5f63 6173 655f 7365 6e73  .is_fs_case_sens
+0000a010: 6974 6976 653a 0a20 2020 2020 2020 2020  itive:.         
+0000a020: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
+0000a030: 2020 2020 2020 2020 6361 7365 645f 7061          cased_pa
+0000a040: 7468 203d 2074 6f5f 6578 6973 7469 6e67  th = to_existing
+0000a050: 5f75 6e6e 6f72 6d61 6c69 7a65 645f 7061  _unnormalized_pa
+0000a060: 7468 2873 656c 662e 6472 6f70 626f 785f  th(self.dropbox_
+0000a070: 7061 7468 290a 2020 2020 2020 2020 2020  path).          
+0000a080: 2020 6578 6365 7074 2028 4669 6c65 4e6f    except (FileNo
+0000a090: 7446 6f75 6e64 4572 726f 722c 204e 6f74  tFoundError, Not
+0000a0a0: 4144 6972 6563 746f 7279 4572 726f 7229  ADirectoryError)
+0000a0b0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0000a0c0: 2020 7261 6973 6520 6578 6365 7074 696f    raise exceptio
+0000a0d0: 6e0a 0a20 2020 2020 2020 2020 2020 2069  n..            i
+0000a0e0: 6620 6361 7365 645f 7061 7468 2021 3d20  f cased_path != 
+0000a0f0: 7365 6c66 2e64 726f 7062 6f78 5f70 6174  self.dropbox_pat
+0000a100: 683a 0a20 2020 2020 2020 2020 2020 2020  h:.             
+0000a110: 2020 2074 6974 6c65 203d 2022 4472 6f70     title = "Drop
+0000a120: 626f 7820 666f 6c64 6572 2072 656e 616d  box folder renam
+0000a130: 6564 220a 2020 2020 2020 2020 2020 2020  ed".            
+0000a140: 2020 2020 6d73 6720 3d20 280a 2020 2020      msg = (.    
+0000a150: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a160: 2250 6c65 6173 6520 6d6f 7665 2074 6865  "Please move the
+0000a170: 2044 726f 7062 6f78 2066 6f6c 6465 7220   Dropbox folder 
+0000a180: 6261 636b 2074 6f20 6974 7320 6f72 6967  back to its orig
+0000a190: 696e 616c 206c 6f63 6174 696f 6e20 220a  inal location ".
+0000a1a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a1b0: 2020 2020 226f 7220 7265 7374 6172 7420      "or restart 
+0000a1c0: 4d61 6573 7472 616c 2074 6f20 7365 7420  Maestral to set 
+0000a1d0: 7570 2061 206e 6577 2066 6f6c 6465 722e  up a new folder.
+0000a1e0: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
+0000a1f0: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
+0000a200: 2020 2020 7261 6973 6520 4e6f 4472 6f70      raise NoDrop
+0000a210: 626f 7844 6972 4572 726f 7228 7469 746c  boxDirError(titl
+0000a220: 652c 206d 7367 290a 0a20 2020 2064 6566  e, msg)..    def
+0000a230: 2065 6e73 7572 655f 6361 6368 655f 6469   ensure_cache_di
+0000a240: 725f 7072 6573 656e 7428 7365 6c66 2920  r_present(self) 
+0000a250: 2d3e 204e 6f6e 653a 0a20 2020 2020 2020  -> None:.       
+0000a260: 2022 2222 0a20 2020 2020 2020 2043 6865   """.        Che
+0000a270: 636b 7320 666f 7220 6f72 2063 7265 6174  cks for or creat
+0000a280: 6573 2061 2064 6972 6563 746f 7279 2061  es a directory a
+0000a290: 7420 3a61 7474 723a 6066 696c 655f 6361  t :attr:`file_ca
+0000a2a0: 6368 655f 7061 7468 602e 0a0a 2020 2020  che_path`...    
+0000a2b0: 2020 2020 3a72 6169 7365 7320 4361 6368      :raises Cach
+0000a2c0: 6544 6972 4572 726f 723a 2057 6865 6e20  eDirError: When 
+0000a2d0: 6c6f 6361 6c20 6361 6368 6520 6469 7265  local cache dire
+0000a2e0: 6374 6f72 7920 6361 6e6e 6f74 2062 6520  ctory cannot be 
+0000a2f0: 6372 6561 7465 642e 0a20 2020 2020 2020  created..       
+0000a300: 2022 2222 0a20 2020 2020 2020 2072 6574   """.        ret
+0000a310: 7269 6573 203d 2030 0a20 2020 2020 2020  ries = 0.       
+0000a320: 206d 6178 5f72 6574 7269 6573 203d 2031   max_retries = 1
+0000a330: 300a 0a20 2020 2020 2020 2077 6869 6c65  0..        while
+0000a340: 206e 6f74 2069 7364 6972 2873 656c 662e   not isdir(self.
+0000a350: 6669 6c65 5f63 6163 6865 5f70 6174 6829  file_cache_path)
+0000a360: 3a0a 2020 2020 2020 2020 2020 2020 7472  :.            tr
+0000a370: 793a 0a20 2020 2020 2020 2020 2020 2020  y:.             
+0000a380: 2020 2023 2054 6869 7320 7769 6c6c 2072     # This will r
+0000a390: 6169 7365 2046 696c 6545 7869 7374 7345  aise FileExistsE
+0000a3a0: 7272 6f72 2069 6620 6669 6c65 5f63 6163  rror if file_cac
+0000a3b0: 6865 5f70 6174 680a 2020 2020 2020 2020  he_path.        
+0000a3c0: 2020 2020 2020 2020 2320 6578 6973 7473          # exists
+0000a3d0: 2062 7574 2069 7320 6120 6669 6c65 2069   but is a file i
+0000a3e0: 6e73 7465 6164 206f 6620 6120 6469 7265  nstead of a dire
+0000a3f0: 6374 6f72 792e 0a20 2020 2020 2020 2020  ctory..         
+0000a400: 2020 2020 2020 206f 732e 6d61 6b65 6469         os.makedi
+0000a410: 7273 2873 656c 662e 6669 6c65 5f63 6163  rs(self.file_cac
+0000a420: 6865 5f70 6174 682c 2065 7869 7374 5f6f  he_path, exist_o
+0000a430: 6b3d 5472 7565 290a 2020 2020 2020 2020  k=True).        
+0000a440: 2020 2020 2020 2020 7265 7475 726e 0a20          return. 
+0000a450: 2020 2020 2020 2020 2020 2065 7863 6570             excep
+0000a460: 7420 4669 6c65 4578 6973 7473 4572 726f  t FileExistsErro
+0000a470: 723a 0a20 2020 2020 2020 2020 2020 2020  r:.             
+0000a480: 2020 2023 2052 656d 6f76 6520 7468 6520     # Remove the 
+0000a490: 6669 6c65 2074 6861 7427 7320 696e 206f  file that's in o
+0000a4a0: 7572 2077 6179 2c20 7265 7472 7920 6372  ur way, retry cr
+0000a4b0: 6561 7469 6f6e 2e0a 2020 2020 2020 2020  eation..        
+0000a4c0: 2020 2020 2020 2020 7365 6c66 2e63 6c65          self.cle
+0000a4d0: 616e 5f63 6163 6865 5f64 6972 2829 0a20  an_cache_dir(). 
+0000a4e0: 2020 2020 2020 2020 2020 2065 7863 6570             excep
+0000a4f0: 7420 4e6f 7441 4469 7265 6374 6f72 7945  t NotADirectoryE
+0000a500: 7272 6f72 3a0a 2020 2020 2020 2020 2020  rror:.          
+0000a510: 2020 2020 2020 2320 456e 7375 7265 2074        # Ensure t
+0000a520: 6861 7420 7061 7265 6e74 2064 6972 6563  hat parent direc
+0000a530: 746f 7269 6573 2065 7869 7374 2061 7320  tories exist as 
+0000a540: 6578 7065 6374 6564 2e0a 2020 2020 2020  expected..      
+0000a550: 2020 2020 2020 2020 2020 7365 6c66 2e65            self.e
+0000a560: 6e73 7572 655f 6472 6f70 626f 785f 666f  nsure_dropbox_fo
+0000a570: 6c64 6572 5f70 7265 7365 6e74 2829 0a20  lder_present(). 
+0000a580: 2020 2020 2020 2020 2020 2065 7863 6570             excep
+0000a590: 7420 4f53 4572 726f 7220 6173 2065 7272  t OSError as err
+0000a5a0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0000a5b0: 2020 7261 6973 6520 4361 6368 6544 6972    raise CacheDir
+0000a5c0: 4572 726f 7228 0a20 2020 2020 2020 2020  Error(.         
+0000a5d0: 2020 2020 2020 2020 2020 2066 2243 616e             f"Can
+0000a5e0: 6e6f 7420 6372 6561 7465 2063 6163 6865  not create cache
+0000a5f0: 2064 6972 6563 746f 7279 3a20 7b65 7272   directory: {err
+0000a600: 2e73 7472 6572 726f 727d 222c 0a20 2020  .strerror}",.   
+0000a610: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a620: 2022 506c 6561 7365 2063 6865 636b 2069   "Please check i
+0000a630: 6620 796f 7520 6861 7665 2077 7269 7465  f you have write
+0000a640: 2070 6572 6d69 7373 696f 6e73 2066 6f72   permissions for
+0000a650: 2022 0a20 2020 2020 2020 2020 2020 2020   ".             
+0000a660: 2020 2020 2020 2066 227b 7365 6c66 2e5f         f"{self._
+0000a670: 6669 6c65 5f63 6163 6865 5f70 6174 687d  file_cache_path}
+0000a680: 2e22 2c0a 2020 2020 2020 2020 2020 2020  .",.            
+0000a690: 2020 2020 290a 0a20 2020 2020 2020 2020      )..         
+0000a6a0: 2020 2069 6620 7265 7472 6965 7320 3e20     if retries > 
+0000a6b0: 6d61 785f 7265 7472 6965 733a 0a20 2020  max_retries:.   
+0000a6c0: 2020 2020 2020 2020 2020 2020 2072 6169               rai
+0000a6d0: 7365 2043 6163 6865 4469 7245 7272 6f72  se CacheDirError
+0000a6e0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+0000a6f0: 2020 2020 2020 2243 616e 6e6f 7420 6372        "Cannot cr
+0000a700: 6561 7465 2063 6163 6865 2064 6972 6563  eate cache direc
+0000a710: 746f 7279 222c 0a20 2020 2020 2020 2020  tory",.         
+0000a720: 2020 2020 2020 2020 2020 2022 4578 6365             "Exce
+0000a730: 6564 6564 206d 6178 696d 756d 206e 756d  eded maximum num
+0000a740: 6265 7220 6f66 2072 6574 7269 6573 222c  ber of retries",
+0000a750: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000a760: 2029 0a0a 2020 2020 2020 2020 2020 2020   )..            
+0000a770: 7469 6d65 2e73 6c65 6570 2830 2e30 3129  time.sleep(0.01)
+0000a780: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+0000a790: 7269 6573 202b 3d20 310a 0a20 2020 2064  ries += 1..    d
+0000a7a0: 6566 2063 6c65 616e 5f63 6163 6865 5f64  ef clean_cache_d
+0000a7b0: 6972 2873 656c 662c 2072 6169 7365 5f65  ir(self, raise_e
+0000a7c0: 7272 6f72 3a20 626f 6f6c 203d 2054 7275  rror: bool = Tru
+0000a7d0: 6529 202d 3e20 4e6f 6e65 3a0a 2020 2020  e) -> None:.    
+0000a7e0: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
+0000a7f0: 5265 6d6f 7665 7320 616c 6c20 6974 656d  Removes all item
+0000a800: 7320 696e 2074 6865 2063 6163 6865 2064  s in the cache d
+0000a810: 6972 6563 746f 7279 2e0a 0a20 2020 2020  irectory...     
+0000a820: 2020 203a 7061 7261 6d20 7261 6973 655f     :param raise_
+0000a830: 6572 726f 723a 2057 6865 7468 6572 2065  error: Whether e
+0000a840: 7272 6f72 7320 7368 6f75 6c64 2062 6520  rrors should be 
+0000a850: 7261 6973 6564 206f 7220 6f6e 6c79 206c  raised or only l
+0000a860: 6f67 6765 642e 0a20 2020 2020 2020 2022  ogged..        "
+0000a870: 2222 0a20 2020 2020 2020 2077 6974 6820  "".        with 
+0000a880: 7365 6c66 2e73 796e 635f 6c6f 636b 3a0a  self.sync_lock:.
+0000a890: 2020 2020 2020 2020 2020 2020 7472 793a              try:
+0000a8a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000a8b0: 2064 656c 6574 6528 7365 6c66 2e5f 6669   delete(self._fi
+0000a8c0: 6c65 5f63 6163 6865 5f70 6174 682c 2072  le_cache_path, r
+0000a8d0: 6169 7365 5f65 7272 6f72 3d54 7275 6529  aise_error=True)
+0000a8e0: 0a20 2020 2020 2020 2020 2020 2065 7863  .            exc
+0000a8f0: 6570 7420 2846 696c 654e 6f74 466f 756e  ept (FileNotFoun
+0000a900: 6445 7272 6f72 2c20 4973 4144 6972 6563  dError, IsADirec
+0000a910: 746f 7279 4572 726f 7229 3a0a 2020 2020  toryError):.    
+0000a920: 2020 2020 2020 2020 2020 2020 7061 7373              pass
+0000a930: 0a20 2020 2020 2020 2020 2020 2065 7863  .            exc
+0000a940: 6570 7420 4f53 4572 726f 7220 6173 2065  ept OSError as e
+0000a950: 7272 3a0a 2020 2020 2020 2020 2020 2020  rr:.            
+0000a960: 2020 2020 6578 6320 3d20 4361 6368 6544      exc = CacheD
+0000a970: 6972 4572 726f 7228 0a20 2020 2020 2020  irError(.       
+0000a980: 2020 2020 2020 2020 2020 2020 2066 2243               f"C
+0000a990: 616e 6e6f 7420 6372 6561 7465 2063 6163  annot create cac
+0000a9a0: 6865 2064 6972 6563 746f 7279 3a20 7b65  he directory: {e
+0000a9b0: 7272 2e73 7472 6572 726f 727d 222c 0a20  rr.strerror}",. 
+0000a9c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a9d0: 2020 2022 506c 6561 7365 2063 6865 636b     "Please check
+0000a9e0: 2069 6620 796f 7520 6861 7665 2077 7269   if you have wri
+0000a9f0: 7465 2070 6572 6d69 7373 696f 6e73 2066  te permissions f
+0000aa00: 6f72 2022 0a20 2020 2020 2020 2020 2020  or ".           
+0000aa10: 2020 2020 2020 2020 2066 227b 7365 6c66           f"{self
+0000aa20: 2e5f 6669 6c65 5f63 6163 6865 5f70 6174  ._file_cache_pat
+0000aa30: 687d 2e22 2c0a 2020 2020 2020 2020 2020  h}.",.          
+0000aa40: 2020 2020 2020 290a 0a20 2020 2020 2020        )..       
+0000aa50: 2020 2020 2020 2020 2069 6620 7261 6973           if rais
+0000aa60: 655f 6572 726f 723a 0a20 2020 2020 2020  e_error:.       
+0000aa70: 2020 2020 2020 2020 2020 2020 2072 6169               rai
+0000aa80: 7365 2065 7863 0a0a 2020 2020 2020 2020  se exc..        
+0000aa90: 2020 2020 2020 2020 7365 6c66 2e5f 6c6f          self._lo
+0000aaa0: 6767 6572 2e65 7272 6f72 2865 7863 2e74  gger.error(exc.t
+0000aab0: 6974 6c65 2c20 6578 635f 696e 666f 3d65  itle, exc_info=e
+0000aac0: 7863 5f69 6e66 6f5f 7475 706c 6528 6578  xc_info_tuple(ex
+0000aad0: 6329 290a 2020 2020 2020 2020 2020 2020  c)).            
+0000aae0: 2020 2020 6966 2073 656c 662e 6465 736b      if self.desk
+0000aaf0: 746f 705f 6e6f 7469 6669 6572 3a0a 2020  top_notifier:.  
+0000ab00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ab10: 2020 7365 6c66 2e64 6573 6b74 6f70 5f6e    self.desktop_n
+0000ab20: 6f74 6966 6965 722e 6e6f 7469 6679 280a  otifier.notify(.
+0000ab30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ab40: 2020 2020 2020 2020 6578 632e 7469 746c          exc.titl
+0000ab50: 652c 2065 7863 2e6d 6573 7361 6765 2c20  e, exc.message, 
+0000ab60: 6c65 7665 6c3d 6e6f 7469 6679 2e45 5252  level=notify.ERR
+0000ab70: 4f52 0a20 2020 2020 2020 2020 2020 2020  OR.             
+0000ab80: 2020 2020 2020 2029 0a0a 2020 2020 6465         )..    de
+0000ab90: 6620 5f6e 6577 5f74 6d70 5f66 696c 6528  f _new_tmp_file(
+0000aba0: 7365 6c66 2920 2d3e 2073 7472 3a0a 2020  self) -> str:.  
+0000abb0: 2020 2020 2020 2222 2243 7265 6174 6573        """Creates
+0000abc0: 2061 206e 6577 2074 656d 706f 7261 7279   a new temporary
+0000abd0: 2066 696c 6520 696e 206f 7572 2063 6163   file in our cac
+0000abe0: 6865 2064 6972 6563 746f 7279 2061 6e64  he directory and
+0000abf0: 2072 6574 7572 6e73 2069 7473 2070 6174   returns its pat
+0000ac00: 682e 2222 220a 2020 2020 2020 2020 7365  h.""".        se
+0000ac10: 6c66 2e65 6e73 7572 655f 6361 6368 655f  lf.ensure_cache_
+0000ac20: 6469 725f 7072 6573 656e 7428 290a 2020  dir_present().  
+0000ac30: 2020 2020 2020 7472 793a 0a20 2020 2020        try:.     
+0000ac40: 2020 2020 2020 2077 6974 6820 4e61 6d65         with Name
+0000ac50: 6454 656d 706f 7261 7279 4669 6c65 2864  dTemporaryFile(d
+0000ac60: 6972 3d73 656c 662e 6669 6c65 5f63 6163  ir=self.file_cac
+0000ac70: 6865 5f70 6174 682c 2064 656c 6574 653d  he_path, delete=
+0000ac80: 4661 6c73 6529 2061 7320 663a 0a20 2020  False) as f:.   
+0000ac90: 2020 2020 2020 2020 2020 2020 2074 7279               try
+0000aca0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0000acb0: 2020 2020 2020 6f73 2e63 686d 6f64 2866        os.chmod(f
+0000acc0: 2e66 696c 656e 6f28 292c 2030 6f36 3636  .fileno(), 0o666
+0000acd0: 2026 207e 756d 6173 6b29 0a20 2020 2020   & ~umask).     
+0000ace0: 2020 2020 2020 2020 2020 2065 7863 6570             excep
+0000acf0: 7420 4f53 4572 726f 7220 6173 2065 7272  t OSError as err
+0000ad00: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0000ad10: 2020 2020 2020 2320 4361 6e20 6f63 6375        # Can occu
+0000ad20: 7220 6f6e 2066 696c 6520 7379 7374 656d  r on file system
+0000ad30: 2773 2074 6861 7420 646f 6e27 7420 7375  's that don't su
+0000ad40: 7070 6f72 7420 504f 5349 5820 7065 726d  pport POSIX perm
+0000ad50: 6973 7369 6f6e 730a 2020 2020 2020 2020  issions.        
+0000ad60: 2020 2020 2020 2020 2020 2020 2320 7375              # su
+0000ad70: 6368 2061 7320 4e54 4653 206d 6f75 6e74  ch as NTFS mount
+0000ad80: 6564 2077 6974 686f 7574 2074 6865 2070  ed without the p
+0000ad90: 6572 6d69 7373 696f 6e73 206f 7074 696f  ermissions optio
+0000ada0: 6e2e 0a20 2020 2020 2020 2020 2020 2020  n..             
+0000adb0: 2020 2020 2020 2073 656c 662e 5f6c 6f67         self._log
+0000adc0: 6765 722e 6465 6275 6728 2243 616e 6e6f  ger.debug("Canno
+0000add0: 7420 7365 7420 7065 726d 6973 7369 6f6e  t set permission
+0000ade0: 733a 2025 7322 2c20 6572 722e 7374 7265  s: %s", err.stre
+0000adf0: 7272 6f72 290a 2020 2020 2020 2020 2020  rror).          
+0000ae00: 2020 2020 2020 7265 7475 726e 2066 2e6e        return f.n
+0000ae10: 616d 650a 2020 2020 2020 2020 6578 6365  ame.        exce
+0000ae20: 7074 204f 5345 7272 6f72 2061 7320 6572  pt OSError as er
+0000ae30: 723a 0a20 2020 2020 2020 2020 2020 2072  r:.            r
+0000ae40: 6169 7365 2043 6163 6865 4469 7245 7272  aise CacheDirErr
+0000ae50: 6f72 280a 2020 2020 2020 2020 2020 2020  or(.            
+0000ae60: 2020 2020 6622 4361 6e6e 6f74 2063 7265      f"Cannot cre
+0000ae70: 6174 6520 6361 6368 6520 6469 7265 6374  ate cache direct
+0000ae80: 6f72 793a 207b 6572 722e 7374 7265 7272  ory: {err.strerr
+0000ae90: 6f72 7d22 2c0a 2020 2020 2020 2020 2020  or}",.          
+0000aea0: 2020 2020 2020 2250 6c65 6173 6520 6368        "Please ch
+0000aeb0: 6563 6b20 6966 2079 6f75 2068 6176 6520  eck if you have 
+0000aec0: 7772 6974 6520 7065 726d 6973 7369 6f6e  write permission
+0000aed0: 7320 666f 7220 220a 2020 2020 2020 2020  s for ".        
+0000aee0: 2020 2020 2020 2020 6622 7b73 656c 662e          f"{self.
+0000aef0: 5f66 696c 655f 6361 6368 655f 7061 7468  _file_cache_path
+0000af00: 7d2e 222c 0a20 2020 2020 2020 2020 2020  }.",.           
+0000af10: 2029 0a0a 2020 2020 6465 6620 636f 7272   )..    def corr
+0000af20: 6563 745f 6361 7365 2873 656c 662c 2064  ect_case(self, d
+0000af30: 6278 5f70 6174 683a 2073 7472 2920 2d3e  bx_path: str) ->
+0000af40: 2073 7472 3a0a 2020 2020 2020 2020 2222   str:.        ""
+0000af50: 220a 2020 2020 2020 2020 436f 6e76 6572  ".        Conver
+0000af60: 7473 2061 2044 726f 7062 6f78 2070 6174  ts a Dropbox pat
+0000af70: 6820 7769 7468 2063 6f72 7265 6374 6c79  h with correctly
+0000af80: 2063 6173 6564 2062 6173 656e 616d 6520   cased basename 
+0000af90: 746f 2061 2066 756c 6c79 2063 6173 6564  to a fully cased
+0000afa0: 2070 6174 682e 0a20 2020 2020 2020 2054   path..        T
+0000afb0: 6869 7320 6973 2075 7365 6675 6c20 6265  his is useful be
+0000afc0: 6361 7573 6520 7468 6520 4472 6f70 626f  cause the Dropbo
+0000afd0: 7820 4150 4920 6775 6172 616e 7465 6573  x API guarantees
+0000afe0: 2074 6865 2063 6f72 7265 6374 2063 6173   the correct cas
+0000aff0: 696e 6720 666f 7220 7468 650a 2020 2020  ing for the.    
+0000b000: 2020 2020 6261 7365 6e61 6d65 206f 6e6c      basename onl
+0000b010: 792e 2049 6e20 7072 6163 7469 6365 2c20  y. In practice, 
+0000b020: 6361 7369 6e67 206f 6620 7061 7265 6e74  casing of parent
+0000b030: 2064 6972 6563 746f 7269 6573 2069 7320   directories is 
+0000b040: 6f66 7465 6e20 696e 636f 7272 6563 742e  often incorrect.
+0000b050: 0a20 2020 2020 2020 2054 6869 7320 6d65  .        This me
+0000b060: 7468 6f64 2072 6574 7269 6576 6573 2074  thod retrieves t
+0000b070: 6865 2063 6f72 7265 6374 2063 6173 696e  he correct casin
+0000b080: 6720 6f66 2061 6c6c 2061 6e63 6573 746f  g of all ancesto
+0000b090: 7273 2069 6e20 7468 6520 7061 7468 2c20  rs in the path, 
+0000b0a0: 6569 7468 6572 0a20 2020 2020 2020 2066  either.        f
+0000b0b0: 726f 6d20 6f75 7220 6361 6368 652c 206f  rom our cache, o
+0000b0c0: 7572 2064 6174 6162 6173 652c 206f 7220  ur database, or 
+0000b0d0: 6672 6f6d 2044 726f 7062 6f78 2073 6572  from Dropbox ser
+0000b0e0: 7665 7273 2e0a 0a20 2020 2020 2020 2050  vers...        P
+0000b0f0: 6572 666f 726d 616e 6365 206d 6179 2076  erformance may v
+0000b100: 6172 7920 7369 676e 6966 6963 616e 746c  ary significantl
+0000b110: 7920 7769 7468 2074 6865 206e 756d 6265  y with the numbe
+0000b120: 7220 6f66 2070 6172 656e 7420 666f 6c64  r of parent fold
+0000b130: 6572 7320 616e 6420 7468 650a 2020 2020  ers and the.    
+0000b140: 2020 2020 6d65 7468 6f64 2075 7365 6420      method used 
+0000b150: 746f 2072 6573 6f6c 7665 2074 6865 2063  to resolve the c
+0000b160: 6173 696e 6720 6f66 2061 6c6c 2070 6172  asing of all par
+0000b170: 656e 7420 6469 7265 6374 6f72 7920 6e61  ent directory na
+0000b180: 6d65 733a 0a0a 2020 2020 2020 2020 3129  mes:..        1)
+0000b190: 2049 6620 7468 6520 7061 7265 6e74 2064   If the parent d
+0000b1a0: 6972 6563 746f 7279 2069 7320 616c 7265  irectory is alre
+0000b1b0: 6164 7920 696e 206f 7572 2063 6163 6865  ady in our cache
+0000b1c0: 2c20 7065 7266 6f72 6d61 6e63 6520 6973  , performance is
+0000b1d0: 204f 2831 292e 0a20 2020 2020 2020 2032   O(1)..        2
+0000b1e0: 2920 4966 2074 6865 2070 6172 656e 7420  ) If the parent 
+0000b1f0: 6469 7265 6374 6f72 7920 6973 2061 6c72  directory is alr
+0000b200: 6561 6479 2069 6e20 6f75 7220 7379 6e63  eady in our sync
+0000b210: 2069 6e64 6578 2c20 7065 7266 6f72 6d61   index, performa
+0000b220: 6e63 6520 6973 2073 6c6f 7765 720a 2020  nce is slower.  
+0000b230: 2020 2020 2020 2020 2062 6563 6175 7365           because
+0000b240: 2069 7420 7265 7175 6972 6573 2061 2073   it requires a s
+0000b250: 716c 6974 6520 7175 6572 7920 6275 7420  qlite query but 
+0000b260: 7374 696c 6c20 4f28 3129 2e0a 2020 2020  still O(1)..    
+0000b270: 2020 2020 3329 2049 6620 7468 6520 7061      3) If the pa
+0000b280: 7265 6e74 2064 6972 6563 746f 7279 2069  rent directory i
+0000b290: 7320 756e 6b6e 6f77 6e20 746f 2075 732c  s unknown to us,
+0000b2a0: 2069 7473 206d 6574 6164 6174 6120 2869   its metadata (i
+0000b2b0: 6e63 6c75 6469 6e67 2074 6865 2063 6f72  ncluding the cor
+0000b2c0: 7265 6374 0a20 2020 2020 2020 2020 2020  rect.           
+0000b2d0: 6361 7369 6e67 206f 6620 6469 7265 6374  casing of direct
+0000b2e0: 6f72 7927 7320 6261 7365 6e61 6d65 2920  ory's basename) 
+0000b2f0: 6973 2071 7565 7269 6564 2066 726f 6d20  is queried from 
+0000b300: 4472 6f70 626f 782e 2054 6869 7320 6973  Dropbox. This is
+0000b310: 2075 7365 6420 746f 0a20 2020 2020 2020   used to.       
+0000b320: 2020 2020 636f 6e73 7472 7563 7420 6120      construct a 
+0000b330: 636f 7272 6563 746c 7920 6361 7365 6420  correctly cased 
+0000b340: 7061 7468 2062 7920 6361 6c6c 696e 6720  path by calling 
+0000b350: 3a6d 6574 683a 6063 6f72 7265 6374 5f63  :meth:`correct_c
+0000b360: 6173 6560 2061 6761 696e 2e20 4174 0a20  ase` again. At. 
+0000b370: 2020 2020 2020 2020 2020 6265 7374 2c20            best, 
+0000b380: 7065 7266 6f72 6d61 6e63 6520 7769 6c6c  performance will
+0000b390: 2062 6520 6f66 204f 2832 2920 6966 2074   be of O(2) if t
+0000b3a0: 6865 2070 6172 656e 7420 6469 7265 6374  he parent direct
+0000b3b0: 6f72 7920 6973 206b 6e6f 776e 2074 6f20  ory is known to 
+0000b3c0: 7573 2c20 6174 0a20 2020 2020 2020 2020  us, at.         
+0000b3d0: 2020 776f 7273 7420 6974 2077 696c 6c20    worst it will 
+0000b3e0: 6265 206f 6620 6f72 6465 7220 4f28 6e29  be of order O(n)
+0000b3f0: 2069 6e76 6f6c 7669 6e67 2071 7565 7269   involving queri
+0000b400: 6573 2074 6f20 4472 6f70 626f 7820 7365  es to Dropbox se
+0000b410: 7276 6572 7320 666f 7220 6561 6368 0a20  rvers for each. 
+0000b420: 2020 2020 2020 2020 2020 7061 7265 6e74            parent
+0000b430: 2064 6972 6563 746f 7279 2e0a 0a20 2020   directory...   
+0000b440: 2020 2020 2057 6865 6e20 6361 6c6c 696e       When callin
+0000b450: 6720 3a6d 6574 683a 6063 6f72 7265 6374  g :meth:`correct
+0000b460: 5f63 6173 6560 2072 6570 6561 7465 646c  _case` repeatedl
+0000b470: 7920 666f 7220 7061 7468 7320 6672 6f6d  y for paths from
+0000b480: 2074 6865 2073 616d 6520 7472 6565 2c20   the same tree, 
+0000b490: 6974 2069 730a 2020 2020 2020 2020 7468  it is.        th
+0000b4a0: 6572 6566 6f72 6520 6265 7374 2074 6f20  erefore best to 
+0000b4b0: 646f 2073 6f20 696e 2068 6965 7261 7263  do so in hierarc
+0000b4c0: 6869 6361 6c20 6f72 6465 722e 0a0a 2020  hical order...  
+0000b4d0: 2020 2020 2020 3a70 6172 616d 2064 6278        :param dbx
+0000b4e0: 5f70 6174 683a 2044 726f 7062 6f78 2070  _path: Dropbox p
+0000b4f0: 6174 6820 7769 7468 2063 6f72 7265 6374  ath with correct
+0000b500: 6c79 2063 6173 6564 2062 6173 656e 616d  ly cased basenam
+0000b510: 652c 2061 7320 7072 6f76 6964 6564 2062  e, as provided b
+0000b520: 790a 2020 2020 2020 2020 2020 2020 3a61  y.            :a
+0000b530: 7474 723a 6064 726f 7062 6f78 2e66 696c  ttr:`dropbox.fil
+0000b540: 6573 2e4d 6574 6164 6174 612e 7061 7468  es.Metadata.path
+0000b550: 5f64 6973 706c 6179 6020 6f72 0a20 2020  _display` or.   
+0000b560: 2020 2020 2020 2020 203a 6174 7472 3a60           :attr:`
+0000b570: 6472 6f70 626f 782e 6669 6c65 732e 4d65  dropbox.files.Me
+0000b580: 7461 6461 7461 2e6e 616d 6560 2e0a 2020  tadata.name`..  
+0000b590: 2020 2020 2020 3a72 6574 7572 6e73 3a20        :returns: 
+0000b5a0: 436f 7272 6563 746c 7920 6361 7365 6420  Correctly cased 
+0000b5b0: 4472 6f70 626f 7820 7061 7468 2e0a 2020  Dropbox path..  
+0000b5c0: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
+0000b5d0: 2020 6462 785f 7061 7468 5f6c 6f77 6572    dbx_path_lower
+0000b5e0: 203d 206e 6f72 6d61 6c69 7a65 2864 6278   = normalize(dbx
+0000b5f0: 5f70 6174 6829 0a0a 2020 2020 2020 2020  _path)..        
+0000b600: 6469 726e 616d 652c 2062 6173 656e 616d  dirname, basenam
+0000b610: 6520 3d20 6f73 702e 7370 6c69 7428 6462  e = osp.split(db
+0000b620: 785f 7061 7468 290a 2020 2020 2020 2020  x_path).        
+0000b630: 6469 726e 616d 655f 6c6f 7765 7220 3d20  dirname_lower = 
+0000b640: 6f73 702e 6469 726e 616d 6528 6462 785f  osp.dirname(dbx_
+0000b650: 7061 7468 5f6c 6f77 6572 290a 0a20 2020  path_lower)..   
+0000b660: 2020 2020 2064 6972 6e61 6d65 5f63 6173       dirname_cas
+0000b670: 6564 203d 2073 656c 662e 5f63 6f72 7265  ed = self._corre
+0000b680: 6374 5f63 6173 655f 6865 6c70 6572 2864  ct_case_helper(d
+0000b690: 6972 6e61 6d65 2c20 6469 726e 616d 655f  irname, dirname_
+0000b6a0: 6c6f 7765 7229 0a20 2020 2020 2020 2070  lower).        p
+0000b6b0: 6174 685f 6361 7365 6420 3d20 6f73 702e  ath_cased = osp.
+0000b6c0: 6a6f 696e 2864 6972 6e61 6d65 5f63 6173  join(dirname_cas
+0000b6d0: 6564 2c20 6261 7365 6e61 6d65 290a 0a20  ed, basename).. 
+0000b6e0: 2020 2020 2020 2023 2041 6464 206f 7572         # Add our
+0000b6f0: 2072 6573 756c 7420 746f 2074 6865 2063   result to the c
+0000b700: 6163 6865 2e0a 2020 2020 2020 2020 7365  ache..        se
+0000b710: 6c66 2e5f 6361 7365 5f63 6f6e 7665 7273  lf._case_convers
+0000b720: 696f 6e5f 6361 6368 652e 7075 7428 6462  ion_cache.put(db
+0000b730: 785f 7061 7468 5f6c 6f77 6572 2c20 7061  x_path_lower, pa
+0000b740: 7468 5f63 6173 6564 290a 0a20 2020 2020  th_cased)..     
+0000b750: 2020 2072 6574 7572 6e20 7061 7468 5f63     return path_c
+0000b760: 6173 6564 0a0a 2020 2020 6465 6620 5f63  ased..    def _c
+0000b770: 6f72 7265 6374 5f63 6173 655f 6865 6c70  orrect_case_help
+0000b780: 6572 2873 656c 662c 2064 6278 5f70 6174  er(self, dbx_pat
+0000b790: 683a 2073 7472 2c20 6462 785f 7061 7468  h: str, dbx_path
+0000b7a0: 5f6c 6f77 6572 3a20 7374 7229 202d 3e20  _lower: str) -> 
+0000b7b0: 7374 723a 0a20 2020 2020 2020 2022 2222  str:.        """
+0000b7c0: 0a20 2020 2020 2020 203a 7061 7261 6d20  .        :param 
+0000b7d0: 6462 785f 7061 7468 3a20 556e 6361 7365  dbx_path: Uncase
+0000b7e0: 6420 6f72 2072 616e 646f 6d6c 7920 6361  d or randomly ca
+0000b7f0: 7365 6420 4472 6f70 626f 7820 7061 7468  sed Dropbox path
+0000b800: 2e0a 2020 2020 2020 2020 3a70 6172 616d  ..        :param
+0000b810: 2064 6278 5f70 6174 685f 6c6f 7765 723a   dbx_path_lower:
+0000b820: 204e 6f72 6d61 6c69 7a65 6420 6675 6c6c   Normalized full
+0000b830: 7920 6c6f 7765 7220 6361 7365 6420 4472  y lower cased Dr
+0000b840: 6f70 626f 7820 7061 7468 2e0a 2020 2020  opbox path..    
+0000b850: 2020 2020 3a72 6574 7572 6e73 3a20 436f      :returns: Co
+0000b860: 7272 6563 746c 7920 6361 7365 6420 4472  rrectly cased Dr
+0000b870: 6f70 626f 7820 7061 7468 2e0a 2020 2020  opbox path..    
+0000b880: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
+0000b890: 2320 4368 6563 6b20 666f 7220 726f 6f74  # Check for root
+0000b8a0: 2066 6f6c 6465 722e 0a20 2020 2020 2020   folder..       
+0000b8b0: 2069 6620 6462 785f 7061 7468 203d 3d20   if dbx_path == 
+0000b8c0: 222f 223a 0a20 2020 2020 2020 2020 2020  "/":.           
+0000b8d0: 2072 6574 7572 6e20 6462 785f 7061 7468   return dbx_path
+0000b8e0: 0a0a 2020 2020 2020 2020 2320 4368 6563  ..        # Chec
+0000b8f0: 6b20 696e 206f 7572 2063 6f6e 7665 7273  k in our convers
+0000b900: 696f 6e20 6361 6368 652e 0a20 2020 2020  ion cache..     
+0000b910: 2020 2064 6278 5f70 6174 685f 6361 7365     dbx_path_case
+0000b920: 6420 3d20 7365 6c66 2e5f 6361 7365 5f63  d = self._case_c
+0000b930: 6f6e 7665 7273 696f 6e5f 6361 6368 652e  onversion_cache.
+0000b940: 6765 7428 6462 785f 7061 7468 5f6c 6f77  get(dbx_path_low
+0000b950: 6572 290a 0a20 2020 2020 2020 2069 6620  er)..        if 
+0000b960: 6462 785f 7061 7468 5f63 6173 6564 3a0a  dbx_path_cased:.
+0000b970: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+0000b980: 726e 2064 6278 5f70 6174 685f 6361 7365  rn dbx_path_case
+0000b990: 640a 0a20 2020 2020 2020 2023 2054 7279  d..        # Try
+0000b9a0: 2074 6f20 6765 7420 6361 7369 6e67 2066   to get casing f
+0000b9b0: 726f 6d20 6f75 7220 696e 6465 782c 2074  rom our index, t
+0000b9c0: 6869 7320 6973 2073 6c6f 7765 722e 0a20  his is slower.. 
+0000b9d0: 2020 2020 2020 2077 6974 6820 7365 6c66         with self
+0000b9e0: 2e5f 6461 7461 6261 7365 5f61 6363 6573  ._database_acces
+0000b9f0: 7328 293a 0a20 2020 2020 2020 2020 2020  s():.           
+0000ba00: 2065 6e74 7279 203d 2073 656c 662e 6765   entry = self.ge
+0000ba10: 745f 696e 6465 785f 656e 7472 7928 6462  t_index_entry(db
+0000ba20: 785f 7061 7468 5f6c 6f77 6572 290a 0a20  x_path_lower).. 
+0000ba30: 2020 2020 2020 2069 6620 656e 7472 793a         if entry:
+0000ba40: 0a20 2020 2020 2020 2020 2020 2064 6278  .            dbx
+0000ba50: 5f70 6174 685f 6361 7365 6420 3d20 656e  _path_cased = en
+0000ba60: 7472 792e 6462 785f 7061 7468 5f63 6173  try.dbx_path_cas
+0000ba70: 6564 0a20 2020 2020 2020 2065 6c73 653a  ed.        else:
+0000ba80: 0a20 2020 2020 2020 2020 2020 2023 2046  .            # F
+0000ba90: 616c 6c20 6261 636b 2074 6f20 7175 6572  all back to quer
+0000baa0: 7969 6e67 2066 726f 6d20 7365 7276 6572  ying from server
+0000bab0: 2e0a 2020 2020 2020 2020 2020 2020 6d64  ..            md
+0000bac0: 203d 2073 656c 662e 636c 6965 6e74 2e67   = self.client.g
+0000bad0: 6574 5f6d 6574 6164 6174 6128 6462 785f  et_metadata(dbx_
+0000bae0: 7061 7468 290a 2020 2020 2020 2020 2020  path).          
+0000baf0: 2020 6966 206d 643a 0a20 2020 2020 2020    if md:.       
+0000bb00: 2020 2020 2020 2020 2023 2052 6563 7572           # Recur
+0000bb10: 7365 206f 7665 7220 7061 7265 6e74 2064  se over parent d
+0000bb20: 6972 6563 746f 7269 6573 2e0a 2020 2020  irectories..    
+0000bb30: 2020 2020 2020 2020 2020 2020 6462 785f              dbx_
+0000bb40: 7061 7468 5f63 6173 6564 203d 2073 656c  path_cased = sel
+0000bb50: 662e 636f 7272 6563 745f 6361 7365 286d  f.correct_case(m
+0000bb60: 642e 7061 7468 5f64 6973 706c 6179 290a  d.path_display).
+0000bb70: 2020 2020 2020 2020 2020 2020 656c 7365              else
+0000bb80: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0000bb90: 2020 2320 4769 7665 2075 702e 0a20 2020    # Give up..   
+0000bba0: 2020 2020 2020 2020 2020 2020 2064 6278               dbx
+0000bbb0: 5f70 6174 685f 6361 7365 6420 3d20 6462  _path_cased = db
+0000bbc0: 785f 7061 7468 0a0a 2020 2020 2020 2020  x_path..        
+0000bbd0: 2320 4164 6420 6f75 7220 7265 7375 6c74  # Add our result
+0000bbe0: 2074 6f20 7468 6520 6361 6368 652e 0a20   to the cache.. 
+0000bbf0: 2020 2020 2020 2073 656c 662e 5f63 6173         self._cas
+0000bc00: 655f 636f 6e76 6572 7369 6f6e 5f63 6163  e_conversion_cac
+0000bc10: 6865 2e70 7574 2864 6278 5f70 6174 685f  he.put(dbx_path_
+0000bc20: 6c6f 7765 722c 2064 6278 5f70 6174 685f  lower, dbx_path_
+0000bc30: 6361 7365 6429 0a0a 2020 2020 2020 2020  cased)..        
+0000bc40: 7265 7475 726e 2064 6278 5f70 6174 685f  return dbx_path_
+0000bc50: 6361 7365 640a 0a20 2020 2064 6566 2074  cased..    def t
+0000bc60: 6f5f 6462 785f 7061 7468 2873 656c 662c  o_dbx_path(self,
+0000bc70: 206c 6f63 616c 5f70 6174 683a 2073 7472   local_path: str
+0000bc80: 2920 2d3e 2073 7472 3a0a 2020 2020 2020  ) -> str:.      
+0000bc90: 2020 2222 220a 2020 2020 2020 2020 436f    """.        Co
+0000bca0: 6e76 6572 7473 2061 206c 6f63 616c 2070  nverts a local p
+0000bcb0: 6174 6820 746f 2061 2070 6174 6820 7265  ath to a path re
+0000bcc0: 6c61 7469 7665 2074 6f20 7468 6520 4472  lative to the Dr
+0000bcd0: 6f70 626f 7820 666f 6c64 6572 2e20 4361  opbox folder. Ca
+0000bce0: 7369 6e67 206f 6620 7468 650a 2020 2020  sing of the.    
+0000bcf0: 2020 2020 6769 7665 6e20 6060 6c6f 6361      given ``loca
+0000bd00: 6c5f 7061 7468 6060 2077 696c 6c20 6265  l_path`` will be
+0000bd10: 2070 7265 7365 7276 6564 2e0a 0a20 2020   preserved...   
+0000bd20: 2020 2020 203a 7061 7261 6d20 6c6f 6361       :param loca
+0000bd30: 6c5f 7061 7468 3a20 4162 736f 6c75 7465  l_path: Absolute
+0000bd40: 2070 6174 6820 6f6e 206c 6f63 616c 2064   path on local d
+0000bd50: 7269 7665 2e0a 2020 2020 2020 2020 3a72  rive..        :r
+0000bd60: 6574 7572 6e73 3a20 5265 6c61 7469 7665  eturns: Relative
+0000bd70: 2070 6174 6820 7769 7468 2072 6573 7065   path with respe
+0000bd80: 6374 2074 6f20 4472 6f70 626f 7820 666f  ct to Dropbox fo
+0000bd90: 6c64 6572 2e0a 2020 2020 2020 2020 3a72  lder..        :r
+0000bda0: 6169 7365 7320 5661 6c75 6545 7272 6f72  aises ValueError
+0000bdb0: 3a20 5768 656e 2074 6865 2070 6174 6820  : When the path 
+0000bdc0: 6c69 6573 206f 7574 7369 6465 2074 6865  lies outside the
+0000bdd0: 206c 6f63 616c 2044 726f 7062 6f78 2066   local Dropbox f
+0000bde0: 6f6c 6465 722e 0a20 2020 2020 2020 2022  older..        "
+0000bdf0: 2222 0a20 2020 2020 2020 2069 6620 6e6f  "".        if no
+0000be00: 7420 6973 5f65 7175 616c 5f6f 725f 6368  t is_equal_or_ch
+0000be10: 696c 6428 0a20 2020 2020 2020 2020 2020  ild(.           
+0000be20: 206c 6f63 616c 5f70 6174 682c 2073 656c   local_path, sel
+0000be30: 662e 6472 6f70 626f 785f 7061 7468 2c20  f.dropbox_path, 
+0000be40: 7365 6c66 2e69 735f 6673 5f63 6173 655f  self.is_fs_case_
+0000be50: 7365 6e73 6974 6976 650a 2020 2020 2020  sensitive.      
+0000be60: 2020 293a 0a20 2020 2020 2020 2020 2020    ):.           
+0000be70: 2072 6169 7365 2056 616c 7565 4572 726f   raise ValueErro
+0000be80: 7228 6627 227b 6c6f 6361 6c5f 7061 7468  r(f'"{local_path
+0000be90: 7d22 2069 7320 6e6f 7420 696e 2022 7b73  }" is not in "{s
+0000bea0: 656c 662e 6472 6f70 626f 785f 7061 7468  elf.dropbox_path
+0000beb0: 7d22 2729 0a20 2020 2020 2020 2072 6574  }"').        ret
+0000bec0: 7572 6e20 222f 2220 2b20 7265 6d6f 7665  urn "/" + remove
+0000bed0: 7072 6566 6978 280a 2020 2020 2020 2020  prefix(.        
+0000bee0: 2020 2020 6c6f 6361 6c5f 7061 7468 2c20      local_path, 
+0000bef0: 7365 6c66 2e64 726f 7062 6f78 5f70 6174  self.dropbox_pat
+0000bf00: 682c 2073 656c 662e 6973 5f66 735f 6361  h, self.is_fs_ca
+0000bf10: 7365 5f73 656e 7369 7469 7665 0a20 2020  se_sensitive.   
+0000bf20: 2020 2020 2029 2e6c 7374 7269 7028 222f       ).lstrip("/
+0000bf30: 2229 0a0a 2020 2020 6465 6620 746f 5f64  ")..    def to_d
+0000bf40: 6278 5f70 6174 685f 6c6f 7765 7228 7365  bx_path_lower(se
+0000bf50: 6c66 2c20 6c6f 6361 6c5f 7061 7468 3a20  lf, local_path: 
+0000bf60: 7374 7229 202d 3e20 7374 723a 0a20 2020  str) -> str:.   
+0000bf70: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
+0000bf80: 2043 6f6e 7665 7274 7320 6120 6c6f 6361   Converts a loca
+0000bf90: 6c20 7061 7468 2074 6f20 6120 7061 7468  l path to a path
+0000bfa0: 2072 656c 6174 6976 6520 746f 2074 6865   relative to the
+0000bfb0: 2044 726f 7062 6f78 2066 6f6c 6465 722e   Dropbox folder.
+0000bfc0: 2054 6865 2070 6174 6820 7769 6c6c 2062   The path will b
+0000bfd0: 650a 2020 2020 2020 2020 6e6f 726d 616c  e.        normal
+0000bfe0: 697a 6564 2061 7320 6f6e 2044 726f 7062  ized as on Dropb
+0000bff0: 6f78 2073 6572 7665 7273 2028 6c6f 7765  ox servers (lowe
+0000c000: 7220 6361 7365 2061 6e64 2073 6f6d 6520  r case and some 
+0000c010: 6164 6469 7469 6f6e 616c 0a20 2020 2020  additional.     
+0000c020: 2020 206e 6f72 6d61 6c69 7361 7469 6f6e     normalisation
+0000c030: 7329 2e0a 0a20 2020 2020 2020 203a 7061  s)...        :pa
+0000c040: 7261 6d20 6c6f 6361 6c5f 7061 7468 3a20  ram local_path: 
+0000c050: 4162 736f 6c75 7465 2070 6174 6820 6f6e  Absolute path on
+0000c060: 206c 6f63 616c 2064 7269 7665 2e0a 2020   local drive..  
+0000c070: 2020 2020 2020 3a72 6574 7572 6e73 3a20        :returns: 
+0000c080: 5265 6c61 7469 7665 2070 6174 6820 7769  Relative path wi
+0000c090: 7468 2072 6573 7065 6374 2074 6f20 4472  th respect to Dr
+0000c0a0: 6f70 626f 7820 666f 6c64 6572 2e0a 2020  opbox folder..  
+0000c0b0: 2020 2020 2020 3a72 6169 7365 7320 5661        :raises Va
+0000c0c0: 6c75 6545 7272 6f72 3a20 5768 656e 2074  lueError: When t
+0000c0d0: 6865 2070 6174 6820 6c69 6573 206f 7574  he path lies out
+0000c0e0: 7369 6465 2074 6865 206c 6f63 616c 2044  side the local D
+0000c0f0: 726f 7062 6f78 2066 6f6c 6465 722e 0a20  ropbox folder.. 
+0000c100: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
+0000c110: 2020 2072 6574 7572 6e20 6e6f 726d 616c     return normal
+0000c120: 697a 6528 7365 6c66 2e74 6f5f 6462 785f  ize(self.to_dbx_
+0000c130: 7061 7468 286c 6f63 616c 5f70 6174 6829  path(local_path)
+0000c140: 290a 0a20 2020 2064 6566 2074 6f5f 6c6f  )..    def to_lo
+0000c150: 6361 6c5f 7061 7468 5f66 726f 6d5f 6361  cal_path_from_ca
+0000c160: 7365 6428 7365 6c66 2c20 6462 785f 7061  sed(self, dbx_pa
+0000c170: 7468 5f63 6173 6564 3a20 7374 7229 202d  th_cased: str) -
+0000c180: 3e20 7374 723a 0a20 2020 2020 2020 2022  > str:.        "
+0000c190: 2222 0a20 2020 2020 2020 2043 6f6e 7665  "".        Conve
+0000c1a0: 7274 7320 6120 636f 7272 6563 746c 7920  rts a correctly 
+0000c1b0: 6361 7365 6420 4472 6f70 626f 7820 7061  cased Dropbox pa
+0000c1c0: 7468 2074 6f20 7468 6520 636f 7272 6573  th to the corres
+0000c1d0: 706f 6e64 696e 6720 6c6f 6361 6c20 7061  ponding local pa
+0000c1e0: 7468 2e20 5468 6973 2069 730a 2020 2020  th. This is.    
+0000c1f0: 2020 2020 6d6f 7265 2065 6666 6963 6965      more efficie
+0000c200: 6e74 2074 6861 6e20 3a6d 6574 683a 6074  nt than :meth:`t
+0000c210: 6f5f 6c6f 6361 6c5f 7061 7468 6020 7768  o_local_path` wh
+0000c220: 6963 6820 6163 6365 7074 7320 756e 6361  ich accepts unca
+0000c230: 7365 6420 7061 7468 732e 0a0a 2020 2020  sed paths...    
+0000c240: 2020 2020 3a70 6172 616d 2064 6278 5f70      :param dbx_p
+0000c250: 6174 685f 6361 7365 643a 2050 6174 6820  ath_cased: Path 
+0000c260: 7265 6c61 7469 7665 2074 6f20 4472 6f70  relative to Drop
+0000c270: 626f 7820 666f 6c64 6572 2c20 636f 7272  box folder, corr
+0000c280: 6563 746c 7920 6361 7365 642e 0a20 2020  ectly cased..   
+0000c290: 2020 2020 203a 7265 7475 726e 733a 2043       :returns: C
+0000c2a0: 6f72 7265 7370 6f6e 6469 6e67 206c 6f63  orresponding loc
+0000c2b0: 616c 2070 6174 6820 6f6e 2064 7269 7665  al path on drive
+0000c2c0: 2e0a 2020 2020 2020 2020 2222 220a 2020  ..        """.  
+0000c2d0: 2020 2020 2020 7265 7475 726e 2066 227b        return f"{
+0000c2e0: 7365 6c66 2e64 726f 7062 6f78 5f70 6174  self.dropbox_pat
+0000c2f0: 687d 7b64 6278 5f70 6174 685f 6361 7365  h}{dbx_path_case
+0000c300: 647d 220a 0a20 2020 2064 6566 2074 6f5f  d}"..    def to_
+0000c310: 6c6f 6361 6c5f 7061 7468 2873 656c 662c  local_path(self,
+0000c320: 2064 6278 5f70 6174 683a 2073 7472 2920   dbx_path: str) 
+0000c330: 2d3e 2073 7472 3a0a 2020 2020 2020 2020  -> str:.        
+0000c340: 2222 220a 2020 2020 2020 2020 436f 6e76  """.        Conv
+0000c350: 6572 7473 2061 2044 726f 7062 6f78 2070  erts a Dropbox p
+0000c360: 6174 6820 746f 2074 6865 2063 6f72 7265  ath to the corre
+0000c370: 7370 6f6e 6469 6e67 206c 6f63 616c 2070  sponding local p
+0000c380: 6174 682e 204f 6e6c 7920 7468 6520 6261  ath. Only the ba
+0000c390: 7365 6e61 6d65 206d 7573 740a 2020 2020  sename must.    
+0000c3a0: 2020 2020 6265 2063 6f72 7265 6374 6c79      be correctly
+0000c3b0: 2063 6173 6564 2c20 6173 2067 7561 7261   cased, as guara
+0000c3c0: 6e74 6565 6420 6279 2074 6865 2044 726f  nteed by the Dro
+0000c3d0: 7062 6f78 2041 5049 2066 6f72 2074 6865  pbox API for the
+0000c3e0: 2060 6064 6973 706c 6179 5f70 6174 6860   ``display_path`
+0000c3f0: 600a 2020 2020 2020 2020 6174 7472 6962  `.        attrib
+0000c400: 7574 6520 6f66 2066 696c 6520 6f72 2066  ute of file or f
+0000c410: 6f6c 6465 7220 6d65 7461 6461 7461 2e0a  older metadata..
+0000c420: 0a20 2020 2020 2020 2054 6869 7320 6d65  .        This me
+0000c430: 7468 6f64 2073 6c6f 7765 7220 7468 616e  thod slower than
+0000c440: 203a 6d65 7468 3a60 746f 5f6c 6f63 616c   :meth:`to_local
+0000c450: 5f70 6174 685f 6672 6f6d 5f63 6173 6564  _path_from_cased
+0000c460: 602e 0a0a 2020 2020 2020 2020 3a70 6172  `...        :par
+0000c470: 616d 2064 6278 5f70 6174 683a 2050 6174  am dbx_path: Pat
+0000c480: 6820 7265 6c61 7469 7665 2074 6f20 4472  h relative to Dr
+0000c490: 6f70 626f 7820 666f 6c64 6572 2c20 6d75  opbox folder, mu
+0000c4a0: 7374 2062 6520 636f 7272 6563 746c 7920  st be correctly 
+0000c4b0: 6361 7365 6420 696e 2069 7473 0a20 2020  cased in its.   
+0000c4c0: 2020 2020 2020 2020 2062 6173 656e 616d           basenam
+0000c4d0: 652e 0a20 2020 2020 2020 203a 7265 7475  e..        :retu
+0000c4e0: 726e 733a 2043 6f72 7265 7370 6f6e 6469  rns: Correspondi
+0000c4f0: 6e67 206c 6f63 616c 2070 6174 6820 6f6e  ng local path on
+0000c500: 2064 7269 7665 2e0a 2020 2020 2020 2020   drive..        
+0000c510: 2222 220a 2020 2020 2020 2020 6462 785f  """.        dbx_
+0000c520: 7061 7468 5f63 6173 6564 203d 2073 656c  path_cased = sel
+0000c530: 662e 636f 7272 6563 745f 6361 7365 2864  f.correct_case(d
+0000c540: 6278 5f70 6174 6829 0a20 2020 2020 2020  bx_path).       
+0000c550: 2072 6574 7572 6e20 6622 7b73 656c 662e   return f"{self.
+0000c560: 6472 6f70 626f 785f 7061 7468 7d7b 6462  dropbox_path}{db
+0000c570: 785f 7061 7468 5f63 6173 6564 7d22 0a0a  x_path_cased}"..
+0000c580: 2020 2020 6465 6620 6973 5f65 7863 6c75      def is_exclu
+0000c590: 6465 6428 7365 6c66 2c20 7061 7468 3a20  ded(self, path: 
+0000c5a0: 7374 7229 202d 3e20 626f 6f6c 3a0a 2020  str) -> bool:.  
+0000c5b0: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
+0000c5c0: 2020 4368 6563 6b73 2069 6620 6120 6669    Checks if a fi
+0000c5d0: 6c65 2069 7320 6578 636c 7564 6564 2066  le is excluded f
+0000c5e0: 726f 6d20 7379 6e63 2e20 4365 7274 6169  rom sync. Certai
+0000c5f0: 6e20 6669 6c65 206e 616d 6573 2061 7265  n file names are
+0000c600: 2061 6c77 6179 7320 6578 636c 7564 6564   always excluded
+0000c610: 0a20 2020 2020 2020 2066 726f 6d20 7379  .        from sy
+0000c620: 6e63 696e 672c 2066 6f6c 6c6f 7769 6e67  ncing, following
+0000c630: 2074 6865 2044 726f 7062 6f78 2073 7570   the Dropbox sup
+0000c640: 706f 7274 2061 7274 6963 6c65 3a0a 0a20  port article:.. 
+0000c650: 2020 2020 2020 2068 7474 7073 3a2f 2f68         https://h
+0000c660: 656c 702e 6472 6f70 626f 782e 636f 6d2f  elp.dropbox.com/
+0000c670: 696e 7374 616c 6c73 2d69 6e74 6567 7261  installs-integra
+0000c680: 7469 6f6e 732f 7379 6e63 2d75 706c 6f61  tions/sync-uploa
+0000c690: 6473 2f66 696c 6573 2d6e 6f74 2d73 796e  ds/files-not-syn
+0000c6a0: 6369 6e67 0a0a 2020 2020 2020 2020 5468  cing..        Th
+0000c6b0: 6973 2069 6e63 6c75 6465 7320 6669 6c65  is includes file
+0000c6c0: 2073 7973 7465 6d20 6669 6c65 7320 7375   system files su
+0000c6d0: 6368 2061 7320 2764 6573 6b74 6f70 2e69  ch as 'desktop.i
+0000c6e0: 6e69 2720 616e 6420 272e 4453 5f53 746f  ni' and '.DS_Sto
+0000c6f0: 7265 2720 616e 6420 736f 6d65 0a20 2020  re' and some.   
+0000c700: 2020 2020 2074 656d 706f 7261 7279 2066       temporary f
+0000c710: 696c 6573 2061 7320 7765 6c6c 2061 7320  iles as well as 
+0000c720: 6361 6368 6573 2075 7365 6420 6279 2044  caches used by D
+0000c730: 726f 7062 6f78 206f 7220 4d61 6573 7472  ropbox or Maestr
+0000c740: 616c 2e20 6069 735f 6578 636c 7564 6564  al. `is_excluded
+0000c750: 600a 2020 2020 2020 2020 6163 6365 7074  `.        accept
+0000c760: 7320 626f 7468 206c 6f63 616c 2061 6e64  s both local and
+0000c770: 2044 726f 7062 6f78 2070 6174 6873 2e0a   Dropbox paths..
+0000c780: 0a20 2020 2020 2020 203a 7061 7261 6d20  .        :param 
+0000c790: 7061 7468 3a20 4361 6e20 6265 2061 6e20  path: Can be an 
+0000c7a0: 6162 736f 6c75 7465 2070 6174 682c 2061  absolute path, a
+0000c7b0: 2070 6174 6820 7265 6c61 7469 7665 2074   path relative t
+0000c7c0: 6f20 7468 6520 4472 6f70 626f 7820 666f  o the Dropbox fo
+0000c7d0: 6c64 6572 206f 720a 2020 2020 2020 2020  lder or.        
+0000c7e0: 2020 2020 6a75 7374 2061 2066 696c 6520      just a file 
+0000c7f0: 6e61 6d65 2e20 446f 6573 206e 6f74 206e  name. Does not n
+0000c800: 6565 6420 746f 2062 6520 6e6f 726d 616c  eed to be normal
+0000c810: 697a 6564 2e0a 2020 2020 2020 2020 3a72  ized..        :r
+0000c820: 6574 7572 6e73 3a20 5768 6574 6865 7220  eturns: Whether 
+0000c830: 7468 6520 7061 7468 2069 7320 6578 636c  the path is excl
+0000c840: 7564 6564 2066 726f 6d20 7379 6e63 696e  uded from syncin
+0000c850: 672e 0a20 2020 2020 2020 2022 2222 0a20  g..        """. 
+0000c860: 2020 2020 2020 2064 6972 6e61 6d65 2c20         dirname, 
+0000c870: 6261 7365 6e61 6d65 203d 206f 7370 2e73  basename = osp.s
+0000c880: 706c 6974 2870 6174 6829 0a0a 2020 2020  plit(path)..    
+0000c890: 2020 2020 2320 4973 2069 6e20 6578 636c      # Is in excl
+0000c8a0: 7564 6564 2066 696c 6573 3f0a 2020 2020  uded files?.    
+0000c8b0: 2020 2020 6966 2062 6173 656e 616d 6520      if basename 
+0000c8c0: 696e 2045 5843 4c55 4445 445f 4649 4c45  in EXCLUDED_FILE
+0000c8d0: 5f4e 414d 4553 3a0a 2020 2020 2020 2020  _NAMES:.        
+0000c8e0: 2020 2020 7265 7475 726e 2054 7275 650a      return True.
+0000c8f0: 0a20 2020 2020 2020 2023 2049 7320 696e  .        # Is in
+0000c900: 2065 7863 6c75 6465 6420 6469 7273 3f0a   excluded dirs?.
+0000c910: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
+0000c920: 2020 2020 2020 2020 2064 6278 5f64 6972           dbx_dir
+0000c930: 6e61 6d65 203d 2073 656c 662e 746f 5f64  name = self.to_d
+0000c940: 6278 5f70 6174 6828 6469 726e 616d 6529  bx_path(dirname)
+0000c950: 0a20 2020 2020 2020 2065 7863 6570 7420  .        except 
+0000c960: 5661 6c75 6545 7272 6f72 3a0a 2020 2020  ValueError:.    
+0000c970: 2020 2020 2020 2020 2320 5061 7468 2069          # Path i
+0000c980: 7320 616c 7265 6164 7920 7265 6c61 7469  s already relati
+0000c990: 7665 2074 6f20 4472 6f70 626f 782e 0a20  ve to Dropbox.. 
+0000c9a0: 2020 2020 2020 2020 2020 2064 6278 5f64             dbx_d
+0000c9b0: 6972 6e61 6d65 203d 2064 6972 6e61 6d65  irname = dirname
+0000c9c0: 0a0a 2020 2020 2020 2020 726f 6f74 5f64  ..        root_d
+0000c9d0: 6972 203d 206e 6578 7428 6974 6572 2870  ir = next(iter(p
+0000c9e0: 6172 7420 666f 7220 7061 7274 2069 6e20  art for part in 
+0000c9f0: 6462 785f 6469 726e 616d 652e 7370 6c69  dbx_dirname.spli
+0000ca00: 7428 222f 222c 2032 2920 6966 2070 6172  t("/", 2) if par
+0000ca10: 7429 2c20 2222 290a 0a20 2020 2020 2020  t), "")..       
+0000ca20: 2069 6620 726f 6f74 5f64 6972 2069 6e20   if root_dir in 
+0000ca30: 4558 434c 5544 4544 5f44 4952 5f4e 414d  EXCLUDED_DIR_NAM
+0000ca40: 4553 3a0a 2020 2020 2020 2020 2020 2020  ES:.            
+0000ca50: 7265 7475 726e 2054 7275 650a 0a20 2020  return True..   
+0000ca60: 2020 2020 2023 2049 7320 7465 6d70 6f72       # Is tempor
+0000ca70: 6172 7920 6669 6c65 3f0a 2020 2020 2020  ary file?.      
+0000ca80: 2020 6966 2022 7e22 2069 6e20 6261 7365    if "~" in base
+0000ca90: 6e61 6d65 3a0a 2020 2020 2020 2020 2020  name:.          
+0000caa0: 2020 2320 3129 204f 6666 6963 6520 7465    # 1) Office te
+0000cab0: 6d70 6f72 6172 7920 6669 6c65 730a 2020  mporary files.  
+0000cac0: 2020 2020 2020 2020 2020 6966 2062 6173            if bas
+0000cad0: 656e 616d 652e 7374 6172 7473 7769 7468  ename.startswith
+0000cae0: 2822 7e24 2229 3a0a 2020 2020 2020 2020  ("~$"):.        
+0000caf0: 2020 2020 2020 2020 7265 7475 726e 2054          return T
+0000cb00: 7275 650a 2020 2020 2020 2020 2020 2020  rue.            
+0000cb10: 6966 2062 6173 656e 616d 652e 7374 6172  if basename.star
+0000cb20: 7473 7769 7468 2822 2e7e 2229 3a0a 2020  tswith(".~"):.  
+0000cb30: 2020 2020 2020 2020 2020 2020 2020 7265                re
+0000cb40: 7475 726e 2054 7275 650a 2020 2020 2020  turn True.      
+0000cb50: 2020 2020 2020 2320 3229 204f 7468 6572        # 2) Other
+0000cb60: 2074 656d 706f 7261 7279 2066 696c 6573   temporary files
+0000cb70: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+0000cb80: 6261 7365 6e61 6d65 2e73 7461 7274 7377  basename.startsw
+0000cb90: 6974 6828 227e 2229 2061 6e64 2062 6173  ith("~") and bas
+0000cba0: 656e 616d 652e 656e 6473 7769 7468 2822  ename.endswith("
+0000cbb0: 2e74 6d70 2229 3a0a 2020 2020 2020 2020  .tmp"):.        
+0000cbc0: 2020 2020 2020 2020 7265 7475 726e 2054          return T
+0000cbd0: 7275 650a 0a20 2020 2020 2020 2072 6574  rue..        ret
+0000cbe0: 7572 6e20 4661 6c73 650a 0a20 2020 2064  urn False..    d
+0000cbf0: 6566 2069 735f 6578 636c 7564 6564 5f62  ef is_excluded_b
+0000cc00: 795f 7573 6572 2873 656c 662c 2064 6278  y_user(self, dbx
+0000cc10: 5f70 6174 685f 6c6f 7765 723a 2073 7472  _path_lower: str
+0000cc20: 2920 2d3e 2062 6f6f 6c3a 0a20 2020 2020  ) -> bool:.     
+0000cc30: 2020 2022 2222 0a20 2020 2020 2020 2043     """.        C
+0000cc40: 6865 636b 2069 6620 6669 6c65 2068 6173  heck if file has
+0000cc50: 2062 6565 6e20 6578 636c 7564 6564 2074   been excluded t
+0000cc60: 6872 6f75 6768 2022 7365 6c65 6374 6976  hrough "selectiv
+0000cc70: 6520 7379 6e63 2220 6279 2074 6865 2075  e sync" by the u
+0000cc80: 7365 722e 0a0a 2020 2020 2020 2020 3a70  ser...        :p
+0000cc90: 6172 616d 2064 6278 5f70 6174 685f 6c6f  aram dbx_path_lo
+0000cca0: 7765 723a 204e 6f72 6d61 6c69 7365 6420  wer: Normalised 
+0000ccb0: 6c6f 7765 7220 6361 7365 2044 726f 7062  lower case Dropb
+0000ccc0: 6f78 2070 6174 682e 0a20 2020 2020 2020  ox path..       
+0000ccd0: 203a 7265 7475 726e 733a 2057 6865 7468   :returns: Wheth
+0000cce0: 6572 2074 6865 2070 6174 6820 6973 2065  er the path is e
+0000ccf0: 7863 6c75 6465 6420 6672 6f6d 2064 6f77  xcluded from dow
+0000cd00: 6e6c 6f61 6420 7379 6e63 696e 6720 6279  nload syncing by
+0000cd10: 2074 6865 2075 7365 722e 0a20 2020 2020   the user..     
+0000cd20: 2020 2022 2222 0a20 2020 2020 2020 2072     """.        r
+0000cd30: 6574 7572 6e20 616e 7928 6973 5f65 7175  eturn any(is_equ
+0000cd40: 616c 5f6f 725f 6368 696c 6428 6462 785f  al_or_child(dbx_
+0000cd50: 7061 7468 5f6c 6f77 6572 2c20 7029 2066  path_lower, p) f
+0000cd60: 6f72 2070 2069 6e20 7365 6c66 2e65 7863  or p in self.exc
+0000cd70: 6c75 6465 645f 6974 656d 7329 0a0a 2020  luded_items)..  
+0000cd80: 2020 6465 6620 6973 5f6d 6967 6e6f 7265    def is_mignore
+0000cd90: 2873 656c 662c 2065 7665 6e74 3a20 5379  (self, event: Sy
+0000cda0: 6e63 4576 656e 7429 202d 3e20 626f 6f6c  ncEvent) -> bool
+0000cdb0: 3a0a 2020 2020 2020 2020 2222 220a 2020  :.        """.  
+0000cdc0: 2020 2020 2020 4368 6563 6b20 6966 206c        Check if l
+0000cdd0: 6f63 616c 2066 696c 6520 6368 616e 6765  ocal file change
+0000cde0: 2068 6173 2062 6565 6e20 6578 636c 7564   has been exclud
+0000cdf0: 6564 2062 7920 6120 6d69 676e 6f72 6520  ed by a mignore 
+0000ce00: 7061 7474 6572 6e2e 0a0a 2020 2020 2020  pattern...      
+0000ce10: 2020 3a70 6172 616d 2065 7665 6e74 3a20    :param event: 
+0000ce20: 5379 6e63 4576 656e 7420 666f 7220 6c6f  SyncEvent for lo
+0000ce30: 6361 6c20 6669 6c65 2065 7665 6e74 2e0a  cal file event..
+0000ce40: 2020 2020 2020 2020 3a72 6574 7572 6e73          :returns
+0000ce50: 3a20 5768 6574 6865 7220 7468 6520 7061  : Whether the pa
+0000ce60: 7468 2069 7320 6578 636c 7564 6564 2066  th is excluded f
+0000ce70: 726f 6d20 7570 6c6f 6164 2073 796e 6369  rom upload synci
+0000ce80: 6e67 2062 7920 7468 6520 7573 6572 2e0a  ng by the user..
+0000ce90: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
+0000cea0: 2020 2020 6966 206c 656e 2873 656c 662e      if len(self.
+0000ceb0: 6d69 676e 6f72 655f 7275 6c65 732e 7061  mignore_rules.pa
+0000cec0: 7474 6572 6e73 2920 3d3d 2030 3a0a 2020  tterns) == 0:.  
+0000ced0: 2020 2020 2020 2020 2020 7265 7475 726e            return
+0000cee0: 2046 616c 7365 0a0a 2020 2020 2020 2020   False..        
+0000cef0: 7265 7475 726e 2073 656c 662e 5f69 735f  return self._is_
+0000cf00: 6d69 676e 6f72 655f 7061 7468 280a 2020  mignore_path(.  
+0000cf10: 2020 2020 2020 2020 2020 6576 656e 742e            event.
+0000cf20: 6462 785f 7061 7468 2c20 6973 5f64 6972  dbx_path, is_dir
+0000cf30: 3d65 7665 6e74 2e69 735f 6469 7265 6374  =event.is_direct
+0000cf40: 6f72 790a 2020 2020 2020 2020 2920 616e  ory.        ) an
+0000cf50: 6420 6e6f 7420 7365 6c66 2e67 6574 5f6c  d not self.get_l
+0000cf60: 6f63 616c 5f72 6576 2865 7665 6e74 2e64  ocal_rev(event.d
+0000cf70: 6278 5f70 6174 685f 6c6f 7765 7229 0a0a  bx_path_lower)..
+0000cf80: 2020 2020 6465 6620 5f69 735f 6d69 676e      def _is_mign
+0000cf90: 6f72 655f 7061 7468 2873 656c 662c 2064  ore_path(self, d
+0000cfa0: 6278 5f70 6174 683a 2073 7472 2c20 6973  bx_path: str, is
+0000cfb0: 5f64 6972 3a20 626f 6f6c 203d 2046 616c  _dir: bool = Fal
+0000cfc0: 7365 2920 2d3e 2062 6f6f 6c3a 0a20 2020  se) -> bool:.   
+0000cfd0: 2020 2020 2072 656c 6174 6976 655f 7061       relative_pa
+0000cfe0: 7468 203d 2064 6278 5f70 6174 682e 6c73  th = dbx_path.ls
+0000cff0: 7472 6970 2822 2f22 290a 0a20 2020 2020  trip("/")..     
+0000d000: 2020 2069 6620 6973 5f64 6972 3a0a 2020     if is_dir:.  
+0000d010: 2020 2020 2020 2020 2020 7265 6c61 7469            relati
+0000d020: 7665 5f70 6174 6820 3d20 6622 7b72 656c  ve_path = f"{rel
+0000d030: 6174 6976 655f 7061 7468 7d2f 220a 2020  ative_path}/".  
+0000d040: 2020 2020 2020 7265 7475 726e 2073 656c        return sel
+0000d050: 662e 6d69 676e 6f72 655f 7275 6c65 732e  f.mignore_rules.
+0000d060: 6d61 7463 685f 6669 6c65 2872 656c 6174  match_file(relat
+0000d070: 6976 655f 7061 7468 290a 0a20 2020 2064  ive_path)..    d
+0000d080: 6566 205f 736c 6f77 5f64 6f77 6e28 7365  ef _slow_down(se
+0000d090: 6c66 2920 2d3e 204e 6f6e 653a 0a20 2020  lf) -> None:.   
+0000d0a0: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
+0000d0b0: 2050 6175 7365 7320 6966 2043 5055 2075   Pauses if CPU u
+0000d0c0: 7361 6765 2069 7320 746f 6f20 6869 6768  sage is too high
+0000d0d0: 2069 6620 6361 6c6c 6564 2066 726f 6d20   if called from 
+0000d0e0: 6f6e 6520 6f66 206f 7572 2074 6872 6561  one of our threa
+0000d0f0: 6420 706f 6f6c 732e 0a20 2020 2020 2020  d pools..       
+0000d100: 2022 2222 0a20 2020 2020 2020 2069 6620   """.        if 
+0000d110: 7365 6c66 2e5f 6d61 785f 6370 755f 7065  self._max_cpu_pe
+0000d120: 7263 656e 7420 3d3d 2031 3030 202a 2043  rcent == 100 * C
+0000d130: 5055 5f43 4f52 455f 434f 554e 543a 0a20  PU_CORE_COUNT:. 
+0000d140: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+0000d150: 6e0a 0a20 2020 2020 2020 2063 7075 5f75  n..        cpu_u
+0000d160: 7361 6765 203d 2063 7075 5f75 7361 6765  sage = cpu_usage
+0000d170: 5f70 6572 6365 6e74 2829 0a0a 2020 2020  _percent()..    
+0000d180: 2020 2020 6966 2063 7075 5f75 7361 6765      if cpu_usage
+0000d190: 203e 2073 656c 662e 5f6d 6178 5f63 7075   > self._max_cpu
+0000d1a0: 5f70 6572 6365 6e74 3a0a 2020 2020 2020  _percent:.      
+0000d1b0: 2020 2020 2020 7468 7265 6164 5f6e 616d        thread_nam
+0000d1c0: 6520 3d20 6375 7272 656e 745f 7468 7265  e = current_thre
+0000d1d0: 6164 2829 2e6e 616d 650a 2020 2020 2020  ad().name.      
+0000d1e0: 2020 2020 2020 7365 6c66 2e5f 6c6f 6767        self._logg
+0000d1f0: 6572 2e64 6562 7567 2866 227b 7468 7265  er.debug(f"{thre
+0000d200: 6164 5f6e 616d 657d 3a20 7b63 7075 5f75  ad_name}: {cpu_u
+0000d210: 7361 6765 7d25 2043 5055 2075 7361 6765  sage}% CPU usage
+0000d220: 202d 2074 6872 6f74 746c 696e 6722 290a   - throttling").
+0000d230: 0a20 2020 2020 2020 2020 2020 2077 6869  .            whi
+0000d240: 6c65 2063 7075 5f75 7361 6765 203e 2073  le cpu_usage > s
+0000d250: 656c 662e 5f6d 6178 5f63 7075 5f70 6572  elf._max_cpu_per
+0000d260: 6365 6e74 3a0a 2020 2020 2020 2020 2020  cent:.          
+0000d270: 2020 2020 2020 6370 755f 7573 6167 6520        cpu_usage 
+0000d280: 3d20 6370 755f 7573 6167 655f 7065 7263  = cpu_usage_perc
+0000d290: 656e 7428 302e 3520 2b20 3220 2a20 7261  ent(0.5 + 2 * ra
+0000d2a0: 6e64 6f6d 2e72 616e 646f 6d28 2929 0a0a  ndom.random())..
+0000d2b0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+0000d2c0: 2e5f 6c6f 6767 6572 2e64 6562 7567 280a  ._logger.debug(.
+0000d2d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d2e0: 6622 7b74 6872 6561 645f 6e61 6d65 7d3a  f"{thread_name}:
+0000d2f0: 207b 6370 755f 7573 6167 657d 2520 4350   {cpu_usage}% CP
+0000d300: 5520 7573 6167 6520 2d20 656e 6420 7468  U usage - end th
+0000d310: 726f 7474 6c69 6e67 220a 2020 2020 2020  rottling".      
+0000d320: 2020 2020 2020 290a 0a20 2020 2064 6566        )..    def
+0000d330: 2063 616e 6365 6c5f 7379 6e63 2873 656c   cancel_sync(sel
+0000d340: 6629 202d 3e20 4e6f 6e65 3a0a 2020 2020  f) -> None:.    
+0000d350: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
+0000d360: 5261 6973 6573 2061 203a 6578 633a 606d  Raises a :exc:`m
+0000d370: 6165 7374 7261 6c2e 6578 6365 7074 696f  aestral.exceptio
+0000d380: 6e73 2e43 616e 6365 6c6c 6564 4572 726f  ns.CancelledErro
+0000d390: 7260 2069 6e20 616c 6c20 7379 6e63 2074  r` in all sync t
+0000d3a0: 6872 6561 6473 2061 6e64 2077 6169 7473  hreads and waits
+0000d3b0: 0a20 2020 2020 2020 2066 6f72 2074 6865  .        for the
+0000d3c0: 6d20 746f 2073 6875 7420 646f 776e 2e0a  m to shut down..
+0000d3d0: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
+0000d3e0: 2020 2020 7365 6c66 2e5f 6361 6e63 656c      self._cancel
+0000d3f0: 5f72 6571 7565 7374 6564 2e73 6574 2829  _requested.set()
+0000d400: 0a0a 2020 2020 2020 2020 2320 5761 6974  ..        # Wait
+0000d410: 2075 6e74 696c 2077 6520 6361 6e20 6163   until we can ac
+0000d420: 7175 6972 6520 7468 6520 7379 6e63 206c  quire the sync l
+0000d430: 6f63 6b20 3d3e 2077 6520 6172 6520 6964  ock => we are id
+0000d440: 6c65 2e0a 2020 2020 2020 2020 7365 6c66  le..        self
+0000d450: 2e73 796e 635f 6c6f 636b 2e61 6371 7569  .sync_lock.acqui
+0000d460: 7265 2829 0a20 2020 2020 2020 2073 656c  re().        sel
+0000d470: 662e 7379 6e63 5f6c 6f63 6b2e 7265 6c65  f.sync_lock.rele
+0000d480: 6173 6528 290a 0a20 2020 2020 2020 2073  ase()..        s
+0000d490: 656c 662e 5f63 616e 6365 6c5f 7265 7175  elf._cancel_requ
+0000d4a0: 6573 7465 642e 636c 6561 7228 290a 0a20  ested.clear().. 
+0000d4b0: 2020 2020 2020 2073 656c 662e 5f6c 6f67         self._log
+0000d4c0: 6765 722e 696e 666f 2822 5379 6e63 2061  ger.info("Sync a
+0000d4d0: 626f 7274 6564 2229 0a0a 2020 2020 6465  borted")..    de
+0000d4e0: 6620 6275 7379 2873 656c 6629 202d 3e20  f busy(self) -> 
+0000d4f0: 626f 6f6c 3a0a 2020 2020 2020 2020 2222  bool:.        ""
+0000d500: 220a 2020 2020 2020 2020 4368 6563 6b73  ".        Checks
+0000d510: 2069 6620 7765 2061 7265 2063 7572 7265   if we are curre
+0000d520: 6e74 6c79 2073 796e 6369 6e67 2e0a 0a20  ntly syncing... 
+0000d530: 2020 2020 2020 203a 7265 7475 726e 733a         :returns:
+0000d540: 2060 6054 7275 6560 6020 6966 203a 6174   ``True`` if :at
+0000d550: 7472 3a60 7379 6e63 5f6c 6f63 6b60 2063  tr:`sync_lock` c
+0000d560: 616e 6e6f 7420 6265 2061 6371 7569 7265  annot be acquire
+0000d570: 642c 2060 6046 616c 7365 6060 206f 7468  d, ``False`` oth
+0000d580: 6572 7769 7365 2e0a 2020 2020 2020 2020  erwise..        
+0000d590: 2222 220a 2020 2020 2020 2020 6964 6c65  """.        idle
+0000d5a0: 203d 2073 656c 662e 7379 6e63 5f6c 6f63   = self.sync_loc
+0000d5b0: 6b2e 6163 7175 6972 6528 626c 6f63 6b69  k.acquire(blocki
+0000d5c0: 6e67 3d46 616c 7365 290a 2020 2020 2020  ng=False).      
+0000d5d0: 2020 6966 2069 646c 653a 0a20 2020 2020    if idle:.     
+0000d5e0: 2020 2020 2020 2073 656c 662e 7379 6e63         self.sync
+0000d5f0: 5f6c 6f63 6b2e 7265 6c65 6173 6528 290a  _lock.release().
+0000d600: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+0000d610: 6e6f 7420 6964 6c65 0a0a 2020 2020 6465  not idle..    de
+0000d620: 6620 5f68 616e 646c 655f 7379 6e63 5f65  f _handle_sync_e
+0000d630: 7272 6f72 2873 656c 662c 2065 7272 3a20  rror(self, err: 
+0000d640: 5379 6e63 4572 726f 722c 2064 6972 6563  SyncError, direc
+0000d650: 7469 6f6e 3a20 5379 6e63 4469 7265 6374  tion: SyncDirect
+0000d660: 696f 6e29 202d 3e20 4e6f 6e65 3a0a 2020  ion) -> None:.  
+0000d670: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
+0000d680: 2020 4861 6e64 6c65 7320 6120 7379 6e63    Handles a sync
+0000d690: 2065 7272 6f72 2e20 4669 6c6c 7320 6f75   error. Fills ou
+0000d6a0: 7420 616e 7920 6d69 7373 696e 6720 7061  t any missing pa
+0000d6b0: 7468 2069 6e66 6f72 6d61 7469 6f6e 2061  th information a
+0000d6c0: 6e64 2061 6464 7320 7468 6520 6572 726f  nd adds the erro
+0000d6d0: 720a 2020 2020 2020 2020 746f 2074 6865  r.        to the
+0000d6e0: 2070 6572 7369 7374 656e 7420 7374 6174   persistent stat
+0000d6f0: 6520 666f 7220 6c61 7465 7220 7265 7379  e for later resy
+0000d700: 6e63 2e0a 0a20 2020 2020 2020 203a 7061  nc...        :pa
+0000d710: 7261 6d20 6572 723a 2054 6865 2073 796e  ram err: The syn
+0000d720: 6320 6572 726f 7220 746f 2068 616e 646c  c error to handl
+0000d730: 652e 0a20 2020 2020 2020 203a 7061 7261  e..        :para
+0000d740: 6d20 6469 7265 6374 696f 6e3a 2054 6865  m direction: The
+0000d750: 2073 796e 6320 6469 7265 6374 696f 6e20   sync direction 
+0000d760: 2875 7020 6f72 2064 6f77 6e29 2066 6f72  (up or down) for
+0000d770: 2077 6869 6368 2074 6865 2065 7272 6f72   which the error
+0000d780: 206f 6363 7572 7265 642e 0a20 2020 2020   occurred..     
+0000d790: 2020 2022 2222 0a20 2020 2020 2020 2023     """.        #
+0000d7a0: 2046 696c 6c20 696e 206d 6973 7369 6e67   Fill in missing
+0000d7b0: 2064 6278 5f70 6174 6820 6f72 206c 6f63   dbx_path or loc
+0000d7c0: 616c 5f70 6174 682e 0a20 2020 2020 2020  al_path..       
+0000d7d0: 2069 6620 6572 722e 6462 785f 7061 7468   if err.dbx_path
+0000d7e0: 2061 6e64 206e 6f74 2065 7272 2e6c 6f63   and not err.loc
+0000d7f0: 616c 5f70 6174 683a 0a20 2020 2020 2020  al_path:.       
+0000d800: 2020 2020 2065 7272 2e6c 6f63 616c 5f70       err.local_p
+0000d810: 6174 6820 3d20 7365 6c66 2e74 6f5f 6c6f  ath = self.to_lo
+0000d820: 6361 6c5f 7061 7468 5f66 726f 6d5f 6361  cal_path_from_ca
+0000d830: 7365 6428 6572 722e 6462 785f 7061 7468  sed(err.dbx_path
+0000d840: 290a 2020 2020 2020 2020 6966 2065 7272  ).        if err
+0000d850: 2e6c 6f63 616c 5f70 6174 6820 616e 6420  .local_path and 
+0000d860: 6e6f 7420 6572 722e 6462 785f 7061 7468  not err.dbx_path
+0000d870: 3a0a 2020 2020 2020 2020 2020 2020 6572  :.            er
+0000d880: 722e 6462 785f 7061 7468 203d 2073 656c  r.dbx_path = sel
+0000d890: 662e 746f 5f64 6278 5f70 6174 6828 6572  f.to_dbx_path(er
+0000d8a0: 722e 6c6f 6361 6c5f 7061 7468 290a 0a20  r.local_path).. 
+0000d8b0: 2020 2020 2020 2023 2046 696c 6c20 696e         # Fill in
+0000d8c0: 206d 6973 7369 6e67 2064 6278 5f70 6174   missing dbx_pat
+0000d8d0: 685f 6672 6f6d 206f 7220 6c6f 6361 6c5f  h_from or local_
+0000d8e0: 7061 7468 5f66 726f 6d2e 0a20 2020 2020  path_from..     
+0000d8f0: 2020 2069 6620 6572 722e 6462 785f 7061     if err.dbx_pa
+0000d900: 7468 5f66 726f 6d20 616e 6420 6e6f 7420  th_from and not 
+0000d910: 6572 722e 6c6f 6361 6c5f 7061 7468 5f66  err.local_path_f
+0000d920: 726f 6d3a 0a20 2020 2020 2020 2020 2020  rom:.           
+0000d930: 2065 7272 2e6c 6f63 616c 5f70 6174 685f   err.local_path_
+0000d940: 6672 6f6d 203d 2073 656c 662e 746f 5f6c  from = self.to_l
+0000d950: 6f63 616c 5f70 6174 685f 6672 6f6d 5f63  ocal_path_from_c
+0000d960: 6173 6564 2865 7272 2e64 6278 5f70 6174  ased(err.dbx_pat
+0000d970: 685f 6672 6f6d 290a 2020 2020 2020 2020  h_from).        
+0000d980: 6966 2065 7272 2e6c 6f63 616c 5f70 6174  if err.local_pat
+0000d990: 685f 6672 6f6d 2061 6e64 206e 6f74 2065  h_from and not e
+0000d9a0: 7272 2e64 6278 5f70 6174 685f 6672 6f6d  rr.dbx_path_from
+0000d9b0: 3a0a 2020 2020 2020 2020 2020 2020 6572  :.            er
+0000d9c0: 722e 6462 785f 7061 7468 5f66 726f 6d20  r.dbx_path_from 
+0000d9d0: 3d20 7365 6c66 2e74 6f5f 6462 785f 7061  = self.to_dbx_pa
+0000d9e0: 7468 2865 7272 2e6c 6f63 616c 5f70 6174  th(err.local_pat
+0000d9f0: 685f 6672 6f6d 290a 0a20 2020 2020 2020  h_from)..       
+0000da00: 2069 6620 6e6f 7420 6572 722e 6462 785f   if not err.dbx_
+0000da10: 7061 7468 3a0a 2020 2020 2020 2020 2020  path:.          
+0000da20: 2020 7261 6973 6520 5661 6c75 6545 7272    raise ValueErr
+0000da30: 6f72 2822 5379 6e63 2065 7272 6f72 2068  or("Sync error h
+0000da40: 6173 2061 6e20 756e 6b6e 6f77 6e20 7061  as an unknown pa
+0000da50: 7468 2229 0a0a 2020 2020 2020 2020 7072  th")..        pr
+0000da60: 696e 7461 626c 655f 6669 6c65 5f6e 616d  intable_file_nam
+0000da70: 6520 3d20 7361 6e69 7469 7a65 5f73 7472  e = sanitize_str
+0000da80: 696e 6728 6f73 702e 6261 7365 6e61 6d65  ing(osp.basename
+0000da90: 2865 7272 2e64 6278 5f70 6174 6829 290a  (err.dbx_path)).
+0000daa0: 0a20 2020 2020 2020 2073 656c 662e 5f6c  .        self._l
+0000dab0: 6f67 6765 722e 696e 666f 2822 436f 756c  ogger.info("Coul
+0000dac0: 6420 6e6f 7420 7379 6e63 2025 7322 2c20  d not sync %s", 
+0000dad0: 7072 696e 7461 626c 655f 6669 6c65 5f6e  printable_file_n
+0000dae0: 616d 652c 2065 7863 5f69 6e66 6f3d 5472  ame, exc_info=Tr
+0000daf0: 7565 290a 0a20 2020 2020 2020 2064 6566  ue)..        def
+0000db00: 2063 616c 6c62 6163 6b28 2920 2d3e 204e   callback() -> N
+0000db10: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
+0000db20: 2069 6620 6572 722e 6c6f 6361 6c5f 7061   if err.local_pa
+0000db30: 7468 3a0a 2020 2020 2020 2020 2020 2020  th:.            
+0000db40: 2020 2020 636c 6963 6b2e 6c61 756e 6368      click.launch
+0000db50: 2865 7272 2e6c 6f63 616c 5f70 6174 682c  (err.local_path,
+0000db60: 206c 6f63 6174 653d 5472 7565 290a 2020   locate=True).  
+0000db70: 2020 2020 2020 2020 2020 656c 6966 2065            elif e
+0000db80: 7272 2e64 6278 5f70 6174 683a 0a20 2020  rr.dbx_path:.   
+0000db90: 2020 2020 2020 2020 2020 2020 2075 726c               url
+0000dba0: 5f70 6174 6820 3d20 7572 6c6c 6962 2e70  _path = urllib.p
+0000dbb0: 6172 7365 2e71 756f 7465 2865 7272 2e64  arse.quote(err.d
+0000dbc0: 6278 5f70 6174 6829 0a20 2020 2020 2020  bx_path).       
+0000dbd0: 2020 2020 2020 2020 2063 6c69 636b 2e6c           click.l
+0000dbe0: 6175 6e63 6828 6622 6874 7470 733a 2f2f  aunch(f"https://
+0000dbf0: 7777 772e 6472 6f70 626f 782e 636f 6d2f  www.dropbox.com/
+0000dc00: 7072 6576 6965 777b 7572 6c5f 7061 7468  preview{url_path
+0000dc10: 7d22 290a 0a20 2020 2020 2020 2069 6620  }")..        if 
+0000dc20: 7365 6c66 2e64 6573 6b74 6f70 5f6e 6f74  self.desktop_not
+0000dc30: 6966 6965 723a 0a20 2020 2020 2020 2020  ifier:.         
+0000dc40: 2020 2073 656c 662e 6465 736b 746f 705f     self.desktop_
+0000dc50: 6e6f 7469 6669 6572 2e6e 6f74 6966 7928  notifier.notify(
+0000dc60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000dc70: 2022 5379 6e63 2065 7272 6f72 222c 0a20   "Sync error",. 
+0000dc80: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+0000dc90: 2243 6f75 6c64 206e 6f74 207b 6469 7265  "Could not {dire
+0000dca0: 6374 696f 6e2e 7661 6c75 657d 6c6f 6164  ction.value}load
+0000dcb0: 207b 7072 696e 7461 626c 655f 6669 6c65   {printable_file
+0000dcc0: 5f6e 616d 657d 222c 0a20 2020 2020 2020  _name}",.       
+0000dcd0: 2020 2020 2020 2020 206c 6576 656c 3d6e           level=n
+0000dce0: 6f74 6966 792e 5359 4e43 4953 5355 452c  otify.SYNCISSUE,
+0000dcf0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000dd00: 2061 6374 696f 6e73 3d7b 2253 686f 7722   actions={"Show"
+0000dd10: 3a20 6361 6c6c 6261 636b 7d2c 0a20 2020  : callback},.   
+0000dd20: 2020 2020 2020 2020 2020 2020 206f 6e5f               on_
+0000dd30: 636c 6963 6b3d 6361 6c6c 6261 636b 2c0a  click=callback,.
+0000dd40: 2020 2020 2020 2020 2020 2020 290a 0a20              ).. 
+0000dd50: 2020 2020 2020 2023 2053 6176 6520 7379         # Save sy
+0000dd60: 6e63 2065 7272 6f72 7320 746f 2072 6574  nc errors to ret
+0000dd70: 7279 206c 6174 6572 2e0a 0a20 2020 2020  ry later...     
+0000dd80: 2020 2064 6278 5f70 6174 685f 6c6f 7765     dbx_path_lowe
+0000dd90: 7220 3d20 6e6f 726d 616c 697a 6528 6572  r = normalize(er
+0000dda0: 722e 6462 785f 7061 7468 290a 2020 2020  r.dbx_path).    
+0000ddb0: 2020 2020 6966 2065 7272 2e64 6278 5f70      if err.dbx_p
+0000ddc0: 6174 685f 6672 6f6d 3a0a 2020 2020 2020  ath_from:.      
+0000ddd0: 2020 2020 2020 6462 785f 7061 7468 5f66        dbx_path_f
+0000dde0: 726f 6d5f 6c6f 7765 7220 3d20 6e6f 726d  rom_lower = norm
+0000ddf0: 616c 697a 6528 6572 722e 6462 785f 7061  alize(err.dbx_pa
+0000de00: 7468 5f66 726f 6d29 0a20 2020 2020 2020  th_from).       
+0000de10: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+0000de20: 2020 2064 6278 5f70 6174 685f 6672 6f6d     dbx_path_from
+0000de30: 5f6c 6f77 6572 203d 204e 6f6e 650a 0a20  _lower = None.. 
+0000de40: 2020 2020 2020 2077 6974 6820 7365 6c66         with self
+0000de50: 2e5f 6461 7461 6261 7365 5f61 6363 6573  ._database_acces
+0000de60: 7328 293a 0a20 2020 2020 2020 2020 2020  s():.           
+0000de70: 2073 656c 662e 5f73 796e 635f 6572 726f   self._sync_erro
+0000de80: 7273 5f74 6162 6c65 2e75 7064 6174 6528  rs_table.update(
+0000de90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000dea0: 2053 796e 6345 7272 6f72 456e 7472 7928   SyncErrorEntry(
+0000deb0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000dec0: 2020 2020 2064 6278 5f70 6174 683d 6572       dbx_path=er
+0000ded0: 722e 6462 785f 7061 7468 2c0a 2020 2020  r.dbx_path,.    
+0000dee0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000def0: 6462 785f 7061 7468 5f6c 6f77 6572 3d64  dbx_path_lower=d
+0000df00: 6278 5f70 6174 685f 6c6f 7765 722c 0a20  bx_path_lower,. 
+0000df10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000df20: 2020 2064 6278 5f70 6174 685f 6672 6f6d     dbx_path_from
+0000df30: 3d65 7272 2e64 6278 5f70 6174 685f 6672  =err.dbx_path_fr
+0000df40: 6f6d 2c0a 2020 2020 2020 2020 2020 2020  om,.            
+0000df50: 2020 2020 2020 2020 6462 785f 7061 7468          dbx_path
+0000df60: 5f66 726f 6d5f 6c6f 7765 723d 6462 785f  _from_lower=dbx_
+0000df70: 7061 7468 5f66 726f 6d5f 6c6f 7765 722c  path_from_lower,
+0000df80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000df90: 2020 2020 206c 6f63 616c 5f70 6174 683d       local_path=
+0000dfa0: 6572 722e 6c6f 6361 6c5f 7061 7468 2c0a  err.local_path,.
+0000dfb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000dfc0: 2020 2020 6c6f 6361 6c5f 7061 7468 5f66      local_path_f
+0000dfd0: 726f 6d3d 6572 722e 6c6f 6361 6c5f 7061  rom=err.local_pa
+0000dfe0: 7468 5f66 726f 6d2c 0a20 2020 2020 2020  th_from,.       
+0000dff0: 2020 2020 2020 2020 2020 2020 2064 6972               dir
+0000e000: 6563 7469 6f6e 3d64 6972 6563 7469 6f6e  ection=direction
+0000e010: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0000e020: 2020 2020 2020 7469 746c 653d 6572 722e        title=err.
+0000e030: 7469 746c 652c 0a20 2020 2020 2020 2020  title,.         
+0000e040: 2020 2020 2020 2020 2020 206d 6573 7361             messa
+0000e050: 6765 3d65 7272 2e6d 6573 7361 6765 2c0a  ge=err.message,.
+0000e060: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e070: 2020 2020 7479 7065 3d65 7272 2e5f 5f63      type=err.__c
+0000e080: 6c61 7373 5f5f 2e5f 5f6e 616d 655f 5f2c  lass__.__name__,
+0000e090: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000e0a0: 2029 0a20 2020 2020 2020 2020 2020 2029   ).            )
+0000e0b0: 0a0a 2020 2020 4063 6f6e 7465 7874 6d61  ..    @contextma
+0000e0c0: 6e61 6765 720a 2020 2020 6465 6620 5f64  nager.    def _d
+0000e0d0: 6174 6162 6173 655f 6163 6365 7373 2873  atabase_access(s
+0000e0e0: 656c 662c 2072 6169 7365 5f65 7272 6f72  elf, raise_error
+0000e0f0: 3a20 626f 6f6c 203d 2054 7275 6529 202d  : bool = True) -
+0000e100: 3e20 4974 6572 6174 6f72 5b4e 6f6e 655d  > Iterator[None]
+0000e110: 3a0a 2020 2020 2020 2020 2222 220a 2020  :.        """.  
+0000e120: 2020 2020 2020 4120 636f 6e74 6578 7420        A context 
+0000e130: 6d61 6e61 6765 7220 746f 2073 796e 6368  manager to synch
+0000e140: 726f 6e69 7365 7320 6163 6365 7373 2074  ronises access t
+0000e150: 6f20 7468 6520 5351 4c69 7465 2064 6174  o the SQLite dat
+0000e160: 6162 6173 652e 2043 6174 6368 6573 0a20  abase. Catches. 
+0000e170: 2020 2020 2020 2065 7863 6570 7469 6f6e         exception
+0000e180: 7320 7261 6973 6564 2062 7920 7371 6c69  s raised by sqli
+0000e190: 7465 3320 616e 6420 636f 6e76 6572 7473  te3 and converts
+0000e1a0: 2074 6865 6d20 746f 2061 204d 6165 7374   them to a Maest
+0000e1b0: 7261 6c41 7069 4572 726f 7220 6966 2077  ralApiError if w
+0000e1c0: 6520 6b6e 6f77 0a20 2020 2020 2020 2068  e know.        h
+0000e1d0: 6f77 2074 6f20 6861 6e64 6c65 2074 6865  ow to handle the
+0000e1e0: 6d2e 0a0a 2020 2020 2020 2020 3a70 6172  m...        :par
+0000e1f0: 616d 2072 6169 7365 5f65 7272 6f72 3a20  am raise_error: 
+0000e200: 5768 6574 6865 7220 6572 726f 7273 2073  Whether errors s
+0000e210: 686f 756c 6420 6265 2072 6169 7365 6420  hould be raised 
+0000e220: 6f72 206c 6f67 6765 642e 0a20 2020 2020  or logged..     
+0000e230: 2020 2022 2222 0a20 2020 2020 2020 2074     """.        t
+0000e240: 6974 6c65 203d 2022 220a 2020 2020 2020  itle = "".      
+0000e250: 2020 6d73 6720 3d20 2222 0a20 2020 2020    msg = "".     
+0000e260: 2020 206e 6577 5f65 7863 203d 204e 6f6e     new_exc = Non
+0000e270: 650a 0a20 2020 2020 2020 2074 7279 3a0a  e..        try:.
+0000e280: 2020 2020 2020 2020 2020 2020 7769 7468              with
+0000e290: 2073 656c 662e 5f64 625f 6c6f 636b 3a0a   self._db_lock:.
+0000e2a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e2b0: 7969 656c 640a 2020 2020 2020 2020 6578  yield.        ex
+0000e2c0: 6365 7074 2073 716c 6974 6533 2e4f 7065  cept sqlite3.Ope
+0000e2d0: 7261 7469 6f6e 616c 4572 726f 7220 6173  rationalError as
+0000e2e0: 2065 7863 3a0a 2020 2020 2020 2020 2020   exc:.          
+0000e2f0: 2020 7469 746c 6520 3d20 2244 6174 6162    title = "Datab
+0000e300: 6173 6520 7472 616e 7361 6374 696f 6e20  ase transaction 
+0000e310: 6572 726f 7222 0a20 2020 2020 2020 2020  error".         
+0000e320: 2020 206d 7367 203d 2028 0a20 2020 2020     msg = (.     
+0000e330: 2020 2020 2020 2020 2020 2066 2754 6865             f'The
+0000e340: 2069 6e64 6578 2066 696c 6520 6174 2022   index file at "
+0000e350: 7b73 656c 662e 5f64 625f 7061 7468 7d22  {self._db_path}"
+0000e360: 2063 616e 6e6f 7420 6265 2072 6561 642e   cannot be read.
+0000e370: 2027 0a20 2020 2020 2020 2020 2020 2020   '.             
+0000e380: 2020 2022 506c 6561 7365 2063 6865 636b     "Please check
+0000e390: 2074 6861 7420 796f 7520 6861 7665 2073   that you have s
+0000e3a0: 7566 6669 6369 656e 7420 7065 726d 6973  ufficient permis
+0000e3b0: 7369 6f6e 7320 616e 6420 220a 2020 2020  sions and ".    
+0000e3c0: 2020 2020 2020 2020 2020 2020 2272 6573              "res
+0000e3d0: 7461 7274 204d 6165 7374 7261 6c20 746f  tart Maestral to
+0000e3e0: 2063 6f6e 7469 6e75 6520 7379 6e63 696e   continue syncin
+0000e3f0: 672e 220a 2020 2020 2020 2020 2020 2020  g.".            
+0000e400: 290a 2020 2020 2020 2020 2020 2020 6e65  ).            ne
+0000e410: 775f 6578 6320 3d20 4461 7461 6261 7365  w_exc = Database
+0000e420: 4572 726f 7228 7469 746c 652c 206d 7367  Error(title, msg
+0000e430: 292e 7769 7468 5f74 7261 6365 6261 636b  ).with_traceback
+0000e440: 2865 7863 2e5f 5f74 7261 6365 6261 636b  (exc.__traceback
+0000e450: 5f5f 290a 2020 2020 2020 2020 6578 6365  __).        exce
+0000e460: 7074 2073 716c 6974 6533 2e49 6e74 6567  pt sqlite3.Integ
+0000e470: 7269 7479 4572 726f 7220 6173 2065 7863  rityError as exc
+0000e480: 3a0a 2020 2020 2020 2020 2020 2020 7469  :.            ti
+0000e490: 746c 6520 3d20 2244 6174 6162 6173 6520  tle = "Database 
+0000e4a0: 696e 7465 6772 6974 7920 6572 726f 7222  integrity error"
+0000e4b0: 0a20 2020 2020 2020 2020 2020 206d 7367  .            msg
+0000e4c0: 203d 2022 506c 6561 7365 2072 6573 7461   = "Please resta
+0000e4d0: 7274 204d 6165 7374 7261 6c20 746f 2063  rt Maestral to c
+0000e4e0: 6f6e 7469 6e75 6520 7379 6e63 696e 672e  ontinue syncing.
+0000e4f0: 220a 2020 2020 2020 2020 2020 2020 6e65  ".            ne
+0000e500: 775f 6578 6320 3d20 4461 7461 6261 7365  w_exc = Database
+0000e510: 4572 726f 7228 7469 746c 652c 206d 7367  Error(title, msg
+0000e520: 292e 7769 7468 5f74 7261 6365 6261 636b  ).with_traceback
+0000e530: 2865 7863 2e5f 5f74 7261 6365 6261 636b  (exc.__traceback
+0000e540: 5f5f 290a 2020 2020 2020 2020 6578 6365  __).        exce
+0000e550: 7074 2073 716c 6974 6533 2e44 6174 6162  pt sqlite3.Datab
+0000e560: 6173 6545 7272 6f72 2061 7320 6578 633a  aseError as exc:
+0000e570: 0a20 2020 2020 2020 2020 2020 2074 6974  .            tit
+0000e580: 6c65 203d 2022 4461 7461 6261 7365 2074  le = "Database t
+0000e590: 7261 6e73 6163 7469 6f6e 2065 7272 6f72  ransaction error
+0000e5a0: 220a 2020 2020 2020 2020 2020 2020 6d73  ".            ms
+0000e5b0: 6720 3d20 280a 2020 2020 2020 2020 2020  g = (.          
+0000e5c0: 2020 2020 2020 2250 6c65 6173 6520 7265        "Please re
+0000e5d0: 7374 6172 7420 4d61 6573 7472 616c 2074  start Maestral t
+0000e5e0: 6f20 636f 6e74 696e 7565 2073 796e 6369  o continue synci
+0000e5f0: 6e67 2e20 220a 2020 2020 2020 2020 2020  ng. ".          
+0000e600: 2020 2020 2020 2252 6562 7569 6c64 2074        "Rebuild t
+0000e610: 6865 2069 6e64 6578 2069 6620 7468 6973  he index if this
+0000e620: 2069 7373 7565 2070 6572 7369 7374 732e   issue persists.
+0000e630: 220a 2020 2020 2020 2020 2020 2020 290a  ".            ).
+0000e640: 2020 2020 2020 2020 2020 2020 6e65 775f              new_
+0000e650: 6578 6320 3d20 4461 7461 6261 7365 4572  exc = DatabaseEr
+0000e660: 726f 7228 7469 746c 652c 206d 7367 292e  ror(title, msg).
+0000e670: 7769 7468 5f74 7261 6365 6261 636b 2865  with_traceback(e
+0000e680: 7863 2e5f 5f74 7261 6365 6261 636b 5f5f  xc.__traceback__
+0000e690: 290a 0a20 2020 2020 2020 2069 6620 6e65  )..        if ne
+0000e6a0: 775f 6578 633a 0a20 2020 2020 2020 2020  w_exc:.         
+0000e6b0: 2020 2069 6620 7261 6973 655f 6572 726f     if raise_erro
+0000e6c0: 723a 0a20 2020 2020 2020 2020 2020 2020  r:.             
+0000e6d0: 2020 2072 6169 7365 206e 6577 5f65 7863     raise new_exc
+0000e6e0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+0000e6f0: 662e 5f6c 6f67 6765 722e 6572 726f 7228  f._logger.error(
+0000e700: 7469 746c 652c 2065 7863 5f69 6e66 6f3d  title, exc_info=
+0000e710: 6578 635f 696e 666f 5f74 7570 6c65 286e  exc_info_tuple(n
+0000e720: 6577 5f65 7863 2929 0a20 2020 2020 2020  ew_exc)).       
+0000e730: 2020 2020 2069 6620 7365 6c66 2e64 6573       if self.des
+0000e740: 6b74 6f70 5f6e 6f74 6966 6965 723a 0a20  ktop_notifier:. 
+0000e750: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+0000e760: 656c 662e 6465 736b 746f 705f 6e6f 7469  elf.desktop_noti
+0000e770: 6669 6572 2e6e 6f74 6966 7928 7469 746c  fier.notify(titl
+0000e780: 652c 206d 7367 2c20 6c65 7665 6c3d 6e6f  e, msg, level=no
+0000e790: 7469 6679 2e45 5252 4f52 290a 0a20 2020  tify.ERROR)..   
+0000e7a0: 2064 6566 205f 636c 6561 725f 6361 6368   def _clear_cach
+0000e7b0: 6573 2873 656c 6629 202d 3e20 4e6f 6e65  es(self) -> None
+0000e7c0: 3a0a 2020 2020 2020 2020 2222 220a 2020  :.        """.  
+0000e7d0: 2020 2020 2020 4672 6565 7320 6d65 6d6f        Frees memo
+0000e7e0: 7279 2062 7920 636c 6561 7269 6e67 2069  ry by clearing i
+0000e7f0: 6e74 6572 6e61 6c20 6361 6368 6573 2e0a  nternal caches..
+0000e800: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
+0000e810: 2020 2020 7365 6c66 2e5f 6361 7365 5f63      self._case_c
+0000e820: 6f6e 7665 7273 696f 6e5f 6361 6368 652e  onversion_cache.
+0000e830: 636c 6561 7228 290a 2020 2020 2020 2020  clear().        
+0000e840: 7365 6c66 2e66 735f 6576 656e 7473 2e65  self.fs_events.e
+0000e850: 7870 6972 655f 6967 6e6f 7265 645f 6576  xpire_ignored_ev
+0000e860: 656e 7473 2829 0a0a 2020 2020 6465 6620  ents()..    def 
+0000e870: 5f73 796e 635f 6576 656e 745f 6672 6f6d  _sync_event_from
+0000e880: 5f66 735f 6576 656e 7428 7365 6c66 2c20  _fs_event(self, 
+0000e890: 6673 5f65 7665 6e74 3a20 4669 6c65 5379  fs_event: FileSy
+0000e8a0: 7374 656d 4576 656e 7429 202d 3e20 5379  stemEvent) -> Sy
+0000e8b0: 6e63 4576 656e 743a 0a20 2020 2020 2020  ncEvent:.       
+0000e8c0: 2072 6574 7572 6e20 5379 6e63 4576 656e   return SyncEven
+0000e8d0: 742e 6672 6f6d 5f66 696c 655f 7379 7374  t.from_file_syst
+0000e8e0: 656d 5f65 7665 6e74 2866 735f 6576 656e  em_event(fs_even
+0000e8f0: 742c 2073 656c 6629 0a0a 2020 2020 6465  t, self)..    de
+0000e900: 6620 5f73 796e 635f 6576 656e 7473 5f66  f _sync_events_f
+0000e910: 726f 6d5f 6673 5f65 7665 6e74 7328 0a20  rom_fs_events(. 
+0000e920: 2020 2020 2020 2073 656c 662c 2066 735f         self, fs_
+0000e930: 6576 656e 7473 3a20 436f 6c6c 6563 7469  events: Collecti
+0000e940: 6f6e 5b46 696c 6553 7973 7465 6d45 7665  on[FileSystemEve
+0000e950: 6e74 5d0a 2020 2020 2920 2d3e 206c 6973  nt].    ) -> lis
+0000e960: 745b 5379 6e63 4576 656e 745d 3a0a 2020  t[SyncEvent]:.  
+0000e970: 2020 2020 2020 2222 2243 6f6e 7665 7274        """Convert
+0000e980: 206c 6f63 616c 2066 696c 6520 7379 7374   local file syst
+0000e990: 656d 2065 7665 6e74 7320 746f 2073 796e  em events to syn
+0000e9a0: 6320 6576 656e 7473 2e20 5468 6973 2069  c events. This i
+0000e9b0: 7320 646f 6e65 2069 6e20 6120 7468 7265  s done in a thre
+0000e9c0: 6164 0a20 2020 2020 2020 2070 6f6f 6c20  ad.        pool 
+0000e9d0: 746f 2070 6172 616c 6c65 6c69 7a65 2063  to parallelize c
+0000e9e0: 6f6e 7465 6e74 2068 6173 6869 6e67 2e22  ontent hashing."
+0000e9f0: 2222 0a20 2020 2020 2020 2072 6573 203d  "".        res =
+0000ea00: 2064 6f5f 7061 7261 6c6c 656c 280a 2020   do_parallel(.  
+0000ea10: 2020 2020 2020 2020 2020 7365 6c66 2e5f            self._
+0000ea20: 7379 6e63 5f65 7665 6e74 5f66 726f 6d5f  sync_event_from_
+0000ea30: 6673 5f65 7665 6e74 2c0a 2020 2020 2020  fs_event,.      
+0000ea40: 2020 2020 2020 6673 5f65 7665 6e74 732c        fs_events,
+0000ea50: 0a20 2020 2020 2020 2020 2020 2074 6872  .            thr
+0000ea60: 6561 645f 6e61 6d65 5f70 7265 6669 783d  ead_name_prefix=
+0000ea70: 226d 6165 7374 7261 6c2d 6c6f 6361 6c2d  "maestral-local-
+0000ea80: 696e 6465 7865 7222 2c0a 2020 2020 2020  indexer",.      
+0000ea90: 2020 290a 2020 2020 2020 2020 7265 7475    ).        retu
+0000eaa0: 726e 206c 6973 7428 7265 7329 0a0a 2020  rn list(res)..  
+0000eab0: 2020 2320 3d3d 3d3d 2055 706c 6f61 6420    # ==== Upload 
+0000eac0: 7379 6e63 203d 3d3d 3d3d 3d3d 3d3d 3d3d  sync ===========
+0000ead0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0000eae0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0000eaf0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0000eb00: 3d3d 3d3d 3d3d 0a0a 2020 2020 6465 6620  ======..    def 
+0000eb10: 7570 6c6f 6164 5f6c 6f63 616c 5f63 6861  upload_local_cha
+0000eb20: 6e67 6573 5f77 6869 6c65 5f69 6e61 6374  nges_while_inact
+0000eb30: 6976 6528 7365 6c66 2920 2d3e 204e 6f6e  ive(self) -> Non
+0000eb40: 653a 0a20 2020 2020 2020 2022 2222 0a20  e:.        """. 
+0000eb50: 2020 2020 2020 2043 6f6c 6c65 6374 7320         Collects 
+0000eb60: 6368 616e 6765 7320 7768 696c 6520 7379  changes while sy
+0000eb70: 6e63 2068 6173 206e 6f74 2062 6565 6e20  nc has not been 
+0000eb80: 7275 6e6e 696e 6720 616e 6420 7570 6c6f  running and uplo
+0000eb90: 6164 7320 7468 656d 2074 6f20 4472 6f70  ads them to Drop
+0000eba0: 626f 782e 0a20 2020 2020 2020 2043 616c  box..        Cal
+0000ebb0: 6c20 7468 6973 206d 6574 686f 6420 7768  l this method wh
+0000ebc0: 656e 2072 6573 756d 696e 6720 7379 6e63  en resuming sync
+0000ebd0: 2e0a 2020 2020 2020 2020 2222 220a 2020  ..        """.  
+0000ebe0: 2020 2020 2020 7769 7468 2073 656c 662e        with self.
+0000ebf0: 7379 6e63 5f6c 6f63 6b3a 0a20 2020 2020  sync_lock:.     
+0000ec00: 2020 2020 2020 2023 2044 656c 6574 6520         # Delete 
+0000ec10: 7570 6c6f 6164 2073 796e 6320 6572 726f  upload sync erro
+0000ec20: 7273 2062 6566 6f72 6520 7374 6172 7469  rs before starti
+0000ec30: 6e67 2069 6e64 6578 696e 672e 2054 6869  ng indexing. Thi
+0000ec40: 7320 7072 6576 656e 7473 2065 7272 6f72  s prevents error
+0000ec50: 730a 2020 2020 2020 2020 2020 2020 2320  s.            # 
+0000ec60: 6672 6f6d 206e 6f77 2064 656c 6574 6564  from now deleted
+0000ec70: 206f 7220 6967 6e6f 7265 6420 282e 6d69   or ignored (.mi
+0000ec80: 676e 6f72 6529 2069 7465 6d73 2066 726f  gnore) items fro
+0000ec90: 6d20 6c69 6e67 6572 696e 6720 6f6e 2e20  m lingering on. 
+0000eca0: 416c 6c20 6f74 6865 720a 2020 2020 2020  All other.      
+0000ecb0: 2020 2020 2020 2320 7379 6e63 2065 7272        # sync err
+0000ecc0: 6f72 7320 7769 6c6c 2062 6520 7265 7472  ors will be retr
+0000ecd0: 6965 6420 6175 746f 6d61 7469 6361 6c6c  ied automaticall
+0000ece0: 7920 6279 2063 6f6d 7061 7269 6e67 206c  y by comparing l
+0000ecf0: 6f63 616c 2069 7465 6d73 2061 6761 696e  ocal items again
+0000ed00: 7374 0a20 2020 2020 2020 2020 2020 2023  st.            #
+0000ed10: 206f 7572 2069 6e64 6578 2e0a 2020 2020   our index..    
+0000ed20: 2020 2020 2020 2020 7365 6c66 2e5f 6c6f          self._lo
+0000ed30: 6767 6572 2e64 6562 7567 2822 5072 756e  gger.debug("Prun
+0000ed40: 696e 6720 7379 6e63 2065 7272 6f72 7322  ing sync errors"
+0000ed50: 290a 0a20 2020 2020 2020 2020 2020 2077  )..            w
+0000ed60: 6974 6820 7365 6c66 2e5f 6461 7461 6261  ith self._databa
+0000ed70: 7365 5f61 6363 6573 7328 293a 0a20 2020  se_access():.   
+0000ed80: 2020 2020 2020 2020 2020 2020 2071 7565               que
+0000ed90: 7279 203d 204d 6174 6368 5175 6572 7928  ry = MatchQuery(
+0000eda0: 5379 6e63 4572 726f 7245 6e74 7279 2e64  SyncErrorEntry.d
+0000edb0: 6972 6563 7469 6f6e 2c20 5379 6e63 4469  irection, SyncDi
+0000edc0: 7265 6374 696f 6e2e 5570 290a 2020 2020  rection.Up).    
+0000edd0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+0000ede0: 2e5f 7379 6e63 5f65 7272 6f72 735f 7461  ._sync_errors_ta
+0000edf0: 626c 652e 6465 6c65 7465 2871 7565 7279  ble.delete(query
+0000ee00: 290a 0a20 2020 2020 2020 2020 2020 2073  )..            s
+0000ee10: 656c 662e 5f6c 6f67 6765 722e 696e 666f  elf._logger.info
+0000ee20: 2822 496e 6465 7869 6e67 206c 6f63 616c  ("Indexing local
+0000ee30: 2063 6861 6e67 6573 2e2e 2e22 290a 0a20   changes...").. 
+0000ee40: 2020 2020 2020 2020 2020 2074 7279 3a0a             try:.
+0000ee50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ee60: 6576 656e 7473 2c20 6c6f 6361 6c5f 6375  events, local_cu
+0000ee70: 7273 6f72 203d 2073 656c 662e 5f67 6574  rsor = self._get
+0000ee80: 5f6c 6f63 616c 5f63 6861 6e67 6573 5f77  _local_changes_w
+0000ee90: 6869 6c65 5f69 6e61 6374 6976 6528 290a  hile_inactive().
+0000eea0: 2020 2020 2020 2020 2020 2020 6578 6365              exce
+0000eeb0: 7074 204f 5345 7272 6f72 2061 7320 6572  pt OSError as er
+0000eec0: 723a 0a20 2020 2020 2020 2020 2020 2020  r:.             
+0000eed0: 2020 2069 6620 6572 722e 6669 6c65 6e61     if err.filena
+0000eee0: 6d65 203d 3d20 7365 6c66 2e64 726f 7062  me == self.dropb
+0000eef0: 6f78 5f70 6174 683a 0a20 2020 2020 2020  ox_path:.       
+0000ef00: 2020 2020 2020 2020 2020 2020 2073 656c               sel
+0000ef10: 662e 656e 7375 7265 5f64 726f 7062 6f78  f.ensure_dropbox
+0000ef20: 5f66 6f6c 6465 725f 7072 6573 656e 7428  _folder_present(
+0000ef30: 290a 0a20 2020 2020 2020 2020 2020 2020  )..             
+0000ef40: 2020 2072 6169 7365 206f 735f 746f 5f6d     raise os_to_m
+0000ef50: 6165 7374 7261 6c5f 6572 726f 7228 6572  aestral_error(er
+0000ef60: 7229 0a0a 2020 2020 2020 2020 2020 2020  r)..            
+0000ef70: 6576 656e 7473 203d 2073 656c 662e 5f63  events = self._c
+0000ef80: 6c65 616e 5f6c 6f63 616c 5f65 7665 6e74  lean_local_event
+0000ef90: 7328 6576 656e 7473 290a 0a20 2020 2020  s(events)..     
+0000efa0: 2020 2020 2020 2073 796e 635f 6576 656e         sync_even
+0000efb0: 7473 203d 2073 656c 662e 5f73 796e 635f  ts = self._sync_
+0000efc0: 6576 656e 7473 5f66 726f 6d5f 6673 5f65  events_from_fs_e
+0000efd0: 7665 6e74 7328 6576 656e 7473 290a 2020  vents(events).  
+0000efe0: 2020 2020 2020 2020 2020 6465 6c20 6576            del ev
+0000eff0: 656e 7473 0a0a 2020 2020 2020 2020 2020  ents..          
+0000f000: 2020 6966 206c 656e 2873 796e 635f 6576    if len(sync_ev
+0000f010: 656e 7473 2920 3e20 303a 0a20 2020 2020  ents) > 0:.     
+0000f020: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+0000f030: 6170 706c 795f 6c6f 6361 6c5f 6368 616e  apply_local_chan
+0000f040: 6765 7328 7379 6e63 5f65 7665 6e74 7329  ges(sync_events)
+0000f050: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000f060: 2073 656c 662e 5f6c 6f67 6765 722e 6465   self._logger.de
+0000f070: 6275 6728 2255 706c 6f61 6465 6420 6c6f  bug("Uploaded lo
+0000f080: 6361 6c20 6368 616e 6765 7320 7768 696c  cal changes whil
+0000f090: 6520 696e 6163 7469 7665 2229 0a20 2020  e inactive").   
+0000f0a0: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
+0000f0b0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+0000f0c0: 656c 662e 5f6c 6f67 6765 722e 6465 6275  elf._logger.debu
+0000f0d0: 6728 224e 6f20 6c6f 6361 6c20 6368 616e  g("No local chan
+0000f0e0: 6765 7320 7768 696c 6520 696e 6163 7469  ges while inacti
+0000f0f0: 7665 2229 0a0a 2020 2020 2020 2020 2020  ve")..          
+0000f100: 2020 6465 6c20 7379 6e63 5f65 7665 6e74    del sync_event
+0000f110: 730a 2020 2020 2020 2020 2020 2020 6763  s.            gc
+0000f120: 2e63 6f6c 6c65 6374 2829 0a0a 2020 2020  .collect()..    
+0000f130: 2020 2020 2020 2020 7365 6c66 2e6c 6f63          self.loc
+0000f140: 616c 5f63 7572 736f 7220 3d20 6c6f 6361  al_cursor = loca
+0000f150: 6c5f 6375 7273 6f72 0a0a 2020 2020 2020  l_cursor..      
+0000f160: 2020 2020 2020 7365 6c66 2e5f 636c 6561        self._clea
+0000f170: 725f 6361 6368 6573 2829 0a0a 2020 2020  r_caches()..    
+0000f180: 6465 6620 5f67 6574 5f6c 6f63 616c 5f63  def _get_local_c
+0000f190: 6861 6e67 6573 5f77 6869 6c65 5f69 6e61  hanges_while_ina
+0000f1a0: 6374 6976 6528 7365 6c66 2920 2d3e 2074  ctive(self) -> t
+0000f1b0: 7570 6c65 5b6c 6973 745b 4669 6c65 5379  uple[list[FileSy
+0000f1c0: 7374 656d 4576 656e 745d 2c20 666c 6f61  stemEvent], floa
+0000f1d0: 745d 3a0a 2020 2020 2020 2020 2222 220a  t]:.        """.
+0000f1e0: 2020 2020 2020 2020 5265 7472 6965 7665          Retrieve
+0000f1f0: 7320 616c 6c20 6c6f 6361 6c20 6368 616e  s all local chan
+0000f200: 6765 7320 7369 6e63 6520 7468 6520 6c61  ges since the la
+0000f210: 7374 2073 796e 6320 6279 2070 6572 666f  st sync by perfo
+0000f220: 726d 696e 6720 6120 6675 6c6c 2073 6361  rming a full sca
+0000f230: 6e20 6f66 2074 6865 0a20 2020 2020 2020  n of the.       
+0000f240: 206c 6f63 616c 2066 6f6c 6465 722e 2043   local folder. C
+0000f250: 6861 6e67 6573 2061 7265 2064 6574 6563  hanges are detec
+0000f260: 7465 6420 6279 2063 6f6d 7061 7269 6e67  ted by comparing
+0000f270: 2074 6865 206e 6577 2064 6972 6563 746f   the new directo
+0000f280: 7279 2073 6e61 7073 686f 7420 746f 0a20  ry snapshot to. 
+0000f290: 2020 2020 2020 206f 7572 2069 6e64 6578         our index
+0000f2a0: 2e0a 0a20 2020 2020 2020 2041 6464 6564  ...        Added
+0000f2b0: 2069 7465 6d73 3a20 4172 6520 7072 6573   items: Are pres
+0000f2c0: 656e 7420 696e 2074 6865 2073 6e61 7073  ent in the snaps
+0000f2d0: 686f 7420 6275 7420 6e6f 7420 696e 206f  hot but not in o
+0000f2e0: 7572 2069 6e64 6578 2e0a 2020 2020 2020  ur index..      
+0000f2f0: 2020 4465 6c65 7465 6420 6974 656d 733a    Deleted items:
+0000f300: 2041 7265 2070 7265 7365 6e74 2069 6e20   Are present in 
+0000f310: 6f75 7220 696e 6465 7820 6275 7420 6e6f  our index but no
+0000f320: 7420 696e 2074 6865 2073 6e61 7073 686f  t in the snapsho
+0000f330: 742e 0a20 2020 2020 2020 204d 6f64 6966  t..        Modif
+0000f340: 6965 6420 6974 656d 733a 2041 7265 2070  ied items: Are p
+0000f350: 7265 7365 6e74 2069 6e20 626f 7468 2062  resent in both b
+0000f360: 7574 2068 6176 6520 6120 6d74 696d 6520  ut have a mtime 
+0000f370: 6e65 7765 7220 7468 616e 2074 6865 206c  newer than the l
+0000f380: 6173 7420 7379 6e63 2e0a 0a20 2020 2020  ast sync...     
+0000f390: 2020 204e 6f74 6520 7468 6174 2074 6865     Note that the
+0000f3a0: 2063 6c69 656e 7420 7365 7473 206d 7469   client sets mti
+0000f3b0: 6d65 7320 666f 7220 6669 6c65 7320 6578  mes for files ex
+0000f3c0: 706c 6963 6974 6c79 2062 7574 206e 6576  plicitly but nev
+0000f3d0: 6572 2074 6f20 6120 7661 6c75 6520 696e  er to a value in
+0000f3e0: 0a20 2020 2020 2020 2074 6865 2066 7574  .        the fut
+0000f3f0: 7572 652e 206d 7469 6d65 203e 206c 6173  ure. mtime > las
+0000f400: 745f 7379 6e63 2074 6865 7265 666f 7265  t_sync therefore
+0000f410: 2069 6e64 6963 6174 6573 2061 2072 6563   indicates a rec
+0000f420: 656e 7420 636f 6e74 656e 7420 6368 616e  ent content chan
+0000f430: 6765 2e20 5765 2064 6f0a 2020 2020 2020  ge. We do.      
+0000f440: 2020 6e6f 7420 7573 6520 7468 6520 6374    not use the ct
+0000f450: 696d 6520 6865 7265 2074 6f20 6176 6f69  ime here to avoi
+0000f460: 6420 7265 7379 6e63 696e 6720 7468 6520  d resyncing the 
+0000f470: 656e 7469 7265 2066 6f6c 6465 7220 6166  entire folder af
+0000f480: 7465 7220 6974 2068 6173 2062 6565 6e0a  ter it has been.
+0000f490: 2020 2020 2020 2020 6d6f 7665 6420 286d          moved (m
+0000f4a0: 6f76 696e 6720 6265 7477 6565 6e20 7061  oving between pa
+0000f4b0: 7274 6974 696f 6e73 2061 6e64 206f 6e20  rtitions and on 
+0000f4c0: 736f 6d65 2066 696c 6520 7379 7374 656d  some file system
+0000f4d0: 7320 6361 6e20 6368 616e 6765 2074 6865  s can change the
+0000f4e0: 2063 7469 6d65 292e 0a0a 2020 2020 2020   ctime)...      
+0000f4f0: 2020 3a72 6574 7572 6e73 3a20 5475 706c    :returns: Tupl
+0000f500: 6520 636f 6e74 6169 6e69 6e67 206c 6f63  e containing loc
+0000f510: 616c 2066 696c 6520 7379 7374 656d 2065  al file system e
+0000f520: 7665 6e74 7320 616e 6420 6120 6375 7273  vents and a curs
+0000f530: 6f72 202f 2074 696d 6573 7461 6d70 0a20  or / timestamp. 
+0000f540: 2020 2020 2020 2020 2020 2066 6f72 2074             for t
+0000f550: 6865 2063 6861 6e67 6573 2e0a 2020 2020  he changes..    
+0000f560: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
+0000f570: 6368 616e 6765 7320 3d20 5b5d 0a20 2020  changes = [].   
+0000f580: 2020 2020 2073 6e61 7073 686f 745f 7469       snapshot_ti
+0000f590: 6d65 203d 2074 696d 652e 7469 6d65 2829  me = time.time()
+0000f5a0: 0a0a 2020 2020 2020 2020 2320 4765 7420  ..        # Get 
+0000f5b0: 6d6f 6469 6669 6564 206f 7220 6164 6465  modified or adde
+0000f5c0: 6420 6974 656d 732e 0a20 2020 2020 2020  d items..       
+0000f5d0: 2066 6f72 206c 6f63 616c 5f70 6174 682c   for local_path,
+0000f5e0: 2073 7461 7420 696e 2077 616c 6b28 7365   stat in walk(se
+0000f5f0: 6c66 2e64 726f 7062 6f78 5f70 6174 682c  lf.dropbox_path,
+0000f600: 2073 656c 662e 5f73 6361 6e64 6972 5f77   self._scandir_w
+0000f610: 6974 685f 6967 6e6f 7265 293a 0a20 2020  ith_ignore):.   
+0000f620: 2020 2020 2020 2020 2069 735f 6469 7220           is_dir 
+0000f630: 3d20 535f 4953 4449 5228 7374 6174 2e73  = S_ISDIR(stat.s
+0000f640: 745f 6d6f 6465 290a 2020 2020 2020 2020  t_mode).        
+0000f650: 2020 2020 696e 6465 785f 656e 7472 7920      index_entry 
+0000f660: 3d20 7365 6c66 2e67 6574 5f69 6e64 6578  = self.get_index
+0000f670: 5f65 6e74 7279 5f66 6f72 5f6c 6f63 616c  _entry_for_local
+0000f680: 5f70 6174 6828 6c6f 6361 6c5f 7061 7468  _path(local_path
+0000f690: 290a 0a20 2020 2020 2020 2020 2020 2069  )..            i
+0000f6a0: 6620 696e 6465 785f 656e 7472 793a 0a20  f index_entry:. 
+0000f6b0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+0000f6c0: 735f 6e65 7720 3d20 4661 6c73 650a 2020  s_new = False.  
+0000f6d0: 2020 2020 2020 2020 2020 2020 2020 6c61                la
+0000f6e0: 7374 5f73 796e 6320 3d20 696e 6465 785f  st_sync = index_
+0000f6f0: 656e 7472 792e 6c61 7374 5f73 796e 6320  entry.last_sync 
+0000f700: 6f72 2030 2e30 0a20 2020 2020 2020 2020  or 0.0.         
+0000f710: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+0000f720: 2020 2020 2020 2020 2069 735f 6e65 7720           is_new 
+0000f730: 3d20 5472 7565 0a20 2020 2020 2020 2020  = True.         
+0000f740: 2020 2020 2020 206c 6173 745f 7379 6e63         last_sync
+0000f750: 203d 2030 2e30 0a0a 2020 2020 2020 2020   = 0.0..        
+0000f760: 2020 2020 6c61 7374 5f73 796e 6320 3d20      last_sync = 
+0000f770: 6d61 7828 6c61 7374 5f73 796e 632c 2073  max(last_sync, s
+0000f780: 656c 662e 6c6f 6361 6c5f 6375 7273 6f72  elf.local_cursor
+0000f790: 290a 0a20 2020 2020 2020 2020 2020 2023  )..            #
+0000f7a0: 2043 6865 636b 2069 6620 6974 656d 2077   Check if item w
+0000f7b0: 6173 2063 7265 6174 6564 206f 7220 6d6f  as created or mo
+0000f7c0: 6469 6669 6564 2073 696e 6365 2074 6865  dified since the
+0000f7d0: 206c 6173 7420 7379 6e63 2c0a 2020 2020   last sync,.    
+0000f7e0: 2020 2020 2020 2020 2320 6275 7420 6265          # but be
+0000f7f0: 666f 7265 2077 6520 7374 6172 7465 6420  fore we started 
+0000f800: 7468 6520 4669 6c65 4576 656e 7448 616e  the FileEventHan
+0000f810: 646c 6572 2028 7e73 6e61 7073 686f 745f  dler (~snapshot_
+0000f820: 7469 6d65 292e 0a20 2020 2020 2020 2020  time)..         
+0000f830: 2020 206d 7469 6d65 5f63 6865 636b 203d     mtime_check =
+0000f840: 2073 6e61 7073 686f 745f 7469 6d65 203e   snapshot_time >
+0000f850: 2073 7461 742e 7374 5f6d 7469 6d65 203e   stat.st_mtime >
+0000f860: 206c 6173 745f 7379 6e63 0a0a 2020 2020   last_sync..    
+0000f870: 2020 2020 2020 2020 2320 416c 7761 7973          # Always
+0000f880: 2075 706c 6f61 6420 756e 7472 6163 6b65   upload untracke
+0000f890: 6420 6974 656d 732c 2063 6865 636b 206d  d items, check m
+0000f8a0: 7469 6d65 206f 6620 7472 6163 6b65 6420  time of tracked 
+0000f8b0: 6974 656d 732e 0a20 2020 2020 2020 2020  items..         
+0000f8c0: 2020 2069 735f 6d6f 6469 6669 6564 203d     is_modified =
+0000f8d0: 206d 7469 6d65 5f63 6865 636b 2061 6e64   mtime_check and
+0000f8e0: 206e 6f74 2069 735f 6e65 770a 0a20 2020   not is_new..   
+0000f8f0: 2020 2020 2020 2020 2065 7665 6e74 3a20           event: 
+0000f900: 4669 6c65 5379 7374 656d 4576 656e 740a  FileSystemEvent.
+0000f910: 2020 2020 2020 2020 2020 2020 6576 656e              even
+0000f920: 7430 3a20 4669 6c65 5379 7374 656d 4576  t0: FileSystemEv
+0000f930: 656e 740a 2020 2020 2020 2020 2020 2020  ent.            
+0000f940: 6576 656e 7431 3a20 4669 6c65 5379 7374  event1: FileSyst
+0000f950: 656d 4576 656e 740a 0a20 2020 2020 2020  emEvent..       
+0000f960: 2020 2020 2069 6620 6973 5f6e 6577 3a0a       if is_new:.
+0000f970: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f980: 6966 2069 735f 6469 723a 0a20 2020 2020  if is_dir:.     
+0000f990: 2020 2020 2020 2020 2020 2020 2020 2065                 e
+0000f9a0: 7665 6e74 203d 2044 6972 4372 6561 7465  vent = DirCreate
+0000f9b0: 6445 7665 6e74 286c 6f63 616c 5f70 6174  dEvent(local_pat
+0000f9c0: 6829 0a20 2020 2020 2020 2020 2020 2020  h).             
+0000f9d0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+0000f9e0: 2020 2020 2020 2020 2020 2020 2065 7665               eve
+0000f9f0: 6e74 203d 2046 696c 6543 7265 6174 6564  nt = FileCreated
+0000fa00: 4576 656e 7428 6c6f 6361 6c5f 7061 7468  Event(local_path
+0000fa10: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0000fa20: 2020 6368 616e 6765 732e 6170 7065 6e64    changes.append
+0000fa30: 2865 7665 6e74 290a 0a20 2020 2020 2020  (event)..       
+0000fa40: 2020 2020 2065 6c69 6620 6973 5f6d 6f64       elif is_mod
+0000fa50: 6966 6965 643a 0a20 2020 2020 2020 2020  ified:.         
+0000fa60: 2020 2020 2020 2069 6620 6973 5f64 6972         if is_dir
+0000fa70: 2061 6e64 2069 6e64 6578 5f65 6e74 7279   and index_entry
+0000fa80: 2e69 735f 6469 7265 6374 6f72 793a 2020  .is_directory:  
+0000fa90: 2320 7479 7065 3a20 6967 6e6f 7265 0a20  # type: ignore. 
+0000faa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000fab0: 2020 2023 2057 6520 646f 6e27 7420 656d     # We don't em
+0000fac0: 6974 2060 4469 724d 6f64 6966 6965 6445  it `DirModifiedE
+0000fad0: 7665 6e74 6073 2e0a 2020 2020 2020 2020  vent`s..        
+0000fae0: 2020 2020 2020 2020 2020 2020 7061 7373              pass
+0000faf0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000fb00: 2065 6c69 6620 6e6f 7420 6973 5f64 6972   elif not is_dir
+0000fb10: 2061 6e64 206e 6f74 2069 6e64 6578 5f65   and not index_e
+0000fb20: 6e74 7279 2e69 735f 6469 7265 6374 6f72  ntry.is_director
+0000fb30: 793a 2020 2320 7479 7065 3a20 6967 6e6f  y:  # type: igno
+0000fb40: 7265 0a20 2020 2020 2020 2020 2020 2020  re.             
+0000fb50: 2020 2020 2020 2065 7665 6e74 203d 2046         event = F
+0000fb60: 696c 654d 6f64 6966 6965 6445 7665 6e74  ileModifiedEvent
+0000fb70: 286c 6f63 616c 5f70 6174 6829 0a20 2020  (local_path).   
+0000fb80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000fb90: 2063 6861 6e67 6573 2e61 7070 656e 6428   changes.append(
+0000fba0: 6576 656e 7429 0a20 2020 2020 2020 2020  event).         
+0000fbb0: 2020 2020 2020 2065 6c69 6620 6973 5f64         elif is_d
+0000fbc0: 6972 3a0a 2020 2020 2020 2020 2020 2020  ir:.            
+0000fbd0: 2020 2020 2020 2020 6576 656e 7430 203d          event0 =
+0000fbe0: 2046 696c 6544 656c 6574 6564 4576 656e   FileDeletedEven
+0000fbf0: 7428 6c6f 6361 6c5f 7061 7468 290a 2020  t(local_path).  
+0000fc00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000fc10: 2020 6576 656e 7431 203d 2044 6972 4372    event1 = DirCr
+0000fc20: 6561 7465 6445 7665 6e74 286c 6f63 616c  eatedEvent(local
+0000fc30: 5f70 6174 6829 0a20 2020 2020 2020 2020  _path).         
+0000fc40: 2020 2020 2020 2020 2020 2063 6861 6e67             chang
+0000fc50: 6573 202b 3d20 5b65 7665 6e74 302c 2065  es += [event0, e
+0000fc60: 7665 6e74 315d 0a20 2020 2020 2020 2020  vent1].         
+0000fc70: 2020 2020 2020 2065 6c69 6620 6e6f 7420         elif not 
+0000fc80: 6973 5f64 6972 3a0a 2020 2020 2020 2020  is_dir:.        
+0000fc90: 2020 2020 2020 2020 2020 2020 6576 656e              even
+0000fca0: 7430 203d 2044 6972 4465 6c65 7465 6445  t0 = DirDeletedE
+0000fcb0: 7665 6e74 286c 6f63 616c 5f70 6174 6829  vent(local_path)
+0000fcc0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000fcd0: 2020 2020 2065 7665 6e74 3120 3d20 4669       event1 = Fi
+0000fce0: 6c65 4372 6561 7465 6445 7665 6e74 286c  leCreatedEvent(l
+0000fcf0: 6f63 616c 5f70 6174 6829 0a20 2020 2020  ocal_path).     
+0000fd00: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+0000fd10: 6861 6e67 6573 202b 3d20 5b65 7665 6e74  hanges += [event
+0000fd20: 302c 2065 7665 6e74 315d 0a0a 2020 2020  0, event1]..    
+0000fd30: 2020 2020 2320 4765 7420 6465 6c65 7465      # Get delete
+0000fd40: 6420 6974 656d 732e 0a20 2020 2020 2020  d items..       
+0000fd50: 2066 6f72 2065 6e74 7279 2069 6e20 7365   for entry in se
+0000fd60: 6c66 2e69 7465 725f 696e 6465 7828 293a  lf.iter_index():
+0000fd70: 0a20 2020 2020 2020 2020 2020 206c 6f63  .            loc
+0000fd80: 616c 5f70 6174 685f 696e 6465 7865 6420  al_path_indexed 
+0000fd90: 3d20 7365 6c66 2e74 6f5f 6c6f 6361 6c5f  = self.to_local_
+0000fda0: 7061 7468 5f66 726f 6d5f 6361 7365 6428  path_from_cased(
+0000fdb0: 656e 7472 792e 6462 785f 7061 7468 5f63  entry.dbx_path_c
+0000fdc0: 6173 6564 290a 2020 2020 2020 2020 2020  ased).          
+0000fdd0: 2020 6973 5f6d 6967 6e6f 7265 203d 2073    is_mignore = s
+0000fde0: 656c 662e 5f69 735f 6d69 676e 6f72 655f  elf._is_mignore_
+0000fdf0: 7061 7468 2865 6e74 7279 2e64 6278 5f70  path(entry.dbx_p
+0000fe00: 6174 685f 6361 7365 642c 2065 6e74 7279  ath_cased, entry
+0000fe10: 2e69 735f 6469 7265 6374 6f72 7929 0a0a  .is_directory)..
+0000fe20: 2020 2020 2020 2020 2020 2020 6966 2069              if i
+0000fe30: 735f 6d69 676e 6f72 6520 6f72 206e 6f74  s_mignore or not
+0000fe40: 2073 656c 662e 5f65 7869 7374 735f 7769   self._exists_wi
+0000fe50: 7468 5f67 6976 656e 5f63 6173 696e 6728  th_given_casing(
+0000fe60: 6c6f 6361 6c5f 7061 7468 5f69 6e64 6578  local_path_index
+0000fe70: 6564 293a 0a20 2020 2020 2020 2020 2020  ed):.           
+0000fe80: 2020 2020 2069 6620 656e 7472 792e 6973       if entry.is
+0000fe90: 5f64 6972 6563 746f 7279 3a0a 2020 2020  _directory:.    
+0000fea0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000feb0: 6576 656e 7420 3d20 4469 7244 656c 6574  event = DirDelet
+0000fec0: 6564 4576 656e 7428 6c6f 6361 6c5f 7061  edEvent(local_pa
+0000fed0: 7468 5f69 6e64 6578 6564 290a 2020 2020  th_indexed).    
+0000fee0: 2020 2020 2020 2020 2020 2020 656c 7365              else
+0000fef0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0000ff00: 2020 2020 2020 6576 656e 7420 3d20 4669        event = Fi
+0000ff10: 6c65 4465 6c65 7465 6445 7665 6e74 286c  leDeletedEvent(l
+0000ff20: 6f63 616c 5f70 6174 685f 696e 6465 7865  ocal_path_indexe
+0000ff30: 6429 0a20 2020 2020 2020 2020 2020 2020  d).             
+0000ff40: 2020 2063 6861 6e67 6573 2e61 7070 656e     changes.appen
+0000ff50: 6428 6576 656e 7429 0a0a 2020 2020 2020  d(event)..      
+0000ff60: 2020 2320 456e 7375 7265 2074 6861 7420    # Ensure that 
+0000ff70: 7468 6520 6c6f 6361 6c20 4472 6f70 626f  the local Dropbo
+0000ff80: 7820 666f 6c64 6572 2073 7469 6c6c 2065  x folder still e
+0000ff90: 7869 7374 7320 6265 666f 7265 2072 6574  xists before ret
+0000ffa0: 7572 6e69 6e67 2063 6861 6e67 6573 2e0a  urning changes..
+0000ffb0: 2020 2020 2020 2020 2320 5468 6973 2070          # This p
+0000ffc0: 7265 7665 6e74 7320 6120 6465 6c65 7469  revents a deleti
+0000ffd0: 6f6e 206f 6620 7468 6520 4472 6f70 626f  on of the Dropbo
+0000ffe0: 7820 666f 6c64 6572 2066 726f 6d20 6265  x folder from be
+0000fff0: 696e 6720 696e 636f 7272 6563 746c 790a  ing incorrectly.
+00010000: 2020 2020 2020 2020 2320 7072 6f63 6573          # proces
+00010010: 7365 6420 6173 2069 6e64 6976 6964 7561  sed as individua
+00010020: 6c20 6669 6c65 2064 656c 6574 696f 6e73  l file deletions
+00010030: 2e0a 2020 2020 2020 2020 7365 6c66 2e65  ..        self.e
+00010040: 6e73 7572 655f 6472 6f70 626f 785f 666f  nsure_dropbox_fo
+00010050: 6c64 6572 5f70 7265 7365 6e74 2829 0a0a  lder_present()..
+00010060: 2020 2020 2020 2020 6475 7261 7469 6f6e          duration
+00010070: 203d 2074 696d 652e 7469 6d65 2829 202d   = time.time() -
+00010080: 2073 6e61 7073 686f 745f 7469 6d65 0a20   snapshot_time. 
+00010090: 2020 2020 2020 2073 656c 662e 5f6c 6f67         self._log
+000100a0: 6765 722e 6465 6275 6728 224c 6f63 616c  ger.debug("Local
+000100b0: 2069 6e64 6578 696e 6720 636f 6d70 6c65   indexing comple
+000100c0: 7465 6420 696e 2025 7320 7365 6322 2c20  ted in %s sec", 
+000100d0: 726f 756e 6428 6475 7261 7469 6f6e 2c20  round(duration, 
+000100e0: 3429 290a 2020 2020 2020 2020 7365 6c66  4)).        self
+000100f0: 2e5f 6c6f 6767 6572 2e64 6562 7567 2822  ._logger.debug("
+00010100: 5265 7472 6965 7665 6420 6c6f 6361 6c20  Retrieved local 
+00010110: 6368 616e 6765 733a 5c6e 2573 222c 2070  changes:\n%s", p
+00010120: 665f 7265 7072 2863 6861 6e67 6573 2929  f_repr(changes))
+00010130: 0a0a 2020 2020 2020 2020 7265 7475 726e  ..        return
+00010140: 2063 6861 6e67 6573 2c20 736e 6170 7368   changes, snapsh
+00010150: 6f74 5f74 696d 650a 0a20 2020 2064 6566  ot_time..    def
+00010160: 205f 6578 6973 7473 5f77 6974 685f 6769   _exists_with_gi
+00010170: 7665 6e5f 6361 7369 6e67 2873 656c 662c  ven_casing(self,
+00010180: 206c 6f63 616c 5f70 6174 683a 2073 7472   local_path: str
+00010190: 2920 2d3e 2062 6f6f 6c3a 0a20 2020 2020  ) -> bool:.     
+000101a0: 2020 2022 2222 0a20 2020 2020 2020 204f     """.        O
+000101b0: 6e20 6361 7365 2d69 6e73 656e 7369 7469  n case-insensiti
+000101c0: 7665 2062 7574 2063 6173 6520 7072 6573  ve but case pres
+000101d0: 6572 7669 6e67 2066 696c 6520 7379 7374  erving file syst
+000101e0: 656d 732c 2061 2060 6f73 2e70 6174 682e  ems, a `os.path.
+000101f0: 6578 6973 7473 600a 2020 2020 2020 2020  exists`.        
+00010200: 6361 6c6c 2077 696c 6c20 7265 7475 726e  call will return
+00010210: 2074 7275 6520 6576 656e 2069 6620 7468   true even if th
+00010220: 6520 6c6f 6361 6c20 6361 7369 6e67 2064  e local casing d
+00010230: 6966 6665 7273 2066 726f 6d20 7468 650a  iffers from the.
+00010240: 2020 2020 2020 2020 696e 6465 7865 6420          indexed 
+00010250: 6361 7369 6e67 2e20 5468 6973 206d 6574  casing. This met
+00010260: 686f 6420 7265 7475 726e 7320 4661 6c73  hod returns Fals
+00010270: 6520 6966 2074 6865 2064 6973 706c 6179  e if the display
+00010280: 2063 6173 696e 6720 6469 6666 6572 7320   casing differs 
+00010290: 6672 6f6d 2074 6865 0a20 2020 2020 2020  from the.       
+000102a0: 2067 6976 656e 2069 6e70 7574 2c20 6576   given input, ev
+000102b0: 656e 2069 6620 7061 7468 7320 7265 6665  en if paths refe
+000102c0: 7220 746f 2074 6865 2073 616d 6520 6669  r to the same fi
+000102d0: 6c65 2e0a 2020 2020 2020 2020 2222 220a  le..        """.
+000102e0: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
+000102f0: 6973 5f66 735f 6361 7365 5f73 656e 7369  is_fs_case_sensi
+00010300: 7469 7665 3a0a 2020 2020 2020 2020 2020  tive:.          
+00010310: 2020 7265 7475 726e 2065 7869 7374 7328    return exists(
+00010320: 6c6f 6361 6c5f 7061 7468 290a 0a20 2020  local_path)..   
+00010330: 2020 2020 2069 6620 6e6f 7420 6578 6973       if not exis
+00010340: 7473 286c 6f63 616c 5f70 6174 6829 3a0a  ts(local_path):.
+00010350: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+00010360: 726e 2046 616c 7365 0a0a 2020 2020 2020  rn False..      
+00010370: 2020 7472 793a 0a20 2020 2020 2020 2020    try:.         
+00010380: 2020 206c 6f63 616c 5f70 6174 685f 6469     local_path_di
+00010390: 7370 6c61 7965 6420 3d20 746f 5f65 7869  splayed = to_exi
+000103a0: 7374 696e 675f 756e 6e6f 726d 616c 697a  sting_unnormaliz
+000103b0: 6564 5f70 6174 6828 6c6f 6361 6c5f 7061  ed_path(local_pa
+000103c0: 7468 290a 2020 2020 2020 2020 2020 2020  th).            
+000103d0: 7265 7475 726e 206c 6f63 616c 5f70 6174  return local_pat
+000103e0: 685f 6469 7370 6c61 7965 6420 3d3d 206c  h_displayed == l
+000103f0: 6f63 616c 5f70 6174 680a 2020 2020 2020  ocal_path.      
+00010400: 2020 6578 6365 7074 2028 4669 6c65 4e6f    except (FileNo
+00010410: 7446 6f75 6e64 4572 726f 722c 204e 6f74  tFoundError, Not
+00010420: 4144 6972 6563 746f 7279 4572 726f 7229  ADirectoryError)
+00010430: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
+00010440: 7475 726e 2046 616c 7365 0a0a 2020 2020  turn False..    
+00010450: 6465 6620 7761 6974 5f66 6f72 5f6c 6f63  def wait_for_loc
+00010460: 616c 5f63 6861 6e67 6573 2873 656c 662c  al_changes(self,
+00010470: 2074 696d 656f 7574 3a20 666c 6f61 7420   timeout: float 
+00010480: 3d20 3430 2920 2d3e 2062 6f6f 6c3a 0a20  = 40) -> bool:. 
+00010490: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
+000104a0: 2020 2042 6c6f 636b 7320 756e 7469 6c20     Blocks until 
+000104b0: 6c6f 6361 6c20 6368 616e 6765 7320 6172  local changes ar
+000104c0: 6520 6176 6169 6c61 626c 652e 0a0a 2020  e available...  
+000104d0: 2020 2020 2020 3a70 6172 616d 2074 696d        :param tim
+000104e0: 656f 7574 3a20 4d61 7869 6d75 6d20 7469  eout: Maximum ti
+000104f0: 6d65 2069 6e20 7365 636f 6e64 7320 746f  me in seconds to
+00010500: 2077 6169 742e 0a20 2020 2020 2020 203a   wait..        :
+00010510: 7265 7475 726e 733a 2060 6054 7275 6560  returns: ``True`
+00010520: 6020 6966 2063 6861 6e67 6573 2061 7265  ` if changes are
+00010530: 2061 7661 696c 6162 6c65 2c20 6060 4661   available, ``Fa
+00010540: 6c73 6560 6020 6f74 6865 7277 6973 652e  lse`` otherwise.
+00010550: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
+00010560: 2020 2020 2073 656c 662e 5f6c 6f67 6765       self._logge
+00010570: 722e 6465 6275 6728 0a20 2020 2020 2020  r.debug(.       
+00010580: 2020 2020 2022 5761 6974 696e 6720 666f       "Waiting fo
+00010590: 7220 6c6f 6361 6c20 6368 616e 6765 7320  r local changes 
+000105a0: 7369 6e63 6520 6375 7273 6f72 3a20 2573  since cursor: %s
+000105b0: 222c 2073 656c 662e 6c6f 6361 6c5f 6375  ", self.local_cu
+000105c0: 7273 6f72 0a20 2020 2020 2020 2029 0a20  rsor.        ). 
+000105d0: 2020 2020 2020 2072 6574 7572 6e20 7365         return se
+000105e0: 6c66 2e66 735f 6576 656e 7473 2e77 6169  lf.fs_events.wai
+000105f0: 745f 666f 725f 6576 656e 7428 7469 6d65  t_for_event(time
+00010600: 6f75 7429 0a0a 2020 2020 6465 6620 7570  out)..    def up
+00010610: 6c6f 6164 5f73 796e 635f 6379 636c 6528  load_sync_cycle(
+00010620: 7365 6c66 2920 2d3e 204e 6f6e 653a 0a20  self) -> None:. 
+00010630: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
+00010640: 2020 2050 6572 666f 726d 7320 6120 6675     Performs a fu
+00010650: 6c6c 2075 706c 6f61 6420 7379 6e63 2063  ll upload sync c
+00010660: 7963 6c65 2062 7920 6361 6c6c 696e 6720  ycle by calling 
+00010670: 696e 206f 7264 6572 3a0a 0a20 2020 2020  in order:..     
+00010680: 2020 2020 2020 2031 2920 3a6d 6574 683a         1) :meth:
+00010690: 606c 6973 745f 6c6f 6361 6c5f 6368 616e  `list_local_chan
+000106a0: 6765 7360 0a20 2020 2020 2020 2020 2020  ges`.           
+000106b0: 2032 2920 3a6d 6574 683a 6061 7070 6c79   2) :meth:`apply
+000106c0: 5f6c 6f63 616c 5f63 6861 6e67 6573 600a  _local_changes`.
+000106d0: 0a20 2020 2020 2020 2048 616e 646c 6573  .        Handles
+000106e0: 2075 7064 6174 696e 6720 7468 6520 6c6f   updating the lo
+000106f0: 6361 6c20 6375 7273 6f72 2066 6f72 2079  cal cursor for y
+00010700: 6f75 2e20 4966 206d 6f6e 6974 6f72 696e  ou. If monitorin
+00010710: 6720 666f 7220 6c6f 6361 6c20 6669 6c65  g for local file
+00010720: 2065 7665 6e74 730a 2020 2020 2020 2020   events.        
+00010730: 7761 7320 696e 7465 7272 7570 7465 642c  was interrupted,
+00010740: 2063 616c 6c20 3a6d 6574 683a 6075 706c   call :meth:`upl
+00010750: 6f61 645f 6c6f 6361 6c5f 6368 616e 6765  oad_local_change
+00010760: 735f 7768 696c 655f 696e 6163 7469 7665  s_while_inactive
+00010770: 6020 696e 7374 6561 642e 0a20 2020 2020  ` instead..     
+00010780: 2020 2022 2222 0a20 2020 2020 2020 2077     """.        w
+00010790: 6974 6820 7365 6c66 2e73 796e 635f 6c6f  ith self.sync_lo
+000107a0: 636b 3a0a 2020 2020 2020 2020 2020 2020  ck:.            
+000107b0: 6368 616e 6765 732c 2063 7572 736f 7220  changes, cursor 
+000107c0: 3d20 7365 6c66 2e6c 6973 745f 6c6f 6361  = self.list_loca
+000107d0: 6c5f 6368 616e 6765 7328 290a 2020 2020  l_changes().    
+000107e0: 2020 2020 2020 2020 7365 6c66 2e61 7070          self.app
+000107f0: 6c79 5f6c 6f63 616c 5f63 6861 6e67 6573  ly_local_changes
+00010800: 2863 6861 6e67 6573 290a 0a20 2020 2020  (changes)..     
+00010810: 2020 2020 2020 2063 6f6e 666c 6963 7473         conflicts
+00010820: 203d 205b 6520 666f 7220 6520 696e 2063   = [e for e in c
+00010830: 6861 6e67 6573 2069 6620 652e 7374 6174  hanges if e.stat
+00010840: 7573 2069 7320 5379 6e63 5374 6174 7573  us is SyncStatus
+00010850: 2e43 6f6e 666c 6963 745d 0a20 2020 2020  .Conflict].     
+00010860: 2020 2020 2020 2073 656c 662e 6e6f 7469         self.noti
+00010870: 6679 5f75 7365 7228 636f 6e66 6c69 6374  fy_user(conflict
+00010880: 7329 0a0a 2020 2020 2020 2020 2020 2020  s)..            
+00010890: 7365 6c66 2e6c 6f63 616c 5f63 7572 736f  self.local_curso
+000108a0: 7220 3d20 6375 7273 6f72 0a0a 2020 2020  r = cursor..    
+000108b0: 2020 2020 2020 2020 2320 4672 6565 206d          # Free m
+000108c0: 656d 6f72 7920 6561 726c 7920 746f 2070  emory early to p
+000108d0: 7265 7665 6e74 2066 7261 676d 656e 7461  revent fragmenta
+000108e0: 7469 6f6e 2e0a 2020 2020 2020 2020 2020  tion..          
+000108f0: 2020 6465 6c20 6368 616e 6765 730a 2020    del changes.  
+00010900: 2020 2020 2020 2020 2020 7365 6c66 2e5f            self._
+00010910: 636c 6561 725f 6361 6368 6573 2829 0a20  clear_caches(). 
+00010920: 2020 2020 2020 2020 2020 2067 632e 636f             gc.co
+00010930: 6c6c 6563 7428 290a 0a20 2020 2020 2020  llect()..       
+00010940: 2020 2020 2069 6620 7365 6c66 2e5f 6361       if self._ca
+00010950: 6e63 656c 5f72 6571 7565 7374 6564 2e69  ncel_requested.i
+00010960: 735f 7365 7428 293a 0a20 2020 2020 2020  s_set():.       
+00010970: 2020 2020 2020 2020 2072 6169 7365 2043           raise C
+00010980: 616e 6365 6c6c 6564 4572 726f 7228 2253  ancelledError("S
+00010990: 796e 6320 6361 6e63 656c 6c65 6422 290a  ync cancelled").
+000109a0: 0a20 2020 2064 6566 206c 6973 745f 6c6f  .    def list_lo
+000109b0: 6361 6c5f 6368 616e 6765 7328 7365 6c66  cal_changes(self
+000109c0: 2c20 6465 6c61 793a 2066 6c6f 6174 203d  , delay: float =
+000109d0: 2031 2920 2d3e 2074 7570 6c65 5b6c 6973   1) -> tuple[lis
+000109e0: 745b 5379 6e63 4576 656e 745d 2c20 666c  t[SyncEvent], fl
+000109f0: 6f61 745d 3a0a 2020 2020 2020 2020 2222  oat]:.        ""
+00010a00: 220a 2020 2020 2020 2020 5265 7475 726e  ".        Return
+00010a10: 7320 6120 6c69 7374 206f 6620 6c6f 6361  s a list of loca
+00010a20: 6c20 6368 616e 6765 7320 7769 7468 2061  l changes with a
+00010a30: 7420 6d6f 7374 206f 6e65 2065 6e74 7279  t most one entry
+00010a40: 2070 6572 2070 6174 682e 0a0a 2020 2020   per path...    
+00010a50: 2020 2020 3a70 6172 616d 2064 656c 6179      :param delay
+00010a60: 3a20 4465 6c61 7920 696e 2073 6563 2074  : Delay in sec t
+00010a70: 6f20 7761 6974 2066 6f72 2073 7562 7365  o wait for subse
+00010a80: 7175 656e 7420 6368 616e 6765 7320 6265  quent changes be
+00010a90: 666f 7265 2072 6574 7572 6e69 6e67 2e0a  fore returning..
+00010aa0: 2020 2020 2020 2020 3a72 6574 7572 6e73          :returns
+00010ab0: 3a20 286c 6973 7420 6f66 2073 796e 6320  : (list of sync 
+00010ac0: 7469 6d65 7320 6576 656e 7473 2c20 7469  times events, ti
+00010ad0: 6d65 5f73 7461 6d70 290a 2020 2020 2020  me_stamp).      
+00010ae0: 2020 2222 220a 2020 2020 2020 2020 6576    """.        ev
+00010af0: 656e 7473 203d 205b 5d0a 2020 2020 2020  ents = [].      
+00010b00: 2020 6c6f 6361 6c5f 6375 7273 6f72 203d    local_cursor =
+00010b10: 2074 696d 652e 7469 6d65 2829 0a0a 2020   time.time()..  
+00010b20: 2020 2020 2020 2320 4b65 6570 2063 6f6c        # Keep col
+00010b30: 6c65 6374 696e 6720 6576 656e 7473 2075  lecting events u
+00010b40: 6e74 696c 2069 646c 6520 666f 7220 6064  ntil idle for `d
+00010b50: 656c 6179 602e 0a20 2020 2020 2020 2077  elay`..        w
+00010b60: 6869 6c65 2054 7275 653a 0a20 2020 2020  hile True:.     
+00010b70: 2020 2020 2020 2074 7279 3a0a 2020 2020         try:.    
+00010b80: 2020 2020 2020 2020 2020 2020 6576 656e              even
+00010b90: 7420 3d20 7365 6c66 2e66 735f 6576 656e  t = self.fs_even
+00010ba0: 7473 2e6c 6f63 616c 5f66 696c 655f 6576  ts.local_file_ev
+00010bb0: 656e 745f 7175 6575 652e 6765 7428 7469  ent_queue.get(ti
+00010bc0: 6d65 6f75 743d 6465 6c61 7929 0a20 2020  meout=delay).   
+00010bd0: 2020 2020 2020 2020 2020 2020 2065 7665               eve
+00010be0: 6e74 732e 6170 7065 6e64 2865 7665 6e74  nts.append(event
+00010bf0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00010c00: 2020 6c6f 6361 6c5f 6375 7273 6f72 203d    local_cursor =
+00010c10: 2074 696d 652e 7469 6d65 2829 0a20 2020   time.time().   
+00010c20: 2020 2020 2020 2020 2065 7863 6570 7420           except 
+00010c30: 456d 7074 793a 0a20 2020 2020 2020 2020  Empty:.         
+00010c40: 2020 2020 2020 2062 7265 616b 0a0a 2020         break..  
+00010c50: 2020 2020 2020 7365 6c66 2e5f 6c6f 6767        self._logg
+00010c60: 6572 2e64 6562 7567 2822 5265 7472 6965  er.debug("Retrie
+00010c70: 7665 6420 6c6f 6361 6c20 6669 6c65 2065  ved local file e
+00010c80: 7665 6e74 733a 5c6e 2573 222c 2070 665f  vents:\n%s", pf_
+00010c90: 7265 7072 2865 7665 6e74 7329 290a 0a20  repr(events)).. 
+00010ca0: 2020 2020 2020 2065 7665 6e74 7320 3d20         events = 
+00010cb0: 7365 6c66 2e5f 636c 6561 6e5f 6c6f 6361  self._clean_loca
+00010cc0: 6c5f 6576 656e 7473 2865 7665 6e74 7329  l_events(events)
+00010cd0: 0a20 2020 2020 2020 2073 796e 635f 6576  .        sync_ev
+00010ce0: 656e 7473 203d 2073 656c 662e 5f73 796e  ents = self._syn
+00010cf0: 635f 6576 656e 7473 5f66 726f 6d5f 6673  c_events_from_fs
+00010d00: 5f65 7665 6e74 7328 6576 656e 7473 290a  _events(events).
+00010d10: 0a20 2020 2020 2020 2023 2046 7265 6520  .        # Free 
+00010d20: 6d65 6d6f 7279 2065 6172 6c79 2074 6f20  memory early to 
+00010d30: 7072 6576 656e 7420 6672 6167 6d65 6e74  prevent fragment
+00010d40: 6174 696f 6e2e 0a20 2020 2020 2020 2064  ation..        d
+00010d50: 656c 2065 7665 6e74 730a 2020 2020 2020  el events.      
+00010d60: 2020 6763 2e63 6f6c 6c65 6374 2829 0a0a    gc.collect()..
+00010d70: 2020 2020 2020 2020 7265 7475 726e 2073          return s
+00010d80: 796e 635f 6576 656e 7473 2c20 6c6f 6361  ync_events, loca
+00010d90: 6c5f 6375 7273 6f72 0a0a 2020 2020 6465  l_cursor..    de
+00010da0: 6620 6170 706c 795f 6c6f 6361 6c5f 6368  f apply_local_ch
+00010db0: 616e 6765 7328 0a20 2020 2020 2020 2073  anges(.        s
+00010dc0: 656c 662c 2073 796e 635f 6576 656e 7473  elf, sync_events
+00010dd0: 3a20 436f 6c6c 6563 7469 6f6e 5b53 796e  : Collection[Syn
+00010de0: 6345 7665 6e74 5d0a 2020 2020 2920 2d3e  cEvent].    ) ->
+00010df0: 206c 6973 745b 5379 6e63 4576 656e 745d   list[SyncEvent]
+00010e00: 3a0a 2020 2020 2020 2020 2222 220a 2020  :.        """.  
+00010e10: 2020 2020 2020 4170 706c 6965 7320 6c6f        Applies lo
+00010e20: 6361 6c6c 7920 6465 7465 6374 6564 2063  cally detected c
+00010e30: 6861 6e67 6573 2074 6f20 7468 6520 7265  hanges to the re
+00010e40: 6d6f 7465 2044 726f 7062 6f78 2e20 4368  mote Dropbox. Ch
+00010e50: 616e 6765 7320 7768 6963 6820 7368 6f75  anges which shou
+00010e60: 6c64 2062 650a 2020 2020 2020 2020 6967  ld be.        ig
+00010e70: 6e6f 7265 6420 286d 6967 6e6f 7265 206f  nored (mignore o
+00010e80: 7220 616c 7761 7973 2069 676e 6f72 6564  r always ignored
+00010e90: 2066 696c 6573 2920 6172 6520 736b 6970   files) are skip
+00010ea0: 7065 642e 0a0a 2020 2020 2020 2020 3a70  ped...        :p
+00010eb0: 6172 616d 2073 796e 635f 6576 656e 7473  aram sync_events
+00010ec0: 3a20 4c69 7374 206f 6620 6c6f 6361 6c20  : List of local 
+00010ed0: 6669 6c65 2073 7973 7465 6d20 6576 656e  file system even
+00010ee0: 7473 2e0a 2020 2020 2020 2020 2222 220a  ts..        """.
+00010ef0: 2020 2020 2020 2020 7265 7375 6c74 733a          results:
+00010f00: 206c 6973 745b 5379 6e63 4576 656e 745d   list[SyncEvent]
+00010f10: 203d 205b 5d0a 0a20 2020 2020 2020 2069   = []..        i
+00010f20: 6620 6c65 6e28 7379 6e63 5f65 7665 6e74  f len(sync_event
+00010f30: 7329 203d 3d20 303a 0a20 2020 2020 2020  s) == 0:.       
+00010f40: 2020 2020 2072 6574 7572 6e20 7265 7375       return resu
+00010f50: 6c74 730a 0a20 2020 2020 2020 2023 2053  lts..        # S
+00010f60: 6f72 7420 616c 6c20 7379 6e63 2065 7665  ort all sync eve
+00010f70: 6e74 7320 696e 746f 2064 656c 6574 6564  nts into deleted
+00010f80: 2c20 6469 725f 6d6f 7665 6420 616e 6420  , dir_moved and 
+00010f90: 6f74 6865 722e 2044 6973 6361 7264 2069  other. Discard i
+00010fa0: 7465 6d73 0a20 2020 2020 2020 2023 2077  tems.        # w
+00010fb0: 6869 6368 2061 7265 2065 7863 6c75 6465  hich are exclude
+00010fc0: 6420 6279 206d 6967 6e6f 7265 206f 7220  d by mignore or 
+00010fd0: 7468 6520 696e 7465 726e 616c 2065 7863  the internal exc
+00010fe0: 6c75 7369 6f6e 206c 6973 742e 2044 656c  lusion list. Del
+00010ff0: 6574 6564 2061 6e64 0a20 2020 2020 2020  eted and.       
+00011000: 2023 2064 6972 5f6d 6f76 6564 2065 7665   # dir_moved eve
+00011010: 6e74 7320 7769 6c6c 206e 6576 6572 2062  nts will never b
+00011020: 6520 6e65 7374 6564 2028 7765 2068 6176  e nested (we hav
+00011030: 6520 616c 7265 6164 7920 636f 6d62 696e  e already combin
+00011040: 6564 2073 7563 6820 6e65 7374 6564 0a20  ed such nested. 
+00011050: 2020 2020 2020 2023 2065 7665 6e74 7329         # events)
+00011060: 2062 7574 2061 6c6c 206f 7468 6572 2065   but all other e
+00011070: 7665 6e74 7320 6d69 6768 7420 6265 2e20  vents might be. 
+00011080: 5765 206f 7264 6572 2061 6e64 2061 7070  We order and app
+00011090: 6c79 2074 6865 6d20 6869 6572 6172 6368  ly them hierarch
+000110a0: 6963 616c 6c79 2e0a 0a20 2020 2020 2020  ically...       
+000110b0: 2064 656c 6574 6564 3a20 6c69 7374 5b53   deleted: list[S
+000110c0: 796e 6345 7665 6e74 5d20 3d20 5b5d 0a20  yncEvent] = []. 
+000110d0: 2020 2020 2020 2064 6972 5f6d 6f76 6564         dir_moved
+000110e0: 3a20 6c69 7374 5b53 796e 6345 7665 6e74  : list[SyncEvent
+000110f0: 5d20 3d20 5b5d 0a20 2020 2020 2020 206f  ] = [].        o
+00011100: 7468 6572 3a20 6465 6661 756c 7464 6963  ther: defaultdic
+00011110: 745b 696e 742c 206c 6973 745b 5379 6e63  t[int, list[Sync
+00011120: 4576 656e 745d 5d20 3d20 6465 6661 756c  Event]] = defaul
+00011130: 7464 6963 7428 6c69 7374 290a 0a20 2020  tdict(list)..   
+00011140: 2020 2020 2066 6f72 2065 7665 6e74 2069       for event i
+00011150: 6e20 7379 6e63 5f65 7665 6e74 733a 0a20  n sync_events:. 
+00011160: 2020 2020 2020 2020 2020 2069 6620 7365             if se
+00011170: 6c66 2e69 735f 6578 636c 7564 6564 2865  lf.is_excluded(e
+00011180: 7665 6e74 2e6c 6f63 616c 5f70 6174 6829  vent.local_path)
+00011190: 206f 7220 7365 6c66 2e69 735f 6d69 676e   or self.is_mign
+000111a0: 6f72 6528 6576 656e 7429 3a0a 2020 2020  ore(event):.    
+000111b0: 2020 2020 2020 2020 2020 2020 636f 6e74              cont
+000111c0: 696e 7565 0a0a 2020 2020 2020 2020 2020  inue..          
+000111d0: 2020 6966 2065 7665 6e74 2e69 735f 6465    if event.is_de
+000111e0: 6c65 7465 643a 0a20 2020 2020 2020 2020  leted:.         
+000111f0: 2020 2020 2020 2064 656c 6574 6564 2e61         deleted.a
+00011200: 7070 656e 6428 6576 656e 7429 0a20 2020  ppend(event).   
+00011210: 2020 2020 2020 2020 2065 6c69 6620 6576           elif ev
+00011220: 656e 742e 6973 5f64 6972 6563 746f 7279  ent.is_directory
+00011230: 2061 6e64 2065 7665 6e74 2e69 735f 6d6f   and event.is_mo
+00011240: 7665 643a 0a20 2020 2020 2020 2020 2020  ved:.           
+00011250: 2020 2020 2064 6972 5f6d 6f76 6564 2e61       dir_moved.a
+00011260: 7070 656e 6428 6576 656e 7429 0a20 2020  ppend(event).   
+00011270: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
+00011280: 2020 2020 2020 2020 2020 2020 2020 206c                 l
+00011290: 6576 656c 203d 2065 7665 6e74 2e64 6278  evel = event.dbx
+000112a0: 5f70 6174 682e 636f 756e 7428 222f 2229  _path.count("/")
+000112b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000112c0: 206f 7468 6572 5b6c 6576 656c 5d2e 6170   other[level].ap
+000112d0: 7065 6e64 2865 7665 6e74 290a 0a20 2020  pend(event)..   
+000112e0: 2020 2020 2020 2020 2023 2048 6f75 7365           # House
+000112f0: 6b65 6570 696e 672e 0a20 2020 2020 2020  keeping..       
+00011300: 2020 2020 2073 656c 662e 6163 7469 7669       self.activi
+00011310: 7479 2e61 6464 2865 7665 6e74 290a 0a20  ty.add(event).. 
+00011320: 2020 2020 2020 2073 656c 662e 5f6c 6f67         self._log
+00011330: 6765 722e 6465 6275 6728 2246 696c 7465  ger.debug("Filte
+00011340: 7265 6420 6465 6c65 7465 6420 6576 656e  red deleted even
+00011350: 7473 3a5c 6e25 7322 2c20 7066 5f72 6570  ts:\n%s", pf_rep
+00011360: 7228 6465 6c65 7465 6429 290a 2020 2020  r(deleted)).    
+00011370: 2020 2020 7365 6c66 2e5f 6c6f 6767 6572      self._logger
+00011380: 2e64 6562 7567 2822 4669 6c74 6572 6564  .debug("Filtered
+00011390: 2064 6972 206d 6f76 6564 2065 7665 6e74   dir moved event
+000113a0: 733a 5c6e 2573 222c 2070 665f 7265 7072  s:\n%s", pf_repr
+000113b0: 2864 6972 5f6d 6f76 6564 2929 0a20 2020  (dir_moved)).   
+000113c0: 2020 2020 2073 656c 662e 5f6c 6f67 6765       self._logge
+000113d0: 722e 6465 6275 6728 2246 696c 7465 7265  r.debug("Filtere
+000113e0: 6420 6f74 6865 7220 6576 656e 7473 3a5c  d other events:\
+000113f0: 6e25 7322 2c20 7066 5f72 6570 7228 6f74  n%s", pf_repr(ot
+00011400: 6865 7229 290a 0a20 2020 2020 2020 2023  her))..        #
+00011410: 2041 7070 6c79 2064 656c 6574 6564 2065   Apply deleted e
+00011420: 7665 6e74 7320 6669 7273 742c 2066 6f6c  vents first, fol
+00011430: 6465 7220 6d6f 7665 6420 6576 656e 7473  der moved events
+00011440: 2073 6563 6f6e 642e 0a20 2020 2020 2020   second..       
+00011450: 2023 204e 6569 7468 6572 2065 7665 6e74   # Neither event
+00011460: 2074 7970 6520 7265 7175 6972 6573 2061   type requires a
+00011470: 6e20 6163 7475 616c 2075 706c 6f61 642e  n actual upload.
+00011480: 0a20 2020 2020 2020 2069 6620 6465 6c65  .        if dele
+00011490: 7465 643a 0a20 2020 2020 2020 2020 2020  ted:.           
+000114a0: 2073 656c 662e 5f6c 6f67 6765 722e 696e   self._logger.in
+000114b0: 666f 2822 5570 6c6f 6164 696e 6720 6465  fo("Uploading de
+000114c0: 6c65 7469 6f6e 732e 2e2e 2229 0a0a 2020  letions...")..  
+000114d0: 2020 2020 2020 7265 7320 3d20 646f 5f70        res = do_p
+000114e0: 6172 616c 6c65 6c28 0a20 2020 2020 2020  arallel(.       
+000114f0: 2020 2020 2073 656c 662e 5f63 7265 6174       self._creat
+00011500: 655f 7265 6d6f 7465 5f65 6e74 7279 2c0a  e_remote_entry,.
+00011510: 2020 2020 2020 2020 2020 2020 6465 6c65              dele
+00011520: 7465 642c 0a20 2020 2020 2020 2020 2020  ted,.           
+00011530: 206f 6e5f 7072 6f67 7265 7373 3d6c 616d   on_progress=lam
+00011540: 6264 6120 782c 2079 3a20 7365 6c66 2e5f  bda x, y: self._
+00011550: 6c6f 6767 6572 2e69 6e66 6f28 6622 4465  logger.info(f"De
+00011560: 6c65 7469 6e67 207b 787d 2f7b 797d 2229  leting {x}/{y}")
+00011570: 2c0a 2020 2020 2020 2020 2020 2020 7468  ,.            th
+00011580: 7265 6164 5f6e 616d 655f 7072 6566 6978  read_name_prefix
+00011590: 3d22 6d61 6573 7472 616c 2d75 706c 6f61  ="maestral-uploa
+000115a0: 642d 706f 6f6c 222c 0a20 2020 2020 2020  d-pool",.       
+000115b0: 2029 0a20 2020 2020 2020 2072 6573 756c   ).        resul
+000115c0: 7473 2e65 7874 656e 6428 7265 7329 0a0a  ts.extend(res)..
+000115d0: 2020 2020 2020 2020 6966 2064 6972 5f6d          if dir_m
+000115e0: 6f76 6564 3a0a 2020 2020 2020 2020 2020  oved:.          
+000115f0: 2020 7365 6c66 2e5f 6c6f 6767 6572 2e69    self._logger.i
+00011600: 6e66 6f28 224d 6f76 696e 6720 666f 6c64  nfo("Moving fold
+00011610: 6572 732e 2e2e 2229 0a0a 2020 2020 2020  ers...")..      
+00011620: 2020 666f 7220 6576 656e 7420 696e 2064    for event in d
+00011630: 6972 5f6d 6f76 6564 3a0a 2020 2020 2020  ir_moved:.      
+00011640: 2020 2020 2020 7365 6c66 2e5f 6c6f 6767        self._logg
+00011650: 6572 2e69 6e66 6f28 6622 4d6f 7669 6e67  er.info(f"Moving
+00011660: 207b 6576 656e 742e 6462 785f 7061 7468   {event.dbx_path
+00011670: 5f66 726f 6d7d 2229 0a20 2020 2020 2020  _from}").       
+00011680: 2020 2020 2072 203d 2073 656c 662e 5f63       r = self._c
+00011690: 7265 6174 655f 7265 6d6f 7465 5f65 6e74  reate_remote_ent
+000116a0: 7279 2865 7665 6e74 290a 2020 2020 2020  ry(event).      
+000116b0: 2020 2020 2020 7265 7375 6c74 732e 6170        results.ap
+000116c0: 7065 6e64 2872 290a 0a20 2020 2020 2020  pend(r)..       
+000116d0: 2023 2041 7070 6c79 206f 7468 6572 2065   # Apply other e
+000116e0: 7665 6e74 7320 696e 2070 6172 616c 6c65  vents in paralle
+000116f0: 6c2c 2070 726f 6365 7373 696e 6720 6561  l, processing ea
+00011700: 6368 2068 6965 7261 7263 6879 206c 6576  ch hierarchy lev
+00011710: 656c 2073 7563 6365 7373 6976 656c 792e  el successively.
+00011720: 0a20 2020 2020 2020 2066 6f72 206c 6576  .        for lev
+00011730: 656c 2069 6e20 736f 7274 6564 286f 7468  el in sorted(oth
+00011740: 6572 293a 0a20 2020 2020 2020 2020 2020  er):.           
+00011750: 2072 6573 203d 2064 6f5f 7061 7261 6c6c   res = do_parall
+00011760: 656c 280a 2020 2020 2020 2020 2020 2020  el(.            
+00011770: 2020 2020 7365 6c66 2e5f 6372 6561 7465      self._create
+00011780: 5f72 656d 6f74 655f 656e 7472 792c 0a20  _remote_entry,. 
+00011790: 2020 2020 2020 2020 2020 2020 2020 206f                 o
+000117a0: 7468 6572 5b6c 6576 656c 5d2c 0a20 2020  ther[level],.   
+000117b0: 2020 2020 2020 2020 2020 2020 206f 6e5f               on_
+000117c0: 7072 6f67 7265 7373 3d6c 616d 6264 6120  progress=lambda 
+000117d0: 782c 2079 3a20 7365 6c66 2e5f 6c6f 6767  x, y: self._logg
+000117e0: 6572 2e69 6e66 6f28 6622 5379 6e63 696e  er.info(f"Syncin
+000117f0: 6720 e286 9120 7b78 7d2f 7b79 7d22 292c  g ... {x}/{y}"),
+00011800: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00011810: 2074 6872 6561 645f 6e61 6d65 5f70 7265   thread_name_pre
+00011820: 6669 783d 226d 6165 7374 7261 6c2d 7570  fix="maestral-up
+00011830: 6c6f 6164 2d70 6f6f 6c22 2c0a 2020 2020  load-pool",.    
+00011840: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+00011850: 2020 2020 2020 7265 7375 6c74 732e 6578        results.ex
+00011860: 7465 6e64 2872 6573 290a 0a20 2020 2020  tend(res)..     
+00011870: 2020 2073 656c 662e 5f63 6c65 616e 5f68     self._clean_h
+00011880: 6973 746f 7279 2829 0a0a 2020 2020 2020  istory()..      
+00011890: 2020 7265 7475 726e 2072 6573 756c 7473    return results
+000118a0: 0a0a 2020 2020 6465 6620 5f63 6c65 616e  ..    def _clean
+000118b0: 5f6c 6f63 616c 5f65 7665 6e74 7328 0a20  _local_events(. 
+000118c0: 2020 2020 2020 2073 656c 662c 2065 7665         self, eve
+000118d0: 6e74 733a 2043 6f6c 6c65 6374 696f 6e5b  nts: Collection[
+000118e0: 4669 6c65 5379 7374 656d 4576 656e 745d  FileSystemEvent]
+000118f0: 0a20 2020 2029 202d 3e20 6c69 7374 5b46  .    ) -> list[F
+00011900: 696c 6553 7973 7465 6d45 7665 6e74 5d3a  ileSystemEvent]:
+00011910: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
+00011920: 2020 2020 2054 616b 6573 206c 6f63 616c       Takes local
+00011930: 2066 696c 6520 6576 656e 7473 2061 6e64   file events and
+00011940: 2063 6c65 616e 7320 7468 656d 2075 7020   cleans them up 
+00011950: 6173 2066 6f6c 6c6f 7773 3a0a 0a20 2020  as follows:..   
+00011960: 2020 2020 2031 2920 4b65 6570 206f 6e6c       1) Keep onl
+00011970: 7920 6120 7369 6e67 6c65 2065 7665 6e74  y a single event
+00011980: 2070 6572 2070 6174 682c 2075 6e6c 6573   per path, unles
+00011990: 7320 7468 6520 6974 656d 2074 7970 6520  s the item type 
+000119a0: 6368 616e 6765 6420 2865 2e67 2e2c 2066  changed (e.g., f
+000119b0: 726f 6d0a 2020 2020 2020 2020 2020 2066  rom.           f
+000119c0: 696c 6520 746f 2066 6f6c 6465 7229 2e0a  ile to folder)..
+000119d0: 2020 2020 2020 2020 3229 2043 6f6c 6c61          2) Colla
+000119e0: 7073 6573 206d 6f76 6564 2061 6e64 2064  pses moved and d
+000119f0: 656c 6574 6564 2065 7665 6e74 7320 6f66  eleted events of
+00011a00: 2066 6f6c 6465 7273 2077 6974 6820 7468   folders with th
+00011a10: 6f73 6520 6f66 2074 6865 6972 2063 6869  ose of their chi
+00011a20: 6c64 7265 6e2e 0a0a 2020 2020 2020 2020  ldren...        
+00011a30: 5468 6520 6f72 6465 7220 6f66 2065 7665  The order of eve
+00011a40: 6e74 7320 7769 6c6c 2062 6520 7072 6573  nts will be pres
+00011a50: 6572 7665 6420 6163 636f 7264 696e 6720  erved according 
+00011a60: 746f 2074 6865 2066 6972 7374 2065 7665  to the first eve
+00011a70: 6e74 2072 6567 6973 7465 7265 640a 2020  nt registered.  
+00011a80: 2020 2020 2020 666f 7220 7468 6174 2070        for that p
+00011a90: 6174 682e 0a0a 2020 2020 2020 2020 3a70  ath...        :p
+00011aa0: 6172 616d 2065 7665 6e74 733a 2049 7465  aram events: Ite
+00011ab0: 7261 626c 6520 6f66 203a 636c 6173 733a  rable of :class:
+00011ac0: 6077 6174 6368 646f 672e 4669 6c65 5379  `watchdog.FileSy
+00011ad0: 7374 656d 4576 656e 7460 2e0a 2020 2020  stemEvent`..    
+00011ae0: 2020 2020 3a72 6574 7572 6e73 3a20 4c69      :returns: Li
+00011af0: 7374 206f 6620 3a63 6c61 7373 3a60 7761  st of :class:`wa
+00011b00: 7463 6864 6f67 2e46 696c 6553 7973 7465  tchdog.FileSyste
+00011b10: 6d45 7665 6e74 602e 0a20 2020 2020 2020  mEvent`..       
+00011b20: 2022 2222 0a20 2020 2020 2020 2023 2043   """.        # C
+00011b30: 4f4d 4249 4e45 2045 5645 4e54 5320 544f  OMBINE EVENTS TO
+00011b40: 204f 4e45 2045 5645 4e54 2050 4552 2050   ONE EVENT PER P
+00011b50: 4154 480a 0a20 2020 2020 2020 2023 204d  ATH..        # M
+00011b60: 6f76 6520 6576 656e 7473 2061 7265 2064  ove events are d
+00011b70: 6966 6669 6375 6c74 2074 6f20 636f 6d62  ifficult to comb
+00011b80: 696e 6520 7769 7468 206f 7468 6572 2065  ine with other e
+00011b90: 7665 6e74 2074 7970 6573 2c20 7765 2073  vent types, we s
+00011ba0: 706c 6974 2074 6865 6d0a 2020 2020 2020  plit them.      
+00011bb0: 2020 2320 696e 746f 2064 656c 6574 6564    # into deleted
+00011bc0: 2061 6e64 2063 7265 6174 6564 2065 7665   and created eve
+00011bd0: 6e74 7320 616e 6420 7265 636f 6d62 696e  nts and recombin
+00011be0: 6520 7468 656d 206c 6174 6572 2069 6620  e them later if 
+00011bf0: 6e65 6974 6865 7220 7468 6520 736f 7572  neither the sour
+00011c00: 6365 0a20 2020 2020 2020 2023 206f 6620  ce.        # of 
+00011c10: 7468 6520 6465 7374 696e 6174 696f 6e20  the destination 
+00011c20: 7061 7468 206f 6620 6861 7320 6f74 6865  path of has othe
+00011c30: 7220 6576 656e 7473 2061 7373 6f63 6961  r events associa
+00011c40: 7465 6420 7769 7468 2069 7420 6f72 2069  ted with it or i
+00011c50: 7320 6578 636c 7564 6564 0a20 2020 2020  s excluded.     
+00011c60: 2020 2023 2066 726f 6d20 7379 6e63 2e0a     # from sync..
+00011c70: 0a20 2020 2020 2020 2023 206d 6170 7069  .        # mappi
+00011c80: 6e67 206f 6620 7061 7468 202d 3e20 6576  ng of path -> ev
+00011c90: 656e 7420 6869 7374 6f72 790a 2020 2020  ent history.    
+00011ca0: 2020 2020 6576 656e 7473 5f66 6f72 5f70      events_for_p
+00011cb0: 6174 683a 2064 6566 6175 6c74 6469 6374  ath: defaultdict
+00011cc0: 5b73 7472 2c20 6c69 7374 5b46 696c 6553  [str, list[FileS
+00011cd0: 7973 7465 6d45 7665 6e74 5d5d 203d 2064  ystemEvent]] = d
+00011ce0: 6566 6175 6c74 6469 6374 286c 6973 7429  efaultdict(list)
+00011cf0: 0a0a 2020 2020 2020 2020 2320 6d61 7070  ..        # mapp
+00011d00: 696e 6720 6f66 2073 6f75 7263 6520 6465  ing of source de
+00011d10: 6c65 7469 6f6e 2065 7665 6e74 202d 3e20  letion event -> 
+00011d20: 6465 7374 696e 6174 696f 6e20 6372 6561  destination crea
+00011d30: 7469 6f6e 2065 7665 6e74 0a20 2020 2020  tion event.     
+00011d40: 2020 206d 6f76 6564 5f66 726f 6d5f 746f     moved_from_to
+00011d50: 3a20 6469 6374 5b46 696c 6553 7973 7465  : dict[FileSyste
+00011d60: 6d45 7665 6e74 2c20 4669 6c65 5379 7374  mEvent, FileSyst
+00011d70: 656d 4576 656e 745d 203d 207b 7d0a 2020  emEvent] = {}.  
+00011d80: 2020 2020 2020 6d6f 7665 645f 6576 656e        moved_even
+00011d90: 7473 5f74 6f5f 7265 636f 6d62 696e 653a  ts_to_recombine:
+00011da0: 206c 6973 745b 4669 6c65 5379 7374 656d   list[FileSystem
+00011db0: 4576 656e 745d 203d 205b 5d0a 0a20 2020  Event] = []..   
+00011dc0: 2020 2020 2066 6f72 2065 7665 6e74 2069       for event i
+00011dd0: 6e20 6576 656e 7473 3a0a 2020 2020 2020  n events:.      
+00011de0: 2020 2020 2020 6966 2069 735f 6d6f 7665        if is_move
+00011df0: 6428 6576 656e 7429 3a0a 2020 2020 2020  d(event):.      
+00011e00: 2020 2020 2020 2020 2020 6465 6c65 7465            delete
+00011e10: 642c 2063 7265 6174 6564 203d 2073 706c  d, created = spl
+00011e20: 6974 5f6d 6f76 6564 5f65 7665 6e74 2865  it_moved_event(e
+00011e30: 7665 6e74 290a 2020 2020 2020 2020 2020  vent).          
+00011e40: 2020 2020 2020 6d6f 7665 645f 6672 6f6d        moved_from
+00011e50: 5f74 6f5b 6465 6c65 7465 645d 203d 2063  _to[deleted] = c
+00011e60: 7265 6174 6564 0a0a 2020 2020 2020 2020  reated..        
+00011e70: 2020 2020 2020 2020 6576 656e 7473 5f66          events_f
+00011e80: 6f72 5f70 6174 685b 6465 6c65 7465 642e  or_path[deleted.
+00011e90: 7372 635f 7061 7468 5d2e 6170 7065 6e64  src_path].append
+00011ea0: 2864 656c 6574 6564 290a 2020 2020 2020  (deleted).      
+00011eb0: 2020 2020 2020 2020 2020 6576 656e 7473            events
+00011ec0: 5f66 6f72 5f70 6174 685b 6372 6561 7465  _for_path[create
+00011ed0: 642e 7372 635f 7061 7468 5d2e 6170 7065  d.src_path].appe
+00011ee0: 6e64 2863 7265 6174 6564 290a 2020 2020  nd(created).    
+00011ef0: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+00011f00: 2020 2020 2020 2020 2020 2020 2020 6576                ev
+00011f10: 656e 7473 5f66 6f72 5f70 6174 685b 6576  ents_for_path[ev
+00011f20: 656e 742e 7372 635f 7061 7468 5d2e 6170  ent.src_path].ap
+00011f30: 7065 6e64 2865 7665 6e74 290a 0a20 2020  pend(event)..   
+00011f40: 2020 2020 2023 2046 6f72 2065 7665 7279       # For every
+00011f50: 2070 6174 682c 206b 6565 7020 6f6e 6c79   path, keep only
+00011f60: 2061 2073 696e 676c 6520 6576 656e 7420   a single event 
+00011f70: 7768 6963 6820 7265 7072 6573 656e 7473  which represents
+00011f80: 2061 6c6c 2063 6861 6e67 6573 2c0a 2020   all changes,.  
+00011f90: 2020 2020 2020 2320 756e 6c65 7373 2077        # unless w
+00011fa0: 6520 6465 616c 2077 6974 6820 6120 7479  e deal with a ty
+00011fb0: 7065 2063 6861 6e67 652e 0a20 2020 2020  pe change..     
+00011fc0: 2020 2066 6f72 2070 6174 6820 696e 206c     for path in l
+00011fd0: 6973 7428 6576 656e 7473 5f66 6f72 5f70  ist(events_for_p
+00011fe0: 6174 6829 3a0a 2020 2020 2020 2020 2020  ath):.          
+00011ff0: 2020 6576 656e 7473 203d 2065 7665 6e74    events = event
+00012000: 735f 666f 725f 7061 7468 5b70 6174 685d  s_for_path[path]
+00012010: 0a0a 2020 2020 2020 2020 2020 2020 6966  ..            if
+00012020: 206c 656e 2865 7665 6e74 7329 203d 3d20   len(events) == 
+00012030: 313a 0a20 2020 2020 2020 2020 2020 2020  1:.             
+00012040: 2020 2065 7665 6e74 203d 2065 7665 6e74     event = event
+00012050: 735b 305d 0a20 2020 2020 2020 2020 2020  s[0].           
+00012060: 2020 2020 2023 204d 6172 6b20 6d6f 7665       # Mark move
+00012070: 6420 6576 656e 7473 2069 6620 7468 6572  d events if ther
+00012080: 6520 6973 2061 2073 696e 676c 6520 6576  e is a single ev
+00012090: 656e 7420 6f6e 6c79 2061 7420 7468 6520  ent only at the 
+000120a0: 7372 630a 2020 2020 2020 2020 2020 2020  src.            
+000120b0: 2020 2020 2320 616e 6420 6465 7374 2070      # and dest p
+000120c0: 6174 6873 2c20 746f 2062 6520 7265 636f  aths, to be reco
+000120d0: 6d62 696e 6564 206c 6174 6572 2e0a 2020  mbined later..  
+000120e0: 2020 2020 2020 2020 2020 2020 2020 6966                if
+000120f0: 2065 7665 6e74 2069 6e20 6d6f 7665 645f   event in moved_
+00012100: 6672 6f6d 5f74 6f3a 0a20 2020 2020 2020  from_to:.       
+00012110: 2020 2020 2020 2020 2020 2020 2064 6573               des
+00012120: 745f 7061 7468 203d 206d 6f76 6564 5f66  t_path = moved_f
+00012130: 726f 6d5f 746f 5b65 7665 6e74 5d2e 7372  rom_to[event].sr
+00012140: 635f 7061 7468 0a20 2020 2020 2020 2020  c_path.         
+00012150: 2020 2020 2020 2020 2020 2069 6620 6c65             if le
+00012160: 6e28 6576 656e 7473 5f66 6f72 5f70 6174  n(events_for_pat
+00012170: 685b 6465 7374 5f70 6174 685d 2920 3d3d  h[dest_path]) ==
+00012180: 2031 3a0a 2020 2020 2020 2020 2020 2020   1:.            
+00012190: 2020 2020 2020 2020 2020 2020 6d6f 7665              move
+000121a0: 645f 6576 656e 7473 5f74 6f5f 7265 636f  d_events_to_reco
+000121b0: 6d62 696e 652e 6170 7065 6e64 2865 7665  mbine.append(eve
+000121c0: 6e74 290a 0a20 2020 2020 2020 2020 2020  nt)..           
+000121d0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+000121e0: 2020 2020 2020 2023 2043 6f75 6e74 2068         # Count h
+000121f0: 6f77 206f 6674 656e 2074 6865 2066 696c  ow often the fil
+00012200: 6520 2f20 666f 6c64 6572 2077 6173 2063  e / folder was c
+00012210: 7265 6174 6564 2076 7320 6465 6c65 7465  reated vs delete
+00012220: 642e 0a20 2020 2020 2020 2020 2020 2020  d..             
+00012230: 2020 2023 2052 656d 656d 6265 7220 6966     # Remember if
+00012240: 2069 7420 7761 7320 6669 7273 7420 6372   it was first cr
+00012250: 6561 7465 6420 6f72 2064 656c 6574 6564  eated or deleted
+00012260: 2e0a 0a20 2020 2020 2020 2020 2020 2020  ...             
+00012270: 2020 206e 5f63 7265 6174 6564 203d 2030     n_created = 0
+00012280: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00012290: 206e 5f64 656c 6574 6564 203d 2030 0a0a   n_deleted = 0..
+000122a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000122b0: 6669 7273 745f 6372 6561 7465 645f 696e  first_created_in
+000122c0: 6465 7820 3d20 2d31 0a20 2020 2020 2020  dex = -1.       
+000122d0: 2020 2020 2020 2020 2066 6972 7374 5f64           first_d
+000122e0: 656c 6574 6564 5f69 6e64 6578 203d 202d  eleted_index = -
+000122f0: 310a 0a20 2020 2020 2020 2020 2020 2020  1..             
+00012300: 2020 2066 6f72 2069 2069 6e20 7265 7665     for i in reve
+00012310: 7273 6564 2872 616e 6765 286c 656e 2865  rsed(range(len(e
+00012320: 7665 6e74 7329 2929 3a0a 2020 2020 2020  vents))):.      
+00012330: 2020 2020 2020 2020 2020 2020 2020 6576                ev
+00012340: 656e 7420 3d20 6576 656e 7473 5b69 5d0a  ent = events[i].
+00012350: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00012360: 2020 2020 2069 6620 6973 5f63 7265 6174       if is_creat
+00012370: 6564 2865 7665 6e74 293a 0a20 2020 2020  ed(event):.     
+00012380: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012390: 2020 206e 5f63 7265 6174 6564 202b 3d20     n_created += 
+000123a0: 310a 2020 2020 2020 2020 2020 2020 2020  1.              
+000123b0: 2020 2020 2020 2020 2020 6669 7273 745f            first_
+000123c0: 6372 6561 7465 645f 696e 6465 7820 3d20  created_index = 
+000123d0: 690a 0a20 2020 2020 2020 2020 2020 2020  i..             
+000123e0: 2020 2020 2020 2069 6620 6973 5f64 656c         if is_del
+000123f0: 6574 6564 2865 7665 6e74 293a 0a20 2020  eted(event):.   
+00012400: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012410: 2020 2020 206e 5f64 656c 6574 6564 202b       n_deleted +
+00012420: 3d20 310a 2020 2020 2020 2020 2020 2020  = 1.            
+00012430: 2020 2020 2020 2020 2020 2020 6669 7273              firs
+00012440: 745f 6465 6c65 7465 645f 696e 6465 7820  t_deleted_index 
+00012450: 3d20 690a 0a20 2020 2020 2020 2020 2020  = i..           
+00012460: 2020 2020 2069 6620 6e5f 6372 6561 7465       if n_create
+00012470: 6420 3e20 6e5f 6465 6c65 7465 643a 2020  d > n_deleted:  
+00012480: 2320 4974 656d 2077 6173 2063 7265 6174  # Item was creat
+00012490: 6564 2e0a 2020 2020 2020 2020 2020 2020  ed..            
+000124a0: 2020 2020 2020 2020 6966 2065 7665 6e74          if event
+000124b0: 735b 2d31 5d2e 6973 5f64 6972 6563 746f  s[-1].is_directo
+000124c0: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
+000124d0: 2020 2020 2020 2020 2020 2020 6576 656e              even
+000124e0: 7473 5f66 6f72 5f70 6174 685b 7061 7468  ts_for_path[path
+000124f0: 5d20 3d20 5b44 6972 4372 6561 7465 6445  ] = [DirCreatedE
+00012500: 7665 6e74 2870 6174 6829 5d0a 2020 2020  vent(path)].    
+00012510: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012520: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+00012530: 2020 2020 2020 2020 2020 2020 2020 6576                ev
+00012540: 656e 7473 5f66 6f72 5f70 6174 685b 7061  ents_for_path[pa
+00012550: 7468 5d20 3d20 5b46 696c 6543 7265 6174  th] = [FileCreat
+00012560: 6564 4576 656e 7428 7061 7468 295d 0a0a  edEvent(path)]..
+00012570: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012580: 656c 6966 206e 5f63 7265 6174 6564 203c  elif n_created <
+00012590: 206e 5f64 656c 6574 6564 3a20 2023 2049   n_deleted:  # I
+000125a0: 7465 6d20 7761 7320 6465 6c65 7465 642e  tem was deleted.
+000125b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000125c0: 2020 2020 2069 6620 6576 656e 7473 5b30       if events[0
+000125d0: 5d2e 6973 5f64 6972 6563 746f 7279 3a0a  ].is_directory:.
+000125e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000125f0: 2020 2020 2020 2020 6576 656e 7473 5f66          events_f
+00012600: 6f72 5f70 6174 685b 7061 7468 5d20 3d20  or_path[path] = 
+00012610: 5b44 6972 4465 6c65 7465 6445 7665 6e74  [DirDeletedEvent
+00012620: 2870 6174 6829 5d0a 2020 2020 2020 2020  (path)].        
+00012630: 2020 2020 2020 2020 2020 2020 656c 7365              else
+00012640: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00012650: 2020 2020 2020 2020 2020 6576 656e 7473            events
+00012660: 5f66 6f72 5f70 6174 685b 7061 7468 5d20  _for_path[path] 
+00012670: 3d20 5b46 696c 6544 656c 6574 6564 4576  = [FileDeletedEv
+00012680: 656e 7428 7061 7468 295d 0a0a 2020 2020  ent(path)]..    
+00012690: 2020 2020 2020 2020 2020 2020 656c 7365              else
+000126a0: 3a20 2023 2053 616d 6520 6e75 6d62 6572  :  # Same number
+000126b0: 206f 6620 6465 6c65 7465 6420 616e 6420   of deleted and 
+000126c0: 6372 6561 7465 6420 6576 656e 7473 2e0a  created events..
+000126d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000126e0: 2020 2020 6966 206e 5f63 7265 6174 6564      if n_created
+000126f0: 203d 3d20 3020 6f72 2066 6972 7374 5f64   == 0 or first_d
+00012700: 656c 6574 6564 5f69 6e64 6578 203c 2066  eleted_index < f
+00012710: 6972 7374 5f63 7265 6174 6564 5f69 6e64  irst_created_ind
+00012720: 6578 3a0a 2020 2020 2020 2020 2020 2020  ex:.            
+00012730: 2020 2020 2020 2020 2020 2020 2320 4974              # It
+00012740: 656d 2077 6173 206d 6f64 6966 6965 642e  em was modified.
+00012750: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00012760: 2020 2020 2020 2020 2069 6620 6576 656e           if even
+00012770: 7473 5b30 5d2e 6973 5f64 6972 6563 746f  ts[0].is_directo
+00012780: 7279 2061 6e64 2065 7665 6e74 735b 2d31  ry and events[-1
+00012790: 5d2e 6973 5f64 6972 6563 746f 7279 3a0a  ].is_directory:.
+000127a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000127b0: 2020 2020 2020 2020 2020 2020 2320 426f              # Bo
+000127c0: 7468 2066 6972 7374 2061 6e64 206c 6173  th first and las
+000127d0: 7420 6576 656e 7473 2061 7265 2066 726f  t events are fro
+000127e0: 6d20 666f 6c64 6572 732e 0a20 2020 2020  m folders..     
+000127f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012800: 2020 2020 2020 2065 7665 6e74 735f 666f         events_fo
+00012810: 725f 7061 7468 5b70 6174 685d 203d 205b  r_path[path] = [
+00012820: 4469 724d 6f64 6966 6965 6445 7665 6e74  DirModifiedEvent
+00012830: 2870 6174 6829 5d0a 2020 2020 2020 2020  (path)].        
+00012840: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012850: 656c 6966 206e 6f74 2065 7665 6e74 735b  elif not events[
+00012860: 305d 2e69 735f 6469 7265 6374 6f72 7920  0].is_directory 
+00012870: 616e 6420 6e6f 7420 6576 656e 7473 5b2d  and not events[-
+00012880: 315d 2e69 735f 6469 7265 6374 6f72 793a  1].is_directory:
+00012890: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000128a0: 2020 2020 2020 2020 2020 2020 2023 2042               # B
+000128b0: 6f74 6820 6669 7273 7420 616e 6420 6c61  oth first and la
+000128c0: 7374 2065 7665 6e74 7320 6172 6520 6672  st events are fr
+000128d0: 6f6d 2066 696c 6573 2e0a 2020 2020 2020  om files..      
+000128e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000128f0: 2020 2020 2020 6576 656e 7473 5f66 6f72        events_for
+00012900: 5f70 6174 685b 7061 7468 5d20 3d20 5b46  _path[path] = [F
+00012910: 696c 654d 6f64 6966 6965 6445 7665 6e74  ileModifiedEvent
+00012920: 2870 6174 6829 5d0a 2020 2020 2020 2020  (path)].        
+00012930: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012940: 656c 6966 2065 7665 6e74 735b 305d 2e69  elif events[0].i
+00012950: 735f 6469 7265 6374 6f72 793a 0a20 2020  s_directory:.   
+00012960: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012970: 2020 2020 2020 2020 2023 2054 7970 6520           # Type 
+00012980: 6368 616e 6765 2066 6f6c 6465 7220 2d3e  change folder ->
+00012990: 2066 696c 652e 0a20 2020 2020 2020 2020   file..         
+000129a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000129b0: 2020 2065 7665 6e74 735f 666f 725f 7061     events_for_pa
+000129c0: 7468 5b70 6174 685d 203d 205b 0a20 2020  th[path] = [.   
+000129d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000129e0: 2020 2020 2020 2020 2020 2020 2044 6972               Dir
+000129f0: 4465 6c65 7465 6445 7665 6e74 2870 6174  DeletedEvent(pat
+00012a00: 6829 2c0a 2020 2020 2020 2020 2020 2020  h),.            
+00012a10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012a20: 2020 2020 4669 6c65 4372 6561 7465 6445      FileCreatedE
+00012a30: 7665 6e74 2870 6174 6829 2c0a 2020 2020  vent(path),.    
+00012a40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012a50: 2020 2020 2020 2020 5d0a 2020 2020 2020          ].      
+00012a60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012a70: 2020 656c 6966 2065 7665 6e74 735b 2d31    elif events[-1
+00012a80: 5d2e 6973 5f64 6972 6563 746f 7279 3a0a  ].is_directory:.
+00012a90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012aa0: 2020 2020 2020 2020 2020 2020 2320 5479              # Ty
+00012ab0: 7065 2063 6861 6e67 6520 6669 6c65 202d  pe change file -
+00012ac0: 3e20 666f 6c64 6572 2e0a 2020 2020 2020  > folder..      
+00012ad0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012ae0: 2020 2020 2020 6576 656e 7473 5f66 6f72        events_for
+00012af0: 5f70 6174 685b 7061 7468 5d20 3d20 5b0a  _path[path] = [.
+00012b00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012b10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012b20: 4669 6c65 4465 6c65 7465 6445 7665 6e74  FileDeletedEvent
+00012b30: 2870 6174 6829 2c0a 2020 2020 2020 2020  (path),.        
+00012b40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012b50: 2020 2020 2020 2020 4469 7243 7265 6174          DirCreat
+00012b60: 6564 4576 656e 7428 7061 7468 292c 0a20  edEvent(path),. 
+00012b70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012b80: 2020 2020 2020 2020 2020 205d 0a20 2020             ].   
+00012b90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012ba0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+00012bb0: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+00012bc0: 2049 7465 6d20 7761 7320 6c69 6b65 6c79   Item was likely
+00012bd0: 206f 6e6c 7920 7465 6d70 6f72 6172 792e   only temporary.
+00012be0: 2057 6520 7374 696c 6c20 7472 6967 6765   We still trigge
+00012bf0: 7220 6120 7265 7363 616e 206f 660a 2020  r a rescan of.  
+00012c00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012c10: 2020 2020 2020 2320 7468 6520 7061 7468        # the path
+00012c20: 2062 6563 6175 7365 2073 6f6d 6520 6174   because some at
+00012c30: 6f6d 6963 206d 6f64 6966 6963 6174 696f  omic modificatio
+00012c40: 6e73 206d 6179 2062 6520 7265 706f 7274  ns may be report
+00012c50: 6564 2061 730a 2020 2020 2020 2020 2020  ed as.          
+00012c60: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+00012c70: 6f75 742d 6f66 2d6f 7264 6572 2063 7265  out-of-order cre
+00012c80: 6174 6564 2061 6e64 2064 656c 6574 6564  ated and deleted
+00012c90: 2065 7665 6e74 7320 6f6e 206d 6163 4f53   events on macOS
+00012ca0: 2e0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00012cb0: 2020 2020 2020 2020 2020 6465 6c20 6576            del ev
+00012cc0: 656e 7473 5f66 6f72 5f70 6174 685b 7061  ents_for_path[pa
+00012cd0: 7468 5d0a 2020 2020 2020 2020 2020 2020  th].            
+00012ce0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+00012cf0: 2e72 6573 6361 6e28 7061 7468 290a 0a20  .rescan(path).. 
+00012d00: 2020 2020 2020 2023 2052 6563 6f6d 6269         # Recombi
+00012d10: 6e65 206d 6f76 6564 2065 7665 6e74 7320  ne moved events 
+00012d20: 6966 2077 6520 6861 7665 2072 6574 6169  if we have retai
+00012d30: 6e65 6420 626f 7468 2073 6964 6573 206f  ned both sides o
+00012d40: 6620 6576 656e 7420 6475 7269 6e67 2074  f event during t
+00012d50: 6865 0a20 2020 2020 2020 2023 2061 626f  he.        # abo
+00012d60: 7665 2063 6f6e 736f 6c69 6461 7469 6f6e  ve consolidation
+00012d70: 2e0a 2020 2020 2020 2020 666f 7220 7372  ..        for sr
+00012d80: 635f 6576 656e 7420 696e 206d 6f76 6564  c_event in moved
+00012d90: 5f65 7665 6e74 735f 746f 5f72 6563 6f6d  _events_to_recom
+00012da0: 6269 6e65 3a0a 2020 2020 2020 2020 2020  bine:.          
+00012db0: 2020 7372 635f 7061 7468 203d 2073 7263    src_path = src
+00012dc0: 5f65 7665 6e74 2e73 7263 5f70 6174 680a  _event.src_path.
+00012dd0: 2020 2020 2020 2020 2020 2020 6465 7374              dest
+00012de0: 5f70 6174 6820 3d20 6d6f 7665 645f 6672  _path = moved_fr
+00012df0: 6f6d 5f74 6f5b 7372 635f 6576 656e 745d  om_to[src_event]
+00012e00: 2e73 7263 5f70 6174 680a 0a20 2020 2020  .src_path..     
+00012e10: 2020 2020 2020 206e 6577 5f65 7665 6e74         new_event
+00012e20: 3a20 4469 724d 6f76 6564 4576 656e 7420  : DirMovedEvent 
+00012e30: 7c20 4669 6c65 4d6f 7665 6445 7665 6e74  | FileMovedEvent
+00012e40: 0a0a 2020 2020 2020 2020 2020 2020 6966  ..            if
+00012e50: 2073 7263 5f65 7665 6e74 2e69 735f 6469   src_event.is_di
+00012e60: 7265 6374 6f72 793a 0a20 2020 2020 2020  rectory:.       
+00012e70: 2020 2020 2020 2020 206e 6577 5f65 7665           new_eve
+00012e80: 6e74 203d 2044 6972 4d6f 7665 6445 7665  nt = DirMovedEve
+00012e90: 6e74 2873 7263 5f70 6174 682c 2064 6573  nt(src_path, des
+00012ea0: 745f 7061 7468 290a 2020 2020 2020 2020  t_path).        
+00012eb0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+00012ec0: 2020 2020 2020 2020 2020 6e65 775f 6576            new_ev
+00012ed0: 656e 7420 3d20 4669 6c65 4d6f 7665 6445  ent = FileMovedE
+00012ee0: 7665 6e74 2873 7263 5f70 6174 682c 2064  vent(src_path, d
+00012ef0: 6573 745f 7061 7468 290a 0a20 2020 2020  est_path)..     
+00012f00: 2020 2020 2020 2023 204f 6e6c 7920 7265         # Only re
+00012f10: 636f 6d62 696e 6520 6576 656e 7473 2069  combine events i
+00012f20: 6620 6e65 6974 6865 7220 6861 7320 616e  f neither has an
+00012f30: 2065 7863 6c75 6465 6420 7061 7468 3a20   excluded path: 
+00012f40: 5765 2077 616e 7420 746f 0a20 2020 2020  We want to.     
+00012f50: 2020 2020 2020 2023 2074 7265 6174 2072         # treat r
+00012f60: 656e 616d 696e 6720 6672 6f6d 202f 2074  enaming from / t
+00012f70: 6f20 616e 2065 7863 6c75 6465 6420 7061  o an excluded pa
+00012f80: 7468 2061 7320 6120 6372 6561 7469 6f6e  th as a creation
+00012f90: 202f 2064 656c 6574 696f 6e2c 0a20 2020   / deletion,.   
+00012fa0: 2020 2020 2020 2020 2023 2072 6573 7065           # respe
+00012fb0: 6374 6976 656c 792e 0a20 2020 2020 2020  ctively..       
+00012fc0: 2020 2020 2069 6620 6e6f 7420 7365 6c66       if not self
+00012fd0: 2e5f 7368 6f75 6c64 5f73 706c 6974 5f65  ._should_split_e
+00012fe0: 7863 6c75 6465 6428 6e65 775f 6576 656e  xcluded(new_even
+00012ff0: 7429 3a0a 2020 2020 2020 2020 2020 2020  t):.            
+00013000: 2020 2020 6465 6c20 6576 656e 7473 5f66      del events_f
+00013010: 6f72 5f70 6174 685b 7372 635f 7061 7468  or_path[src_path
+00013020: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
+00013030: 2020 6576 656e 7473 5f66 6f72 5f70 6174    events_for_pat
+00013040: 685b 6465 7374 5f70 6174 685d 203d 205b  h[dest_path] = [
+00013050: 6e65 775f 6576 656e 745d 0a0a 2020 2020  new_event]..    
+00013060: 2020 2020 2320 4174 2074 6869 7320 706f      # At this po
+00013070: 696e 742c 2060 6576 656e 7473 5f66 6f72  int, `events_for
+00013080: 5f70 6174 6860 2077 696c 6c20 636f 6e74  _path` will cont
+00013090: 6169 6e20 6120 7369 6e67 6c65 2065 7665  ain a single eve
+000130a0: 6e74 2070 6572 2070 6174 6820 6f72 0a20  nt per path or. 
+000130b0: 2020 2020 2020 2023 2065 7861 6374 6c79         # exactly
+000130c0: 2074 776f 2065 7665 6e74 7320 2864 656c   two events (del
+000130d0: 6574 6564 2061 6e64 2063 7265 6174 6564  eted and created
+000130e0: 2920 696e 2063 6173 6520 6f66 2061 2074  ) in case of a t
+000130f0: 7970 6520 6368 616e 6765 2e0a 0a20 2020  ype change...   
+00013100: 2020 2020 2023 2043 4f4d 4249 4e45 204d       # COMBINE M
+00013110: 4f56 4544 2041 4e44 2044 454c 4554 4544  OVED AND DELETED
+00013120: 2045 5645 4e54 5320 4f46 2046 4f4c 4445   EVENTS OF FOLDE
+00013130: 5253 2041 4e44 2054 4845 4952 2043 4849  RS AND THEIR CHI
+00013140: 4c44 5245 4e20 494e 544f 204f 4e45 2045  LDREN INTO ONE E
+00013150: 5645 4e54 0a0a 2020 2020 2020 2020 2320  VENT..        # 
+00013160: 4176 6f69 6420 6e65 7374 6564 2069 7465  Avoid nested ite
+00013170: 7261 7469 6f6e 7320 6f76 6572 2061 6c6c  rations over all
+00013180: 2065 7665 6e74 7320 6865 7265 2c20 7468   events here, th
+00013190: 6579 2061 7265 206f 6e20 7468 6520 6f72  ey are on the or
+000131a0: 6465 7220 6f66 204f 286e 5e32 290a 2020  der of O(n^2).  
+000131b0: 2020 2020 2020 2320 7768 6963 6820 6265        # which be
+000131c0: 636f 6d65 7320 636f 7374 6c79 2077 6865  comes costly whe
+000131d0: 6e20 7468 6520 7573 6572 206d 6f76 6573  n the user moves
+000131e0: 206f 7220 6465 6c65 7465 7320 666f 6c64   or deletes fold
+000131f0: 6572 2077 6974 6820 6120 6c61 7267 6520  er with a large 
+00013200: 6e75 6d62 6572 0a20 2020 2020 2020 2023  number.        #
+00013210: 206f 6620 6368 696c 6472 656e 2e20 4265   of children. Be
+00013220: 6e63 686d 6172 6b3a 2061 696d 2074 6f20  nchmark: aim to 
+00013230: 7374 6179 2062 656c 6f77 2031 2073 6563  stay below 1 sec
+00013240: 2066 6f72 2032 302c 3030 3020 6e65 7374   for 20,000 nest
+00013250: 6564 2065 7665 6e74 7320 6f6e 0a20 2020  ed events on.   
+00013260: 2020 2020 2023 2072 6570 7265 7365 6e74       # represent
+00013270: 6174 6976 6520 6c61 7074 6f70 2050 4373  ative laptop PCs
+00013280: 2e0a 0a20 2020 2020 2020 2023 2030 2920  ...        # 0) 
+00013290: 436f 6c6c 6563 7420 616c 6c20 6d6f 7665  Collect all move
+000132a0: 6420 616e 6420 6465 6c65 7465 6420 6576  d and deleted ev
+000132b0: 656e 7473 2069 6e20 7365 7473 2e0a 0a20  ents in sets... 
+000132c0: 2020 2020 2020 2064 6972 5f6d 6f76 6564         dir_moved
+000132d0: 5f70 6174 6873 3a20 7365 745b 7475 706c  _paths: set[tupl
+000132e0: 655b 7374 722c 2073 7472 5d5d 203d 2073  e[str, str]] = s
+000132f0: 6574 2829 0a20 2020 2020 2020 2064 6972  et().        dir
+00013300: 5f64 656c 6574 6564 5f70 6174 6873 3a20  _deleted_paths: 
+00013310: 7365 745b 7374 725d 203d 2073 6574 2829  set[str] = set()
+00013320: 0a0a 2020 2020 2020 2020 666f 7220 6576  ..        for ev
+00013330: 656e 7473 2069 6e20 6576 656e 7473 5f66  ents in events_f
+00013340: 6f72 5f70 6174 682e 7661 6c75 6573 2829  or_path.values()
+00013350: 3a0a 2020 2020 2020 2020 2020 2020 6576  :.            ev
+00013360: 656e 7420 3d20 6576 656e 7473 5b30 5d0a  ent = events[0].
+00013370: 2020 2020 2020 2020 2020 2020 6966 2069              if i
+00013380: 7369 6e73 7461 6e63 6528 6576 656e 742c  sinstance(event,
+00013390: 2044 6972 4d6f 7665 6445 7665 6e74 293a   DirMovedEvent):
+000133a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000133b0: 2064 6972 5f6d 6f76 6564 5f70 6174 6873   dir_moved_paths
+000133c0: 2e61 6464 2828 6576 656e 742e 7372 635f  .add((event.src_
+000133d0: 7061 7468 2c20 6576 656e 742e 6465 7374  path, event.dest
+000133e0: 5f70 6174 6829 290a 2020 2020 2020 2020  _path)).        
+000133f0: 2020 2020 656c 6966 2069 7369 6e73 7461      elif isinsta
+00013400: 6e63 6528 6576 656e 742c 2044 6972 4465  nce(event, DirDe
+00013410: 6c65 7465 6445 7665 6e74 293a 0a20 2020  letedEvent):.   
+00013420: 2020 2020 2020 2020 2020 2020 2064 6972               dir
+00013430: 5f64 656c 6574 6564 5f70 6174 6873 2e61  _deleted_paths.a
+00013440: 6464 2865 7665 6e74 2e73 7263 5f70 6174  dd(event.src_pat
+00013450: 6829 0a0a 2020 2020 2020 2020 2320 3129  h)..        # 1)
+00013460: 2043 6f6d 6269 6e65 206d 6f76 6564 2065   Combine moved e
+00013470: 7665 6e74 7320 6f66 2066 6f6c 6465 7273  vents of folders
+00013480: 2061 6e64 2074 6865 6972 2063 6869 6c64   and their child
+00013490: 7265 6e20 696e 746f 206f 6e65 2065 7665  ren into one eve
+000134a0: 6e74 2e0a 0a20 2020 2020 2020 2069 6620  nt...        if 
+000134b0: 6c65 6e28 6469 725f 6d6f 7665 645f 7061  len(dir_moved_pa
+000134c0: 7468 7329 203e 2030 3a0a 2020 2020 2020  ths) > 0:.      
+000134d0: 2020 2020 2020 6368 696c 645f 6d6f 7665        child_move
+000134e0: 645f 6473 745f 7061 7468 733a 2073 6574  d_dst_paths: set
+000134f0: 5b73 7472 5d20 3d20 7365 7428 290a 0a20  [str] = set().. 
+00013500: 2020 2020 2020 2020 2020 2023 2046 6f72             # For
+00013510: 2065 6163 6820 6576 656e 742c 2063 6865   each event, che
+00013520: 636b 2069 6620 6974 2069 7320 6120 6368  ck if it is a ch
+00013530: 696c 6420 6f66 2061 206d 6f76 6564 2065  ild of a moved e
+00013540: 7665 6e74 2064 6973 6361 7264 2069 7420  vent discard it 
+00013550: 6966 2079 6573 2e0a 2020 2020 2020 2020  if yes..        
+00013560: 2020 2020 666f 7220 6576 656e 7473 2069      for events i
+00013570: 6e20 6576 656e 7473 5f66 6f72 5f70 6174  n events_for_pat
+00013580: 682e 7661 6c75 6573 2829 3a0a 2020 2020  h.values():.    
+00013590: 2020 2020 2020 2020 2020 2020 6576 656e              even
+000135a0: 7420 3d20 6576 656e 7473 5b30 5d0a 2020  t = events[0].  
+000135b0: 2020 2020 2020 2020 2020 2020 2020 6966                if
+000135c0: 2069 735f 6d6f 7665 6428 6576 656e 7429   is_moved(event)
+000135d0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+000135e0: 2020 2020 2020 6469 726e 616d 6573 203d        dirnames =
+000135f0: 2028 0a20 2020 2020 2020 2020 2020 2020   (.             
+00013600: 2020 2020 2020 2020 2020 206f 7370 2e64             osp.d
+00013610: 6972 6e61 6d65 2865 7665 6e74 2e73 7263  irname(event.src
+00013620: 5f70 6174 6829 2c0a 2020 2020 2020 2020  _path),.        
+00013630: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013640: 6f73 702e 6469 726e 616d 6528 6576 656e  osp.dirname(even
+00013650: 742e 6465 7374 5f70 6174 6829 2c0a 2020  t.dest_path),.  
+00013660: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013670: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
+00013680: 2020 2020 2020 2020 6966 2064 6972 6e61          if dirna
+00013690: 6d65 7320 696e 2064 6972 5f6d 6f76 6564  mes in dir_moved
+000136a0: 5f70 6174 6873 3a0a 2020 2020 2020 2020  _paths:.        
+000136b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000136c0: 6368 696c 645f 6d6f 7665 645f 6473 745f  child_moved_dst_
+000136d0: 7061 7468 732e 6164 6428 6576 656e 742e  paths.add(event.
+000136e0: 6465 7374 5f70 6174 6829 0a0a 2020 2020  dest_path)..    
+000136f0: 2020 2020 2020 2020 666f 7220 7061 7468          for path
+00013700: 2069 6e20 6368 696c 645f 6d6f 7665 645f   in child_moved_
+00013710: 6473 745f 7061 7468 733a 0a20 2020 2020  dst_paths:.     
+00013720: 2020 2020 2020 2020 2020 2064 656c 2065             del e
+00013730: 7665 6e74 735f 666f 725f 7061 7468 5b70  vents_for_path[p
+00013740: 6174 685d 0a0a 2020 2020 2020 2020 2320  ath]..        # 
+00013750: 3229 2043 6f6d 6269 6e65 2064 656c 6574  2) Combine delet
+00013760: 6564 2065 7665 6e74 7320 6f66 2066 6f6c  ed events of fol
+00013770: 6465 7273 2061 6e64 2074 6865 6972 2063  ders and their c
+00013780: 6869 6c64 7265 6e20 746f 206f 6e65 2065  hildren to one e
+00013790: 7665 6e74 2e0a 0a20 2020 2020 2020 2069  vent...        i
+000137a0: 6620 6c65 6e28 6469 725f 6465 6c65 7465  f len(dir_delete
+000137b0: 645f 7061 7468 7329 203e 2030 3a0a 2020  d_paths) > 0:.  
+000137c0: 2020 2020 2020 2020 2020 6368 696c 645f            child_
+000137d0: 6465 6c65 7465 645f 7061 7468 733a 2073  deleted_paths: s
+000137e0: 6574 5b73 7472 5d20 3d20 7365 7428 290a  et[str] = set().
+000137f0: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
+00013800: 2065 7665 6e74 7320 696e 2065 7665 6e74   events in event
+00013810: 735f 666f 725f 7061 7468 2e76 616c 7565  s_for_path.value
+00013820: 7328 293a 0a20 2020 2020 2020 2020 2020  s():.           
+00013830: 2020 2020 2065 7665 6e74 203d 2065 7665       event = eve
+00013840: 6e74 735b 305d 0a20 2020 2020 2020 2020  nts[0].         
+00013850: 2020 2020 2020 2069 6620 6973 5f64 656c         if is_del
+00013860: 6574 6564 2865 7665 6e74 293a 0a20 2020  eted(event):.   
+00013870: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013880: 2064 6972 6e61 6d65 203d 206f 7370 2e64   dirname = osp.d
+00013890: 6972 6e61 6d65 2865 7665 6e74 2e73 7263  irname(event.src
+000138a0: 5f70 6174 6829 0a20 2020 2020 2020 2020  _path).         
+000138b0: 2020 2020 2020 2020 2020 2069 6620 6469             if di
+000138c0: 726e 616d 6520 696e 2064 6972 5f64 656c  rname in dir_del
+000138d0: 6574 6564 5f70 6174 6873 3a0a 2020 2020  eted_paths:.    
+000138e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000138f0: 2020 2020 6368 696c 645f 6465 6c65 7465      child_delete
+00013900: 645f 7061 7468 732e 6164 6428 6576 656e  d_paths.add(even
+00013910: 742e 7372 635f 7061 7468 290a 0a20 2020  t.src_path)..   
+00013920: 2020 2020 2020 2020 2066 6f72 2070 6174           for pat
+00013930: 6820 696e 2063 6869 6c64 5f64 656c 6574  h in child_delet
+00013940: 6564 5f70 6174 6873 3a0a 2020 2020 2020  ed_paths:.      
+00013950: 2020 2020 2020 2020 2020 6465 6c20 6576            del ev
+00013960: 656e 7473 5f66 6f72 5f70 6174 685b 7061  ents_for_path[pa
+00013970: 7468 5d0a 0a20 2020 2020 2020 2023 2050  th]..        # P
+00013980: 5245 5041 5245 2052 4554 5552 4e20 5641  REPARE RETURN VA
+00013990: 4c55 4520 414e 4420 4652 4545 204d 454d  LUE AND FREE MEM
+000139a0: 4f52 590a 0a20 2020 2020 2020 2063 6c65  ORY..        cle
+000139b0: 616e 6564 5f65 7665 6e74 7320 3d20 5b5d  aned_events = []
+000139c0: 0a0a 2020 2020 2020 2020 666f 7220 6576  ..        for ev
+000139d0: 656e 7473 2069 6e20 6576 656e 7473 5f66  ents in events_f
+000139e0: 6f72 5f70 6174 682e 7661 6c75 6573 2829  or_path.values()
+000139f0: 3a0a 2020 2020 2020 2020 2020 2020 636c  :.            cl
+00013a00: 6561 6e65 645f 6576 656e 7473 2e65 7874  eaned_events.ext
+00013a10: 656e 6428 6576 656e 7473 290a 0a20 2020  end(events)..   
+00013a20: 2020 2020 2023 2046 7265 6520 6d65 6d6f       # Free memo
+00013a30: 7279 2065 6172 6c79 2074 6f20 7072 6576  ry early to prev
+00013a40: 656e 7420 6672 6167 6d65 6e74 6174 696f  ent fragmentatio
+00013a50: 6e2e 0a20 2020 2020 2020 2064 656c 2065  n..        del e
+00013a60: 7665 6e74 735f 666f 725f 7061 7468 0a20  vents_for_path. 
+00013a70: 2020 2020 2020 2064 656c 206d 6f76 6564         del moved
+00013a80: 5f66 726f 6d5f 746f 0a20 2020 2020 2020  _from_to.       
+00013a90: 2064 656c 206d 6f76 6564 5f65 7665 6e74   del moved_event
+00013aa0: 735f 746f 5f72 6563 6f6d 6269 6e65 0a20  s_to_recombine. 
+00013ab0: 2020 2020 2020 2064 656c 2064 6972 5f6d         del dir_m
+00013ac0: 6f76 6564 5f70 6174 6873 0a20 2020 2020  oved_paths.     
+00013ad0: 2020 2064 656c 2064 6972 5f64 656c 6574     del dir_delet
+00013ae0: 6564 5f70 6174 6873 0a20 2020 2020 2020  ed_paths.       
+00013af0: 2067 632e 636f 6c6c 6563 7428 290a 0a20   gc.collect().. 
+00013b00: 2020 2020 2020 2072 6574 7572 6e20 636c         return cl
+00013b10: 6561 6e65 645f 6576 656e 7473 0a0a 2020  eaned_events..  
+00013b20: 2020 6465 6620 5f73 686f 756c 645f 7370    def _should_sp
+00013b30: 6c69 745f 6578 636c 7564 6564 2873 656c  lit_excluded(sel
+00013b40: 662c 2065 7665 6e74 3a20 4669 6c65 4d6f  f, event: FileMo
+00013b50: 7665 6445 7665 6e74 207c 2044 6972 4d6f  vedEvent | DirMo
+00013b60: 7665 6445 7665 6e74 2920 2d3e 2062 6f6f  vedEvent) -> boo
+00013b70: 6c3a 0a20 2020 2020 2020 2064 6278 5f73  l:.        dbx_s
+00013b80: 7263 5f70 6174 6820 3d20 7365 6c66 2e74  rc_path = self.t
+00013b90: 6f5f 6462 785f 7061 7468 2865 7665 6e74  o_dbx_path(event
+00013ba0: 2e73 7263 5f70 6174 6829 0a20 2020 2020  .src_path).     
+00013bb0: 2020 2064 6278 5f64 6573 745f 7061 7468     dbx_dest_path
+00013bc0: 203d 2073 656c 662e 746f 5f64 6278 5f70   = self.to_dbx_p
+00013bd0: 6174 6828 6576 656e 742e 6465 7374 5f70  ath(event.dest_p
+00013be0: 6174 6829 0a0a 2020 2020 2020 2020 6966  ath)..        if
+00013bf0: 2028 0a20 2020 2020 2020 2020 2020 2073   (.            s
+00013c00: 656c 662e 6973 5f65 7863 6c75 6465 6428  elf.is_excluded(
+00013c10: 6576 656e 742e 7372 635f 7061 7468 290a  event.src_path).
+00013c20: 2020 2020 2020 2020 2020 2020 6f72 2073              or s
+00013c30: 656c 662e 6973 5f65 7863 6c75 6465 6428  elf.is_excluded(
+00013c40: 6576 656e 742e 6465 7374 5f70 6174 6829  event.dest_path)
+00013c50: 0a20 2020 2020 2020 2020 2020 206f 7220  .            or 
+00013c60: 7365 6c66 2e69 735f 6578 636c 7564 6564  self.is_excluded
+00013c70: 5f62 795f 7573 6572 286e 6f72 6d61 6c69  _by_user(normali
+00013c80: 7a65 2864 6278 5f73 7263 5f70 6174 6829  ze(dbx_src_path)
+00013c90: 290a 2020 2020 2020 2020 2020 2020 6f72  ).            or
+00013ca0: 2073 656c 662e 6973 5f65 7863 6c75 6465   self.is_exclude
+00013cb0: 645f 6279 5f75 7365 7228 6e6f 726d 616c  d_by_user(normal
+00013cc0: 697a 6528 6462 785f 6465 7374 5f70 6174  ize(dbx_dest_pat
+00013cd0: 6829 290a 2020 2020 2020 2020 293a 0a20  h)).        ):. 
+00013ce0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+00013cf0: 6e20 5472 7565 0a0a 2020 2020 2020 2020  n True..        
+00013d00: 656c 6966 206c 656e 2873 656c 662e 6d69  elif len(self.mi
+00013d10: 676e 6f72 655f 7275 6c65 732e 7061 7474  gnore_rules.patt
+00013d20: 6572 6e73 2920 3d3d 2030 3a0a 2020 2020  erns) == 0:.    
+00013d30: 2020 2020 2020 2020 7265 7475 726e 2046          return F
+00013d40: 616c 7365 0a20 2020 2020 2020 2065 6c73  alse.        els
+00013d50: 653a 0a20 2020 2020 2020 2020 2020 2073  e:.            s
+00013d60: 7263 5f69 735f 6d69 676e 6f72 6520 3d20  rc_is_mignore = 
+00013d70: 7365 6c66 2e5f 6973 5f6d 6967 6e6f 7265  self._is_mignore
+00013d80: 5f70 6174 6828 6462 785f 7372 635f 7061  _path(dbx_src_pa
+00013d90: 7468 2c20 6576 656e 742e 6973 5f64 6972  th, event.is_dir
+00013da0: 6563 746f 7279 290a 2020 2020 2020 2020  ectory).        
+00013db0: 2020 2020 6465 7374 5f69 735f 6d69 676e      dest_is_mign
+00013dc0: 6f72 6520 3d20 7365 6c66 2e5f 6973 5f6d  ore = self._is_m
+00013dd0: 6967 6e6f 7265 5f70 6174 6828 6462 785f  ignore_path(dbx_
+00013de0: 6465 7374 5f70 6174 682c 2065 7665 6e74  dest_path, event
+00013df0: 2e69 735f 6469 7265 6374 6f72 7929 0a0a  .is_directory)..
+00013e00: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+00013e10: 726e 2073 7263 5f69 735f 6d69 676e 6f72  rn src_is_mignor
+00013e20: 6520 6f72 2064 6573 745f 6973 5f6d 6967  e or dest_is_mig
+00013e30: 6e6f 7265 0a0a 2020 2020 6465 6620 5f68  nore..    def _h
+00013e40: 616e 646c 655f 6e6f 726d 616c 697a 6174  andle_normalizat
+00013e50: 696f 6e5f 636f 6e66 6c69 6374 2873 656c  ion_conflict(sel
+00013e60: 662c 2065 7665 6e74 3a20 5379 6e63 4576  f, event: SyncEv
+00013e70: 656e 7429 202d 3e20 626f 6f6c 3a0a 2020  ent) -> bool:.  
+00013e80: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
+00013e90: 2020 4368 6563 6b73 2066 6f72 206f 7468    Checks for oth
+00013ea0: 6572 2069 7465 6d73 2069 6e20 7468 6520  er items in the 
+00013eb0: 7361 6d65 2064 6972 6563 746f 7279 2077  same directory w
+00013ec0: 6974 6820 6120 6469 6666 6572 656e 7420  ith a different 
+00013ed0: 6e61 6d65 2062 7574 2074 6865 2073 616d  name but the sam
+00013ee0: 650a 2020 2020 2020 2020 6e6f 726d 616c  e.        normal
+00013ef0: 697a 6174 696f 6e2e 0a0a 2020 2020 2020  ization...      
+00013f00: 2020 3a70 6172 616d 2065 7665 6e74 3a20    :param event: 
+00013f10: 5379 6e63 4576 656e 7420 666f 7220 6c6f  SyncEvent for lo
+00013f20: 6361 6c20 6372 6561 7465 6420 6f72 206d  cal created or m
+00013f30: 6f76 6564 2065 7665 6e74 2e0a 2020 2020  oved event..    
+00013f40: 2020 2020 3a72 6574 7572 6e73 3a20 5768      :returns: Wh
+00013f50: 6574 6865 7220 6120 6361 7365 2063 6f6e  ether a case con
+00013f60: 666c 6963 7420 7761 7320 6465 7465 6374  flict was detect
+00013f70: 6564 2061 6e64 2068 616e 646c 6564 2e0a  ed and handled..
+00013f80: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
+00013f90: 2020 2020 6966 206e 6f74 2028 6576 656e      if not (even
+00013fa0: 742e 6973 5f61 6464 6564 206f 7220 6576  t.is_added or ev
+00013fb0: 656e 742e 6973 5f6d 6f76 6564 293a 0a20  ent.is_moved):. 
+00013fc0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+00013fd0: 6e20 4661 6c73 650a 0a20 2020 2020 2020  n False..       
+00013fe0: 2064 6972 6e61 6d65 2c20 6261 7365 6e61   dirname, basena
+00013ff0: 6d65 203d 206f 7370 2e73 706c 6974 2865  me = osp.split(e
+00014000: 7665 6e74 2e6c 6f63 616c 5f70 6174 6829  vent.local_path)
+00014010: 0a20 2020 2020 2020 2065 7175 6976 616c  .        equival
+00014020: 656e 745f 7061 7468 7320 3d20 6765 745f  ent_paths = get_
+00014030: 6578 6973 7469 6e67 5f65 7175 6976 616c  existing_equival
+00014040: 656e 745f 7061 7468 7328 6261 7365 6e61  ent_paths(basena
+00014050: 6d65 2c20 726f 6f74 3d64 6972 6e61 6d65  me, root=dirname
+00014060: 290a 0a20 2020 2020 2020 2069 6620 6c65  )..        if le
+00014070: 6e28 6571 7569 7661 6c65 6e74 5f70 6174  n(equivalent_pat
+00014080: 6873 2920 3e20 313a 0a20 2020 2020 2020  hs) > 1:.       
+00014090: 2020 2020 2023 2057 6520 6861 7665 2064       # We have d
+000140a0: 6966 6665 7265 6e74 2066 696c 6520 6e61  ifferent file na
+000140b0: 6d65 7320 7468 6174 2077 6f75 6c64 206d  mes that would m
+000140c0: 6170 2074 6f20 7468 6520 7361 6d65 206e  ap to the same n
+000140d0: 6f72 6d61 6c69 7a65 6420 7061 7468 210a  ormalized path!.
+000140e0: 0a20 2020 2020 2020 2020 2020 2063 6f6e  .            con
+000140f0: 666c 6963 745f 7061 7468 203d 206e 6578  flict_path = nex
+00014100: 7428 7020 666f 7220 7020 696e 2065 7175  t(p for p in equ
+00014110: 6976 616c 656e 745f 7061 7468 7320 6966  ivalent_paths if
+00014120: 2070 2021 3d20 6576 656e 742e 6c6f 6361   p != event.loca
+00014130: 6c5f 7061 7468 290a 0a20 2020 2020 2020  l_path)..       
+00014140: 2020 2020 2023 2043 6865 636b 2069 6620       # Check if 
+00014150: 7765 2068 6176 6520 6120 6361 7365 2063  we have a case c
+00014160: 6f6e 666c 6963 7420 6f72 2061 2075 6e69  onflict or a uni
+00014170: 636f 6465 2063 6f6e 666c 6963 742e 0a0a  code conflict...
+00014180: 2020 2020 2020 2020 2020 2020 6966 206e              if n
+00014190: 6f72 6d61 6c69 7a65 5f63 6173 6528 6576  ormalize_case(ev
+000141a0: 656e 742e 6c6f 6361 6c5f 7061 7468 2920  ent.local_path) 
+000141b0: 3d3d 206e 6f72 6d61 6c69 7a65 5f63 6173  == normalize_cas
+000141c0: 6528 636f 6e66 6c69 6374 5f70 6174 6829  e(conflict_path)
+000141d0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+000141e0: 2020 7375 6666 6978 203d 2022 6361 7365    suffix = "case
+000141f0: 2063 6f6e 666c 6963 7422 0a20 2020 2020   conflict".     
+00014200: 2020 2020 2020 2065 6c69 6620 6e6f 726d         elif norm
+00014210: 616c 697a 655f 756e 6963 6f64 6528 6576  alize_unicode(ev
+00014220: 656e 742e 6c6f 6361 6c5f 7061 7468 2920  ent.local_path) 
+00014230: 3d3d 206e 6f72 6d61 6c69 7a65 5f63 6173  == normalize_cas
+00014240: 6528 636f 6e66 6c69 6374 5f70 6174 6829  e(conflict_path)
+00014250: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00014260: 2020 7375 6666 6978 203d 2022 756e 6963    suffix = "unic
+00014270: 6f64 6520 636f 6e66 6c69 6374 220a 2020  ode conflict".  
+00014280: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
+00014290: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000142a0: 7375 6666 6978 203d 2022 6e6f 726d 616c  suffix = "normal
+000142b0: 697a 6174 696f 6e20 636f 6e66 6c69 6374  ization conflict
+000142c0: 220a 0a20 2020 2020 2020 2020 2020 206c  "..            l
+000142d0: 6f63 616c 5f70 6174 685f 6363 203d 2067  ocal_path_cc = g
+000142e0: 656e 6572 6174 655f 6363 5f6e 616d 6528  enerate_cc_name(
+000142f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00014300: 2065 7665 6e74 2e6c 6f63 616c 5f70 6174   event.local_pat
+00014310: 682c 0a20 2020 2020 2020 2020 2020 2020  h,.             
+00014320: 2020 2073 7566 6669 783d 7375 6666 6978     suffix=suffix
+00014330: 2c0a 2020 2020 2020 2020 2020 2020 290a  ,.            ).
+00014340: 0a20 2020 2020 2020 2020 2020 2065 7665  .            eve
+00014350: 6e74 5f63 6c73 203d 2044 6972 4d6f 7665  nt_cls = DirMove
+00014360: 6445 7665 6e74 2069 6620 6973 6469 7228  dEvent if isdir(
+00014370: 6576 656e 742e 6c6f 6361 6c5f 7061 7468  event.local_path
+00014380: 2920 656c 7365 2046 696c 654d 6f76 6564  ) else FileMoved
+00014390: 4576 656e 740a 2020 2020 2020 2020 2020  Event.          
+000143a0: 2020 7769 7468 2073 656c 662e 6673 5f65    with self.fs_e
+000143b0: 7665 6e74 732e 6967 6e6f 7265 2865 7665  vents.ignore(eve
+000143c0: 6e74 5f63 6c73 2865 7665 6e74 2e6c 6f63  nt_cls(event.loc
+000143d0: 616c 5f70 6174 682c 206c 6f63 616c 5f70  al_path, local_p
+000143e0: 6174 685f 6363 2929 3a0a 2020 2020 2020  ath_cc)):.      
+000143f0: 2020 2020 2020 2020 2020 7769 7468 2063            with c
+00014400: 6f6e 7665 7274 5f61 7069 5f65 7272 6f72  onvert_api_error
+00014410: 7328 293a 0a20 2020 2020 2020 2020 2020  s():.           
+00014420: 2020 2020 2020 2020 206d 6f76 6528 6576           move(ev
+00014430: 656e 742e 6c6f 6361 6c5f 7061 7468 2c20  ent.local_path, 
+00014440: 6c6f 6361 6c5f 7061 7468 5f63 632c 2072  local_path_cc, r
+00014450: 6169 7365 5f65 7272 6f72 3d54 7275 6529  aise_error=True)
+00014460: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00014470: 2020 7365 6c66 2e72 6573 6361 6e28 6c6f    self.rescan(lo
+00014480: 6361 6c5f 7061 7468 5f63 6329 0a0a 2020  cal_path_cc)..  
+00014490: 2020 2020 2020 2020 2020 7365 6c66 2e5f            self._
+000144a0: 6c6f 6767 6572 2e69 6e66 6f28 0a20 2020  logger.info(.   
+000144b0: 2020 2020 2020 2020 2020 2020 2027 4e6f               'No
+000144c0: 726d 616c 697a 6174 696f 6e20 636f 6e66  rmalization conf
+000144d0: 6c69 6374 3a20 7265 6e61 6d65 6420 2225  lict: renamed "%
+000144e0: 7322 2074 6f20 2225 7322 272c 0a20 2020  s" to "%s"',.   
+000144f0: 2020 2020 2020 2020 2020 2020 2065 7665               eve
+00014500: 6e74 2e6c 6f63 616c 5f70 6174 682c 0a20  nt.local_path,. 
+00014510: 2020 2020 2020 2020 2020 2020 2020 206c                 l
+00014520: 6f63 616c 5f70 6174 685f 6363 2c0a 2020  ocal_path_cc,.  
+00014530: 2020 2020 2020 2020 2020 290a 0a20 2020            )..   
+00014540: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+00014550: 5472 7565 0a20 2020 2020 2020 2065 6c73  True.        els
+00014560: 653a 0a20 2020 2020 2020 2020 2020 2072  e:.            r
+00014570: 6574 7572 6e20 4661 6c73 650a 0a20 2020  eturn False..   
+00014580: 2064 6566 205f 6861 6e64 6c65 5f73 656c   def _handle_sel
+00014590: 6563 7469 7665 5f73 796e 635f 636f 6e66  ective_sync_conf
+000145a0: 6c69 6374 2873 656c 662c 2065 7665 6e74  lict(self, event
+000145b0: 3a20 5379 6e63 4576 656e 7429 202d 3e20  : SyncEvent) -> 
+000145c0: 626f 6f6c 3a0a 2020 2020 2020 2020 2222  bool:.        ""
+000145d0: 220a 2020 2020 2020 2020 4368 6563 6b73  ".        Checks
+000145e0: 2066 6f72 2069 7465 6d73 2069 6e20 7468   for items in th
+000145f0: 6520 6c6f 6361 6c20 6469 7265 6374 6f72  e local director
+00014600: 7920 7769 7468 2073 616d 6520 7061 7468  y with same path
+00014610: 2061 7320 616e 2069 7465 6d20 7768 6963   as an item whic
+00014620: 6820 6973 0a20 2020 2020 2020 2065 7863  h is.        exc
+00014630: 6c75 6465 6420 6279 2073 656c 6563 7469  luded by selecti
+00014640: 7665 2073 796e 632e 2052 656e 616d 6573  ve sync. Renames
+00014650: 2069 7465 6d73 2069 6620 6e65 6365 7373   items if necess
+00014660: 6172 792e 0a0a 2020 2020 2020 2020 3a70  ary...        :p
+00014670: 6172 616d 2065 7665 6e74 3a20 5379 6e63  aram event: Sync
+00014680: 4576 656e 7420 666f 7220 6c6f 6361 6c20  Event for local 
+00014690: 6372 6561 7465 6420 6f72 206d 6f76 6564  created or moved
+000146a0: 2065 7665 6e74 2e0a 2020 2020 2020 2020   event..        
+000146b0: 3a72 6574 7572 6e73 3a20 5768 6574 6865  :returns: Whethe
+000146c0: 7220 6120 7365 6c65 6374 6976 6520 7379  r a selective sy
+000146d0: 6e63 2063 6f6e 666c 6963 7420 7761 7320  nc conflict was 
+000146e0: 6465 7465 6374 6564 2061 6e64 2068 616e  detected and han
+000146f0: 646c 6564 2e0a 2020 2020 2020 2020 2222  dled..        ""
+00014700: 220a 2020 2020 2020 2020 6966 206e 6f74  ".        if not
+00014710: 2028 6576 656e 742e 6973 5f61 6464 6564   (event.is_added
+00014720: 206f 7220 6576 656e 742e 6973 5f6d 6f76   or event.is_mov
+00014730: 6564 293a 0a20 2020 2020 2020 2020 2020  ed):.           
+00014740: 2072 6574 7572 6e20 4661 6c73 650a 0a20   return False.. 
+00014750: 2020 2020 2020 2069 6620 7365 6c66 2e69         if self.i
+00014760: 735f 6578 636c 7564 6564 5f62 795f 7573  s_excluded_by_us
+00014770: 6572 2865 7665 6e74 2e64 6278 5f70 6174  er(event.dbx_pat
+00014780: 685f 6c6f 7765 7229 3a0a 2020 2020 2020  h_lower):.      
+00014790: 2020 2020 2020 6c6f 6361 6c5f 7061 7468        local_path
+000147a0: 5f63 6320 3d20 6765 6e65 7261 7465 5f63  _cc = generate_c
+000147b0: 635f 6e61 6d65 280a 2020 2020 2020 2020  c_name(.        
+000147c0: 2020 2020 2020 2020 6576 656e 742e 6c6f          event.lo
+000147d0: 6361 6c5f 7061 7468 2c0a 2020 2020 2020  cal_path,.      
+000147e0: 2020 2020 2020 2020 2020 7375 6666 6978            suffix
+000147f0: 3d22 7365 6c65 6374 6976 6520 7379 6e63  ="selective sync
+00014800: 2063 6f6e 666c 6963 7422 2c0a 2020 2020   conflict",.    
+00014810: 2020 2020 2020 2020 290a 0a20 2020 2020          )..     
+00014820: 2020 2020 2020 2065 7665 6e74 5f63 6c73         event_cls
+00014830: 203d 2044 6972 4d6f 7665 6445 7665 6e74   = DirMovedEvent
+00014840: 2069 6620 6973 6469 7228 6576 656e 742e   if isdir(event.
+00014850: 6c6f 6361 6c5f 7061 7468 2920 656c 7365  local_path) else
+00014860: 2046 696c 654d 6f76 6564 4576 656e 740a   FileMovedEvent.
+00014870: 2020 2020 2020 2020 2020 2020 7769 7468              with
+00014880: 2073 656c 662e 6673 5f65 7665 6e74 732e   self.fs_events.
+00014890: 6967 6e6f 7265 2865 7665 6e74 5f63 6c73  ignore(event_cls
+000148a0: 2865 7665 6e74 2e6c 6f63 616c 5f70 6174  (event.local_pat
+000148b0: 682c 206c 6f63 616c 5f70 6174 685f 6363  h, local_path_cc
+000148c0: 2929 3a0a 2020 2020 2020 2020 2020 2020  )):.            
+000148d0: 2020 2020 7769 7468 2063 6f6e 7665 7274      with convert
+000148e0: 5f61 7069 5f65 7272 6f72 7328 293a 0a20  _api_errors():. 
+000148f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014900: 2020 206d 6f76 6528 6576 656e 742e 6c6f     move(event.lo
+00014910: 6361 6c5f 7061 7468 2c20 6c6f 6361 6c5f  cal_path, local_
+00014920: 7061 7468 5f63 632c 2072 6169 7365 5f65  path_cc, raise_e
+00014930: 7272 6f72 3d54 7275 6529 0a0a 2020 2020  rror=True)..    
+00014940: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+00014950: 2e72 6573 6361 6e28 6c6f 6361 6c5f 7061  .rescan(local_pa
+00014960: 7468 5f63 6329 0a0a 2020 2020 2020 2020  th_cc)..        
+00014970: 2020 2020 7365 6c66 2e5f 6c6f 6767 6572      self._logger
+00014980: 2e69 6e66 6f28 0a20 2020 2020 2020 2020  .info(.         
+00014990: 2020 2020 2020 2027 5365 6c65 6374 6976         'Selectiv
+000149a0: 6520 7379 6e63 2063 6f6e 666c 6963 743a  e sync conflict:
+000149b0: 2072 656e 616d 6564 2022 2573 2220 746f   renamed "%s" to
+000149c0: 2022 2573 2227 2c0a 2020 2020 2020 2020   "%s"',.        
+000149d0: 2020 2020 2020 2020 6576 656e 742e 6c6f          event.lo
+000149e0: 6361 6c5f 7061 7468 2c0a 2020 2020 2020  cal_path,.      
+000149f0: 2020 2020 2020 2020 2020 6c6f 6361 6c5f            local_
+00014a00: 7061 7468 5f63 632c 0a20 2020 2020 2020  path_cc,.       
+00014a10: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
+00014a20: 2020 2072 6574 7572 6e20 5472 7565 0a20     return True. 
+00014a30: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+00014a40: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+00014a50: 4661 6c73 650a 0a20 2020 2064 6566 205f  False..    def _
+00014a60: 6372 6561 7465 5f72 656d 6f74 655f 656e  create_remote_en
+00014a70: 7472 7928 7365 6c66 2c20 6576 656e 743a  try(self, event:
+00014a80: 2053 796e 6345 7665 6e74 2920 2d3e 2053   SyncEvent) -> S
+00014a90: 796e 6345 7665 6e74 3a0a 2020 2020 2020  yncEvent:.      
+00014aa0: 2020 2222 220a 2020 2020 2020 2020 4170    """.        Ap
+00014ab0: 706c 6965 7320 6120 6c6f 6361 6c20 6669  plies a local fi
+00014ac0: 6c65 2073 7973 7465 6d20 6576 656e 7420  le system event 
+00014ad0: 746f 2074 6865 2072 656d 6f74 6520 4472  to the remote Dr
+00014ae0: 6f70 626f 7820 616e 6420 636c 6561 7273  opbox and clears
+00014af0: 2061 6e79 2065 7869 7374 696e 670a 2020   any existing.  
+00014b00: 2020 2020 2020 7379 6e63 2065 7272 6f72        sync error
+00014b10: 7320 6265 6c6f 6e67 696e 6720 746f 2074  s belonging to t
+00014b20: 6861 7420 7061 7468 2e20 416e 7920 3a65  hat path. Any :e
+00014b30: 7863 3a60 6d61 6573 7472 616c 2e65 7863  xc:`maestral.exc
+00014b40: 6570 7469 6f6e 2e53 796e 6345 7272 6f72  eption.SyncError
+00014b50: 6020 7769 6c6c 0a20 2020 2020 2020 2062  ` will.        b
+00014b60: 6520 6361 7567 6874 2061 6e64 206c 6f67  e caught and log
+00014b70: 6765 6420 6173 2061 7070 726f 7072 6961  ged as appropria
+00014b80: 7465 2e0a 0a20 2020 2020 2020 2054 6869  te...        Thi
+00014b90: 7320 6d65 7468 6f64 2061 6c77 6179 7320  s method always 
+00014ba0: 7573 6573 2061 206e 6577 2063 6f70 7920  uses a new copy 
+00014bb0: 6f66 2063 6c69 656e 7420 616e 6420 636c  of client and cl
+00014bc0: 6f73 6573 2074 6865 206e 6574 776f 726b  oses the network
+00014bd0: 2073 6573 7369 6f6e 0a20 2020 2020 2020   session.       
+00014be0: 2061 6674 6572 7761 7264 732e 0a0a 2020   afterwards...  
+00014bf0: 2020 2020 2020 3a70 6172 616d 2065 7665        :param eve
+00014c00: 6e74 3a20 5379 6e63 4576 656e 7420 666f  nt: SyncEvent fo
+00014c10: 7220 6c6f 6361 6c20 6669 6c65 2065 7665  r local file eve
+00014c20: 6e74 2e0a 2020 2020 2020 2020 3a72 6574  nt..        :ret
+00014c30: 7572 6e73 3a20 5379 6e63 4576 656e 7420  urns: SyncEvent 
+00014c40: 7769 7468 2075 7064 6174 6564 2073 7461  with updated sta
+00014c50: 7475 732e 0a20 2020 2020 2020 2022 2222  tus..        """
+00014c60: 0a20 2020 2020 2020 2069 6620 7365 6c66  .        if self
+00014c70: 2e5f 6361 6e63 656c 5f72 6571 7565 7374  ._cancel_request
+00014c80: 6564 2e69 735f 7365 7428 293a 0a20 2020  ed.is_set():.   
+00014c90: 2020 2020 2020 2020 2072 6169 7365 2043           raise C
+00014ca0: 616e 6365 6c6c 6564 4572 726f 7228 2253  ancelledError("S
+00014cb0: 796e 6320 6361 6e63 656c 6c65 6422 290a  ync cancelled").
+00014cc0: 0a20 2020 2020 2020 2073 656c 662e 5f73  .        self._s
+00014cd0: 6c6f 775f 646f 776e 2829 0a0a 2020 2020  low_down()..    
+00014ce0: 2020 2020 6576 656e 742e 7374 6174 7573      event.status
+00014cf0: 203d 2053 796e 6353 7461 7475 732e 5379   = SyncStatus.Sy
+00014d00: 6e63 696e 670a 0a20 2020 2020 2020 2074  ncing..        t
+00014d10: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
+00014d20: 6966 2065 7665 6e74 2e69 735f 6669 6c65  if event.is_file
+00014d30: 2061 6e64 2028 6576 656e 742e 6973 5f61   and (event.is_a
+00014d40: 6464 6564 206f 7220 6576 656e 742e 6973  dded or event.is
+00014d50: 5f63 6861 6e67 6564 293a 0a20 2020 2020  _changed):.     
+00014d60: 2020 2020 2020 2020 2020 2073 7461 7475             statu
+00014d70: 7320 3d20 7365 6c66 2e5f 6f6e 5f6c 6f63  s = self._on_loc
+00014d80: 616c 5f66 696c 655f 6d6f 6469 6669 6564  al_file_modified
+00014d90: 2865 7665 6e74 290a 2020 2020 2020 2020  (event).        
+00014da0: 2020 2020 656c 6966 2065 7665 6e74 2e69      elif event.i
+00014db0: 735f 6469 7265 6374 6f72 7920 616e 6420  s_directory and 
+00014dc0: 6576 656e 742e 6973 5f61 6464 6564 3a0a  event.is_added:.
+00014dd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014de0: 7374 6174 7573 203d 2073 656c 662e 5f6f  status = self._o
+00014df0: 6e5f 6c6f 6361 6c5f 666f 6c64 6572 5f63  n_local_folder_c
+00014e00: 7265 6174 6564 2865 7665 6e74 290a 2020  reated(event).  
+00014e10: 2020 2020 2020 2020 2020 656c 6966 2065            elif e
+00014e20: 7665 6e74 2e69 735f 6d6f 7665 643a 0a20  vent.is_moved:. 
+00014e30: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00014e40: 7461 7475 7320 3d20 7365 6c66 2e5f 6f6e  tatus = self._on
+00014e50: 5f6c 6f63 616c 5f6d 6f76 6564 2865 7665  _local_moved(eve
+00014e60: 6e74 290a 2020 2020 2020 2020 2020 2020  nt).            
+00014e70: 656c 6966 2065 7665 6e74 2e69 735f 6465  elif event.is_de
+00014e80: 6c65 7465 643a 0a20 2020 2020 2020 2020  leted:.         
+00014e90: 2020 2020 2020 2073 7461 7475 7320 3d20         status = 
+00014ea0: 7365 6c66 2e5f 6f6e 5f6c 6f63 616c 5f64  self._on_local_d
+00014eb0: 656c 6574 6564 2865 7665 6e74 290a 2020  eleted(event).  
+00014ec0: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
+00014ed0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014ee0: 7374 6174 7573 203d 2053 796e 6353 7461  status = SyncSta
+00014ef0: 7475 732e 536b 6970 7065 640a 0a20 2020  tus.Skipped..   
+00014f00: 2020 2020 2020 2020 2065 7665 6e74 2e73           event.s
+00014f10: 7461 7475 7320 3d20 7374 6174 7573 0a0a  tatus = status..
+00014f20: 2020 2020 2020 2020 6578 6365 7074 2053          except S
+00014f30: 796e 6345 7272 6f72 2061 7320 6572 723a  yncError as err:
+00014f40: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+00014f50: 662e 5f68 616e 646c 655f 7379 6e63 5f65  f._handle_sync_e
+00014f60: 7272 6f72 2865 7272 2c20 6469 7265 6374  rror(err, direct
+00014f70: 696f 6e3d 5379 6e63 4469 7265 6374 696f  ion=SyncDirectio
+00014f80: 6e2e 5570 290a 2020 2020 2020 2020 2020  n.Up).          
+00014f90: 2020 6576 656e 742e 7374 6174 7573 203d    event.status =
+00014fa0: 2053 796e 6353 7461 7475 732e 4661 696c   SyncStatus.Fail
+00014fb0: 6564 0a20 2020 2020 2020 2065 6c73 653a  ed.        else:
+00014fc0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+00014fd0: 662e 636c 6561 725f 7379 6e63 5f65 7272  f.clear_sync_err
+00014fe0: 6f72 735f 6672 6f6d 5f65 7665 6e74 2865  ors_from_event(e
+00014ff0: 7665 6e74 290a 2020 2020 2020 2020 2020  vent).          
+00015000: 2020 7365 6c66 2e61 6374 6976 6974 792e    self.activity.
+00015010: 6469 7363 6172 6428 6576 656e 7429 0a0a  discard(event)..
+00015020: 2020 2020 2020 2020 2320 4164 6420 6576          # Add ev
+00015030: 656e 7473 2074 6f20 6869 7374 6f72 7920  ents to history 
+00015040: 6461 7461 6261 7365 2e0a 2020 2020 2020  database..      
+00015050: 2020 6966 2065 7665 6e74 2e73 7461 7475    if event.statu
+00015060: 7320 3d3d 2053 796e 6353 7461 7475 732e  s == SyncStatus.
+00015070: 446f 6e65 3a0a 2020 2020 2020 2020 2020  Done:.          
+00015080: 2020 7769 7468 2073 656c 662e 5f64 6174    with self._dat
+00015090: 6162 6173 655f 6163 6365 7373 2829 3a0a  abase_access():.
+000150a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000150b0: 7365 6c66 2e5f 6869 7374 6f72 795f 7461  self._history_ta
+000150c0: 626c 652e 7361 7665 2865 7665 6e74 290a  ble.save(event).
+000150d0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+000150e0: 6576 656e 740a 0a20 2020 2040 7374 6174  event..    @stat
+000150f0: 6963 6d65 7468 6f64 0a20 2020 2064 6566  icmethod.    def
+00015100: 205f 7761 6974 5f66 6f72 5f63 7265 6174   _wait_for_creat
+00015110: 696f 6e28 6c6f 6361 6c5f 7061 7468 3a20  ion(local_path: 
+00015120: 7374 7229 202d 3e20 4e6f 6e65 3a0a 2020  str) -> None:.  
+00015130: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
+00015140: 2020 5761 6974 2066 6f72 2061 2066 696c    Wait for a fil
+00015150: 6520 6174 2061 2070 6174 6820 746f 2062  e at a path to b
+00015160: 6520 6372 6561 7465 6420 6f72 206d 6f64  e created or mod
+00015170: 6966 6965 642e 0a0a 2020 2020 2020 2020  ified...        
+00015180: 3a70 6172 616d 206c 6f63 616c 5f70 6174  :param local_pat
+00015190: 683a 2041 6273 6f6c 7574 6520 7061 7468  h: Absolute path
+000151a0: 2074 6f20 6669 6c65 206f 6e20 6472 6976   to file on driv
+000151b0: 652e 0a20 2020 2020 2020 2022 2222 0a20  e..        """. 
+000151c0: 2020 2020 2020 2074 7279 3a0a 2020 2020         try:.    
+000151d0: 2020 2020 2020 2020 7768 696c 6520 5472          while Tr
+000151e0: 7565 3a0a 2020 2020 2020 2020 2020 2020  ue:.            
+000151f0: 2020 2020 7369 7a65 3120 3d20 6765 7473      size1 = gets
+00015200: 697a 6528 6c6f 6361 6c5f 7061 7468 290a  ize(local_path).
+00015210: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015220: 7469 6d65 2e73 6c65 6570 2830 2e32 290a  time.sleep(0.2).
+00015230: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015240: 7369 7a65 3220 3d20 6765 7473 697a 6528  size2 = getsize(
+00015250: 6c6f 6361 6c5f 7061 7468 290a 2020 2020  local_path).    
+00015260: 2020 2020 2020 2020 2020 2020 6966 2073              if s
+00015270: 697a 6531 203d 3d20 7369 7a65 323a 0a20  ize1 == size2:. 
+00015280: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015290: 2020 2072 6574 7572 6e0a 2020 2020 2020     return.      
+000152a0: 2020 6578 6365 7074 204f 5345 7272 6f72    except OSError
+000152b0: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
+000152c0: 7475 726e 0a0a 2020 2020 6465 6620 5f6f  turn..    def _o
+000152d0: 6e5f 6c6f 6361 6c5f 6d6f 7665 6428 7365  n_local_moved(se
+000152e0: 6c66 2c20 6576 656e 743a 2053 796e 6345  lf, event: SyncE
+000152f0: 7665 6e74 2920 2d3e 2053 796e 6353 7461  vent) -> SyncSta
+00015300: 7475 733a 0a20 2020 2020 2020 2022 2222  tus:.        """
+00015310: 0a20 2020 2020 2020 2043 616c 6c20 7768  .        Call wh
+00015320: 656e 2061 206c 6f63 616c 2069 7465 6d20  en a local item 
+00015330: 6973 206d 6f76 6564 2e0a 0a20 2020 2020  is moved...     
+00015340: 2020 204b 6565 7020 696e 206d 696e 6420     Keep in mind 
+00015350: 7468 6174 2077 6520 6d61 7920 6265 206d  that we may be m
+00015360: 6f76 696e 6720 6120 7768 6f6c 6520 7472  oving a whole tr
+00015370: 6565 206f 6620 6974 656d 732e 2042 7574  ee of items. But
+00015380: 2069 7473 2062 6574 7465 7220 6465 616c   its better deal
+00015390: 0a20 2020 2020 2020 2077 6974 6820 7468  .        with th
+000153a0: 6520 636f 6d70 6c65 7869 7479 2074 6861  e complexity tha
+000153b0: 6e20 746f 2064 656c 6574 6520 616e 6420  n to delete and 
+000153c0: 7265 2d75 706c 6f61 6469 6e67 2065 7665  re-uploading eve
+000153d0: 7279 7468 696e 672e 2054 6861 6e6b 6675  rything. Thankfu
+000153e0: 6c6c 792c 2069 6e0a 2020 2020 2020 2020  lly, in.        
+000153f0: 6361 7365 206f 6620 6469 7265 6374 6f72  case of director
+00015400: 6965 732c 2077 6520 616c 7761 7973 2070  ies, we always p
+00015410: 726f 6365 7373 2074 6865 2074 6f70 2d6c  rocess the top-l
+00015420: 6576 656c 2066 6972 7374 2e20 5472 7969  evel first. Tryi
+00015430: 6e67 2074 6f20 6d6f 7665 2074 6865 0a20  ng to move the. 
+00015440: 2020 2020 2020 2063 6869 6c64 7265 6e20         children 
+00015450: 7769 6c6c 2074 6865 6e20 6265 2064 656c  will then be del
+00015460: 6567 6174 6564 2074 6f20 606f 6e5f 6372  egated to `on_cr
+00015470: 6561 7465 6020 2862 6563 6175 7365 2074  eate` (because t
+00015480: 6865 206f 6c64 2069 7465 6d20 6e6f 206c  he old item no l
+00015490: 6f6e 6765 720a 2020 2020 2020 2020 6c69  onger.        li
+000154a0: 7665 7320 6f6e 2044 726f 7062 6f78 2920  ves on Dropbox) 
+000154b0: 616e 6420 7468 6174 2077 6f6e 2774 2075  and that won't u
+000154c0: 706c 6f61 6420 616e 7974 6869 6e67 2062  pload anything b
+000154d0: 6563 6175 7365 2066 696c 6520 636f 6e74  ecause file cont
+000154e0: 656e 7473 2068 6176 650a 2020 2020 2020  ents have.      
+000154f0: 2020 7265 6d61 696e 6564 2074 6865 2073    remained the s
+00015500: 616d 652e 0a0a 2020 2020 2020 2020 3a70  ame...        :p
+00015510: 6172 616d 2065 7665 6e74 3a20 5379 6e63  aram event: Sync
+00015520: 4576 656e 7420 666f 7220 6c6f 6361 6c20  Event for local 
+00015530: 6d6f 7665 6420 6576 656e 742e 0a20 2020  moved event..   
+00015540: 2020 2020 203a 7265 7475 726e 733a 204d       :returns: M
+00015550: 6574 6164 6174 6120 666f 7220 6372 6561  etadata for crea
+00015560: 7465 6420 7265 6d6f 7465 2069 7465 6d20  ted remote item 
+00015570: 6174 2064 6573 7469 6e61 7469 6f6e 2e0a  at destination..
+00015580: 2020 2020 2020 2020 3a72 6169 7365 7320          :raises 
+00015590: 4d61 6573 7472 616c 4170 6945 7272 6f72  MaestralApiError
+000155a0: 3a20 466f 7220 616e 7920 6973 7375 6573  : For any issues
+000155b0: 2077 6865 6e20 7379 6e63 696e 6720 7468   when syncing th
+000155c0: 6520 6974 656d 2e0a 2020 2020 2020 2020  e item..        
+000155d0: 2222 220a 2020 2020 2020 2020 6368 6563  """.        chec
+000155e0: 6b5f 6368 616e 6765 5f74 7970 6528 6576  k_change_type(ev
+000155f0: 656e 742c 207b 4368 616e 6765 5479 7065  ent, {ChangeType
+00015600: 2e4d 6f76 6564 7d29 0a20 2020 2020 2020  .Moved}).       
+00015610: 2063 6865 636b 5f65 6e63 6f64 696e 6728   check_encoding(
+00015620: 6576 656e 742e 6c6f 6361 6c5f 7061 7468  event.local_path
+00015630: 290a 0a20 2020 2020 2020 2069 6620 6576  )..        if ev
+00015640: 656e 742e 6c6f 6361 6c5f 7061 7468 5f66  ent.local_path_f
+00015650: 726f 6d20 3d3d 2073 656c 662e 6472 6f70  rom == self.drop
+00015660: 626f 785f 7061 7468 3a0a 2020 2020 2020  box_path:.      
+00015670: 2020 2020 2020 7365 6c66 2e65 6e73 7572        self.ensur
+00015680: 655f 6472 6f70 626f 785f 666f 6c64 6572  e_dropbox_folder
+00015690: 5f70 7265 7365 6e74 2829 0a0a 2020 2020  _present()..    
+000156a0: 2020 2020 6966 2073 656c 662e 5f68 616e      if self._han
+000156b0: 646c 655f 7365 6c65 6374 6976 655f 7379  dle_selective_sy
+000156c0: 6e63 5f63 6f6e 666c 6963 7428 6576 656e  nc_conflict(even
+000156d0: 7429 3a0a 2020 2020 2020 2020 2020 2020  t):.            
+000156e0: 7265 7475 726e 2053 796e 6353 7461 7475  return SyncStatu
+000156f0: 732e 536b 6970 7065 640a 2020 2020 2020  s.Skipped.      
+00015700: 2020 6966 2073 656c 662e 5f68 616e 646c    if self._handl
+00015710: 655f 6e6f 726d 616c 697a 6174 696f 6e5f  e_normalization_
+00015720: 636f 6e66 6c69 6374 2865 7665 6e74 293a  conflict(event):
+00015730: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+00015740: 7572 6e20 5379 6e63 5374 6174 7573 2e53  urn SyncStatus.S
+00015750: 6b69 7070 6564 0a0a 2020 2020 2020 2020  kipped..        
+00015760: 6462 785f 7061 7468 5f66 726f 6d20 3d20  dbx_path_from = 
+00015770: 6361 7374 2873 7472 2c20 6576 656e 742e  cast(str, event.
+00015780: 6462 785f 7061 7468 5f66 726f 6d29 0a0a  dbx_path_from)..
+00015790: 2020 2020 2020 2020 2320 4966 2061 2066          # If a f
+000157a0: 696c 6520 6174 2074 6865 2064 6573 7469  ile at the desti
+000157b0: 6e61 7469 6f6e 2073 686f 756c 6420 6265  nation should be
+000157c0: 2072 6570 6c61 6365 642c 2072 656d 6f76   replaced, remov
+000157d0: 6520 6974 2066 6972 7374 2c20 6275 7420  e it first, but 
+000157e0: 6f6e 6c79 2069 660a 2020 2020 2020 2020  only if.        
+000157f0: 2320 6974 7320 7265 7620 6d61 7463 6865  # its rev matche
+00015800: 7320 7468 6520 7265 7620 6f66 2074 6865  s the rev of the
+00015810: 206c 6f63 616c 206f 7665 7277 7269 7474   local overwritt
+00015820: 656e 2066 696c 652e 0a20 2020 2020 2020  en file..       
+00015830: 2023 2054 6865 2044 726f 7062 6f78 2041   # The Dropbox A
+00015840: 5049 2064 6f65 7320 6e6f 7420 616c 6c6f  PI does not allo
+00015850: 7720 6f76 6572 7772 6974 696e 6720 6120  w overwriting a 
+00015860: 6465 7374 696e 6174 696f 6e20 6669 6c65  destination file
+00015870: 2064 7572 696e 6720 6120 6d6f 7665 2e0a   during a move..
+00015880: 2020 2020 2020 2020 6c6f 6361 6c5f 656e          local_en
+00015890: 7472 7920 3d20 7365 6c66 2e67 6574 5f69  try = self.get_i
+000158a0: 6e64 6578 5f65 6e74 7279 2865 7665 6e74  ndex_entry(event
+000158b0: 2e64 6278 5f70 6174 685f 6c6f 7765 7229  .dbx_path_lower)
+000158c0: 0a0a 2020 2020 2020 2020 6966 206c 6f63  ..        if loc
+000158d0: 616c 5f65 6e74 7279 2061 6e64 206c 6f63  al_entry and loc
+000158e0: 616c 5f65 6e74 7279 2e69 735f 6669 6c65  al_entry.is_file
+000158f0: 3a0a 2020 2020 2020 2020 2020 2020 7472  :.            tr
+00015900: 793a 0a20 2020 2020 2020 2020 2020 2020  y:.             
+00015910: 2020 2073 656c 662e 636c 6965 6e74 2e72     self.client.r
+00015920: 656d 6f76 6528 0a20 2020 2020 2020 2020  emove(.         
+00015930: 2020 2020 2020 2020 2020 206c 6f63 616c             local
+00015940: 5f65 6e74 7279 2e64 6278 5f70 6174 685f  _entry.dbx_path_
+00015950: 6c6f 7765 722c 2070 6172 656e 745f 7265  lower, parent_re
+00015960: 763d 6c6f 6361 6c5f 656e 7472 792e 7265  v=local_entry.re
+00015970: 760a 2020 2020 2020 2020 2020 2020 2020  v.              
+00015980: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
+00015990: 6578 6365 7074 2028 4e6f 7446 6f75 6e64  except (NotFound
+000159a0: 4572 726f 722c 2046 696c 6543 6f6e 666c  Error, FileConfl
+000159b0: 6963 7445 7272 6f72 293a 0a20 2020 2020  ictError):.     
+000159c0: 2020 2020 2020 2020 2020 2070 6173 730a             pass.
+000159d0: 2020 2020 2020 2020 2020 2020 656c 7365              else
+000159e0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+000159f0: 2020 7365 6c66 2e5f 6c6f 6767 6572 2e64    self._logger.d
+00015a00: 6562 7567 280a 2020 2020 2020 2020 2020  ebug(.          
+00015a10: 2020 2020 2020 2020 2020 2752 6570 6c61            'Repla
+00015a20: 6369 6e67 2065 7869 7374 696e 6720 6669  cing existing fi
+00015a30: 6c65 2022 2573 2220 6279 206d 6f76 6527  le "%s" by move'
+00015a40: 2c20 6c6f 6361 6c5f 656e 7472 792e 6462  , local_entry.db
+00015a50: 785f 7061 7468 5f6c 6f77 6572 0a20 2020  x_path_lower.   
+00015a60: 2020 2020 2020 2020 2020 2020 2029 0a0a               )..
+00015a70: 2020 2020 2020 2020 2320 5065 7266 6f72          # Perfor
+00015a80: 6d20 7468 6520 6d6f 7665 2e0a 2020 2020  m the move..    
+00015a90: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
+00015aa0: 2020 2020 206d 645f 746f 5f6e 6577 203d       md_to_new =
+00015ab0: 2073 656c 662e 636c 6965 6e74 2e6d 6f76   self.client.mov
+00015ac0: 6528 6462 785f 7061 7468 5f66 726f 6d2c  e(dbx_path_from,
+00015ad0: 2065 7665 6e74 2e64 6278 5f70 6174 682c   event.dbx_path,
+00015ae0: 2061 7574 6f72 656e 616d 653d 5472 7565   autorename=True
+00015af0: 290a 2020 2020 2020 2020 6578 6365 7074  ).        except
+00015b00: 204e 6f74 466f 756e 6445 7272 6f72 3a0a   NotFoundError:.
+00015b10: 2020 2020 2020 2020 2020 2020 2320 4966              # If
+00015b20: 206e 6f74 206f 6e20 4472 6f70 626f 782c   not on Dropbox,
+00015b30: 2065 2e67 2e2c 2062 6563 6175 7365 2069   e.g., because i
+00015b40: 7473 206f 6c64 206e 616d 6520 7761 7320  ts old name was 
+00015b50: 696e 7661 6c69 642c 0a20 2020 2020 2020  invalid,.       
+00015b60: 2020 2020 2023 2063 7265 6174 6520 6974       # create it
+00015b70: 2069 6e73 7465 6164 206f 6620 6d6f 7669   instead of movi
+00015b80: 6e67 2069 742e 0a20 2020 2020 2020 2020  ng it..         
+00015b90: 2020 2073 656c 662e 5f6c 6f67 6765 722e     self._logger.
+00015ba0: 6465 6275 6728 0a20 2020 2020 2020 2020  debug(.         
+00015bb0: 2020 2020 2020 2027 436f 756c 6420 6e6f         'Could no
+00015bc0: 7420 6d6f 7665 2022 2573 2220 2d3e 2022  t move "%s" -> "
+00015bd0: 2573 2220 6f6e 2044 726f 7062 6f78 2c20  %s" on Dropbox, 
+00015be0: 736f 7572 6365 2064 6f65 7320 6e6f 7420  source does not 
+00015bf0: 6578 6973 7473 2e20 270a 2020 2020 2020  exists. '.      
+00015c00: 2020 2020 2020 2020 2020 2743 7265 6174            'Creat
+00015c10: 696e 6720 2225 7322 2069 6e73 7465 6164  ing "%s" instead
+00015c20: 272c 0a20 2020 2020 2020 2020 2020 2020  ',.             
+00015c30: 2020 2065 7665 6e74 2e64 6278 5f70 6174     event.dbx_pat
+00015c40: 685f 6672 6f6d 2c0a 2020 2020 2020 2020  h_from,.        
+00015c50: 2020 2020 2020 2020 6576 656e 742e 6462          event.db
+00015c60: 785f 7061 7468 2c0a 2020 2020 2020 2020  x_path,.        
+00015c70: 2020 2020 2020 2020 6576 656e 742e 6462          event.db
+00015c80: 785f 7061 7468 2c0a 2020 2020 2020 2020  x_path,.        
+00015c90: 2020 2020 290a 0a20 2020 2020 2020 2020      )..         
+00015ca0: 2020 2073 656c 662e 7265 7363 616e 2865     self.rescan(e
+00015cb0: 7665 6e74 2e6c 6f63 616c 5f70 6174 6829  vent.local_path)
+00015cc0: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+00015cd0: 7572 6e20 5379 6e63 5374 6174 7573 2e53  urn SyncStatus.S
+00015ce0: 6b69 7070 6564 0a0a 2020 2020 2020 2020  kipped..        
+00015cf0: 6173 7365 7274 2065 7665 6e74 2e64 6278  assert event.dbx
+00015d00: 5f70 6174 685f 6672 6f6d 5f6c 6f77 6572  _path_from_lower
+00015d10: 2069 7320 6e6f 7420 4e6f 6e65 0a20 2020   is not None.   
+00015d20: 2020 2020 2073 656c 662e 7265 6d6f 7665       self.remove
+00015d30: 5f6e 6f64 655f 6672 6f6d 5f69 6e64 6578  _node_from_index
+00015d40: 2865 7665 6e74 2e64 6278 5f70 6174 685f  (event.dbx_path_
+00015d50: 6672 6f6d 5f6c 6f77 6572 290a 0a20 2020  from_lower)..   
+00015d60: 2020 2020 2069 6620 7365 6c66 2e5f 6861       if self._ha
+00015d70: 6e64 6c65 5f75 706c 6f61 645f 636f 6e66  ndle_upload_conf
+00015d80: 6c69 6374 286d 645f 746f 5f6e 6577 2c20  lict(md_to_new, 
+00015d90: 6576 656e 7429 3a0a 2020 2020 2020 2020  event):.        
+00015da0: 2020 2020 7374 6174 7573 203d 2053 796e      status = Syn
+00015db0: 6353 7461 7475 732e 436f 6e66 6c69 6374  cStatus.Conflict
+00015dc0: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
+00015dd0: 2020 2020 2020 2020 2020 2073 7461 7475             statu
+00015de0: 7320 3d20 5379 6e63 5374 6174 7573 2e44  s = SyncStatus.D
+00015df0: 6f6e 650a 2020 2020 2020 2020 2020 2020  one.            
+00015e00: 7365 6c66 2e5f 6c6f 6767 6572 2e64 6562  self._logger.deb
+00015e10: 7567 280a 2020 2020 2020 2020 2020 2020  ug(.            
+00015e20: 2020 2020 274d 6f76 6564 2022 2573 2220      'Moved "%s" 
+00015e30: 746f 2022 2573 2220 6f6e 2044 726f 7062  to "%s" on Dropb
+00015e40: 6f78 272c 2064 6278 5f70 6174 685f 6672  ox', dbx_path_fr
+00015e50: 6f6d 2c20 6576 656e 742e 6462 785f 7061  om, event.dbx_pa
+00015e60: 7468 0a20 2020 2020 2020 2020 2020 2029  th.            )
+00015e70: 0a20 2020 2020 2020 2073 656c 662e 5f75  .        self._u
+00015e80: 7064 6174 655f 696e 6465 785f 7265 6375  pdate_index_recu
+00015e90: 7273 6976 6528 6d64 5f74 6f5f 6e65 7729  rsive(md_to_new)
+00015ea0: 0a0a 2020 2020 2020 2020 7265 7475 726e  ..        return
+00015eb0: 2073 7461 7475 730a 0a20 2020 2064 6566   status..    def
+00015ec0: 205f 7570 6461 7465 5f69 6e64 6578 5f72   _update_index_r
+00015ed0: 6563 7572 7369 7665 2873 656c 662c 206d  ecursive(self, m
+00015ee0: 643a 204d 6574 6164 6174 6129 202d 3e20  d: Metadata) -> 
+00015ef0: 4e6f 6e65 3a0a 2020 2020 2020 2020 7365  None:.        se
+00015f00: 6c66 2e75 7064 6174 655f 696e 6465 785f  lf.update_index_
+00015f10: 6672 6f6d 5f64 6278 5f6d 6574 6164 6174  from_dbx_metadat
+00015f20: 6128 6d64 290a 0a20 2020 2020 2020 2069  a(md)..        i
+00015f30: 6620 6973 696e 7374 616e 6365 286d 642c  f isinstance(md,
+00015f40: 2046 6f6c 6465 724d 6574 6164 6174 6129   FolderMetadata)
+00015f50: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
+00015f60: 7375 6c74 203d 2073 656c 662e 636c 6965  sult = self.clie
+00015f70: 6e74 2e6c 6973 745f 666f 6c64 6572 286d  nt.list_folder(m
+00015f80: 642e 7061 7468 5f6c 6f77 6572 2c20 7265  d.path_lower, re
+00015f90: 6375 7273 6976 653d 5472 7565 290a 2020  cursive=True).  
+00015fa0: 2020 2020 2020 2020 2020 666f 7220 6d64            for md
+00015fb0: 2069 6e20 7265 7375 6c74 2e65 6e74 7269   in result.entri
+00015fc0: 6573 3a0a 2020 2020 2020 2020 2020 2020  es:.            
+00015fd0: 2020 2020 7365 6c66 2e75 7064 6174 655f      self.update_
+00015fe0: 696e 6465 785f 6672 6f6d 5f64 6278 5f6d  index_from_dbx_m
+00015ff0: 6574 6164 6174 6128 6d64 290a 0a20 2020  etadata(md)..   
+00016000: 2064 6566 205f 6f6e 5f6c 6f63 616c 5f66   def _on_local_f
+00016010: 696c 655f 6d6f 6469 6669 6564 2873 656c  ile_modified(sel
+00016020: 662c 2065 7665 6e74 3a20 5379 6e63 4576  f, event: SyncEv
+00016030: 656e 7429 202d 3e20 5379 6e63 5374 6174  ent) -> SyncStat
+00016040: 7573 3a0a 2020 2020 2020 2020 2222 220a  us:.        """.
+00016050: 2020 2020 2020 2020 4361 6c6c 2077 6865          Call whe
+00016060: 6e20 6120 6c6f 6361 6c20 6669 6c65 2069  n a local file i
+00016070: 7320 6372 6561 7465 6420 6f72 206d 6f64  s created or mod
+00016080: 6966 6965 642e 0a0a 2020 2020 2020 2020  ified...        
+00016090: 3a70 6172 616d 2065 7665 6e74 3a20 5379  :param event: Sy
+000160a0: 6e63 4576 656e 7420 636f 7272 6573 706f  ncEvent correspo
+000160b0: 6e64 696e 6720 746f 206c 6f63 616c 2063  nding to local c
+000160c0: 7265 6174 6564 2065 7665 6e74 2e0a 2020  reated event..  
+000160d0: 2020 2020 2020 3a72 6574 7572 6e73 3a20        :returns: 
+000160e0: 4d65 7461 6461 7461 2066 6f72 2063 7265  Metadata for cre
+000160f0: 6174 6564 2069 7465 6d20 6f72 204e 6f6e  ated item or Non
+00016100: 6520 6966 206e 6f20 7265 6d6f 7465 2069  e if no remote i
+00016110: 7465 6d20 6973 2063 7265 6174 6564 2e0a  tem is created..
+00016120: 2020 2020 2020 2020 3a72 6169 7365 7320          :raises 
+00016130: 4d61 6573 7472 616c 4170 6945 7272 6f72  MaestralApiError
+00016140: 3a20 466f 7220 616e 7920 6973 7375 6573  : For any issues
+00016150: 2077 6865 6e20 7379 6e63 696e 6720 7468   when syncing th
+00016160: 6520 6974 656d 2e0a 2020 2020 2020 2020  e item..        
+00016170: 3a72 6169 7365 7320 5661 6c75 6545 7272  :raises ValueErr
+00016180: 6f72 3a20 4966 2074 6865 2043 6861 6e67  or: If the Chang
+00016190: 6554 7970 6520 6973 206e 6f74 2041 6464  eType is not Add
+000161a0: 6564 206f 7220 4d6f 6469 6669 6564 2e0a  ed or Modified..
+000161b0: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
+000161c0: 2020 2020 6368 6563 6b5f 6368 616e 6765      check_change
+000161d0: 5f74 7970 6528 6576 656e 742c 207b 4368  _type(event, {Ch
+000161e0: 616e 6765 5479 7065 2e41 6464 6564 2c20  angeType.Added, 
+000161f0: 4368 616e 6765 5479 7065 2e4d 6f64 6966  ChangeType.Modif
+00016200: 6965 647d 290a 2020 2020 2020 2020 6368  ied}).        ch
+00016210: 6563 6b5f 656e 636f 6469 6e67 2865 7665  eck_encoding(eve
+00016220: 6e74 2e6c 6f63 616c 5f70 6174 6829 0a0a  nt.local_path)..
+00016230: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
+00016240: 5f68 616e 646c 655f 7365 6c65 6374 6976  _handle_selectiv
+00016250: 655f 7379 6e63 5f63 6f6e 666c 6963 7428  e_sync_conflict(
+00016260: 6576 656e 7429 3a0a 2020 2020 2020 2020  event):.        
+00016270: 2020 2020 7265 7475 726e 2053 796e 6353      return SyncS
+00016280: 7461 7475 732e 436f 6e66 6c69 6374 0a20  tatus.Conflict. 
+00016290: 2020 2020 2020 2069 6620 7365 6c66 2e5f         if self._
+000162a0: 6861 6e64 6c65 5f6e 6f72 6d61 6c69 7a61  handle_normaliza
+000162b0: 7469 6f6e 5f63 6f6e 666c 6963 7428 6576  tion_conflict(ev
+000162c0: 656e 7429 3a0a 2020 2020 2020 2020 2020  ent):.          
+000162d0: 2020 7265 7475 726e 2053 796e 6353 7461    return SyncSta
+000162e0: 7475 732e 436f 6e66 6c69 6374 0a0a 2020  tus.Conflict..  
+000162f0: 2020 2020 2020 7365 6c66 2e5f 7761 6974        self._wait
+00016300: 5f66 6f72 5f63 7265 6174 696f 6e28 6576  _for_creation(ev
+00016310: 656e 742e 6c6f 6361 6c5f 7061 7468 290a  ent.local_path).
+00016320: 0a20 2020 2020 2020 2023 2043 6865 636b  .        # Check
+00016330: 2069 6620 6974 656d 2061 6c72 6561 6479   if item already
+00016340: 2065 7869 7374 7320 7769 7468 2069 6465   exists with ide
+00016350: 6e74 6963 616c 2063 6f6e 7465 6e74 2e0a  ntical content..
+00016360: 2020 2020 2020 2020 6966 206e 6f74 2073          if not s
+00016370: 656c 662e 5f63 6865 636b 5f72 6571 7569  elf._check_requi
+00016380: 7265 735f 7570 6c6f 6164 2865 7665 6e74  res_upload(event
+00016390: 293a 0a20 2020 2020 2020 2020 2020 2072  ):.            r
+000163a0: 6574 7572 6e20 5379 6e63 5374 6174 7573  eturn SyncStatus
+000163b0: 2e53 6b69 7070 6564 0a0a 2020 2020 2020  .Skipped..      
+000163c0: 2020 6c6f 6361 6c5f 656e 7472 7920 3d20    local_entry = 
+000163d0: 7365 6c66 2e67 6574 5f69 6e64 6578 5f65  self.get_index_e
+000163e0: 6e74 7279 2865 7665 6e74 2e64 6278 5f70  ntry(event.dbx_p
+000163f0: 6174 685f 6c6f 7765 7229 0a20 2020 2020  ath_lower).     
+00016400: 2020 206c 6f63 616c 5f72 6576 3a20 7374     local_rev: st
+00016410: 7220 7c20 4e6f 6e65 203d 204e 6f6e 650a  r | None = None.
+00016420: 0a20 2020 2020 2020 2069 6620 6e6f 7420  .        if not 
+00016430: 6c6f 6361 6c5f 656e 7472 793a 0a20 2020  local_entry:.   
+00016440: 2020 2020 2020 2020 2023 2046 696c 6520           # File 
+00016450: 6973 206e 6577 2074 6f20 7573 2c20 6c65  is new to us, le
+00016460: 7420 4472 6f70 626f 7820 7265 6e61 6d65  t Dropbox rename
+00016470: 2069 7420 6966 2073 6f6d 6574 6869 6e67   it if something
+00016480: 2069 7320 696e 2074 6865 2077 6179 2e0a   is in the way..
+00016490: 2020 2020 2020 2020 2020 2020 6d6f 6465              mode
+000164a0: 203d 2057 7269 7465 4d6f 6465 2e41 6464   = WriteMode.Add
+000164b0: 0a20 2020 2020 2020 2020 2020 2065 7665  .            eve
+000164c0: 6e74 2e63 6861 6e67 655f 7479 7065 203d  nt.change_type =
+000164d0: 2043 6861 6e67 6554 7970 652e 4164 6465   ChangeType.Adde
+000164e0: 640a 2020 2020 2020 2020 656c 6966 206c  d.        elif l
+000164f0: 6f63 616c 5f65 6e74 7279 2e69 735f 6469  ocal_entry.is_di
+00016500: 7265 6374 6f72 793a 0a20 2020 2020 2020  rectory:.       
+00016510: 2020 2020 2023 2054 7279 2074 6f20 6f76       # Try to ov
+00016520: 6572 7772 6974 6520 7468 6520 6465 7374  erwrite the dest
+00016530: 696e 6174 696f 6e2c 2074 6869 7320 7769  ination, this wi
+00016540: 6c6c 2066 6169 6c2e 2e2e 0a20 2020 2020  ll fail....     
+00016550: 2020 2020 2020 206d 6f64 6520 3d20 5772         mode = Wr
+00016560: 6974 654d 6f64 652e 4f76 6572 7772 6974  iteMode.Overwrit
+00016570: 650a 2020 2020 2020 2020 656c 7365 3a0a  e.        else:.
+00016580: 2020 2020 2020 2020 2020 2020 2320 4669              # Fi
+00016590: 6c65 2068 6173 2062 6565 6e20 6d6f 6469  le has been modi
+000165a0: 6669 6564 2c20 7570 6461 7465 2072 656d  fied, update rem
+000165b0: 6f74 6520 6966 206d 6174 6368 696e 6720  ote if matching 
+000165c0: 7265 762c 0a20 2020 2020 2020 2020 2020  rev,.           
+000165d0: 2023 2063 7265 6174 6520 636f 6e66 6c69   # create confli
+000165e0: 6374 206f 7468 6572 7769 7365 2e0a 2020  ct otherwise..  
+000165f0: 2020 2020 2020 2020 2020 6d6f 6465 203d            mode =
+00016600: 2057 7269 7465 4d6f 6465 2e55 7064 6174   WriteMode.Updat
+00016610: 650a 2020 2020 2020 2020 2020 2020 6576  e.            ev
+00016620: 656e 742e 6368 616e 6765 5f74 7970 6520  ent.change_type 
+00016630: 3d20 4368 616e 6765 5479 7065 2e4d 6f64  = ChangeType.Mod
+00016640: 6966 6965 640a 2020 2020 2020 2020 2020  ified.          
+00016650: 2020 6c6f 6361 6c5f 7265 7620 3d20 6c6f    local_rev = lo
+00016660: 6361 6c5f 656e 7472 792e 7265 760a 0a20  cal_entry.rev.. 
+00016670: 2020 2020 2020 2074 7279 3a0a 2020 2020         try:.    
+00016680: 2020 2020 2020 2020 7769 7468 2073 656c          with sel
+00016690: 662e 5f70 6172 616c 6c65 6c5f 7570 5f73  f._parallel_up_s
+000166a0: 656d 6170 686f 7265 3a0a 2020 2020 2020  emaphore:.      
+000166b0: 2020 2020 2020 2020 2020 6d64 5f6e 6577            md_new
+000166c0: 203d 2073 656c 662e 636c 6965 6e74 2e75   = self.client.u
+000166d0: 706c 6f61 6428 0a20 2020 2020 2020 2020  pload(.         
+000166e0: 2020 2020 2020 2020 2020 2065 7665 6e74             event
+000166f0: 2e6c 6f63 616c 5f70 6174 682c 0a20 2020  .local_path,.   
 00016700: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016710: 2023 206c 6f63 616c 6c79 2061 6e64 2072   # locally and r
-00016720: 6574 7572 6e2e 0a20 2020 2020 2020 2020  eturn..         
-00016730: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-00016740: 5f6c 6f67 6765 722e 6465 6275 6728 0a20  _logger.debug(. 
-00016750: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016760: 2020 2020 2020 2027 2225 7322 206f 6e20         '"%s" on 
-00016770: 4472 6f70 626f 7820 7761 7320 6465 6c65  Dropbox was dele
-00016780: 7465 6420 6166 7465 7220 6372 6561 7469  ted after creati
-00016790: 6f6e 2c20 270a 2020 2020 2020 2020 2020  on, '.          
-000167a0: 2020 2020 2020 2020 2020 2020 2020 2264                "d
-000167b0: 656c 6574 696e 6720 6c6f 6361 6c20 636f  eleting local co
-000167c0: 7079 222c 0a20 2020 2020 2020 2020 2020  py",.           
-000167d0: 2020 2020 2020 2020 2020 2020 2065 7665               eve
-000167e0: 6e74 2e64 6278 5f70 6174 682c 0a20 2020  nt.dbx_path,.   
-000167f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016800: 2029 0a20 2020 2020 2020 2020 2020 2020   ).             
-00016810: 2020 2020 2020 2065 7272 203d 2064 656c         err = del
-00016820: 6574 6528 0a20 2020 2020 2020 2020 2020  ete(.           
-00016830: 2020 2020 2020 2020 2020 2020 2065 7665               eve
-00016840: 6e74 2e6c 6f63 616c 5f70 6174 682c 0a20  nt.local_path,. 
-00016850: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016860: 2020 2020 2020 2066 6f72 6365 5f63 6173         force_cas
-00016870: 655f 7365 6e73 6974 6976 653d 6e6f 7420  e_sensitive=not 
-00016880: 7365 6c66 2e69 735f 6673 5f63 6173 655f  self.is_fs_case_
-00016890: 7365 6e73 6974 6976 652c 0a20 2020 2020  sensitive,.     
-000168a0: 2020 2020 2020 2020 2020 2020 2020 2029                 )
-000168b0: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
-000168c0: 2020 2020 2020 6966 2065 7272 3a0a 2020        if err:.  
-000168d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000168e0: 2020 2020 2020 7261 6973 6520 6f73 5f74        raise os_t
-000168f0: 6f5f 6d61 6573 7472 616c 5f65 7272 6f72  o_maestral_error
-00016900: 2865 7272 290a 0a20 2020 2020 2020 2020  (err)..         
-00016910: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-00016920: 6e20 5379 6e63 5374 6174 7573 2e53 6b69  n SyncStatus.Ski
-00016930: 7070 6564 0a20 2020 2020 2020 2020 2020  pped.           
-00016940: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-00016950: 2020 2020 2020 206d 645f 6e65 7720 3d20         md_new = 
-00016960: 7365 6c66 2e63 6c69 656e 742e 6d61 6b65  self.client.make
-00016970: 5f64 6972 2865 7665 6e74 2e64 6278 5f70  _dir(event.dbx_p
-00016980: 6174 682c 2061 7574 6f72 656e 616d 653d  ath, autorename=
-00016990: 4661 6c73 6529 0a20 2020 2020 2020 2065  False).        e
-000169a0: 7863 6570 7420 466f 6c64 6572 436f 6e66  xcept FolderConf
-000169b0: 6c69 6374 4572 726f 723a 0a20 2020 2020  lictError:.     
-000169c0: 2020 2020 2020 2073 656c 662e 5f6c 6f67         self._log
-000169d0: 6765 722e 6465 6275 6728 0a20 2020 2020  ger.debug(.     
-000169e0: 2020 2020 2020 2020 2020 2027 4e6f 2063             'No c
-000169f0: 6f6e 666c 6963 7420 666f 7220 2225 7322  onflict for "%s"
-00016a00: 3a20 7468 6520 666f 6c64 6572 2061 6c72  : the folder alr
-00016a10: 6561 6479 2065 7869 7374 7327 2c20 6576  eady exists', ev
-00016a20: 656e 742e 6c6f 6361 6c5f 7061 7468 0a20  ent.local_path. 
-00016a30: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
-00016a40: 2020 2020 2020 2020 2074 7279 3a0a 2020           try:.  
-00016a50: 2020 2020 2020 2020 2020 2020 2020 6d64                md
-00016a60: 203d 2073 656c 662e 636c 6965 6e74 2e67   = self.client.g
-00016a70: 6574 5f6d 6574 6164 6174 6128 6576 656e  et_metadata(even
-00016a80: 742e 6462 785f 7061 7468 290a 2020 2020  t.dbx_path).    
-00016a90: 2020 2020 2020 2020 2020 2020 6966 2069              if i
-00016aa0: 7369 6e73 7461 6e63 6528 6d64 2c20 466f  sinstance(md, Fo
-00016ab0: 6c64 6572 4d65 7461 6461 7461 293a 0a20  lderMetadata):. 
-00016ac0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016ad0: 2020 2073 656c 662e 7570 6461 7465 5f69     self.update_i
-00016ae0: 6e64 6578 5f66 726f 6d5f 6462 785f 6d65  ndex_from_dbx_me
-00016af0: 7461 6461 7461 286d 6429 0a20 2020 2020  tadata(md).     
-00016b00: 2020 2020 2020 2065 7863 6570 7420 4e6f         except No
-00016b10: 7446 6f75 6e64 4572 726f 723a 0a20 2020  tFoundError:.   
-00016b20: 2020 2020 2020 2020 2020 2020 2070 6173               pas
-00016b30: 730a 0a20 2020 2020 2020 2020 2020 2072  s..            r
-00016b40: 6574 7572 6e20 5379 6e63 5374 6174 7573  eturn SyncStatus
-00016b50: 2e53 6b69 7070 6564 0a20 2020 2020 2020  .Skipped.       
-00016b60: 2065 7863 6570 7420 4669 6c65 436f 6e66   except FileConf
-00016b70: 6c69 6374 4572 726f 723a 0a20 2020 2020  lictError:.     
-00016b80: 2020 2020 2020 206d 645f 6e65 7720 3d20         md_new = 
-00016b90: 7365 6c66 2e63 6c69 656e 742e 6d61 6b65  self.client.make
-00016ba0: 5f64 6972 2865 7665 6e74 2e64 6278 5f70  _dir(event.dbx_p
-00016bb0: 6174 682c 2061 7574 6f72 656e 616d 653d  ath, autorename=
-00016bc0: 5472 7565 290a 0a20 2020 2020 2020 2069  True)..        i
-00016bd0: 6620 7365 6c66 2e5f 6861 6e64 6c65 5f75  f self._handle_u
-00016be0: 706c 6f61 645f 636f 6e66 6c69 6374 286d  pload_conflict(m
-00016bf0: 645f 6e65 772c 2065 7665 6e74 293a 0a20  d_new, event):. 
-00016c00: 2020 2020 2020 2020 2020 2073 7461 7475             statu
-00016c10: 7320 3d20 5379 6e63 5374 6174 7573 2e43  s = SyncStatus.C
-00016c20: 6f6e 666c 6963 740a 2020 2020 2020 2020  onflict.        
-00016c30: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-00016c40: 2020 7374 6174 7573 203d 2053 796e 6353    status = SyncS
-00016c50: 7461 7475 732e 446f 6e65 0a20 2020 2020  tatus.Done.     
-00016c60: 2020 2020 2020 2073 656c 662e 5f6c 6f67         self._log
-00016c70: 6765 722e 6465 6275 6728 2743 7265 6174  ger.debug('Creat
-00016c80: 6564 2022 2573 2220 6f6e 2044 726f 7062  ed "%s" on Dropb
-00016c90: 6f78 272c 2065 7665 6e74 2e64 6278 5f70  ox', event.dbx_p
-00016ca0: 6174 6829 0a0a 2020 2020 2020 2020 7365  ath)..        se
-00016cb0: 6c66 2e75 7064 6174 655f 696e 6465 785f  lf.update_index_
-00016cc0: 6672 6f6d 5f64 6278 5f6d 6574 6164 6174  from_dbx_metadat
-00016cd0: 6128 6d64 5f6e 6577 290a 0a20 2020 2020  a(md_new)..     
-00016ce0: 2020 2072 6574 7572 6e20 7374 6174 7573     return status
-00016cf0: 0a0a 2020 2020 6465 6620 5f6f 6e5f 6c6f  ..    def _on_lo
-00016d00: 6361 6c5f 6465 6c65 7465 6428 7365 6c66  cal_deleted(self
-00016d10: 2c20 6576 656e 743a 2053 796e 6345 7665  , event: SyncEve
-00016d20: 6e74 2920 2d3e 2053 796e 6353 7461 7475  nt) -> SyncStatu
-00016d30: 733a 0a20 2020 2020 2020 2022 2222 0a20  s:.        """. 
-00016d40: 2020 2020 2020 2043 616c 6c20 7768 656e         Call when
-00016d50: 2061 206c 6f63 616c 2069 7465 6d20 6973   a local item is
-00016d60: 2064 656c 6574 6564 2e20 5765 2074 7279   deleted. We try
-00016d70: 206e 6f74 2074 6f20 6465 6c65 7465 2072   not to delete r
-00016d80: 656d 6f74 6520 6974 656d 7320 7768 6963  emote items whic
-00016d90: 6820 6861 7665 0a20 2020 2020 2020 2062  h have.        b
-00016da0: 6565 6e20 6d6f 6469 6669 6564 2073 696e  een modified sin
-00016db0: 6365 2074 6865 206c 6173 7420 7379 6e63  ce the last sync
-00016dc0: 2e0a 0a20 2020 2020 2020 203a 7061 7261  ...        :para
-00016dd0: 6d20 6576 656e 743a 2053 796e 6345 7665  m event: SyncEve
-00016de0: 6e74 2066 6f72 206c 6f63 616c 2064 656c  nt for local del
-00016df0: 6574 696f 6e2e 0a20 2020 2020 2020 203a  etion..        :
-00016e00: 7265 7475 726e 733a 204d 6574 6164 6174  returns: Metadat
-00016e10: 6120 666f 7220 6465 6c65 7465 6420 6974  a for deleted it
-00016e20: 656d 206f 7220 4e6f 6e65 2069 6620 6e6f  em or None if no
-00016e30: 2072 656d 6f74 6520 6974 656d 2069 7320   remote item is 
-00016e40: 6465 6c65 7465 642e 0a20 2020 2020 2020  deleted..       
-00016e50: 203a 7261 6973 6573 204d 6165 7374 7261   :raises Maestra
-00016e60: 6c41 7069 4572 726f 723a 2046 6f72 2061  lApiError: For a
-00016e70: 6e79 2069 7373 7565 7320 7768 656e 2073  ny issues when s
-00016e80: 796e 6369 6e67 2074 6865 2069 7465 6d2e  yncing the item.
-00016e90: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
-00016ea0: 2020 2020 2063 6865 636b 5f63 6861 6e67       check_chang
-00016eb0: 655f 7479 7065 2865 7665 6e74 2c20 7b43  e_type(event, {C
-00016ec0: 6861 6e67 6554 7970 652e 5265 6d6f 7665  hangeType.Remove
-00016ed0: 647d 290a 2020 2020 2020 2020 7472 793a  d}).        try:
-00016ee0: 0a20 2020 2020 2020 2020 2020 2063 6865  .            che
-00016ef0: 636b 5f65 6e63 6f64 696e 6728 6576 656e  ck_encoding(even
-00016f00: 742e 6c6f 6361 6c5f 7061 7468 290a 2020  t.local_path).  
-00016f10: 2020 2020 2020 6578 6365 7074 2050 6174        except Pat
-00016f20: 6845 7272 6f72 3a0a 2020 2020 2020 2020  hError:.        
-00016f30: 2020 2020 2320 446f 6e27 7420 7261 6973      # Don't rais
-00016f40: 6520 616e 2065 7272 6f72 2068 6572 6520  e an error here 
-00016f50: 6265 6361 7573 6520 7468 6520 6669 6c65  because the file
-00016f60: 2063 616e 6e6f 7420 6578 6973 7420 6f6e   cannot exist on
-00016f70: 2074 6865 2073 6572 7665 722e 0a20 2020   the server..   
-00016f80: 2020 2020 2020 2020 2073 656c 662e 5f6c           self._l
-00016f90: 6f67 6765 722e 6465 6275 6728 0a20 2020  ogger.debug(.   
-00016fa0: 2020 2020 2020 2020 2020 2020 2027 436f               'Co
-00016fb0: 756c 6420 6e6f 7420 6465 6c65 7465 2022  uld not delete "
-00016fc0: 2573 223a 2074 6865 2069 7465 6d20 646f  %s": the item do
-00016fd0: 6573 206e 6f74 2065 7869 7374 206f 6e20  es not exist on 
-00016fe0: 4472 6f70 626f 7827 2c0a 2020 2020 2020  Dropbox',.      
-00016ff0: 2020 2020 2020 2020 2020 6576 656e 742e            event.
-00017000: 6462 785f 7061 7468 2c0a 2020 2020 2020  dbx_path,.      
-00017010: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-00017020: 2020 2020 7265 7475 726e 2053 796e 6353      return SyncS
-00017030: 7461 7475 732e 536b 6970 7065 640a 0a20  tatus.Skipped.. 
-00017040: 2020 2020 2020 2023 2057 6520 696e 7465         # We inte
-00017050: 7263 6570 7420 616e 7920 6174 7465 6d70  rcept any attemp
-00017060: 7473 2074 6f20 6465 6c65 7465 2074 6865  ts to delete the
-00017070: 2068 6f6d 6520 666f 6c64 6572 2068 6572   home folder her
-00017080: 6520 696e 7374 6561 6420 6f66 2077 6169  e instead of wai
-00017090: 7469 6e67 0a20 2020 2020 2020 2023 2066  ting.        # f
-000170a0: 6f72 2061 6e20 6572 726f 7220 6672 6f6d  or an error from
-000170b0: 2074 6865 2044 726f 7062 6f78 2041 5049   the Dropbox API
-000170c0: 2e20 5468 6973 2061 6c6c 6f77 7320 7573  . This allows us
-000170d0: 2074 6f20 7072 6f76 6964 6520 6120 6265   to provide a be
-000170e0: 7474 6572 2065 7272 6f72 0a20 2020 2020  tter error.     
-000170f0: 2020 2023 206d 6573 7361 6765 2e0a 0a20     # message... 
-00017100: 2020 2020 2020 2068 6f6d 655f 7061 7468         home_path
-00017110: 203d 2073 656c 662e 5f73 7461 7465 2e67   = self._state.g
-00017120: 6574 2822 6163 636f 756e 7422 2c20 2268  et("account", "h
-00017130: 6f6d 655f 7061 7468 2229 0a0a 2020 2020  ome_path")..    
-00017140: 2020 2020 6966 2065 7665 6e74 2e64 6278      if event.dbx
-00017150: 5f70 6174 6820 3d3d 2068 6f6d 655f 7061  _path == home_pa
-00017160: 7468 3a0a 2020 2020 2020 2020 2020 2020  th:.            
-00017170: 7261 6973 6520 5379 6e63 4572 726f 7228  raise SyncError(
-00017180: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00017190: 2074 6974 6c65 3d22 436f 756c 6420 6e6f   title="Could no
-000171a0: 7420 6465 6c65 7465 2069 7465 6d22 2c0a  t delete item",.
-000171b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000171c0: 6d65 7373 6167 653d 2243 616e 6e6f 7420  message="Cannot 
-000171d0: 6465 6c65 7465 2074 6865 2075 7365 7227  delete the user'
-000171e0: 7320 686f 6d65 2066 6f6c 6465 7222 2c0a  s home folder",.
-000171f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017200: 6462 785f 7061 7468 3d65 7665 6e74 2e64  dbx_path=event.d
-00017210: 6278 5f70 6174 682c 0a20 2020 2020 2020  bx_path,.       
-00017220: 2020 2020 2020 2020 206c 6f63 616c 5f70           local_p
-00017230: 6174 683d 6576 656e 742e 6c6f 6361 6c5f  ath=event.local_
-00017240: 7061 7468 2c0a 2020 2020 2020 2020 2020  path,.          
-00017250: 2020 290a 0a20 2020 2020 2020 2069 6620    )..        if 
-00017260: 6576 656e 742e 6c6f 6361 6c5f 7061 7468  event.local_path
-00017270: 203d 3d20 7365 6c66 2e64 726f 7062 6f78   == self.dropbox
-00017280: 5f70 6174 683a 0a20 2020 2020 2020 2020  _path:.         
-00017290: 2020 2073 656c 662e 656e 7375 7265 5f64     self.ensure_d
-000172a0: 726f 7062 6f78 5f66 6f6c 6465 725f 7072  ropbox_folder_pr
-000172b0: 6573 656e 7428 290a 0a20 2020 2020 2020  esent()..       
-000172c0: 2069 6620 7365 6c66 2e69 735f 6578 636c   if self.is_excl
-000172d0: 7564 6564 5f62 795f 7573 6572 2865 7665  uded_by_user(eve
-000172e0: 6e74 2e64 6278 5f70 6174 685f 6c6f 7765  nt.dbx_path_lowe
-000172f0: 7229 3a0a 2020 2020 2020 2020 2020 2020  r):.            
-00017300: 7365 6c66 2e5f 6c6f 6767 6572 2e64 6562  self._logger.deb
-00017310: 7567 280a 2020 2020 2020 2020 2020 2020  ug(.            
-00017320: 2020 2020 274e 6f74 2064 656c 6574 696e      'Not deletin
-00017330: 6720 2225 7322 3a20 6973 2065 7863 6c75  g "%s": is exclu
-00017340: 6465 6420 6279 2073 656c 6563 7469 7665  ded by selective
-00017350: 2073 796e 6327 2c20 6576 656e 742e 6462   sync', event.db
-00017360: 785f 7061 7468 0a20 2020 2020 2020 2020  x_path.         
-00017370: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
-00017380: 2072 6574 7572 6e20 5379 6e63 5374 6174   return SyncStat
-00017390: 7573 2e53 6b69 7070 6564 0a0a 2020 2020  us.Skipped..    
-000173a0: 2020 2020 6c6f 6361 6c5f 7265 7620 3d20      local_rev = 
-000173b0: 7365 6c66 2e67 6574 5f6c 6f63 616c 5f72  self.get_local_r
-000173c0: 6576 2865 7665 6e74 2e64 6278 5f70 6174  ev(event.dbx_pat
-000173d0: 685f 6c6f 7765 7229 0a0a 2020 2020 2020  h_lower)..      
-000173e0: 2020 6d64 203d 2073 656c 662e 636c 6965    md = self.clie
-000173f0: 6e74 2e67 6574 5f6d 6574 6164 6174 6128  nt.get_metadata(
-00017400: 6576 656e 742e 6462 785f 7061 7468 2c20  event.dbx_path, 
-00017410: 696e 636c 7564 655f 6465 6c65 7465 643d  include_deleted=
-00017420: 5472 7565 290a 0a20 2020 2020 2020 2069  True)..        i
-00017430: 6620 6e6f 7420 6d64 3a0a 2020 2020 2020  f not md:.      
-00017440: 2020 2020 2020 7365 6c66 2e5f 6c6f 6767        self._logg
-00017450: 6572 2e64 6562 7567 280a 2020 2020 2020  er.debug(.      
-00017460: 2020 2020 2020 2020 2020 2743 6f75 6c64            'Could
-00017470: 206e 6f74 2064 656c 6574 6520 2225 7322   not delete "%s"
-00017480: 3a20 7468 6520 6974 656d 2064 6f65 7320  : the item does 
-00017490: 6e6f 7420 6578 6973 7420 6f6e 2044 726f  not exist on Dro
-000174a0: 7062 6f78 272c 0a20 2020 2020 2020 2020  pbox',.         
-000174b0: 2020 2020 2020 2065 7665 6e74 2e64 6278         event.dbx
-000174c0: 5f70 6174 682c 0a20 2020 2020 2020 2020  _path,.         
-000174d0: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
-000174e0: 2072 6574 7572 6e20 5379 6e63 5374 6174   return SyncStat
-000174f0: 7573 2e53 6b69 7070 6564 0a0a 2020 2020  us.Skipped..    
-00017500: 2020 2020 6966 2065 7665 6e74 2e69 735f      if event.is_
-00017510: 6469 7265 6374 6f72 7920 616e 6420 6973  directory and is
-00017520: 696e 7374 616e 6365 286d 642c 2046 696c  instance(md, Fil
-00017530: 654d 6574 6164 6174 6129 3a0a 2020 2020  eMetadata):.    
-00017540: 2020 2020 2020 2020 7365 6c66 2e5f 6c6f          self._lo
-00017550: 6767 6572 2e64 6562 7567 280a 2020 2020  gger.debug(.    
-00017560: 2020 2020 2020 2020 2020 2020 2745 7870              'Exp
-00017570: 6563 7465 6420 666f 6c64 6572 2061 7420  ected folder at 
-00017580: 2225 7322 2062 7574 2066 6f75 6e64 2061  "%s" but found a
-00017590: 2066 696c 6520 696e 7374 6561 642c 2063   file instead, c
-000175a0: 6865 636b 696e 6720 270a 2020 2020 2020  hecking '.      
-000175b0: 2020 2020 2020 2020 2020 2277 6869 6368            "which
-000175c0: 206f 6e65 2069 7320 6e65 7765 7222 2c0a   one is newer",.
-000175d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000175e0: 6d64 2e70 6174 685f 6469 7370 6c61 792c  md.path_display,
-000175f0: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
-00017600: 2020 2020 2020 2020 2020 2023 2044 6f6e             # Don
-00017610: 2774 2064 656c 6574 6520 6120 7265 6d6f  't delete a remo
-00017620: 7465 2066 696c 6520 6966 2069 7420 7761  te file if it wa
-00017630: 7320 6d6f 6469 6669 6564 2073 696e 6365  s modified since
-00017640: 206c 6173 7420 7379 6e63 2e0a 2020 2020   last sync..    
-00017650: 2020 2020 2020 2020 6966 206d 642e 7365          if md.se
-00017660: 7276 6572 5f6d 6f64 6966 6965 642e 7469  rver_modified.ti
-00017670: 6d65 7374 616d 7028 2920 3e3d 2073 656c  mestamp() >= sel
-00017680: 662e 6765 745f 6c61 7374 5f73 796e 6328  f.get_last_sync(
-00017690: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000176a0: 2065 7665 6e74 2e64 6278 5f70 6174 685f   event.dbx_path_
-000176b0: 6c6f 7765 720a 2020 2020 2020 2020 2020  lower.          
-000176c0: 2020 293a 0a20 2020 2020 2020 2020 2020    ):.           
-000176d0: 2020 2020 2073 656c 662e 5f6c 6f67 6765       self._logge
-000176e0: 722e 6465 6275 6728 0a20 2020 2020 2020  r.debug(.       
-000176f0: 2020 2020 2020 2020 2020 2020 2027 536b               'Sk
-00017700: 6970 7069 6e67 2064 656c 6574 696f 6e3a  ipping deletion:
-00017710: 2072 656d 6f74 6520 6974 656d 2022 2573   remote item "%s
-00017720: 2220 6861 7320 6265 656e 206d 6f64 6966  " has been modif
-00017730: 6965 6420 270a 2020 2020 2020 2020 2020  ied '.          
-00017740: 2020 2020 2020 2020 2020 2273 696e 6365            "since
-00017750: 206c 6173 7420 7379 6e63 222c 0a20 2020   last sync",.   
-00017760: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017770: 206d 642e 7061 7468 5f64 6973 706c 6179   md.path_display
-00017780: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00017790: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
-000177a0: 2020 2020 2320 4d61 726b 206c 6f63 616c      # Mark local
-000177b0: 2066 6f6c 6465 7220 6173 2075 6e74 7261   folder as untra
-000177c0: 636b 6564 2e0a 2020 2020 2020 2020 2020  cked..          
-000177d0: 2020 2020 2020 7365 6c66 2e72 656d 6f76        self.remov
-000177e0: 655f 6e6f 6465 5f66 726f 6d5f 696e 6465  e_node_from_inde
-000177f0: 7828 6576 656e 742e 6462 785f 7061 7468  x(event.dbx_path
-00017800: 5f6c 6f77 6572 290a 0a20 2020 2020 2020  _lower)..       
-00017810: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-00017820: 5379 6e63 5374 6174 7573 2e53 6b69 7070  SyncStatus.Skipp
-00017830: 6564 0a0a 2020 2020 2020 2020 6966 2065  ed..        if e
-00017840: 7665 6e74 2e69 735f 6669 6c65 2061 6e64  vent.is_file and
-00017850: 2069 7369 6e73 7461 6e63 6528 6d64 2c20   isinstance(md, 
-00017860: 466f 6c64 6572 4d65 7461 6461 7461 293a  FolderMetadata):
-00017870: 0a20 2020 2020 2020 2020 2020 2023 2044  .            # D
-00017880: 6f6e 2774 2064 656c 6574 6520 6120 7265  on't delete a re
-00017890: 6d6f 7465 2066 6f6c 6465 7220 6966 2077  mote folder if w
-000178a0: 6520 7765 7265 2065 7870 6563 7469 6e67  e were expecting
-000178b0: 2061 2066 696c 652e 0a20 2020 2020 2020   a file..       
-000178c0: 2020 2020 2023 2054 4f44 4f3a 2044 656c       # TODO: Del
-000178d0: 6574 6520 7468 6520 666f 6c64 6572 2069  ete the folder i
-000178e0: 6620 6974 7320 6368 696c 6472 656e 2064  f its children d
-000178f0: 6964 206e 6f74 2063 6861 6e67 6520 7369  id not change si
-00017900: 6e63 6520 6c61 7374 2073 796e 632e 0a20  nce last sync.. 
-00017910: 2020 2020 2020 2020 2020 2023 2020 2049             #   I
-00017920: 7320 7468 6572 6520 6120 7761 7920 6f66  s there a way of
-00017930: 2061 6368 6965 7669 6e67 2074 6869 7320   achieving this 
-00017940: 7769 7468 6f75 7420 6c69 7374 696e 6720  without listing 
-00017950: 7468 6520 666f 6c64 6572 206f 7220 6c69  the folder or li
-00017960: 7374 696e 670a 2020 2020 2020 2020 2020  sting.          
-00017970: 2020 2320 2020 616c 6c20 6368 616e 6765    #   all change
-00017980: 7320 616e 6420 6368 6563 6b69 6e67 2077  s and checking w
-00017990: 6865 6e20 7468 6579 206f 6363 7572 7265  hen they occurre
-000179a0: 643f 0a20 2020 2020 2020 2020 2020 2073  d?.            s
-000179b0: 656c 662e 5f6c 6f67 6765 722e 6465 6275  elf._logger.debu
-000179c0: 6728 0a20 2020 2020 2020 2020 2020 2020  g(.             
-000179d0: 2020 2027 536b 6970 7069 6e67 2064 656c     'Skipping del
-000179e0: 6574 696f 6e3a 2065 7870 6563 7465 6420  etion: expected 
-000179f0: 6669 6c65 2061 7420 2225 7322 2062 7574  file at "%s" but
-00017a00: 2066 6f75 6e64 2061 2027 0a20 2020 2020   found a '.     
-00017a10: 2020 2020 2020 2020 2020 2022 666f 6c64             "fold
-00017a20: 6572 2069 6e73 7465 6164 222c 0a20 2020  er instead",.   
-00017a30: 2020 2020 2020 2020 2020 2020 206d 642e               md.
-00017a40: 7061 7468 5f64 6973 706c 6179 2c0a 2020  path_display,.  
-00017a50: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
-00017a60: 2020 2020 2020 2020 2320 4d61 726b 206c          # Mark l
-00017a70: 6f63 616c 2066 696c 6520 6173 2075 6e74  ocal file as unt
-00017a80: 7261 636b 6564 2e0a 2020 2020 2020 2020  racked..        
-00017a90: 2020 2020 7365 6c66 2e72 656d 6f76 655f      self.remove_
-00017aa0: 6e6f 6465 5f66 726f 6d5f 696e 6465 7828  node_from_index(
-00017ab0: 6576 656e 742e 6462 785f 7061 7468 5f6c  event.dbx_path_l
-00017ac0: 6f77 6572 290a 0a20 2020 2020 2020 2020  ower)..         
-00017ad0: 2020 2072 6574 7572 6e20 5379 6e63 5374     return SyncSt
-00017ae0: 6174 7573 2e53 6b69 7070 6564 0a0a 2020  atus.Skipped..  
-00017af0: 2020 2020 2020 7472 793a 0a20 2020 2020        try:.     
-00017b00: 2020 2020 2020 2023 2057 696c 6c20 6f6e         # Will on
-00017b10: 6c79 2070 6572 666f 726d 2064 656c 6574  ly perform delet
-00017b20: 6520 6966 2044 726f 7062 6f78 2072 656d  e if Dropbox rem
-00017b30: 6f74 6520 7265 7620 6d61 7463 6865 7320  ote rev matches 
-00017b40: 606c 6f63 616c 5f72 6576 602e 0a20 2020  `local_rev`..   
-00017b50: 2020 2020 2020 2020 2073 656c 662e 636c           self.cl
-00017b60: 6965 6e74 2e72 656d 6f76 6528 0a20 2020  ient.remove(.   
-00017b70: 2020 2020 2020 2020 2020 2020 2065 7665               eve
-00017b80: 6e74 2e64 6278 5f70 6174 682c 2070 6172  nt.dbx_path, par
-00017b90: 656e 745f 7265 763d 6c6f 6361 6c5f 7265  ent_rev=local_re
-00017ba0: 7620 6966 2065 7665 6e74 2e69 735f 6669  v if event.is_fi
-00017bb0: 6c65 2065 6c73 6520 4e6f 6e65 0a20 2020  le else None.   
-00017bc0: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
-00017bd0: 2020 2020 2020 2073 7461 7475 7320 3d20         status = 
-00017be0: 5379 6e63 5374 6174 7573 2e44 6f6e 650a  SyncStatus.Done.
-00017bf0: 2020 2020 2020 2020 6578 6365 7074 204e          except N
-00017c00: 6f74 466f 756e 6445 7272 6f72 3a0a 2020  otFoundError:.  
-00017c10: 2020 2020 2020 2020 2020 7365 6c66 2e5f            self._
-00017c20: 6c6f 6767 6572 2e64 6562 7567 280a 2020  logger.debug(.  
-00017c30: 2020 2020 2020 2020 2020 2020 2020 2743                'C
-00017c40: 6f75 6c64 206e 6f74 2064 656c 6574 6520  ould not delete 
-00017c50: 2225 7322 3a20 7468 6520 6974 656d 206e  "%s": the item n
-00017c60: 6f20 6c6f 6e67 6572 2065 7869 7374 7320  o longer exists 
-00017c70: 6f6e 2044 726f 7062 6f78 272c 0a20 2020  on Dropbox',.   
-00017c80: 2020 2020 2020 2020 2020 2020 2065 7665               eve
-00017c90: 6e74 2e64 6278 5f70 6174 682c 0a20 2020  nt.dbx_path,.   
-00017ca0: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
-00017cb0: 2020 2020 2020 2073 7461 7475 7320 3d20         status = 
-00017cc0: 5379 6e63 5374 6174 7573 2e53 6b69 7070  SyncStatus.Skipp
-00017cd0: 6564 0a20 2020 2020 2020 2065 7863 6570  ed.        excep
-00017ce0: 7420 5061 7468 4572 726f 723a 0a20 2020  t PathError:.   
-00017cf0: 2020 2020 2020 2020 2073 656c 662e 5f6c           self._l
-00017d00: 6f67 6765 722e 6465 6275 6728 0a20 2020  ogger.debug(.   
-00017d10: 2020 2020 2020 2020 2020 2020 2027 436f               'Co
-00017d20: 756c 6420 6e6f 7420 6465 6c65 7465 2022  uld not delete "
-00017d30: 2573 223a 2074 6865 2069 7465 6d20 6861  %s": the item ha
-00017d40: 7320 6265 656e 2063 6861 6e67 6564 2073  s been changed s
-00017d50: 696e 6365 206c 6173 7420 7379 6e63 272c  ince last sync',
-00017d60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00017d70: 2065 7665 6e74 2e64 6278 5f70 6174 682c   event.dbx_path,
-00017d80: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
-00017d90: 2020 2020 2020 2020 2020 2073 7461 7475             statu
-00017da0: 7320 3d20 5379 6e63 5374 6174 7573 2e53  s = SyncStatus.S
-00017db0: 6b69 7070 6564 0a0a 2020 2020 2020 2020  kipped..        
-00017dc0: 2320 5265 6d6f 7665 2072 6576 6973 696f  # Remove revisio
-00017dd0: 6e20 6d65 7461 6461 7461 2e0a 2020 2020  n metadata..    
-00017de0: 2020 2020 7365 6c66 2e72 656d 6f76 655f      self.remove_
-00017df0: 6e6f 6465 5f66 726f 6d5f 696e 6465 7828  node_from_index(
-00017e00: 6576 656e 742e 6462 785f 7061 7468 5f6c  event.dbx_path_l
-00017e10: 6f77 6572 290a 0a20 2020 2020 2020 2072  ower)..        r
-00017e20: 6574 7572 6e20 7374 6174 7573 0a0a 2020  eturn status..  
-00017e30: 2020 6465 6620 5f68 616e 646c 655f 7570    def _handle_up
-00017e40: 6c6f 6164 5f63 6f6e 666c 6963 7428 7365  load_conflict(se
-00017e50: 6c66 2c20 6d64 5f6e 6577 3a20 4d65 7461  lf, md_new: Meta
-00017e60: 6461 7461 2c20 6576 656e 743a 2053 796e  data, event: Syn
-00017e70: 6345 7665 6e74 2920 2d3e 2062 6f6f 6c3a  cEvent) -> bool:
-00017e80: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
-00017e90: 2020 2020 2049 6620 6120 636f 6e66 6c69       If a confli
-00017ea0: 6374 696e 6720 636f 7079 2077 6173 2063  cting copy was c
-00017eb0: 7265 6174 6564 2062 7920 4472 6f70 626f  reated by Dropbo
-00017ec0: 7820 6475 7269 6e67 2074 6865 2075 706c  x during the upl
-00017ed0: 6f61 642c 2077 6520 6d69 7272 6f72 2074  oad, we mirror t
-00017ee0: 6865 0a20 2020 2020 2020 2072 656d 6f74  he.        remot
-00017ef0: 6520 6368 616e 6765 7320 6c6f 6361 6c6c  e changes locall
-00017f00: 792e 2054 6869 7320 6d65 7468 6f64 2063  y. This method c
-00017f10: 616e 206f 6e6c 7920 6265 2075 7365 6420  an only be used 
-00017f20: 666f 7220 6164 6465 642c 2063 6861 6e67  for added, chang
-00017f30: 6564 2061 6e64 0a20 2020 2020 2020 206d  ed and.        m
-00017f40: 6f76 6564 2065 7665 6e74 732e 0a0a 2020  oved events...  
-00017f50: 2020 2020 2020 3a70 6172 616d 206d 645f        :param md_
-00017f60: 6e65 773a 204d 6574 6164 6174 6120 6f66  new: Metadata of
-00017f70: 2069 7465 6d20 6166 7465 7220 7570 6c6f   item after uplo
-00017f80: 6164 2e0a 2020 2020 2020 2020 3a70 6172  ad..        :par
-00017f90: 616d 2065 7665 6e74 3a20 4f72 6967 696e  am event: Origin
-00017fa0: 616c 2075 706c 6f61 6420 7379 6e63 2065  al upload sync e
-00017fb0: 7665 6e74 2077 6869 6368 2074 7269 6767  vent which trigg
-00017fc0: 6572 6564 2074 6865 2075 706c 6f61 642e  ered the upload.
-00017fd0: 0a20 2020 2020 2020 203a 7265 7475 726e  .        :return
-00017fe0: 733a 2057 6865 7468 6572 2061 2063 6f6e  s: Whether a con
-00017ff0: 666c 6963 7469 6e67 2063 6f70 7920 7761  flicting copy wa
-00018000: 7320 6372 6561 7465 642e 0a20 2020 2020  s created..     
-00018010: 2020 2022 2222 0a20 2020 2020 2020 2069     """.        i
-00018020: 6620 6576 656e 742e 6973 5f64 656c 6574  f event.is_delet
-00018030: 6564 3a0a 2020 2020 2020 2020 2020 2020  ed:.            
-00018040: 7261 6973 6520 5661 6c75 6545 7272 6f72  raise ValueError
-00018050: 2822 4361 6e6e 6f74 2070 726f 6365 7373  ("Cannot process
-00018060: 2064 656c 6574 6564 2065 7665 6e74 2e22   deleted event."
-00018070: 290a 0a20 2020 2020 2020 2069 6620 7365  )..        if se
-00018080: 6c66 2e69 735f 6673 5f63 6173 655f 7365  lf.is_fs_case_se
-00018090: 6e73 6974 6976 653a 0a20 2020 2020 2020  nsitive:.       
-000180a0: 2020 2020 2023 2043 6f6d 7061 7265 2075       # Compare u
-000180b0: 6e2d 6e6f 726d 616c 697a 6564 2066 696c  n-normalized fil
-000180c0: 6520 6e61 6d65 732e 2054 6869 7320 656e  e names. This en
-000180d0: 7375 7265 7320 7468 6174 2077 6520 6d69  sures that we mi
-000180e0: 7272 6f72 206c 6f63 616c 6c79 2061 6e79  rror locally any
-000180f0: 0a20 2020 2020 2020 2020 2020 2023 2075  .            # u
-00018100: 6e69 636f 6465 206f 7220 6361 7365 206e  nicode or case n
-00018110: 6f72 6d61 6c69 7a61 7469 6f6e 2070 6572  ormalization per
-00018120: 666f 726d 6564 2062 7920 4472 6f70 626f  formed by Dropbo
-00018130: 7820 7365 7276 6572 732e 0a20 2020 2020  x servers..     
-00018140: 2020 2020 2020 2069 6620 6d64 5f6e 6577         if md_new
-00018150: 2e6e 616d 6520 3d3d 206f 7370 2e62 6173  .name == osp.bas
-00018160: 656e 616d 6528 6576 656e 742e 6c6f 6361  ename(event.loca
-00018170: 6c5f 7061 7468 293a 0a20 2020 2020 2020  l_path):.       
-00018180: 2020 2020 2020 2020 2023 204e 6f20 636f           # No co
-00018190: 6e66 6c69 6374 696e 6720 636f 7079 2077  nflicting copy w
-000181a0: 6173 2063 7265 6174 6564 2e0a 2020 2020  as created..    
-000181b0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-000181c0: 726e 2046 616c 7365 0a20 2020 2020 2020  rn False.       
-000181d0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-000181e0: 2020 2023 2043 6f6d 7061 7265 206e 6f72     # Compare nor
-000181f0: 6d61 6c69 7a65 6420 7061 7468 732e 204d  malized paths. M
-00018200: 6972 726f 7269 6e67 2061 6e79 206e 6f72  irroring any nor
-00018210: 6d61 6c69 7a61 7469 6f6e 2063 6861 6e67  malization chang
-00018220: 6573 206c 6f63 616c 6c79 2069 730a 2020  es locally is.  
-00018230: 2020 2020 2020 2020 2020 2320 6e6f 7420            # not 
-00018240: 7265 7175 6972 6564 206f 6e20 6e6f 726d  required on norm
-00018250: 616c 6973 696e 6720 6669 6c65 2073 7973  alising file sys
-00018260: 7465 6d73 2e0a 2020 2020 2020 2020 2020  tems..          
-00018270: 2020 6966 206d 645f 6e65 772e 7061 7468    if md_new.path
-00018280: 5f6c 6f77 6572 203d 3d20 6576 656e 742e  _lower == event.
-00018290: 6462 785f 7061 7468 5f6c 6f77 6572 3a0a  dbx_path_lower:.
-000182a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000182b0: 2320 4e6f 2063 6f6e 666c 6963 7469 6e67  # No conflicting
-000182c0: 2063 6f70 7920 7761 7320 6372 6561 7465   copy was create
-000182d0: 642e 0a20 2020 2020 2020 2020 2020 2020  d..             
-000182e0: 2020 2072 6574 7572 6e20 4661 6c73 650a     return False.
-000182f0: 0a20 2020 2020 2020 2023 2047 6574 206e  .        # Get n
-00018300: 6577 206c 6f63 616c 2070 6174 6820 636f  ew local path co
-00018310: 7272 6573 706f 6e64 696e 6720 746f 2063  rresponding to c
-00018320: 7265 6174 6564 2065 6e74 7279 2e0a 2020  reated entry..  
-00018330: 2020 2020 2020 6c6f 6361 6c5f 7061 7468        local_path
-00018340: 5f63 6320 3d20 7365 6c66 2e74 6f5f 6c6f  _cc = self.to_lo
-00018350: 6361 6c5f 7061 7468 286d 645f 6e65 772e  cal_path(md_new.
-00018360: 7061 7468 5f64 6973 706c 6179 290a 0a20  path_display).. 
-00018370: 2020 2020 2020 2023 204d 6f76 6520 7468         # Move th
-00018380: 6520 6c6f 6361 6c20 6974 656d 2e0a 2020  e local item..  
-00018390: 2020 2020 2020 6576 656e 745f 636c 7320        event_cls 
-000183a0: 3d20 4469 724d 6f76 6564 4576 656e 7420  = DirMovedEvent 
-000183b0: 6966 2069 7364 6972 2865 7665 6e74 2e6c  if isdir(event.l
-000183c0: 6f63 616c 5f70 6174 6829 2065 6c73 6520  ocal_path) else 
-000183d0: 4669 6c65 4d6f 7665 6445 7665 6e74 0a20  FileMovedEvent. 
-000183e0: 2020 2020 2020 2077 6974 6820 7365 6c66         with self
-000183f0: 2e66 735f 6576 656e 7473 2e69 676e 6f72  .fs_events.ignor
-00018400: 6528 6576 656e 745f 636c 7328 6576 656e  e(event_cls(even
-00018410: 742e 6c6f 6361 6c5f 7061 7468 2c20 6c6f  t.local_path, lo
-00018420: 6361 6c5f 7061 7468 5f63 6329 293a 0a20  cal_path_cc)):. 
-00018430: 2020 2020 2020 2020 2020 2077 6974 6820             with 
-00018440: 636f 6e76 6572 745f 6170 695f 6572 726f  convert_api_erro
-00018450: 7273 2829 3a0a 2020 2020 2020 2020 2020  rs():.          
-00018460: 2020 2020 2020 6d6f 7665 2865 7665 6e74        move(event
-00018470: 2e6c 6f63 616c 5f70 6174 682c 206c 6f63  .local_path, loc
-00018480: 616c 5f70 6174 685f 6363 2c20 7261 6973  al_path_cc, rais
-00018490: 655f 6572 726f 723d 5472 7565 290a 0a20  e_error=True).. 
-000184a0: 2020 2020 2020 2023 2044 656c 6574 6520         # Delete 
-000184b0: 656e 7472 7920 6f66 206f 6c64 2070 6174  entry of old pat
-000184c0: 682e 0a20 2020 2020 2020 2073 656c 662e  h..        self.
-000184d0: 7265 6d6f 7665 5f6e 6f64 655f 6672 6f6d  remove_node_from
-000184e0: 5f69 6e64 6578 2865 7665 6e74 2e64 6278  _index(event.dbx
-000184f0: 5f70 6174 685f 6c6f 7765 7229 0a20 2020  _path_lower).   
-00018500: 2020 2020 2073 656c 662e 5f6c 6f67 6765       self._logge
-00018510: 722e 6465 6275 6728 0a20 2020 2020 2020  r.debug(.       
-00018520: 2020 2020 2027 5570 6c6f 6164 2063 6f6e       'Upload con
-00018530: 666c 6963 743a 2072 656e 616d 6564 2022  flict: renamed "
-00018540: 2573 2220 746f 2022 2573 2227 2c0a 2020  %s" to "%s"',.  
-00018550: 2020 2020 2020 2020 2020 6576 656e 742e            event.
-00018560: 6462 785f 7061 7468 2c0a 2020 2020 2020  dbx_path,.      
-00018570: 2020 2020 2020 6d64 5f6e 6577 2e70 6174        md_new.pat
-00018580: 685f 6469 7370 6c61 792c 0a20 2020 2020  h_display,.     
-00018590: 2020 2029 0a0a 2020 2020 2020 2020 7265     )..        re
-000185a0: 7475 726e 2054 7275 650a 0a20 2020 2064  turn True..    d
-000185b0: 6566 205f 6368 6563 6b5f 7265 7175 6972  ef _check_requir
-000185c0: 6573 5f75 706c 6f61 6428 7365 6c66 2c20  es_upload(self, 
-000185d0: 6576 656e 743a 2053 796e 6345 7665 6e74  event: SyncEvent
-000185e0: 2920 2d3e 2062 6f6f 6c3a 0a20 2020 2020  ) -> bool:.     
-000185f0: 2020 2022 2222 0a20 2020 2020 2020 2043     """.        C
-00018600: 6865 636b 7320 6966 2061 206c 6f63 616c  hecks if a local
-00018610: 2066 696c 6520 6e65 6564 7320 746f 2062   file needs to b
-00018620: 6520 7570 6c6f 6164 6564 2e20 5468 6973  e uploaded. This
-00018630: 2069 7320 6465 7465 726d 696e 6564 2062   is determined b
-00018640: 7920 6368 6563 6b69 6e67 2066 6f72 0a20  y checking for. 
-00018650: 2020 2020 2020 2065 7175 616c 2066 696c         equal fil
-00018660: 6520 636f 6e74 656e 7473 2e20 4966 206e  e contents. If n
-00018670: 6f20 7570 6c6f 6164 2069 7320 7265 7175  o upload is requ
-00018680: 6972 6564 2c20 7468 6520 6c6f 6361 6c20  ired, the local 
-00018690: 696e 6465 7820 6973 2075 7064 6174 6564  index is updated
-000186a0: 2077 6974 680a 2020 2020 2020 2020 7468   with.        th
-000186b0: 6520 7265 6d6f 7465 206d 6574 6164 6174  e remote metadat
-000186c0: 612e 204e 6f74 6520 7468 6174 2063 6f6e  a. Note that con
-000186d0: 666c 6963 7420 7265 736f 6c75 7469 6f6e  flict resolution
-000186e0: 2069 6e20 6361 7365 206f 6620 6469 6666   in case of diff
-000186f0: 6572 656e 7420 636f 6e74 656e 740a 2020  erent content.  
-00018700: 2020 2020 2020 7769 6c6c 2062 6520 6861        will be ha
-00018710: 6e64 6c65 6420 6279 2074 6865 2073 6572  ndled by the ser
-00018720: 7665 722e 0a0a 2020 2020 2020 2020 3a70  ver...        :p
-00018730: 6172 616d 2065 7665 6e74 3a20 4c6f 6361  aram event: Loca
-00018740: 6c20 7379 6e63 2065 7665 6e74 206f 6620  l sync event of 
-00018750: 6120 6669 6c65 2063 7265 6174 696f 6e20  a file creation 
-00018760: 6f72 206d 6f64 6966 6963 6174 696f 6e2e  or modification.
-00018770: 0a20 2020 2020 2020 203a 7265 7475 726e  .        :return
-00018780: 3a20 5768 6574 6865 7220 7468 6520 7265  : Whether the re
-00018790: 6d6f 7465 2069 7465 6d20 6861 7320 7468  mote item has th
-000187a0: 6520 7361 6d65 2063 6f6e 7465 6e74 2061  e same content a
-000187b0: 7320 7468 6520 6c6f 6361 6c20 7379 6e63  s the local sync
-000187c0: 2065 7665 6e74 2e0a 2020 2020 2020 2020   event..        
-000187d0: 2222 220a 2020 2020 2020 2020 6966 206e  """.        if n
-000187e0: 6f74 2028 6576 656e 742e 6973 5f66 696c  ot (event.is_fil
-000187f0: 6520 616e 6420 2865 7665 6e74 2e69 735f  e and (event.is_
-00018800: 6368 616e 6765 6420 6f72 2065 7665 6e74  changed or event
-00018810: 2e69 735f 6164 6465 6429 293a 0a20 2020  .is_added)):.   
-00018820: 2020 2020 2020 2020 2072 6169 7365 2056           raise V
-00018830: 616c 7565 4572 726f 7228 2243 616e 206f  alueError("Can o
-00018840: 6e6c 7920 6265 2063 616c 6c65 6420 7769  nly be called wi
-00018850: 7468 2061 6464 6564 206f 7220 6d6f 6469  th added or modi
-00018860: 6669 6564 2066 696c 6573 2229 0a0a 2020  fied files")..  
-00018870: 2020 2020 2020 6d64 5f6f 6c64 203d 2073        md_old = s
-00018880: 656c 662e 636c 6965 6e74 2e67 6574 5f6d  elf.client.get_m
-00018890: 6574 6164 6174 6128 6576 656e 742e 6462  etadata(event.db
-000188a0: 785f 7061 7468 290a 0a20 2020 2020 2020  x_path)..       
-000188b0: 2069 6620 6973 696e 7374 616e 6365 286d   if isinstance(m
-000188c0: 645f 6f6c 642c 2046 696c 654d 6574 6164  d_old, FileMetad
-000188d0: 6174 6129 3a0a 2020 2020 2020 2020 2020  ata):.          
-000188e0: 2020 6966 2028 0a20 2020 2020 2020 2020    if (.         
-000188f0: 2020 2020 2020 2065 7665 6e74 2e63 6f6e         event.con
-00018900: 7465 6e74 5f68 6173 6820 3d3d 206d 645f  tent_hash == md_
-00018910: 6f6c 642e 636f 6e74 656e 745f 6861 7368  old.content_hash
-00018920: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00018930: 2061 6e64 2065 7665 6e74 2e73 796d 6c69   and event.symli
-00018940: 6e6b 5f74 6172 6765 7420 3d3d 206d 645f  nk_target == md_
-00018950: 6f6c 642e 7379 6d6c 696e 6b5f 7461 7267  old.symlink_targ
-00018960: 6574 0a20 2020 2020 2020 2020 2020 2029  et.            )
-00018970: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00018980: 2020 2320 4669 6c65 2063 6f6e 7465 6e74    # File content
-00018990: 7320 6172 6520 6964 656e 7469 6361 6c2c  s are identical,
-000189a0: 2064 6f20 6e6f 7420 7570 6c6f 6164 2e0a   do not upload..
-000189b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000189c0: 6368 616e 6765 5f74 7970 6520 3d20 224d  change_type = "M
-000189d0: 6f64 6966 6963 6174 696f 6e22 2069 6620  odification" if 
-000189e0: 6576 656e 742e 6973 5f63 6861 6e67 6564  event.is_changed
-000189f0: 2065 6c73 6520 2243 7265 6174 696f 6e22   else "Creation"
-00018a00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00018a10: 2073 656c 662e 5f6c 6f67 6765 722e 6465   self._logger.de
-00018a20: 6275 6728 0a20 2020 2020 2020 2020 2020  bug(.           
-00018a30: 2020 2020 2020 2020 2027 2573 206f 6620           '%s of 
-00018a40: 2225 7322 2064 6574 6563 7465 6420 6275  "%s" detected bu
-00018a50: 7420 6669 6c65 2063 6f6e 7465 6e74 2069  t file content i
-00018a60: 7320 7468 6520 7361 6d65 2061 7320 6f6e  s the same as on
-00018a70: 2044 726f 7062 6f78 272c 0a20 2020 2020   Dropbox',.     
-00018a80: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-00018a90: 6861 6e67 655f 7479 7065 2c0a 2020 2020  hange_type,.    
-00018aa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018ab0: 6576 656e 742e 6462 785f 7061 7468 2c0a  event.dbx_path,.
-00018ac0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018ad0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00018ae0: 2020 7365 6c66 2e75 7064 6174 655f 696e    self.update_in
-00018af0: 6465 785f 6672 6f6d 5f64 6278 5f6d 6574  dex_from_dbx_met
-00018b00: 6164 6174 6128 6d64 5f6f 6c64 290a 2020  adata(md_old).  
-00018b10: 2020 2020 2020 2020 2020 2020 2020 7265                re
-00018b20: 7475 726e 2046 616c 7365 0a20 2020 2020  turn False.     
-00018b30: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-00018b40: 2020 2020 2020 2020 2020 2020 2072 6574               ret
-00018b50: 7572 6e20 5472 7565 0a0a 2020 2020 2020  urn True..      
-00018b60: 2020 7265 7475 726e 2054 7275 650a 0a20    return True.. 
-00018b70: 2020 2023 203d 3d3d 3d20 446f 776e 6c6f     # ==== Downlo
-00018b80: 6164 2073 796e 6320 3d3d 3d3d 3d3d 3d3d  ad sync ========
-00018b90: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00018ba0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00018bb0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00018bc0: 3d3d 3d3d 3d3d 3d0a 0a20 2020 2064 6566  =======..    def
-00018bd0: 2067 6574 5f72 656d 6f74 655f 6974 656d   get_remote_item
-00018be0: 2873 656c 662c 2064 6278 5f70 6174 683a  (self, dbx_path:
-00018bf0: 2073 7472 2920 2d3e 2062 6f6f 6c3a 0a20   str) -> bool:. 
-00018c00: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
-00018c10: 2020 2044 6f77 6e6c 6f61 6473 2061 2072     Downloads a r
-00018c20: 656d 6f74 6520 6669 6c65 206f 7220 666f  emote file or fo
-00018c30: 6c64 6572 2061 6e64 2075 7064 6174 6573  lder and updates
-00018c40: 2069 7473 206c 6f63 616c 2072 6576 2e20   its local rev. 
-00018c50: 4966 2074 6865 2072 656d 6f74 6520 6974  If the remote it
-00018c60: 656d 0a20 2020 2020 2020 2064 6f65 7320  em.        does 
-00018c70: 6e6f 7420 6578 6973 742c 2061 6e79 2063  not exist, any c
-00018c80: 6f72 7265 7370 6f6e 6469 6e67 206c 6f63  orresponding loc
-00018c90: 616c 2069 7465 6d73 2077 696c 6c20 6265  al items will be
-00018ca0: 2064 656c 6574 6564 2e20 4966 2060 6064   deleted. If ``d
-00018cb0: 6278 5f70 6174 6860 600a 2020 2020 2020  bx_path``.      
-00018cc0: 2020 7265 6665 7273 2074 6f20 6120 666f    refers to a fo
-00018cd0: 6c64 6572 2c20 7468 6520 646f 776e 6c6f  lder, the downlo
-00018ce0: 6164 2077 696c 6c20 6265 2068 616e 646c  ad will be handl
-00018cf0: 6564 2062 7920 3a6d 6574 683a 605f 6765  ed by :meth:`_ge
-00018d00: 745f 7265 6d6f 7465 5f66 6f6c 6465 7260  t_remote_folder`
-00018d10: 2e0a 2020 2020 2020 2020 4966 2069 7420  ..        If it 
-00018d20: 7265 6665 7273 2074 6f20 6120 7369 6e67  refers to a sing
-00018d30: 6c65 2066 696c 652c 2074 6865 2064 6f77  le file, the dow
-00018d40: 6e6c 6f61 6420 7769 6c6c 2062 6520 7065  nload will be pe
-00018d50: 7266 6f72 6d65 6420 6279 0a20 2020 2020  rformed by.     
-00018d60: 2020 203a 6d65 7468 3a60 5f63 7265 6174     :meth:`_creat
-00018d70: 655f 6c6f 6361 6c5f 656e 7472 7960 2e0a  e_local_entry`..
-00018d80: 0a20 2020 2020 2020 2054 6869 7320 6d65  .        This me
-00018d90: 7468 6f64 2063 616e 2062 6520 7573 6564  thod can be used
-00018da0: 2074 6f20 6665 7463 6820 696e 6469 7669   to fetch indivi
-00018db0: 6475 616c 2069 7465 6d73 206f 7574 7369  dual items outsi
-00018dc0: 6465 2074 6865 2072 6567 756c 6172 2073  de the regular s
-00018dd0: 796e 630a 2020 2020 2020 2020 6379 636c  ync.        cycl
-00018de0: 652c 2066 6f72 2069 6e73 7461 6e63 6520  e, for instance 
-00018df0: 7768 656e 2069 6e63 6c75 6469 6e67 2061  when including a
-00018e00: 2070 7265 7669 6f75 736c 7920 6578 636c   previously excl
-00018e10: 7564 6564 2066 696c 6520 6f72 2066 6f6c  uded file or fol
-00018e20: 6465 722e 0a0a 2020 2020 2020 2020 3a70  der...        :p
-00018e30: 6172 616d 2064 6278 5f70 6174 683a 2050  aram dbx_path: P
-00018e40: 6174 6820 7265 6c61 7469 7665 2074 6f20  ath relative to 
-00018e50: 4472 6f70 626f 7820 666f 6c64 6572 2e0a  Dropbox folder..
-00018e60: 2020 2020 2020 2020 3a72 6574 7572 6e73          :returns
-00018e70: 3a20 5768 6574 6865 7220 646f 776e 6c6f  : Whether downlo
-00018e80: 6164 2077 6173 2073 7563 6365 7373 6675  ad was successfu
-00018e90: 6c2e 0a20 2020 2020 2020 2022 2222 0a20  l..        """. 
-00018ea0: 2020 2020 2020 2073 656c 662e 5f6c 6f67         self._log
-00018eb0: 6765 722e 696e 666f 2866 2253 796e 6369  ger.info(f"Synci
-00018ec0: 6e67 20e2 8693 207b 6462 785f 7061 7468  ng ... {dbx_path
-00018ed0: 7d22 290a 0a20 2020 2020 2020 2077 6974  }")..        wit
-00018ee0: 6820 7365 6c66 2e73 796e 635f 6c6f 636b  h self.sync_lock
-00018ef0: 3a0a 2020 2020 2020 2020 2020 2020 6d64  :.            md
-00018f00: 203d 2073 656c 662e 636c 6965 6e74 2e67   = self.client.g
-00018f10: 6574 5f6d 6574 6164 6174 6128 6462 785f  et_metadata(dbx_
-00018f20: 7061 7468 2c20 696e 636c 7564 655f 6465  path, include_de
-00018f30: 6c65 7465 643d 5472 7565 290a 0a20 2020  leted=True)..   
-00018f40: 2020 2020 2020 2020 2064 6278 5f70 6174           dbx_pat
-00018f50: 685f 6c6f 7765 7220 3d20 6e6f 726d 616c  h_lower = normal
-00018f60: 697a 6528 6462 785f 7061 7468 290a 0a20  ize(dbx_path).. 
-00018f70: 2020 2020 2020 2020 2020 2069 6620 6d64             if md
-00018f80: 2069 7320 4e6f 6e65 3a0a 2020 2020 2020   is None:.      
-00018f90: 2020 2020 2020 2020 2020 2320 4372 6561            # Crea
-00018fa0: 7465 2061 2066 616b 6520 6465 6c65 7465  te a fake delete
-00018fb0: 6420 6576 656e 742e 0a20 2020 2020 2020  d event..       
-00018fc0: 2020 2020 2020 2020 2069 6e64 6578 5f65           index_e
-00018fd0: 6e74 7279 203d 2073 656c 662e 6765 745f  ntry = self.get_
-00018fe0: 696e 6465 785f 656e 7472 7928 6462 785f  index_entry(dbx_
-00018ff0: 7061 7468 5f6c 6f77 6572 290a 2020 2020  path_lower).    
-00019000: 2020 2020 2020 2020 2020 2020 6361 7365              case
-00019010: 645f 7061 7468 203d 2069 6e64 6578 5f65  d_path = index_e
-00019020: 6e74 7279 2e64 6278 5f70 6174 685f 6361  ntry.dbx_path_ca
-00019030: 7365 6420 6966 2069 6e64 6578 5f65 6e74  sed if index_ent
-00019040: 7279 2065 6c73 6520 6462 785f 7061 7468  ry else dbx_path
-00019050: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
-00019060: 2020 6d64 203d 2044 656c 6574 6564 4d65    md = DeletedMe
-00019070: 7461 6461 7461 280a 2020 2020 2020 2020  tadata(.        
-00019080: 2020 2020 2020 2020 2020 2020 6e61 6d65              name
-00019090: 3d6f 7370 2e62 6173 656e 616d 6528 6462  =osp.basename(db
-000190a0: 785f 7061 7468 292c 0a20 2020 2020 2020  x_path),.       
-000190b0: 2020 2020 2020 2020 2020 2020 2070 6174               pat
-000190c0: 685f 6c6f 7765 723d 6462 785f 7061 7468  h_lower=dbx_path
-000190d0: 5f6c 6f77 6572 2c0a 2020 2020 2020 2020  _lower,.        
-000190e0: 2020 2020 2020 2020 2020 2020 7061 7468              path
-000190f0: 5f64 6973 706c 6179 3d63 6173 6564 5f70  _display=cased_p
-00019100: 6174 682c 0a20 2020 2020 2020 2020 2020  ath,.           
-00019110: 2020 2020 2029 0a0a 2020 2020 2020 2020       )..        
-00019120: 2020 2020 6576 656e 7420 3d20 5379 6e63      event = Sync
-00019130: 4576 656e 742e 6672 6f6d 5f6d 6574 6164  Event.from_metad
-00019140: 6174 6128 6d64 2c20 7365 6c66 290a 0a20  ata(md, self).. 
-00019150: 2020 2020 2020 2020 2020 2069 6620 6576             if ev
-00019160: 656e 742e 6973 5f64 6972 6563 746f 7279  ent.is_directory
-00019170: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00019180: 2020 7375 6363 6573 7320 3d20 7365 6c66    success = self
-00019190: 2e5f 6765 745f 7265 6d6f 7465 5f66 6f6c  ._get_remote_fol
-000191a0: 6465 7228 6462 785f 7061 7468 290a 2020  der(dbx_path).  
-000191b0: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
-000191c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000191d0: 7365 6c66 2e61 6374 6976 6974 792e 6164  self.activity.ad
-000191e0: 6428 6576 656e 7429 0a20 2020 2020 2020  d(event).       
-000191f0: 2020 2020 2020 2020 2065 203d 2073 656c           e = sel
-00019200: 662e 5f63 7265 6174 655f 6c6f 6361 6c5f  f._create_local_
-00019210: 656e 7472 7928 6576 656e 7429 0a20 2020  entry(event).   
-00019220: 2020 2020 2020 2020 2020 2020 2073 7563               suc
-00019230: 6365 7373 203d 2065 2e73 7461 7475 7320  cess = e.status 
-00019240: 696e 2028 5379 6e63 5374 6174 7573 2e44  in (SyncStatus.D
-00019250: 6f6e 652c 2053 796e 6353 7461 7475 732e  one, SyncStatus.
-00019260: 536b 6970 7065 6429 0a0a 2020 2020 2020  Skipped)..      
-00019270: 2020 2020 2020 7365 6c66 2e5f 636c 6561        self._clea
-00019280: 725f 6361 6368 6573 2829 0a0a 2020 2020  r_caches()..    
-00019290: 2020 2020 2020 2020 7265 7475 726e 2073          return s
-000192a0: 7563 6365 7373 0a0a 2020 2020 6465 6620  uccess..    def 
-000192b0: 5f67 6574 5f72 656d 6f74 655f 666f 6c64  _get_remote_fold
-000192c0: 6572 2873 656c 662c 2064 6278 5f70 6174  er(self, dbx_pat
-000192d0: 683a 2073 7472 2920 2d3e 2062 6f6f 6c3a  h: str) -> bool:
-000192e0: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
-000192f0: 2020 2020 2047 6574 7320 616c 6c20 6669       Gets all fi
-00019300: 6c65 732f 666f 6c64 6572 7320 6672 6f6d  les/folders from
-00019310: 2061 2044 726f 7062 6f78 2066 6f6c 6465   a Dropbox folde
-00019320: 7220 616e 6420 7772 6974 6573 2074 6865  r and writes the
-00019330: 6d20 746f 2074 6865 206c 6f63 616c 2066  m to the local f
-00019340: 6f6c 6465 720a 2020 2020 2020 2020 3a61  older.        :a
-00019350: 7474 723a 6064 726f 7062 6f78 5f70 6174  ttr:`dropbox_pat
-00019360: 6860 2e0a 0a20 2020 2020 2020 203a 7061  h`...        :pa
-00019370: 7261 6d20 6462 785f 7061 7468 3a20 5061  ram dbx_path: Pa
-00019380: 7468 2072 656c 6174 6976 6520 746f 2044  th relative to D
-00019390: 726f 7062 6f78 2066 6f6c 6465 722e 0a20  ropbox folder.. 
-000193a0: 2020 2020 2020 203a 7265 7475 726e 733a         :returns:
-000193b0: 2057 6865 7468 6572 2064 6f77 6e6c 6f61   Whether downloa
-000193c0: 6420 7761 7320 7375 6363 6573 7366 756c  d was successful
-000193d0: 2e0a 2020 2020 2020 2020 2222 220a 2020  ..        """.  
-000193e0: 2020 2020 2020 7769 7468 2073 656c 662e        with self.
-000193f0: 7379 6e63 5f6c 6f63 6b3a 0a20 2020 2020  sync_lock:.     
-00019400: 2020 2020 2020 2074 7279 3a0a 2020 2020         try:.    
-00019410: 2020 2020 2020 2020 2020 2020 6964 7820              idx 
-00019420: 3d20 300a 0a20 2020 2020 2020 2020 2020  = 0..           
-00019430: 2020 2020 2023 2049 7465 7261 7465 206f       # Iterate o
-00019440: 7665 7220 696e 6465 7820 616e 6420 646f  ver index and do
-00019450: 776e 6c6f 6164 2072 6573 756c 7473 2e0a  wnload results..
-00019460: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019470: 6c69 7374 5f69 7465 7220 3d20 7365 6c66  list_iter = self
-00019480: 2e63 6c69 656e 742e 6c69 7374 5f66 6f6c  .client.list_fol
-00019490: 6465 725f 6974 6572 6174 6f72 2864 6278  der_iterator(dbx
-000194a0: 5f70 6174 682c 2072 6563 7572 7369 7665  _path, recursive
-000194b0: 3d54 7275 6529 0a0a 2020 2020 2020 2020  =True)..        
-000194c0: 2020 2020 2020 2020 666f 7220 7265 7320          for res 
-000194d0: 696e 206c 6973 745f 6974 6572 3a0a 2020  in list_iter:.  
-000194e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000194f0: 2020 6964 7820 2b3d 206c 656e 2872 6573    idx += len(res
-00019500: 2e65 6e74 7269 6573 290a 0a20 2020 2020  .entries)..     
-00019510: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00019520: 6620 6964 7820 3e20 303a 0a20 2020 2020  f idx > 0:.     
-00019530: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019540: 2020 2073 656c 662e 5f6c 6f67 6765 722e     self._logger.
-00019550: 696e 666f 2866 2249 6e64 6578 696e 6720  info(f"Indexing 
-00019560: 7b69 6478 7d2e 2e2e 2229 0a0a 2020 2020  {idx}...")..    
-00019570: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019580: 7265 732e 656e 7472 6965 732e 736f 7274  res.entries.sort
-00019590: 286b 6579 3d6c 616d 6264 6120 783a 2078  (key=lambda x: x
-000195a0: 2e70 6174 685f 6c6f 7765 722e 636f 756e  .path_lower.coun
-000195b0: 7428 222f 2229 290a 0a20 2020 2020 2020  t("/"))..       
-000195c0: 2020 2020 2020 2020 2020 2020 2023 2043               # C
-000195d0: 6f6e 7665 7274 206d 6574 6164 6174 6120  onvert metadata 
-000195e0: 746f 2073 796e 635f 6576 656e 7473 2e0a  to sync_events..
-000195f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019600: 2020 2020 7379 6e63 5f65 7665 6e74 7320      sync_events 
-00019610: 3d20 5b0a 2020 2020 2020 2020 2020 2020  = [.            
-00019620: 2020 2020 2020 2020 2020 2020 5379 6e63              Sync
-00019630: 4576 656e 742e 6672 6f6d 5f6d 6574 6164  Event.from_metad
-00019640: 6174 6128 6d64 2c20 7365 6c66 2920 666f  ata(md, self) fo
-00019650: 7220 6d64 2069 6e20 7265 732e 656e 7472  r md in res.entr
-00019660: 6965 730a 2020 2020 2020 2020 2020 2020  ies.            
-00019670: 2020 2020 2020 2020 5d0a 2020 2020 2020          ].      
-00019680: 2020 2020 2020 2020 2020 2020 2020 646f                do
-00019690: 776e 6c6f 6164 5f72 6573 203d 2073 656c  wnload_res = sel
-000196a0: 662e 6170 706c 795f 7265 6d6f 7465 5f63  f.apply_remote_c
-000196b0: 6861 6e67 6573 2873 796e 635f 6576 656e  hanges(sync_even
-000196c0: 7473 290a 0a20 2020 2020 2020 2020 2020  ts)..           
-000196d0: 2020 2020 2020 2020 2073 7563 6365 7373           success
-000196e0: 203d 2061 6c6c 280a 2020 2020 2020 2020   = all(.        
-000196f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019700: 652e 7374 6174 7573 2069 6e20 2853 796e  e.status in (Syn
-00019710: 6353 7461 7475 732e 446f 6e65 2c20 5379  cStatus.Done, Sy
-00019720: 6e63 5374 6174 7573 2e53 6b69 7070 6564  ncStatus.Skipped
-00019730: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00019740: 2020 2020 2020 2020 2020 666f 7220 6520            for e 
-00019750: 696e 2064 6f77 6e6c 6f61 645f 7265 730a  in download_res.
-00019760: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019770: 2020 2020 290a 0a20 2020 2020 2020 2020      )..         
-00019780: 2020 2020 2020 2020 2020 2069 6620 7365             if se
-00019790: 6c66 2e5f 6361 6e63 656c 5f72 6571 7565  lf._cancel_reque
-000197a0: 7374 6564 2e69 735f 7365 7428 293a 0a20  sted.is_set():. 
-000197b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000197c0: 2020 2020 2020 2072 6169 7365 2043 616e         raise Can
-000197d0: 6365 6c6c 6564 4572 726f 7228 2253 796e  celledError("Syn
-000197e0: 6320 6361 6e63 656c 6c65 6422 290a 0a20  c cancelled").. 
-000197f0: 2020 2020 2020 2020 2020 2065 7863 6570             excep
-00019800: 7420 5379 6e63 4572 726f 7220 6173 2065  t SyncError as e
-00019810: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00019820: 2020 7365 6c66 2e5f 6861 6e64 6c65 5f73    self._handle_s
-00019830: 796e 635f 6572 726f 7228 652c 2064 6972  ync_error(e, dir
-00019840: 6563 7469 6f6e 3d53 796e 6344 6972 6563  ection=SyncDirec
-00019850: 7469 6f6e 2e44 6f77 6e29 0a20 2020 2020  tion.Down).     
-00019860: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-00019870: 6e20 4661 6c73 650a 0a20 2020 2020 2020  n False..       
-00019880: 2020 2020 2072 6574 7572 6e20 7375 6363       return succ
-00019890: 6573 730a 0a20 2020 2064 6566 2077 6169  ess..    def wai
-000198a0: 745f 666f 725f 7265 6d6f 7465 5f63 6861  t_for_remote_cha
-000198b0: 6e67 6573 280a 2020 2020 2020 2020 7365  nges(.        se
-000198c0: 6c66 2c0a 2020 2020 2020 2020 6c61 7374  lf,.        last
-000198d0: 5f63 7572 736f 723a 2073 7472 2c0a 2020  _cursor: str,.  
-000198e0: 2020 2020 2020 7469 6d65 6f75 743a 2069        timeout: i
-000198f0: 6e74 203d 2034 302c 0a20 2020 2029 202d  nt = 40,.    ) -
-00019900: 3e20 626f 6f6c 3a0a 2020 2020 2020 2020  > bool:.        
-00019910: 2222 220a 2020 2020 2020 2020 426c 6f63  """.        Bloc
-00019920: 6b73 2075 6e74 696c 2063 6861 6e67 6573  ks until changes
-00019930: 2074 6f20 7468 6520 7265 6d6f 7465 2044   to the remote D
-00019940: 726f 7062 6f78 2061 7265 2061 7661 696c  ropbox are avail
-00019950: 6162 6c65 2e0a 0a20 2020 2020 2020 203a  able...        :
-00019960: 7061 7261 6d20 6c61 7374 5f63 7572 736f  param last_curso
-00019970: 723a 2043 7572 736f 7220 666f 726d 206c  r: Cursor form l
-00019980: 6173 7420 7379 6e63 2e0a 2020 2020 2020  ast sync..      
-00019990: 2020 3a70 6172 616d 2074 696d 656f 7574    :param timeout
-000199a0: 3a20 5469 6d65 6f75 7420 696e 2073 6563  : Timeout in sec
-000199b0: 6f6e 6473 2062 6566 6f72 6520 7265 7475  onds before retu
-000199c0: 726e 696e 6720 6576 656e 2069 6620 7468  rning even if th
-000199d0: 6572 6520 6172 6520 6e6f 0a20 2020 2020  ere are no.     
-000199e0: 2020 2020 2020 2063 6861 6e67 6573 2e20         changes. 
-000199f0: 4472 6f70 626f 7820 6164 6473 2072 616e  Dropbox adds ran
-00019a00: 646f 6d20 6a69 7474 6572 206f 6620 7570  dom jitter of up
-00019a10: 2074 6f20 3930 2073 6563 2074 6f20 7468   to 90 sec to th
-00019a20: 6973 2076 616c 7565 2e0a 2020 2020 2020  is value..      
-00019a30: 2020 3a72 6574 7572 6e73 3a20 6060 5472    :returns: ``Tr
-00019a40: 7565 6060 2069 6620 6368 616e 6765 7320  ue`` if changes 
-00019a50: 6172 6520 6176 6169 6c61 626c 652c 2060  are available, `
-00019a60: 6046 616c 7365 6060 206f 7468 6572 7769  `False`` otherwi
-00019a70: 7365 2e0a 2020 2020 2020 2020 2222 220a  se..        """.
-00019a80: 2020 2020 2020 2020 7365 6c66 2e5f 6c6f          self._lo
-00019a90: 6767 6572 2e64 6562 7567 2822 5761 6974  gger.debug("Wait
-00019aa0: 696e 6720 666f 7220 7265 6d6f 7465 2063  ing for remote c
-00019ab0: 6861 6e67 6573 2073 696e 6365 2063 7572  hanges since cur
-00019ac0: 736f 723a 5c6e 2573 222c 206c 6173 745f  sor:\n%s", last_
-00019ad0: 6375 7273 6f72 290a 2020 2020 2020 2020  cursor).        
-00019ae0: 6861 735f 6368 616e 6765 7320 3d20 7365  has_changes = se
-00019af0: 6c66 2e63 6c69 656e 742e 7761 6974 5f66  lf.client.wait_f
-00019b00: 6f72 5f72 656d 6f74 655f 6368 616e 6765  or_remote_change
-00019b10: 7328 6c61 7374 5f63 7572 736f 722c 2074  s(last_cursor, t
-00019b20: 696d 656f 7574 3d74 696d 656f 7574 290a  imeout=timeout).
-00019b30: 0a20 2020 2020 2020 2023 2057 6169 7420  .        # Wait 
-00019b40: 666f 7220 3220 7365 632e 2054 6869 7320  for 2 sec. This 
-00019b50: 6465 6c61 7920 6973 2074 7970 6963 616c  delay is typical
-00019b60: 6c79 206f 6e6c 7920 6e65 6365 7373 6172  ly only necessar
-00019b70: 7920 666f 6c64 6572 7320 6172 6520 7368  y folders are sh
-00019b80: 6172 6564 202f 0a20 2020 2020 2020 2023  ared /.        #
-00019b90: 2075 6e2d 7368 6172 6564 2077 6974 6820   un-shared with 
-00019ba0: 6f74 6865 7220 4472 6f70 626f 7820 6163  other Dropbox ac
-00019bb0: 636f 756e 7473 2e0a 2020 2020 2020 2020  counts..        
-00019bc0: 7469 6d65 2e73 6c65 6570 2832 290a 0a20  time.sleep(2).. 
-00019bd0: 2020 2020 2020 2073 656c 662e 5f6c 6f67         self._log
-00019be0: 6765 722e 6465 6275 6728 2244 6574 6563  ger.debug("Detec
-00019bf0: 7465 6420 7265 6d6f 7465 2063 6861 6e67  ted remote chang
-00019c00: 6573 3a20 2573 222c 2068 6173 5f63 6861  es: %s", has_cha
-00019c10: 6e67 6573 290a 2020 2020 2020 2020 7265  nges).        re
-00019c20: 7475 726e 2068 6173 5f63 6861 6e67 6573  turn has_changes
-00019c30: 0a0a 2020 2020 6465 6620 646f 776e 6c6f  ..    def downlo
-00019c40: 6164 5f73 796e 635f 6379 636c 6528 7365  ad_sync_cycle(se
-00019c50: 6c66 2920 2d3e 204e 6f6e 653a 0a20 2020  lf) -> None:.   
-00019c60: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
-00019c70: 2050 6572 666f 726d 7320 6120 6675 6c6c   Performs a full
-00019c80: 2064 6f77 6e6c 6f61 6420 7379 6e63 2063   download sync c
-00019c90: 7963 6c65 2062 7920 6361 6c6c 696e 6720  ycle by calling 
-00019ca0: 696e 206f 7264 6572 3a0a 0a20 2020 2020  in order:..     
-00019cb0: 2020 2020 2020 2031 2920 3a6d 6574 683a         1) :meth:
-00019cc0: 606c 6973 745f 7265 6d6f 7465 5f63 6861  `list_remote_cha
-00019cd0: 6e67 6573 5f69 7465 7261 746f 7260 0a20  nges_iterator`. 
-00019ce0: 2020 2020 2020 2020 2020 2032 2920 3a6d             2) :m
-00019cf0: 6574 683a 6061 7070 6c79 5f72 656d 6f74  eth:`apply_remot
-00019d00: 655f 6368 616e 6765 7360 0a0a 2020 2020  e_changes`..    
-00019d10: 2020 2020 4861 6e64 6c65 7320 7570 6461      Handles upda
-00019d20: 7469 6e67 2074 6865 2072 656d 6f74 6520  ting the remote 
-00019d30: 6375 7273 6f72 2061 6e64 2072 6573 756d  cursor and resum
-00019d40: 696e 6720 696e 7465 7272 7570 7465 6420  ing interrupted 
-00019d50: 7379 6e63 7320 666f 7220 796f 752e 0a20  syncs for you.. 
-00019d60: 2020 2020 2020 2043 616c 6c69 6e67 2074         Calling t
-00019d70: 6869 7320 6d65 7468 6f64 2077 696c 6c20  his method will 
-00019d80: 7065 7266 6f72 6d20 6120 6675 6c6c 2069  perform a full i
-00019d90: 6e64 6578 696e 6720 6966 2074 6869 7320  ndexing if this 
-00019da0: 6973 2074 6865 2066 6972 7374 2064 6f77  is the first dow
-00019db0: 6e6c 6f61 642e 0a20 2020 2020 2020 2022  nload..        "
-00019dc0: 2222 0a20 2020 2020 2020 2077 6974 6820  "".        with 
-00019dd0: 7365 6c66 2e73 796e 635f 6c6f 636b 3a0a  self.sync_lock:.
-00019de0: 2020 2020 2020 2020 2020 2020 6966 2073              if s
-00019df0: 656c 662e 7265 6d6f 7465 5f63 7572 736f  elf.remote_curso
-00019e00: 7220 3d3d 2022 223a 0a20 2020 2020 2020  r == "":.       
-00019e10: 2020 2020 2020 2020 2073 656c 662e 5f73           self._s
-00019e20: 7461 7465 2e73 6574 2822 7379 6e63 222c  tate.set("sync",
-00019e30: 2022 6c61 7374 5f72 6569 6e64 6578 222c   "last_reindex",
-00019e40: 2074 696d 652e 7469 6d65 2829 290a 2020   time.time()).  
-00019e50: 2020 2020 2020 2020 2020 2020 2020 7365                se
-00019e60: 6c66 2e5f 7374 6174 652e 7365 7428 2273  lf._state.set("s
-00019e70: 796e 6322 2c20 2264 6964 5f66 696e 6973  ync", "did_finis
-00019e80: 685f 696e 6465 7869 6e67 222c 2046 616c  h_indexing", Fal
-00019e90: 7365 290a 2020 2020 2020 2020 2020 2020  se).            
-00019ea0: 2020 2020 7365 6c66 2e5f 7374 6174 652e      self._state.
-00019eb0: 7365 7428 2273 796e 6322 2c20 2269 6e64  set("sync", "ind
-00019ec0: 6578 696e 675f 636f 756e 7465 7222 2c20  exing_counter", 
-00019ed0: 3029 0a0a 2020 2020 2020 2020 2020 2020  0)..            
-00019ee0: 6964 7820 3d20 7365 6c66 2e5f 7374 6174  idx = self._stat
-00019ef0: 652e 6765 7428 2273 796e 6322 2c20 2269  e.get("sync", "i
-00019f00: 6e64 6578 696e 675f 636f 756e 7465 7222  ndexing_counter"
-00019f10: 290a 2020 2020 2020 2020 2020 2020 6973  ).            is
-00019f20: 5f69 6e64 6578 696e 6720 3d20 6e6f 7420  _indexing = not 
-00019f30: 7365 6c66 2e5f 7374 6174 652e 6765 7428  self._state.get(
-00019f40: 2273 796e 6322 2c20 2264 6964 5f66 696e  "sync", "did_fin
-00019f50: 6973 685f 696e 6465 7869 6e67 2229 0a0a  ish_indexing")..
-00019f60: 2020 2020 2020 2020 2020 2020 6966 2069              if i
-00019f70: 735f 696e 6465 7869 6e67 2061 6e64 2069  s_indexing and i
-00019f80: 6478 203d 3d20 303a 0a20 2020 2020 2020  dx == 0:.       
-00019f90: 2020 2020 2020 2020 2073 656c 662e 5f6c           self._l
-00019fa0: 6f67 6765 722e 696e 666f 2822 496e 6465  ogger.info("Inde
-00019fb0: 7869 6e67 2072 656d 6f74 6520 4472 6f70  xing remote Drop
-00019fc0: 626f 7822 290a 2020 2020 2020 2020 2020  box").          
-00019fd0: 2020 656c 6966 2069 735f 696e 6465 7869    elif is_indexi
-00019fe0: 6e67 3a0a 2020 2020 2020 2020 2020 2020  ng:.            
-00019ff0: 2020 2020 7365 6c66 2e5f 6c6f 6767 6572      self._logger
-0001a000: 2e69 6e66 6f28 2252 6573 756d 696e 6720  .info("Resuming 
-0001a010: 696e 6465 7869 6e67 2229 0a20 2020 2020  indexing").     
-0001a020: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-0001a030: 2020 2020 2020 2020 2020 2020 2073 656c               sel
-0001a040: 662e 5f6c 6f67 6765 722e 696e 666f 2822  f._logger.info("
-0001a050: 4665 7463 6869 6e67 2072 656d 6f74 6520  Fetching remote 
-0001a060: 6368 616e 6765 7322 290a 0a20 2020 2020  changes")..     
-0001a070: 2020 2020 2020 2063 6861 6e67 6573 5f69         changes_i
-0001a080: 7465 7220 3d20 7365 6c66 2e6c 6973 745f  ter = self.list_
-0001a090: 7265 6d6f 7465 5f63 6861 6e67 6573 5f69  remote_changes_i
-0001a0a0: 7465 7261 746f 7228 7365 6c66 2e72 656d  terator(self.rem
-0001a0b0: 6f74 655f 6375 7273 6f72 290a 0a20 2020  ote_cursor)..   
-0001a0c0: 2020 2020 2020 2020 2023 2044 6f77 6e6c           # Downl
-0001a0d0: 6f61 6420 6368 616e 6765 7320 696e 2063  oad changes in c
-0001a0e0: 6875 6e6b 7320 746f 2072 6564 7563 6520  hunks to reduce 
-0001a0f0: 6d65 6d6f 7279 2075 7361 6765 2e0a 2020  memory usage..  
-0001a100: 2020 2020 2020 2020 2020 666f 7220 6368            for ch
-0001a110: 616e 6765 732c 2063 7572 736f 7220 696e  anges, cursor in
-0001a120: 2063 6861 6e67 6573 5f69 7465 723a 0a20   changes_iter:. 
-0001a130: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-0001a140: 6478 202b 3d20 6c65 6e28 6368 616e 6765  dx += len(change
-0001a150: 7329 0a0a 2020 2020 2020 2020 2020 2020  s)..            
-0001a160: 2020 2020 6966 2069 6478 203e 2030 3a0a      if idx > 0:.
-0001a170: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a180: 2020 2020 7365 6c66 2e5f 6c6f 6767 6572      self._logger
-0001a190: 2e69 6e66 6f28 6622 496e 6465 7869 6e67  .info(f"Indexing
-0001a1a0: 207b 6964 787d 2e2e 2e22 290a 0a20 2020   {idx}...")..   
-0001a1b0: 2020 2020 2020 2020 2020 2020 2064 6f77               dow
-0001a1c0: 6e6c 6f61 6465 6420 3d20 7365 6c66 2e61  nloaded = self.a
-0001a1d0: 7070 6c79 5f72 656d 6f74 655f 6368 616e  pply_remote_chan
-0001a1e0: 6765 7328 6368 616e 6765 7329 0a0a 2020  ges(changes)..  
-0001a1f0: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-0001a200: 5361 7665 2028 696e 6372 656d 656e 7461  Save (incrementa
-0001a210: 6c29 2072 656d 6f74 6520 6375 7273 6f72  l) remote cursor
-0001a220: 2e0a 2020 2020 2020 2020 2020 2020 2020  ..              
-0001a230: 2020 7365 6c66 2e72 656d 6f74 655f 6375    self.remote_cu
-0001a240: 7273 6f72 203d 2063 7572 736f 720a 2020  rsor = cursor.  
-0001a250: 2020 2020 2020 2020 2020 2020 2020 7365                se
-0001a260: 6c66 2e5f 7374 6174 652e 7365 7428 2273  lf._state.set("s
-0001a270: 796e 6322 2c20 2269 6e64 6578 696e 675f  ync", "indexing_
-0001a280: 636f 756e 7465 7222 2c20 6964 7829 0a0a  counter", idx)..
-0001a290: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a2a0: 2320 5365 6e64 2064 6573 6b74 6f70 206e  # Send desktop n
-0001a2b0: 6f74 6966 6963 6174 696f 6e73 2077 6865  otifications whe
-0001a2c0: 6e20 6e6f 7420 696e 6465 7869 6e67 2e0a  n not indexing..
-0001a2d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a2e0: 6966 206e 6f74 2069 735f 696e 6465 7869  if not is_indexi
-0001a2f0: 6e67 3a0a 2020 2020 2020 2020 2020 2020  ng:.            
-0001a300: 2020 2020 2020 2020 7365 6c66 2e6e 6f74          self.not
-0001a310: 6966 795f 7573 6572 2864 6f77 6e6c 6f61  ify_user(downloa
-0001a320: 6465 6429 0a0a 2020 2020 2020 2020 2020  ded)..          
-0001a330: 2020 2020 2020 6966 2073 656c 662e 5f63        if self._c
-0001a340: 616e 6365 6c5f 7265 7175 6573 7465 642e  ancel_requested.
-0001a350: 6973 5f73 6574 2829 3a0a 2020 2020 2020  is_set():.      
-0001a360: 2020 2020 2020 2020 2020 2020 2020 7261                ra
-0001a370: 6973 6520 4361 6e63 656c 6c65 6445 7272  ise CancelledErr
-0001a380: 6f72 2822 5379 6e63 2063 616e 6365 6c6c  or("Sync cancell
-0001a390: 6564 2229 0a0a 2020 2020 2020 2020 2020  ed")..          
-0001a3a0: 2020 2020 2020 2320 4672 6565 206d 656d        # Free mem
-0001a3b0: 6f72 7920 6561 726c 7920 746f 2070 7265  ory early to pre
-0001a3c0: 7665 6e74 2066 7261 676d 656e 7461 7469  vent fragmentati
-0001a3d0: 6f6e 2e0a 2020 2020 2020 2020 2020 2020  on..            
-0001a3e0: 2020 2020 6465 6c20 6368 616e 6765 730a      del changes.
-0001a3f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a400: 6465 6c20 646f 776e 6c6f 6164 6564 0a20  del downloaded. 
-0001a410: 2020 2020 2020 2020 2020 2020 2020 2067                 g
-0001a420: 632e 636f 6c6c 6563 7428 290a 0a20 2020  c.collect()..   
-0001a430: 2020 2020 2020 2020 2073 656c 662e 5f73           self._s
-0001a440: 7461 7465 2e73 6574 2822 7379 6e63 222c  tate.set("sync",
-0001a450: 2022 6469 645f 6669 6e69 7368 5f69 6e64   "did_finish_ind
-0001a460: 6578 696e 6722 2c20 5472 7565 290a 2020  exing", True).  
-0001a470: 2020 2020 2020 2020 2020 7365 6c66 2e5f            self._
-0001a480: 7374 6174 652e 7365 7428 2273 796e 6322  state.set("sync"
-0001a490: 2c20 2269 6e64 6578 696e 675f 636f 756e  , "indexing_coun
-0001a4a0: 7465 7222 2c20 3029 0a0a 2020 2020 2020  ter", 0)..      
-0001a4b0: 2020 2020 2020 6966 2069 6478 203e 2030        if idx > 0
-0001a4c0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0001a4d0: 2020 7365 6c66 2e5f 6c6f 6767 6572 2e69    self._logger.i
-0001a4e0: 6e66 6f28 4944 4c45 290a 0a20 2020 2020  nfo(IDLE)..     
-0001a4f0: 2020 2020 2020 2073 656c 662e 5f63 6c65         self._cle
-0001a500: 6172 5f63 6163 6865 7328 290a 0a20 2020  ar_caches()..   
-0001a510: 2064 6566 206c 6973 745f 7265 6d6f 7465   def list_remote
-0001a520: 5f63 6861 6e67 6573 5f69 7465 7261 746f  _changes_iterato
-0001a530: 7228 0a20 2020 2020 2020 2073 656c 662c  r(.        self,
-0001a540: 206c 6173 745f 6375 7273 6f72 3a20 7374   last_cursor: st
-0001a550: 720a 2020 2020 2920 2d3e 2049 7465 7261  r.    ) -> Itera
-0001a560: 746f 725b 7475 706c 655b 6c69 7374 5b53  tor[tuple[list[S
-0001a570: 796e 6345 7665 6e74 5d2c 2073 7472 5d5d  yncEvent], str]]
-0001a580: 3a0a 2020 2020 2020 2020 2222 220a 2020  :.        """.  
-0001a590: 2020 2020 2020 4765 7420 7265 6d6f 7465        Get remote
-0001a5a0: 2063 6861 6e67 6573 2073 696e 6365 2074   changes since t
-0001a5b0: 6865 206c 6173 7420 646f 776e 6c6f 6164  he last download
-0001a5c0: 2073 796e 632c 2061 7320 7370 6563 6966   sync, as specif
-0001a5d0: 6965 6420 6279 0a20 2020 2020 2020 2060  ied by.        `
-0001a5e0: 606c 6173 745f 6375 7273 6f72 6060 2e20  `last_cursor``. 
-0001a5f0: 4966 2074 6865 2060 606c 6173 745f 6375  If the ``last_cu
-0001a600: 7273 6f72 6060 2069 7320 6672 6f6d 2070  rsor`` is from p
-0001a610: 6167 696e 6174 696e 6720 7468 726f 7567  aginating throug
-0001a620: 6820 6120 7072 6576 696f 7573 0a20 2020  h a previous.   
-0001a630: 2020 2020 2073 6574 206f 6620 6368 616e       set of chan
-0001a640: 6765 732c 2063 6f6e 7469 6e75 6520 7768  ges, continue wh
-0001a650: 6572 6520 7765 206c 6566 7420 6f66 662e  ere we left off.
-0001a660: 2049 6620 6060 6c61 7374 5f63 7572 736f   If ``last_curso
-0001a670: 7260 6020 6973 2061 6e20 656d 7074 790a  r`` is an empty.
-0001a680: 2020 2020 2020 2020 7374 7269 6e67 2c20          string, 
-0001a690: 7065 7266 6f72 6d20 6120 6675 6c6c 2069  perform a full i
-0001a6a0: 6e64 6578 696e 6720 6f66 2074 6865 2044  ndexing of the D
-0001a6b0: 726f 7062 6f78 2066 6f6c 6465 722e 0a0a  ropbox folder...
-0001a6c0: 2020 2020 2020 2020 3a70 6172 616d 206c          :param l
-0001a6d0: 6173 745f 6375 7273 6f72 3a20 4375 7273  ast_cursor: Curs
-0001a6e0: 6f72 2066 726f 6d20 6c61 7374 2064 6f77  or from last dow
-0001a6f0: 6e6c 6f61 6420 7379 6e63 2e0a 2020 2020  nload sync..    
-0001a700: 2020 2020 3a72 6574 7572 6e73 3a20 4974      :returns: It
-0001a710: 6572 6174 6f72 2079 6965 6c64 696e 6720  erator yielding 
-0001a720: 7475 706c 6573 2077 6974 6820 7265 6d6f  tuples with remo
-0001a730: 7465 2063 6861 6e67 6573 2061 6e64 2063  te changes and c
-0001a740: 6f72 7265 7370 6f6e 6469 6e67 2063 7572  orresponding cur
-0001a750: 736f 722e 0a20 2020 2020 2020 2022 2222  sor..        """
-0001a760: 0a20 2020 2020 2020 2069 6620 6c61 7374  .        if last
-0001a770: 5f63 7572 736f 7220 3d3d 2022 223a 0a20  _cursor == "":. 
-0001a780: 2020 2020 2020 2020 2020 2023 2057 6520             # We 
-0001a790: 6172 6520 7374 6172 7469 6e67 2066 726f  are starting fro
-0001a7a0: 6d20 7468 6520 6265 6769 6e6e 696e 672c  m the beginning,
-0001a7b0: 2064 6f20 6120 6675 6c6c 2069 6e64 6578   do a full index
-0001a7c0: 696e 672e 0a20 2020 2020 2020 2020 2020  ing..           
-0001a7d0: 2063 6861 6e67 6573 5f69 7465 7220 3d20   changes_iter = 
-0001a7e0: 7365 6c66 2e63 6c69 656e 742e 6c69 7374  self.client.list
-0001a7f0: 5f66 6f6c 6465 725f 6974 6572 6174 6f72  _folder_iterator
-0001a800: 2822 2f22 2c20 7265 6375 7273 6976 653d  ("/", recursive=
-0001a810: 5472 7565 290a 2020 2020 2020 2020 656c  True).        el
-0001a820: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-0001a830: 2320 5069 636b 2075 7020 7768 6572 6520  # Pick up where 
-0001a840: 7765 206c 6566 7420 6f66 662e 2054 6869  we left off. Thi
-0001a850: 7320 6d61 7920 6265 2061 6e20 696e 7465  s may be an inte
-0001a860: 7272 7570 7465 6420 696e 6465 7869 6e67  rrupted indexing
-0001a870: 202f 0a20 2020 2020 2020 2020 2020 2023   /.            #
-0001a880: 2070 6167 696e 6174 696f 6e20 7468 726f   pagination thro
-0001a890: 7567 6820 6368 616e 6765 7320 6f72 2061  ugh changes or a
-0001a8a0: 2063 6f6d 706c 6574 656c 7920 6e65 7720   completely new 
-0001a8b0: 7365 7420 6f66 2063 6861 6e67 6573 2e0a  set of changes..
-0001a8c0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-0001a8d0: 2e5f 6c6f 6767 6572 2e64 6562 7567 2822  ._logger.debug("
-0001a8e0: 4665 7463 6869 6e67 2072 656d 6f74 6520  Fetching remote 
-0001a8f0: 6368 616e 6765 7320 7369 6e63 6520 6375  changes since cu
-0001a900: 7273 6f72 3a20 2573 222c 206c 6173 745f  rsor: %s", last_
-0001a910: 6375 7273 6f72 290a 2020 2020 2020 2020  cursor).        
-0001a920: 2020 2020 6368 616e 6765 735f 6974 6572      changes_iter
-0001a930: 203d 2073 656c 662e 636c 6965 6e74 2e6c   = self.client.l
-0001a940: 6973 745f 7265 6d6f 7465 5f63 6861 6e67  ist_remote_chang
-0001a950: 6573 5f69 7465 7261 746f 7228 6c61 7374  es_iterator(last
-0001a960: 5f63 7572 736f 7229 0a0a 2020 2020 2020  _cursor)..      
-0001a970: 2020 666f 7220 6368 616e 6765 7320 696e    for changes in
-0001a980: 2063 6861 6e67 6573 5f69 7465 723a 0a20   changes_iter:. 
-0001a990: 2020 2020 2020 2020 2020 2063 6861 6e67             chang
-0001a9a0: 6573 203d 2073 656c 662e 5f63 6c65 616e  es = self._clean
-0001a9b0: 5f72 656d 6f74 655f 6368 616e 6765 7328  _remote_changes(
-0001a9c0: 6368 616e 6765 7329 0a20 2020 2020 2020  changes).       
-0001a9d0: 2020 2020 2063 6861 6e67 6573 2e65 6e74       changes.ent
-0001a9e0: 7269 6573 2e73 6f72 7428 6b65 793d 6c61  ries.sort(key=la
-0001a9f0: 6d62 6461 2078 3a20 782e 7061 7468 5f6c  mbda x: x.path_l
-0001aa00: 6f77 6572 2e63 6f75 6e74 2822 2f22 2929  ower.count("/"))
-0001aa10: 0a0a 2020 2020 2020 2020 2020 2020 7365  ..            se
-0001aa20: 6c66 2e5f 6c6f 6767 6572 2e64 6562 7567  lf._logger.debug
-0001aa30: 2822 5265 6d6f 7465 2063 6861 6e67 6573  ("Remote changes
-0001aa40: 3a5c 6e25 7322 2c20 7066 5f72 6570 7228  :\n%s", pf_repr(
-0001aa50: 6368 616e 6765 732e 656e 7472 6965 7329  changes.entries)
-0001aa60: 290a 0a20 2020 2020 2020 2020 2020 2073  )..            s
-0001aa70: 796e 635f 6576 656e 7473 203d 205b 5379  ync_events = [Sy
-0001aa80: 6e63 4576 656e 742e 6672 6f6d 5f6d 6574  ncEvent.from_met
-0001aa90: 6164 6174 6128 6d64 2c20 7365 6c66 2920  adata(md, self) 
-0001aaa0: 666f 7220 6d64 2069 6e20 6368 616e 6765  for md in change
-0001aab0: 732e 656e 7472 6965 735d 0a0a 2020 2020  s.entries]..    
-0001aac0: 2020 2020 2020 2020 7365 6c66 2e5f 6c6f          self._lo
-0001aad0: 6767 6572 2e64 6562 7567 2822 436f 6e76  gger.debug("Conv
-0001aae0: 6572 7465 6420 7265 6d6f 7465 2063 6861  erted remote cha
-0001aaf0: 6e67 6573 2074 6f20 5379 6e63 4576 656e  nges to SyncEven
-0001ab00: 7473 2229 0a0a 2020 2020 2020 2020 2020  ts")..          
-0001ab10: 2020 7969 656c 6420 7379 6e63 5f65 7665    yield sync_eve
-0001ab20: 6e74 732c 2063 6861 6e67 6573 2e63 7572  nts, changes.cur
-0001ab30: 736f 720a 0a20 2020 2064 6566 2061 7070  sor..    def app
-0001ab40: 6c79 5f72 656d 6f74 655f 6368 616e 6765  ly_remote_change
-0001ab50: 7328 0a20 2020 2020 2020 2073 656c 662c  s(.        self,
-0001ab60: 2073 796e 635f 6576 656e 7473 3a20 436f   sync_events: Co
-0001ab70: 6c6c 6563 7469 6f6e 5b53 796e 6345 7665  llection[SyncEve
-0001ab80: 6e74 5d0a 2020 2020 2920 2d3e 206c 6973  nt].    ) -> lis
-0001ab90: 745b 5379 6e63 4576 656e 745d 3a0a 2020  t[SyncEvent]:.  
-0001aba0: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
-0001abb0: 2020 4170 706c 6965 7320 7265 6d6f 7465    Applies remote
-0001abc0: 2063 6861 6e67 6573 2074 6f20 6c6f 6361   changes to loca
-0001abd0: 6c20 666f 6c64 6572 2e20 4361 6c6c 2074  l folder. Call t
-0001abe0: 6869 7320 6f6e 2074 6865 2072 6573 756c  his on the resul
-0001abf0: 7420 6f66 0a20 2020 2020 2020 203a 6d65  t of.        :me
-0001ac00: 7468 3a60 6c69 7374 5f72 656d 6f74 655f  th:`list_remote_
-0001ac10: 6368 616e 6765 7360 2e20 5468 6520 7361  changes`. The sa
-0001ac20: 7665 6420 6375 7273 6f72 2069 7320 7570  ved cursor is up
-0001ac30: 6461 7465 6420 6166 7465 7220 6120 7365  dated after a se
-0001ac40: 7420 6f66 2063 6861 6e67 6573 0a20 2020  t of changes.   
-0001ac50: 2020 2020 2068 6173 2062 6565 6e20 7375       has been su
-0001ac60: 6363 6573 7366 756c 6c79 2061 7070 6c69  ccessfully appli
-0001ac70: 6564 2e20 456e 7472 6965 7320 696e 2074  ed. Entries in t
-0001ac80: 6865 206c 6f63 616c 2069 6e64 6578 2061  he local index a
-0001ac90: 7265 2063 7265 6174 6564 2061 6674 6572  re created after
-0001aca0: 0a20 2020 2020 2020 2073 7563 6365 7373  .        success
-0001acb0: 6675 6c20 636f 6d70 6c65 7469 6f6e 2e0a  ful completion..
-0001acc0: 0a20 2020 2020 2020 203a 7061 7261 6d20  .        :param 
-0001acd0: 7379 6e63 5f65 7665 6e74 733a 204c 6973  sync_events: Lis
-0001ace0: 7420 6f66 2072 656d 6f74 6520 6368 616e  t of remote chan
-0001acf0: 6765 732e 0a20 2020 2020 2020 203a 7265  ges..        :re
-0001ad00: 7475 726e 733a 204c 6973 7420 6f66 2063  turns: List of c
-0001ad10: 6861 6e67 6573 2074 6861 7420 7765 7265  hanges that were
-0001ad20: 206d 6164 6520 746f 206c 6f63 616c 2066   made to local f
-0001ad30: 696c 6573 2061 6e64 2062 6f6f 6c20 696e  iles and bool in
-0001ad40: 6469 6361 7469 6e67 2069 660a 2020 2020  dicating if.    
-0001ad50: 2020 2020 2020 2020 616c 6c20 646f 776e          all down
-0001ad60: 6c6f 6164 2073 796e 6373 2077 6572 6520  load syncs were 
-0001ad70: 7375 6363 6573 7366 756c 2e0a 2020 2020  successful..    
-0001ad80: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
-0001ad90: 7265 7375 6c74 733a 206c 6973 745b 5379  results: list[Sy
-0001ada0: 6e63 4576 656e 745d 203d 205b 5d0a 0a20  ncEvent] = [].. 
-0001adb0: 2020 2020 2020 2069 6620 6c65 6e28 7379         if len(sy
-0001adc0: 6e63 5f65 7665 6e74 7329 203d 3d20 303a  nc_events) == 0:
-0001add0: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-0001ade0: 7572 6e20 7265 7375 6c74 730a 0a20 2020  urn results..   
-0001adf0: 2020 2020 2023 2053 6f72 7420 6368 616e       # Sort chan
-0001ae00: 6765 7320 696e 746f 2066 6f6c 6465 7273  ges into folders
-0001ae10: 2c20 6669 6c65 7320 616e 6420 6465 6c65  , files and dele
-0001ae20: 7465 6420 6974 656d 732e 2044 6973 6361  ted items. Disca
-0001ae30: 7264 2065 7863 6c75 6465 6420 6974 656d  rd excluded item
-0001ae40: 730a 2020 2020 2020 2020 2320 616e 6420  s.        # and 
-0001ae50: 7265 6d6f 7665 2061 6e64 2064 656c 6574  remove and delet
-0001ae60: 6564 2069 7465 6d73 2066 726f 6d20 6f75  ed items from ou
-0001ae70: 7220 6578 636c 7564 6564 206c 6973 742e  r excluded list.
-0001ae80: 0a20 2020 2020 2020 2023 2053 6f72 7420  .        # Sort 
-0001ae90: 6163 636f 7264 696e 6720 746f 2070 6174  according to pat
-0001aea0: 6820 6869 6572 6172 6368 793a 0a20 2020  h hierarchy:.   
-0001aeb0: 2020 2020 2023 202d 2044 6f20 6e6f 7420       # - Do not 
-0001aec0: 6372 6561 7465 2073 7562 2d66 6f6c 6465  create sub-folde
-0001aed0: 7220 2f20 6669 6c65 2062 6566 6f72 6520  r / file before 
-0001aee0: 7061 7265 6e74 2065 7869 7374 732e 0a20  parent exists.. 
-0001aef0: 2020 2020 2020 2023 202d 2044 656c 6574         # - Delet
-0001af00: 6520 7061 7265 6e74 7320 6265 666f 7265  e parents before
-0001af10: 2064 656c 6574 696e 6720 6368 696c 6472   deleting childr
-0001af20: 656e 2074 6f20 7361 7665 2073 6f6d 6520  en to save some 
-0001af30: 776f 726b 2e0a 0a20 2020 2020 2020 2066  work...        f
-0001af40: 696c 6573 3a20 6c69 7374 5b53 796e 6345  iles: list[SyncE
-0001af50: 7665 6e74 5d20 3d20 5b5d 0a20 2020 2020  vent] = [].     
-0001af60: 2020 2066 6f6c 6465 7273 3a20 6465 6661     folders: defa
-0001af70: 756c 7464 6963 745b 696e 742c 206c 6973  ultdict[int, lis
-0001af80: 745b 5379 6e63 4576 656e 745d 5d20 3d20  t[SyncEvent]] = 
-0001af90: 6465 6661 756c 7464 6963 7428 6c69 7374  defaultdict(list
-0001afa0: 290a 2020 2020 2020 2020 6465 6c65 7465  ).        delete
-0001afb0: 643a 2064 6566 6175 6c74 6469 6374 5b69  d: defaultdict[i
-0001afc0: 6e74 2c20 6c69 7374 5b53 796e 6345 7665  nt, list[SyncEve
-0001afd0: 6e74 5d5d 203d 2064 6566 6175 6c74 6469  nt]] = defaultdi
-0001afe0: 6374 286c 6973 7429 0a0a 2020 2020 2020  ct(list)..      
-0001aff0: 2020 6e65 775f 6578 636c 7564 6564 203d    new_excluded =
-0001b000: 2073 656c 662e 6578 636c 7564 6564 5f69   self.excluded_i
-0001b010: 7465 6d73 0a0a 2020 2020 2020 2020 666f  tems..        fo
-0001b020: 7220 6576 656e 7420 696e 2073 796e 635f  r event in sync_
-0001b030: 6576 656e 7473 3a0a 2020 2020 2020 2020  events:.        
-0001b040: 2020 2020 6973 5f65 7863 6c75 6465 6420      is_excluded 
-0001b050: 3d20 7365 6c66 2e69 735f 6578 636c 7564  = self.is_exclud
-0001b060: 6564 5f62 795f 7573 6572 280a 2020 2020  ed_by_user(.    
-0001b070: 2020 2020 2020 2020 2020 2020 6576 656e              even
-0001b080: 742e 6462 785f 7061 7468 5f6c 6f77 6572  t.dbx_path_lower
-0001b090: 0a20 2020 2020 2020 2020 2020 2029 206f  .            ) o
-0001b0a0: 7220 7365 6c66 2e69 735f 6578 636c 7564  r self.is_exclud
-0001b0b0: 6564 2865 7665 6e74 2e64 6278 5f70 6174  ed(event.dbx_pat
-0001b0c0: 6829 0a0a 2020 2020 2020 2020 2020 2020  h)..            
-0001b0d0: 6966 2069 735f 6578 636c 7564 6564 3a0a  if is_excluded:.
-0001b0e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b0f0: 6966 2065 7665 6e74 2e69 735f 6465 6c65  if event.is_dele
-0001b100: 7465 643a 0a20 2020 2020 2020 2020 2020  ted:.           
-0001b110: 2020 2020 2020 2020 2023 2052 656d 6f76           # Remov
-0001b120: 6520 6465 6c65 7465 6420 6974 656d 2061  e deleted item a
-0001b130: 6e64 2069 7473 2063 6869 6c64 7265 6e20  nd its children 
-0001b140: 6672 6f6d 2074 6865 2065 7863 6c75 6465  from the exclude
-0001b150: 6420 6c69 7374 2e0a 2020 2020 2020 2020  d list..        
-0001b160: 2020 2020 2020 2020 2020 2020 6e65 775f              new_
-0001b170: 6578 636c 7564 6564 203d 205b 0a20 2020  excluded = [.   
-0001b180: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b190: 2020 2020 2070 6174 680a 2020 2020 2020       path.      
-0001b1a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b1b0: 2020 666f 7220 7061 7468 2069 6e20 6e65    for path in ne
-0001b1c0: 775f 6578 636c 7564 6564 0a20 2020 2020  w_excluded.     
-0001b1d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b1e0: 2020 2069 6620 6e6f 7420 6973 5f65 7175     if not is_equ
-0001b1f0: 616c 5f6f 725f 6368 696c 6428 7061 7468  al_or_child(path
-0001b200: 2c20 6576 656e 742e 6462 785f 7061 7468  , event.dbx_path
-0001b210: 5f6c 6f77 6572 290a 2020 2020 2020 2020  _lower).        
-0001b220: 2020 2020 2020 2020 2020 2020 5d0a 0a20              ].. 
-0001b230: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
-0001b240: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001b250: 206c 6576 656c 203d 2065 7665 6e74 2e64   level = event.d
-0001b260: 6278 5f70 6174 682e 636f 756e 7428 222f  bx_path.count("/
-0001b270: 2229 0a0a 2020 2020 2020 2020 2020 2020  ")..            
-0001b280: 2020 2020 6966 2065 7665 6e74 2e69 735f      if event.is_
-0001b290: 6465 6c65 7465 643a 0a20 2020 2020 2020  deleted:.       
-0001b2a0: 2020 2020 2020 2020 2020 2020 2064 656c               del
-0001b2b0: 6574 6564 5b6c 6576 656c 5d2e 6170 7065  eted[level].appe
-0001b2c0: 6e64 2865 7665 6e74 290a 2020 2020 2020  nd(event).      
-0001b2d0: 2020 2020 2020 2020 2020 656c 6966 2065            elif e
-0001b2e0: 7665 6e74 2e69 735f 6669 6c65 3a0a 2020  vent.is_file:.  
-0001b2f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b300: 2020 6669 6c65 732e 6170 7065 6e64 2865    files.append(e
-0001b310: 7665 6e74 290a 2020 2020 2020 2020 2020  vent).          
-0001b320: 2020 2020 2020 656c 6966 2065 7665 6e74        elif event
-0001b330: 2e69 735f 6469 7265 6374 6f72 793a 0a20  .is_directory:. 
-0001b340: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b350: 2020 2066 6f6c 6465 7273 5b6c 6576 656c     folders[level
-0001b360: 5d2e 6170 7065 6e64 2865 7665 6e74 290a  ].append(event).
-0001b370: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001b380: 2023 2048 6f75 7365 6b65 6570 696e 672e   # Housekeeping.
-0001b390: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001b3a0: 2073 656c 662e 6163 7469 7669 7479 2e61   self.activity.a
-0001b3b0: 6464 2865 7665 6e74 290a 0a20 2020 2020  dd(event)..     
-0001b3c0: 2020 2073 656c 662e 6578 636c 7564 6564     self.excluded
-0001b3d0: 5f69 7465 6d73 203d 206e 6577 5f65 7863  _items = new_exc
-0001b3e0: 6c75 6465 640a 0a20 2020 2020 2020 2023  luded..        #
-0001b3f0: 2041 7070 6c79 2064 656c 6574 6564 2069   Apply deleted i
-0001b400: 7465 6d73 2e0a 2020 2020 2020 2020 6966  tems..        if
-0001b410: 2064 656c 6574 6564 3a0a 2020 2020 2020   deleted:.      
-0001b420: 2020 2020 2020 7365 6c66 2e5f 6c6f 6767        self._logg
-0001b430: 6572 2e69 6e66 6f28 2241 7070 6c79 696e  er.info("Applyin
-0001b440: 6720 6465 6c65 7469 6f6e 732e 2e2e 2229  g deletions...")
-0001b450: 0a0a 2020 2020 2020 2020 666f 7220 6c65  ..        for le
-0001b460: 7665 6c20 696e 2073 6f72 7465 6428 6465  vel in sorted(de
-0001b470: 6c65 7465 6429 3a0a 2020 2020 2020 2020  leted):.        
-0001b480: 2020 2020 7265 7320 3d20 646f 5f70 6172      res = do_par
-0001b490: 616c 6c65 6c28 0a20 2020 2020 2020 2020  allel(.         
-0001b4a0: 2020 2020 2020 2073 656c 662e 5f63 7265         self._cre
-0001b4b0: 6174 655f 6c6f 6361 6c5f 656e 7472 792c  ate_local_entry,
-0001b4c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001b4d0: 2064 656c 6574 6564 5b6c 6576 656c 5d2c   deleted[level],
-0001b4e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001b4f0: 206f 6e5f 7072 6f67 7265 7373 3d6c 616d   on_progress=lam
-0001b500: 6264 6120 782c 2079 3a20 7365 6c66 2e5f  bda x, y: self._
-0001b510: 6c6f 6767 6572 2e69 6e66 6f28 6622 4465  logger.info(f"De
-0001b520: 6c65 7469 6e67 207b 787d 2f7b 797d 2229  leting {x}/{y}")
-0001b530: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0001b540: 2020 7468 7265 6164 5f6e 616d 655f 7072    thread_name_pr
-0001b550: 6566 6978 3d22 6d61 6573 7472 616c 2d64  efix="maestral-d
-0001b560: 6f77 6e6c 6f61 642d 706f 6f6c 222c 0a20  ownload-pool",. 
-0001b570: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
-0001b580: 2020 2020 2020 2020 2072 6573 756c 7473           results
-0001b590: 2e65 7874 656e 6428 7265 7329 0a0a 2020  .extend(res)..  
-0001b5a0: 2020 2020 2020 2320 4372 6561 7465 206c        # Create l
-0001b5b0: 6f63 616c 2066 6f6c 6465 7273 2c20 7374  ocal folders, st
-0001b5c0: 6172 7420 7769 7468 2074 6f70 2d6c 6576  art with top-lev
-0001b5d0: 656c 2061 6e64 2077 6f72 6b20 796f 7572  el and work your
-0001b5e0: 2077 6179 2064 6f77 6e2e 0a20 2020 2020   way down..     
-0001b5f0: 2020 2069 6620 666f 6c64 6572 733a 0a20     if folders:. 
-0001b600: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-0001b610: 5f6c 6f67 6765 722e 696e 666f 2822 4372  _logger.info("Cr
-0001b620: 6561 7469 6e67 2066 6f6c 6465 7273 2e2e  eating folders..
-0001b630: 2e22 290a 0a20 2020 2020 2020 2066 6f72  .")..        for
-0001b640: 206c 6576 656c 2069 6e20 736f 7274 6564   level in sorted
-0001b650: 2866 6f6c 6465 7273 293a 0a20 2020 2020  (folders):.     
-0001b660: 2020 2020 2020 2072 6573 203d 2064 6f5f         res = do_
-0001b670: 7061 7261 6c6c 656c 280a 2020 2020 2020  parallel(.      
-0001b680: 2020 2020 2020 2020 2020 7365 6c66 2e5f            self._
-0001b690: 6372 6561 7465 5f6c 6f63 616c 5f65 6e74  create_local_ent
-0001b6a0: 7279 2c0a 2020 2020 2020 2020 2020 2020  ry,.            
-0001b6b0: 2020 2020 666f 6c64 6572 735b 6c65 7665      folders[leve
-0001b6c0: 6c5d 2c0a 2020 2020 2020 2020 2020 2020  l],.            
-0001b6d0: 2020 2020 6f6e 5f70 726f 6772 6573 733d      on_progress=
-0001b6e0: 6c61 6d62 6461 2078 2c20 793a 2073 656c  lambda x, y: sel
-0001b6f0: 662e 5f6c 6f67 6765 722e 696e 666f 2866  f._logger.info(f
-0001b700: 2243 7265 6174 696e 6720 666f 6c64 6572  "Creating folder
-0001b710: 207b 787d 2f7b 797d 2229 2c0a 2020 2020   {x}/{y}"),.    
-0001b720: 2020 2020 2020 2020 2020 2020 7468 7265              thre
-0001b730: 6164 5f6e 616d 655f 7072 6566 6978 3d22  ad_name_prefix="
-0001b740: 6d61 6573 7472 616c 2d64 6f77 6e6c 6f61  maestral-downloa
-0001b750: 642d 706f 6f6c 222c 0a20 2020 2020 2020  d-pool",.       
-0001b760: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
-0001b770: 2020 2072 6573 756c 7473 2e65 7874 656e     results.exten
-0001b780: 6428 7265 7329 0a0a 2020 2020 2020 2020  d(res)..        
-0001b790: 2320 4170 706c 7920 6372 6561 7465 6420  # Apply created 
-0001b7a0: 6669 6c65 732e 0a20 2020 2020 2020 2072  files..        r
-0001b7b0: 6573 203d 2064 6f5f 7061 7261 6c6c 656c  es = do_parallel
-0001b7c0: 280a 2020 2020 2020 2020 2020 2020 7365  (.            se
-0001b7d0: 6c66 2e5f 6372 6561 7465 5f6c 6f63 616c  lf._create_local
-0001b7e0: 5f65 6e74 7279 2c0a 2020 2020 2020 2020  _entry,.        
-0001b7f0: 2020 2020 6669 6c65 732c 0a20 2020 2020      files,.     
-0001b800: 2020 2020 2020 206f 6e5f 7072 6f67 7265         on_progre
-0001b810: 7373 3d6c 616d 6264 6120 782c 2079 3a20  ss=lambda x, y: 
-0001b820: 7365 6c66 2e5f 6c6f 6767 6572 2e69 6e66  self._logger.inf
-0001b830: 6f28 6622 5379 6e63 696e 6720 e286 9320  o(f"Syncing ... 
-0001b840: 7b78 7d2f 7b79 7d22 292c 0a20 2020 2020  {x}/{y}"),.     
-0001b850: 2020 2020 2020 2074 6872 6561 645f 6e61         thread_na
-0001b860: 6d65 5f70 7265 6669 783d 226d 6165 7374  me_prefix="maest
-0001b870: 7261 6c2d 646f 776e 6c6f 6164 2d70 6f6f  ral-download-poo
-0001b880: 6c22 2c0a 2020 2020 2020 2020 290a 2020  l",.        ).  
-0001b890: 2020 2020 2020 7265 7375 6c74 732e 6578        results.ex
-0001b8a0: 7465 6e64 2872 6573 290a 0a20 2020 2020  tend(res)..     
-0001b8b0: 2020 2073 656c 662e 5f63 6c65 616e 5f68     self._clean_h
-0001b8c0: 6973 746f 7279 2829 0a0a 2020 2020 2020  istory()..      
-0001b8d0: 2020 7265 7475 726e 2072 6573 756c 7473    return results
-0001b8e0: 0a0a 2020 2020 6465 6620 6e6f 7469 6679  ..    def notify
-0001b8f0: 5f75 7365 7228 7365 6c66 2c20 7379 6e63  _user(self, sync
-0001b900: 5f65 7665 6e74 733a 2053 6571 7565 6e63  _events: Sequenc
-0001b910: 655b 5379 6e63 4576 656e 745d 2920 2d3e  e[SyncEvent]) ->
-0001b920: 204e 6f6e 653a 0a20 2020 2020 2020 2022   None:.        "
-0001b930: 2222 0a20 2020 2020 2020 2053 686f 7773  "".        Shows
-0001b940: 2061 2064 6573 6b74 6f70 206e 6f74 6966   a desktop notif
-0001b950: 6963 6174 696f 6e20 666f 7220 7468 6520  ication for the 
-0001b960: 6769 7665 6e20 6669 6c65 2063 6861 6e67  given file chang
-0001b970: 6573 2e0a 0a20 2020 2020 2020 203a 7061  es...        :pa
-0001b980: 7261 6d20 7379 6e63 5f65 7665 6e74 733a  ram sync_events:
-0001b990: 204c 6973 7420 6f66 2053 796e 6345 7665   List of SyncEve
-0001b9a0: 6e74 7320 6672 6f6d 2064 6f77 6e6c 6f61  nts from downloa
-0001b9b0: 6420 7379 6e63 2e0a 2020 2020 2020 2020  d sync..        
-0001b9c0: 2222 220a 2020 2020 2020 2020 6966 206e  """.        if n
-0001b9d0: 6f74 2073 656c 662e 6465 736b 746f 705f  ot self.desktop_
-0001b9e0: 6e6f 7469 6669 6572 3a0a 2020 2020 2020  notifier:.      
-0001b9f0: 2020 2020 2020 7265 7475 726e 0a0a 2020        return..  
-0001ba00: 2020 2020 2020 6368 616e 6765 733a 206c        changes: l
-0001ba10: 6973 745b 5379 6e63 4576 656e 745d 203d  ist[SyncEvent] =
-0001ba20: 205b 5d0a 2020 2020 2020 2020 6576 656e   [].        even
-0001ba30: 7473 5f63 6f6e 666c 6963 743a 206c 6973  ts_conflict: lis
-0001ba40: 745b 5379 6e63 4576 656e 745d 203d 205b  t[SyncEvent] = [
-0001ba50: 5d0a 0a20 2020 2020 2020 2066 6f72 2065  ]..        for e
-0001ba60: 7665 6e74 2069 6e20 7379 6e63 5f65 7665  vent in sync_eve
-0001ba70: 6e74 733a 0a20 2020 2020 2020 2020 2020  nts:.           
-0001ba80: 2069 6620 6576 656e 742e 7374 6174 7573   if event.status
-0001ba90: 2069 7320 6e6f 7420 5379 6e63 5374 6174   is not SyncStat
-0001baa0: 7573 2e53 6b69 7070 6564 3a0a 2020 2020  us.Skipped:.    
-0001bab0: 2020 2020 2020 2020 2020 2020 6368 616e              chan
-0001bac0: 6765 732e 6170 7065 6e64 2865 7665 6e74  ges.append(event
-0001bad0: 290a 2020 2020 2020 2020 2020 2020 6966  ).            if
-0001bae0: 2065 7665 6e74 2e73 7461 7475 7320 6973   event.status is
-0001baf0: 2053 796e 6353 7461 7475 732e 436f 6e66   SyncStatus.Conf
-0001bb00: 6c69 6374 3a0a 2020 2020 2020 2020 2020  lict:.          
-0001bb10: 2020 2020 2020 6576 656e 7473 5f63 6f6e        events_con
-0001bb20: 666c 6963 742e 6170 7065 6e64 2865 7665  flict.append(eve
-0001bb30: 6e74 290a 0a20 2020 2020 2020 2023 2047  nt)..        # G
-0001bb40: 6574 206e 756d 6265 7220 6f66 2072 656d  et number of rem
-0001bb50: 6f74 6520 6368 616e 6765 732e 0a20 2020  ote changes..   
-0001bb60: 2020 2020 206e 5f63 6861 6e67 6564 203d       n_changed =
-0001bb70: 206c 656e 2863 6861 6e67 6573 290a 0a20   len(changes).. 
-0001bb80: 2020 2020 2020 2069 6620 6e5f 6368 616e         if n_chan
-0001bb90: 6765 6420 3d3d 2030 3a0a 2020 2020 2020  ged == 0:.      
-0001bba0: 2020 2020 2020 7265 7475 726e 0a0a 2020        return..  
-0001bbb0: 2020 2020 2020 2320 4669 6e64 206f 7574        # Find out
-0001bbc0: 2077 686f 2063 6861 6e67 6564 2074 6865   who changed the
-0001bbd0: 2069 7465 6d28 7329 2e0a 2020 2020 2020   item(s)..      
-0001bbe0: 2020 7573 6572 5f6e 616d 653a 2073 7472    user_name: str
-0001bbf0: 207c 204e 6f6e 650a 2020 2020 2020 2020   | None.        
-0001bc00: 6462 6964 5f73 6574 203d 207b 652e 6368  dbid_set = {e.ch
-0001bc10: 616e 6765 5f64 6269 6420 666f 7220 6520  ange_dbid for e 
-0001bc20: 696e 2063 6861 6e67 6573 7d0a 2020 2020  in changes}.    
-0001bc30: 2020 2020 6966 206c 656e 2864 6269 645f      if len(dbid_
-0001bc40: 7365 7429 203d 3d20 313a 0a20 2020 2020  set) == 1:.     
-0001bc50: 2020 2020 2020 2023 2041 6c6c 2066 696c         # All fil
-0001bc60: 6573 2068 6176 6520 6265 656e 206d 6f64  es have been mod
-0001bc70: 6966 6965 6420 6279 2074 6865 2073 616d  ified by the sam
-0001bc80: 6520 7573 6572 0a20 2020 2020 2020 2020  e user.         
-0001bc90: 2020 2064 6269 6420 3d20 6462 6964 5f73     dbid = dbid_s
-0001bca0: 6574 2e70 6f70 2829 0a20 2020 2020 2020  et.pop().       
-0001bcb0: 2020 2020 2069 6620 6462 6964 203d 3d20       if dbid == 
-0001bcc0: 7365 6c66 2e63 6c69 656e 742e 6163 636f  self.client.acco
-0001bcd0: 756e 745f 696e 666f 2e61 6363 6f75 6e74  unt_info.account
-0001bce0: 5f69 643a 0a20 2020 2020 2020 2020 2020  _id:.           
-0001bcf0: 2020 2020 2075 7365 725f 6e61 6d65 203d       user_name =
-0001bd00: 2022 596f 7522 0a20 2020 2020 2020 2020   "You".         
-0001bd10: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-0001bd20: 2020 2020 2020 2020 2075 7365 725f 6e61           user_na
-0001bd30: 6d65 203d 2073 656c 662e 5f64 6973 706c  me = self._displ
-0001bd40: 6179 5f6e 616d 655f 666f 725f 6163 636f  ay_name_for_acco
-0001bd50: 756e 7428 6462 6964 290a 2020 2020 2020  unt(dbid).      
-0001bd60: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-0001bd70: 2020 2020 2320 446f 6e27 7420 6469 7370      # Don't disp
-0001bd80: 6c61 7920 6d75 6c74 6970 6c65 2075 7365  lay multiple use
-0001bd90: 726e 616d 6573 2069 6e20 6e6f 7469 6669  rnames in notifi
-0001bda0: 6361 7469 6f6e 2e0a 2020 2020 2020 2020  cation..        
-0001bdb0: 2020 2020 7573 6572 5f6e 616d 6520 3d20      user_name = 
-0001bdc0: 4e6f 6e65 0a0a 2020 2020 2020 2020 6275  None..        bu
-0001bdd0: 7474 6f6e 733a 2064 6963 745b 7374 722c  ttons: dict[str,
-0001bde0: 2043 616c 6c61 626c 655b 5b5d 2c20 4e6f   Callable[[], No
-0001bdf0: 6e65 5d5d 0a0a 2020 2020 2020 2020 6966  ne]]..        if
-0001be00: 206e 5f63 6861 6e67 6564 203d 3d20 313a   n_changed == 1:
-0001be10: 0a20 2020 2020 2020 2020 2020 2023 2044  .            # D
-0001be20: 6973 706c 6179 2074 6865 2075 7365 726e  isplay the usern
-0001be30: 616d 652c 2066 696c 6520 6e61 6d65 2c20  ame, file name, 
-0001be40: 616e 6420 7479 7065 206f 6620 6368 616e  and type of chan
-0001be50: 6765 2069 6e20 6e6f 7469 6669 6361 7469  ge in notificati
-0001be60: 6f6e 2e0a 2020 2020 2020 2020 2020 2020  on..            
-0001be70: 6576 656e 7420 3d20 6368 616e 6765 735b  event = changes[
-0001be80: 305d 0a20 2020 2020 2020 2020 2020 2066  0].            f
-0001be90: 696c 655f 6e61 6d65 203d 206f 7370 2e62  ile_name = osp.b
-0001bea0: 6173 656e 616d 6528 6576 656e 742e 6462  asename(event.db
-0001beb0: 785f 7061 7468 290a 2020 2020 2020 2020  x_path).        
-0001bec0: 2020 2020 6368 616e 6765 5f74 7970 6520      change_type 
-0001bed0: 3d20 6576 656e 742e 6368 616e 6765 5f74  = event.change_t
-0001bee0: 7970 652e 7661 6c75 650a 0a20 2020 2020  ype.value..     
-0001bef0: 2020 2020 2020 2064 6566 2063 616c 6c62         def callb
-0001bf00: 6163 6b28 2920 2d3e 204e 6f6e 653a 0a20  ack() -> None:. 
-0001bf10: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-0001bf20: 6c69 636b 2e6c 6175 6e63 6828 6576 656e  lick.launch(even
-0001bf30: 742e 6c6f 6361 6c5f 7061 7468 2c20 6c6f  t.local_path, lo
-0001bf40: 6361 7465 3d54 7275 6529 0a0a 2020 2020  cate=True)..    
-0001bf50: 2020 2020 2020 2020 6275 7474 6f6e 7320          buttons 
-0001bf60: 3d20 7b22 5368 6f77 223a 2063 616c 6c62  = {"Show": callb
-0001bf70: 6163 6b7d 0a0a 2020 2020 2020 2020 656c  ack}..        el
-0001bf80: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-0001bf90: 2320 4469 7370 6c61 7920 7468 6520 6e75  # Display the nu
-0001bfa0: 6d62 6572 206f 6620 6669 6c65 7320 6368  mber of files ch
-0001bfb0: 616e 6765 6420 616e 6420 706f 7465 6e74  anged and potent
-0001bfc0: 6961 6c6c 7920 7468 6520 7479 7065 206f  ially the type o
-0001bfd0: 6620 6368 616e 6765 2069 6e0a 2020 2020  f change in.    
-0001bfe0: 2020 2020 2020 2020 2320 6e6f 7469 6669          # notifi
-0001bff0: 6361 7469 6f6e 2e0a 0a20 2020 2020 2020  cation...       
-0001c000: 2020 2020 2069 6620 616c 6c28 652e 6368       if all(e.ch
-0001c010: 616e 6765 5f74 7970 6520 3d3d 2073 796e  ange_type == syn
-0001c020: 635f 6576 656e 7473 5b30 5d2e 6368 616e  c_events[0].chan
-0001c030: 6765 5f74 7970 6520 666f 7220 6520 696e  ge_type for e in
-0001c040: 2073 796e 635f 6576 656e 7473 293a 0a20   sync_events):. 
-0001c050: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-0001c060: 6861 6e67 655f 7479 7065 203d 2073 796e  hange_type = syn
-0001c070: 635f 6576 656e 7473 5b30 5d2e 6368 616e  c_events[0].chan
-0001c080: 6765 5f74 7970 652e 7661 6c75 650a 2020  ge_type.value.  
-0001c090: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
-0001c0a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c0b0: 6368 616e 6765 5f74 7970 6520 3d20 2263  change_type = "c
-0001c0c0: 6861 6e67 6564 220a 0a20 2020 2020 2020  hanged"..       
-0001c0d0: 2020 2020 2069 6620 616c 6c28 652e 6973       if all(e.is
-0001c0e0: 5f66 696c 6520 666f 7220 6520 696e 2073  _file for e in s
-0001c0f0: 796e 635f 6576 656e 7473 293a 0a20 2020  ync_events):.   
-0001c100: 2020 2020 2020 2020 2020 2020 2066 696c               fil
-0001c110: 655f 6e61 6d65 203d 2066 227b 6e5f 6368  e_name = f"{n_ch
-0001c120: 616e 6765 647d 2066 696c 6573 220a 2020  anged} files".  
-0001c130: 2020 2020 2020 2020 2020 656c 6966 2061            elif a
-0001c140: 6c6c 2865 2e69 735f 6469 7265 6374 6f72  ll(e.is_director
-0001c150: 7920 666f 7220 6520 696e 2073 796e 635f  y for e in sync_
-0001c160: 6576 656e 7473 293a 0a20 2020 2020 2020  events):.       
-0001c170: 2020 2020 2020 2020 2066 696c 655f 6e61           file_na
-0001c180: 6d65 203d 2066 227b 6e5f 6368 616e 6765  me = f"{n_change
-0001c190: 647d 2066 6f6c 6465 7273 220a 2020 2020  d} folders".    
-0001c1a0: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-0001c1b0: 2020 2020 2020 2020 2020 2020 2020 6669                fi
-0001c1c0: 6c65 5f6e 616d 6520 3d20 6622 7b6e 5f63  le_name = f"{n_c
-0001c1d0: 6861 6e67 6564 7d20 6974 656d 7322 0a0a  hanged} items"..
-0001c1e0: 2020 2020 2020 2020 2020 2020 6465 6620              def 
-0001c1f0: 6361 6c6c 6261 636b 2829 202d 3e20 4e6f  callback() -> No
-0001c200: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
-0001c210: 2020 2020 7061 7373 0a0a 2020 2020 2020      pass..      
-0001c220: 2020 2020 2020 6275 7474 6f6e 7320 3d20        buttons = 
-0001c230: 7b7d 0a0a 2020 2020 2020 2020 6966 2063  {}..        if c
-0001c240: 6861 6e67 655f 7479 7065 203d 3d20 4368  hange_type == Ch
-0001c250: 616e 6765 5479 7065 2e52 656d 6f76 6564  angeType.Removed
-0001c260: 2e76 616c 7565 3a0a 0a20 2020 2020 2020  .value:..       
-0001c270: 2020 2020 2064 6566 2063 616c 6c62 6163       def callbac
-0001c280: 6b28 2920 2d3e 204e 6f6e 653a 0a20 2020  k() -> None:.   
-0001c290: 2020 2020 2020 2020 2020 2020 2023 2053               # S
-0001c2a0: 686f 7720 4472 6f70 626f 7820 7765 6273  how Dropbox webs
-0001c2b0: 6974 6520 7769 7468 2064 656c 6574 6564  ite with deleted
-0001c2c0: 2066 696c 6573 2e0a 2020 2020 2020 2020   files..        
-0001c2d0: 2020 2020 2020 2020 636c 6963 6b2e 6c61          click.la
-0001c2e0: 756e 6368 2822 6874 7470 733a 2f2f 7777  unch("https://ww
-0001c2f0: 772e 6472 6f70 626f 782e 636f 6d2f 6465  w.dropbox.com/de
-0001c300: 6c65 7465 645f 6669 6c65 7322 290a 0a20  leted_files").. 
-0001c310: 2020 2020 2020 2020 2020 2062 7574 746f             butto
-0001c320: 6e73 203d 207b 2253 686f 7722 3a20 6361  ns = {"Show": ca
-0001c330: 6c6c 6261 636b 7d0a 0a20 2020 2020 2020  llback}..       
-0001c340: 2069 6620 7573 6572 5f6e 616d 653a 0a20   if user_name:. 
-0001c350: 2020 2020 2020 2020 2020 206d 7367 203d             msg =
-0001c360: 2066 227b 7573 6572 5f6e 616d 657d 207b   f"{user_name} {
-0001c370: 6368 616e 6765 5f74 7970 657d 207b 6669  change_type} {fi
-0001c380: 6c65 5f6e 616d 657d 220a 2020 2020 2020  le_name}".      
-0001c390: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-0001c3a0: 2020 2020 6d73 6720 3d20 6622 7b66 696c      msg = f"{fil
-0001c3b0: 655f 6e61 6d65 7d20 7b63 6861 6e67 655f  e_name} {change_
-0001c3c0: 7479 7065 7d22 0a0a 2020 2020 2020 2020  type}"..        
-0001c3d0: 2320 4e6f 7469 6679 2069 6e20 6275 6c6b  # Notify in bulk
-0001c3e0: 2066 6f72 2061 6c6c 2062 6174 6368 6564   for all batched
-0001c3f0: 2063 6861 6e67 6573 2e0a 2020 2020 2020   changes..      
-0001c400: 2020 7365 6c66 2e64 6573 6b74 6f70 5f6e    self.desktop_n
-0001c410: 6f74 6966 6965 722e 6e6f 7469 6679 280a  otifier.notify(.
-0001c420: 2020 2020 2020 2020 2020 2020 2249 7465              "Ite
-0001c430: 6d73 2073 796e 6365 6422 2c20 6d73 672c  ms synced", msg,
-0001c440: 2061 6374 696f 6e73 3d62 7574 746f 6e73   actions=buttons
-0001c450: 2c20 6f6e 5f63 6c69 636b 3d63 616c 6c62  , on_click=callb
-0001c460: 6163 6b0a 2020 2020 2020 2020 290a 0a20  ack.        ).. 
-0001c470: 2020 2020 2020 2023 204e 6f74 6966 7920         # Notify 
-0001c480: 7365 7061 7261 7465 6c79 2066 6f72 2065  separately for e
-0001c490: 6163 6820 7379 6e63 2063 6f6e 666c 6963  ach sync conflic
-0001c4a0: 742e 0a20 2020 2020 2020 2066 6f72 2065  t..        for e
-0001c4b0: 7665 6e74 2069 6e20 6576 656e 7473 5f63  vent in events_c
-0001c4c0: 6f6e 666c 6963 743a 0a0a 2020 2020 2020  onflict:..      
-0001c4d0: 2020 2020 2020 6465 6620 6361 6c6c 6261        def callba
-0001c4e0: 636b 2829 202d 3e20 4e6f 6e65 3a0a 2020  ck() -> None:.  
-0001c4f0: 2020 2020 2020 2020 2020 2020 2020 636c                cl
-0001c500: 6963 6b2e 6c61 756e 6368 2865 7665 6e74  ick.launch(event
-0001c510: 2e6c 6f63 616c 5f70 6174 682c 206c 6f63  .local_path, loc
-0001c520: 6174 653d 5472 7565 290a 0a20 2020 2020  ate=True)..     
-0001c530: 2020 2020 2020 2073 656c 662e 6465 736b         self.desk
-0001c540: 746f 705f 6e6f 7469 6669 6572 2e6e 6f74  top_notifier.not
-0001c550: 6966 7928 0a20 2020 2020 2020 2020 2020  ify(.           
-0001c560: 2020 2020 2022 5379 6e63 2063 6f6e 666c       "Sync confl
-0001c570: 6963 7422 2c0a 2020 2020 2020 2020 2020  ict",.          
-0001c580: 2020 2020 2020 6622 436f 6e66 6c69 6374        f"Conflict
-0001c590: 696e 6720 636f 7079 2066 6f72 207b 6669  ing copy for {fi
-0001c5a0: 6c65 5f6e 616d 657d 222c 0a20 2020 2020  le_name}",.     
-0001c5b0: 2020 2020 2020 2020 2020 2061 6374 696f             actio
-0001c5c0: 6e73 3d7b 2253 686f 7722 3a20 6361 6c6c  ns={"Show": call
-0001c5d0: 6261 636b 7d2c 0a20 2020 2020 2020 2020  back},.         
-0001c5e0: 2020 2020 2020 206f 6e5f 636c 6963 6b3d         on_click=
-0001c5f0: 6361 6c6c 6261 636b 2c0a 2020 2020 2020  callback,.      
-0001c600: 2020 2020 2020 290a 0a20 2020 2064 6566        )..    def
-0001c610: 205f 6469 7370 6c61 795f 6e61 6d65 5f66   _display_name_f
-0001c620: 6f72 5f61 6363 6f75 6e74 2873 656c 662c  or_account(self,
-0001c630: 2064 6269 643a 2073 7472 207c 204e 6f6e   dbid: str | Non
-0001c640: 6529 202d 3e20 7374 7220 7c20 4e6f 6e65  e) -> str | None
-0001c650: 3a0a 2020 2020 2020 2020 2222 220a 2020  :.        """.  
-0001c660: 2020 2020 2020 5265 7475 726e 7320 7468        Returns th
-0001c670: 6520 6469 7370 6c61 7920 6e61 6d65 2063  e display name c
-0001c680: 6f72 7265 7370 6f6e 6469 6e67 2074 6f20  orresponding to 
-0001c690: 6120 4472 6f70 626f 7820 4944 2e0a 2020  a Dropbox ID..  
-0001c6a0: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
-0001c6b0: 2020 6966 2064 6269 6420 6973 204e 6f6e    if dbid is Non
-0001c6c0: 653a 0a20 2020 2020 2020 2020 2020 2072  e:.            r
-0001c6d0: 6574 7572 6e20 4e6f 6e65 0a20 2020 2020  eturn None.     
-0001c6e0: 2020 2069 6620 6462 6964 203d 3d20 7365     if dbid == se
-0001c6f0: 6c66 2e63 6c69 656e 742e 6163 636f 756e  lf.client.accoun
-0001c700: 745f 696e 666f 2e61 6363 6f75 6e74 5f69  t_info.account_i
-0001c710: 643a 0a20 2020 2020 2020 2020 2020 2023  d:.            #
-0001c720: 2052 6574 7572 6e20 6361 6368 6564 2064   Return cached d
-0001c730: 6973 706c 6179 206e 616d 650a 2020 2020  isplay name.    
-0001c740: 2020 2020 2020 2020 7265 7475 726e 2073          return s
-0001c750: 656c 662e 636c 6965 6e74 2e61 6363 6f75  elf.client.accou
-0001c760: 6e74 5f69 6e66 6f2e 6469 7370 6c61 795f  nt_info.display_
-0001c770: 6e61 6d65 0a0a 2020 2020 2020 2020 7472  name..        tr
-0001c780: 793a 0a20 2020 2020 2020 2020 2020 2061  y:.            a
-0001c790: 6363 6f75 6e74 5f69 6e66 6f20 3d20 7365  ccount_info = se
-0001c7a0: 6c66 2e63 6c69 656e 742e 6765 745f 6163  lf.client.get_ac
-0001c7b0: 636f 756e 745f 696e 666f 2864 6269 6429  count_info(dbid)
-0001c7c0: 0a20 2020 2020 2020 2065 7863 6570 7420  .        except 
-0001c7d0: 496e 7661 6c69 6444 6269 6445 7272 6f72  InvalidDbidError
-0001c7e0: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
-0001c7f0: 7475 726e 204e 6f6e 650a 2020 2020 2020  turn None.      
-0001c800: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-0001c810: 2020 2020 7265 7475 726e 2061 6363 6f75      return accou
-0001c820: 6e74 5f69 6e66 6f2e 6469 7370 6c61 795f  nt_info.display_
-0001c830: 6e61 6d65 0a0a 2020 2020 6465 6620 5f63  name..    def _c
-0001c840: 6865 636b 5f64 6f77 6e6c 6f61 645f 636f  heck_download_co
-0001c850: 6e66 6c69 6374 2873 656c 662c 2065 7665  nflict(self, eve
-0001c860: 6e74 3a20 5379 6e63 4576 656e 7429 202d  nt: SyncEvent) -
-0001c870: 3e20 436f 6e66 6c69 6374 3a0a 2020 2020  > Conflict:.    
-0001c880: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
-0001c890: 4368 6563 6b20 6966 2061 206c 6f63 616c  Check if a local
-0001c8a0: 2069 7465 6d20 6973 2063 6f6e 666c 6963   item is conflic
-0001c8b0: 7469 6e67 2077 6974 6820 7265 6d6f 7465  ting with remote
-0001c8c0: 2063 6861 6e67 652e 2054 6865 2065 7175   change. The equ
-0001c8d0: 6976 616c 656e 7420 6368 6563 6b0a 2020  ivalent check.  
-0001c8e0: 2020 2020 2020 7768 656e 2075 706c 6f61        when uploa
-0001c8f0: 6469 6e67 2061 6e64 2061 2063 6861 6e67  ding and a chang
-0001c900: 6520 7769 6c6c 2062 6520 6361 7272 6965  e will be carrie
-0001c910: 6420 6f75 7420 6279 2044 726f 7062 6f78  d out by Dropbox
-0001c920: 2069 7473 656c 662e 0a0a 2020 2020 2020   itself...      
-0001c930: 2020 4368 6563 6b73 2061 7265 2063 6172    Checks are car
-0001c940: 7269 6564 206f 7574 2061 6761 696e 7374  ried out against
-0001c950: 206f 7572 2069 6e64 6578 2c20 7265 666c   our index, refl
-0001c960: 6563 7469 6e67 2074 6865 206c 6174 6573  ecting the lates
-0001c970: 7420 7379 6e63 2073 7461 7465 2e0a 2020  t sync state..  
-0001c980: 2020 2020 2020 5765 2063 6f6d 7061 7265        We compare
-0001c990: 2074 6865 2066 6f6c 6c6f 7769 6e67 2076   the following v
-0001c9a0: 616c 7565 733a 0a0a 2020 2020 2020 2020  alues:..        
-0001c9b0: 3129 204c 6f63 616c 2076 7320 7265 6d6f  1) Local vs remo
-0001c9c0: 7465 2072 6576 3a20 2766 6f6c 6465 7227  te rev: 'folder'
-0001c9d0: 2066 6f72 2066 6f6c 6465 7273 2c20 6163   for folders, ac
-0001c9e0: 7475 616c 2072 6576 6973 696f 6e20 666f  tual revision fo
-0001c9f0: 7220 6669 6c65 7320 616e 6420 4e6f 6e65  r files and None
-0001ca00: 0a20 2020 2020 2020 2020 2020 666f 7220  .           for 
-0001ca10: 6465 6c65 7465 6420 6f72 206e 6f74 2070  deleted or not p
-0001ca20: 7265 7365 6e74 2069 7465 6d73 2e0a 2020  resent items..  
-0001ca30: 2020 2020 2020 3229 204c 6f63 616c 2076        2) Local v
-0001ca40: 7320 7265 6d6f 7465 2063 6f6e 7465 6e74  s remote content
-0001ca50: 2068 6173 683a 2027 666f 6c64 6572 2720   hash: 'folder' 
-0001ca60: 666f 7220 666f 6c64 6572 732c 2061 6374  for folders, act
-0001ca70: 7561 6c20 6861 7368 2066 6f72 2066 696c  ual hash for fil
-0001ca80: 6573 2061 6e64 0a20 2020 2020 2020 2020  es and.         
-0001ca90: 2020 4e6f 6e65 2066 6f72 2064 656c 6574    None for delet
-0001caa0: 696f 6e73 2e0a 2020 2020 2020 2020 3329  ions..        3)
-0001cab0: 204c 6f63 616c 2063 7469 6d65 2076 7320   Local ctime vs 
-0001cac0: 6c61 7374 2073 796e 6320 7469 6d65 3a20  last sync time: 
-0001cad0: 5468 6973 2069 7320 6361 6c63 756c 6174  This is calculat
-0001cae0: 6564 2072 6563 7572 7369 7665 6c79 2066  ed recursively f
-0001caf0: 6f72 2066 6f6c 6465 7273 2e0a 0a20 2020  or folders...   
-0001cb00: 2020 2020 203a 7061 7261 6d20 6576 656e       :param even
-0001cb10: 743a 2044 6f77 6e6c 6f61 6420 5379 6e63  t: Download Sync
-0001cb20: 4576 656e 742e 0a20 2020 2020 2020 203a  Event..        :
-0001cb30: 7265 7475 726e 733a 2043 6f6e 666c 6963  returns: Conflic
-0001cb40: 7420 6368 6563 6b20 7265 7375 6c74 2e0a  t check result..
-0001cb50: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
-0001cb60: 2020 2020 6c6f 6361 6c5f 7265 7620 3d20      local_rev = 
-0001cb70: 7365 6c66 2e67 6574 5f6c 6f63 616c 5f72  self.get_local_r
-0001cb80: 6576 2865 7665 6e74 2e64 6278 5f70 6174  ev(event.dbx_pat
-0001cb90: 685f 6c6f 7765 7229 0a0a 2020 2020 2020  h_lower)..      
-0001cba0: 2020 7769 7468 2063 6f6e 7665 7274 5f61    with convert_a
-0001cbb0: 7069 5f65 7272 6f72 7328 6576 656e 742e  pi_errors(event.
-0001cbc0: 6462 785f 7061 7468 2c20 6576 656e 742e  dbx_path, event.
-0001cbd0: 6c6f 6361 6c5f 7061 7468 293a 0a20 2020  local_path):.   
-0001cbe0: 2020 2020 2020 2020 206c 6f63 616c 5f73           local_s
-0001cbf0: 796d 6c69 6e6b 5f74 6172 6765 7420 3d20  ymlink_target = 
-0001cc00: 6765 745f 7379 6d6c 696e 6b5f 7461 7267  get_symlink_targ
-0001cc10: 6574 2865 7665 6e74 2e6c 6f63 616c 5f70  et(event.local_p
-0001cc20: 6174 6829 0a0a 2020 2020 2020 2020 6966  ath)..        if
-0001cc30: 2065 7665 6e74 2e72 6576 203d 3d20 6c6f   event.rev == lo
-0001cc40: 6361 6c5f 7265 763a 0a20 2020 2020 2020  cal_rev:.       
-0001cc50: 2020 2020 2023 204c 6f63 616c 2063 6861       # Local cha
-0001cc60: 6e67 6520 6861 7320 7468 6520 7361 6d65  nge has the same
-0001cc70: 2072 6576 2e20 5468 6520 6c6f 6361 6c20   rev. The local 
-0001cc80: 6974 656d 2028 6f72 2064 656c 6574 696f  item (or deletio
-0001cc90: 6e29 206d 7573 7420 6265 206e 6577 6572  n) must be newer
-0001cca0: 0a20 2020 2020 2020 2020 2020 2023 2061  .            # a
-0001ccb0: 6e64 206e 6f74 2079 6574 2073 796e 6365  nd not yet synce
-0001ccc0: 6420 6f72 2069 6465 6e74 6963 616c 2074  d or identical t
-0001ccd0: 6f20 7468 6520 7265 6d6f 7465 2073 7461  o the remote sta
-0001cce0: 7465 2e20 446f 6e27 7420 6f76 6572 7772  te. Don't overwr
-0001ccf0: 6974 652e 0a20 2020 2020 2020 2020 2020  ite..           
-0001cd00: 2073 656c 662e 5f6c 6f67 6765 722e 6465   self._logger.de
-0001cd10: 6275 6728 0a20 2020 2020 2020 2020 2020  bug(.           
-0001cd20: 2020 2020 2027 4571 7561 6c20 7265 7673       'Equal revs
-0001cd30: 2066 6f72 2022 2573 223a 206c 6f63 616c   for "%s": local
-0001cd40: 2069 7465 6d20 6973 2074 6865 2073 616d   item is the sam
-0001cd50: 6520 6f72 206e 6577 6572 2027 0a20 2020  e or newer '.   
-0001cd60: 2020 2020 2020 2020 2020 2020 2022 7468               "th
-0001cd70: 616e 206f 6e20 4472 6f70 626f 7822 2c0a  an on Dropbox",.
-0001cd80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001cd90: 6576 656e 742e 6462 785f 7061 7468 2c0a  event.dbx_path,.
-0001cda0: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
-0001cdb0: 2020 2020 2020 2020 2020 7265 7475 726e            return
-0001cdc0: 2043 6f6e 666c 6963 742e 4c6f 6361 6c4e   Conflict.LocalN
-0001cdd0: 6577 6572 4f72 4964 656e 7469 6361 6c0a  ewerOrIdentical.
-0001cde0: 0a20 2020 2020 2020 2065 6c69 6620 280a  .        elif (.
-0001cdf0: 2020 2020 2020 2020 2020 2020 6576 656e              even
-0001ce00: 742e 636f 6e74 656e 745f 6861 7368 203d  t.content_hash =
-0001ce10: 3d20 7365 6c66 2e67 6574 5f6c 6f63 616c  = self.get_local
-0001ce20: 5f68 6173 6828 6576 656e 742e 6c6f 6361  _hash(event.loca
-0001ce30: 6c5f 7061 7468 290a 2020 2020 2020 2020  l_path).        
-0001ce40: 2020 2020 616e 6420 6576 656e 742e 7379      and event.sy
-0001ce50: 6d6c 696e 6b5f 7461 7267 6574 203d 3d20  mlink_target == 
-0001ce60: 6c6f 6361 6c5f 7379 6d6c 696e 6b5f 7461  local_symlink_ta
-0001ce70: 7267 6574 0a20 2020 2020 2020 2029 3a0a  rget.        ):.
-0001ce80: 2020 2020 2020 2020 2020 2020 2320 436f              # Co
-0001ce90: 6e74 656e 7420 6861 7368 6573 2061 7265  ntent hashes are
-0001cea0: 2065 7175 616c 2c20 7468 6572 6566 6f72   equal, therefor
-0001ceb0: 6520 6974 656d 7320 6172 6520 6964 656e  e items are iden
-0001cec0: 7469 6361 6c2e 2046 6f6c 6465 7273 2077  tical. Folders w
-0001ced0: 696c 6c0a 2020 2020 2020 2020 2020 2020  ill.            
-0001cee0: 2320 6861 7665 2061 2063 6f6e 7465 6e74  # have a content
-0001cef0: 2068 6173 6820 6f66 2027 666f 6c64 6572   hash of 'folder
-0001cf00: 272e 0a20 2020 2020 2020 2020 2020 2073  '..            s
-0001cf10: 656c 662e 5f6c 6f67 6765 722e 6465 6275  elf._logger.debu
-0001cf20: 6728 0a20 2020 2020 2020 2020 2020 2020  g(.             
-0001cf30: 2020 2027 4571 7561 6c20 636f 6e74 656e     'Equal conten
-0001cf40: 7420 6861 7368 6573 2066 6f72 2022 2573  t hashes for "%s
-0001cf50: 223a 206e 6f20 636f 6e66 6c69 6374 272c  ": no conflict',
-0001cf60: 2065 7665 6e74 2e64 6278 5f70 6174 680a   event.dbx_path.
-0001cf70: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
-0001cf80: 2020 2020 2020 2020 2020 7265 7475 726e            return
-0001cf90: 2043 6f6e 666c 6963 742e 4964 656e 7469   Conflict.Identi
-0001cfa0: 6361 6c0a 2020 2020 2020 2020 656c 6966  cal.        elif
-0001cfb0: 2028 0a20 2020 2020 2020 2020 2020 206c   (.            l
-0001cfc0: 656e 280a 2020 2020 2020 2020 2020 2020  en(.            
-0001cfd0: 2020 2020 7365 6c66 2e73 796e 635f 6572      self.sync_er
-0001cfe0: 726f 7273 5f66 6f72 5f70 6174 6828 0a20  rors_for_path(. 
-0001cff0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001d000: 2020 2065 7665 6e74 2e64 6278 5f70 6174     event.dbx_pat
-0001d010: 685f 6c6f 7765 722c 2064 6972 6563 7469  h_lower, directi
-0001d020: 6f6e 3d53 796e 6344 6972 6563 7469 6f6e  on=SyncDirection
-0001d030: 2e55 700a 2020 2020 2020 2020 2020 2020  .Up.            
-0001d040: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
-0001d050: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
-0001d060: 3e20 300a 2020 2020 2020 2020 293a 0a20  > 0.        ):. 
-0001d070: 2020 2020 2020 2020 2020 2023 204c 6f63             # Loc
-0001d080: 616c 2076 6572 7369 6f6e 2063 6f75 6c64  al version could
-0001d090: 206e 6f74 2062 6520 7570 6c6f 6164 6564   not be uploaded
-0001d0a0: 2064 7565 2074 6f20 6120 7379 6e63 2065   due to a sync e
-0001d0b0: 7272 6f72 2e20 446f 206e 6f74 0a20 2020  rror. Do not.   
-0001d0c0: 2020 2020 2020 2020 2023 206f 7665 722d           # over-
-0001d0d0: 7772 6974 6520 756e 7379 6e63 6564 2063  write unsynced c
-0001d0e0: 6861 6e67 6573 2062 7574 2064 6563 6c61  hanges but decla
-0001d0f0: 7265 2061 2063 6f6e 666c 6963 742e 0a20  re a conflict.. 
-0001d100: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-0001d110: 5f6c 6f67 6765 722e 6465 6275 6728 0a20  _logger.debug(. 
-0001d120: 2020 2020 2020 2020 2020 2020 2020 2027                 '
-0001d130: 556e 7265 736f 6c76 6564 2075 706c 6f61  Unresolved uploa
-0001d140: 6420 6572 726f 7220 666f 7220 2225 7322  d error for "%s"
-0001d150: 3a20 636f 6e66 6c69 6374 272c 2065 7665  : conflict', eve
-0001d160: 6e74 2e64 6278 5f70 6174 680a 2020 2020  nt.dbx_path.    
-0001d170: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-0001d180: 2020 2020 2020 7265 7475 726e 2043 6f6e        return Con
-0001d190: 666c 6963 742e 436f 6e66 6c69 6374 0a20  flict.Conflict. 
-0001d1a0: 2020 2020 2020 2065 6c69 6620 6e6f 7420         elif not 
-0001d1b0: 7365 6c66 2e5f 6374 696d 655f 6e65 7765  self._ctime_newe
-0001d1c0: 725f 7468 616e 5f6c 6173 745f 7379 6e63  r_than_last_sync
-0001d1d0: 2865 7665 6e74 2e6c 6f63 616c 5f70 6174  (event.local_pat
-0001d1e0: 6829 3a0a 2020 2020 2020 2020 2020 2020  h):.            
-0001d1f0: 2320 4c61 7374 2063 6861 6e67 6520 7469  # Last change ti
-0001d200: 6d65 206f 6620 6c6f 6361 6c20 6974 656d  me of local item
-0001d210: 2028 7265 6375 7273 6976 6520 666f 7220   (recursive for 
-0001d220: 666f 6c64 6572 7329 2069 7320 6f6c 6465  folders) is olde
-0001d230: 7220 7468 616e 0a20 2020 2020 2020 2020  r than.         
-0001d240: 2020 2023 2074 6865 206c 6173 7420 7469     # the last ti
-0001d250: 6d65 2074 6865 2069 7465 6d20 7761 7320  me the item was 
-0001d260: 7379 6e63 6564 2e20 5265 6d6f 7465 206d  synced. Remote m
-0001d270: 7573 7420 6265 206e 6577 6572 2e0a 2020  ust be newer..  
-0001d280: 2020 2020 2020 2020 2020 7365 6c66 2e5f            self._
-0001d290: 6c6f 6767 6572 2e64 6562 7567 280a 2020  logger.debug(.  
-0001d2a0: 2020 2020 2020 2020 2020 2020 2020 274c                'L
-0001d2b0: 6f63 616c 2069 7465 6d20 2225 7322 2068  ocal item "%s" h
-0001d2c0: 6173 206e 6f20 756e 7379 6e63 6564 2063  as no unsynced c
-0001d2d0: 6861 6e67 6573 3a20 7265 6d6f 7465 2069  hanges: remote i
-0001d2e0: 7465 6d20 6973 206e 6577 6572 272c 0a20  tem is newer',. 
-0001d2f0: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-0001d300: 7665 6e74 2e64 6278 5f70 6174 682c 0a20  vent.dbx_path,. 
-0001d310: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
-0001d320: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-0001d330: 436f 6e66 6c69 6374 2e52 656d 6f74 654e  Conflict.RemoteN
-0001d340: 6577 6572 0a20 2020 2020 2020 2065 6c69  ewer.        eli
-0001d350: 6620 6576 656e 742e 6973 5f64 656c 6574  f event.is_delet
-0001d360: 6564 3a0a 2020 2020 2020 2020 2020 2020  ed:.            
-0001d370: 2320 5265 6d6f 7465 2069 7465 6d20 7761  # Remote item wa
-0001d380: 7320 6465 6c65 7465 6420 6275 7420 6c6f  s deleted but lo
-0001d390: 6361 6c20 6974 656d 2068 6173 2062 6565  cal item has bee
-0001d3a0: 6e20 6d6f 6469 6669 6564 2073 696e 6365  n modified since
-0001d3b0: 2074 6865 6e2e 0a20 2020 2020 2020 2020   then..         
-0001d3c0: 2020 2073 656c 662e 5f6c 6f67 6765 722e     self._logger.
-0001d3d0: 6465 6275 6728 0a20 2020 2020 2020 2020  debug(.         
-0001d3e0: 2020 2020 2020 2027 4c6f 6361 6c20 6974         'Local it
-0001d3f0: 656d 2022 2573 2220 6861 7320 756e 7379  em "%s" has unsy
-0001d400: 6e63 6564 2063 6861 6e67 6573 2061 6e64  nced changes and
-0001d410: 2072 656d 6f74 6520 7761 7320 270a 2020   remote was '.  
-0001d420: 2020 2020 2020 2020 2020 2020 2020 2264                "d
-0001d430: 656c 6574 6564 3a20 6c6f 6361 6c20 6974  eleted: local it
-0001d440: 656d 2069 7320 6e65 7765 7222 2c0a 2020  em is newer",.  
-0001d450: 2020 2020 2020 2020 2020 2020 2020 6576                ev
-0001d460: 656e 742e 6462 785f 7061 7468 2c0a 2020  ent.dbx_path,.  
-0001d470: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
-0001d480: 2020 2020 2020 2020 7265 7475 726e 2043          return C
-0001d490: 6f6e 666c 6963 742e 4c6f 6361 6c4e 6577  onflict.LocalNew
-0001d4a0: 6572 4f72 4964 656e 7469 6361 6c0a 2020  erOrIdentical.  
-0001d4b0: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-0001d4c0: 2020 2020 2020 2020 2320 426f 7468 2072          # Both r
-0001d4d0: 656d 6f74 6520 616e 6420 6c6f 6361 6c20  emote and local 
-0001d4e0: 6974 656d 7320 6861 7665 2075 6e73 796e  items have unsyn
-0001d4f0: 6365 6420 6368 616e 6765 733a 2063 6f6e  ced changes: con
-0001d500: 666c 6963 742e 0a20 2020 2020 2020 2020  flict..         
-0001d510: 2020 2073 656c 662e 5f6c 6f67 6765 722e     self._logger.
-0001d520: 6465 6275 6728 0a20 2020 2020 2020 2020  debug(.         
-0001d530: 2020 2020 2020 2027 4c6f 6361 6c20 6974         'Local it
-0001d540: 656d 2022 2573 2220 6861 7320 756e 7379  em "%s" has unsy
-0001d550: 6e63 6564 206c 6f63 616c 2063 6861 6e67  nced local chang
-0001d560: 6573 3a20 636f 6e66 6c69 6374 272c 0a20  es: conflict',. 
-0001d570: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-0001d580: 7665 6e74 2e64 6278 5f70 6174 682c 0a20  vent.dbx_path,. 
-0001d590: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
-0001d5a0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-0001d5b0: 436f 6e66 6c69 6374 2e43 6f6e 666c 6963  Conflict.Conflic
-0001d5c0: 740a 0a20 2020 2064 6566 205f 6374 696d  t..    def _ctim
-0001d5d0: 655f 6e65 7765 725f 7468 616e 5f6c 6173  e_newer_than_las
-0001d5e0: 745f 7379 6e63 2873 656c 662c 206c 6f63  t_sync(self, loc
-0001d5f0: 616c 5f70 6174 683a 2073 7472 2920 2d3e  al_path: str) ->
-0001d600: 2062 6f6f 6c3a 0a20 2020 2020 2020 2022   bool:.        "
-0001d610: 2222 0a20 2020 2020 2020 2043 6865 636b  "".        Check
-0001d620: 7320 6966 2061 206c 6f63 616c 2069 7465  s if a local ite
-0001d630: 6d20 6861 7320 616e 7920 756e 7379 6e63  m has any unsync
-0001d640: 6564 2063 6861 6e67 6573 2e20 5468 6973  ed changes. This
-0001d650: 2069 7320 6279 2063 6f6d 7061 7269 6e67   is by comparing
-0001d660: 2069 7473 2063 7469 6d65 0a20 2020 2020   its ctime.     
-0001d670: 2020 2074 6f20 7468 6520 6060 6c61 7374     to the ``last
-0001d680: 5f73 796e 6360 6020 7469 6d65 2073 6176  _sync`` time sav
-0001d690: 6564 2069 6e20 6f75 7220 696e 6465 782e  ed in our index.
-0001d6a0: 2049 6e20 6361 7365 206f 6620 666f 6c64   In case of fold
-0001d6b0: 6572 732c 2077 6520 7265 6375 7273 6976  ers, we recursiv
-0001d6c0: 656c 790a 2020 2020 2020 2020 6368 6563  ely.        chec
-0001d6d0: 6b20 7468 6520 6374 696d 6520 6f66 2063  k the ctime of c
-0001d6e0: 6869 6c64 7265 6e2e 0a0a 2020 2020 2020  hildren...      
-0001d6f0: 2020 3a70 6172 616d 206c 6f63 616c 5f70    :param local_p
-0001d700: 6174 683a 204c 6f63 616c 2070 6174 6820  ath: Local path 
-0001d710: 6f66 2069 7465 6d20 746f 2063 6865 636b  of item to check
-0001d720: 2e0a 2020 2020 2020 2020 3a72 6574 7572  ..        :retur
-0001d730: 6e73 3a20 5768 6574 6865 7220 7468 6520  ns: Whether the 
-0001d740: 6c6f 6361 6c20 6974 656d 2068 6173 2075  local item has u
-0001d750: 6e73 796e 6365 6420 6368 616e 6765 732e  nsynced changes.
-0001d760: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
-0001d770: 2020 2020 2069 6620 7365 6c66 2e69 735f       if self.is_
-0001d780: 6578 636c 7564 6564 286c 6f63 616c 5f70  excluded(local_p
-0001d790: 6174 6829 3a0a 2020 2020 2020 2020 2020  ath):.          
-0001d7a0: 2020 2320 4578 636c 7564 6564 206e 616d    # Excluded nam
-0001d7b0: 6573 2073 7563 6820 6173 202e 4453 5f53  es such as .DS_S
-0001d7c0: 746f 7265 2065 7463 2e20 6e65 7665 7220  tore etc. never 
-0001d7d0: 636f 756e 7420 6173 2075 6e73 796e 6365  count as unsynce
-0001d7e0: 6420 6368 616e 6765 732e 0a20 2020 2020  d changes..     
-0001d7f0: 2020 2020 2020 2072 6574 7572 6e20 4661         return Fa
-0001d800: 6c73 650a 0a20 2020 2020 2020 2064 6278  lse..        dbx
-0001d810: 5f70 6174 685f 6c6f 7765 7220 3d20 7365  _path_lower = se
-0001d820: 6c66 2e74 6f5f 6462 785f 7061 7468 5f6c  lf.to_dbx_path_l
-0001d830: 6f77 6572 286c 6f63 616c 5f70 6174 6829  ower(local_path)
-0001d840: 0a20 2020 2020 2020 2069 6e64 6578 5f65  .        index_e
-0001d850: 6e74 7279 203d 2073 656c 662e 6765 745f  ntry = self.get_
-0001d860: 696e 6465 785f 656e 7472 7928 6462 785f  index_entry(dbx_
-0001d870: 7061 7468 5f6c 6f77 6572 290a 0a20 2020  path_lower)..   
-0001d880: 2020 2020 2077 6974 6820 636f 6e76 6572       with conver
-0001d890: 745f 6170 695f 6572 726f 7273 286c 6f63  t_api_errors(loc
-0001d8a0: 616c 5f70 6174 683d 6c6f 6361 6c5f 7061  al_path=local_pa
-0001d8b0: 7468 293a 2020 2320 4361 7463 6820 4f53  th):  # Catch OS
-0001d8c0: 4572 726f 7273 2e0a 2020 2020 2020 2020  Errors..        
-0001d8d0: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
-0001d8e0: 2020 2020 2020 2020 2073 7461 7420 3d20           stat = 
-0001d8f0: 6f73 2e6c 7374 6174 286c 6f63 616c 5f70  os.lstat(local_p
-0001d900: 6174 6829 0a20 2020 2020 2020 2020 2020  ath).           
-0001d910: 2065 7863 6570 7420 2846 696c 654e 6f74   except (FileNot
-0001d920: 466f 756e 6445 7272 6f72 2c20 4e6f 7441  FoundError, NotA
-0001d930: 4469 7265 6374 6f72 7945 7272 6f72 293a  DirectoryError):
-0001d940: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001d950: 2023 2044 6f6e 2774 2063 6865 636b 2063   # Don't check c
-0001d960: 7469 6d65 2066 6f72 2064 656c 6574 6564  time for deleted
-0001d970: 2069 7465 6d73 2028 6f73 2077 6f6e 2774   items (os won't
-0001d980: 2067 6976 6520 7374 6174 2069 6e66 6f29   give stat info)
-0001d990: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001d9a0: 2023 2062 7574 2063 6f6e 6669 726d 2061   # but confirm a
-0001d9b0: 6273 656e 6365 2066 726f 6d20 696e 6465  bsence from inde
-0001d9c0: 782e 0a20 2020 2020 2020 2020 2020 2020  x..             
-0001d9d0: 2020 2072 6574 7572 6e20 696e 6465 785f     return index_
-0001d9e0: 656e 7472 7920 6973 206e 6f74 204e 6f6e  entry is not Non
-0001d9f0: 650a 0a20 2020 2020 2020 2020 2020 2069  e..            i
-0001da00: 6620 535f 4953 4449 5228 7374 6174 2e73  f S_ISDIR(stat.s
-0001da10: 745f 6d6f 6465 293a 0a20 2020 2020 2020  t_mode):.       
-0001da20: 2020 2020 2020 2020 2023 2044 6f6e 2774           # Don't
-0001da30: 2063 6865 636b 2063 7469 6d65 2066 6f72   check ctime for
-0001da40: 2066 6f6c 6465 7273 2062 7574 2063 6f6d   folders but com
-0001da50: 7061 7265 2074 6f20 696e 6465 7820 656e  pare to index en
-0001da60: 7472 7920 7479 7065 2e0a 2020 2020 2020  try type..      
-0001da70: 2020 2020 2020 2020 2020 6966 2069 6e64            if ind
-0001da80: 6578 5f65 6e74 7279 2069 7320 4e6f 6e65  ex_entry is None
-0001da90: 206f 7220 696e 6465 785f 656e 7472 792e   or index_entry.
-0001daa0: 6973 5f66 696c 653a 0a20 2020 2020 2020  is_file:.       
-0001dab0: 2020 2020 2020 2020 2020 2020 2072 6574               ret
-0001dac0: 7572 6e20 5472 7565 0a0a 2020 2020 2020  urn True..      
-0001dad0: 2020 2020 2020 2020 2020 2320 5265 6375            # Recu
-0001dae0: 7273 6520 6f76 6572 2063 6869 6c64 7265  rse over childre
-0001daf0: 6e2e 0a20 2020 2020 2020 2020 2020 2020  n..             
-0001db00: 2020 2077 6974 6820 6f73 2e73 6361 6e64     with os.scand
-0001db10: 6972 286c 6f63 616c 5f70 6174 6829 2061  ir(local_path) a
-0001db20: 7320 6974 3a0a 2020 2020 2020 2020 2020  s it:.          
-0001db30: 2020 2020 2020 2020 2020 666f 7220 656e            for en
-0001db40: 7472 7920 696e 2069 743a 0a20 2020 2020  try in it:.     
-0001db50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001db60: 2020 2069 6620 656e 7472 792e 6973 5f64     if entry.is_d
-0001db70: 6972 2866 6f6c 6c6f 775f 7379 6d6c 696e  ir(follow_symlin
-0001db80: 6b73 3d46 616c 7365 293a 0a20 2020 2020  ks=False):.     
-0001db90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001dba0: 2020 2020 2020 2069 6620 7365 6c66 2e5f         if self._
-0001dbb0: 6374 696d 655f 6e65 7765 725f 7468 616e  ctime_newer_than
-0001dbc0: 5f6c 6173 745f 7379 6e63 2865 6e74 7279  _last_sync(entry
-0001dbd0: 2e70 6174 6829 3a0a 2020 2020 2020 2020  .path):.        
-0001dbe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001dbf0: 2020 2020 2020 2020 7265 7475 726e 2054          return T
-0001dc00: 7275 650a 2020 2020 2020 2020 2020 2020  rue.            
-0001dc10: 2020 2020 2020 2020 2020 2020 656c 6966              elif
-0001dc20: 206e 6f74 2073 656c 662e 6973 5f65 7863   not self.is_exc
-0001dc30: 6c75 6465 6428 656e 7472 792e 6e61 6d65  luded(entry.name
-0001dc40: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-0001dc50: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-0001dc60: 6869 6c64 5f64 6278 5f70 6174 685f 6c6f  hild_dbx_path_lo
-0001dc70: 7765 7220 3d20 7365 6c66 2e74 6f5f 6462  wer = self.to_db
-0001dc80: 785f 7061 7468 5f6c 6f77 6572 2865 6e74  x_path_lower(ent
-0001dc90: 7279 2e70 6174 6829 0a20 2020 2020 2020  ry.path).       
-0001dca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001dcb0: 2020 2020 2063 7469 6d65 203d 2065 6e74       ctime = ent
-0001dcc0: 7279 2e73 7461 7428 666f 6c6c 6f77 5f73  ry.stat(follow_s
-0001dcd0: 796d 6c69 6e6b 733d 4661 6c73 6529 2e73  ymlinks=False).s
-0001dce0: 745f 6374 696d 650a 2020 2020 2020 2020  t_ctime.        
-0001dcf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001dd00: 2020 2020 6966 2063 7469 6d65 203e 2073      if ctime > s
-0001dd10: 656c 662e 6765 745f 6c61 7374 5f73 796e  elf.get_last_syn
-0001dd20: 6328 6368 696c 645f 6462 785f 7061 7468  c(child_dbx_path
-0001dd30: 5f6c 6f77 6572 293a 0a20 2020 2020 2020  _lower):.       
-0001dd40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001dd50: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-0001dd60: 5472 7565 0a0a 2020 2020 2020 2020 2020  True..          
-0001dd70: 2020 2020 2020 7265 7475 726e 2046 616c        return Fal
-0001dd80: 7365 0a0a 2020 2020 2020 2020 2020 2020  se..            
-0001dd90: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-0001dda0: 2020 2020 2020 2320 4368 6563 6b20 6f75        # Check ou
-0001ddb0: 7220 6374 696d 6520 6167 6169 6e73 7420  r ctime against 
-0001ddc0: 696e 6465 782e 0a20 2020 2020 2020 2020  index..         
-0001ddd0: 2020 2020 2020 2072 6574 7572 6e20 7374         return st
-0001dde0: 6174 2e73 745f 6374 696d 6520 3e20 7365  at.st_ctime > se
-0001ddf0: 6c66 2e67 6574 5f6c 6173 745f 7379 6e63  lf.get_last_sync
-0001de00: 2864 6278 5f70 6174 685f 6c6f 7765 7229  (dbx_path_lower)
-0001de10: 0a0a 2020 2020 6465 6620 5f67 6574 5f63  ..    def _get_c
-0001de20: 7469 6d65 2873 656c 662c 206c 6f63 616c  time(self, local
-0001de30: 5f70 6174 683a 2073 7472 2920 2d3e 2066  _path: str) -> f
-0001de40: 6c6f 6174 3a0a 2020 2020 2020 2020 2222  loat:.        ""
-0001de50: 220a 2020 2020 2020 2020 5265 7475 726e  ".        Return
-0001de60: 7320 7468 6520 6374 696d 6520 6f66 2061  s the ctime of a
-0001de70: 206c 6f63 616c 2069 7465 6d20 6f72 202d   local item or -
-0001de80: 312e 3020 6966 2074 6865 7265 2069 7320  1.0 if there is 
-0001de90: 6e6f 7468 696e 6720 6174 2074 6865 2070  nothing at the p
-0001dea0: 6174 682e 2049 660a 2020 2020 2020 2020  ath. If.        
-0001deb0: 7468 6520 6974 656d 2069 7320 6120 6469  the item is a di
-0001dec0: 7265 6374 6f72 792c 2072 6574 7572 6e20  rectory, return 
-0001ded0: 7468 6520 6c61 7267 6573 7420 6374 696d  the largest ctim
-0001dee0: 6520 6f66 2069 7420 616e 6420 6974 7320  e of it and its 
-0001def0: 6368 696c 6472 656e 2e20 4974 656d 730a  children. Items.
-0001df00: 2020 2020 2020 2020 7768 6963 6820 6172          which ar
-0001df10: 6520 6578 636c 7564 6564 2066 726f 6d20  e excluded from 
-0001df20: 7379 6e63 696e 6720 2865 2e67 2e2c 202e  syncing (e.g., .
-0001df30: 4453 5f53 746f 7265 2066 696c 6573 2920  DS_Store files) 
-0001df40: 6172 6520 6967 6e6f 7265 642e 0a0a 2020  are ignored...  
-0001df50: 2020 2020 2020 3a70 6172 616d 206c 6f63        :param loc
-0001df60: 616c 5f70 6174 683a 2041 6273 6f6c 7574  al_path: Absolut
-0001df70: 6520 7061 7468 206f 6e20 6c6f 6361 6c20  e path on local 
-0001df80: 6472 6976 652e 0a20 2020 2020 2020 203a  drive..        :
-0001df90: 7265 7475 726e 733a 2043 7469 6d65 206f  returns: Ctime o
-0001dfa0: 7220 2d31 2e30 2e0a 2020 2020 2020 2020  r -1.0..        
-0001dfb0: 2222 220a 2020 2020 2020 2020 7472 793a  """.        try:
-0001dfc0: 0a20 2020 2020 2020 2020 2020 2073 7461  .            sta
-0001dfd0: 7420 3d20 6f73 2e6c 7374 6174 286c 6f63  t = os.lstat(loc
-0001dfe0: 616c 5f70 6174 6829 0a20 2020 2020 2020  al_path).       
-0001dff0: 2020 2020 2069 6620 535f 4953 4449 5228       if S_ISDIR(
-0001e000: 7374 6174 2e73 745f 6d6f 6465 293a 0a20  stat.st_mode):. 
-0001e010: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-0001e020: 7469 6d65 203d 2073 7461 742e 7374 5f63  time = stat.st_c
-0001e030: 7469 6d65 0a20 2020 2020 2020 2020 2020  time.           
-0001e040: 2020 2020 2077 6974 6820 6f73 2e73 6361       with os.sca
-0001e050: 6e64 6972 286c 6f63 616c 5f70 6174 6829  ndir(local_path)
-0001e060: 2061 7320 6974 3a0a 2020 2020 2020 2020   as it:.        
-0001e070: 2020 2020 2020 2020 2020 2020 666f 7220              for 
-0001e080: 656e 7472 7920 696e 2069 743a 0a20 2020  entry in it:.   
-0001e090: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e0a0: 2020 2020 2069 6620 656e 7472 792e 6973       if entry.is
-0001e0b0: 5f64 6972 2866 6f6c 6c6f 775f 7379 6d6c  _dir(follow_syml
-0001e0c0: 696e 6b73 3d46 616c 7365 293a 0a20 2020  inks=False):.   
-0001e0d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e0e0: 2020 2020 2020 2020 2063 6869 6c64 5f63           child_c
-0001e0f0: 7469 6d65 203d 2073 656c 662e 5f67 6574  time = self._get
-0001e100: 5f63 7469 6d65 2865 6e74 7279 2e70 6174  _ctime(entry.pat
-0001e110: 6829 0a20 2020 2020 2020 2020 2020 2020  h).             
-0001e120: 2020 2020 2020 2020 2020 2065 6c69 6620             elif 
-0001e130: 6e6f 7420 7365 6c66 2e69 735f 6578 636c  not self.is_excl
-0001e140: 7564 6564 2865 6e74 7279 2e6e 616d 6529  uded(entry.name)
-0001e150: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0001e160: 2020 2020 2020 2020 2020 2020 2020 6368                ch
-0001e170: 696c 645f 6374 696d 6520 3d20 656e 7472  ild_ctime = entr
-0001e180: 792e 7374 6174 2866 6f6c 6c6f 775f 7379  y.stat(follow_sy
-0001e190: 6d6c 696e 6b73 3d46 616c 7365 292e 7374  mlinks=False).st
-0001e1a0: 5f63 7469 6d65 0a20 2020 2020 2020 2020  _ctime.         
-0001e1b0: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-0001e1c0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-0001e1d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e1e0: 2063 6869 6c64 5f63 7469 6d65 203d 202d   child_ctime = -
-0001e1f0: 312e 300a 0a20 2020 2020 2020 2020 2020  1.0..           
-0001e200: 2020 2020 2020 2020 2020 2020 2063 7469               cti
-0001e210: 6d65 203d 206d 6178 2863 7469 6d65 2c20  me = max(ctime, 
-0001e220: 6368 696c 645f 6374 696d 6529 0a0a 2020  child_ctime)..  
-0001e230: 2020 2020 2020 2020 2020 2020 2020 7265                re
-0001e240: 7475 726e 2063 7469 6d65 0a20 2020 2020  turn ctime.     
-0001e250: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-0001e260: 2020 2020 2020 2020 2020 2020 2072 6574               ret
-0001e270: 7572 6e20 7374 6174 2e73 745f 6374 696d  urn stat.st_ctim
-0001e280: 650a 2020 2020 2020 2020 6578 6365 7074  e.        except
-0001e290: 2028 4669 6c65 4e6f 7446 6f75 6e64 4572   (FileNotFoundEr
-0001e2a0: 726f 722c 204e 6f74 4144 6972 6563 746f  ror, NotADirecto
-0001e2b0: 7279 4572 726f 7229 3a0a 2020 2020 2020  ryError):.      
-0001e2c0: 2020 2020 2020 7265 7475 726e 202d 312e        return -1.
-0001e2d0: 300a 2020 2020 2020 2020 6578 6365 7074  0.        except
-0001e2e0: 204f 5345 7272 6f72 2061 7320 6578 633a   OSError as exc:
-0001e2f0: 0a20 2020 2020 2020 2020 2020 2072 6169  .            rai
-0001e300: 7365 206f 735f 746f 5f6d 6165 7374 7261  se os_to_maestra
-0001e310: 6c5f 6572 726f 7228 6578 632c 206c 6f63  l_error(exc, loc
-0001e320: 616c 5f70 6174 683d 6c6f 6361 6c5f 7061  al_path=local_pa
-0001e330: 7468 290a 0a20 2020 2064 6566 205f 636c  th)..    def _cl
-0001e340: 6561 6e5f 7265 6d6f 7465 5f63 6861 6e67  ean_remote_chang
-0001e350: 6573 2873 656c 662c 2063 6861 6e67 6573  es(self, changes
-0001e360: 3a20 4c69 7374 466f 6c64 6572 5265 7375  : ListFolderResu
-0001e370: 6c74 2920 2d3e 204c 6973 7446 6f6c 6465  lt) -> ListFolde
-0001e380: 7252 6573 756c 743a 0a20 2020 2020 2020  rResult:.       
-0001e390: 2022 2222 0a20 2020 2020 2020 2054 616b   """.        Tak
-0001e3a0: 6573 2072 656d 6f74 6520 6669 6c65 2065  es remote file e
-0001e3b0: 7665 6e74 7320 7369 6e63 6520 6c61 7374  vents since last
-0001e3c0: 2073 796e 6320 616e 6420 636c 6561 6e73   sync and cleans
-0001e3d0: 2074 6865 6d20 7570 2073 6f20 7468 6174   them up so that
-0001e3e0: 2074 6865 7265 2069 730a 2020 2020 2020   there is.      
-0001e3f0: 2020 6f6e 6c79 2061 2073 696e 676c 6520    only a single 
-0001e400: 6576 656e 7420 7065 7220 7061 7468 2e0a  event per path..
-0001e410: 0a20 2020 2020 2020 2044 726f 7062 6f78  .        Dropbox
-0001e420: 2077 696c 6c20 736f 6d65 7469 6d65 7320   will sometimes 
-0001e430: 7265 706f 7274 206d 756c 7469 706c 6520  report multiple 
-0001e440: 6368 616e 6765 7320 7065 7220 7061 7468  changes per path
-0001e450: 2e20 4f6e 6365 2073 7563 6820 696e 7374  . Once such inst
-0001e460: 616e 6365 2069 730a 2020 2020 2020 2020  ance is.        
-0001e470: 7768 656e 2073 6861 7269 6e67 2061 2066  when sharing a f
-0001e480: 6f6c 6465 723a 2060 6066 696c 6573 2f6c  older: ``files/l
-0001e490: 6973 745f 666f 6c64 6572 2f63 6f6e 7469  ist_folder/conti
-0001e4a0: 6e75 6560 6020 7769 6c6c 2072 6570 6f72  nue`` will repor
-0001e4b0: 7420 7468 6520 7368 6172 6564 0a20 2020  t the shared.   
-0001e4c0: 2020 2020 2066 6f6c 6465 7220 616e 6420       folder and 
-0001e4d0: 6974 7320 6368 696c 6472 656e 2061 7320  its children as 
-0001e4e0: 6465 6c65 7465 6420 616e 6420 7468 656e  deleted and then
-0001e4f0: 2063 7265 6174 6564 2062 6563 6175 7365   created because
-0001e500: 2074 6865 2066 6f6c 6465 7220 2a69 732a   the folder *is*
-0001e510: 0a20 2020 2020 2020 2061 6374 7561 6c6c  .        actuall
-0001e520: 7920 6465 6c65 7465 6420 6672 6f6d 2074  y deleted from t
-0001e530: 6865 2075 7365 7227 7320 4472 6f70 626f  he user's Dropbo
-0001e540: 7820 616e 6420 7265 6372 6561 7465 6420  x and recreated 
-0001e550: 6173 2061 2073 6861 7265 6420 666f 6c64  as a shared fold
-0001e560: 6572 2077 6869 6368 0a20 2020 2020 2020  er which.       
-0001e570: 2074 6865 6e20 6765 7473 206d 6f75 6e74   then gets mount
-0001e580: 6564 2074 6f20 7468 6520 7573 6572 2773  ed to the user's
-0001e590: 2044 726f 7062 6f78 2e20 4964 6561 6c6c   Dropbox. Ideall
-0001e5a0: 792c 2077 6520 7761 6e74 2074 6f20 6465  y, we want to de
-0001e5b0: 616c 2077 6974 6820 7468 6973 0a20 2020  al with this.   
-0001e5c0: 2020 2020 2077 6974 686f 7574 2072 652d       without re-
-0001e5d0: 646f 776e 6c6f 6164 696e 6720 616c 6c20  downloading all 
-0001e5e0: 6974 7320 636f 6e74 656e 7473 2e0a 0a20  its contents... 
-0001e5f0: 2020 2020 2020 203a 7061 7261 6d20 6368         :param ch
-0001e600: 616e 6765 733a 2052 6573 756c 7420 6672  anges: Result fr
-0001e610: 6f6d 2044 726f 7062 6f78 2041 5049 2063  om Dropbox API c
-0001e620: 616c 6c20 746f 2072 6574 7269 6576 6520  all to retrieve 
-0001e630: 7265 6d6f 7465 2063 6861 6e67 6573 2e0a  remote changes..
-0001e640: 2020 2020 2020 2020 3a72 6574 7572 6e73          :returns
-0001e650: 3a20 436c 6561 6e65 6420 7570 2063 6861  : Cleaned up cha
-0001e660: 6e67 6573 2077 6974 6820 6120 7369 6e67  nges with a sing
-0001e670: 6c65 204d 6574 6164 6174 6120 656e 7472  le Metadata entr
-0001e680: 7920 7065 7220 7061 7468 2e0a 2020 2020  y per path..    
-0001e690: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
-0001e6a0: 2320 4e6f 7465 3a20 7765 2077 6f6e 2774  # Note: we won't
-0001e6b0: 2068 6176 6520 746f 2064 6561 6c20 7769   have to deal wi
-0001e6c0: 7468 206d 6f64 6966 6965 6420 6f72 206d  th modified or m
-0001e6d0: 6f76 6564 2065 7665 6e74 732c 0a20 2020  oved events,.   
-0001e6e0: 2020 2020 2023 2044 726f 7062 6f78 206f       # Dropbox o
-0001e6f0: 6e6c 7920 7265 706f 7274 7320 4465 6c65  nly reports Dele
-0001e700: 7465 644d 6574 6164 6174 6120 6f72 2046  tedMetadata or F
-0001e710: 696c 654d 6574 6164 6174 6120 2f20 466f  ileMetadata / Fo
-0001e720: 6c64 6572 4d65 7461 6461 7461 0a20 2020  lderMetadata.   
-0001e730: 2020 2020 2068 6973 746f 7269 6573 3a20       histories: 
-0001e740: 6465 6661 756c 7464 6963 745b 7374 722c  defaultdict[str,
-0001e750: 206c 6973 745b 4d65 7461 6461 7461 5d5d   list[Metadata]]
-0001e760: 203d 2064 6566 6175 6c74 6469 6374 286c   = defaultdict(l
-0001e770: 6973 7429 0a0a 2020 2020 2020 2020 666f  ist)..        fo
-0001e780: 7220 656e 7472 7920 696e 2063 6861 6e67  r entry in chang
-0001e790: 6573 2e65 6e74 7269 6573 3a0a 2020 2020  es.entries:.    
-0001e7a0: 2020 2020 2020 2020 6869 7374 6f72 6965          historie
-0001e7b0: 735b 656e 7472 792e 7061 7468 5f6c 6f77  s[entry.path_low
-0001e7c0: 6572 5d2e 6170 7065 6e64 2865 6e74 7279  er].append(entry
-0001e7d0: 290a 0a20 2020 2020 2020 206e 6577 5f65  )..        new_e
-0001e7e0: 6e74 7269 6573 203d 205b 5d0a 0a20 2020  ntries = []..   
-0001e7f0: 2020 2020 2066 6f72 2068 2069 6e20 6869       for h in hi
-0001e800: 7374 6f72 6965 732e 7661 6c75 6573 2829  stories.values()
-0001e810: 3a0a 2020 2020 2020 2020 2020 2020 6966  :.            if
-0001e820: 206c 656e 2868 2920 3d3d 2031 3a0a 2020   len(h) == 1:.  
-0001e830: 2020 2020 2020 2020 2020 2020 2020 6e65                ne
-0001e840: 775f 656e 7472 6965 732e 6578 7465 6e64  w_entries.extend
-0001e850: 2868 290a 2020 2020 2020 2020 2020 2020  (h).            
-0001e860: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-0001e870: 2020 2020 2020 6c61 7374 5f65 7665 6e74        last_event
-0001e880: 203d 2068 5b2d 315d 0a20 2020 2020 2020   = h[-1].       
-0001e890: 2020 2020 2020 2020 206c 6f63 616c 5f65           local_e
-0001e8a0: 6e74 7279 203d 2073 656c 662e 6765 745f  ntry = self.get_
-0001e8b0: 696e 6465 785f 656e 7472 7928 6c61 7374  index_entry(last
-0001e8c0: 5f65 7665 6e74 2e70 6174 685f 6c6f 7765  _event.path_lowe
-0001e8d0: 7229 0a20 2020 2020 2020 2020 2020 2020  r).             
-0001e8e0: 2020 2077 6173 5f64 6972 203d 206c 6f63     was_dir = loc
-0001e8f0: 616c 5f65 6e74 7279 2061 6e64 206c 6f63  al_entry and loc
-0001e900: 616c 5f65 6e74 7279 2e69 735f 6469 7265  al_entry.is_dire
-0001e910: 6374 6f72 790a 0a20 2020 2020 2020 2020  ctory..         
-0001e920: 2020 2020 2020 2023 2044 726f 7062 6f78         # Dropbox
-0001e930: 2067 7561 7261 6e74 6565 7320 7468 6174   guarantees that
-0001e940: 2061 7070 6c79 696e 6720 6576 656e 7473   applying events
-0001e950: 2069 6e20 7468 6520 7072 6f76 6964 6564   in the provided
-0001e960: 206f 7264 6572 2077 696c 6c0a 2020 2020   order will.    
-0001e970: 2020 2020 2020 2020 2020 2020 2320 7265              # re
-0001e980: 7072 6f64 7563 6520 7468 6520 7374 6174  produce the stat
-0001e990: 6520 696e 2074 6865 2063 6c6f 7564 2e20  e in the cloud. 
-0001e9a0: 5765 2074 6865 7265 666f 7265 206b 6565  We therefore kee
-0001e9b0: 7020 6f6e 6c79 2074 6865 206c 6173 740a  p only the last.
-0001e9c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e9d0: 2320 6576 656e 742c 2075 6e6c 6573 7320  # event, unless 
-0001e9e0: 7468 6572 6520 6973 2061 2063 6861 6e67  there is a chang
-0001e9f0: 6520 696e 2069 7465 6d20 7479 7065 2e0a  e in item type..
-0001ea00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ea10: 6966 2028 0a20 2020 2020 2020 2020 2020  if (.           
-0001ea20: 2020 2020 2020 2020 2077 6173 5f64 6972           was_dir
-0001ea30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001ea40: 2020 2020 2061 6e64 2069 7369 6e73 7461       and isinsta
-0001ea50: 6e63 6528 6c61 7374 5f65 7665 6e74 2c20  nce(last_event, 
-0001ea60: 4669 6c65 4d65 7461 6461 7461 290a 2020  FileMetadata).  
-0001ea70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ea80: 2020 6f72 206e 6f74 2077 6173 5f64 6972    or not was_dir
-0001ea90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001eaa0: 2020 2020 2061 6e64 2069 7369 6e73 7461       and isinsta
-0001eab0: 6e63 6528 6c61 7374 5f65 7665 6e74 2c20  nce(last_event, 
-0001eac0: 466f 6c64 6572 4d65 7461 6461 7461 290a  FolderMetadata).
-0001ead0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001eae0: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-0001eaf0: 2020 2020 2020 2064 656c 6574 6564 5f65         deleted_e
-0001eb00: 7665 6e74 203d 2044 656c 6574 6564 4d65  vent = DeletedMe
-0001eb10: 7461 6461 7461 280a 2020 2020 2020 2020  tadata(.        
-0001eb20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001eb30: 6e61 6d65 3d6c 6173 745f 6576 656e 742e  name=last_event.
-0001eb40: 6e61 6d65 2c0a 2020 2020 2020 2020 2020  name,.          
-0001eb50: 2020 2020 2020 2020 2020 2020 2020 7061                pa
-0001eb60: 7468 5f6c 6f77 6572 3d6c 6173 745f 6576  th_lower=last_ev
-0001eb70: 656e 742e 7061 7468 5f6c 6f77 6572 2c0a  ent.path_lower,.
-0001eb80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001eb90: 2020 2020 2020 2020 7061 7468 5f64 6973          path_dis
-0001eba0: 706c 6179 3d6c 6173 745f 6576 656e 742e  play=last_event.
-0001ebb0: 7061 7468 5f64 6973 706c 6179 2c0a 2020  path_display,.  
-0001ebc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ebd0: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
-0001ebe0: 2020 2020 2020 2020 6e65 775f 656e 7472          new_entr
-0001ebf0: 6965 732e 6170 7065 6e64 2864 656c 6574  ies.append(delet
-0001ec00: 6564 5f65 7665 6e74 290a 2020 2020 2020  ed_event).      
-0001ec10: 2020 2020 2020 2020 2020 2020 2020 6e65                ne
-0001ec20: 775f 656e 7472 6965 732e 6170 7065 6e64  w_entries.append
-0001ec30: 286c 6173 745f 6576 656e 7429 0a20 2020  (last_event).   
-0001ec40: 2020 2020 2020 2020 2020 2020 2065 6c73               els
-0001ec50: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-0001ec60: 2020 2020 2020 206e 6577 5f65 6e74 7269         new_entri
-0001ec70: 6573 2e61 7070 656e 6428 6c61 7374 5f65  es.append(last_e
-0001ec80: 7665 6e74 290a 0a20 2020 2020 2020 2063  vent)..        c
-0001ec90: 6861 6e67 6573 2e65 6e74 7269 6573 203d  hanges.entries =
-0001eca0: 206e 6577 5f65 6e74 7269 6573 0a0a 2020   new_entries..  
-0001ecb0: 2020 2020 2020 7265 7475 726e 2063 6861        return cha
-0001ecc0: 6e67 6573 0a0a 2020 2020 6465 6620 5f63  nges..    def _c
-0001ecd0: 7265 6174 655f 6c6f 6361 6c5f 656e 7472  reate_local_entr
-0001ece0: 7928 7365 6c66 2c20 6576 656e 743a 2053  y(self, event: S
-0001ecf0: 796e 6345 7665 6e74 2920 2d3e 2053 796e  yncEvent) -> Syn
-0001ed00: 6345 7665 6e74 3a0a 2020 2020 2020 2020  cEvent:.        
-0001ed10: 2222 220a 2020 2020 2020 2020 4170 706c  """.        Appl
-0001ed20: 6965 7320 6120 6669 6c65 202f 2066 6f6c  ies a file / fol
-0001ed30: 6465 7220 6368 616e 6765 2066 726f 6d20  der change from 
-0001ed40: 4472 6f70 626f 7820 7365 7276 6572 7320  Dropbox servers 
-0001ed50: 746f 2074 6865 206c 6f63 616c 2044 726f  to the local Dro
-0001ed60: 7062 6f78 2066 6f6c 6465 722e 0a20 2020  pbox folder..   
-0001ed70: 2020 2020 2041 6e79 203a 6578 633a 606d       Any :exc:`m
-0001ed80: 6165 7374 7261 6c2e 6578 6365 7074 696f  aestral.exceptio
-0001ed90: 6e2e 4d61 6573 7472 616c 4170 6945 7272  n.MaestralApiErr
-0001eda0: 6f72 6020 7769 6c6c 2062 6520 6361 7567  or` will be caug
-0001edb0: 6874 2061 6e64 206c 6f67 6765 6420 6173  ht and logged as
-0001edc0: 0a20 2020 2020 2020 2061 7070 726f 7072  .        appropr
-0001edd0: 6961 7465 2e20 456e 7472 6965 7320 696e  iate. Entries in
-0001ede0: 2074 6865 206c 6f63 616c 2069 6e64 6578   the local index
-0001edf0: 2061 7265 2063 7265 6174 6564 2061 6674   are created aft
-0001ee00: 6572 2073 7563 6365 7373 6675 6c20 636f  er successful co
-0001ee10: 6d70 6c65 7469 6f6e 2e0a 0a20 2020 2020  mpletion...     
-0001ee20: 2020 203a 7061 7261 6d20 6576 656e 743a     :param event:
-0001ee30: 2044 726f 7062 6f78 206d 6574 6164 6174   Dropbox metadat
-0001ee40: 612e 0a20 2020 2020 2020 203a 7265 7475  a..        :retu
-0001ee50: 726e 733a 2043 6f70 7920 6f66 2074 6865  rns: Copy of the
-0001ee60: 2044 726f 7062 6f78 206d 6574 6164 6174   Dropbox metadat
-0001ee70: 6120 6966 2074 6865 2063 6861 6e67 6520  a if the change 
-0001ee80: 7761 7320 6170 706c 6965 6420 7375 6363  was applied succ
-0001ee90: 6573 7366 756c 6c79 2c0a 2020 2020 2020  essfully,.      
-0001eea0: 2020 2020 2020 6060 5472 7565 6060 2069        ``True`` i
-0001eeb0: 6620 7468 6520 6368 616e 6765 2061 6c72  f the change alr
-0001eec0: 6561 6479 2065 7869 7374 6564 2c20 6060  eady existed, ``
-0001eed0: 4661 6c73 6560 6020 696e 2063 6173 6520  False`` in case 
-0001eee0: 6f66 2061 2073 796e 6320 6572 726f 720a  of a sync error.
-0001eef0: 2020 2020 2020 2020 2020 2020 616e 6420              and 
-0001ef00: 6060 4e6f 6e65 6060 2069 6620 6361 6e63  ``None`` if canc
-0001ef10: 656c 6c65 642e 0a20 2020 2020 2020 2022  elled..        "
-0001ef20: 2222 0a20 2020 2020 2020 2069 6620 7365  "".        if se
-0001ef30: 6c66 2e5f 6361 6e63 656c 5f72 6571 7565  lf._cancel_reque
-0001ef40: 7374 6564 2e69 735f 7365 7428 293a 0a20  sted.is_set():. 
-0001ef50: 2020 2020 2020 2020 2020 2072 6169 7365             raise
-0001ef60: 2043 616e 6365 6c6c 6564 4572 726f 7228   CancelledError(
-0001ef70: 2253 796e 6320 6361 6e63 656c 6c65 6422  "Sync cancelled"
-0001ef80: 290a 0a20 2020 2020 2020 2073 656c 662e  )..        self.
-0001ef90: 5f73 6c6f 775f 646f 776e 2829 0a0a 2020  _slow_down()..  
-0001efa0: 2020 2020 2020 6576 656e 742e 7374 6174        event.stat
-0001efb0: 7573 203d 2053 796e 6353 7461 7475 732e  us = SyncStatus.
-0001efc0: 5379 6e63 696e 670a 0a20 2020 2020 2020  Syncing..       
-0001efd0: 2074 7279 3a0a 2020 2020 2020 2020 2020   try:.          
-0001efe0: 2020 6966 2065 7665 6e74 2e69 735f 6465    if event.is_de
-0001eff0: 6c65 7465 643a 0a20 2020 2020 2020 2020  leted:.         
-0001f000: 2020 2020 2020 2073 7461 7475 7320 3d20         status = 
-0001f010: 7365 6c66 2e5f 6f6e 5f72 656d 6f74 655f  self._on_remote_
-0001f020: 6465 6c65 7465 6428 6576 656e 7429 0a20  deleted(event). 
-0001f030: 2020 2020 2020 2020 2020 2065 6c69 6620             elif 
-0001f040: 6576 656e 742e 6973 5f66 696c 653a 0a20  event.is_file:. 
-0001f050: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-0001f060: 7461 7475 7320 3d20 7365 6c66 2e5f 6f6e  tatus = self._on
-0001f070: 5f72 656d 6f74 655f 6669 6c65 2865 7665  _remote_file(eve
-0001f080: 6e74 290a 2020 2020 2020 2020 2020 2020  nt).            
-0001f090: 656c 6966 2065 7665 6e74 2e69 735f 6469  elif event.is_di
-0001f0a0: 7265 6374 6f72 793a 0a20 2020 2020 2020  rectory:.       
-0001f0b0: 2020 2020 2020 2020 2073 7461 7475 7320           status 
-0001f0c0: 3d20 7365 6c66 2e5f 6f6e 5f72 656d 6f74  = self._on_remot
-0001f0d0: 655f 666f 6c64 6572 2865 7665 6e74 290a  e_folder(event).
-0001f0e0: 2020 2020 2020 2020 2020 2020 656c 7365              else
-0001f0f0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0001f100: 2020 7374 6174 7573 203d 2053 796e 6353    status = SyncS
-0001f110: 7461 7475 732e 536b 6970 7065 640a 0a20  tatus.Skipped.. 
-0001f120: 2020 2020 2020 2020 2020 2065 7665 6e74             event
-0001f130: 2e73 7461 7475 7320 3d20 7374 6174 7573  .status = status
-0001f140: 0a0a 2020 2020 2020 2020 6578 6365 7074  ..        except
-0001f150: 2053 796e 6345 7272 6f72 2061 7320 653a   SyncError as e:
-0001f160: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-0001f170: 662e 5f68 616e 646c 655f 7379 6e63 5f65  f._handle_sync_e
-0001f180: 7272 6f72 2865 2c20 6469 7265 6374 696f  rror(e, directio
-0001f190: 6e3d 5379 6e63 4469 7265 6374 696f 6e2e  n=SyncDirection.
-0001f1a0: 446f 776e 290a 2020 2020 2020 2020 2020  Down).          
-0001f1b0: 2020 6576 656e 742e 7374 6174 7573 203d    event.status =
-0001f1c0: 2053 796e 6353 7461 7475 732e 4661 696c   SyncStatus.Fail
-0001f1d0: 6564 0a20 2020 2020 2020 2065 6c73 653a  ed.        else:
-0001f1e0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-0001f1f0: 662e 636c 6561 725f 7379 6e63 5f65 7272  f.clear_sync_err
-0001f200: 6f72 735f 6672 6f6d 5f65 7665 6e74 2865  ors_from_event(e
-0001f210: 7665 6e74 290a 2020 2020 2020 2020 2020  vent).          
-0001f220: 2020 7365 6c66 2e61 6374 6976 6974 792e    self.activity.
-0001f230: 6469 7363 6172 6428 6576 656e 7429 0a0a  discard(event)..
-0001f240: 2020 2020 2020 2020 2320 4164 6420 6576          # Add ev
-0001f250: 656e 7473 2074 6f20 6869 7374 6f72 7920  ents to history 
-0001f260: 6461 7461 6261 7365 2e0a 2020 2020 2020  database..      
-0001f270: 2020 6966 2065 7665 6e74 2e73 7461 7475    if event.statu
-0001f280: 7320 3d3d 2053 796e 6353 7461 7475 732e  s == SyncStatus.
-0001f290: 446f 6e65 3a0a 2020 2020 2020 2020 2020  Done:.          
-0001f2a0: 2020 7769 7468 2073 656c 662e 5f64 6174    with self._dat
-0001f2b0: 6162 6173 655f 6163 6365 7373 2829 3a0a  abase_access():.
-0001f2c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f2d0: 7365 6c66 2e5f 6869 7374 6f72 795f 7461  self._history_ta
-0001f2e0: 626c 652e 7361 7665 2865 7665 6e74 290a  ble.save(event).
-0001f2f0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-0001f300: 6576 656e 740a 0a20 2020 2064 6566 205f  event..    def _
-0001f310: 656e 7375 7265 5f70 6172 656e 7428 7365  ensure_parent(se
-0001f320: 6c66 2c20 6576 656e 743a 2053 796e 6345  lf, event: SyncE
-0001f330: 7665 6e74 2920 2d3e 204e 6f6e 653a 0a20  vent) -> None:. 
-0001f340: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
-0001f350: 2020 2045 6e73 7572 6573 2074 6861 7420     Ensures that 
-0001f360: 616c 6c20 7061 7265 6e74 2066 6f6c 6465  all parent folde
-0001f370: 7273 2066 6f72 2061 2073 796e 6320 6576  rs for a sync ev
-0001f380: 656e 7420 6578 6973 7420 6c6f 6361 6c6c  ent exist locall
-0001f390: 792e 2054 6869 7320 6973 2075 7365 6420  y. This is used 
-0001f3a0: 746f 0a20 2020 2020 2020 2070 7265 7665  to.        preve
-0001f3b0: 6e74 2063 6869 6c64 7265 6e20 6672 6f6d  nt children from
-0001f3c0: 2062 6569 6e67 2064 6f77 6e6c 6f61 6465   being downloade
-0001f3d0: 6420 6265 666f 7265 2074 6865 6972 2070  d before their p
-0001f3e0: 6172 656e 7473 2e20 496e 2074 6865 206d  arents. In the m
-0001f3f0: 6f73 7420 6361 7365 732c 0a20 2020 2020  ost cases,.     
-0001f400: 2020 2077 6520 7769 6c6c 2061 7574 6f6d     we will autom
-0001f410: 6174 6963 616c 6c79 2073 796e 6320 7061  atically sync pa
-0001f420: 7265 6e74 7320 6265 666f 7265 2074 6865  rents before the
-0001f430: 6972 2063 6869 6c64 7265 6e20 6275 7420  ir children but 
-0001f440: 7468 6973 2069 7320 6e6f 7420 616c 7761  this is not alwa
-0001f450: 7973 0a20 2020 2020 2020 2067 7561 7261  ys.        guara
-0001f460: 6e74 6565 642e 2053 6565 2068 7474 7073  nteed. See https
-0001f470: 3a2f 2f67 6974 6875 622e 636f 6d2f 5361  ://github.com/Sa
-0001f480: 6d53 6368 6f74 742f 6d61 6573 7472 616c  mSchott/maestral
-0001f490: 2f69 7373 7565 732f 3435 322e 0a0a 2020  /issues/452...  
-0001f4a0: 2020 2020 2020 3a70 6172 616d 2065 7665        :param eve
-0001f4b0: 6e74 3a20 5379 6e63 4576 656e 7420 666f  nt: SyncEvent fo
-0001f4c0: 7220 7461 7267 6574 2066 696c 652e 0a20  r target file.. 
-0001f4d0: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
-0001f4e0: 2020 2064 6278 5f70 6174 685f 6c6f 7765     dbx_path_lowe
-0001f4f0: 725f 6469 726e 616d 6520 3d20 6f73 702e  r_dirname = osp.
-0001f500: 6469 726e 616d 6528 6576 656e 742e 6462  dirname(event.db
-0001f510: 785f 7061 7468 5f6c 6f77 6572 290a 0a20  x_path_lower).. 
-0001f520: 2020 2020 2020 2069 6620 6462 785f 7061         if dbx_pa
-0001f530: 7468 5f6c 6f77 6572 5f64 6972 6e61 6d65  th_lower_dirname
-0001f540: 203d 3d20 222f 223a 0a20 2020 2020 2020   == "/":.       
-0001f550: 2020 2020 2072 6574 7572 6e0a 0a20 2020       return..   
-0001f560: 2020 2020 2077 6974 6820 7365 6c66 2e5f       with self._
-0001f570: 7472 6565 5f74 7261 7665 7273 616c 3a0a  tree_traversal:.
-0001f580: 2020 2020 2020 2020 2020 2020 6966 206e              if n
-0001f590: 6f74 2073 656c 662e 6765 745f 696e 6465  ot self.get_inde
-0001f5a0: 785f 656e 7472 7928 6462 785f 7061 7468  x_entry(dbx_path
-0001f5b0: 5f6c 6f77 6572 5f64 6972 6e61 6d65 293a  _lower_dirname):
-0001f5c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001f5d0: 2073 656c 662e 5f6c 6f67 6765 722e 6465   self._logger.de
-0001f5e0: 6275 6728 0a20 2020 2020 2020 2020 2020  bug(.           
-0001f5f0: 2020 2020 2020 2020 2066 2250 6172 656e           f"Paren
-0001f600: 7420 666f 6c64 6572 207b 6462 785f 7061  t folder {dbx_pa
-0001f610: 7468 5f6c 6f77 6572 5f64 6972 6e61 6d65  th_lower_dirname
-0001f620: 7d20 6973 206e 6f74 2069 6e20 696e 6465  } is not in inde
-0001f630: 782e 2022 0a20 2020 2020 2020 2020 2020  x. ".           
-0001f640: 2020 2020 2020 2020 2066 2253 796e 6369           f"Synci
-0001f650: 6e67 2069 7420 6e6f 7720 6265 666f 7265  ng it now before
-0001f660: 2073 796e 6369 6e67 2061 6e79 2063 6869   syncing any chi
-0001f670: 6c64 7265 6e2e 220a 2020 2020 2020 2020  ldren.".        
-0001f680: 2020 2020 2020 2020 290a 0a20 2020 2020          )..     
-0001f690: 2020 2020 2020 2020 2020 2070 6172 656e             paren
-0001f6a0: 745f 6d64 203d 2073 656c 662e 636c 6965  t_md = self.clie
-0001f6b0: 6e74 2e67 6574 5f6d 6574 6164 6174 6128  nt.get_metadata(
-0001f6c0: 6462 785f 7061 7468 5f6c 6f77 6572 5f64  dbx_path_lower_d
-0001f6d0: 6972 6e61 6d65 290a 0a20 2020 2020 2020  irname)..       
-0001f6e0: 2020 2020 2020 2020 2069 6620 7061 7265           if pare
-0001f6f0: 6e74 5f6d 643a 2020 2320 4966 2074 6865  nt_md:  # If the
-0001f700: 2070 6172 656e 7420 6e6f 206c 6f6e 6765   parent no longe
-0001f710: 7220 6578 6973 7473 2c20 7765 2064 6f6e  r exists, we don
-0001f720: 2774 2064 6f20 616e 7974 6869 6e67 2e0a  't do anything..
-0001f730: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f740: 2020 2020 7061 7265 6e74 5f65 7665 6e74      parent_event
-0001f750: 203d 2053 796e 6345 7665 6e74 2e66 726f   = SyncEvent.fro
-0001f760: 6d5f 6d65 7461 6461 7461 2870 6172 656e  m_metadata(paren
-0001f770: 745f 6d64 2c20 7365 6c66 290a 2020 2020  t_md, self).    
-0001f780: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f790: 7365 6c66 2e5f 6f6e 5f72 656d 6f74 655f  self._on_remote_
-0001f7a0: 666f 6c64 6572 2870 6172 656e 745f 6576  folder(parent_ev
-0001f7b0: 656e 7429 0a0a 2020 2020 6465 6620 5f6c  ent)..    def _l
-0001f7c0: 6f63 616c 5f63 635f 6669 6c65 6e61 6d65  ocal_cc_filename
-0001f7d0: 2873 656c 662c 206c 6f63 616c 5f70 6174  (self, local_pat
-0001f7e0: 683a 2073 7472 2c20 6462 6964 3a20 7374  h: str, dbid: st
-0001f7f0: 7220 7c20 4e6f 6e65 2920 2d3e 2073 7472  r | None) -> str
-0001f800: 3a0a 2020 2020 2020 2020 6368 616e 6765  :.        change
-0001f810: 5f6f 776e 6572 203d 2073 656c 662e 5f64  _owner = self._d
-0001f820: 6973 706c 6179 5f6e 616d 655f 666f 725f  isplay_name_for_
-0001f830: 6163 636f 756e 7428 6462 6964 290a 2020  account(dbid).  
-0001f840: 2020 2020 2020 6461 7465 203d 2064 6174        date = dat
-0001f850: 6574 696d 652e 6e6f 7728 292e 7374 7266  etime.now().strf
-0001f860: 7469 6d65 2822 2559 2d25 6d2d 2564 2229  time("%Y-%m-%d")
-0001f870: 0a20 2020 2020 2020 2069 6620 6368 616e  .        if chan
-0001f880: 6765 5f6f 776e 6572 3a0a 2020 2020 2020  ge_owner:.      
-0001f890: 2020 2020 2020 7375 6666 6978 203d 2066        suffix = f
-0001f8a0: 227b 6368 616e 6765 5f6f 776e 6572 7d27  "{change_owner}'
-0001f8b0: 7320 636f 6e66 6c69 6374 6564 2063 6f70  s conflicted cop
-0001f8c0: 7920 7b64 6174 657d 220a 2020 2020 2020  y {date}".      
-0001f8d0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-0001f8e0: 2020 2020 7375 6666 6978 203d 2066 2263      suffix = f"c
-0001f8f0: 6f6e 666c 6963 7465 6420 636f 7079 207b  onflicted copy {
-0001f900: 6461 7465 7d22 0a20 2020 2020 2020 2072  date}".        r
-0001f910: 6574 7572 6e20 6765 6e65 7261 7465 5f63  eturn generate_c
-0001f920: 635f 6e61 6d65 286c 6f63 616c 5f70 6174  c_name(local_pat
-0001f930: 682c 2073 7566 6669 7829 0a0a 2020 2020  h, suffix)..    
-0001f940: 6465 6620 5f6f 6e5f 7265 6d6f 7465 5f66  def _on_remote_f
-0001f950: 696c 6528 7365 6c66 2c20 6576 656e 743a  ile(self, event:
-0001f960: 2053 796e 6345 7665 6e74 2920 2d3e 2053   SyncEvent) -> S
-0001f970: 796e 6353 7461 7475 733a 0a20 2020 2020  yncStatus:.     
-0001f980: 2020 2022 2222 0a20 2020 2020 2020 2041     """.        A
-0001f990: 7070 6c69 6573 2061 2072 656d 6f74 6520  pplies a remote 
-0001f9a0: 6669 6c65 2063 6861 6e67 6520 6f72 2063  file change or c
-0001f9b0: 7265 6174 696f 6e20 6c6f 6361 6c6c 792e  reation locally.
-0001f9c0: 0a0a 2020 2020 2020 2020 3a70 6172 616d  ..        :param
-0001f9d0: 2065 7665 6e74 3a20 5379 6e63 4576 656e   event: SyncEven
-0001f9e0: 7420 666f 7220 6669 6c65 2064 6f77 6e6c  t for file downl
-0001f9f0: 6f61 642e 0a20 2020 2020 2020 203a 7265  oad..        :re
-0001fa00: 7475 726e 733a 2053 796e 6345 7665 6e74  turns: SyncEvent
-0001fa10: 2063 6f72 7265 7370 6f6e 6469 6e67 2074   corresponding t
-0001fa20: 6f20 6c6f 6361 6c20 6974 656d 206f 7220  o local item or 
-0001fa30: 4e6f 6e65 2069 6620 6e6f 206c 6f63 616c  None if no local
-0001fa40: 2063 6861 6e67 6573 0a20 2020 2020 2020   changes.       
-0001fa50: 2020 2020 2061 7265 206d 6164 652e 0a20       are made.. 
-0001fa60: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
-0001fa70: 2020 2073 656c 662e 5f61 7070 6c79 5f63     self._apply_c
-0001fa80: 6173 655f 6368 616e 6765 2865 7665 6e74  ase_change(event
-0001fa90: 290a 0a20 2020 2020 2020 2023 2053 746f  )..        # Sto
-0001faa0: 7265 2074 6865 206e 6577 2065 6e74 7279  re the new entry
-0001fab0: 2061 7420 7468 6520 6769 7665 6e20 7061   at the given pa
-0001fac0: 7468 2069 6e20 796f 7572 206c 6f63 616c  th in your local
-0001fad0: 2073 7461 7465 2e20 4966 2074 6865 2072   state. If the r
-0001fae0: 6571 7569 7265 640a 2020 2020 2020 2020  equired.        
-0001faf0: 2320 7061 7265 6e74 2066 6f6c 6465 7273  # parent folders
-0001fb00: 2064 6f6e e280 9974 2065 7869 7374 2079   don...t exist y
-0001fb10: 6574 2c20 6372 6561 7465 2074 6865 6d2e  et, create them.
-0001fb20: 2049 6620 7468 6572 65e2 8099 7320 616c   If there...s al
-0001fb30: 7265 6164 7920 736f 6d65 7468 696e 6720  ready something 
-0001fb40: 656c 7365 0a20 2020 2020 2020 2023 2061  else.        # a
-0001fb50: 7420 7468 6520 6769 7665 6e20 7061 7468  t the given path
-0001fb60: 2c20 7265 706c 6163 6520 6974 2061 6e64  , replace it and
-0001fb70: 2072 656d 6f76 6520 616c 6c20 6974 7320   remove all its 
-0001fb80: 6368 696c 6472 656e 2e0a 0a20 2020 2020  children...     
-0001fb90: 2020 2063 6f6e 666c 6963 745f 6368 6563     conflict_chec
-0001fba0: 6b20 3d20 7365 6c66 2e5f 6368 6563 6b5f  k = self._check_
-0001fbb0: 646f 776e 6c6f 6164 5f63 6f6e 666c 6963  download_conflic
-0001fbc0: 7428 6576 656e 7429 0a0a 2020 2020 2020  t(event)..      
-0001fbd0: 2020 6966 2063 6f6e 666c 6963 745f 6368    if conflict_ch
-0001fbe0: 6563 6b20 6973 2043 6f6e 666c 6963 742e  eck is Conflict.
-0001fbf0: 4964 656e 7469 6361 6c3a 0a20 2020 2020  Identical:.     
-0001fc00: 2020 2020 2020 2073 656c 662e 7570 6461         self.upda
-0001fc10: 7465 5f69 6e64 6578 5f66 726f 6d5f 7379  te_index_from_sy
-0001fc20: 6e63 5f65 7665 6e74 2865 7665 6e74 290a  nc_event(event).
-0001fc30: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-0001fc40: 726e 2053 796e 6353 7461 7475 732e 536b  rn SyncStatus.Sk
-0001fc50: 6970 7065 640a 2020 2020 2020 2020 656c  ipped.        el
-0001fc60: 6966 2063 6f6e 666c 6963 745f 6368 6563  if conflict_chec
-0001fc70: 6b20 6973 2043 6f6e 666c 6963 742e 4c6f  k is Conflict.Lo
-0001fc80: 6361 6c4e 6577 6572 4f72 4964 656e 7469  calNewerOrIdenti
-0001fc90: 6361 6c3a 0a20 2020 2020 2020 2020 2020  cal:.           
-0001fca0: 2072 6574 7572 6e20 5379 6e63 5374 6174   return SyncStat
-0001fcb0: 7573 2e53 6b69 7070 6564 0a0a 2020 2020  us.Skipped..    
-0001fcc0: 2020 2020 2320 456e 7375 7265 2074 6861      # Ensure tha
-0001fcd0: 7420 7061 7265 6e74 2066 6f6c 6465 7273  t parent folders
-0001fce0: 2061 7265 2073 796e 6365 642e 0a20 2020   are synced..   
-0001fcf0: 2020 2020 2073 656c 662e 5f65 6e73 7572       self._ensur
-0001fd00: 655f 7061 7265 6e74 2865 7665 6e74 290a  e_parent(event).
-0001fd10: 0a20 2020 2020 2020 2069 6620 6576 656e  .        if even
-0001fd20: 742e 7379 6d6c 696e 6b5f 7461 7267 6574  t.symlink_target
-0001fd30: 2069 7320 6e6f 7420 4e6f 6e65 3a0a 2020   is not None:.  
-0001fd40: 2020 2020 2020 2020 2020 2320 446f 6e27            # Don'
-0001fd50: 7420 646f 776e 6c6f 6164 2062 7574 2072  t download but r
-0001fd60: 6570 726f 6475 6365 2073 796d 6c69 6e6b  eproduce symlink
-0001fd70: 206c 6f63 616c 6c79 2e0a 2020 2020 2020   locally..      
-0001fd80: 2020 2020 2020 7769 7468 2073 656c 662e        with self.
-0001fd90: 6673 5f65 7665 6e74 732e 6967 6e6f 7265  fs_events.ignore
-0001fda0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-0001fdb0: 2020 4669 6c65 4372 6561 7465 6445 7665    FileCreatedEve
-0001fdc0: 6e74 2865 7665 6e74 2e6c 6f63 616c 5f70  nt(event.local_p
-0001fdd0: 6174 6829 2c20 7265 6375 7273 6976 653d  ath), recursive=
-0001fde0: 4661 6c73 650a 2020 2020 2020 2020 2020  False.          
-0001fdf0: 2020 293a 0a20 2020 2020 2020 2020 2020    ):.           
-0001fe00: 2020 2020 2077 6974 6820 636f 6e76 6572       with conver
-0001fe10: 745f 6170 695f 6572 726f 7273 2864 6278  t_api_errors(dbx
-0001fe20: 5f70 6174 683d 6576 656e 742e 6462 785f  _path=event.dbx_
-0001fe30: 7061 7468 293a 0a20 2020 2020 2020 2020  path):.         
-0001fe40: 2020 2020 2020 2020 2020 206f 732e 7379             os.sy
-0001fe50: 6d6c 696e 6b28 6576 656e 742e 7379 6d6c  mlink(event.syml
-0001fe60: 696e 6b5f 7461 7267 6574 2c20 6576 656e  ink_target, even
-0001fe70: 742e 6c6f 6361 6c5f 7061 7468 290a 2020  t.local_path).  
+00016710: 2065 7665 6e74 2e64 6278 5f70 6174 682c   event.dbx_path,
+00016720: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00016730: 2020 2020 2061 7574 6f72 656e 616d 653d       autorename=
+00016740: 5472 7565 2c0a 2020 2020 2020 2020 2020  True,.          
+00016750: 2020 2020 2020 2020 2020 7772 6974 655f            write_
+00016760: 6d6f 6465 3d6d 6f64 652c 0a20 2020 2020  mode=mode,.     
+00016770: 2020 2020 2020 2020 2020 2020 2020 2075                 u
+00016780: 7064 6174 655f 7265 763d 6c6f 6361 6c5f  pdate_rev=local_
+00016790: 7265 762c 0a20 2020 2020 2020 2020 2020  rev,.           
+000167a0: 2020 2020 2020 2020 2073 796e 635f 6576           sync_ev
+000167b0: 656e 743d 6576 656e 742c 0a20 2020 2020  ent=event,.     
+000167c0: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
+000167d0: 2020 2020 2065 7863 6570 7420 284e 6f74       except (Not
+000167e0: 466f 756e 6445 7272 6f72 2c20 4e6f 7441  FoundError, NotA
+000167f0: 466f 6c64 6572 4572 726f 722c 2049 7341  FolderError, IsA
+00016800: 466f 6c64 6572 4572 726f 7229 3a0a 2020  FolderError):.  
+00016810: 2020 2020 2020 2020 2020 2320 4e6f 7465            # Note
+00016820: 3a20 4e6f 7441 466f 6c64 6572 4572 726f  : NotAFolderErro
+00016830: 7220 6361 6e20 6265 2072 6169 7365 6420  r can be raised 
+00016840: 7768 656e 2061 2070 6172 656e 7420 696e  when a parent in
+00016850: 2074 6865 206c 6f63 616c 2070 6174 680a   the local path.
+00016860: 2020 2020 2020 2020 2020 2020 2320 7265              # re
+00016870: 6665 7273 2074 6f20 6120 6669 6c65 2069  fers to a file i
+00016880: 6e73 7465 6164 206f 6620 6120 666f 6c64  nstead of a fold
+00016890: 6572 2e0a 2020 2020 2020 2020 2020 2020  er..            
+000168a0: 7365 6c66 2e5f 6c6f 6767 6572 2e64 6562  self._logger.deb
+000168b0: 7567 280a 2020 2020 2020 2020 2020 2020  ug(.            
+000168c0: 2020 2020 2743 6f75 6c64 206e 6f74 2075      'Could not u
+000168d0: 706c 6f61 6420 2225 7322 3a20 7468 6520  pload "%s": the 
+000168e0: 6669 6c65 2064 6f65 7320 6e6f 7420 6578  file does not ex
+000168f0: 6973 7427 2c20 6576 656e 742e 6c6f 6361  ist', event.loca
+00016900: 6c5f 7061 7468 0a20 2020 2020 2020 2020  l_path.         
+00016910: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
+00016920: 2072 6574 7572 6e20 5379 6e63 5374 6174   return SyncStat
+00016930: 7573 2e53 6b69 7070 6564 0a20 2020 2020  us.Skipped.     
+00016940: 2020 2065 7863 6570 7420 4461 7461 4368     except DataCh
+00016950: 616e 6765 6445 7272 6f72 3a0a 2020 2020  angedError:.    
+00016960: 2020 2020 2020 2020 7365 6c66 2e5f 6c6f          self._lo
+00016970: 6767 6572 2e64 6562 7567 280a 2020 2020  gger.debug(.    
+00016980: 2020 2020 2020 2020 2020 2020 2743 6f75              'Cou
+00016990: 6c64 206e 6f74 2075 706c 6f61 6420 2225  ld not upload "%
+000169a0: 7322 3a20 7468 6520 6669 6c65 2077 6173  s": the file was
+000169b0: 206d 6f64 6966 6965 6420 6475 7269 6e67   modified during
+000169c0: 2075 706c 6f61 6427 2c0a 2020 2020 2020   upload',.      
+000169d0: 2020 2020 2020 2020 2020 6576 656e 742e            event.
+000169e0: 6c6f 6361 6c5f 7061 7468 2c0a 2020 2020  local_path,.    
+000169f0: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+00016a00: 2020 2020 2020 7265 7475 726e 2053 796e        return Syn
+00016a10: 6353 7461 7475 732e 536b 6970 7065 640a  cStatus.Skipped.
+00016a20: 0a20 2020 2020 2020 2069 6620 7365 6c66  .        if self
+00016a30: 2e5f 6861 6e64 6c65 5f75 706c 6f61 645f  ._handle_upload_
+00016a40: 636f 6e66 6c69 6374 286d 645f 6e65 772c  conflict(md_new,
+00016a50: 2065 7665 6e74 293a 0a20 2020 2020 2020   event):.       
+00016a60: 2020 2020 2073 7461 7475 7320 3d20 5379       status = Sy
+00016a70: 6e63 5374 6174 7573 2e43 6f6e 666c 6963  ncStatus.Conflic
+00016a80: 740a 2020 2020 2020 2020 656c 7365 3a0a  t.        else:.
+00016a90: 2020 2020 2020 2020 2020 2020 7374 6174              stat
+00016aa0: 7573 203d 2053 796e 6353 7461 7475 732e  us = SyncStatus.
+00016ab0: 446f 6e65 0a20 2020 2020 2020 2020 2020  Done.           
+00016ac0: 2069 6620 6576 656e 742e 6368 616e 6765   if event.change
+00016ad0: 5f74 7970 6520 6973 2043 6861 6e67 6554  _type is ChangeT
+00016ae0: 7970 652e 4164 6465 643a 0a20 2020 2020  ype.Added:.     
+00016af0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+00016b00: 5f6c 6f67 6765 722e 6465 6275 6728 2743  _logger.debug('C
+00016b10: 7265 6174 6564 2022 2573 2220 6f6e 2044  reated "%s" on D
+00016b20: 726f 7062 6f78 272c 2065 7665 6e74 2e64  ropbox', event.d
+00016b30: 6278 5f70 6174 6829 0a20 2020 2020 2020  bx_path).       
+00016b40: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+00016b50: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+00016b60: 5f6c 6f67 6765 722e 6465 6275 6728 2755  _logger.debug('U
+00016b70: 706c 6f61 6465 6420 6d6f 6469 6669 6564  ploaded modified
+00016b80: 2022 2573 2220 746f 2044 726f 7062 6f78   "%s" to Dropbox
+00016b90: 272c 2065 7665 6e74 2e64 6278 5f70 6174  ', event.dbx_pat
+00016ba0: 6829 0a0a 2020 2020 2020 2020 7365 6c66  h)..        self
+00016bb0: 2e75 7064 6174 655f 696e 6465 785f 6672  .update_index_fr
+00016bc0: 6f6d 5f64 6278 5f6d 6574 6164 6174 6128  om_dbx_metadata(
+00016bd0: 6d64 5f6e 6577 290a 0a20 2020 2020 2020  md_new)..       
+00016be0: 2072 6574 7572 6e20 7374 6174 7573 0a0a   return status..
+00016bf0: 2020 2020 6465 6620 5f6f 6e5f 6c6f 6361      def _on_loca
+00016c00: 6c5f 666f 6c64 6572 5f63 7265 6174 6564  l_folder_created
+00016c10: 2873 656c 662c 2065 7665 6e74 3a20 5379  (self, event: Sy
+00016c20: 6e63 4576 656e 7429 202d 3e20 5379 6e63  ncEvent) -> Sync
+00016c30: 5374 6174 7573 3a0a 2020 2020 2020 2020  Status:.        
+00016c40: 2222 220a 2020 2020 2020 2020 4361 6c6c  """.        Call
+00016c50: 2077 6865 6e20 6120 6c6f 6361 6c20 666f   when a local fo
+00016c60: 6c64 6572 2069 7320 6372 6561 7465 642e  lder is created.
+00016c70: 0a0a 2020 2020 2020 2020 3a70 6172 616d  ..        :param
+00016c80: 2065 7665 6e74 3a20 5379 6e63 4576 656e   event: SyncEven
+00016c90: 7420 636f 7272 6573 706f 6e64 696e 6720  t corresponding 
+00016ca0: 746f 206c 6f63 616c 2063 7265 6174 6564  to local created
+00016cb0: 2065 7665 6e74 2e0a 2020 2020 2020 2020   event..        
+00016cc0: 3a72 6574 7572 6e73 3a20 4d65 7461 6461  :returns: Metada
+00016cd0: 7461 2066 6f72 2063 7265 6174 6564 2069  ta for created i
+00016ce0: 7465 6d20 6f72 204e 6f6e 6520 6966 206e  tem or None if n
+00016cf0: 6f20 7265 6d6f 7465 2069 7465 6d20 6973  o remote item is
+00016d00: 2063 7265 6174 6564 2e0a 2020 2020 2020   created..      
+00016d10: 2020 3a72 6169 7365 7320 4d61 6573 7472    :raises Maestr
+00016d20: 616c 4170 6945 7272 6f72 3a20 466f 7220  alApiError: For 
+00016d30: 616e 7920 6973 7375 6573 2077 6865 6e20  any issues when 
+00016d40: 7379 6e63 696e 6720 7468 6520 6974 656d  syncing the item
+00016d50: 2e0a 2020 2020 2020 2020 2222 220a 2020  ..        """.  
+00016d60: 2020 2020 2020 6368 6563 6b5f 6368 616e        check_chan
+00016d70: 6765 5f74 7970 6528 6576 656e 742c 207b  ge_type(event, {
+00016d80: 4368 616e 6765 5479 7065 2e41 6464 6564  ChangeType.Added
+00016d90: 7d29 0a20 2020 2020 2020 2063 6865 636b  }).        check
+00016da0: 5f65 6e63 6f64 696e 6728 6576 656e 742e  _encoding(event.
+00016db0: 6c6f 6361 6c5f 7061 7468 290a 0a20 2020  local_path)..   
+00016dc0: 2020 2020 2069 6620 7365 6c66 2e5f 6861       if self._ha
+00016dd0: 6e64 6c65 5f73 656c 6563 7469 7665 5f73  ndle_selective_s
+00016de0: 796e 635f 636f 6e66 6c69 6374 2865 7665  ync_conflict(eve
+00016df0: 6e74 293a 0a20 2020 2020 2020 2020 2020  nt):.           
+00016e00: 2072 6574 7572 6e20 5379 6e63 5374 6174   return SyncStat
+00016e10: 7573 2e43 6f6e 666c 6963 740a 2020 2020  us.Conflict.    
+00016e20: 2020 2020 6966 2073 656c 662e 5f68 616e      if self._han
+00016e30: 646c 655f 6e6f 726d 616c 697a 6174 696f  dle_normalizatio
+00016e40: 6e5f 636f 6e66 6c69 6374 2865 7665 6e74  n_conflict(event
+00016e50: 293a 0a20 2020 2020 2020 2020 2020 2072  ):.            r
+00016e60: 6574 7572 6e20 5379 6e63 5374 6174 7573  eturn SyncStatus
+00016e70: 2e43 6f6e 666c 6963 740a 0a20 2020 2020  .Conflict..     
+00016e80: 2020 2073 656c 662e 5f77 6169 745f 666f     self._wait_fo
+00016e90: 725f 6372 6561 7469 6f6e 2865 7665 6e74  r_creation(event
+00016ea0: 2e6c 6f63 616c 5f70 6174 6829 0a0a 2020  .local_path)..  
+00016eb0: 2020 2020 2020 7472 793a 0a20 2020 2020        try:.     
+00016ec0: 2020 2020 2020 2069 6620 7365 6c66 2e63         if self.c
+00016ed0: 6c69 656e 742e 6973 5f74 6561 6d5f 7370  lient.is_team_sp
+00016ee0: 6163 6520 616e 6420 6576 656e 742e 6462  ace and event.db
+00016ef0: 785f 7061 7468 2e63 6f75 6e74 2822 2f22  x_path.count("/"
+00016f00: 2920 3d3d 2031 3a0a 2020 2020 2020 2020  ) == 1:.        
+00016f10: 2020 2020 2020 2020 6d64 5f6e 6577 203d          md_new =
+00016f20: 2073 656c 662e 636c 6965 6e74 2e73 6861   self.client.sha
+00016f30: 7265 5f64 6972 2865 7665 6e74 2e64 6278  re_dir(event.dbx
+00016f40: 5f70 6174 6829 0a0a 2020 2020 2020 2020  _path)..        
+00016f50: 2020 2020 2020 2020 6966 206e 6f74 206d          if not m
+00016f60: 645f 6e65 773a 0a20 2020 2020 2020 2020  d_new:.         
+00016f70: 2020 2020 2020 2020 2020 2023 2052 656d             # Rem
+00016f80: 6f74 6520 666f 6c64 6572 2068 6173 2062  ote folder has b
+00016f90: 6565 6e20 6465 6c65 7465 6420 6166 7465  een deleted afte
+00016fa0: 7220 6372 6561 7469 6e67 2e20 5265 666c  r creating. Refl
+00016fb0: 6563 7420 6368 616e 6765 730a 2020 2020  ect changes.    
+00016fc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016fd0: 2320 6c6f 6361 6c6c 7920 616e 6420 7265  # locally and re
+00016fe0: 7475 726e 2e0a 2020 2020 2020 2020 2020  turn..          
+00016ff0: 2020 2020 2020 2020 2020 7365 6c66 2e5f            self._
+00017000: 6c6f 6767 6572 2e64 6562 7567 280a 2020  logger.debug(.  
+00017010: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017020: 2020 2020 2020 2722 2573 2220 6f6e 2044        '"%s" on D
+00017030: 726f 7062 6f78 2077 6173 2064 656c 6574  ropbox was delet
+00017040: 6564 2061 6674 6572 2063 7265 6174 696f  ed after creatio
+00017050: 6e2c 2027 0a20 2020 2020 2020 2020 2020  n, '.           
+00017060: 2020 2020 2020 2020 2020 2020 2022 6465               "de
+00017070: 6c65 7469 6e67 206c 6f63 616c 2063 6f70  leting local cop
+00017080: 7922 2c0a 2020 2020 2020 2020 2020 2020  y",.            
+00017090: 2020 2020 2020 2020 2020 2020 6576 656e              even
+000170a0: 742e 6462 785f 7061 7468 2c0a 2020 2020  t.dbx_path,.    
+000170b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000170c0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+000170d0: 2020 2020 2020 6572 7220 3d20 6465 6c65        err = dele
+000170e0: 7465 280a 2020 2020 2020 2020 2020 2020  te(.            
+000170f0: 2020 2020 2020 2020 2020 2020 6576 656e              even
+00017100: 742e 6c6f 6361 6c5f 7061 7468 2c0a 2020  t.local_path,.  
+00017110: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017120: 2020 2020 2020 666f 7263 655f 6361 7365        force_case
+00017130: 5f73 656e 7369 7469 7665 3d6e 6f74 2073  _sensitive=not s
+00017140: 656c 662e 6973 5f66 735f 6361 7365 5f73  elf.is_fs_case_s
+00017150: 656e 7369 7469 7665 2c0a 2020 2020 2020  ensitive,.      
+00017160: 2020 2020 2020 2020 2020 2020 2020 290a                ).
+00017170: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00017180: 2020 2020 2069 6620 6572 723a 0a20 2020       if err:.   
+00017190: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000171a0: 2020 2020 2072 6169 7365 206f 735f 746f       raise os_to
+000171b0: 5f6d 6165 7374 7261 6c5f 6572 726f 7228  _maestral_error(
+000171c0: 6572 7229 0a0a 2020 2020 2020 2020 2020  err)..          
+000171d0: 2020 2020 2020 2020 2020 7265 7475 726e            return
+000171e0: 2053 796e 6353 7461 7475 732e 536b 6970   SyncStatus.Skip
+000171f0: 7065 640a 2020 2020 2020 2020 2020 2020  ped.            
+00017200: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+00017210: 2020 2020 2020 6d64 5f6e 6577 203d 2073        md_new = s
+00017220: 656c 662e 636c 6965 6e74 2e6d 616b 655f  elf.client.make_
+00017230: 6469 7228 6576 656e 742e 6462 785f 7061  dir(event.dbx_pa
+00017240: 7468 2c20 6175 746f 7265 6e61 6d65 3d46  th, autorename=F
+00017250: 616c 7365 290a 2020 2020 2020 2020 6578  alse).        ex
+00017260: 6365 7074 2046 6f6c 6465 7243 6f6e 666c  cept FolderConfl
+00017270: 6963 7445 7272 6f72 3a0a 2020 2020 2020  ictError:.      
+00017280: 2020 2020 2020 7365 6c66 2e5f 6c6f 6767        self._logg
+00017290: 6572 2e64 6562 7567 280a 2020 2020 2020  er.debug(.      
+000172a0: 2020 2020 2020 2020 2020 274e 6f20 636f            'No co
+000172b0: 6e66 6c69 6374 2066 6f72 2022 2573 223a  nflict for "%s":
+000172c0: 2074 6865 2066 6f6c 6465 7220 616c 7265   the folder alre
+000172d0: 6164 7920 6578 6973 7473 272c 2065 7665  ady exists', eve
+000172e0: 6e74 2e6c 6f63 616c 5f70 6174 680a 2020  nt.local_path.  
+000172f0: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
+00017300: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
+00017310: 2020 2020 2020 2020 2020 2020 206d 6420               md 
+00017320: 3d20 7365 6c66 2e63 6c69 656e 742e 6765  = self.client.ge
+00017330: 745f 6d65 7461 6461 7461 2865 7665 6e74  t_metadata(event
+00017340: 2e64 6278 5f70 6174 6829 0a20 2020 2020  .dbx_path).     
+00017350: 2020 2020 2020 2020 2020 2069 6620 6973             if is
+00017360: 696e 7374 616e 6365 286d 642c 2046 6f6c  instance(md, Fol
+00017370: 6465 724d 6574 6164 6174 6129 3a0a 2020  derMetadata):.  
+00017380: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017390: 2020 7365 6c66 2e75 7064 6174 655f 696e    self.update_in
+000173a0: 6465 785f 6672 6f6d 5f64 6278 5f6d 6574  dex_from_dbx_met
+000173b0: 6164 6174 6128 6d64 290a 2020 2020 2020  adata(md).      
+000173c0: 2020 2020 2020 6578 6365 7074 204e 6f74        except Not
+000173d0: 466f 756e 6445 7272 6f72 3a0a 2020 2020  FoundError:.    
+000173e0: 2020 2020 2020 2020 2020 2020 7061 7373              pass
+000173f0: 0a0a 2020 2020 2020 2020 2020 2020 7265  ..            re
+00017400: 7475 726e 2053 796e 6353 7461 7475 732e  turn SyncStatus.
+00017410: 536b 6970 7065 640a 2020 2020 2020 2020  Skipped.        
+00017420: 6578 6365 7074 2046 696c 6543 6f6e 666c  except FileConfl
+00017430: 6963 7445 7272 6f72 3a0a 2020 2020 2020  ictError:.      
+00017440: 2020 2020 2020 6d64 5f6e 6577 203d 2073        md_new = s
+00017450: 656c 662e 636c 6965 6e74 2e6d 616b 655f  elf.client.make_
+00017460: 6469 7228 6576 656e 742e 6462 785f 7061  dir(event.dbx_pa
+00017470: 7468 2c20 6175 746f 7265 6e61 6d65 3d54  th, autorename=T
+00017480: 7275 6529 0a0a 2020 2020 2020 2020 6966  rue)..        if
+00017490: 2073 656c 662e 5f68 616e 646c 655f 7570   self._handle_up
+000174a0: 6c6f 6164 5f63 6f6e 666c 6963 7428 6d64  load_conflict(md
+000174b0: 5f6e 6577 2c20 6576 656e 7429 3a0a 2020  _new, event):.  
+000174c0: 2020 2020 2020 2020 2020 7374 6174 7573            status
+000174d0: 203d 2053 796e 6353 7461 7475 732e 436f   = SyncStatus.Co
+000174e0: 6e66 6c69 6374 0a20 2020 2020 2020 2065  nflict.        e
+000174f0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+00017500: 2073 7461 7475 7320 3d20 5379 6e63 5374   status = SyncSt
+00017510: 6174 7573 2e44 6f6e 650a 2020 2020 2020  atus.Done.      
+00017520: 2020 2020 2020 7365 6c66 2e5f 6c6f 6767        self._logg
+00017530: 6572 2e64 6562 7567 2827 4372 6561 7465  er.debug('Create
+00017540: 6420 2225 7322 206f 6e20 4472 6f70 626f  d "%s" on Dropbo
+00017550: 7827 2c20 6576 656e 742e 6462 785f 7061  x', event.dbx_pa
+00017560: 7468 290a 0a20 2020 2020 2020 2073 656c  th)..        sel
+00017570: 662e 7570 6461 7465 5f69 6e64 6578 5f66  f.update_index_f
+00017580: 726f 6d5f 6462 785f 6d65 7461 6461 7461  rom_dbx_metadata
+00017590: 286d 645f 6e65 7729 0a0a 2020 2020 2020  (md_new)..      
+000175a0: 2020 7265 7475 726e 2073 7461 7475 730a    return status.
+000175b0: 0a20 2020 2064 6566 205f 6f6e 5f6c 6f63  .    def _on_loc
+000175c0: 616c 5f64 656c 6574 6564 2873 656c 662c  al_deleted(self,
+000175d0: 2065 7665 6e74 3a20 5379 6e63 4576 656e   event: SyncEven
+000175e0: 7429 202d 3e20 5379 6e63 5374 6174 7573  t) -> SyncStatus
+000175f0: 3a0a 2020 2020 2020 2020 2222 220a 2020  :.        """.  
+00017600: 2020 2020 2020 4361 6c6c 2077 6865 6e20        Call when 
+00017610: 6120 6c6f 6361 6c20 6974 656d 2069 7320  a local item is 
+00017620: 6465 6c65 7465 642e 2057 6520 7472 7920  deleted. We try 
+00017630: 6e6f 7420 746f 2064 656c 6574 6520 7265  not to delete re
+00017640: 6d6f 7465 2069 7465 6d73 2077 6869 6368  mote items which
+00017650: 2068 6176 650a 2020 2020 2020 2020 6265   have.        be
+00017660: 656e 206d 6f64 6966 6965 6420 7369 6e63  en modified sinc
+00017670: 6520 7468 6520 6c61 7374 2073 796e 632e  e the last sync.
+00017680: 0a0a 2020 2020 2020 2020 3a70 6172 616d  ..        :param
+00017690: 2065 7665 6e74 3a20 5379 6e63 4576 656e   event: SyncEven
+000176a0: 7420 666f 7220 6c6f 6361 6c20 6465 6c65  t for local dele
+000176b0: 7469 6f6e 2e0a 2020 2020 2020 2020 3a72  tion..        :r
+000176c0: 6574 7572 6e73 3a20 4d65 7461 6461 7461  eturns: Metadata
+000176d0: 2066 6f72 2064 656c 6574 6564 2069 7465   for deleted ite
+000176e0: 6d20 6f72 204e 6f6e 6520 6966 206e 6f20  m or None if no 
+000176f0: 7265 6d6f 7465 2069 7465 6d20 6973 2064  remote item is d
+00017700: 656c 6574 6564 2e0a 2020 2020 2020 2020  eleted..        
+00017710: 3a72 6169 7365 7320 4d61 6573 7472 616c  :raises Maestral
+00017720: 4170 6945 7272 6f72 3a20 466f 7220 616e  ApiError: For an
+00017730: 7920 6973 7375 6573 2077 6865 6e20 7379  y issues when sy
+00017740: 6e63 696e 6720 7468 6520 6974 656d 2e0a  ncing the item..
+00017750: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
+00017760: 2020 2020 6368 6563 6b5f 6368 616e 6765      check_change
+00017770: 5f74 7970 6528 6576 656e 742c 207b 4368  _type(event, {Ch
+00017780: 616e 6765 5479 7065 2e52 656d 6f76 6564  angeType.Removed
+00017790: 7d29 0a20 2020 2020 2020 2074 7279 3a0a  }).        try:.
+000177a0: 2020 2020 2020 2020 2020 2020 6368 6563              chec
+000177b0: 6b5f 656e 636f 6469 6e67 2865 7665 6e74  k_encoding(event
+000177c0: 2e6c 6f63 616c 5f70 6174 6829 0a20 2020  .local_path).   
+000177d0: 2020 2020 2065 7863 6570 7420 5061 7468       except Path
+000177e0: 4572 726f 723a 0a20 2020 2020 2020 2020  Error:.         
+000177f0: 2020 2023 2044 6f6e 2774 2072 6169 7365     # Don't raise
+00017800: 2061 6e20 6572 726f 7220 6865 7265 2062   an error here b
+00017810: 6563 6175 7365 2074 6865 2066 696c 6520  ecause the file 
+00017820: 6361 6e6e 6f74 2065 7869 7374 206f 6e20  cannot exist on 
+00017830: 7468 6520 7365 7276 6572 2e0a 2020 2020  the server..    
+00017840: 2020 2020 2020 2020 7365 6c66 2e5f 6c6f          self._lo
+00017850: 6767 6572 2e64 6562 7567 280a 2020 2020  gger.debug(.    
+00017860: 2020 2020 2020 2020 2020 2020 2743 6f75              'Cou
+00017870: 6c64 206e 6f74 2064 656c 6574 6520 2225  ld not delete "%
+00017880: 7322 3a20 7468 6520 6974 656d 2064 6f65  s": the item doe
+00017890: 7320 6e6f 7420 6578 6973 7420 6f6e 2044  s not exist on D
+000178a0: 726f 7062 6f78 272c 0a20 2020 2020 2020  ropbox',.       
+000178b0: 2020 2020 2020 2020 2065 7665 6e74 2e64           event.d
+000178c0: 6278 5f70 6174 682c 0a20 2020 2020 2020  bx_path,.       
+000178d0: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
+000178e0: 2020 2072 6574 7572 6e20 5379 6e63 5374     return SyncSt
+000178f0: 6174 7573 2e53 6b69 7070 6564 0a0a 2020  atus.Skipped..  
+00017900: 2020 2020 2020 2320 5765 2069 6e74 6572        # We inter
+00017910: 6365 7074 2061 6e79 2061 7474 656d 7074  cept any attempt
+00017920: 7320 746f 2064 656c 6574 6520 7468 6520  s to delete the 
+00017930: 686f 6d65 2066 6f6c 6465 7220 6865 7265  home folder here
+00017940: 2069 6e73 7465 6164 206f 6620 7761 6974   instead of wait
+00017950: 696e 670a 2020 2020 2020 2020 2320 666f  ing.        # fo
+00017960: 7220 616e 2065 7272 6f72 2066 726f 6d20  r an error from 
+00017970: 7468 6520 4472 6f70 626f 7820 4150 492e  the Dropbox API.
+00017980: 2054 6869 7320 616c 6c6f 7773 2075 7320   This allows us 
+00017990: 746f 2070 726f 7669 6465 2061 2062 6574  to provide a bet
+000179a0: 7465 7220 6572 726f 720a 2020 2020 2020  ter error.      
+000179b0: 2020 2320 6d65 7373 6167 652e 0a0a 2020    # message...  
+000179c0: 2020 2020 2020 686f 6d65 5f70 6174 6820        home_path 
+000179d0: 3d20 7365 6c66 2e5f 7374 6174 652e 6765  = self._state.ge
+000179e0: 7428 2261 6363 6f75 6e74 222c 2022 686f  t("account", "ho
+000179f0: 6d65 5f70 6174 6822 290a 0a20 2020 2020  me_path")..     
+00017a00: 2020 2069 6620 6576 656e 742e 6462 785f     if event.dbx_
+00017a10: 7061 7468 203d 3d20 686f 6d65 5f70 6174  path == home_pat
+00017a20: 683a 0a20 2020 2020 2020 2020 2020 2072  h:.            r
+00017a30: 6169 7365 2053 796e 6345 7272 6f72 280a  aise SyncError(.
+00017a40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017a50: 7469 746c 653d 2243 6f75 6c64 206e 6f74  title="Could not
+00017a60: 2064 656c 6574 6520 6974 656d 222c 0a20   delete item",. 
+00017a70: 2020 2020 2020 2020 2020 2020 2020 206d                 m
+00017a80: 6573 7361 6765 3d22 4361 6e6e 6f74 2064  essage="Cannot d
+00017a90: 656c 6574 6520 7468 6520 7573 6572 2773  elete the user's
+00017aa0: 2068 6f6d 6520 666f 6c64 6572 222c 0a20   home folder",. 
+00017ab0: 2020 2020 2020 2020 2020 2020 2020 2064                 d
+00017ac0: 6278 5f70 6174 683d 6576 656e 742e 6462  bx_path=event.db
+00017ad0: 785f 7061 7468 2c0a 2020 2020 2020 2020  x_path,.        
+00017ae0: 2020 2020 2020 2020 6c6f 6361 6c5f 7061          local_pa
+00017af0: 7468 3d65 7665 6e74 2e6c 6f63 616c 5f70  th=event.local_p
+00017b00: 6174 682c 0a20 2020 2020 2020 2020 2020  ath,.           
+00017b10: 2029 0a0a 2020 2020 2020 2020 6966 2065   )..        if e
+00017b20: 7665 6e74 2e6c 6f63 616c 5f70 6174 6820  vent.local_path 
+00017b30: 3d3d 2073 656c 662e 6472 6f70 626f 785f  == self.dropbox_
+00017b40: 7061 7468 3a0a 2020 2020 2020 2020 2020  path:.          
+00017b50: 2020 7365 6c66 2e65 6e73 7572 655f 6472    self.ensure_dr
+00017b60: 6f70 626f 785f 666f 6c64 6572 5f70 7265  opbox_folder_pre
+00017b70: 7365 6e74 2829 0a0a 2020 2020 2020 2020  sent()..        
+00017b80: 6966 2073 656c 662e 6973 5f65 7863 6c75  if self.is_exclu
+00017b90: 6465 645f 6279 5f75 7365 7228 6576 656e  ded_by_user(even
+00017ba0: 742e 6462 785f 7061 7468 5f6c 6f77 6572  t.dbx_path_lower
+00017bb0: 293a 0a20 2020 2020 2020 2020 2020 2073  ):.            s
+00017bc0: 656c 662e 5f6c 6f67 6765 722e 6465 6275  elf._logger.debu
+00017bd0: 6728 0a20 2020 2020 2020 2020 2020 2020  g(.             
+00017be0: 2020 2027 4e6f 7420 6465 6c65 7469 6e67     'Not deleting
+00017bf0: 2022 2573 223a 2069 7320 6578 636c 7564   "%s": is exclud
+00017c00: 6564 2062 7920 7365 6c65 6374 6976 6520  ed by selective 
+00017c10: 7379 6e63 272c 2065 7665 6e74 2e64 6278  sync', event.dbx
+00017c20: 5f70 6174 680a 2020 2020 2020 2020 2020  _path.          
+00017c30: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
+00017c40: 7265 7475 726e 2053 796e 6353 7461 7475  return SyncStatu
+00017c50: 732e 536b 6970 7065 640a 0a20 2020 2020  s.Skipped..     
+00017c60: 2020 206c 6f63 616c 5f72 6576 203d 2073     local_rev = s
+00017c70: 656c 662e 6765 745f 6c6f 6361 6c5f 7265  elf.get_local_re
+00017c80: 7628 6576 656e 742e 6462 785f 7061 7468  v(event.dbx_path
+00017c90: 5f6c 6f77 6572 290a 0a20 2020 2020 2020  _lower)..       
+00017ca0: 206d 6420 3d20 7365 6c66 2e63 6c69 656e   md = self.clien
+00017cb0: 742e 6765 745f 6d65 7461 6461 7461 2865  t.get_metadata(e
+00017cc0: 7665 6e74 2e64 6278 5f70 6174 682c 2069  vent.dbx_path, i
+00017cd0: 6e63 6c75 6465 5f64 656c 6574 6564 3d54  nclude_deleted=T
+00017ce0: 7275 6529 0a0a 2020 2020 2020 2020 6966  rue)..        if
+00017cf0: 206e 6f74 206d 643a 0a20 2020 2020 2020   not md:.       
+00017d00: 2020 2020 2073 656c 662e 5f6c 6f67 6765       self._logge
+00017d10: 722e 6465 6275 6728 0a20 2020 2020 2020  r.debug(.       
+00017d20: 2020 2020 2020 2020 2027 436f 756c 6420           'Could 
+00017d30: 6e6f 7420 6465 6c65 7465 2022 2573 223a  not delete "%s":
+00017d40: 2074 6865 2069 7465 6d20 646f 6573 206e   the item does n
+00017d50: 6f74 2065 7869 7374 206f 6e20 4472 6f70  ot exist on Drop
+00017d60: 626f 7827 2c0a 2020 2020 2020 2020 2020  box',.          
+00017d70: 2020 2020 2020 6576 656e 742e 6462 785f        event.dbx_
+00017d80: 7061 7468 2c0a 2020 2020 2020 2020 2020  path,.          
+00017d90: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
+00017da0: 7265 7475 726e 2053 796e 6353 7461 7475  return SyncStatu
+00017db0: 732e 536b 6970 7065 640a 0a20 2020 2020  s.Skipped..     
+00017dc0: 2020 2069 6620 6576 656e 742e 6973 5f64     if event.is_d
+00017dd0: 6972 6563 746f 7279 2061 6e64 2069 7369  irectory and isi
+00017de0: 6e73 7461 6e63 6528 6d64 2c20 4669 6c65  nstance(md, File
+00017df0: 4d65 7461 6461 7461 293a 0a20 2020 2020  Metadata):.     
+00017e00: 2020 2020 2020 2073 656c 662e 5f6c 6f67         self._log
+00017e10: 6765 722e 6465 6275 6728 0a20 2020 2020  ger.debug(.     
+00017e20: 2020 2020 2020 2020 2020 2027 4578 7065             'Expe
+00017e30: 6374 6564 2066 6f6c 6465 7220 6174 2022  cted folder at "
+00017e40: 2573 2220 6275 7420 666f 756e 6420 6120  %s" but found a 
+00017e50: 6669 6c65 2069 6e73 7465 6164 2c20 6368  file instead, ch
+00017e60: 6563 6b69 6e67 2027 0a20 2020 2020 2020  ecking '.       
+00017e70: 2020 2020 2020 2020 2022 7768 6963 6820           "which 
+00017e80: 6f6e 6520 6973 206e 6577 6572 222c 0a20  one is newer",. 
+00017e90: 2020 2020 2020 2020 2020 2020 2020 206d                 m
+00017ea0: 642e 7061 7468 5f64 6973 706c 6179 2c0a  d.path_display,.
+00017eb0: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
+00017ec0: 2020 2020 2020 2020 2020 2320 446f 6e27            # Don'
+00017ed0: 7420 6465 6c65 7465 2061 2072 656d 6f74  t delete a remot
+00017ee0: 6520 6669 6c65 2069 6620 6974 2077 6173  e file if it was
+00017ef0: 206d 6f64 6966 6965 6420 7369 6e63 6520   modified since 
+00017f00: 6c61 7374 2073 796e 632e 0a20 2020 2020  last sync..     
+00017f10: 2020 2020 2020 2069 6620 6d64 2e73 6572         if md.ser
+00017f20: 7665 725f 6d6f 6469 6669 6564 2e74 696d  ver_modified.tim
+00017f30: 6573 7461 6d70 2829 203e 3d20 7365 6c66  estamp() >= self
+00017f40: 2e67 6574 5f6c 6173 745f 7379 6e63 280a  .get_last_sync(.
+00017f50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017f60: 6576 656e 742e 6462 785f 7061 7468 5f6c  event.dbx_path_l
+00017f70: 6f77 6572 0a20 2020 2020 2020 2020 2020  ower.           
+00017f80: 2029 3a0a 2020 2020 2020 2020 2020 2020   ):.            
+00017f90: 2020 2020 7365 6c66 2e5f 6c6f 6767 6572      self._logger
+00017fa0: 2e64 6562 7567 280a 2020 2020 2020 2020  .debug(.        
+00017fb0: 2020 2020 2020 2020 2020 2020 2753 6b69              'Ski
+00017fc0: 7070 696e 6720 6465 6c65 7469 6f6e 3a20  pping deletion: 
+00017fd0: 7265 6d6f 7465 2069 7465 6d20 2225 7322  remote item "%s"
+00017fe0: 2068 6173 2062 6565 6e20 6d6f 6469 6669   has been modifi
+00017ff0: 6564 2027 0a20 2020 2020 2020 2020 2020  ed '.           
+00018000: 2020 2020 2020 2020 2022 7369 6e63 6520           "since 
+00018010: 6c61 7374 2073 796e 6322 2c0a 2020 2020  last sync",.    
+00018020: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018030: 6d64 2e70 6174 685f 6469 7370 6c61 792c  md.path_display,
+00018040: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00018050: 2029 0a20 2020 2020 2020 2020 2020 2020   ).             
+00018060: 2020 2023 204d 6172 6b20 6c6f 6361 6c20     # Mark local 
+00018070: 666f 6c64 6572 2061 7320 756e 7472 6163  folder as untrac
+00018080: 6b65 642e 0a20 2020 2020 2020 2020 2020  ked..           
+00018090: 2020 2020 2073 656c 662e 7265 6d6f 7665       self.remove
+000180a0: 5f6e 6f64 655f 6672 6f6d 5f69 6e64 6578  _node_from_index
+000180b0: 2865 7665 6e74 2e64 6278 5f70 6174 685f  (event.dbx_path_
+000180c0: 6c6f 7765 7229 0a0a 2020 2020 2020 2020  lower)..        
+000180d0: 2020 2020 2020 2020 7265 7475 726e 2053          return S
+000180e0: 796e 6353 7461 7475 732e 536b 6970 7065  yncStatus.Skippe
+000180f0: 640a 0a20 2020 2020 2020 2069 6620 6576  d..        if ev
+00018100: 656e 742e 6973 5f66 696c 6520 616e 6420  ent.is_file and 
+00018110: 6973 696e 7374 616e 6365 286d 642c 2046  isinstance(md, F
+00018120: 6f6c 6465 724d 6574 6164 6174 6129 3a0a  olderMetadata):.
+00018130: 2020 2020 2020 2020 2020 2020 2320 446f              # Do
+00018140: 6e27 7420 6465 6c65 7465 2061 2072 656d  n't delete a rem
+00018150: 6f74 6520 666f 6c64 6572 2069 6620 7765  ote folder if we
+00018160: 2077 6572 6520 6578 7065 6374 696e 6720   were expecting 
+00018170: 6120 6669 6c65 2e0a 2020 2020 2020 2020  a file..        
+00018180: 2020 2020 2320 544f 444f 3a20 4465 6c65      # TODO: Dele
+00018190: 7465 2074 6865 2066 6f6c 6465 7220 6966  te the folder if
+000181a0: 2069 7473 2063 6869 6c64 7265 6e20 6469   its children di
+000181b0: 6420 6e6f 7420 6368 616e 6765 2073 696e  d not change sin
+000181c0: 6365 206c 6173 7420 7379 6e63 2e0a 2020  ce last sync..  
+000181d0: 2020 2020 2020 2020 2020 2320 2020 4973            #   Is
+000181e0: 2074 6865 7265 2061 2077 6179 206f 6620   there a way of 
+000181f0: 6163 6869 6576 696e 6720 7468 6973 2077  achieving this w
+00018200: 6974 686f 7574 206c 6973 7469 6e67 2074  ithout listing t
+00018210: 6865 2066 6f6c 6465 7220 6f72 206c 6973  he folder or lis
+00018220: 7469 6e67 0a20 2020 2020 2020 2020 2020  ting.           
+00018230: 2023 2020 2061 6c6c 2063 6861 6e67 6573   #   all changes
+00018240: 2061 6e64 2063 6865 636b 696e 6720 7768   and checking wh
+00018250: 656e 2074 6865 7920 6f63 6375 7272 6564  en they occurred
+00018260: 3f0a 2020 2020 2020 2020 2020 2020 7365  ?.            se
+00018270: 6c66 2e5f 6c6f 6767 6572 2e64 6562 7567  lf._logger.debug
+00018280: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00018290: 2020 2753 6b69 7070 696e 6720 6465 6c65    'Skipping dele
+000182a0: 7469 6f6e 3a20 6578 7065 6374 6564 2066  tion: expected f
+000182b0: 696c 6520 6174 2022 2573 2220 6275 7420  ile at "%s" but 
+000182c0: 666f 756e 6420 6120 270a 2020 2020 2020  found a '.      
+000182d0: 2020 2020 2020 2020 2020 2266 6f6c 6465            "folde
+000182e0: 7220 696e 7374 6561 6422 2c0a 2020 2020  r instead",.    
+000182f0: 2020 2020 2020 2020 2020 2020 6d64 2e70              md.p
+00018300: 6174 685f 6469 7370 6c61 792c 0a20 2020  ath_display,.   
+00018310: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
+00018320: 2020 2020 2020 2023 204d 6172 6b20 6c6f         # Mark lo
+00018330: 6361 6c20 6669 6c65 2061 7320 756e 7472  cal file as untr
+00018340: 6163 6b65 642e 0a20 2020 2020 2020 2020  acked..         
+00018350: 2020 2073 656c 662e 7265 6d6f 7665 5f6e     self.remove_n
+00018360: 6f64 655f 6672 6f6d 5f69 6e64 6578 2865  ode_from_index(e
+00018370: 7665 6e74 2e64 6278 5f70 6174 685f 6c6f  vent.dbx_path_lo
+00018380: 7765 7229 0a0a 2020 2020 2020 2020 2020  wer)..          
+00018390: 2020 7265 7475 726e 2053 796e 6353 7461    return SyncSta
+000183a0: 7475 732e 536b 6970 7065 640a 0a20 2020  tus.Skipped..   
+000183b0: 2020 2020 2074 7279 3a0a 2020 2020 2020       try:.      
+000183c0: 2020 2020 2020 2320 5769 6c6c 206f 6e6c        # Will onl
+000183d0: 7920 7065 7266 6f72 6d20 6465 6c65 7465  y perform delete
+000183e0: 2069 6620 4472 6f70 626f 7820 7265 6d6f   if Dropbox remo
+000183f0: 7465 2072 6576 206d 6174 6368 6573 2060  te rev matches `
+00018400: 6c6f 6361 6c5f 7265 7660 2e0a 2020 2020  local_rev`..    
+00018410: 2020 2020 2020 2020 7365 6c66 2e63 6c69          self.cli
+00018420: 656e 742e 7265 6d6f 7665 280a 2020 2020  ent.remove(.    
+00018430: 2020 2020 2020 2020 2020 2020 6576 656e              even
+00018440: 742e 6462 785f 7061 7468 2c20 7061 7265  t.dbx_path, pare
+00018450: 6e74 5f72 6576 3d6c 6f63 616c 5f72 6576  nt_rev=local_rev
+00018460: 2069 6620 6576 656e 742e 6973 5f66 696c   if event.is_fil
+00018470: 6520 656c 7365 204e 6f6e 650a 2020 2020  e else None.    
+00018480: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+00018490: 2020 2020 2020 7374 6174 7573 203d 2053        status = S
+000184a0: 796e 6353 7461 7475 732e 446f 6e65 0a20  yncStatus.Done. 
+000184b0: 2020 2020 2020 2065 7863 6570 7420 4e6f         except No
+000184c0: 7446 6f75 6e64 4572 726f 723a 0a20 2020  tFoundError:.   
+000184d0: 2020 2020 2020 2020 2073 656c 662e 5f6c           self._l
+000184e0: 6f67 6765 722e 6465 6275 6728 0a20 2020  ogger.debug(.   
+000184f0: 2020 2020 2020 2020 2020 2020 2027 436f               'Co
+00018500: 756c 6420 6e6f 7420 6465 6c65 7465 2022  uld not delete "
+00018510: 2573 223a 2074 6865 2069 7465 6d20 6e6f  %s": the item no
+00018520: 206c 6f6e 6765 7220 6578 6973 7473 206f   longer exists o
+00018530: 6e20 4472 6f70 626f 7827 2c0a 2020 2020  n Dropbox',.    
+00018540: 2020 2020 2020 2020 2020 2020 6576 656e              even
+00018550: 742e 6462 785f 7061 7468 2c0a 2020 2020  t.dbx_path,.    
+00018560: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+00018570: 2020 2020 2020 7374 6174 7573 203d 2053        status = S
+00018580: 796e 6353 7461 7475 732e 536b 6970 7065  yncStatus.Skippe
+00018590: 640a 2020 2020 2020 2020 6578 6365 7074  d.        except
+000185a0: 2050 6174 6845 7272 6f72 3a0a 2020 2020   PathError:.    
+000185b0: 2020 2020 2020 2020 7365 6c66 2e5f 6c6f          self._lo
+000185c0: 6767 6572 2e64 6562 7567 280a 2020 2020  gger.debug(.    
+000185d0: 2020 2020 2020 2020 2020 2020 2743 6f75              'Cou
+000185e0: 6c64 206e 6f74 2064 656c 6574 6520 2225  ld not delete "%
+000185f0: 7322 3a20 7468 6520 6974 656d 2068 6173  s": the item has
+00018600: 2062 6565 6e20 6368 616e 6765 6420 7369   been changed si
+00018610: 6e63 6520 6c61 7374 2073 796e 6327 2c0a  nce last sync',.
+00018620: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018630: 6576 656e 742e 6462 785f 7061 7468 2c0a  event.dbx_path,.
+00018640: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
+00018650: 2020 2020 2020 2020 2020 7374 6174 7573            status
+00018660: 203d 2053 796e 6353 7461 7475 732e 536b   = SyncStatus.Sk
+00018670: 6970 7065 640a 0a20 2020 2020 2020 2023  ipped..        #
+00018680: 2052 656d 6f76 6520 7265 7669 7369 6f6e   Remove revision
+00018690: 206d 6574 6164 6174 612e 0a20 2020 2020   metadata..     
+000186a0: 2020 2073 656c 662e 7265 6d6f 7665 5f6e     self.remove_n
+000186b0: 6f64 655f 6672 6f6d 5f69 6e64 6578 2865  ode_from_index(e
+000186c0: 7665 6e74 2e64 6278 5f70 6174 685f 6c6f  vent.dbx_path_lo
+000186d0: 7765 7229 0a0a 2020 2020 2020 2020 7265  wer)..        re
+000186e0: 7475 726e 2073 7461 7475 730a 0a20 2020  turn status..   
+000186f0: 2064 6566 205f 6861 6e64 6c65 5f75 706c   def _handle_upl
+00018700: 6f61 645f 636f 6e66 6c69 6374 2873 656c  oad_conflict(sel
+00018710: 662c 206d 645f 6e65 773a 204d 6574 6164  f, md_new: Metad
+00018720: 6174 612c 2065 7665 6e74 3a20 5379 6e63  ata, event: Sync
+00018730: 4576 656e 7429 202d 3e20 626f 6f6c 3a0a  Event) -> bool:.
+00018740: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
+00018750: 2020 2020 4966 2061 2063 6f6e 666c 6963      If a conflic
+00018760: 7469 6e67 2063 6f70 7920 7761 7320 6372  ting copy was cr
+00018770: 6561 7465 6420 6279 2044 726f 7062 6f78  eated by Dropbox
+00018780: 2064 7572 696e 6720 7468 6520 7570 6c6f   during the uplo
+00018790: 6164 2c20 7765 206d 6972 726f 7220 7468  ad, we mirror th
+000187a0: 650a 2020 2020 2020 2020 7265 6d6f 7465  e.        remote
+000187b0: 2063 6861 6e67 6573 206c 6f63 616c 6c79   changes locally
+000187c0: 2e20 5468 6973 206d 6574 686f 6420 6361  . This method ca
+000187d0: 6e20 6f6e 6c79 2062 6520 7573 6564 2066  n only be used f
+000187e0: 6f72 2061 6464 6564 2c20 6368 616e 6765  or added, change
+000187f0: 6420 616e 640a 2020 2020 2020 2020 6d6f  d and.        mo
+00018800: 7665 6420 6576 656e 7473 2e0a 0a20 2020  ved events...   
+00018810: 2020 2020 203a 7061 7261 6d20 6d64 5f6e       :param md_n
+00018820: 6577 3a20 4d65 7461 6461 7461 206f 6620  ew: Metadata of 
+00018830: 6974 656d 2061 6674 6572 2075 706c 6f61  item after uploa
+00018840: 642e 0a20 2020 2020 2020 203a 7061 7261  d..        :para
+00018850: 6d20 6576 656e 743a 204f 7269 6769 6e61  m event: Origina
+00018860: 6c20 7570 6c6f 6164 2073 796e 6320 6576  l upload sync ev
+00018870: 656e 7420 7768 6963 6820 7472 6967 6765  ent which trigge
+00018880: 7265 6420 7468 6520 7570 6c6f 6164 2e0a  red the upload..
+00018890: 2020 2020 2020 2020 3a72 6574 7572 6e73          :returns
+000188a0: 3a20 5768 6574 6865 7220 6120 636f 6e66  : Whether a conf
+000188b0: 6c69 6374 696e 6720 636f 7079 2077 6173  licting copy was
+000188c0: 2063 7265 6174 6564 2e0a 2020 2020 2020   created..      
+000188d0: 2020 2222 220a 2020 2020 2020 2020 6966    """.        if
+000188e0: 2065 7665 6e74 2e69 735f 6465 6c65 7465   event.is_delete
+000188f0: 643a 0a20 2020 2020 2020 2020 2020 2072  d:.            r
+00018900: 6169 7365 2056 616c 7565 4572 726f 7228  aise ValueError(
+00018910: 2243 616e 6e6f 7420 7072 6f63 6573 7320  "Cannot process 
+00018920: 6465 6c65 7465 6420 6576 656e 742e 2229  deleted event.")
+00018930: 0a0a 2020 2020 2020 2020 6966 2073 656c  ..        if sel
+00018940: 662e 6973 5f66 735f 6361 7365 5f73 656e  f.is_fs_case_sen
+00018950: 7369 7469 7665 3a0a 2020 2020 2020 2020  sitive:.        
+00018960: 2020 2020 2320 436f 6d70 6172 6520 756e      # Compare un
+00018970: 2d6e 6f72 6d61 6c69 7a65 6420 6669 6c65  -normalized file
+00018980: 206e 616d 6573 2e20 5468 6973 2065 6e73   names. This ens
+00018990: 7572 6573 2074 6861 7420 7765 206d 6972  ures that we mir
+000189a0: 726f 7220 6c6f 6361 6c6c 7920 616e 790a  ror locally any.
+000189b0: 2020 2020 2020 2020 2020 2020 2320 756e              # un
+000189c0: 6963 6f64 6520 6f72 2063 6173 6520 6e6f  icode or case no
+000189d0: 726d 616c 697a 6174 696f 6e20 7065 7266  rmalization perf
+000189e0: 6f72 6d65 6420 6279 2044 726f 7062 6f78  ormed by Dropbox
+000189f0: 2073 6572 7665 7273 2e0a 2020 2020 2020   servers..      
+00018a00: 2020 2020 2020 6966 206d 645f 6e65 772e        if md_new.
+00018a10: 6e61 6d65 203d 3d20 6f73 702e 6261 7365  name == osp.base
+00018a20: 6e61 6d65 2865 7665 6e74 2e6c 6f63 616c  name(event.local
+00018a30: 5f70 6174 6829 3a0a 2020 2020 2020 2020  _path):.        
+00018a40: 2020 2020 2020 2020 2320 4e6f 2063 6f6e          # No con
+00018a50: 666c 6963 7469 6e67 2063 6f70 7920 7761  flicting copy wa
+00018a60: 7320 6372 6561 7465 642e 0a20 2020 2020  s created..     
+00018a70: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+00018a80: 6e20 4661 6c73 650a 2020 2020 2020 2020  n False.        
+00018a90: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+00018aa0: 2020 2320 436f 6d70 6172 6520 6e6f 726d    # Compare norm
+00018ab0: 616c 697a 6564 2070 6174 6873 2e20 4d69  alized paths. Mi
+00018ac0: 7272 6f72 696e 6720 616e 7920 6e6f 726d  rroring any norm
+00018ad0: 616c 697a 6174 696f 6e20 6368 616e 6765  alization change
+00018ae0: 7320 6c6f 6361 6c6c 7920 6973 0a20 2020  s locally is.   
+00018af0: 2020 2020 2020 2020 2023 206e 6f74 2072           # not r
+00018b00: 6571 7569 7265 6420 6f6e 206e 6f72 6d61  equired on norma
+00018b10: 6c69 7369 6e67 2066 696c 6520 7379 7374  lising file syst
+00018b20: 656d 732e 0a20 2020 2020 2020 2020 2020  ems..           
+00018b30: 2069 6620 6d64 5f6e 6577 2e70 6174 685f   if md_new.path_
+00018b40: 6c6f 7765 7220 3d3d 2065 7665 6e74 2e64  lower == event.d
+00018b50: 6278 5f70 6174 685f 6c6f 7765 723a 0a20  bx_path_lower:. 
+00018b60: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+00018b70: 204e 6f20 636f 6e66 6c69 6374 696e 6720   No conflicting 
+00018b80: 636f 7079 2077 6173 2063 7265 6174 6564  copy was created
+00018b90: 2e0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00018ba0: 2020 7265 7475 726e 2046 616c 7365 0a0a    return False..
+00018bb0: 2020 2020 2020 2020 2320 4765 7420 6e65          # Get ne
+00018bc0: 7720 6c6f 6361 6c20 7061 7468 2063 6f72  w local path cor
+00018bd0: 7265 7370 6f6e 6469 6e67 2074 6f20 6372  responding to cr
+00018be0: 6561 7465 6420 656e 7472 792e 0a20 2020  eated entry..   
+00018bf0: 2020 2020 206c 6f63 616c 5f70 6174 685f       local_path_
+00018c00: 6363 203d 2073 656c 662e 746f 5f6c 6f63  cc = self.to_loc
+00018c10: 616c 5f70 6174 6828 6d64 5f6e 6577 2e70  al_path(md_new.p
+00018c20: 6174 685f 6469 7370 6c61 7929 0a0a 2020  ath_display)..  
+00018c30: 2020 2020 2020 2320 4d6f 7665 2074 6865        # Move the
+00018c40: 206c 6f63 616c 2069 7465 6d2e 0a20 2020   local item..   
+00018c50: 2020 2020 2065 7665 6e74 5f63 6c73 203d       event_cls =
+00018c60: 2044 6972 4d6f 7665 6445 7665 6e74 2069   DirMovedEvent i
+00018c70: 6620 6973 6469 7228 6576 656e 742e 6c6f  f isdir(event.lo
+00018c80: 6361 6c5f 7061 7468 2920 656c 7365 2046  cal_path) else F
+00018c90: 696c 654d 6f76 6564 4576 656e 740a 2020  ileMovedEvent.  
+00018ca0: 2020 2020 2020 7769 7468 2073 656c 662e        with self.
+00018cb0: 6673 5f65 7665 6e74 732e 6967 6e6f 7265  fs_events.ignore
+00018cc0: 2865 7665 6e74 5f63 6c73 2865 7665 6e74  (event_cls(event
+00018cd0: 2e6c 6f63 616c 5f70 6174 682c 206c 6f63  .local_path, loc
+00018ce0: 616c 5f70 6174 685f 6363 2929 3a0a 2020  al_path_cc)):.  
+00018cf0: 2020 2020 2020 2020 2020 7769 7468 2063            with c
+00018d00: 6f6e 7665 7274 5f61 7069 5f65 7272 6f72  onvert_api_error
+00018d10: 7328 293a 0a20 2020 2020 2020 2020 2020  s():.           
+00018d20: 2020 2020 206d 6f76 6528 6576 656e 742e       move(event.
+00018d30: 6c6f 6361 6c5f 7061 7468 2c20 6c6f 6361  local_path, loca
+00018d40: 6c5f 7061 7468 5f63 632c 2072 6169 7365  l_path_cc, raise
+00018d50: 5f65 7272 6f72 3d54 7275 6529 0a0a 2020  _error=True)..  
+00018d60: 2020 2020 2020 2320 4465 6c65 7465 2065        # Delete e
+00018d70: 6e74 7279 206f 6620 6f6c 6420 7061 7468  ntry of old path
+00018d80: 2e0a 2020 2020 2020 2020 7365 6c66 2e72  ..        self.r
+00018d90: 656d 6f76 655f 6e6f 6465 5f66 726f 6d5f  emove_node_from_
+00018da0: 696e 6465 7828 6576 656e 742e 6462 785f  index(event.dbx_
+00018db0: 7061 7468 5f6c 6f77 6572 290a 2020 2020  path_lower).    
+00018dc0: 2020 2020 7365 6c66 2e5f 6c6f 6767 6572      self._logger
+00018dd0: 2e64 6562 7567 280a 2020 2020 2020 2020  .debug(.        
+00018de0: 2020 2020 2755 706c 6f61 6420 636f 6e66      'Upload conf
+00018df0: 6c69 6374 3a20 7265 6e61 6d65 6420 2225  lict: renamed "%
+00018e00: 7322 2074 6f20 2225 7322 272c 0a20 2020  s" to "%s"',.   
+00018e10: 2020 2020 2020 2020 2065 7665 6e74 2e64           event.d
+00018e20: 6278 5f70 6174 682c 0a20 2020 2020 2020  bx_path,.       
+00018e30: 2020 2020 206d 645f 6e65 772e 7061 7468       md_new.path
+00018e40: 5f64 6973 706c 6179 2c0a 2020 2020 2020  _display,.      
+00018e50: 2020 290a 0a20 2020 2020 2020 2072 6574    )..        ret
+00018e60: 7572 6e20 5472 7565 0a0a 2020 2020 6465  urn True..    de
+00018e70: 6620 5f63 6865 636b 5f72 6571 7569 7265  f _check_require
+00018e80: 735f 7570 6c6f 6164 2873 656c 662c 2065  s_upload(self, e
+00018e90: 7665 6e74 3a20 5379 6e63 4576 656e 7429  vent: SyncEvent)
+00018ea0: 202d 3e20 626f 6f6c 3a0a 2020 2020 2020   -> bool:.      
+00018eb0: 2020 2222 220a 2020 2020 2020 2020 4368    """.        Ch
+00018ec0: 6563 6b73 2069 6620 6120 6c6f 6361 6c20  ecks if a local 
+00018ed0: 6669 6c65 206e 6565 6473 2074 6f20 6265  file needs to be
+00018ee0: 2075 706c 6f61 6465 642e 2054 6869 7320   uploaded. This 
+00018ef0: 6973 2064 6574 6572 6d69 6e65 6420 6279  is determined by
+00018f00: 2063 6865 636b 696e 6720 666f 720a 2020   checking for.  
+00018f10: 2020 2020 2020 6571 7561 6c20 6669 6c65        equal file
+00018f20: 2063 6f6e 7465 6e74 732e 2049 6620 6e6f   contents. If no
+00018f30: 2075 706c 6f61 6420 6973 2072 6571 7569   upload is requi
+00018f40: 7265 642c 2074 6865 206c 6f63 616c 2069  red, the local i
+00018f50: 6e64 6578 2069 7320 7570 6461 7465 6420  ndex is updated 
+00018f60: 7769 7468 0a20 2020 2020 2020 2074 6865  with.        the
+00018f70: 2072 656d 6f74 6520 6d65 7461 6461 7461   remote metadata
+00018f80: 2e20 4e6f 7465 2074 6861 7420 636f 6e66  . Note that conf
+00018f90: 6c69 6374 2072 6573 6f6c 7574 696f 6e20  lict resolution 
+00018fa0: 696e 2063 6173 6520 6f66 2064 6966 6665  in case of diffe
+00018fb0: 7265 6e74 2063 6f6e 7465 6e74 0a20 2020  rent content.   
+00018fc0: 2020 2020 2077 696c 6c20 6265 2068 616e       will be han
+00018fd0: 646c 6564 2062 7920 7468 6520 7365 7276  dled by the serv
+00018fe0: 6572 2e0a 0a20 2020 2020 2020 203a 7061  er...        :pa
+00018ff0: 7261 6d20 6576 656e 743a 204c 6f63 616c  ram event: Local
+00019000: 2073 796e 6320 6576 656e 7420 6f66 2061   sync event of a
+00019010: 2066 696c 6520 6372 6561 7469 6f6e 206f   file creation o
+00019020: 7220 6d6f 6469 6669 6361 7469 6f6e 2e0a  r modification..
+00019030: 2020 2020 2020 2020 3a72 6574 7572 6e3a          :return:
+00019040: 2057 6865 7468 6572 2074 6865 2072 656d   Whether the rem
+00019050: 6f74 6520 6974 656d 2068 6173 2074 6865  ote item has the
+00019060: 2073 616d 6520 636f 6e74 656e 7420 6173   same content as
+00019070: 2074 6865 206c 6f63 616c 2073 796e 6320   the local sync 
+00019080: 6576 656e 742e 0a20 2020 2020 2020 2022  event..        "
+00019090: 2222 0a20 2020 2020 2020 2069 6620 6e6f  "".        if no
+000190a0: 7420 2865 7665 6e74 2e69 735f 6669 6c65  t (event.is_file
+000190b0: 2061 6e64 2028 6576 656e 742e 6973 5f63   and (event.is_c
+000190c0: 6861 6e67 6564 206f 7220 6576 656e 742e  hanged or event.
+000190d0: 6973 5f61 6464 6564 2929 3a0a 2020 2020  is_added)):.    
+000190e0: 2020 2020 2020 2020 7261 6973 6520 5661          raise Va
+000190f0: 6c75 6545 7272 6f72 2822 4361 6e20 6f6e  lueError("Can on
+00019100: 6c79 2062 6520 6361 6c6c 6564 2077 6974  ly be called wit
+00019110: 6820 6164 6465 6420 6f72 206d 6f64 6966  h added or modif
+00019120: 6965 6420 6669 6c65 7322 290a 0a20 2020  ied files")..   
+00019130: 2020 2020 206d 645f 6f6c 6420 3d20 7365       md_old = se
+00019140: 6c66 2e63 6c69 656e 742e 6765 745f 6d65  lf.client.get_me
+00019150: 7461 6461 7461 2865 7665 6e74 2e64 6278  tadata(event.dbx
+00019160: 5f70 6174 6829 0a0a 2020 2020 2020 2020  _path)..        
+00019170: 6966 2069 7369 6e73 7461 6e63 6528 6d64  if isinstance(md
+00019180: 5f6f 6c64 2c20 4669 6c65 4d65 7461 6461  _old, FileMetada
+00019190: 7461 293a 0a20 2020 2020 2020 2020 2020  ta):.           
+000191a0: 2069 6620 280a 2020 2020 2020 2020 2020   if (.          
+000191b0: 2020 2020 2020 6576 656e 742e 636f 6e74        event.cont
+000191c0: 656e 745f 6861 7368 203d 3d20 6d64 5f6f  ent_hash == md_o
+000191d0: 6c64 2e63 6f6e 7465 6e74 5f68 6173 680a  ld.content_hash.
+000191e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000191f0: 616e 6420 6576 656e 742e 7379 6d6c 696e  and event.symlin
+00019200: 6b5f 7461 7267 6574 203d 3d20 6d64 5f6f  k_target == md_o
+00019210: 6c64 2e73 796d 6c69 6e6b 5f74 6172 6765  ld.symlink_targe
+00019220: 740a 2020 2020 2020 2020 2020 2020 293a  t.            ):
+00019230: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00019240: 2023 2046 696c 6520 636f 6e74 656e 7473   # File contents
+00019250: 2061 7265 2069 6465 6e74 6963 616c 2c20   are identical, 
+00019260: 646f 206e 6f74 2075 706c 6f61 642e 0a20  do not upload.. 
+00019270: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+00019280: 6861 6e67 655f 7479 7065 203d 2022 4d6f  hange_type = "Mo
+00019290: 6469 6669 6361 7469 6f6e 2220 6966 2065  dification" if e
+000192a0: 7665 6e74 2e69 735f 6368 616e 6765 6420  vent.is_changed 
+000192b0: 656c 7365 2022 4372 6561 7469 6f6e 220a  else "Creation".
+000192c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000192d0: 7365 6c66 2e5f 6c6f 6767 6572 2e64 6562  self._logger.deb
+000192e0: 7567 280a 2020 2020 2020 2020 2020 2020  ug(.            
+000192f0: 2020 2020 2020 2020 2725 7320 6f66 2022          '%s of "
+00019300: 2573 2220 6465 7465 6374 6564 2062 7574  %s" detected but
+00019310: 2066 696c 6520 636f 6e74 656e 7420 6973   file content is
+00019320: 2074 6865 2073 616d 6520 6173 206f 6e20   the same as on 
+00019330: 4472 6f70 626f 7827 2c0a 2020 2020 2020  Dropbox',.      
+00019340: 2020 2020 2020 2020 2020 2020 2020 6368                ch
+00019350: 616e 6765 5f74 7970 652c 0a20 2020 2020  ange_type,.     
+00019360: 2020 2020 2020 2020 2020 2020 2020 2065                 e
+00019370: 7665 6e74 2e64 6278 5f70 6174 682c 0a20  vent.dbx_path,. 
+00019380: 2020 2020 2020 2020 2020 2020 2020 2029                 )
+00019390: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000193a0: 2073 656c 662e 7570 6461 7465 5f69 6e64   self.update_ind
+000193b0: 6578 5f66 726f 6d5f 6462 785f 6d65 7461  ex_from_dbx_meta
+000193c0: 6461 7461 286d 645f 6f6c 6429 0a20 2020  data(md_old).   
+000193d0: 2020 2020 2020 2020 2020 2020 2072 6574               ret
+000193e0: 7572 6e20 4661 6c73 650a 2020 2020 2020  urn False.      
+000193f0: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+00019400: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+00019410: 726e 2054 7275 650a 0a20 2020 2020 2020  rn True..       
+00019420: 2072 6574 7572 6e20 5472 7565 0a0a 2020   return True..  
+00019430: 2020 2320 3d3d 3d3d 2044 6f77 6e6c 6f61    # ==== Downloa
+00019440: 6420 7379 6e63 203d 3d3d 3d3d 3d3d 3d3d  d sync =========
+00019450: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00019460: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00019470: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00019480: 3d3d 3d3d 3d3d 0a0a 2020 2020 6465 6620  ======..    def 
+00019490: 6765 745f 7265 6d6f 7465 5f69 7465 6d28  get_remote_item(
+000194a0: 7365 6c66 2c20 6462 785f 7061 7468 3a20  self, dbx_path: 
+000194b0: 7374 7229 202d 3e20 626f 6f6c 3a0a 2020  str) -> bool:.  
+000194c0: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
+000194d0: 2020 446f 776e 6c6f 6164 7320 6120 7265    Downloads a re
+000194e0: 6d6f 7465 2066 696c 6520 6f72 2066 6f6c  mote file or fol
+000194f0: 6465 7220 616e 6420 7570 6461 7465 7320  der and updates 
+00019500: 6974 7320 6c6f 6361 6c20 7265 762e 2049  its local rev. I
+00019510: 6620 7468 6520 7265 6d6f 7465 2069 7465  f the remote ite
+00019520: 6d0a 2020 2020 2020 2020 646f 6573 206e  m.        does n
+00019530: 6f74 2065 7869 7374 2c20 616e 7920 636f  ot exist, any co
+00019540: 7272 6573 706f 6e64 696e 6720 6c6f 6361  rresponding loca
+00019550: 6c20 6974 656d 7320 7769 6c6c 2062 6520  l items will be 
+00019560: 6465 6c65 7465 642e 2049 6620 6060 6462  deleted. If ``db
+00019570: 785f 7061 7468 6060 0a20 2020 2020 2020  x_path``.       
+00019580: 2072 6566 6572 7320 746f 2061 2066 6f6c   refers to a fol
+00019590: 6465 722c 2074 6865 2064 6f77 6e6c 6f61  der, the downloa
+000195a0: 6420 7769 6c6c 2062 6520 6861 6e64 6c65  d will be handle
+000195b0: 6420 6279 203a 6d65 7468 3a60 5f67 6574  d by :meth:`_get
+000195c0: 5f72 656d 6f74 655f 666f 6c64 6572 602e  _remote_folder`.
+000195d0: 0a20 2020 2020 2020 2049 6620 6974 2072  .        If it r
+000195e0: 6566 6572 7320 746f 2061 2073 696e 676c  efers to a singl
+000195f0: 6520 6669 6c65 2c20 7468 6520 646f 776e  e file, the down
+00019600: 6c6f 6164 2077 696c 6c20 6265 2070 6572  load will be per
+00019610: 666f 726d 6564 2062 790a 2020 2020 2020  formed by.      
+00019620: 2020 3a6d 6574 683a 605f 6372 6561 7465    :meth:`_create
+00019630: 5f6c 6f63 616c 5f65 6e74 7279 602e 0a0a  _local_entry`...
+00019640: 2020 2020 2020 2020 5468 6973 206d 6574          This met
+00019650: 686f 6420 6361 6e20 6265 2075 7365 6420  hod can be used 
+00019660: 746f 2066 6574 6368 2069 6e64 6976 6964  to fetch individ
+00019670: 7561 6c20 6974 656d 7320 6f75 7473 6964  ual items outsid
+00019680: 6520 7468 6520 7265 6775 6c61 7220 7379  e the regular sy
+00019690: 6e63 0a20 2020 2020 2020 2063 7963 6c65  nc.        cycle
+000196a0: 2c20 666f 7220 696e 7374 616e 6365 2077  , for instance w
+000196b0: 6865 6e20 696e 636c 7564 696e 6720 6120  hen including a 
+000196c0: 7072 6576 696f 7573 6c79 2065 7863 6c75  previously exclu
+000196d0: 6465 6420 6669 6c65 206f 7220 666f 6c64  ded file or fold
+000196e0: 6572 2e0a 0a20 2020 2020 2020 203a 7061  er...        :pa
+000196f0: 7261 6d20 6462 785f 7061 7468 3a20 5061  ram dbx_path: Pa
+00019700: 7468 2072 656c 6174 6976 6520 746f 2044  th relative to D
+00019710: 726f 7062 6f78 2066 6f6c 6465 722e 0a20  ropbox folder.. 
+00019720: 2020 2020 2020 203a 7265 7475 726e 733a         :returns:
+00019730: 2057 6865 7468 6572 2064 6f77 6e6c 6f61   Whether downloa
+00019740: 6420 7761 7320 7375 6363 6573 7366 756c  d was successful
+00019750: 2e0a 2020 2020 2020 2020 2222 220a 2020  ..        """.  
+00019760: 2020 2020 2020 7365 6c66 2e5f 6c6f 6767        self._logg
+00019770: 6572 2e69 6e66 6f28 6622 5379 6e63 696e  er.info(f"Syncin
+00019780: 6720 e286 9320 7b64 6278 5f70 6174 687d  g ... {dbx_path}
+00019790: 2229 0a0a 2020 2020 2020 2020 7769 7468  ")..        with
+000197a0: 2073 656c 662e 7379 6e63 5f6c 6f63 6b3a   self.sync_lock:
+000197b0: 0a20 2020 2020 2020 2020 2020 206d 6420  .            md 
+000197c0: 3d20 7365 6c66 2e63 6c69 656e 742e 6765  = self.client.ge
+000197d0: 745f 6d65 7461 6461 7461 2864 6278 5f70  t_metadata(dbx_p
+000197e0: 6174 682c 2069 6e63 6c75 6465 5f64 656c  ath, include_del
+000197f0: 6574 6564 3d54 7275 6529 0a0a 2020 2020  eted=True)..    
+00019800: 2020 2020 2020 2020 6462 785f 7061 7468          dbx_path
+00019810: 5f6c 6f77 6572 203d 206e 6f72 6d61 6c69  _lower = normali
+00019820: 7a65 2864 6278 5f70 6174 6829 0a0a 2020  ze(dbx_path)..  
+00019830: 2020 2020 2020 2020 2020 6966 206d 6420            if md 
+00019840: 6973 204e 6f6e 653a 0a20 2020 2020 2020  is None:.       
+00019850: 2020 2020 2020 2020 2023 2043 7265 6174           # Creat
+00019860: 6520 6120 6661 6b65 2064 656c 6574 6564  e a fake deleted
+00019870: 2065 7665 6e74 2e0a 2020 2020 2020 2020   event..        
+00019880: 2020 2020 2020 2020 696e 6465 785f 656e          index_en
+00019890: 7472 7920 3d20 7365 6c66 2e67 6574 5f69  try = self.get_i
+000198a0: 6e64 6578 5f65 6e74 7279 2864 6278 5f70  ndex_entry(dbx_p
+000198b0: 6174 685f 6c6f 7765 7229 0a20 2020 2020  ath_lower).     
+000198c0: 2020 2020 2020 2020 2020 2063 6173 6564             cased
+000198d0: 5f70 6174 6820 3d20 696e 6465 785f 656e  _path = index_en
+000198e0: 7472 792e 6462 785f 7061 7468 5f63 6173  try.dbx_path_cas
+000198f0: 6564 2069 6620 696e 6465 785f 656e 7472  ed if index_entr
+00019900: 7920 656c 7365 2064 6278 5f70 6174 680a  y else dbx_path.
+00019910: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00019920: 206d 6420 3d20 4465 6c65 7465 644d 6574   md = DeletedMet
+00019930: 6164 6174 6128 0a20 2020 2020 2020 2020  adata(.         
+00019940: 2020 2020 2020 2020 2020 206e 616d 653d             name=
+00019950: 6f73 702e 6261 7365 6e61 6d65 2864 6278  osp.basename(dbx
+00019960: 5f70 6174 6829 2c0a 2020 2020 2020 2020  _path),.        
+00019970: 2020 2020 2020 2020 2020 2020 7061 7468              path
+00019980: 5f6c 6f77 6572 3d64 6278 5f70 6174 685f  _lower=dbx_path_
+00019990: 6c6f 7765 722c 0a20 2020 2020 2020 2020  lower,.         
+000199a0: 2020 2020 2020 2020 2020 2070 6174 685f             path_
+000199b0: 6469 7370 6c61 793d 6361 7365 645f 7061  display=cased_pa
+000199c0: 7468 2c0a 2020 2020 2020 2020 2020 2020  th,.            
+000199d0: 2020 2020 290a 0a20 2020 2020 2020 2020      )..         
+000199e0: 2020 2065 7665 6e74 203d 2053 796e 6345     event = SyncE
+000199f0: 7665 6e74 2e66 726f 6d5f 6d65 7461 6461  vent.from_metada
+00019a00: 7461 286d 642c 2073 656c 6629 0a0a 2020  ta(md, self)..  
+00019a10: 2020 2020 2020 2020 2020 6966 2065 7665            if eve
+00019a20: 6e74 2e69 735f 6469 7265 6374 6f72 793a  nt.is_directory:
+00019a30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00019a40: 2073 7563 6365 7373 203d 2073 656c 662e   success = self.
+00019a50: 5f67 6574 5f72 656d 6f74 655f 666f 6c64  _get_remote_fold
+00019a60: 6572 2864 6278 5f70 6174 6829 0a20 2020  er(dbx_path).   
+00019a70: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
+00019a80: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00019a90: 656c 662e 6163 7469 7669 7479 2e61 6464  elf.activity.add
+00019aa0: 2865 7665 6e74 290a 2020 2020 2020 2020  (event).        
+00019ab0: 2020 2020 2020 2020 6520 3d20 7365 6c66          e = self
+00019ac0: 2e5f 6372 6561 7465 5f6c 6f63 616c 5f65  ._create_local_e
+00019ad0: 6e74 7279 2865 7665 6e74 290a 2020 2020  ntry(event).    
+00019ae0: 2020 2020 2020 2020 2020 2020 7375 6363              succ
+00019af0: 6573 7320 3d20 652e 7374 6174 7573 2069  ess = e.status i
+00019b00: 6e20 2853 796e 6353 7461 7475 732e 446f  n (SyncStatus.Do
+00019b10: 6e65 2c20 5379 6e63 5374 6174 7573 2e53  ne, SyncStatus.S
+00019b20: 6b69 7070 6564 290a 0a20 2020 2020 2020  kipped)..       
+00019b30: 2020 2020 2073 656c 662e 5f63 6c65 6172       self._clear
+00019b40: 5f63 6163 6865 7328 290a 0a20 2020 2020  _caches()..     
+00019b50: 2020 2020 2020 2072 6574 7572 6e20 7375         return su
+00019b60: 6363 6573 730a 0a20 2020 2064 6566 205f  ccess..    def _
+00019b70: 6765 745f 7265 6d6f 7465 5f66 6f6c 6465  get_remote_folde
+00019b80: 7228 7365 6c66 2c20 6462 785f 7061 7468  r(self, dbx_path
+00019b90: 3a20 7374 7229 202d 3e20 626f 6f6c 3a0a  : str) -> bool:.
+00019ba0: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
+00019bb0: 2020 2020 4765 7473 2061 6c6c 2066 696c      Gets all fil
+00019bc0: 6573 2f66 6f6c 6465 7273 2066 726f 6d20  es/folders from 
+00019bd0: 6120 4472 6f70 626f 7820 666f 6c64 6572  a Dropbox folder
+00019be0: 2061 6e64 2077 7269 7465 7320 7468 656d   and writes them
+00019bf0: 2074 6f20 7468 6520 6c6f 6361 6c20 666f   to the local fo
+00019c00: 6c64 6572 0a20 2020 2020 2020 203a 6174  lder.        :at
+00019c10: 7472 3a60 6472 6f70 626f 785f 7061 7468  tr:`dropbox_path
+00019c20: 602e 0a0a 2020 2020 2020 2020 3a70 6172  `...        :par
+00019c30: 616d 2064 6278 5f70 6174 683a 2050 6174  am dbx_path: Pat
+00019c40: 6820 7265 6c61 7469 7665 2074 6f20 4472  h relative to Dr
+00019c50: 6f70 626f 7820 666f 6c64 6572 2e0a 2020  opbox folder..  
+00019c60: 2020 2020 2020 3a72 6574 7572 6e73 3a20        :returns: 
+00019c70: 5768 6574 6865 7220 646f 776e 6c6f 6164  Whether download
+00019c80: 2077 6173 2073 7563 6365 7373 6675 6c2e   was successful.
+00019c90: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
+00019ca0: 2020 2020 2077 6974 6820 7365 6c66 2e73       with self.s
+00019cb0: 796e 635f 6c6f 636b 3a0a 2020 2020 2020  ync_lock:.      
+00019cc0: 2020 2020 2020 7472 793a 0a20 2020 2020        try:.     
+00019cd0: 2020 2020 2020 2020 2020 2069 6478 203d             idx =
+00019ce0: 2030 0a0a 2020 2020 2020 2020 2020 2020   0..            
+00019cf0: 2020 2020 2320 4974 6572 6174 6520 6f76      # Iterate ov
+00019d00: 6572 2069 6e64 6578 2061 6e64 2064 6f77  er index and dow
+00019d10: 6e6c 6f61 6420 7265 7375 6c74 732e 0a20  nload results.. 
+00019d20: 2020 2020 2020 2020 2020 2020 2020 206c                 l
+00019d30: 6973 745f 6974 6572 203d 2073 656c 662e  ist_iter = self.
+00019d40: 636c 6965 6e74 2e6c 6973 745f 666f 6c64  client.list_fold
+00019d50: 6572 5f69 7465 7261 746f 7228 6462 785f  er_iterator(dbx_
+00019d60: 7061 7468 2c20 7265 6375 7273 6976 653d  path, recursive=
+00019d70: 5472 7565 290a 0a20 2020 2020 2020 2020  True)..         
+00019d80: 2020 2020 2020 2066 6f72 2072 6573 2069         for res i
+00019d90: 6e20 6c69 7374 5f69 7465 723a 0a20 2020  n list_iter:.   
+00019da0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019db0: 2069 6478 202b 3d20 6c65 6e28 7265 732e   idx += len(res.
+00019dc0: 656e 7472 6965 7329 0a0a 2020 2020 2020  entries)..      
+00019dd0: 2020 2020 2020 2020 2020 2020 2020 6966                if
+00019de0: 2069 6478 203e 2030 3a0a 2020 2020 2020   idx > 0:.      
+00019df0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019e00: 2020 7365 6c66 2e5f 6c6f 6767 6572 2e69    self._logger.i
+00019e10: 6e66 6f28 6622 496e 6465 7869 6e67 207b  nfo(f"Indexing {
+00019e20: 6964 787d 2e2e 2e22 290a 0a20 2020 2020  idx}...")..     
+00019e30: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+00019e40: 6573 2e65 6e74 7269 6573 2e73 6f72 7428  es.entries.sort(
+00019e50: 6b65 793d 6c61 6d62 6461 2078 3a20 782e  key=lambda x: x.
+00019e60: 7061 7468 5f6c 6f77 6572 2e63 6f75 6e74  path_lower.count
+00019e70: 2822 2f22 2929 0a0a 2020 2020 2020 2020  ("/"))..        
+00019e80: 2020 2020 2020 2020 2020 2020 2320 436f              # Co
+00019e90: 6e76 6572 7420 6d65 7461 6461 7461 2074  nvert metadata t
+00019ea0: 6f20 7379 6e63 5f65 7665 6e74 732e 0a20  o sync_events.. 
+00019eb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019ec0: 2020 2073 796e 635f 6576 656e 7473 203d     sync_events =
+00019ed0: 205b 0a20 2020 2020 2020 2020 2020 2020   [.             
+00019ee0: 2020 2020 2020 2020 2020 2053 796e 6345             SyncE
+00019ef0: 7665 6e74 2e66 726f 6d5f 6d65 7461 6461  vent.from_metada
+00019f00: 7461 286d 642c 2073 656c 6629 2066 6f72  ta(md, self) for
+00019f10: 206d 6420 696e 2072 6573 2e65 6e74 7269   md in res.entri
+00019f20: 6573 0a20 2020 2020 2020 2020 2020 2020  es.             
+00019f30: 2020 2020 2020 205d 0a20 2020 2020 2020         ].       
+00019f40: 2020 2020 2020 2020 2020 2020 2064 6f77               dow
+00019f50: 6e6c 6f61 645f 7265 7320 3d20 7365 6c66  nload_res = self
+00019f60: 2e61 7070 6c79 5f72 656d 6f74 655f 6368  .apply_remote_ch
+00019f70: 616e 6765 7328 7379 6e63 5f65 7665 6e74  anges(sync_event
+00019f80: 7329 0a0a 2020 2020 2020 2020 2020 2020  s)..            
+00019f90: 2020 2020 2020 2020 7375 6363 6573 7320          success 
+00019fa0: 3d20 616c 6c28 0a20 2020 2020 2020 2020  = all(.         
+00019fb0: 2020 2020 2020 2020 2020 2020 2020 2065                 e
+00019fc0: 2e73 7461 7475 7320 696e 2028 5379 6e63  .status in (Sync
+00019fd0: 5374 6174 7573 2e44 6f6e 652c 2053 796e  Status.Done, Syn
+00019fe0: 6353 7461 7475 732e 536b 6970 7065 6429  cStatus.Skipped)
+00019ff0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001a000: 2020 2020 2020 2020 2066 6f72 2065 2069           for e i
+0001a010: 6e20 646f 776e 6c6f 6164 5f72 6573 0a20  n download_res. 
+0001a020: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a030: 2020 2029 0a0a 2020 2020 2020 2020 2020     )..          
+0001a040: 2020 2020 2020 2020 2020 6966 2073 656c            if sel
+0001a050: 662e 5f63 616e 6365 6c5f 7265 7175 6573  f._cancel_reques
+0001a060: 7465 642e 6973 5f73 6574 2829 3a0a 2020  ted.is_set():.  
+0001a070: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a080: 2020 2020 2020 7261 6973 6520 4361 6e63        raise Canc
+0001a090: 656c 6c65 6445 7272 6f72 2822 5379 6e63  elledError("Sync
+0001a0a0: 2063 616e 6365 6c6c 6564 2229 0a0a 2020   cancelled")..  
+0001a0b0: 2020 2020 2020 2020 2020 6578 6365 7074            except
+0001a0c0: 2053 796e 6345 7272 6f72 2061 7320 653a   SyncError as e:
+0001a0d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001a0e0: 2073 656c 662e 5f68 616e 646c 655f 7379   self._handle_sy
+0001a0f0: 6e63 5f65 7272 6f72 2865 2c20 6469 7265  nc_error(e, dire
+0001a100: 6374 696f 6e3d 5379 6e63 4469 7265 6374  ction=SyncDirect
+0001a110: 696f 6e2e 446f 776e 290a 2020 2020 2020  ion.Down).      
+0001a120: 2020 2020 2020 2020 2020 7265 7475 726e            return
+0001a130: 2046 616c 7365 0a0a 2020 2020 2020 2020   False..        
+0001a140: 2020 2020 7265 7475 726e 2073 7563 6365      return succe
+0001a150: 7373 0a0a 2020 2020 6465 6620 7761 6974  ss..    def wait
+0001a160: 5f66 6f72 5f72 656d 6f74 655f 6368 616e  _for_remote_chan
+0001a170: 6765 7328 0a20 2020 2020 2020 2073 656c  ges(.        sel
+0001a180: 662c 0a20 2020 2020 2020 206c 6173 745f  f,.        last_
+0001a190: 6375 7273 6f72 3a20 7374 722c 0a20 2020  cursor: str,.   
+0001a1a0: 2020 2020 2074 696d 656f 7574 3a20 696e       timeout: in
+0001a1b0: 7420 3d20 3430 2c0a 2020 2020 2920 2d3e  t = 40,.    ) ->
+0001a1c0: 2062 6f6f 6c3a 0a20 2020 2020 2020 2022   bool:.        "
+0001a1d0: 2222 0a20 2020 2020 2020 2042 6c6f 636b  "".        Block
+0001a1e0: 7320 756e 7469 6c20 6368 616e 6765 7320  s until changes 
+0001a1f0: 746f 2074 6865 2072 656d 6f74 6520 4472  to the remote Dr
+0001a200: 6f70 626f 7820 6172 6520 6176 6169 6c61  opbox are availa
+0001a210: 626c 652e 0a0a 2020 2020 2020 2020 3a70  ble...        :p
+0001a220: 6172 616d 206c 6173 745f 6375 7273 6f72  aram last_cursor
+0001a230: 3a20 4375 7273 6f72 2066 6f72 6d20 6c61  : Cursor form la
+0001a240: 7374 2073 796e 632e 0a20 2020 2020 2020  st sync..       
+0001a250: 203a 7061 7261 6d20 7469 6d65 6f75 743a   :param timeout:
+0001a260: 2054 696d 656f 7574 2069 6e20 7365 636f   Timeout in seco
+0001a270: 6e64 7320 6265 666f 7265 2072 6574 7572  nds before retur
+0001a280: 6e69 6e67 2065 7665 6e20 6966 2074 6865  ning even if the
+0001a290: 7265 2061 7265 206e 6f0a 2020 2020 2020  re are no.      
+0001a2a0: 2020 2020 2020 6368 616e 6765 732e 2044        changes. D
+0001a2b0: 726f 7062 6f78 2061 6464 7320 7261 6e64  ropbox adds rand
+0001a2c0: 6f6d 206a 6974 7465 7220 6f66 2075 7020  om jitter of up 
+0001a2d0: 746f 2039 3020 7365 6320 746f 2074 6869  to 90 sec to thi
+0001a2e0: 7320 7661 6c75 652e 0a20 2020 2020 2020  s value..       
+0001a2f0: 203a 7265 7475 726e 733a 2060 6054 7275   :returns: ``Tru
+0001a300: 6560 6020 6966 2063 6861 6e67 6573 2061  e`` if changes a
+0001a310: 7265 2061 7661 696c 6162 6c65 2c20 6060  re available, ``
+0001a320: 4661 6c73 6560 6020 6f74 6865 7277 6973  False`` otherwis
+0001a330: 652e 0a20 2020 2020 2020 2022 2222 0a20  e..        """. 
+0001a340: 2020 2020 2020 2073 656c 662e 5f6c 6f67         self._log
+0001a350: 6765 722e 6465 6275 6728 2257 6169 7469  ger.debug("Waiti
+0001a360: 6e67 2066 6f72 2072 656d 6f74 6520 6368  ng for remote ch
+0001a370: 616e 6765 7320 7369 6e63 6520 6375 7273  anges since curs
+0001a380: 6f72 3a5c 6e25 7322 2c20 6c61 7374 5f63  or:\n%s", last_c
+0001a390: 7572 736f 7229 0a20 2020 2020 2020 2068  ursor).        h
+0001a3a0: 6173 5f63 6861 6e67 6573 203d 2073 656c  as_changes = sel
+0001a3b0: 662e 636c 6965 6e74 2e77 6169 745f 666f  f.client.wait_fo
+0001a3c0: 725f 7265 6d6f 7465 5f63 6861 6e67 6573  r_remote_changes
+0001a3d0: 286c 6173 745f 6375 7273 6f72 2c20 7469  (last_cursor, ti
+0001a3e0: 6d65 6f75 743d 7469 6d65 6f75 7429 0a0a  meout=timeout)..
+0001a3f0: 2020 2020 2020 2020 2320 5761 6974 2066          # Wait f
+0001a400: 6f72 2032 2073 6563 2e20 5468 6973 2064  or 2 sec. This d
+0001a410: 656c 6179 2069 7320 7479 7069 6361 6c6c  elay is typicall
+0001a420: 7920 6f6e 6c79 206e 6563 6573 7361 7279  y only necessary
+0001a430: 2066 6f6c 6465 7273 2061 7265 2073 6861   folders are sha
+0001a440: 7265 6420 2f0a 2020 2020 2020 2020 2320  red /.        # 
+0001a450: 756e 2d73 6861 7265 6420 7769 7468 206f  un-shared with o
+0001a460: 7468 6572 2044 726f 7062 6f78 2061 6363  ther Dropbox acc
+0001a470: 6f75 6e74 732e 0a20 2020 2020 2020 2074  ounts..        t
+0001a480: 696d 652e 736c 6565 7028 3229 0a0a 2020  ime.sleep(2)..  
+0001a490: 2020 2020 2020 7365 6c66 2e5f 6c6f 6767        self._logg
+0001a4a0: 6572 2e64 6562 7567 2822 4465 7465 6374  er.debug("Detect
+0001a4b0: 6564 2072 656d 6f74 6520 6368 616e 6765  ed remote change
+0001a4c0: 733a 2025 7322 2c20 6861 735f 6368 616e  s: %s", has_chan
+0001a4d0: 6765 7329 0a20 2020 2020 2020 2072 6574  ges).        ret
+0001a4e0: 7572 6e20 6861 735f 6368 616e 6765 730a  urn has_changes.
+0001a4f0: 0a20 2020 2064 6566 2064 6f77 6e6c 6f61  .    def downloa
+0001a500: 645f 7379 6e63 5f63 7963 6c65 2873 656c  d_sync_cycle(sel
+0001a510: 6629 202d 3e20 4e6f 6e65 3a0a 2020 2020  f) -> None:.    
+0001a520: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
+0001a530: 5065 7266 6f72 6d73 2061 2066 756c 6c20  Performs a full 
+0001a540: 646f 776e 6c6f 6164 2073 796e 6320 6379  download sync cy
+0001a550: 636c 6520 6279 2063 616c 6c69 6e67 2069  cle by calling i
+0001a560: 6e20 6f72 6465 723a 0a0a 2020 2020 2020  n order:..      
+0001a570: 2020 2020 2020 3129 203a 6d65 7468 3a60        1) :meth:`
+0001a580: 6c69 7374 5f72 656d 6f74 655f 6368 616e  list_remote_chan
+0001a590: 6765 735f 6974 6572 6174 6f72 600a 2020  ges_iterator`.  
+0001a5a0: 2020 2020 2020 2020 2020 3229 203a 6d65            2) :me
+0001a5b0: 7468 3a60 6170 706c 795f 7265 6d6f 7465  th:`apply_remote
+0001a5c0: 5f63 6861 6e67 6573 600a 0a20 2020 2020  _changes`..     
+0001a5d0: 2020 2048 616e 646c 6573 2075 7064 6174     Handles updat
+0001a5e0: 696e 6720 7468 6520 7265 6d6f 7465 2063  ing the remote c
+0001a5f0: 7572 736f 7220 616e 6420 7265 7375 6d69  ursor and resumi
+0001a600: 6e67 2069 6e74 6572 7275 7074 6564 2073  ng interrupted s
+0001a610: 796e 6373 2066 6f72 2079 6f75 2e0a 2020  yncs for you..  
+0001a620: 2020 2020 2020 4361 6c6c 696e 6720 7468        Calling th
+0001a630: 6973 206d 6574 686f 6420 7769 6c6c 2070  is method will p
+0001a640: 6572 666f 726d 2061 2066 756c 6c20 696e  erform a full in
+0001a650: 6465 7869 6e67 2069 6620 7468 6973 2069  dexing if this i
+0001a660: 7320 7468 6520 6669 7273 7420 646f 776e  s the first down
+0001a670: 6c6f 6164 2e0a 2020 2020 2020 2020 2222  load..        ""
+0001a680: 220a 2020 2020 2020 2020 7769 7468 2073  ".        with s
+0001a690: 656c 662e 7379 6e63 5f6c 6f63 6b3a 0a20  elf.sync_lock:. 
+0001a6a0: 2020 2020 2020 2020 2020 2069 6620 7365             if se
+0001a6b0: 6c66 2e72 656d 6f74 655f 6375 7273 6f72  lf.remote_cursor
+0001a6c0: 203d 3d20 2222 3a0a 2020 2020 2020 2020   == "":.        
+0001a6d0: 2020 2020 2020 2020 7365 6c66 2e5f 7374          self._st
+0001a6e0: 6174 652e 7365 7428 2273 796e 6322 2c20  ate.set("sync", 
+0001a6f0: 226c 6173 745f 7265 696e 6465 7822 2c20  "last_reindex", 
+0001a700: 7469 6d65 2e74 696d 6528 2929 0a20 2020  time.time()).   
+0001a710: 2020 2020 2020 2020 2020 2020 2073 656c               sel
+0001a720: 662e 5f73 7461 7465 2e73 6574 2822 7379  f._state.set("sy
+0001a730: 6e63 222c 2022 6469 645f 6669 6e69 7368  nc", "did_finish
+0001a740: 5f69 6e64 6578 696e 6722 2c20 4661 6c73  _indexing", Fals
+0001a750: 6529 0a20 2020 2020 2020 2020 2020 2020  e).             
+0001a760: 2020 2073 656c 662e 5f73 7461 7465 2e73     self._state.s
+0001a770: 6574 2822 7379 6e63 222c 2022 696e 6465  et("sync", "inde
+0001a780: 7869 6e67 5f63 6f75 6e74 6572 222c 2030  xing_counter", 0
+0001a790: 290a 0a20 2020 2020 2020 2020 2020 2069  )..            i
+0001a7a0: 6478 203d 2073 656c 662e 5f73 7461 7465  dx = self._state
+0001a7b0: 2e67 6574 2822 7379 6e63 222c 2022 696e  .get("sync", "in
+0001a7c0: 6465 7869 6e67 5f63 6f75 6e74 6572 2229  dexing_counter")
+0001a7d0: 0a20 2020 2020 2020 2020 2020 2069 735f  .            is_
+0001a7e0: 696e 6465 7869 6e67 203d 206e 6f74 2073  indexing = not s
+0001a7f0: 656c 662e 5f73 7461 7465 2e67 6574 2822  elf._state.get("
+0001a800: 7379 6e63 222c 2022 6469 645f 6669 6e69  sync", "did_fini
+0001a810: 7368 5f69 6e64 6578 696e 6722 290a 0a20  sh_indexing").. 
+0001a820: 2020 2020 2020 2020 2020 2069 6620 6973             if is
+0001a830: 5f69 6e64 6578 696e 6720 616e 6420 6964  _indexing and id
+0001a840: 7820 3d3d 2030 3a0a 2020 2020 2020 2020  x == 0:.        
+0001a850: 2020 2020 2020 2020 7365 6c66 2e5f 6c6f          self._lo
+0001a860: 6767 6572 2e69 6e66 6f28 2249 6e64 6578  gger.info("Index
+0001a870: 696e 6720 7265 6d6f 7465 2044 726f 7062  ing remote Dropb
+0001a880: 6f78 2229 0a20 2020 2020 2020 2020 2020  ox").           
+0001a890: 2065 6c69 6620 6973 5f69 6e64 6578 696e   elif is_indexin
+0001a8a0: 673a 0a20 2020 2020 2020 2020 2020 2020  g:.             
+0001a8b0: 2020 2073 656c 662e 5f6c 6f67 6765 722e     self._logger.
+0001a8c0: 696e 666f 2822 5265 7375 6d69 6e67 2069  info("Resuming i
+0001a8d0: 6e64 6578 696e 6722 290a 2020 2020 2020  ndexing").      
+0001a8e0: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+0001a8f0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+0001a900: 2e5f 6c6f 6767 6572 2e69 6e66 6f28 2246  ._logger.info("F
+0001a910: 6574 6368 696e 6720 7265 6d6f 7465 2063  etching remote c
+0001a920: 6861 6e67 6573 2229 0a0a 2020 2020 2020  hanges")..      
+0001a930: 2020 2020 2020 6368 616e 6765 735f 6974        changes_it
+0001a940: 6572 203d 2073 656c 662e 6c69 7374 5f72  er = self.list_r
+0001a950: 656d 6f74 655f 6368 616e 6765 735f 6974  emote_changes_it
+0001a960: 6572 6174 6f72 2873 656c 662e 7265 6d6f  erator(self.remo
+0001a970: 7465 5f63 7572 736f 7229 0a0a 2020 2020  te_cursor)..    
+0001a980: 2020 2020 2020 2020 2320 446f 776e 6c6f          # Downlo
+0001a990: 6164 2063 6861 6e67 6573 2069 6e20 6368  ad changes in ch
+0001a9a0: 756e 6b73 2074 6f20 7265 6475 6365 206d  unks to reduce m
+0001a9b0: 656d 6f72 7920 7573 6167 652e 0a20 2020  emory usage..   
+0001a9c0: 2020 2020 2020 2020 2066 6f72 2063 6861           for cha
+0001a9d0: 6e67 6573 2c20 6375 7273 6f72 2069 6e20  nges, cursor in 
+0001a9e0: 6368 616e 6765 735f 6974 6572 3a0a 2020  changes_iter:.  
+0001a9f0: 2020 2020 2020 2020 2020 2020 2020 6964                id
+0001aa00: 7820 2b3d 206c 656e 2863 6861 6e67 6573  x += len(changes
+0001aa10: 290a 0a20 2020 2020 2020 2020 2020 2020  )..             
+0001aa20: 2020 2069 6620 6964 7820 3e20 303a 0a20     if idx > 0:. 
+0001aa30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001aa40: 2020 2073 656c 662e 5f6c 6f67 6765 722e     self._logger.
+0001aa50: 696e 666f 2866 2249 6e64 6578 696e 6720  info(f"Indexing 
+0001aa60: 7b69 6478 7d2e 2e2e 2229 0a0a 2020 2020  {idx}...")..    
+0001aa70: 2020 2020 2020 2020 2020 2020 646f 776e              down
+0001aa80: 6c6f 6164 6564 203d 2073 656c 662e 6170  loaded = self.ap
+0001aa90: 706c 795f 7265 6d6f 7465 5f63 6861 6e67  ply_remote_chang
+0001aaa0: 6573 2863 6861 6e67 6573 290a 0a20 2020  es(changes)..   
+0001aab0: 2020 2020 2020 2020 2020 2020 2023 2053               # S
+0001aac0: 6176 6520 2869 6e63 7265 6d65 6e74 616c  ave (incremental
+0001aad0: 2920 7265 6d6f 7465 2063 7572 736f 722e  ) remote cursor.
+0001aae0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001aaf0: 2073 656c 662e 7265 6d6f 7465 5f63 7572   self.remote_cur
+0001ab00: 736f 7220 3d20 6375 7273 6f72 0a20 2020  sor = cursor.   
+0001ab10: 2020 2020 2020 2020 2020 2020 2073 656c               sel
+0001ab20: 662e 5f73 7461 7465 2e73 6574 2822 7379  f._state.set("sy
+0001ab30: 6e63 222c 2022 696e 6465 7869 6e67 5f63  nc", "indexing_c
+0001ab40: 6f75 6e74 6572 222c 2069 6478 290a 0a20  ounter", idx).. 
+0001ab50: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+0001ab60: 2053 656e 6420 6465 736b 746f 7020 6e6f   Send desktop no
+0001ab70: 7469 6669 6361 7469 6f6e 7320 7768 656e  tifications when
+0001ab80: 206e 6f74 2069 6e64 6578 696e 672e 0a20   not indexing.. 
+0001ab90: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+0001aba0: 6620 6e6f 7420 6973 5f69 6e64 6578 696e  f not is_indexin
+0001abb0: 673a 0a20 2020 2020 2020 2020 2020 2020  g:.             
+0001abc0: 2020 2020 2020 2073 656c 662e 6e6f 7469         self.noti
+0001abd0: 6679 5f75 7365 7228 646f 776e 6c6f 6164  fy_user(download
+0001abe0: 6564 290a 0a20 2020 2020 2020 2020 2020  ed)..           
+0001abf0: 2020 2020 2069 6620 7365 6c66 2e5f 6361       if self._ca
+0001ac00: 6e63 656c 5f72 6571 7565 7374 6564 2e69  ncel_requested.i
+0001ac10: 735f 7365 7428 293a 0a20 2020 2020 2020  s_set():.       
+0001ac20: 2020 2020 2020 2020 2020 2020 2072 6169               rai
+0001ac30: 7365 2043 616e 6365 6c6c 6564 4572 726f  se CancelledErro
+0001ac40: 7228 2253 796e 6320 6361 6e63 656c 6c65  r("Sync cancelle
+0001ac50: 6422 290a 0a20 2020 2020 2020 2020 2020  d")..           
+0001ac60: 2020 2020 2023 2046 7265 6520 6d65 6d6f       # Free memo
+0001ac70: 7279 2065 6172 6c79 2074 6f20 7072 6576  ry early to prev
+0001ac80: 656e 7420 6672 6167 6d65 6e74 6174 696f  ent fragmentatio
+0001ac90: 6e2e 0a20 2020 2020 2020 2020 2020 2020  n..             
+0001aca0: 2020 2064 656c 2063 6861 6e67 6573 0a20     del changes. 
+0001acb0: 2020 2020 2020 2020 2020 2020 2020 2064                 d
+0001acc0: 656c 2064 6f77 6e6c 6f61 6465 640a 2020  el downloaded.  
+0001acd0: 2020 2020 2020 2020 2020 2020 2020 6763                gc
+0001ace0: 2e63 6f6c 6c65 6374 2829 0a0a 2020 2020  .collect()..    
+0001acf0: 2020 2020 2020 2020 7365 6c66 2e5f 7374          self._st
+0001ad00: 6174 652e 7365 7428 2273 796e 6322 2c20  ate.set("sync", 
+0001ad10: 2264 6964 5f66 696e 6973 685f 696e 6465  "did_finish_inde
+0001ad20: 7869 6e67 222c 2054 7275 6529 0a20 2020  xing", True).   
+0001ad30: 2020 2020 2020 2020 2073 656c 662e 5f73           self._s
+0001ad40: 7461 7465 2e73 6574 2822 7379 6e63 222c  tate.set("sync",
+0001ad50: 2022 696e 6465 7869 6e67 5f63 6f75 6e74   "indexing_count
+0001ad60: 6572 222c 2030 290a 0a20 2020 2020 2020  er", 0)..       
+0001ad70: 2020 2020 2069 6620 6964 7820 3e20 303a       if idx > 0:
+0001ad80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001ad90: 2073 656c 662e 5f6c 6f67 6765 722e 696e   self._logger.in
+0001ada0: 666f 2849 444c 4529 0a0a 2020 2020 2020  fo(IDLE)..      
+0001adb0: 2020 2020 2020 7365 6c66 2e5f 636c 6561        self._clea
+0001adc0: 725f 6361 6368 6573 2829 0a0a 2020 2020  r_caches()..    
+0001add0: 6465 6620 6c69 7374 5f72 656d 6f74 655f  def list_remote_
+0001ade0: 6368 616e 6765 735f 6974 6572 6174 6f72  changes_iterator
+0001adf0: 280a 2020 2020 2020 2020 7365 6c66 2c20  (.        self, 
+0001ae00: 6c61 7374 5f63 7572 736f 723a 2073 7472  last_cursor: str
+0001ae10: 0a20 2020 2029 202d 3e20 4974 6572 6174  .    ) -> Iterat
+0001ae20: 6f72 5b74 7570 6c65 5b6c 6973 745b 5379  or[tuple[list[Sy
+0001ae30: 6e63 4576 656e 745d 2c20 7374 725d 5d3a  ncEvent], str]]:
+0001ae40: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
+0001ae50: 2020 2020 2047 6574 2072 656d 6f74 6520       Get remote 
+0001ae60: 6368 616e 6765 7320 7369 6e63 6520 7468  changes since th
+0001ae70: 6520 6c61 7374 2064 6f77 6e6c 6f61 6420  e last download 
+0001ae80: 7379 6e63 2c20 6173 2073 7065 6369 6669  sync, as specifi
+0001ae90: 6564 2062 790a 2020 2020 2020 2020 6060  ed by.        ``
+0001aea0: 6c61 7374 5f63 7572 736f 7260 602e 2049  last_cursor``. I
+0001aeb0: 6620 7468 6520 6060 6c61 7374 5f63 7572  f the ``last_cur
+0001aec0: 736f 7260 6020 6973 2066 726f 6d20 7061  sor`` is from pa
+0001aed0: 6769 6e61 7469 6e67 2074 6872 6f75 6768  ginating through
+0001aee0: 2061 2070 7265 7669 6f75 730a 2020 2020   a previous.    
+0001aef0: 2020 2020 7365 7420 6f66 2063 6861 6e67      set of chang
+0001af00: 6573 2c20 636f 6e74 696e 7565 2077 6865  es, continue whe
+0001af10: 7265 2077 6520 6c65 6674 206f 6666 2e20  re we left off. 
+0001af20: 4966 2060 606c 6173 745f 6375 7273 6f72  If ``last_cursor
+0001af30: 6060 2069 7320 616e 2065 6d70 7479 0a20  `` is an empty. 
+0001af40: 2020 2020 2020 2073 7472 696e 672c 2070         string, p
+0001af50: 6572 666f 726d 2061 2066 756c 6c20 696e  erform a full in
+0001af60: 6465 7869 6e67 206f 6620 7468 6520 4472  dexing of the Dr
+0001af70: 6f70 626f 7820 666f 6c64 6572 2e0a 0a20  opbox folder... 
+0001af80: 2020 2020 2020 203a 7061 7261 6d20 6c61         :param la
+0001af90: 7374 5f63 7572 736f 723a 2043 7572 736f  st_cursor: Curso
+0001afa0: 7220 6672 6f6d 206c 6173 7420 646f 776e  r from last down
+0001afb0: 6c6f 6164 2073 796e 632e 0a20 2020 2020  load sync..     
+0001afc0: 2020 203a 7265 7475 726e 733a 2049 7465     :returns: Ite
+0001afd0: 7261 746f 7220 7969 656c 6469 6e67 2074  rator yielding t
+0001afe0: 7570 6c65 7320 7769 7468 2072 656d 6f74  uples with remot
+0001aff0: 6520 6368 616e 6765 7320 616e 6420 636f  e changes and co
+0001b000: 7272 6573 706f 6e64 696e 6720 6375 7273  rresponding curs
+0001b010: 6f72 2e0a 2020 2020 2020 2020 2222 220a  or..        """.
+0001b020: 2020 2020 2020 2020 6966 206c 6173 745f          if last_
+0001b030: 6375 7273 6f72 203d 3d20 2222 3a0a 2020  cursor == "":.  
+0001b040: 2020 2020 2020 2020 2020 2320 5765 2061            # We a
+0001b050: 7265 2073 7461 7274 696e 6720 6672 6f6d  re starting from
+0001b060: 2074 6865 2062 6567 696e 6e69 6e67 2c20   the beginning, 
+0001b070: 646f 2061 2066 756c 6c20 696e 6465 7869  do a full indexi
+0001b080: 6e67 2e0a 2020 2020 2020 2020 2020 2020  ng..            
+0001b090: 6368 616e 6765 735f 6974 6572 203d 2073  changes_iter = s
+0001b0a0: 656c 662e 636c 6965 6e74 2e6c 6973 745f  elf.client.list_
+0001b0b0: 666f 6c64 6572 5f69 7465 7261 746f 7228  folder_iterator(
+0001b0c0: 222f 222c 2072 6563 7572 7369 7665 3d54  "/", recursive=T
+0001b0d0: 7275 6529 0a20 2020 2020 2020 2065 6c73  rue).        els
+0001b0e0: 653a 0a20 2020 2020 2020 2020 2020 2023  e:.            #
+0001b0f0: 2050 6963 6b20 7570 2077 6865 7265 2077   Pick up where w
+0001b100: 6520 6c65 6674 206f 6666 2e20 5468 6973  e left off. This
+0001b110: 206d 6179 2062 6520 616e 2069 6e74 6572   may be an inter
+0001b120: 7275 7074 6564 2069 6e64 6578 696e 6720  rupted indexing 
+0001b130: 2f0a 2020 2020 2020 2020 2020 2020 2320  /.            # 
+0001b140: 7061 6769 6e61 7469 6f6e 2074 6872 6f75  pagination throu
+0001b150: 6768 2063 6861 6e67 6573 206f 7220 6120  gh changes or a 
+0001b160: 636f 6d70 6c65 7465 6c79 206e 6577 2073  completely new s
+0001b170: 6574 206f 6620 6368 616e 6765 732e 0a20  et of changes.. 
+0001b180: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+0001b190: 5f6c 6f67 6765 722e 6465 6275 6728 2246  _logger.debug("F
+0001b1a0: 6574 6368 696e 6720 7265 6d6f 7465 2063  etching remote c
+0001b1b0: 6861 6e67 6573 2073 696e 6365 2063 7572  hanges since cur
+0001b1c0: 736f 723a 2025 7322 2c20 6c61 7374 5f63  sor: %s", last_c
+0001b1d0: 7572 736f 7229 0a20 2020 2020 2020 2020  ursor).         
+0001b1e0: 2020 2063 6861 6e67 6573 5f69 7465 7220     changes_iter 
+0001b1f0: 3d20 7365 6c66 2e63 6c69 656e 742e 6c69  = self.client.li
+0001b200: 7374 5f72 656d 6f74 655f 6368 616e 6765  st_remote_change
+0001b210: 735f 6974 6572 6174 6f72 286c 6173 745f  s_iterator(last_
+0001b220: 6375 7273 6f72 290a 0a20 2020 2020 2020  cursor)..       
+0001b230: 2066 6f72 2063 6861 6e67 6573 2069 6e20   for changes in 
+0001b240: 6368 616e 6765 735f 6974 6572 3a0a 2020  changes_iter:.  
+0001b250: 2020 2020 2020 2020 2020 6368 616e 6765            change
+0001b260: 7320 3d20 7365 6c66 2e5f 636c 6561 6e5f  s = self._clean_
+0001b270: 7265 6d6f 7465 5f63 6861 6e67 6573 2863  remote_changes(c
+0001b280: 6861 6e67 6573 290a 2020 2020 2020 2020  hanges).        
+0001b290: 2020 2020 6368 616e 6765 732e 656e 7472      changes.entr
+0001b2a0: 6965 732e 736f 7274 286b 6579 3d6c 616d  ies.sort(key=lam
+0001b2b0: 6264 6120 783a 2078 2e70 6174 685f 6c6f  bda x: x.path_lo
+0001b2c0: 7765 722e 636f 756e 7428 222f 2229 290a  wer.count("/")).
+0001b2d0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+0001b2e0: 662e 5f6c 6f67 6765 722e 6465 6275 6728  f._logger.debug(
+0001b2f0: 2252 656d 6f74 6520 6368 616e 6765 733a  "Remote changes:
+0001b300: 5c6e 2573 222c 2070 665f 7265 7072 2863  \n%s", pf_repr(c
+0001b310: 6861 6e67 6573 2e65 6e74 7269 6573 2929  hanges.entries))
+0001b320: 0a0a 2020 2020 2020 2020 2020 2020 7379  ..            sy
+0001b330: 6e63 5f65 7665 6e74 7320 3d20 5b53 796e  nc_events = [Syn
+0001b340: 6345 7665 6e74 2e66 726f 6d5f 6d65 7461  cEvent.from_meta
+0001b350: 6461 7461 286d 642c 2073 656c 6629 2066  data(md, self) f
+0001b360: 6f72 206d 6420 696e 2063 6861 6e67 6573  or md in changes
+0001b370: 2e65 6e74 7269 6573 5d0a 0a20 2020 2020  .entries]..     
+0001b380: 2020 2020 2020 2073 656c 662e 5f6c 6f67         self._log
+0001b390: 6765 722e 6465 6275 6728 2243 6f6e 7665  ger.debug("Conve
+0001b3a0: 7274 6564 2072 656d 6f74 6520 6368 616e  rted remote chan
+0001b3b0: 6765 7320 746f 2053 796e 6345 7665 6e74  ges to SyncEvent
+0001b3c0: 7322 290a 0a20 2020 2020 2020 2020 2020  s")..           
+0001b3d0: 2079 6965 6c64 2073 796e 635f 6576 656e   yield sync_even
+0001b3e0: 7473 2c20 6368 616e 6765 732e 6375 7273  ts, changes.curs
+0001b3f0: 6f72 0a0a 2020 2020 6465 6620 6170 706c  or..    def appl
+0001b400: 795f 7265 6d6f 7465 5f63 6861 6e67 6573  y_remote_changes
+0001b410: 280a 2020 2020 2020 2020 7365 6c66 2c20  (.        self, 
+0001b420: 7379 6e63 5f65 7665 6e74 733a 2043 6f6c  sync_events: Col
+0001b430: 6c65 6374 696f 6e5b 5379 6e63 4576 656e  lection[SyncEven
+0001b440: 745d 0a20 2020 2029 202d 3e20 6c69 7374  t].    ) -> list
+0001b450: 5b53 796e 6345 7665 6e74 5d3a 0a20 2020  [SyncEvent]:.   
+0001b460: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
+0001b470: 2041 7070 6c69 6573 2072 656d 6f74 6520   Applies remote 
+0001b480: 6368 616e 6765 7320 746f 206c 6f63 616c  changes to local
+0001b490: 2066 6f6c 6465 722e 2043 616c 6c20 7468   folder. Call th
+0001b4a0: 6973 206f 6e20 7468 6520 7265 7375 6c74  is on the result
+0001b4b0: 206f 660a 2020 2020 2020 2020 3a6d 6574   of.        :met
+0001b4c0: 683a 606c 6973 745f 7265 6d6f 7465 5f63  h:`list_remote_c
+0001b4d0: 6861 6e67 6573 602e 2054 6865 2073 6176  hanges`. The sav
+0001b4e0: 6564 2063 7572 736f 7220 6973 2075 7064  ed cursor is upd
+0001b4f0: 6174 6564 2061 6674 6572 2061 2073 6574  ated after a set
+0001b500: 206f 6620 6368 616e 6765 730a 2020 2020   of changes.    
+0001b510: 2020 2020 6861 7320 6265 656e 2073 7563      has been suc
+0001b520: 6365 7373 6675 6c6c 7920 6170 706c 6965  cessfully applie
+0001b530: 642e 2045 6e74 7269 6573 2069 6e20 7468  d. Entries in th
+0001b540: 6520 6c6f 6361 6c20 696e 6465 7820 6172  e local index ar
+0001b550: 6520 6372 6561 7465 6420 6166 7465 720a  e created after.
+0001b560: 2020 2020 2020 2020 7375 6363 6573 7366          successf
+0001b570: 756c 2063 6f6d 706c 6574 696f 6e2e 0a0a  ul completion...
+0001b580: 2020 2020 2020 2020 3a70 6172 616d 2073          :param s
+0001b590: 796e 635f 6576 656e 7473 3a20 4c69 7374  ync_events: List
+0001b5a0: 206f 6620 7265 6d6f 7465 2063 6861 6e67   of remote chang
+0001b5b0: 6573 2e0a 2020 2020 2020 2020 3a72 6574  es..        :ret
+0001b5c0: 7572 6e73 3a20 4c69 7374 206f 6620 6368  urns: List of ch
+0001b5d0: 616e 6765 7320 7468 6174 2077 6572 6520  anges that were 
+0001b5e0: 6d61 6465 2074 6f20 6c6f 6361 6c20 6669  made to local fi
+0001b5f0: 6c65 7320 616e 6420 626f 6f6c 2069 6e64  les and bool ind
+0001b600: 6963 6174 696e 6720 6966 0a20 2020 2020  icating if.     
+0001b610: 2020 2020 2020 2061 6c6c 2064 6f77 6e6c         all downl
+0001b620: 6f61 6420 7379 6e63 7320 7765 7265 2073  oad syncs were s
+0001b630: 7563 6365 7373 6675 6c2e 0a20 2020 2020  uccessful..     
+0001b640: 2020 2022 2222 0a20 2020 2020 2020 2072     """.        r
+0001b650: 6573 756c 7473 3a20 6c69 7374 5b53 796e  esults: list[Syn
+0001b660: 6345 7665 6e74 5d20 3d20 5b5d 0a0a 2020  cEvent] = []..  
+0001b670: 2020 2020 2020 6966 206c 656e 2873 796e        if len(syn
+0001b680: 635f 6576 656e 7473 2920 3d3d 2030 3a0a  c_events) == 0:.
+0001b690: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+0001b6a0: 726e 2072 6573 756c 7473 0a0a 2020 2020  rn results..    
+0001b6b0: 2020 2020 2320 536f 7274 2063 6861 6e67      # Sort chang
+0001b6c0: 6573 2069 6e74 6f20 666f 6c64 6572 732c  es into folders,
+0001b6d0: 2066 696c 6573 2061 6e64 2064 656c 6574   files and delet
+0001b6e0: 6564 2069 7465 6d73 2e20 4469 7363 6172  ed items. Discar
+0001b6f0: 6420 6578 636c 7564 6564 2069 7465 6d73  d excluded items
+0001b700: 0a20 2020 2020 2020 2023 2061 6e64 2072  .        # and r
+0001b710: 656d 6f76 6520 616e 6420 6465 6c65 7465  emove and delete
+0001b720: 6420 6974 656d 7320 6672 6f6d 206f 7572  d items from our
+0001b730: 2065 7863 6c75 6465 6420 6c69 7374 2e0a   excluded list..
+0001b740: 2020 2020 2020 2020 2320 536f 7274 2061          # Sort a
+0001b750: 6363 6f72 6469 6e67 2074 6f20 7061 7468  ccording to path
+0001b760: 2068 6965 7261 7263 6879 3a0a 2020 2020   hierarchy:.    
+0001b770: 2020 2020 2320 2d20 446f 206e 6f74 2063      # - Do not c
+0001b780: 7265 6174 6520 7375 622d 666f 6c64 6572  reate sub-folder
+0001b790: 202f 2066 696c 6520 6265 666f 7265 2070   / file before p
+0001b7a0: 6172 656e 7420 6578 6973 7473 2e0a 2020  arent exists..  
+0001b7b0: 2020 2020 2020 2320 2d20 4465 6c65 7465        # - Delete
+0001b7c0: 2070 6172 656e 7473 2062 6566 6f72 6520   parents before 
+0001b7d0: 6465 6c65 7469 6e67 2063 6869 6c64 7265  deleting childre
+0001b7e0: 6e20 746f 2073 6176 6520 736f 6d65 2077  n to save some w
+0001b7f0: 6f72 6b2e 0a0a 2020 2020 2020 2020 6669  ork...        fi
+0001b800: 6c65 733a 206c 6973 745b 5379 6e63 4576  les: list[SyncEv
+0001b810: 656e 745d 203d 205b 5d0a 2020 2020 2020  ent] = [].      
+0001b820: 2020 666f 6c64 6572 733a 2064 6566 6175    folders: defau
+0001b830: 6c74 6469 6374 5b69 6e74 2c20 6c69 7374  ltdict[int, list
+0001b840: 5b53 796e 6345 7665 6e74 5d5d 203d 2064  [SyncEvent]] = d
+0001b850: 6566 6175 6c74 6469 6374 286c 6973 7429  efaultdict(list)
+0001b860: 0a20 2020 2020 2020 2064 656c 6574 6564  .        deleted
+0001b870: 3a20 6465 6661 756c 7464 6963 745b 696e  : defaultdict[in
+0001b880: 742c 206c 6973 745b 5379 6e63 4576 656e  t, list[SyncEven
+0001b890: 745d 5d20 3d20 6465 6661 756c 7464 6963  t]] = defaultdic
+0001b8a0: 7428 6c69 7374 290a 0a20 2020 2020 2020  t(list)..       
+0001b8b0: 206e 6577 5f65 7863 6c75 6465 6420 3d20   new_excluded = 
+0001b8c0: 7365 6c66 2e65 7863 6c75 6465 645f 6974  self.excluded_it
+0001b8d0: 656d 730a 0a20 2020 2020 2020 2066 6f72  ems..        for
+0001b8e0: 2065 7665 6e74 2069 6e20 7379 6e63 5f65   event in sync_e
+0001b8f0: 7665 6e74 733a 0a20 2020 2020 2020 2020  vents:.         
+0001b900: 2020 2069 735f 6578 636c 7564 6564 203d     is_excluded =
+0001b910: 2073 656c 662e 6973 5f65 7863 6c75 6465   self.is_exclude
+0001b920: 645f 6279 5f75 7365 7228 0a20 2020 2020  d_by_user(.     
+0001b930: 2020 2020 2020 2020 2020 2065 7665 6e74             event
+0001b940: 2e64 6278 5f70 6174 685f 6c6f 7765 720a  .dbx_path_lower.
+0001b950: 2020 2020 2020 2020 2020 2020 2920 6f72              ) or
+0001b960: 2073 656c 662e 6973 5f65 7863 6c75 6465   self.is_exclude
+0001b970: 6428 6576 656e 742e 6462 785f 7061 7468  d(event.dbx_path
+0001b980: 290a 0a20 2020 2020 2020 2020 2020 2069  )..            i
+0001b990: 6620 6973 5f65 7863 6c75 6465 643a 0a20  f is_excluded:. 
+0001b9a0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+0001b9b0: 6620 6576 656e 742e 6973 5f64 656c 6574  f event.is_delet
+0001b9c0: 6564 3a0a 2020 2020 2020 2020 2020 2020  ed:.            
+0001b9d0: 2020 2020 2020 2020 2320 5265 6d6f 7665          # Remove
+0001b9e0: 2064 656c 6574 6564 2069 7465 6d20 616e   deleted item an
+0001b9f0: 6420 6974 7320 6368 696c 6472 656e 2066  d its children f
+0001ba00: 726f 6d20 7468 6520 6578 636c 7564 6564  rom the excluded
+0001ba10: 206c 6973 742e 0a20 2020 2020 2020 2020   list..         
+0001ba20: 2020 2020 2020 2020 2020 206e 6577 5f65             new_e
+0001ba30: 7863 6c75 6465 6420 3d20 5b0a 2020 2020  xcluded = [.    
+0001ba40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ba50: 2020 2020 7061 7468 0a20 2020 2020 2020      path.       
+0001ba60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ba70: 2066 6f72 2070 6174 6820 696e 206e 6577   for path in new
+0001ba80: 5f65 7863 6c75 6465 640a 2020 2020 2020  _excluded.      
+0001ba90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001baa0: 2020 6966 206e 6f74 2069 735f 6571 7561    if not is_equa
+0001bab0: 6c5f 6f72 5f63 6869 6c64 2870 6174 682c  l_or_child(path,
+0001bac0: 2065 7665 6e74 2e64 6278 5f70 6174 685f   event.dbx_path_
+0001bad0: 6c6f 7765 7229 0a20 2020 2020 2020 2020  lower).         
+0001bae0: 2020 2020 2020 2020 2020 205d 0a0a 2020             ]..  
+0001baf0: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
+0001bb00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001bb10: 6c65 7665 6c20 3d20 6576 656e 742e 6462  level = event.db
+0001bb20: 785f 7061 7468 2e63 6f75 6e74 2822 2f22  x_path.count("/"
+0001bb30: 290a 0a20 2020 2020 2020 2020 2020 2020  )..             
+0001bb40: 2020 2069 6620 6576 656e 742e 6973 5f64     if event.is_d
+0001bb50: 656c 6574 6564 3a0a 2020 2020 2020 2020  eleted:.        
+0001bb60: 2020 2020 2020 2020 2020 2020 6465 6c65              dele
+0001bb70: 7465 645b 6c65 7665 6c5d 2e61 7070 656e  ted[level].appen
+0001bb80: 6428 6576 656e 7429 0a20 2020 2020 2020  d(event).       
+0001bb90: 2020 2020 2020 2020 2065 6c69 6620 6576           elif ev
+0001bba0: 656e 742e 6973 5f66 696c 653a 0a20 2020  ent.is_file:.   
+0001bbb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001bbc0: 2066 696c 6573 2e61 7070 656e 6428 6576   files.append(ev
+0001bbd0: 656e 7429 0a20 2020 2020 2020 2020 2020  ent).           
+0001bbe0: 2020 2020 2065 6c69 6620 6576 656e 742e       elif event.
+0001bbf0: 6973 5f64 6972 6563 746f 7279 3a0a 2020  is_directory:.  
+0001bc00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001bc10: 2020 666f 6c64 6572 735b 6c65 7665 6c5d    folders[level]
+0001bc20: 2e61 7070 656e 6428 6576 656e 7429 0a0a  .append(event)..
+0001bc30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001bc40: 2320 486f 7573 656b 6565 7069 6e67 2e0a  # Housekeeping..
+0001bc50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001bc60: 7365 6c66 2e61 6374 6976 6974 792e 6164  self.activity.ad
+0001bc70: 6428 6576 656e 7429 0a0a 2020 2020 2020  d(event)..      
+0001bc80: 2020 7365 6c66 2e65 7863 6c75 6465 645f    self.excluded_
+0001bc90: 6974 656d 7320 3d20 6e65 775f 6578 636c  items = new_excl
+0001bca0: 7564 6564 0a0a 2020 2020 2020 2020 2320  uded..        # 
+0001bcb0: 4170 706c 7920 6465 6c65 7465 6420 6974  Apply deleted it
+0001bcc0: 656d 732e 0a20 2020 2020 2020 2069 6620  ems..        if 
+0001bcd0: 6465 6c65 7465 643a 0a20 2020 2020 2020  deleted:.       
+0001bce0: 2020 2020 2073 656c 662e 5f6c 6f67 6765       self._logge
+0001bcf0: 722e 696e 666f 2822 4170 706c 7969 6e67  r.info("Applying
+0001bd00: 2064 656c 6574 696f 6e73 2e2e 2e22 290a   deletions...").
+0001bd10: 0a20 2020 2020 2020 2066 6f72 206c 6576  .        for lev
+0001bd20: 656c 2069 6e20 736f 7274 6564 2864 656c  el in sorted(del
+0001bd30: 6574 6564 293a 0a20 2020 2020 2020 2020  eted):.         
+0001bd40: 2020 2072 6573 203d 2064 6f5f 7061 7261     res = do_para
+0001bd50: 6c6c 656c 280a 2020 2020 2020 2020 2020  llel(.          
+0001bd60: 2020 2020 2020 7365 6c66 2e5f 6372 6561        self._crea
+0001bd70: 7465 5f6c 6f63 616c 5f65 6e74 7279 2c0a  te_local_entry,.
+0001bd80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001bd90: 6465 6c65 7465 645b 6c65 7665 6c5d 2c0a  deleted[level],.
+0001bda0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001bdb0: 6f6e 5f70 726f 6772 6573 733d 6c61 6d62  on_progress=lamb
+0001bdc0: 6461 2078 2c20 793a 2073 656c 662e 5f6c  da x, y: self._l
+0001bdd0: 6f67 6765 722e 696e 666f 2866 2244 656c  ogger.info(f"Del
+0001bde0: 6574 696e 6720 7b78 7d2f 7b79 7d22 292c  eting {x}/{y}"),
+0001bdf0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001be00: 2074 6872 6561 645f 6e61 6d65 5f70 7265   thread_name_pre
+0001be10: 6669 783d 226d 6165 7374 7261 6c2d 646f  fix="maestral-do
+0001be20: 776e 6c6f 6164 2d70 6f6f 6c22 2c0a 2020  wnload-pool",.  
+0001be30: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
+0001be40: 2020 2020 2020 2020 7265 7375 6c74 732e          results.
+0001be50: 6578 7465 6e64 2872 6573 290a 0a20 2020  extend(res)..   
+0001be60: 2020 2020 2023 2043 7265 6174 6520 6c6f       # Create lo
+0001be70: 6361 6c20 666f 6c64 6572 732c 2073 7461  cal folders, sta
+0001be80: 7274 2077 6974 6820 746f 702d 6c65 7665  rt with top-leve
+0001be90: 6c20 616e 6420 776f 726b 2079 6f75 7220  l and work your 
+0001bea0: 7761 7920 646f 776e 2e0a 2020 2020 2020  way down..      
+0001beb0: 2020 6966 2066 6f6c 6465 7273 3a0a 2020    if folders:.  
+0001bec0: 2020 2020 2020 2020 2020 7365 6c66 2e5f            self._
+0001bed0: 6c6f 6767 6572 2e69 6e66 6f28 2243 7265  logger.info("Cre
+0001bee0: 6174 696e 6720 666f 6c64 6572 732e 2e2e  ating folders...
+0001bef0: 2229 0a0a 2020 2020 2020 2020 666f 7220  ")..        for 
+0001bf00: 6c65 7665 6c20 696e 2073 6f72 7465 6428  level in sorted(
+0001bf10: 666f 6c64 6572 7329 3a0a 2020 2020 2020  folders):.      
+0001bf20: 2020 2020 2020 7265 7320 3d20 646f 5f70        res = do_p
+0001bf30: 6172 616c 6c65 6c28 0a20 2020 2020 2020  arallel(.       
+0001bf40: 2020 2020 2020 2020 2073 656c 662e 5f63           self._c
+0001bf50: 7265 6174 655f 6c6f 6361 6c5f 656e 7472  reate_local_entr
+0001bf60: 792c 0a20 2020 2020 2020 2020 2020 2020  y,.             
+0001bf70: 2020 2066 6f6c 6465 7273 5b6c 6576 656c     folders[level
+0001bf80: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
+0001bf90: 2020 206f 6e5f 7072 6f67 7265 7373 3d6c     on_progress=l
+0001bfa0: 616d 6264 6120 782c 2079 3a20 7365 6c66  ambda x, y: self
+0001bfb0: 2e5f 6c6f 6767 6572 2e69 6e66 6f28 6622  ._logger.info(f"
+0001bfc0: 4372 6561 7469 6e67 2066 6f6c 6465 7220  Creating folder 
+0001bfd0: 7b78 7d2f 7b79 7d22 292c 0a20 2020 2020  {x}/{y}"),.     
+0001bfe0: 2020 2020 2020 2020 2020 2074 6872 6561             threa
+0001bff0: 645f 6e61 6d65 5f70 7265 6669 783d 226d  d_name_prefix="m
+0001c000: 6165 7374 7261 6c2d 646f 776e 6c6f 6164  aestral-download
+0001c010: 2d70 6f6f 6c22 2c0a 2020 2020 2020 2020  -pool",.        
+0001c020: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
+0001c030: 2020 7265 7375 6c74 732e 6578 7465 6e64    results.extend
+0001c040: 2872 6573 290a 0a20 2020 2020 2020 2023  (res)..        #
+0001c050: 2041 7070 6c79 2063 7265 6174 6564 2066   Apply created f
+0001c060: 696c 6573 2e0a 2020 2020 2020 2020 7265  iles..        re
+0001c070: 7320 3d20 646f 5f70 6172 616c 6c65 6c28  s = do_parallel(
+0001c080: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+0001c090: 662e 5f63 7265 6174 655f 6c6f 6361 6c5f  f._create_local_
+0001c0a0: 656e 7472 792c 0a20 2020 2020 2020 2020  entry,.         
+0001c0b0: 2020 2066 696c 6573 2c0a 2020 2020 2020     files,.      
+0001c0c0: 2020 2020 2020 6f6e 5f70 726f 6772 6573        on_progres
+0001c0d0: 733d 6c61 6d62 6461 2078 2c20 793a 2073  s=lambda x, y: s
+0001c0e0: 656c 662e 5f6c 6f67 6765 722e 696e 666f  elf._logger.info
+0001c0f0: 2866 2253 796e 6369 6e67 20e2 8693 207b  (f"Syncing ... {
+0001c100: 787d 2f7b 797d 2229 2c0a 2020 2020 2020  x}/{y}"),.      
+0001c110: 2020 2020 2020 7468 7265 6164 5f6e 616d        thread_nam
+0001c120: 655f 7072 6566 6978 3d22 6d61 6573 7472  e_prefix="maestr
+0001c130: 616c 2d64 6f77 6e6c 6f61 642d 706f 6f6c  al-download-pool
+0001c140: 222c 0a20 2020 2020 2020 2029 0a20 2020  ",.        ).   
+0001c150: 2020 2020 2072 6573 756c 7473 2e65 7874       results.ext
+0001c160: 656e 6428 7265 7329 0a0a 2020 2020 2020  end(res)..      
+0001c170: 2020 7365 6c66 2e5f 636c 6561 6e5f 6869    self._clean_hi
+0001c180: 7374 6f72 7928 290a 0a20 2020 2020 2020  story()..       
+0001c190: 2072 6574 7572 6e20 7265 7375 6c74 730a   return results.
+0001c1a0: 0a20 2020 2064 6566 206e 6f74 6966 795f  .    def notify_
+0001c1b0: 7573 6572 2873 656c 662c 2073 796e 635f  user(self, sync_
+0001c1c0: 6576 656e 7473 3a20 5365 7175 656e 6365  events: Sequence
+0001c1d0: 5b53 796e 6345 7665 6e74 5d29 202d 3e20  [SyncEvent]) -> 
+0001c1e0: 4e6f 6e65 3a0a 2020 2020 2020 2020 2222  None:.        ""
+0001c1f0: 220a 2020 2020 2020 2020 5368 6f77 7320  ".        Shows 
+0001c200: 6120 6465 736b 746f 7020 6e6f 7469 6669  a desktop notifi
+0001c210: 6361 7469 6f6e 2066 6f72 2074 6865 2067  cation for the g
+0001c220: 6976 656e 2066 696c 6520 6368 616e 6765  iven file change
+0001c230: 732e 0a0a 2020 2020 2020 2020 3a70 6172  s...        :par
+0001c240: 616d 2073 796e 635f 6576 656e 7473 3a20  am sync_events: 
+0001c250: 4c69 7374 206f 6620 5379 6e63 4576 656e  List of SyncEven
+0001c260: 7473 2066 726f 6d20 646f 776e 6c6f 6164  ts from download
+0001c270: 2073 796e 632e 0a20 2020 2020 2020 2022   sync..        "
+0001c280: 2222 0a20 2020 2020 2020 2069 6620 6e6f  "".        if no
+0001c290: 7420 7365 6c66 2e64 6573 6b74 6f70 5f6e  t self.desktop_n
+0001c2a0: 6f74 6966 6965 723a 0a20 2020 2020 2020  otifier:.       
+0001c2b0: 2020 2020 2072 6574 7572 6e0a 0a20 2020       return..   
+0001c2c0: 2020 2020 2063 6861 6e67 6573 3a20 6c69       changes: li
+0001c2d0: 7374 5b53 796e 6345 7665 6e74 5d20 3d20  st[SyncEvent] = 
+0001c2e0: 5b5d 0a20 2020 2020 2020 2065 7665 6e74  [].        event
+0001c2f0: 735f 636f 6e66 6c69 6374 3a20 6c69 7374  s_conflict: list
+0001c300: 5b53 796e 6345 7665 6e74 5d20 3d20 5b5d  [SyncEvent] = []
+0001c310: 0a0a 2020 2020 2020 2020 666f 7220 6576  ..        for ev
+0001c320: 656e 7420 696e 2073 796e 635f 6576 656e  ent in sync_even
+0001c330: 7473 3a0a 2020 2020 2020 2020 2020 2020  ts:.            
+0001c340: 6966 2065 7665 6e74 2e73 7461 7475 7320  if event.status 
+0001c350: 6973 206e 6f74 2053 796e 6353 7461 7475  is not SyncStatu
+0001c360: 732e 536b 6970 7065 643a 0a20 2020 2020  s.Skipped:.     
+0001c370: 2020 2020 2020 2020 2020 2063 6861 6e67             chang
+0001c380: 6573 2e61 7070 656e 6428 6576 656e 7429  es.append(event)
+0001c390: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+0001c3a0: 6576 656e 742e 7374 6174 7573 2069 7320  event.status is 
+0001c3b0: 5379 6e63 5374 6174 7573 2e43 6f6e 666c  SyncStatus.Confl
+0001c3c0: 6963 743a 0a20 2020 2020 2020 2020 2020  ict:.           
+0001c3d0: 2020 2020 2065 7665 6e74 735f 636f 6e66       events_conf
+0001c3e0: 6c69 6374 2e61 7070 656e 6428 6576 656e  lict.append(even
+0001c3f0: 7429 0a0a 2020 2020 2020 2020 2320 4765  t)..        # Ge
+0001c400: 7420 6e75 6d62 6572 206f 6620 7265 6d6f  t number of remo
+0001c410: 7465 2063 6861 6e67 6573 2e0a 2020 2020  te changes..    
+0001c420: 2020 2020 6e5f 6368 616e 6765 6420 3d20      n_changed = 
+0001c430: 6c65 6e28 6368 616e 6765 7329 0a0a 2020  len(changes)..  
+0001c440: 2020 2020 2020 6966 206e 5f63 6861 6e67        if n_chang
+0001c450: 6564 203d 3d20 303a 0a20 2020 2020 2020  ed == 0:.       
+0001c460: 2020 2020 2072 6574 7572 6e0a 0a20 2020       return..   
+0001c470: 2020 2020 2023 2046 696e 6420 6f75 7420       # Find out 
+0001c480: 7768 6f20 6368 616e 6765 6420 7468 6520  who changed the 
+0001c490: 6974 656d 2873 292e 0a20 2020 2020 2020  item(s)..       
+0001c4a0: 2075 7365 725f 6e61 6d65 3a20 7374 7220   user_name: str 
+0001c4b0: 7c20 4e6f 6e65 0a20 2020 2020 2020 2064  | None.        d
+0001c4c0: 6269 645f 7365 7420 3d20 7b65 2e63 6861  bid_set = {e.cha
+0001c4d0: 6e67 655f 6462 6964 2066 6f72 2065 2069  nge_dbid for e i
+0001c4e0: 6e20 6368 616e 6765 737d 0a20 2020 2020  n changes}.     
+0001c4f0: 2020 2069 6620 6c65 6e28 6462 6964 5f73     if len(dbid_s
+0001c500: 6574 2920 3d3d 2031 3a0a 2020 2020 2020  et) == 1:.      
+0001c510: 2020 2020 2020 2320 416c 6c20 6669 6c65        # All file
+0001c520: 7320 6861 7665 2062 6565 6e20 6d6f 6469  s have been modi
+0001c530: 6669 6564 2062 7920 7468 6520 7361 6d65  fied by the same
+0001c540: 2075 7365 720a 2020 2020 2020 2020 2020   user.          
+0001c550: 2020 6462 6964 203d 2064 6269 645f 7365    dbid = dbid_se
+0001c560: 742e 706f 7028 290a 2020 2020 2020 2020  t.pop().        
+0001c570: 2020 2020 6966 2064 6269 6420 3d3d 2073      if dbid == s
+0001c580: 656c 662e 636c 6965 6e74 2e61 6363 6f75  elf.client.accou
+0001c590: 6e74 5f69 6e66 6f2e 6163 636f 756e 745f  nt_info.account_
+0001c5a0: 6964 3a0a 2020 2020 2020 2020 2020 2020  id:.            
+0001c5b0: 2020 2020 7573 6572 5f6e 616d 6520 3d20      user_name = 
+0001c5c0: 2259 6f75 220a 2020 2020 2020 2020 2020  "You".          
+0001c5d0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+0001c5e0: 2020 2020 2020 2020 7573 6572 5f6e 616d          user_nam
+0001c5f0: 6520 3d20 7365 6c66 2e5f 6469 7370 6c61  e = self._displa
+0001c600: 795f 6e61 6d65 5f66 6f72 5f61 6363 6f75  y_name_for_accou
+0001c610: 6e74 2864 6269 6429 0a20 2020 2020 2020  nt(dbid).       
+0001c620: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+0001c630: 2020 2023 2044 6f6e 2774 2064 6973 706c     # Don't displ
+0001c640: 6179 206d 756c 7469 706c 6520 7573 6572  ay multiple user
+0001c650: 6e61 6d65 7320 696e 206e 6f74 6966 6963  names in notific
+0001c660: 6174 696f 6e2e 0a20 2020 2020 2020 2020  ation..         
+0001c670: 2020 2075 7365 725f 6e61 6d65 203d 204e     user_name = N
+0001c680: 6f6e 650a 0a20 2020 2020 2020 2062 7574  one..        but
+0001c690: 746f 6e73 3a20 6469 6374 5b73 7472 2c20  tons: dict[str, 
+0001c6a0: 4361 6c6c 6162 6c65 5b5b 5d2c 204e 6f6e  Callable[[], Non
+0001c6b0: 655d 5d0a 0a20 2020 2020 2020 2069 6620  e]]..        if 
+0001c6c0: 6e5f 6368 616e 6765 6420 3d3d 2031 3a0a  n_changed == 1:.
+0001c6d0: 2020 2020 2020 2020 2020 2020 2320 4469              # Di
+0001c6e0: 7370 6c61 7920 7468 6520 7573 6572 6e61  splay the userna
+0001c6f0: 6d65 2c20 6669 6c65 206e 616d 652c 2061  me, file name, a
+0001c700: 6e64 2074 7970 6520 6f66 2063 6861 6e67  nd type of chang
+0001c710: 6520 696e 206e 6f74 6966 6963 6174 696f  e in notificatio
+0001c720: 6e2e 0a20 2020 2020 2020 2020 2020 2065  n..            e
+0001c730: 7665 6e74 203d 2063 6861 6e67 6573 5b30  vent = changes[0
+0001c740: 5d0a 2020 2020 2020 2020 2020 2020 6669  ].            fi
+0001c750: 6c65 5f6e 616d 6520 3d20 6f73 702e 6261  le_name = osp.ba
+0001c760: 7365 6e61 6d65 2865 7665 6e74 2e64 6278  sename(event.dbx
+0001c770: 5f70 6174 6829 0a20 2020 2020 2020 2020  _path).         
+0001c780: 2020 2063 6861 6e67 655f 7479 7065 203d     change_type =
+0001c790: 2065 7665 6e74 2e63 6861 6e67 655f 7479   event.change_ty
+0001c7a0: 7065 2e76 616c 7565 0a0a 2020 2020 2020  pe.value..      
+0001c7b0: 2020 2020 2020 6465 6620 6361 6c6c 6261        def callba
+0001c7c0: 636b 2829 202d 3e20 4e6f 6e65 3a0a 2020  ck() -> None:.  
+0001c7d0: 2020 2020 2020 2020 2020 2020 2020 636c                cl
+0001c7e0: 6963 6b2e 6c61 756e 6368 2865 7665 6e74  ick.launch(event
+0001c7f0: 2e6c 6f63 616c 5f70 6174 682c 206c 6f63  .local_path, loc
+0001c800: 6174 653d 5472 7565 290a 0a20 2020 2020  ate=True)..     
+0001c810: 2020 2020 2020 2062 7574 746f 6e73 203d         buttons =
+0001c820: 207b 2253 686f 7722 3a20 6361 6c6c 6261   {"Show": callba
+0001c830: 636b 7d0a 0a20 2020 2020 2020 2065 6c73  ck}..        els
+0001c840: 653a 0a20 2020 2020 2020 2020 2020 2023  e:.            #
+0001c850: 2044 6973 706c 6179 2074 6865 206e 756d   Display the num
+0001c860: 6265 7220 6f66 2066 696c 6573 2063 6861  ber of files cha
+0001c870: 6e67 6564 2061 6e64 2070 6f74 656e 7469  nged and potenti
+0001c880: 616c 6c79 2074 6865 2074 7970 6520 6f66  ally the type of
+0001c890: 2063 6861 6e67 6520 696e 0a20 2020 2020   change in.     
+0001c8a0: 2020 2020 2020 2023 206e 6f74 6966 6963         # notific
+0001c8b0: 6174 696f 6e2e 0a0a 2020 2020 2020 2020  ation...        
+0001c8c0: 2020 2020 6966 2061 6c6c 2865 2e63 6861      if all(e.cha
+0001c8d0: 6e67 655f 7479 7065 203d 3d20 7379 6e63  nge_type == sync
+0001c8e0: 5f65 7665 6e74 735b 305d 2e63 6861 6e67  _events[0].chang
+0001c8f0: 655f 7479 7065 2066 6f72 2065 2069 6e20  e_type for e in 
+0001c900: 7379 6e63 5f65 7665 6e74 7329 3a0a 2020  sync_events):.  
+0001c910: 2020 2020 2020 2020 2020 2020 2020 6368                ch
+0001c920: 616e 6765 5f74 7970 6520 3d20 7379 6e63  ange_type = sync
+0001c930: 5f65 7665 6e74 735b 305d 2e63 6861 6e67  _events[0].chang
+0001c940: 655f 7479 7065 2e76 616c 7565 0a20 2020  e_type.value.   
+0001c950: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
+0001c960: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+0001c970: 6861 6e67 655f 7479 7065 203d 2022 6368  hange_type = "ch
+0001c980: 616e 6765 6422 0a0a 2020 2020 2020 2020  anged"..        
+0001c990: 2020 2020 6966 2061 6c6c 2865 2e69 735f      if all(e.is_
+0001c9a0: 6669 6c65 2066 6f72 2065 2069 6e20 7379  file for e in sy
+0001c9b0: 6e63 5f65 7665 6e74 7329 3a0a 2020 2020  nc_events):.    
+0001c9c0: 2020 2020 2020 2020 2020 2020 6669 6c65              file
+0001c9d0: 5f6e 616d 6520 3d20 6622 7b6e 5f63 6861  _name = f"{n_cha
+0001c9e0: 6e67 6564 7d20 6669 6c65 7322 0a20 2020  nged} files".   
+0001c9f0: 2020 2020 2020 2020 2065 6c69 6620 616c           elif al
+0001ca00: 6c28 652e 6973 5f64 6972 6563 746f 7279  l(e.is_directory
+0001ca10: 2066 6f72 2065 2069 6e20 7379 6e63 5f65   for e in sync_e
+0001ca20: 7665 6e74 7329 3a0a 2020 2020 2020 2020  vents):.        
+0001ca30: 2020 2020 2020 2020 6669 6c65 5f6e 616d          file_nam
+0001ca40: 6520 3d20 6622 7b6e 5f63 6861 6e67 6564  e = f"{n_changed
+0001ca50: 7d20 666f 6c64 6572 7322 0a20 2020 2020  } folders".     
+0001ca60: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+0001ca70: 2020 2020 2020 2020 2020 2020 2066 696c               fil
+0001ca80: 655f 6e61 6d65 203d 2066 227b 6e5f 6368  e_name = f"{n_ch
+0001ca90: 616e 6765 647d 2069 7465 6d73 220a 0a20  anged} items".. 
+0001caa0: 2020 2020 2020 2020 2020 2064 6566 2063             def c
+0001cab0: 616c 6c62 6163 6b28 2920 2d3e 204e 6f6e  allback() -> Non
+0001cac0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+0001cad0: 2020 2070 6173 730a 0a20 2020 2020 2020     pass..       
+0001cae0: 2020 2020 2062 7574 746f 6e73 203d 207b       buttons = {
+0001caf0: 7d0a 0a20 2020 2020 2020 2069 6620 6368  }..        if ch
+0001cb00: 616e 6765 5f74 7970 6520 3d3d 2043 6861  ange_type == Cha
+0001cb10: 6e67 6554 7970 652e 5265 6d6f 7665 642e  ngeType.Removed.
+0001cb20: 7661 6c75 653a 0a0a 2020 2020 2020 2020  value:..        
+0001cb30: 2020 2020 6465 6620 6361 6c6c 6261 636b      def callback
+0001cb40: 2829 202d 3e20 4e6f 6e65 3a0a 2020 2020  () -> None:.    
+0001cb50: 2020 2020 2020 2020 2020 2020 2320 5368              # Sh
+0001cb60: 6f77 2044 726f 7062 6f78 2077 6562 7369  ow Dropbox websi
+0001cb70: 7465 2077 6974 6820 6465 6c65 7465 6420  te with deleted 
+0001cb80: 6669 6c65 732e 0a20 2020 2020 2020 2020  files..         
+0001cb90: 2020 2020 2020 2063 6c69 636b 2e6c 6175         click.lau
+0001cba0: 6e63 6828 2268 7474 7073 3a2f 2f77 7777  nch("https://www
+0001cbb0: 2e64 726f 7062 6f78 2e63 6f6d 2f64 656c  .dropbox.com/del
+0001cbc0: 6574 6564 5f66 696c 6573 2229 0a0a 2020  eted_files")..  
+0001cbd0: 2020 2020 2020 2020 2020 6275 7474 6f6e            button
+0001cbe0: 7320 3d20 7b22 5368 6f77 223a 2063 616c  s = {"Show": cal
+0001cbf0: 6c62 6163 6b7d 0a0a 2020 2020 2020 2020  lback}..        
+0001cc00: 6966 2075 7365 725f 6e61 6d65 3a0a 2020  if user_name:.  
+0001cc10: 2020 2020 2020 2020 2020 6d73 6720 3d20            msg = 
+0001cc20: 6622 7b75 7365 725f 6e61 6d65 7d20 7b63  f"{user_name} {c
+0001cc30: 6861 6e67 655f 7479 7065 7d20 7b66 696c  hange_type} {fil
+0001cc40: 655f 6e61 6d65 7d22 0a20 2020 2020 2020  e_name}".       
+0001cc50: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+0001cc60: 2020 206d 7367 203d 2066 227b 6669 6c65     msg = f"{file
+0001cc70: 5f6e 616d 657d 207b 6368 616e 6765 5f74  _name} {change_t
+0001cc80: 7970 657d 220a 0a20 2020 2020 2020 2023  ype}"..        #
+0001cc90: 204e 6f74 6966 7920 696e 2062 756c 6b20   Notify in bulk 
+0001cca0: 666f 7220 616c 6c20 6261 7463 6865 6420  for all batched 
+0001ccb0: 6368 616e 6765 732e 0a20 2020 2020 2020  changes..       
+0001ccc0: 2073 656c 662e 6465 736b 746f 705f 6e6f   self.desktop_no
+0001ccd0: 7469 6669 6572 2e6e 6f74 6966 7928 0a20  tifier.notify(. 
+0001cce0: 2020 2020 2020 2020 2020 2022 4974 656d             "Item
+0001ccf0: 7320 7379 6e63 6564 222c 206d 7367 2c20  s synced", msg, 
+0001cd00: 6163 7469 6f6e 733d 6275 7474 6f6e 732c  actions=buttons,
+0001cd10: 206f 6e5f 636c 6963 6b3d 6361 6c6c 6261   on_click=callba
+0001cd20: 636b 0a20 2020 2020 2020 2029 0a0a 2020  ck.        )..  
+0001cd30: 2020 2020 2020 2320 4e6f 7469 6679 2073        # Notify s
+0001cd40: 6570 6172 6174 656c 7920 666f 7220 6561  eparately for ea
+0001cd50: 6368 2073 796e 6320 636f 6e66 6c69 6374  ch sync conflict
+0001cd60: 2e0a 2020 2020 2020 2020 666f 7220 6576  ..        for ev
+0001cd70: 656e 7420 696e 2065 7665 6e74 735f 636f  ent in events_co
+0001cd80: 6e66 6c69 6374 3a0a 0a20 2020 2020 2020  nflict:..       
+0001cd90: 2020 2020 2064 6566 2063 616c 6c62 6163       def callbac
+0001cda0: 6b28 2920 2d3e 204e 6f6e 653a 0a20 2020  k() -> None:.   
+0001cdb0: 2020 2020 2020 2020 2020 2020 2063 6c69               cli
+0001cdc0: 636b 2e6c 6175 6e63 6828 6576 656e 742e  ck.launch(event.
+0001cdd0: 6c6f 6361 6c5f 7061 7468 2c20 6c6f 6361  local_path, loca
+0001cde0: 7465 3d54 7275 6529 0a0a 2020 2020 2020  te=True)..      
+0001cdf0: 2020 2020 2020 7365 6c66 2e64 6573 6b74        self.deskt
+0001ce00: 6f70 5f6e 6f74 6966 6965 722e 6e6f 7469  op_notifier.noti
+0001ce10: 6679 280a 2020 2020 2020 2020 2020 2020  fy(.            
+0001ce20: 2020 2020 2253 796e 6320 636f 6e66 6c69      "Sync confli
+0001ce30: 6374 222c 0a20 2020 2020 2020 2020 2020  ct",.           
+0001ce40: 2020 2020 2066 2243 6f6e 666c 6963 7469       f"Conflicti
+0001ce50: 6e67 2063 6f70 7920 666f 7220 7b66 696c  ng copy for {fil
+0001ce60: 655f 6e61 6d65 7d22 2c0a 2020 2020 2020  e_name}",.      
+0001ce70: 2020 2020 2020 2020 2020 6163 7469 6f6e            action
+0001ce80: 733d 7b22 5368 6f77 223a 2063 616c 6c62  s={"Show": callb
+0001ce90: 6163 6b7d 2c0a 2020 2020 2020 2020 2020  ack},.          
+0001cea0: 2020 2020 2020 6f6e 5f63 6c69 636b 3d63        on_click=c
+0001ceb0: 616c 6c62 6163 6b2c 0a20 2020 2020 2020  allback,.       
+0001cec0: 2020 2020 2029 0a0a 2020 2020 6465 6620       )..    def 
+0001ced0: 5f64 6973 706c 6179 5f6e 616d 655f 666f  _display_name_fo
+0001cee0: 725f 6163 636f 756e 7428 7365 6c66 2c20  r_account(self, 
+0001cef0: 6462 6964 3a20 7374 7220 7c20 4e6f 6e65  dbid: str | None
+0001cf00: 2920 2d3e 2073 7472 207c 204e 6f6e 653a  ) -> str | None:
+0001cf10: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
+0001cf20: 2020 2020 2052 6574 7572 6e73 2074 6865       Returns the
+0001cf30: 2064 6973 706c 6179 206e 616d 6520 636f   display name co
+0001cf40: 7272 6573 706f 6e64 696e 6720 746f 2061  rresponding to a
+0001cf50: 2044 726f 7062 6f78 2049 442e 0a20 2020   Dropbox ID..   
+0001cf60: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
+0001cf70: 2069 6620 6462 6964 2069 7320 4e6f 6e65   if dbid is None
+0001cf80: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
+0001cf90: 7475 726e 204e 6f6e 650a 2020 2020 2020  turn None.      
+0001cfa0: 2020 6966 2064 6269 6420 3d3d 2073 656c    if dbid == sel
+0001cfb0: 662e 636c 6965 6e74 2e61 6363 6f75 6e74  f.client.account
+0001cfc0: 5f69 6e66 6f2e 6163 636f 756e 745f 6964  _info.account_id
+0001cfd0: 3a0a 2020 2020 2020 2020 2020 2020 2320  :.            # 
+0001cfe0: 5265 7475 726e 2063 6163 6865 6420 6469  Return cached di
+0001cff0: 7370 6c61 7920 6e61 6d65 0a20 2020 2020  splay name.     
+0001d000: 2020 2020 2020 2072 6574 7572 6e20 7365         return se
+0001d010: 6c66 2e63 6c69 656e 742e 6163 636f 756e  lf.client.accoun
+0001d020: 745f 696e 666f 2e64 6973 706c 6179 5f6e  t_info.display_n
+0001d030: 616d 650a 0a20 2020 2020 2020 2074 7279  ame..        try
+0001d040: 3a0a 2020 2020 2020 2020 2020 2020 6163  :.            ac
+0001d050: 636f 756e 745f 696e 666f 203d 2073 656c  count_info = sel
+0001d060: 662e 636c 6965 6e74 2e67 6574 5f61 6363  f.client.get_acc
+0001d070: 6f75 6e74 5f69 6e66 6f28 6462 6964 290a  ount_info(dbid).
+0001d080: 2020 2020 2020 2020 6578 6365 7074 2049          except I
+0001d090: 6e76 616c 6964 4462 6964 4572 726f 723a  nvalidDbidError:
+0001d0a0: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+0001d0b0: 7572 6e20 4e6f 6e65 0a20 2020 2020 2020  urn None.       
+0001d0c0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+0001d0d0: 2020 2072 6574 7572 6e20 6163 636f 756e     return accoun
+0001d0e0: 745f 696e 666f 2e64 6973 706c 6179 5f6e  t_info.display_n
+0001d0f0: 616d 650a 0a20 2020 2064 6566 205f 6368  ame..    def _ch
+0001d100: 6563 6b5f 646f 776e 6c6f 6164 5f63 6f6e  eck_download_con
+0001d110: 666c 6963 7428 7365 6c66 2c20 6576 656e  flict(self, even
+0001d120: 743a 2053 796e 6345 7665 6e74 2920 2d3e  t: SyncEvent) ->
+0001d130: 2043 6f6e 666c 6963 743a 0a20 2020 2020   Conflict:.     
+0001d140: 2020 2022 2222 0a20 2020 2020 2020 2043     """.        C
+0001d150: 6865 636b 2069 6620 6120 6c6f 6361 6c20  heck if a local 
+0001d160: 6974 656d 2069 7320 636f 6e66 6c69 6374  item is conflict
+0001d170: 696e 6720 7769 7468 2072 656d 6f74 6520  ing with remote 
+0001d180: 6368 616e 6765 2e20 5468 6520 6571 7569  change. The equi
+0001d190: 7661 6c65 6e74 2063 6865 636b 0a20 2020  valent check.   
+0001d1a0: 2020 2020 2077 6865 6e20 7570 6c6f 6164       when upload
+0001d1b0: 696e 6720 616e 6420 6120 6368 616e 6765  ing and a change
+0001d1c0: 2077 696c 6c20 6265 2063 6172 7269 6564   will be carried
+0001d1d0: 206f 7574 2062 7920 4472 6f70 626f 7820   out by Dropbox 
+0001d1e0: 6974 7365 6c66 2e0a 0a20 2020 2020 2020  itself...       
+0001d1f0: 2043 6865 636b 7320 6172 6520 6361 7272   Checks are carr
+0001d200: 6965 6420 6f75 7420 6167 6169 6e73 7420  ied out against 
+0001d210: 6f75 7220 696e 6465 782c 2072 6566 6c65  our index, refle
+0001d220: 6374 696e 6720 7468 6520 6c61 7465 7374  cting the latest
+0001d230: 2073 796e 6320 7374 6174 652e 0a20 2020   sync state..   
+0001d240: 2020 2020 2057 6520 636f 6d70 6172 6520       We compare 
+0001d250: 7468 6520 666f 6c6c 6f77 696e 6720 7661  the following va
+0001d260: 6c75 6573 3a0a 0a20 2020 2020 2020 2031  lues:..        1
+0001d270: 2920 4c6f 6361 6c20 7673 2072 656d 6f74  ) Local vs remot
+0001d280: 6520 7265 763a 2027 666f 6c64 6572 2720  e rev: 'folder' 
+0001d290: 666f 7220 666f 6c64 6572 732c 2061 6374  for folders, act
+0001d2a0: 7561 6c20 7265 7669 7369 6f6e 2066 6f72  ual revision for
+0001d2b0: 2066 696c 6573 2061 6e64 204e 6f6e 650a   files and None.
+0001d2c0: 2020 2020 2020 2020 2020 2066 6f72 2064             for d
+0001d2d0: 656c 6574 6564 206f 7220 6e6f 7420 7072  eleted or not pr
+0001d2e0: 6573 656e 7420 6974 656d 732e 0a20 2020  esent items..   
+0001d2f0: 2020 2020 2032 2920 4c6f 6361 6c20 7673       2) Local vs
+0001d300: 2072 656d 6f74 6520 636f 6e74 656e 7420   remote content 
+0001d310: 6861 7368 3a20 2766 6f6c 6465 7227 2066  hash: 'folder' f
+0001d320: 6f72 2066 6f6c 6465 7273 2c20 6163 7475  or folders, actu
+0001d330: 616c 2068 6173 6820 666f 7220 6669 6c65  al hash for file
+0001d340: 7320 616e 640a 2020 2020 2020 2020 2020  s and.          
+0001d350: 204e 6f6e 6520 666f 7220 6465 6c65 7469   None for deleti
+0001d360: 6f6e 732e 0a20 2020 2020 2020 2033 2920  ons..        3) 
+0001d370: 4c6f 6361 6c20 6374 696d 6520 7673 206c  Local ctime vs l
+0001d380: 6173 7420 7379 6e63 2074 696d 653a 2054  ast sync time: T
+0001d390: 6869 7320 6973 2063 616c 6375 6c61 7465  his is calculate
+0001d3a0: 6420 7265 6375 7273 6976 656c 7920 666f  d recursively fo
+0001d3b0: 7220 666f 6c64 6572 732e 0a0a 2020 2020  r folders...    
+0001d3c0: 2020 2020 3a70 6172 616d 2065 7665 6e74      :param event
+0001d3d0: 3a20 446f 776e 6c6f 6164 2053 796e 6345  : Download SyncE
+0001d3e0: 7665 6e74 2e0a 2020 2020 2020 2020 3a72  vent..        :r
+0001d3f0: 6574 7572 6e73 3a20 436f 6e66 6c69 6374  eturns: Conflict
+0001d400: 2063 6865 636b 2072 6573 756c 742e 0a20   check result.. 
+0001d410: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
+0001d420: 2020 206c 6f63 616c 5f72 6576 203d 2073     local_rev = s
+0001d430: 656c 662e 6765 745f 6c6f 6361 6c5f 7265  elf.get_local_re
+0001d440: 7628 6576 656e 742e 6462 785f 7061 7468  v(event.dbx_path
+0001d450: 5f6c 6f77 6572 290a 0a20 2020 2020 2020  _lower)..       
+0001d460: 2077 6974 6820 636f 6e76 6572 745f 6170   with convert_ap
+0001d470: 695f 6572 726f 7273 2865 7665 6e74 2e64  i_errors(event.d
+0001d480: 6278 5f70 6174 682c 2065 7665 6e74 2e6c  bx_path, event.l
+0001d490: 6f63 616c 5f70 6174 6829 3a0a 2020 2020  ocal_path):.    
+0001d4a0: 2020 2020 2020 2020 6c6f 6361 6c5f 7379          local_sy
+0001d4b0: 6d6c 696e 6b5f 7461 7267 6574 203d 2067  mlink_target = g
+0001d4c0: 6574 5f73 796d 6c69 6e6b 5f74 6172 6765  et_symlink_targe
+0001d4d0: 7428 6576 656e 742e 6c6f 6361 6c5f 7061  t(event.local_pa
+0001d4e0: 7468 290a 0a20 2020 2020 2020 2069 6620  th)..        if 
+0001d4f0: 6576 656e 742e 7265 7620 3d3d 206c 6f63  event.rev == loc
+0001d500: 616c 5f72 6576 3a0a 2020 2020 2020 2020  al_rev:.        
+0001d510: 2020 2020 2320 4c6f 6361 6c20 6368 616e      # Local chan
+0001d520: 6765 2068 6173 2074 6865 2073 616d 6520  ge has the same 
+0001d530: 7265 762e 2054 6865 206c 6f63 616c 2069  rev. The local i
+0001d540: 7465 6d20 286f 7220 6465 6c65 7469 6f6e  tem (or deletion
+0001d550: 2920 6d75 7374 2062 6520 6e65 7765 720a  ) must be newer.
+0001d560: 2020 2020 2020 2020 2020 2020 2320 616e              # an
+0001d570: 6420 6e6f 7420 7965 7420 7379 6e63 6564  d not yet synced
+0001d580: 206f 7220 6964 656e 7469 6361 6c20 746f   or identical to
+0001d590: 2074 6865 2072 656d 6f74 6520 7374 6174   the remote stat
+0001d5a0: 652e 2044 6f6e 2774 206f 7665 7277 7269  e. Don't overwri
+0001d5b0: 7465 2e0a 2020 2020 2020 2020 2020 2020  te..            
+0001d5c0: 7365 6c66 2e5f 6c6f 6767 6572 2e64 6562  self._logger.deb
+0001d5d0: 7567 280a 2020 2020 2020 2020 2020 2020  ug(.            
+0001d5e0: 2020 2020 2745 7175 616c 2072 6576 7320      'Equal revs 
+0001d5f0: 666f 7220 2225 7322 3a20 6c6f 6361 6c20  for "%s": local 
+0001d600: 6974 656d 2069 7320 7468 6520 7361 6d65  item is the same
+0001d610: 206f 7220 6e65 7765 7220 270a 2020 2020   or newer '.    
+0001d620: 2020 2020 2020 2020 2020 2020 2274 6861              "tha
+0001d630: 6e20 6f6e 2044 726f 7062 6f78 222c 0a20  n on Dropbox",. 
+0001d640: 2020 2020 2020 2020 2020 2020 2020 2065                 e
+0001d650: 7665 6e74 2e64 6278 5f70 6174 682c 0a20  vent.dbx_path,. 
+0001d660: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
+0001d670: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+0001d680: 436f 6e66 6c69 6374 2e4c 6f63 616c 4e65  Conflict.LocalNe
+0001d690: 7765 724f 7249 6465 6e74 6963 616c 0a0a  werOrIdentical..
+0001d6a0: 2020 2020 2020 2020 656c 6966 2028 0a20          elif (. 
+0001d6b0: 2020 2020 2020 2020 2020 2065 7665 6e74             event
+0001d6c0: 2e63 6f6e 7465 6e74 5f68 6173 6820 3d3d  .content_hash ==
+0001d6d0: 2073 656c 662e 6765 745f 6c6f 6361 6c5f   self.get_local_
+0001d6e0: 6861 7368 2865 7665 6e74 2e6c 6f63 616c  hash(event.local
+0001d6f0: 5f70 6174 6829 0a20 2020 2020 2020 2020  _path).         
+0001d700: 2020 2061 6e64 2065 7665 6e74 2e73 796d     and event.sym
+0001d710: 6c69 6e6b 5f74 6172 6765 7420 3d3d 206c  link_target == l
+0001d720: 6f63 616c 5f73 796d 6c69 6e6b 5f74 6172  ocal_symlink_tar
+0001d730: 6765 740a 2020 2020 2020 2020 293a 0a20  get.        ):. 
+0001d740: 2020 2020 2020 2020 2020 2023 2043 6f6e             # Con
+0001d750: 7465 6e74 2068 6173 6865 7320 6172 6520  tent hashes are 
+0001d760: 6571 7561 6c2c 2074 6865 7265 666f 7265  equal, therefore
+0001d770: 2069 7465 6d73 2061 7265 2069 6465 6e74   items are ident
+0001d780: 6963 616c 2e20 466f 6c64 6572 7320 7769  ical. Folders wi
+0001d790: 6c6c 0a20 2020 2020 2020 2020 2020 2023  ll.            #
+0001d7a0: 2068 6176 6520 6120 636f 6e74 656e 7420   have a content 
+0001d7b0: 6861 7368 206f 6620 2766 6f6c 6465 7227  hash of 'folder'
+0001d7c0: 2e0a 2020 2020 2020 2020 2020 2020 7365  ..            se
+0001d7d0: 6c66 2e5f 6c6f 6767 6572 2e64 6562 7567  lf._logger.debug
+0001d7e0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+0001d7f0: 2020 2745 7175 616c 2063 6f6e 7465 6e74    'Equal content
+0001d800: 2068 6173 6865 7320 666f 7220 2225 7322   hashes for "%s"
+0001d810: 3a20 6e6f 2063 6f6e 666c 6963 7427 2c20  : no conflict', 
+0001d820: 6576 656e 742e 6462 785f 7061 7468 0a20  event.dbx_path. 
+0001d830: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
+0001d840: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+0001d850: 436f 6e66 6c69 6374 2e49 6465 6e74 6963  Conflict.Identic
+0001d860: 616c 0a20 2020 2020 2020 2065 6c69 6620  al.        elif 
+0001d870: 280a 2020 2020 2020 2020 2020 2020 6c65  (.            le
+0001d880: 6e28 0a20 2020 2020 2020 2020 2020 2020  n(.             
+0001d890: 2020 2073 656c 662e 7379 6e63 5f65 7272     self.sync_err
+0001d8a0: 6f72 735f 666f 725f 7061 7468 280a 2020  ors_for_path(.  
+0001d8b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d8c0: 2020 6576 656e 742e 6462 785f 7061 7468    event.dbx_path
+0001d8d0: 5f6c 6f77 6572 2c20 6469 7265 6374 696f  _lower, directio
+0001d8e0: 6e3d 5379 6e63 4469 7265 6374 696f 6e2e  n=SyncDirection.
+0001d8f0: 5570 0a20 2020 2020 2020 2020 2020 2020  Up.             
+0001d900: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
+0001d910: 2029 0a20 2020 2020 2020 2020 2020 203e   ).            >
+0001d920: 2030 0a20 2020 2020 2020 2029 3a0a 2020   0.        ):.  
+0001d930: 2020 2020 2020 2020 2020 2320 4c6f 6361            # Loca
+0001d940: 6c20 7665 7273 696f 6e20 636f 756c 6420  l version could 
+0001d950: 6e6f 7420 6265 2075 706c 6f61 6465 6420  not be uploaded 
+0001d960: 6475 6520 746f 2061 2073 796e 6320 6572  due to a sync er
+0001d970: 726f 722e 2044 6f20 6e6f 740a 2020 2020  ror. Do not.    
+0001d980: 2020 2020 2020 2020 2320 6f76 6572 2d77          # over-w
+0001d990: 7269 7465 2075 6e73 796e 6365 6420 6368  rite unsynced ch
+0001d9a0: 616e 6765 7320 6275 7420 6465 636c 6172  anges but declar
+0001d9b0: 6520 6120 636f 6e66 6c69 6374 2e0a 2020  e a conflict..  
+0001d9c0: 2020 2020 2020 2020 2020 7365 6c66 2e5f            self._
+0001d9d0: 6c6f 6767 6572 2e64 6562 7567 280a 2020  logger.debug(.  
+0001d9e0: 2020 2020 2020 2020 2020 2020 2020 2755                'U
+0001d9f0: 6e72 6573 6f6c 7665 6420 7570 6c6f 6164  nresolved upload
+0001da00: 2065 7272 6f72 2066 6f72 2022 2573 223a   error for "%s":
+0001da10: 2063 6f6e 666c 6963 7427 2c20 6576 656e   conflict', even
+0001da20: 742e 6462 785f 7061 7468 0a20 2020 2020  t.dbx_path.     
+0001da30: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+0001da40: 2020 2020 2072 6574 7572 6e20 436f 6e66       return Conf
+0001da50: 6c69 6374 2e43 6f6e 666c 6963 740a 2020  lict.Conflict.  
+0001da60: 2020 2020 2020 656c 6966 206e 6f74 2073        elif not s
+0001da70: 656c 662e 5f63 7469 6d65 5f6e 6577 6572  elf._ctime_newer
+0001da80: 5f74 6861 6e5f 6c61 7374 5f73 796e 6328  _than_last_sync(
+0001da90: 6576 656e 742e 6c6f 6361 6c5f 7061 7468  event.local_path
+0001daa0: 293a 0a20 2020 2020 2020 2020 2020 2023  ):.            #
+0001dab0: 204c 6173 7420 6368 616e 6765 2074 696d   Last change tim
+0001dac0: 6520 6f66 206c 6f63 616c 2069 7465 6d20  e of local item 
+0001dad0: 2872 6563 7572 7369 7665 2066 6f72 2066  (recursive for f
+0001dae0: 6f6c 6465 7273 2920 6973 206f 6c64 6572  olders) is older
+0001daf0: 2074 6861 6e0a 2020 2020 2020 2020 2020   than.          
+0001db00: 2020 2320 7468 6520 6c61 7374 2074 696d    # the last tim
+0001db10: 6520 7468 6520 6974 656d 2077 6173 2073  e the item was s
+0001db20: 796e 6365 642e 2052 656d 6f74 6520 6d75  ynced. Remote mu
+0001db30: 7374 2062 6520 6e65 7765 722e 0a20 2020  st be newer..   
+0001db40: 2020 2020 2020 2020 2073 656c 662e 5f6c           self._l
+0001db50: 6f67 6765 722e 6465 6275 6728 0a20 2020  ogger.debug(.   
+0001db60: 2020 2020 2020 2020 2020 2020 2027 4c6f               'Lo
+0001db70: 6361 6c20 6974 656d 2022 2573 2220 6861  cal item "%s" ha
+0001db80: 7320 6e6f 2075 6e73 796e 6365 6420 6368  s no unsynced ch
+0001db90: 616e 6765 733a 2072 656d 6f74 6520 6974  anges: remote it
+0001dba0: 656d 2069 7320 6e65 7765 7227 2c0a 2020  em is newer',.  
+0001dbb0: 2020 2020 2020 2020 2020 2020 2020 6576                ev
+0001dbc0: 656e 742e 6462 785f 7061 7468 2c0a 2020  ent.dbx_path,.  
+0001dbd0: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
+0001dbe0: 2020 2020 2020 2020 7265 7475 726e 2043          return C
+0001dbf0: 6f6e 666c 6963 742e 5265 6d6f 7465 4e65  onflict.RemoteNe
+0001dc00: 7765 720a 2020 2020 2020 2020 656c 6966  wer.        elif
+0001dc10: 2065 7665 6e74 2e69 735f 6465 6c65 7465   event.is_delete
+0001dc20: 643a 0a20 2020 2020 2020 2020 2020 2023  d:.            #
+0001dc30: 2052 656d 6f74 6520 6974 656d 2077 6173   Remote item was
+0001dc40: 2064 656c 6574 6564 2062 7574 206c 6f63   deleted but loc
+0001dc50: 616c 2069 7465 6d20 6861 7320 6265 656e  al item has been
+0001dc60: 206d 6f64 6966 6965 6420 7369 6e63 6520   modified since 
+0001dc70: 7468 656e 2e0a 2020 2020 2020 2020 2020  then..          
+0001dc80: 2020 7365 6c66 2e5f 6c6f 6767 6572 2e64    self._logger.d
+0001dc90: 6562 7567 280a 2020 2020 2020 2020 2020  ebug(.          
+0001dca0: 2020 2020 2020 274c 6f63 616c 2069 7465        'Local ite
+0001dcb0: 6d20 2225 7322 2068 6173 2075 6e73 796e  m "%s" has unsyn
+0001dcc0: 6365 6420 6368 616e 6765 7320 616e 6420  ced changes and 
+0001dcd0: 7265 6d6f 7465 2077 6173 2027 0a20 2020  remote was '.   
+0001dce0: 2020 2020 2020 2020 2020 2020 2022 6465               "de
+0001dcf0: 6c65 7465 643a 206c 6f63 616c 2069 7465  leted: local ite
+0001dd00: 6d20 6973 206e 6577 6572 222c 0a20 2020  m is newer",.   
+0001dd10: 2020 2020 2020 2020 2020 2020 2065 7665               eve
+0001dd20: 6e74 2e64 6278 5f70 6174 682c 0a20 2020  nt.dbx_path,.   
+0001dd30: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
+0001dd40: 2020 2020 2020 2072 6574 7572 6e20 436f         return Co
+0001dd50: 6e66 6c69 6374 2e4c 6f63 616c 4e65 7765  nflict.LocalNewe
+0001dd60: 724f 7249 6465 6e74 6963 616c 0a20 2020  rOrIdentical.   
+0001dd70: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+0001dd80: 2020 2020 2020 2023 2042 6f74 6820 7265         # Both re
+0001dd90: 6d6f 7465 2061 6e64 206c 6f63 616c 2069  mote and local i
+0001dda0: 7465 6d73 2068 6176 6520 756e 7379 6e63  tems have unsync
+0001ddb0: 6564 2063 6861 6e67 6573 3a20 636f 6e66  ed changes: conf
+0001ddc0: 6c69 6374 2e0a 2020 2020 2020 2020 2020  lict..          
+0001ddd0: 2020 7365 6c66 2e5f 6c6f 6767 6572 2e64    self._logger.d
+0001dde0: 6562 7567 280a 2020 2020 2020 2020 2020  ebug(.          
+0001ddf0: 2020 2020 2020 274c 6f63 616c 2069 7465        'Local ite
+0001de00: 6d20 2225 7322 2068 6173 2075 6e73 796e  m "%s" has unsyn
+0001de10: 6365 6420 6c6f 6361 6c20 6368 616e 6765  ced local change
+0001de20: 733a 2063 6f6e 666c 6963 7427 2c0a 2020  s: conflict',.  
+0001de30: 2020 2020 2020 2020 2020 2020 2020 6576                ev
+0001de40: 656e 742e 6462 785f 7061 7468 2c0a 2020  ent.dbx_path,.  
+0001de50: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
+0001de60: 2020 2020 2020 2020 7265 7475 726e 2043          return C
+0001de70: 6f6e 666c 6963 742e 436f 6e66 6c69 6374  onflict.Conflict
+0001de80: 0a0a 2020 2020 6465 6620 5f63 7469 6d65  ..    def _ctime
+0001de90: 5f6e 6577 6572 5f74 6861 6e5f 6c61 7374  _newer_than_last
+0001dea0: 5f73 796e 6328 7365 6c66 2c20 6c6f 6361  _sync(self, loca
+0001deb0: 6c5f 7061 7468 3a20 7374 7229 202d 3e20  l_path: str) -> 
+0001dec0: 626f 6f6c 3a0a 2020 2020 2020 2020 2222  bool:.        ""
+0001ded0: 220a 2020 2020 2020 2020 4368 6563 6b73  ".        Checks
+0001dee0: 2069 6620 6120 6c6f 6361 6c20 6974 656d   if a local item
+0001def0: 2068 6173 2061 6e79 2075 6e73 796e 6365   has any unsynce
+0001df00: 6420 6368 616e 6765 732e 2054 6869 7320  d changes. This 
+0001df10: 6973 2062 7920 636f 6d70 6172 696e 6720  is by comparing 
+0001df20: 6974 7320 6374 696d 650a 2020 2020 2020  its ctime.      
+0001df30: 2020 746f 2074 6865 2060 606c 6173 745f    to the ``last_
+0001df40: 7379 6e63 6060 2074 696d 6520 7361 7665  sync`` time save
+0001df50: 6420 696e 206f 7572 2069 6e64 6578 2e20  d in our index. 
+0001df60: 496e 2063 6173 6520 6f66 2066 6f6c 6465  In case of folde
+0001df70: 7273 2c20 7765 2072 6563 7572 7369 7665  rs, we recursive
+0001df80: 6c79 0a20 2020 2020 2020 2063 6865 636b  ly.        check
+0001df90: 2074 6865 2063 7469 6d65 206f 6620 6368   the ctime of ch
+0001dfa0: 696c 6472 656e 2e0a 0a20 2020 2020 2020  ildren...       
+0001dfb0: 203a 7061 7261 6d20 6c6f 6361 6c5f 7061   :param local_pa
+0001dfc0: 7468 3a20 4c6f 6361 6c20 7061 7468 206f  th: Local path o
+0001dfd0: 6620 6974 656d 2074 6f20 6368 6563 6b2e  f item to check.
+0001dfe0: 0a20 2020 2020 2020 203a 7265 7475 726e  .        :return
+0001dff0: 733a 2057 6865 7468 6572 2074 6865 206c  s: Whether the l
+0001e000: 6f63 616c 2069 7465 6d20 6861 7320 756e  ocal item has un
+0001e010: 7379 6e63 6564 2063 6861 6e67 6573 2e0a  synced changes..
+0001e020: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
+0001e030: 2020 2020 6966 2073 656c 662e 6973 5f65      if self.is_e
+0001e040: 7863 6c75 6465 6428 6c6f 6361 6c5f 7061  xcluded(local_pa
+0001e050: 7468 293a 0a20 2020 2020 2020 2020 2020  th):.           
+0001e060: 2023 2045 7863 6c75 6465 6420 6e61 6d65   # Excluded name
+0001e070: 7320 7375 6368 2061 7320 2e44 535f 5374  s such as .DS_St
+0001e080: 6f72 6520 6574 632e 206e 6576 6572 2063  ore etc. never c
+0001e090: 6f75 6e74 2061 7320 756e 7379 6e63 6564  ount as unsynced
+0001e0a0: 2063 6861 6e67 6573 2e0a 2020 2020 2020   changes..      
+0001e0b0: 2020 2020 2020 7265 7475 726e 2046 616c        return Fal
+0001e0c0: 7365 0a0a 2020 2020 2020 2020 6462 785f  se..        dbx_
+0001e0d0: 7061 7468 5f6c 6f77 6572 203d 2073 656c  path_lower = sel
+0001e0e0: 662e 746f 5f64 6278 5f70 6174 685f 6c6f  f.to_dbx_path_lo
+0001e0f0: 7765 7228 6c6f 6361 6c5f 7061 7468 290a  wer(local_path).
+0001e100: 2020 2020 2020 2020 696e 6465 785f 656e          index_en
+0001e110: 7472 7920 3d20 7365 6c66 2e67 6574 5f69  try = self.get_i
+0001e120: 6e64 6578 5f65 6e74 7279 2864 6278 5f70  ndex_entry(dbx_p
+0001e130: 6174 685f 6c6f 7765 7229 0a0a 2020 2020  ath_lower)..    
+0001e140: 2020 2020 7769 7468 2063 6f6e 7665 7274      with convert
+0001e150: 5f61 7069 5f65 7272 6f72 7328 6c6f 6361  _api_errors(loca
+0001e160: 6c5f 7061 7468 3d6c 6f63 616c 5f70 6174  l_path=local_pat
+0001e170: 6829 3a20 2023 2043 6174 6368 204f 5345  h):  # Catch OSE
+0001e180: 7272 6f72 732e 0a20 2020 2020 2020 2020  rrors..         
+0001e190: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
+0001e1a0: 2020 2020 2020 2020 7374 6174 203d 206f          stat = o
+0001e1b0: 732e 6c73 7461 7428 6c6f 6361 6c5f 7061  s.lstat(local_pa
+0001e1c0: 7468 290a 2020 2020 2020 2020 2020 2020  th).            
+0001e1d0: 6578 6365 7074 2028 4669 6c65 4e6f 7446  except (FileNotF
+0001e1e0: 6f75 6e64 4572 726f 722c 204e 6f74 4144  oundError, NotAD
+0001e1f0: 6972 6563 746f 7279 4572 726f 7229 3a0a  irectoryError):.
+0001e200: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e210: 2320 446f 6e27 7420 6368 6563 6b20 6374  # Don't check ct
+0001e220: 696d 6520 666f 7220 6465 6c65 7465 6420  ime for deleted 
+0001e230: 6974 656d 7320 286f 7320 776f 6e27 7420  items (os won't 
+0001e240: 6769 7665 2073 7461 7420 696e 666f 290a  give stat info).
+0001e250: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e260: 2320 6275 7420 636f 6e66 6972 6d20 6162  # but confirm ab
+0001e270: 7365 6e63 6520 6672 6f6d 2069 6e64 6578  sence from index
+0001e280: 2e0a 2020 2020 2020 2020 2020 2020 2020  ..              
+0001e290: 2020 7265 7475 726e 2069 6e64 6578 5f65    return index_e
+0001e2a0: 6e74 7279 2069 7320 6e6f 7420 4e6f 6e65  ntry is not None
+0001e2b0: 0a0a 2020 2020 2020 2020 2020 2020 6966  ..            if
+0001e2c0: 2053 5f49 5344 4952 2873 7461 742e 7374   S_ISDIR(stat.st
+0001e2d0: 5f6d 6f64 6529 3a0a 2020 2020 2020 2020  _mode):.        
+0001e2e0: 2020 2020 2020 2020 2320 446f 6e27 7420          # Don't 
+0001e2f0: 6368 6563 6b20 6374 696d 6520 666f 7220  check ctime for 
+0001e300: 666f 6c64 6572 7320 6275 7420 636f 6d70  folders but comp
+0001e310: 6172 6520 746f 2069 6e64 6578 2065 6e74  are to index ent
+0001e320: 7279 2074 7970 652e 0a20 2020 2020 2020  ry type..       
+0001e330: 2020 2020 2020 2020 2069 6620 696e 6465           if inde
+0001e340: 785f 656e 7472 7920 6973 204e 6f6e 6520  x_entry is None 
+0001e350: 6f72 2069 6e64 6578 5f65 6e74 7279 2e69  or index_entry.i
+0001e360: 735f 6669 6c65 3a0a 2020 2020 2020 2020  s_file:.        
+0001e370: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+0001e380: 726e 2054 7275 650a 0a20 2020 2020 2020  rn True..       
+0001e390: 2020 2020 2020 2020 2023 2052 6563 7572           # Recur
+0001e3a0: 7365 206f 7665 7220 6368 696c 6472 656e  se over children
+0001e3b0: 2e0a 2020 2020 2020 2020 2020 2020 2020  ..              
+0001e3c0: 2020 7769 7468 206f 732e 7363 616e 6469    with os.scandi
+0001e3d0: 7228 6c6f 6361 6c5f 7061 7468 2920 6173  r(local_path) as
+0001e3e0: 2069 743a 0a20 2020 2020 2020 2020 2020   it:.           
+0001e3f0: 2020 2020 2020 2020 2066 6f72 2065 6e74           for ent
+0001e400: 7279 2069 6e20 6974 3a0a 2020 2020 2020  ry in it:.      
+0001e410: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e420: 2020 6966 2065 6e74 7279 2e69 735f 6469    if entry.is_di
+0001e430: 7228 666f 6c6c 6f77 5f73 796d 6c69 6e6b  r(follow_symlink
+0001e440: 733d 4661 6c73 6529 3a0a 2020 2020 2020  s=False):.      
+0001e450: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e460: 2020 2020 2020 6966 2073 656c 662e 5f63        if self._c
+0001e470: 7469 6d65 5f6e 6577 6572 5f74 6861 6e5f  time_newer_than_
+0001e480: 6c61 7374 5f73 796e 6328 656e 7472 792e  last_sync(entry.
+0001e490: 7061 7468 293a 0a20 2020 2020 2020 2020  path):.         
+0001e4a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e4b0: 2020 2020 2020 2072 6574 7572 6e20 5472         return Tr
+0001e4c0: 7565 0a20 2020 2020 2020 2020 2020 2020  ue.             
+0001e4d0: 2020 2020 2020 2020 2020 2065 6c69 6620             elif 
+0001e4e0: 6e6f 7420 7365 6c66 2e69 735f 6578 636c  not self.is_excl
+0001e4f0: 7564 6564 2865 6e74 7279 2e6e 616d 6529  uded(entry.name)
+0001e500: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0001e510: 2020 2020 2020 2020 2020 2020 2020 6368                ch
+0001e520: 696c 645f 6462 785f 7061 7468 5f6c 6f77  ild_dbx_path_low
+0001e530: 6572 203d 2073 656c 662e 746f 5f64 6278  er = self.to_dbx
+0001e540: 5f70 6174 685f 6c6f 7765 7228 656e 7472  _path_lower(entr
+0001e550: 792e 7061 7468 290a 2020 2020 2020 2020  y.path).        
+0001e560: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e570: 2020 2020 6374 696d 6520 3d20 656e 7472      ctime = entr
+0001e580: 792e 7374 6174 2866 6f6c 6c6f 775f 7379  y.stat(follow_sy
+0001e590: 6d6c 696e 6b73 3d46 616c 7365 292e 7374  mlinks=False).st
+0001e5a0: 5f63 7469 6d65 0a20 2020 2020 2020 2020  _ctime.         
+0001e5b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e5c0: 2020 2069 6620 6374 696d 6520 3e20 7365     if ctime > se
+0001e5d0: 6c66 2e67 6574 5f6c 6173 745f 7379 6e63  lf.get_last_sync
+0001e5e0: 2863 6869 6c64 5f64 6278 5f70 6174 685f  (child_dbx_path_
+0001e5f0: 6c6f 7765 7229 3a0a 2020 2020 2020 2020  lower):.        
+0001e600: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e610: 2020 2020 2020 2020 7265 7475 726e 2054          return T
+0001e620: 7275 650a 0a20 2020 2020 2020 2020 2020  rue..           
+0001e630: 2020 2020 2072 6574 7572 6e20 4661 6c73       return Fals
+0001e640: 650a 0a20 2020 2020 2020 2020 2020 2065  e..            e
+0001e650: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+0001e660: 2020 2020 2023 2043 6865 636b 206f 7572       # Check our
+0001e670: 2063 7469 6d65 2061 6761 696e 7374 2069   ctime against i
+0001e680: 6e64 6578 2e0a 2020 2020 2020 2020 2020  ndex..          
+0001e690: 2020 2020 2020 7265 7475 726e 2073 7461        return sta
+0001e6a0: 742e 7374 5f63 7469 6d65 203e 2073 656c  t.st_ctime > sel
+0001e6b0: 662e 6765 745f 6c61 7374 5f73 796e 6328  f.get_last_sync(
+0001e6c0: 6462 785f 7061 7468 5f6c 6f77 6572 290a  dbx_path_lower).
+0001e6d0: 0a20 2020 2064 6566 205f 6765 745f 6374  .    def _get_ct
+0001e6e0: 696d 6528 7365 6c66 2c20 6c6f 6361 6c5f  ime(self, local_
+0001e6f0: 7061 7468 3a20 7374 7229 202d 3e20 666c  path: str) -> fl
+0001e700: 6f61 743a 0a20 2020 2020 2020 2022 2222  oat:.        """
+0001e710: 0a20 2020 2020 2020 2052 6574 7572 6e73  .        Returns
+0001e720: 2074 6865 2063 7469 6d65 206f 6620 6120   the ctime of a 
+0001e730: 6c6f 6361 6c20 6974 656d 206f 7220 2d31  local item or -1
+0001e740: 2e30 2069 6620 7468 6572 6520 6973 206e  .0 if there is n
+0001e750: 6f74 6869 6e67 2061 7420 7468 6520 7061  othing at the pa
+0001e760: 7468 2e20 4966 0a20 2020 2020 2020 2074  th. If.        t
+0001e770: 6865 2069 7465 6d20 6973 2061 2064 6972  he item is a dir
+0001e780: 6563 746f 7279 2c20 7265 7475 726e 2074  ectory, return t
+0001e790: 6865 206c 6172 6765 7374 2063 7469 6d65  he largest ctime
+0001e7a0: 206f 6620 6974 2061 6e64 2069 7473 2063   of it and its c
+0001e7b0: 6869 6c64 7265 6e2e 2049 7465 6d73 0a20  hildren. Items. 
+0001e7c0: 2020 2020 2020 2077 6869 6368 2061 7265         which are
+0001e7d0: 2065 7863 6c75 6465 6420 6672 6f6d 2073   excluded from s
+0001e7e0: 796e 6369 6e67 2028 652e 672e 2c20 2e44  yncing (e.g., .D
+0001e7f0: 535f 5374 6f72 6520 6669 6c65 7329 2061  S_Store files) a
+0001e800: 7265 2069 676e 6f72 6564 2e0a 0a20 2020  re ignored...   
+0001e810: 2020 2020 203a 7061 7261 6d20 6c6f 6361       :param loca
+0001e820: 6c5f 7061 7468 3a20 4162 736f 6c75 7465  l_path: Absolute
+0001e830: 2070 6174 6820 6f6e 206c 6f63 616c 2064   path on local d
+0001e840: 7269 7665 2e0a 2020 2020 2020 2020 3a72  rive..        :r
+0001e850: 6574 7572 6e73 3a20 4374 696d 6520 6f72  eturns: Ctime or
+0001e860: 202d 312e 302e 0a20 2020 2020 2020 2022   -1.0..        "
+0001e870: 2222 0a20 2020 2020 2020 2074 7279 3a0a  "".        try:.
+0001e880: 2020 2020 2020 2020 2020 2020 7374 6174              stat
+0001e890: 203d 206f 732e 6c73 7461 7428 6c6f 6361   = os.lstat(loca
+0001e8a0: 6c5f 7061 7468 290a 2020 2020 2020 2020  l_path).        
+0001e8b0: 2020 2020 6966 2053 5f49 5344 4952 2873      if S_ISDIR(s
+0001e8c0: 7461 742e 7374 5f6d 6f64 6529 3a0a 2020  tat.st_mode):.  
+0001e8d0: 2020 2020 2020 2020 2020 2020 2020 6374                ct
+0001e8e0: 696d 6520 3d20 7374 6174 2e73 745f 6374  ime = stat.st_ct
+0001e8f0: 696d 650a 2020 2020 2020 2020 2020 2020  ime.            
+0001e900: 2020 2020 7769 7468 206f 732e 7363 616e      with os.scan
+0001e910: 6469 7228 6c6f 6361 6c5f 7061 7468 2920  dir(local_path) 
+0001e920: 6173 2069 743a 0a20 2020 2020 2020 2020  as it:.         
+0001e930: 2020 2020 2020 2020 2020 2066 6f72 2065             for e
+0001e940: 6e74 7279 2069 6e20 6974 3a0a 2020 2020  ntry in it:.    
+0001e950: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e960: 2020 2020 6966 2065 6e74 7279 2e69 735f      if entry.is_
+0001e970: 6469 7228 666f 6c6c 6f77 5f73 796d 6c69  dir(follow_symli
+0001e980: 6e6b 733d 4661 6c73 6529 3a0a 2020 2020  nks=False):.    
+0001e990: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e9a0: 2020 2020 2020 2020 6368 696c 645f 6374          child_ct
+0001e9b0: 696d 6520 3d20 7365 6c66 2e5f 6765 745f  ime = self._get_
+0001e9c0: 6374 696d 6528 656e 7472 792e 7061 7468  ctime(entry.path
+0001e9d0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0001e9e0: 2020 2020 2020 2020 2020 656c 6966 206e            elif n
+0001e9f0: 6f74 2073 656c 662e 6973 5f65 7863 6c75  ot self.is_exclu
+0001ea00: 6465 6428 656e 7472 792e 6e61 6d65 293a  ded(entry.name):
+0001ea10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001ea20: 2020 2020 2020 2020 2020 2020 2063 6869               chi
+0001ea30: 6c64 5f63 7469 6d65 203d 2065 6e74 7279  ld_ctime = entry
+0001ea40: 2e73 7461 7428 666f 6c6c 6f77 5f73 796d  .stat(follow_sym
+0001ea50: 6c69 6e6b 733d 4661 6c73 6529 2e73 745f  links=False).st_
+0001ea60: 6374 696d 650a 2020 2020 2020 2020 2020  ctime.          
+0001ea70: 2020 2020 2020 2020 2020 2020 2020 656c                el
+0001ea80: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+0001ea90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001eaa0: 6368 696c 645f 6374 696d 6520 3d20 2d31  child_ctime = -1
+0001eab0: 2e30 0a0a 2020 2020 2020 2020 2020 2020  .0..            
+0001eac0: 2020 2020 2020 2020 2020 2020 6374 696d              ctim
+0001ead0: 6520 3d20 6d61 7828 6374 696d 652c 2063  e = max(ctime, c
+0001eae0: 6869 6c64 5f63 7469 6d65 290a 0a20 2020  hild_ctime)..   
+0001eaf0: 2020 2020 2020 2020 2020 2020 2072 6574               ret
+0001eb00: 7572 6e20 6374 696d 650a 2020 2020 2020  urn ctime.      
+0001eb10: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+0001eb20: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+0001eb30: 726e 2073 7461 742e 7374 5f63 7469 6d65  rn stat.st_ctime
+0001eb40: 0a20 2020 2020 2020 2065 7863 6570 7420  .        except 
+0001eb50: 2846 696c 654e 6f74 466f 756e 6445 7272  (FileNotFoundErr
+0001eb60: 6f72 2c20 4e6f 7441 4469 7265 6374 6f72  or, NotADirector
+0001eb70: 7945 7272 6f72 293a 0a20 2020 2020 2020  yError):.       
+0001eb80: 2020 2020 2072 6574 7572 6e20 2d31 2e30       return -1.0
+0001eb90: 0a20 2020 2020 2020 2065 7863 6570 7420  .        except 
+0001eba0: 4f53 4572 726f 7220 6173 2065 7863 3a0a  OSError as exc:.
+0001ebb0: 2020 2020 2020 2020 2020 2020 7261 6973              rais
+0001ebc0: 6520 6f73 5f74 6f5f 6d61 6573 7472 616c  e os_to_maestral
+0001ebd0: 5f65 7272 6f72 2865 7863 2c20 6c6f 6361  _error(exc, loca
+0001ebe0: 6c5f 7061 7468 3d6c 6f63 616c 5f70 6174  l_path=local_pat
+0001ebf0: 6829 0a0a 2020 2020 6465 6620 5f63 6c65  h)..    def _cle
+0001ec00: 616e 5f72 656d 6f74 655f 6368 616e 6765  an_remote_change
+0001ec10: 7328 7365 6c66 2c20 6368 616e 6765 733a  s(self, changes:
+0001ec20: 204c 6973 7446 6f6c 6465 7252 6573 756c   ListFolderResul
+0001ec30: 7429 202d 3e20 4c69 7374 466f 6c64 6572  t) -> ListFolder
+0001ec40: 5265 7375 6c74 3a0a 2020 2020 2020 2020  Result:.        
+0001ec50: 2222 220a 2020 2020 2020 2020 5461 6b65  """.        Take
+0001ec60: 7320 7265 6d6f 7465 2066 696c 6520 6576  s remote file ev
+0001ec70: 656e 7473 2073 696e 6365 206c 6173 7420  ents since last 
+0001ec80: 7379 6e63 2061 6e64 2063 6c65 616e 7320  sync and cleans 
+0001ec90: 7468 656d 2075 7020 736f 2074 6861 7420  them up so that 
+0001eca0: 7468 6572 6520 6973 0a20 2020 2020 2020  there is.       
+0001ecb0: 206f 6e6c 7920 6120 7369 6e67 6c65 2065   only a single e
+0001ecc0: 7665 6e74 2070 6572 2070 6174 682e 0a0a  vent per path...
+0001ecd0: 2020 2020 2020 2020 4472 6f70 626f 7820          Dropbox 
+0001ece0: 7769 6c6c 2073 6f6d 6574 696d 6573 2072  will sometimes r
+0001ecf0: 6570 6f72 7420 6d75 6c74 6970 6c65 2063  eport multiple c
+0001ed00: 6861 6e67 6573 2070 6572 2070 6174 682e  hanges per path.
+0001ed10: 204f 6e63 6520 7375 6368 2069 6e73 7461   Once such insta
+0001ed20: 6e63 6520 6973 0a20 2020 2020 2020 2077  nce is.        w
+0001ed30: 6865 6e20 7368 6172 696e 6720 6120 666f  hen sharing a fo
+0001ed40: 6c64 6572 3a20 6060 6669 6c65 732f 6c69  lder: ``files/li
+0001ed50: 7374 5f66 6f6c 6465 722f 636f 6e74 696e  st_folder/contin
+0001ed60: 7565 6060 2077 696c 6c20 7265 706f 7274  ue`` will report
+0001ed70: 2074 6865 2073 6861 7265 640a 2020 2020   the shared.    
+0001ed80: 2020 2020 666f 6c64 6572 2061 6e64 2069      folder and i
+0001ed90: 7473 2063 6869 6c64 7265 6e20 6173 2064  ts children as d
+0001eda0: 656c 6574 6564 2061 6e64 2074 6865 6e20  eleted and then 
+0001edb0: 6372 6561 7465 6420 6265 6361 7573 6520  created because 
+0001edc0: 7468 6520 666f 6c64 6572 202a 6973 2a0a  the folder *is*.
+0001edd0: 2020 2020 2020 2020 6163 7475 616c 6c79          actually
+0001ede0: 2064 656c 6574 6564 2066 726f 6d20 7468   deleted from th
+0001edf0: 6520 7573 6572 2773 2044 726f 7062 6f78  e user's Dropbox
+0001ee00: 2061 6e64 2072 6563 7265 6174 6564 2061   and recreated a
+0001ee10: 7320 6120 7368 6172 6564 2066 6f6c 6465  s a shared folde
+0001ee20: 7220 7768 6963 680a 2020 2020 2020 2020  r which.        
+0001ee30: 7468 656e 2067 6574 7320 6d6f 756e 7465  then gets mounte
+0001ee40: 6420 746f 2074 6865 2075 7365 7227 7320  d to the user's 
+0001ee50: 4472 6f70 626f 782e 2049 6465 616c 6c79  Dropbox. Ideally
+0001ee60: 2c20 7765 2077 616e 7420 746f 2064 6561  , we want to dea
+0001ee70: 6c20 7769 7468 2074 6869 730a 2020 2020  l with this.    
+0001ee80: 2020 2020 7769 7468 6f75 7420 7265 2d64      without re-d
+0001ee90: 6f77 6e6c 6f61 6469 6e67 2061 6c6c 2069  ownloading all i
+0001eea0: 7473 2063 6f6e 7465 6e74 732e 0a0a 2020  ts contents...  
+0001eeb0: 2020 2020 2020 3a70 6172 616d 2063 6861        :param cha
+0001eec0: 6e67 6573 3a20 5265 7375 6c74 2066 726f  nges: Result fro
+0001eed0: 6d20 4472 6f70 626f 7820 4150 4920 6361  m Dropbox API ca
+0001eee0: 6c6c 2074 6f20 7265 7472 6965 7665 2072  ll to retrieve r
+0001eef0: 656d 6f74 6520 6368 616e 6765 732e 0a20  emote changes.. 
+0001ef00: 2020 2020 2020 203a 7265 7475 726e 733a         :returns:
+0001ef10: 2043 6c65 616e 6564 2075 7020 6368 616e   Cleaned up chan
+0001ef20: 6765 7320 7769 7468 2061 2073 696e 676c  ges with a singl
+0001ef30: 6520 4d65 7461 6461 7461 2065 6e74 7279  e Metadata entry
+0001ef40: 2070 6572 2070 6174 682e 0a20 2020 2020   per path..     
+0001ef50: 2020 2022 2222 0a20 2020 2020 2020 2023     """.        #
+0001ef60: 204e 6f74 653a 2077 6520 776f 6e27 7420   Note: we won't 
+0001ef70: 6861 7665 2074 6f20 6465 616c 2077 6974  have to deal wit
+0001ef80: 6820 6d6f 6469 6669 6564 206f 7220 6d6f  h modified or mo
+0001ef90: 7665 6420 6576 656e 7473 2c0a 2020 2020  ved events,.    
+0001efa0: 2020 2020 2320 4472 6f70 626f 7820 6f6e      # Dropbox on
+0001efb0: 6c79 2072 6570 6f72 7473 2044 656c 6574  ly reports Delet
+0001efc0: 6564 4d65 7461 6461 7461 206f 7220 4669  edMetadata or Fi
+0001efd0: 6c65 4d65 7461 6461 7461 202f 2046 6f6c  leMetadata / Fol
+0001efe0: 6465 724d 6574 6164 6174 610a 2020 2020  derMetadata.    
+0001eff0: 2020 2020 6869 7374 6f72 6965 733a 2064      histories: d
+0001f000: 6566 6175 6c74 6469 6374 5b73 7472 2c20  efaultdict[str, 
+0001f010: 6c69 7374 5b4d 6574 6164 6174 615d 5d20  list[Metadata]] 
+0001f020: 3d20 6465 6661 756c 7464 6963 7428 6c69  = defaultdict(li
+0001f030: 7374 290a 0a20 2020 2020 2020 2066 6f72  st)..        for
+0001f040: 2065 6e74 7279 2069 6e20 6368 616e 6765   entry in change
+0001f050: 732e 656e 7472 6965 733a 0a20 2020 2020  s.entries:.     
+0001f060: 2020 2020 2020 2068 6973 746f 7269 6573         histories
+0001f070: 5b65 6e74 7279 2e70 6174 685f 6c6f 7765  [entry.path_lowe
+0001f080: 725d 2e61 7070 656e 6428 656e 7472 7929  r].append(entry)
+0001f090: 0a0a 2020 2020 2020 2020 6e65 775f 656e  ..        new_en
+0001f0a0: 7472 6965 7320 3d20 5b5d 0a0a 2020 2020  tries = []..    
+0001f0b0: 2020 2020 666f 7220 6820 696e 2068 6973      for h in his
+0001f0c0: 746f 7269 6573 2e76 616c 7565 7328 293a  tories.values():
+0001f0d0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+0001f0e0: 6c65 6e28 6829 203d 3d20 313a 0a20 2020  len(h) == 1:.   
+0001f0f0: 2020 2020 2020 2020 2020 2020 206e 6577               new
+0001f100: 5f65 6e74 7269 6573 2e65 7874 656e 6428  _entries.extend(
+0001f110: 6829 0a20 2020 2020 2020 2020 2020 2065  h).            e
+0001f120: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+0001f130: 2020 2020 206c 6173 745f 6576 656e 7420       last_event 
+0001f140: 3d20 685b 2d31 5d0a 2020 2020 2020 2020  = h[-1].        
+0001f150: 2020 2020 2020 2020 6c6f 6361 6c5f 656e          local_en
+0001f160: 7472 7920 3d20 7365 6c66 2e67 6574 5f69  try = self.get_i
+0001f170: 6e64 6578 5f65 6e74 7279 286c 6173 745f  ndex_entry(last_
+0001f180: 6576 656e 742e 7061 7468 5f6c 6f77 6572  event.path_lower
+0001f190: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0001f1a0: 2020 7761 735f 6469 7220 3d20 6c6f 6361    was_dir = loca
+0001f1b0: 6c5f 656e 7472 7920 616e 6420 6c6f 6361  l_entry and loca
+0001f1c0: 6c5f 656e 7472 792e 6973 5f64 6972 6563  l_entry.is_direc
+0001f1d0: 746f 7279 0a0a 2020 2020 2020 2020 2020  tory..          
+0001f1e0: 2020 2020 2020 2320 4472 6f70 626f 7820        # Dropbox 
+0001f1f0: 6775 6172 616e 7465 6573 2074 6861 7420  guarantees that 
+0001f200: 6170 706c 7969 6e67 2065 7665 6e74 7320  applying events 
+0001f210: 696e 2074 6865 2070 726f 7669 6465 6420  in the provided 
+0001f220: 6f72 6465 7220 7769 6c6c 0a20 2020 2020  order will.     
+0001f230: 2020 2020 2020 2020 2020 2023 2072 6570             # rep
+0001f240: 726f 6475 6365 2074 6865 2073 7461 7465  roduce the state
+0001f250: 2069 6e20 7468 6520 636c 6f75 642e 2057   in the cloud. W
+0001f260: 6520 7468 6572 6566 6f72 6520 6b65 6570  e therefore keep
+0001f270: 206f 6e6c 7920 7468 6520 6c61 7374 0a20   only the last. 
+0001f280: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+0001f290: 2065 7665 6e74 2c20 756e 6c65 7373 2074   event, unless t
+0001f2a0: 6865 7265 2069 7320 6120 6368 616e 6765  here is a change
+0001f2b0: 2069 6e20 6974 656d 2074 7970 652e 0a20   in item type.. 
+0001f2c0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+0001f2d0: 6620 280a 2020 2020 2020 2020 2020 2020  f (.            
+0001f2e0: 2020 2020 2020 2020 7761 735f 6469 720a          was_dir.
+0001f2f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001f300: 2020 2020 616e 6420 6973 696e 7374 616e      and isinstan
+0001f310: 6365 286c 6173 745f 6576 656e 742c 2046  ce(last_event, F
+0001f320: 696c 654d 6574 6164 6174 6129 0a20 2020  ileMetadata).   
+0001f330: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001f340: 206f 7220 6e6f 7420 7761 735f 6469 720a   or not was_dir.
+0001f350: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001f360: 2020 2020 616e 6420 6973 696e 7374 616e      and isinstan
+0001f370: 6365 286c 6173 745f 6576 656e 742c 2046  ce(last_event, F
+0001f380: 6f6c 6465 724d 6574 6164 6174 6129 0a20  olderMetadata). 
+0001f390: 2020 2020 2020 2020 2020 2020 2020 2029                 )
+0001f3a0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0001f3b0: 2020 2020 2020 6465 6c65 7465 645f 6576        deleted_ev
+0001f3c0: 656e 7420 3d20 4465 6c65 7465 644d 6574  ent = DeletedMet
+0001f3d0: 6164 6174 6128 0a20 2020 2020 2020 2020  adata(.         
+0001f3e0: 2020 2020 2020 2020 2020 2020 2020 206e                 n
+0001f3f0: 616d 653d 6c61 7374 5f65 7665 6e74 2e6e  ame=last_event.n
+0001f400: 616d 652c 0a20 2020 2020 2020 2020 2020  ame,.           
+0001f410: 2020 2020 2020 2020 2020 2020 2070 6174               pat
+0001f420: 685f 6c6f 7765 723d 6c61 7374 5f65 7665  h_lower=last_eve
+0001f430: 6e74 2e70 6174 685f 6c6f 7765 722c 0a20  nt.path_lower,. 
+0001f440: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001f450: 2020 2020 2020 2070 6174 685f 6469 7370         path_disp
+0001f460: 6c61 793d 6c61 7374 5f65 7665 6e74 2e70  lay=last_event.p
+0001f470: 6174 685f 6469 7370 6c61 792c 0a20 2020  ath_display,.   
+0001f480: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001f490: 2029 0a20 2020 2020 2020 2020 2020 2020   ).             
+0001f4a0: 2020 2020 2020 206e 6577 5f65 6e74 7269         new_entri
+0001f4b0: 6573 2e61 7070 656e 6428 6465 6c65 7465  es.append(delete
+0001f4c0: 645f 6576 656e 7429 0a20 2020 2020 2020  d_event).       
+0001f4d0: 2020 2020 2020 2020 2020 2020 206e 6577               new
+0001f4e0: 5f65 6e74 7269 6573 2e61 7070 656e 6428  _entries.append(
+0001f4f0: 6c61 7374 5f65 7665 6e74 290a 2020 2020  last_event).    
+0001f500: 2020 2020 2020 2020 2020 2020 656c 7365              else
+0001f510: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0001f520: 2020 2020 2020 6e65 775f 656e 7472 6965        new_entrie
+0001f530: 732e 6170 7065 6e64 286c 6173 745f 6576  s.append(last_ev
+0001f540: 656e 7429 0a0a 2020 2020 2020 2020 6368  ent)..        ch
+0001f550: 616e 6765 732e 656e 7472 6965 7320 3d20  anges.entries = 
+0001f560: 6e65 775f 656e 7472 6965 730a 0a20 2020  new_entries..   
+0001f570: 2020 2020 2072 6574 7572 6e20 6368 616e       return chan
+0001f580: 6765 730a 0a20 2020 2064 6566 205f 6372  ges..    def _cr
+0001f590: 6561 7465 5f6c 6f63 616c 5f65 6e74 7279  eate_local_entry
+0001f5a0: 2873 656c 662c 2065 7665 6e74 3a20 5379  (self, event: Sy
+0001f5b0: 6e63 4576 656e 7429 202d 3e20 5379 6e63  ncEvent) -> Sync
+0001f5c0: 4576 656e 743a 0a20 2020 2020 2020 2022  Event:.        "
+0001f5d0: 2222 0a20 2020 2020 2020 2041 7070 6c69  "".        Appli
+0001f5e0: 6573 2061 2066 696c 6520 2f20 666f 6c64  es a file / fold
+0001f5f0: 6572 2063 6861 6e67 6520 6672 6f6d 2044  er change from D
+0001f600: 726f 7062 6f78 2073 6572 7665 7273 2074  ropbox servers t
+0001f610: 6f20 7468 6520 6c6f 6361 6c20 4472 6f70  o the local Drop
+0001f620: 626f 7820 666f 6c64 6572 2e0a 2020 2020  box folder..    
+0001f630: 2020 2020 416e 7920 3a65 7863 3a60 6d61      Any :exc:`ma
+0001f640: 6573 7472 616c 2e65 7863 6570 7469 6f6e  estral.exception
+0001f650: 2e4d 6165 7374 7261 6c41 7069 4572 726f  .MaestralApiErro
+0001f660: 7260 2077 696c 6c20 6265 2063 6175 6768  r` will be caugh
+0001f670: 7420 616e 6420 6c6f 6767 6564 2061 730a  t and logged as.
+0001f680: 2020 2020 2020 2020 6170 7072 6f70 7269          appropri
+0001f690: 6174 652e 2045 6e74 7269 6573 2069 6e20  ate. Entries in 
+0001f6a0: 7468 6520 6c6f 6361 6c20 696e 6465 7820  the local index 
+0001f6b0: 6172 6520 6372 6561 7465 6420 6166 7465  are created afte
+0001f6c0: 7220 7375 6363 6573 7366 756c 2063 6f6d  r successful com
+0001f6d0: 706c 6574 696f 6e2e 0a0a 2020 2020 2020  pletion...      
+0001f6e0: 2020 3a70 6172 616d 2065 7665 6e74 3a20    :param event: 
+0001f6f0: 4472 6f70 626f 7820 6d65 7461 6461 7461  Dropbox metadata
+0001f700: 2e0a 2020 2020 2020 2020 3a72 6574 7572  ..        :retur
+0001f710: 6e73 3a20 436f 7079 206f 6620 7468 6520  ns: Copy of the 
+0001f720: 4472 6f70 626f 7820 6d65 7461 6461 7461  Dropbox metadata
+0001f730: 2069 6620 7468 6520 6368 616e 6765 2077   if the change w
+0001f740: 6173 2061 7070 6c69 6564 2073 7563 6365  as applied succe
+0001f750: 7373 6675 6c6c 792c 0a20 2020 2020 2020  ssfully,.       
+0001f760: 2020 2020 2060 6054 7275 6560 6020 6966       ``True`` if
+0001f770: 2074 6865 2063 6861 6e67 6520 616c 7265   the change alre
+0001f780: 6164 7920 6578 6973 7465 642c 2060 6046  ady existed, ``F
+0001f790: 616c 7365 6060 2069 6e20 6361 7365 206f  alse`` in case o
+0001f7a0: 6620 6120 7379 6e63 2065 7272 6f72 0a20  f a sync error. 
+0001f7b0: 2020 2020 2020 2020 2020 2061 6e64 2060             and `
+0001f7c0: 604e 6f6e 6560 6020 6966 2063 616e 6365  `None`` if cance
+0001f7d0: 6c6c 6564 2e0a 2020 2020 2020 2020 2222  lled..        ""
+0001f7e0: 220a 2020 2020 2020 2020 6966 2073 656c  ".        if sel
+0001f7f0: 662e 5f63 616e 6365 6c5f 7265 7175 6573  f._cancel_reques
+0001f800: 7465 642e 6973 5f73 6574 2829 3a0a 2020  ted.is_set():.  
+0001f810: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
+0001f820: 4361 6e63 656c 6c65 6445 7272 6f72 2822  CancelledError("
+0001f830: 5379 6e63 2063 616e 6365 6c6c 6564 2229  Sync cancelled")
+0001f840: 0a0a 2020 2020 2020 2020 7365 6c66 2e5f  ..        self._
+0001f850: 736c 6f77 5f64 6f77 6e28 290a 0a20 2020  slow_down()..   
+0001f860: 2020 2020 2065 7665 6e74 2e73 7461 7475       event.statu
+0001f870: 7320 3d20 5379 6e63 5374 6174 7573 2e53  s = SyncStatus.S
+0001f880: 796e 6369 6e67 0a0a 2020 2020 2020 2020  yncing..        
+0001f890: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
+0001f8a0: 2069 6620 6576 656e 742e 6973 5f64 656c   if event.is_del
+0001f8b0: 6574 6564 3a0a 2020 2020 2020 2020 2020  eted:.          
+0001f8c0: 2020 2020 2020 7374 6174 7573 203d 2073        status = s
+0001f8d0: 656c 662e 5f6f 6e5f 7265 6d6f 7465 5f64  elf._on_remote_d
+0001f8e0: 656c 6574 6564 2865 7665 6e74 290a 2020  eleted(event).  
+0001f8f0: 2020 2020 2020 2020 2020 656c 6966 2065            elif e
+0001f900: 7665 6e74 2e69 735f 6669 6c65 3a0a 2020  vent.is_file:.  
+0001f910: 2020 2020 2020 2020 2020 2020 2020 7374                st
+0001f920: 6174 7573 203d 2073 656c 662e 5f6f 6e5f  atus = self._on_
+0001f930: 7265 6d6f 7465 5f66 696c 6528 6576 656e  remote_file(even
+0001f940: 7429 0a20 2020 2020 2020 2020 2020 2065  t).            e
+0001f950: 6c69 6620 6576 656e 742e 6973 5f64 6972  lif event.is_dir
+0001f960: 6563 746f 7279 3a0a 2020 2020 2020 2020  ectory:.        
+0001f970: 2020 2020 2020 2020 7374 6174 7573 203d          status =
+0001f980: 2073 656c 662e 5f6f 6e5f 7265 6d6f 7465   self._on_remote
+0001f990: 5f66 6f6c 6465 7228 6576 656e 7429 0a20  _folder(event). 
+0001f9a0: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
+0001f9b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001f9c0: 2073 7461 7475 7320 3d20 5379 6e63 5374   status = SyncSt
+0001f9d0: 6174 7573 2e53 6b69 7070 6564 0a0a 2020  atus.Skipped..  
+0001f9e0: 2020 2020 2020 2020 2020 6576 656e 742e            event.
+0001f9f0: 7374 6174 7573 203d 2073 7461 7475 730a  status = status.
+0001fa00: 0a20 2020 2020 2020 2065 7863 6570 7420  .        except 
+0001fa10: 5379 6e63 4572 726f 7220 6173 2065 3a0a  SyncError as e:.
+0001fa20: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+0001fa30: 2e5f 6861 6e64 6c65 5f73 796e 635f 6572  ._handle_sync_er
+0001fa40: 726f 7228 652c 2064 6972 6563 7469 6f6e  ror(e, direction
+0001fa50: 3d53 796e 6344 6972 6563 7469 6f6e 2e44  =SyncDirection.D
+0001fa60: 6f77 6e29 0a20 2020 2020 2020 2020 2020  own).           
+0001fa70: 2065 7665 6e74 2e73 7461 7475 7320 3d20   event.status = 
+0001fa80: 5379 6e63 5374 6174 7573 2e46 6169 6c65  SyncStatus.Faile
+0001fa90: 640a 2020 2020 2020 2020 656c 7365 3a0a  d.        else:.
+0001faa0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+0001fab0: 2e63 6c65 6172 5f73 796e 635f 6572 726f  .clear_sync_erro
+0001fac0: 7273 5f66 726f 6d5f 6576 656e 7428 6576  rs_from_event(ev
+0001fad0: 656e 7429 0a20 2020 2020 2020 2020 2020  ent).           
+0001fae0: 2073 656c 662e 6163 7469 7669 7479 2e64   self.activity.d
+0001faf0: 6973 6361 7264 2865 7665 6e74 290a 0a20  iscard(event).. 
+0001fb00: 2020 2020 2020 2023 2041 6464 2065 7665         # Add eve
+0001fb10: 6e74 7320 746f 2068 6973 746f 7279 2064  nts to history d
+0001fb20: 6174 6162 6173 652e 0a20 2020 2020 2020  atabase..       
+0001fb30: 2069 6620 6576 656e 742e 7374 6174 7573   if event.status
+0001fb40: 203d 3d20 5379 6e63 5374 6174 7573 2e44   == SyncStatus.D
+0001fb50: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
+0001fb60: 2077 6974 6820 7365 6c66 2e5f 6461 7461   with self._data
+0001fb70: 6261 7365 5f61 6363 6573 7328 293a 0a20  base_access():. 
+0001fb80: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+0001fb90: 656c 662e 5f68 6973 746f 7279 5f74 6162  elf._history_tab
+0001fba0: 6c65 2e73 6176 6528 6576 656e 7429 0a0a  le.save(event)..
+0001fbb0: 2020 2020 2020 2020 7265 7475 726e 2065          return e
+0001fbc0: 7665 6e74 0a0a 2020 2020 6465 6620 5f65  vent..    def _e
+0001fbd0: 6e73 7572 655f 7061 7265 6e74 2873 656c  nsure_parent(sel
+0001fbe0: 662c 2065 7665 6e74 3a20 5379 6e63 4576  f, event: SyncEv
+0001fbf0: 656e 7429 202d 3e20 4e6f 6e65 3a0a 2020  ent) -> None:.  
+0001fc00: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
+0001fc10: 2020 456e 7375 7265 7320 7468 6174 2061    Ensures that a
+0001fc20: 6c6c 2070 6172 656e 7420 666f 6c64 6572  ll parent folder
+0001fc30: 7320 666f 7220 6120 7379 6e63 2065 7665  s for a sync eve
+0001fc40: 6e74 2065 7869 7374 206c 6f63 616c 6c79  nt exist locally
+0001fc50: 2e20 5468 6973 2069 7320 7573 6564 2074  . This is used t
+0001fc60: 6f0a 2020 2020 2020 2020 7072 6576 656e  o.        preven
+0001fc70: 7420 6368 696c 6472 656e 2066 726f 6d20  t children from 
+0001fc80: 6265 696e 6720 646f 776e 6c6f 6164 6564  being downloaded
+0001fc90: 2062 6566 6f72 6520 7468 6569 7220 7061   before their pa
+0001fca0: 7265 6e74 732e 2049 6e20 7468 6520 6d6f  rents. In the mo
+0001fcb0: 7374 2063 6173 6573 2c0a 2020 2020 2020  st cases,.      
+0001fcc0: 2020 7765 2077 696c 6c20 6175 746f 6d61    we will automa
+0001fcd0: 7469 6361 6c6c 7920 7379 6e63 2070 6172  tically sync par
+0001fce0: 656e 7473 2062 6566 6f72 6520 7468 6569  ents before thei
+0001fcf0: 7220 6368 696c 6472 656e 2062 7574 2074  r children but t
+0001fd00: 6869 7320 6973 206e 6f74 2061 6c77 6179  his is not alway
+0001fd10: 730a 2020 2020 2020 2020 6775 6172 616e  s.        guaran
+0001fd20: 7465 6564 2e20 5365 6520 6874 7470 733a  teed. See https:
+0001fd30: 2f2f 6769 7468 7562 2e63 6f6d 2f53 616d  //github.com/Sam
+0001fd40: 5363 686f 7474 2f6d 6165 7374 7261 6c2f  Schott/maestral/
+0001fd50: 6973 7375 6573 2f34 3532 2e0a 0a20 2020  issues/452...   
+0001fd60: 2020 2020 203a 7061 7261 6d20 6576 656e       :param even
+0001fd70: 743a 2053 796e 6345 7665 6e74 2066 6f72  t: SyncEvent for
+0001fd80: 2074 6172 6765 7420 6669 6c65 2e0a 2020   target file..  
+0001fd90: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
+0001fda0: 2020 6462 785f 7061 7468 5f6c 6f77 6572    dbx_path_lower
+0001fdb0: 5f64 6972 6e61 6d65 203d 206f 7370 2e64  _dirname = osp.d
+0001fdc0: 6972 6e61 6d65 2865 7665 6e74 2e64 6278  irname(event.dbx
+0001fdd0: 5f70 6174 685f 6c6f 7765 7229 0a0a 2020  _path_lower)..  
+0001fde0: 2020 2020 2020 6966 2064 6278 5f70 6174        if dbx_pat
+0001fdf0: 685f 6c6f 7765 725f 6469 726e 616d 6520  h_lower_dirname 
+0001fe00: 3d3d 2022 2f22 3a0a 2020 2020 2020 2020  == "/":.        
+0001fe10: 2020 2020 7265 7475 726e 0a0a 2020 2020      return..    
+0001fe20: 2020 2020 7769 7468 2073 656c 662e 5f74      with self._t
+0001fe30: 7265 655f 7472 6176 6572 7361 6c3a 0a20  ree_traversal:. 
+0001fe40: 2020 2020 2020 2020 2020 2069 6620 6e6f             if no
+0001fe50: 7420 7365 6c66 2e67 6574 5f69 6e64 6578  t self.get_index
+0001fe60: 5f65 6e74 7279 2864 6278 5f70 6174 685f  _entry(dbx_path_
+0001fe70: 6c6f 7765 725f 6469 726e 616d 6529 3a0a  lower_dirname):.
 0001fe80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001fe90: 2020 7374 6174 203d 206f 732e 6c73 7461    stat = os.lsta
-0001fea0: 7428 6576 656e 742e 6c6f 6361 6c5f 7061  t(event.local_pa
-0001feb0: 7468 290a 2020 2020 2020 2020 2020 2020  th).            
-0001fec0: 7374 6174 7573 203d 2053 796e 6353 7461  status = SyncSta
-0001fed0: 7475 732e 446f 6e65 0a20 2020 2020 2020  tus.Done.       
-0001fee0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-0001fef0: 2020 2023 2057 6520 646f 776e 6c6f 6164     # We download
-0001ff00: 2074 6f20 6120 7465 6d70 6f72 6172 7920   to a temporary 
-0001ff10: 6669 6c65 2066 6972 7374 2028 7468 6973  file first (this
-0001ff20: 206d 6179 2074 616b 6520 736f 6d65 2074   may take some t
-0001ff30: 696d 6529 2e0a 2020 2020 2020 2020 2020  ime)..          
-0001ff40: 2020 746d 705f 666e 616d 6520 3d20 7365    tmp_fname = se
-0001ff50: 6c66 2e5f 6e65 775f 746d 705f 6669 6c65  lf._new_tmp_file
-0001ff60: 2829 0a0a 2020 2020 2020 2020 2020 2020  ()..            
-0001ff70: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
-0001ff80: 2020 2020 2077 6974 6820 7365 6c66 2e5f       with self._
-0001ff90: 7061 7261 6c6c 656c 5f64 6f77 6e5f 7365  parallel_down_se
-0001ffa0: 6d61 7068 6f72 653a 0a20 2020 2020 2020  maphore:.       
-0001ffb0: 2020 2020 2020 2020 2020 2020 206d 6420               md 
-0001ffc0: 3d20 7365 6c66 2e63 6c69 656e 742e 646f  = self.client.do
-0001ffd0: 776e 6c6f 6164 280a 2020 2020 2020 2020  wnload(.        
-0001ffe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001fff0: 6622 7265 763a 7b65 7665 6e74 2e72 6576  f"rev:{event.rev
-00020000: 7d22 2c20 746d 705f 666e 616d 652c 2073  }", tmp_fname, s
-00020010: 796e 635f 6576 656e 743d 6576 656e 740a  ync_event=event.
-00020020: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020030: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
-00020040: 2020 2020 2020 6576 656e 7420 3d20 5379        event = Sy
-00020050: 6e63 4576 656e 742e 6672 6f6d 5f6d 6574  ncEvent.from_met
-00020060: 6164 6174 6128 6d64 2c20 7365 6c66 290a  adata(md, self).
-00020070: 2020 2020 2020 2020 2020 2020 6578 6365              exce
-00020080: 7074 2053 796e 6345 7272 6f72 2061 7320  pt SyncError as 
-00020090: 6572 723a 0a20 2020 2020 2020 2020 2020  err:.           
-000200a0: 2020 2020 2023 2052 6570 6c61 6365 2072       # Replace r
-000200b0: 6576 206e 756d 6265 7220 7769 7468 2070  ev number with p
-000200c0: 6174 682e 0a20 2020 2020 2020 2020 2020  ath..           
-000200d0: 2020 2020 2065 7272 2e64 6278 5f70 6174       err.dbx_pat
-000200e0: 6820 3d20 6576 656e 742e 6462 785f 7061  h = event.dbx_pa
-000200f0: 7468 0a20 2020 2020 2020 2020 2020 2020  th.             
-00020100: 2020 2072 6169 7365 2065 7272 0a0a 2020     raise err..  
-00020110: 2020 2020 2020 2020 2020 2320 5265 2d63            # Re-c
-00020120: 6865 636b 2066 6f72 2063 6f6e 666c 6963  heck for conflic
-00020130: 7420 616e 6420 6d6f 7665 2074 6865 2063  t and move the c
-00020140: 6f6e 666c 6963 740a 2020 2020 2020 2020  onflict.        
-00020150: 2020 2020 2320 6f75 7420 6f66 2074 6865      # out of the
-00020160: 2077 6179 2069 6620 616e 7974 6869 6e67   way if anything
-00020170: 2068 6173 2063 6861 6e67 6564 2e0a 2020   has changed..  
-00020180: 2020 2020 2020 2020 2020 6966 2073 656c            if sel
-00020190: 662e 5f63 6865 636b 5f64 6f77 6e6c 6f61  f._check_downloa
-000201a0: 645f 636f 6e66 6c69 6374 2865 7665 6e74  d_conflict(event
-000201b0: 2920 3d3d 2043 6f6e 666c 6963 742e 436f  ) == Conflict.Co
-000201c0: 6e66 6c69 6374 3a0a 2020 2020 2020 2020  nflict:.        
-000201d0: 2020 2020 2020 2020 6363 5f6c 6f63 616c          cc_local
-000201e0: 5f70 6174 6820 3d20 7365 6c66 2e5f 6c6f  _path = self._lo
-000201f0: 6361 6c5f 6363 5f66 696c 656e 616d 6528  cal_cc_filename(
-00020200: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00020210: 2020 2020 2065 7665 6e74 2e6c 6f63 616c       event.local
-00020220: 5f70 6174 682c 2065 7665 6e74 2e63 6861  _path, event.cha
-00020230: 6e67 655f 6462 6964 0a20 2020 2020 2020  nge_dbid.       
-00020240: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
-00020250: 2020 2020 2020 2020 2020 2065 7665 6e74             event
-00020260: 5f63 6c73 203d 2044 6972 4d6f 7665 6445  _cls = DirMovedE
-00020270: 7665 6e74 2069 6620 6973 6469 7228 6576  vent if isdir(ev
-00020280: 656e 742e 6c6f 6361 6c5f 7061 7468 2920  ent.local_path) 
-00020290: 656c 7365 2046 696c 654d 6f76 6564 4576  else FileMovedEv
-000202a0: 656e 740a 2020 2020 2020 2020 2020 2020  ent.            
-000202b0: 2020 2020 7769 7468 2073 656c 662e 6673      with self.fs
-000202c0: 5f65 7665 6e74 732e 6967 6e6f 7265 2865  _events.ignore(e
-000202d0: 7665 6e74 5f63 6c73 2865 7665 6e74 2e6c  vent_cls(event.l
-000202e0: 6f63 616c 5f70 6174 682c 2063 635f 6c6f  ocal_path, cc_lo
-000202f0: 6361 6c5f 7061 7468 2929 3a0a 2020 2020  cal_path)):.    
-00020300: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020310: 7769 7468 2063 6f6e 7665 7274 5f61 7069  with convert_api
-00020320: 5f65 7272 6f72 7328 293a 0a20 2020 2020  _errors():.     
-00020330: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020340: 2020 206d 6f76 6528 6576 656e 742e 6c6f     move(event.lo
-00020350: 6361 6c5f 7061 7468 2c20 6363 5f6c 6f63  cal_path, cc_loc
-00020360: 616c 5f70 6174 682c 2072 6169 7365 5f65  al_path, raise_e
-00020370: 7272 6f72 3d54 7275 6529 0a0a 2020 2020  rror=True)..    
-00020380: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-00020390: 2e5f 6c6f 6767 6572 2e64 6562 7567 280a  ._logger.debug(.
-000203a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000203b0: 2020 2020 2744 6f77 6e6c 6f61 6420 636f      'Download co
-000203c0: 6e66 6c69 6374 3a20 7265 6e61 6d65 6420  nflict: renamed 
-000203d0: 2225 7322 2074 6f20 2225 7322 272c 0a20  "%s" to "%s"',. 
-000203e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000203f0: 2020 2065 7665 6e74 2e6c 6f63 616c 5f70     event.local_p
-00020400: 6174 682c 0a20 2020 2020 2020 2020 2020  ath,.           
-00020410: 2020 2020 2020 2020 2063 635f 6c6f 6361           cc_loca
-00020420: 6c5f 7061 7468 2c0a 2020 2020 2020 2020  l_path,.        
-00020430: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-00020440: 2020 2020 2020 2020 2020 7365 6c66 2e72            self.r
-00020450: 6573 6361 6e28 6363 5f6c 6f63 616c 5f70  escan(cc_local_p
-00020460: 6174 6829 0a20 2020 2020 2020 2020 2020  ath).           
-00020470: 2020 2020 2073 7461 7475 7320 3d20 5379       status = Sy
-00020480: 6e63 5374 6174 7573 2e43 6f6e 666c 6963  ncStatus.Conflic
-00020490: 740a 2020 2020 2020 2020 2020 2020 656c  t.            el
-000204a0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-000204b0: 2020 2020 7374 6174 7573 203d 2053 796e      status = Syn
-000204c0: 6353 7461 7475 732e 446f 6e65 0a0a 2020  cStatus.Done..  
-000204d0: 2020 2020 2020 2020 2020 6966 2069 7364            if isd
-000204e0: 6972 2865 7665 6e74 2e6c 6f63 616c 5f70  ir(event.local_p
-000204f0: 6174 6829 3a0a 2020 2020 2020 2020 2020  ath):.          
-00020500: 2020 2020 2020 7769 7468 2073 656c 662e        with self.
-00020510: 6673 5f65 7665 6e74 732e 6967 6e6f 7265  fs_events.ignore
-00020520: 2844 6972 4465 6c65 7465 6445 7665 6e74  (DirDeletedEvent
-00020530: 2865 7665 6e74 2e6c 6f63 616c 5f70 6174  (event.local_pat
-00020540: 6829 293a 0a20 2020 2020 2020 2020 2020  h)):.           
-00020550: 2020 2020 2020 2020 2064 656c 6574 6528           delete(
-00020560: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00020570: 2020 2020 2020 2020 2065 7665 6e74 2e6c           event.l
-00020580: 6f63 616c 5f70 6174 682c 0a20 2020 2020  ocal_path,.     
-00020590: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000205a0: 2020 2066 6f72 6365 5f63 6173 655f 7365     force_case_se
-000205b0: 6e73 6974 6976 653d 6e6f 7420 7365 6c66  nsitive=not self
-000205c0: 2e69 735f 6673 5f63 6173 655f 7365 6e73  .is_fs_case_sens
-000205d0: 6974 6976 652c 0a20 2020 2020 2020 2020  itive,.         
-000205e0: 2020 2020 2020 2020 2020 2029 0a0a 2020             )..  
-000205f0: 2020 2020 2020 2020 2020 6967 6e6f 7265            ignore
-00020600: 5f65 7665 6e74 733a 206c 6973 745b 4669  _events: list[Fi
-00020610: 6c65 5379 7374 656d 4576 656e 745d 203d  leSystemEvent] =
-00020620: 205b 0a20 2020 2020 2020 2020 2020 2020   [.             
-00020630: 2020 2046 696c 654d 6f76 6564 4576 656e     FileMovedEven
-00020640: 7428 746d 705f 666e 616d 652c 2065 7665  t(tmp_fname, eve
-00020650: 6e74 2e6c 6f63 616c 5f70 6174 6829 0a20  nt.local_path). 
-00020660: 2020 2020 2020 2020 2020 205d 0a0a 2020             ]..  
-00020670: 2020 2020 2020 2020 2020 2320 5072 6573            # Pres
-00020680: 6572 7665 2070 6572 6d69 7373 696f 6e73  erve permissions
-00020690: 206f 6620 7468 6520 6465 7374 696e 6174   of the destinat
-000206a0: 696f 6e20 6669 6c65 2069 6620 7765 2061  ion file if we a
-000206b0: 7265 206f 6e6c 7920 7379 6e63 696e 6720  re only syncing 
-000206c0: 616e 0a20 2020 2020 2020 2020 2020 2023  an.            #
-000206d0: 2075 7064 6174 6520 746f 2074 6865 2066   update to the f
-000206e0: 696c 6520 636f 6e74 656e 7420 2844 726f  ile content (Dro
-000206f0: 7062 6f78 2049 4420 6f66 2074 6865 2066  pbox ID of the f
-00020700: 696c 6520 7265 6d61 696e 7320 7468 6520  ile remains the 
-00020710: 7361 6d65 292e 0a20 2020 2020 2020 2020  same)..         
-00020720: 2020 206f 6c64 5f65 6e74 7279 203d 2073     old_entry = s
-00020730: 656c 662e 6765 745f 696e 6465 785f 656e  elf.get_index_en
-00020740: 7472 7928 6576 656e 742e 6462 785f 7061  try(event.dbx_pa
-00020750: 7468 5f6c 6f77 6572 290a 2020 2020 2020  th_lower).      
-00020760: 2020 2020 2020 7072 6573 6572 7665 5f70        preserve_p
-00020770: 6572 6d69 7373 696f 6e73 203d 2062 6f6f  ermissions = boo
-00020780: 6c28 6f6c 645f 656e 7472 7920 616e 6420  l(old_entry and 
-00020790: 6576 656e 742e 6462 785f 6964 203d 3d20  event.dbx_id == 
-000207a0: 6f6c 645f 656e 7472 792e 6462 785f 6964  old_entry.dbx_id
-000207b0: 290a 0a20 2020 2020 2020 2020 2020 2069  )..            i
-000207c0: 6620 7072 6573 6572 7665 5f70 6572 6d69  f preserve_permi
-000207d0: 7373 696f 6e73 3a0a 2020 2020 2020 2020  ssions:.        
-000207e0: 2020 2020 2020 2020 2320 4967 6e6f 7265          # Ignore
-000207f0: 2046 696c 654d 6f64 6966 6965 6445 7665   FileModifiedEve
-00020800: 6e74 2077 6865 6e20 6368 616e 6769 6e67  nt when changing
-00020810: 2070 6572 6d69 7373 696f 6e73 2e0a 2020   permissions..  
-00020820: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-00020830: 4e6f 7465 2074 6861 7420 7477 6f20 4669  Note that two Fi
-00020840: 6c65 4d6f 6469 6669 6564 4576 656e 7473  leModifiedEvents
-00020850: 206d 6179 2062 6520 656d 6974 7465 6420   may be emitted 
-00020860: 6f6e 206d 6163 4f53 2e0a 2020 2020 2020  on macOS..      
-00020870: 2020 2020 2020 2020 2020 6967 6e6f 7265            ignore
-00020880: 5f65 7665 6e74 732e 6170 7065 6e64 2846  _events.append(F
-00020890: 696c 654d 6f64 6966 6965 6445 7665 6e74  ileModifiedEvent
-000208a0: 2865 7665 6e74 2e6c 6f63 616c 5f70 6174  (event.local_pat
-000208b0: 6829 290a 2020 2020 2020 2020 2020 2020  h)).            
-000208c0: 2020 2020 6966 2049 535f 4d41 434f 533a      if IS_MACOS:
-000208d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000208e0: 2020 2020 2069 676e 6f72 655f 6576 656e       ignore_even
-000208f0: 7473 2e61 7070 656e 6428 4669 6c65 4d6f  ts.append(FileMo
-00020900: 6469 6669 6564 4576 656e 7428 6576 656e  difiedEvent(even
-00020910: 742e 6c6f 6361 6c5f 7061 7468 2929 0a0a  t.local_path))..
-00020920: 2020 2020 2020 2020 2020 2020 6966 2069              if i
-00020930: 7366 696c 6528 6576 656e 742e 6c6f 6361  sfile(event.loca
-00020940: 6c5f 7061 7468 293a 0a20 2020 2020 2020  l_path):.       
-00020950: 2020 2020 2020 2020 2023 2049 676e 6f72           # Ignor
-00020960: 6520 4669 6c65 4465 6c65 7465 6445 7665  e FileDeletedEve
-00020970: 6e74 2077 6865 6e20 7265 706c 6163 696e  nt when replacin
-00020980: 6720 6f6c 6420 6669 6c65 2e0a 2020 2020  g old file..    
-00020990: 2020 2020 2020 2020 2020 2020 6967 6e6f              igno
-000209a0: 7265 5f65 7665 6e74 732e 6170 7065 6e64  re_events.append
-000209b0: 2846 696c 6544 656c 6574 6564 4576 656e  (FileDeletedEven
-000209c0: 7428 6576 656e 742e 6c6f 6361 6c5f 7061  t(event.local_pa
-000209d0: 7468 2929 0a0a 2020 2020 2020 2020 2020  th))..          
-000209e0: 2020 2320 4d6f 7665 2074 6865 2064 6f77    # Move the dow
-000209f0: 6e6c 6f61 6465 6420 6669 6c65 2074 6f20  nloaded file to 
-00020a00: 6974 7320 6465 7374 696e 6174 696f 6e2e  its destination.
-00020a10: 0a20 2020 2020 2020 2020 2020 2077 6974  .            wit
-00020a20: 6820 7365 6c66 2e66 735f 6576 656e 7473  h self.fs_events
-00020a30: 2e69 676e 6f72 6528 2a69 676e 6f72 655f  .ignore(*ignore_
-00020a40: 6576 656e 7473 2c20 7265 6375 7273 6976  events, recursiv
-00020a50: 653d 4661 6c73 6529 3a0a 2020 2020 2020  e=False):.      
-00020a60: 2020 2020 2020 2020 2020 7769 7468 2063            with c
-00020a70: 6f6e 7665 7274 5f61 7069 5f65 7272 6f72  onvert_api_error
-00020a80: 7328 0a20 2020 2020 2020 2020 2020 2020  s(.             
-00020a90: 2020 2020 2020 2064 6278 5f70 6174 683d         dbx_path=
-00020aa0: 6576 656e 742e 6462 785f 7061 7468 2c20  event.dbx_path, 
-00020ab0: 6c6f 6361 6c5f 7061 7468 3d65 7665 6e74  local_path=event
-00020ac0: 2e6c 6f63 616c 5f70 6174 680a 2020 2020  .local_path.    
-00020ad0: 2020 2020 2020 2020 2020 2020 293a 0a20              ):. 
-00020ae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020af0: 2020 2073 7461 7420 3d20 6f73 2e6c 7374     stat = os.lst
-00020b00: 6174 2874 6d70 5f66 6e61 6d65 290a 2020  at(tmp_fname).  
-00020b10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020b20: 2020 6d6f 7665 280a 2020 2020 2020 2020    move(.        
-00020b30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020b40: 746d 705f 666e 616d 652c 0a20 2020 2020  tmp_fname,.     
-00020b50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020b60: 2020 2065 7665 6e74 2e6c 6f63 616c 5f70     event.local_p
-00020b70: 6174 682c 0a20 2020 2020 2020 2020 2020  ath,.           
-00020b80: 2020 2020 2020 2020 2020 2020 2070 7265               pre
-00020b90: 7365 7276 655f 6465 7374 5f70 6572 6d69  serve_dest_permi
-00020ba0: 7373 696f 6e73 3d70 7265 7365 7276 655f  ssions=preserve_
-00020bb0: 7065 726d 6973 7369 6f6e 732c 0a20 2020  permissions,.   
-00020bc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020bd0: 2020 2020 2072 6169 7365 5f65 7272 6f72       raise_error
-00020be0: 3d54 7275 652c 0a20 2020 2020 2020 2020  =True,.         
-00020bf0: 2020 2020 2020 2020 2020 2029 0a0a 2020             )..  
-00020c00: 2020 2020 2020 7365 6c66 2e75 7064 6174        self.updat
-00020c10: 655f 696e 6465 785f 6672 6f6d 5f73 796e  e_index_from_syn
-00020c20: 635f 6576 656e 7428 6576 656e 7429 0a20  c_event(event). 
-00020c30: 2020 2020 2020 2073 656c 662e 5f73 6176         self._sav
-00020c40: 655f 6c6f 6361 6c5f 6861 7368 280a 2020  e_local_hash(.  
-00020c50: 2020 2020 2020 2020 2020 7374 6174 2e73            stat.s
-00020c60: 745f 696e 6f2c 2065 7665 6e74 2e6c 6f63  t_ino, event.loc
-00020c70: 616c 5f70 6174 682c 2065 7665 6e74 2e63  al_path, event.c
-00020c80: 6f6e 7465 6e74 5f68 6173 682c 2073 7461  ontent_hash, sta
-00020c90: 742e 7374 5f6d 7469 6d65 0a20 2020 2020  t.st_mtime.     
-00020ca0: 2020 2029 0a0a 2020 2020 2020 2020 7365     )..        se
-00020cb0: 6c66 2e5f 6c6f 6767 6572 2e64 6562 7567  lf._logger.debug
-00020cc0: 2827 4372 6561 7465 6420 6c6f 6361 6c20  ('Created local 
-00020cd0: 6669 6c65 2022 2573 2227 2c20 6576 656e  file "%s"', even
-00020ce0: 742e 6462 785f 7061 7468 290a 0a20 2020  t.dbx_path)..   
-00020cf0: 2020 2020 2072 6574 7572 6e20 7374 6174       return stat
-00020d00: 7573 0a0a 2020 2020 6465 6620 5f6f 6e5f  us..    def _on_
-00020d10: 7265 6d6f 7465 5f66 6f6c 6465 7228 7365  remote_folder(se
-00020d20: 6c66 2c20 6576 656e 743a 2053 796e 6345  lf, event: SyncE
-00020d30: 7665 6e74 2920 2d3e 2053 796e 6353 7461  vent) -> SyncSta
-00020d40: 7475 733a 0a20 2020 2020 2020 2022 2222  tus:.        """
-00020d50: 0a20 2020 2020 2020 2041 7070 6c69 6573  .        Applies
-00020d60: 2061 2072 656d 6f74 6520 666f 6c64 6572   a remote folder
-00020d70: 2063 7265 6174 696f 6e20 6c6f 6361 6c6c   creation locall
-00020d80: 792e 0a0a 2020 2020 2020 2020 3a70 6172  y...        :par
-00020d90: 616d 2065 7665 6e74 3a20 5379 6e63 4576  am event: SyncEv
-00020da0: 656e 7420 666f 7220 666f 6c64 6572 2064  ent for folder d
-00020db0: 6f77 6e6c 6f61 642e 0a20 2020 2020 2020  ownload..       
-00020dc0: 203a 7265 7475 726e 733a 2053 796e 6345   :returns: SyncE
-00020dd0: 7665 6e74 2063 6f72 7265 7370 6f6e 6469  vent correspondi
-00020de0: 6e67 2074 6f20 6c6f 6361 6c20 6974 656d  ng to local item
-00020df0: 206f 7220 4e6f 6e65 2069 6620 6e6f 206c   or None if no l
-00020e00: 6f63 616c 2063 6861 6e67 6573 0a20 2020  ocal changes.   
-00020e10: 2020 2020 2020 2020 2061 7265 206d 6164           are mad
-00020e20: 652e 0a20 2020 2020 2020 2022 2222 0a20  e..        """. 
-00020e30: 2020 2020 2020 2073 656c 662e 5f61 7070         self._app
-00020e40: 6c79 5f63 6173 655f 6368 616e 6765 2865  ly_case_change(e
-00020e50: 7665 6e74 290a 0a20 2020 2020 2020 2023  vent)..        #
-00020e60: 2053 746f 7265 2074 6865 206e 6577 2065   Store the new e
-00020e70: 6e74 7279 2061 7420 7468 6520 6769 7665  ntry at the give
-00020e80: 6e20 7061 7468 2069 6e20 796f 7572 206c  n path in your l
-00020e90: 6f63 616c 2073 7461 7465 2e20 4966 2074  ocal state. If t
-00020ea0: 6865 2072 6571 7569 7265 640a 2020 2020  he required.    
-00020eb0: 2020 2020 2320 7061 7265 6e74 2066 6f6c      # parent fol
-00020ec0: 6465 7273 2064 6f6e e280 9974 2065 7869  ders don...t exi
-00020ed0: 7374 2079 6574 2c20 6372 6561 7465 2074  st yet, create t
-00020ee0: 6865 6d2e 2049 6620 7468 6572 65e2 8099  hem. If there...
-00020ef0: 7320 616c 7265 6164 7920 736f 6d65 7468  s already someth
-00020f00: 696e 6720 656c 7365 0a20 2020 2020 2020  ing else.       
-00020f10: 2023 2061 7420 7468 6520 6769 7665 6e20   # at the given 
-00020f20: 7061 7468 2c20 7265 706c 6163 6520 6974  path, replace it
-00020f30: 2062 7574 206c 6561 7665 2074 6865 2063   but leave the c
-00020f40: 6869 6c64 7265 6e20 6173 2074 6865 7920  hildren as they 
-00020f50: 6172 652e 0a0a 2020 2020 2020 2020 636f  are...        co
-00020f60: 6e66 6c69 6374 5f63 6865 636b 203d 2073  nflict_check = s
-00020f70: 656c 662e 5f63 6865 636b 5f64 6f77 6e6c  elf._check_downl
-00020f80: 6f61 645f 636f 6e66 6c69 6374 2865 7665  oad_conflict(eve
-00020f90: 6e74 290a 0a20 2020 2020 2020 2069 6620  nt)..        if 
-00020fa0: 636f 6e66 6c69 6374 5f63 6865 636b 2069  conflict_check i
-00020fb0: 7320 436f 6e66 6c69 6374 2e49 6465 6e74  s Conflict.Ident
-00020fc0: 6963 616c 3a0a 2020 2020 2020 2020 2020  ical:.          
-00020fd0: 2020 7365 6c66 2e75 7064 6174 655f 696e    self.update_in
-00020fe0: 6465 785f 6672 6f6d 5f73 796e 635f 6576  dex_from_sync_ev
-00020ff0: 656e 7428 6576 656e 7429 0a20 2020 2020  ent(event).     
-00021000: 2020 2020 2020 2072 6574 7572 6e20 5379         return Sy
-00021010: 6e63 5374 6174 7573 2e53 6b69 7070 6564  ncStatus.Skipped
-00021020: 0a20 2020 2020 2020 2065 6c69 6620 636f  .        elif co
-00021030: 6e66 6c69 6374 5f63 6865 636b 2069 7320  nflict_check is 
-00021040: 436f 6e66 6c69 6374 2e4c 6f63 616c 4e65  Conflict.LocalNe
-00021050: 7765 724f 7249 6465 6e74 6963 616c 3a0a  werOrIdentical:.
-00021060: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-00021070: 726e 2053 796e 6353 7461 7475 732e 536b  rn SyncStatus.Sk
-00021080: 6970 7065 640a 0a20 2020 2020 2020 2069  ipped..        i
-00021090: 6620 636f 6e66 6c69 6374 5f63 6865 636b  f conflict_check
-000210a0: 203d 3d20 436f 6e66 6c69 6374 2e43 6f6e   == Conflict.Con
-000210b0: 666c 6963 743a 0a20 2020 2020 2020 2020  flict:.         
-000210c0: 2020 2063 635f 6c6f 6361 6c5f 7061 7468     cc_local_path
-000210d0: 203d 2073 656c 662e 5f6c 6f63 616c 5f63   = self._local_c
-000210e0: 635f 6669 6c65 6e61 6d65 2865 7665 6e74  c_filename(event
-000210f0: 2e6c 6f63 616c 5f70 6174 682c 2065 7665  .local_path, eve
-00021100: 6e74 2e63 6861 6e67 655f 6462 6964 290a  nt.change_dbid).
-00021110: 2020 2020 2020 2020 2020 2020 6576 656e              even
-00021120: 745f 636c 7320 3d20 4469 724d 6f76 6564  t_cls = DirMoved
-00021130: 4576 656e 7420 6966 2069 7364 6972 2865  Event if isdir(e
-00021140: 7665 6e74 2e6c 6f63 616c 5f70 6174 6829  vent.local_path)
-00021150: 2065 6c73 6520 4669 6c65 4d6f 7665 6445   else FileMovedE
-00021160: 7665 6e74 0a20 2020 2020 2020 2020 2020  vent.           
-00021170: 2077 6974 6820 7365 6c66 2e66 735f 6576   with self.fs_ev
-00021180: 656e 7473 2e69 676e 6f72 6528 6576 656e  ents.ignore(even
-00021190: 745f 636c 7328 6576 656e 742e 6c6f 6361  t_cls(event.loca
-000211a0: 6c5f 7061 7468 2c20 6363 5f6c 6f63 616c  l_path, cc_local
-000211b0: 5f70 6174 6829 293a 0a20 2020 2020 2020  _path)):.       
-000211c0: 2020 2020 2020 2020 2077 6974 6820 636f           with co
-000211d0: 6e76 6572 745f 6170 695f 6572 726f 7273  nvert_api_errors
-000211e0: 2829 3a0a 2020 2020 2020 2020 2020 2020  ():.            
-000211f0: 2020 2020 2020 2020 6d6f 7665 2865 7665          move(eve
-00021200: 6e74 2e6c 6f63 616c 5f70 6174 682c 2063  nt.local_path, c
-00021210: 635f 6c6f 6361 6c5f 7061 7468 2c20 7261  c_local_path, ra
-00021220: 6973 655f 6572 726f 723d 5472 7565 290a  ise_error=True).
-00021230: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-00021240: 662e 5f6c 6f67 6765 722e 6465 6275 6728  f._logger.debug(
-00021250: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00021260: 2027 446f 776e 6c6f 6164 2063 6f6e 666c   'Download confl
-00021270: 6963 743a 2072 656e 616d 6564 2022 2573  ict: renamed "%s
-00021280: 2220 746f 2022 2573 2227 2c0a 2020 2020  " to "%s"',.    
-00021290: 2020 2020 2020 2020 2020 2020 6576 656e              even
-000212a0: 742e 6c6f 6361 6c5f 7061 7468 2c0a 2020  t.local_path,.  
-000212b0: 2020 2020 2020 2020 2020 2020 2020 6363                cc
-000212c0: 5f6c 6f63 616c 5f70 6174 682c 0a20 2020  _local_path,.   
-000212d0: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
-000212e0: 2020 2020 2020 2073 656c 662e 7265 7363         self.resc
-000212f0: 616e 2863 635f 6c6f 6361 6c5f 7061 7468  an(cc_local_path
-00021300: 290a 2020 2020 2020 2020 2020 2020 7374  ).            st
-00021310: 6174 7573 203d 2053 796e 6353 7461 7475  atus = SyncStatu
-00021320: 732e 436f 6e66 6c69 6374 0a20 2020 2020  s.Conflict.     
-00021330: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-00021340: 2020 2020 2073 7461 7475 7320 3d20 5379       status = Sy
-00021350: 6e63 5374 6174 7573 2e44 6f6e 650a 0a20  ncStatus.Done.. 
-00021360: 2020 2020 2020 2023 2045 6e73 7572 6520         # Ensure 
-00021370: 7468 6174 2070 6172 656e 7420 666f 6c64  that parent fold
-00021380: 6572 7320 6172 6520 7379 6e63 6564 2e0a  ers are synced..
-00021390: 2020 2020 2020 2020 7365 6c66 2e5f 656e          self._en
-000213a0: 7375 7265 5f70 6172 656e 7428 6576 656e  sure_parent(even
-000213b0: 7429 0a0a 2020 2020 2020 2020 6966 2069  t)..        if i
-000213c0: 7366 696c 6528 6576 656e 742e 6c6f 6361  sfile(event.loca
-000213d0: 6c5f 7061 7468 293a 0a20 2020 2020 2020  l_path):.       
-000213e0: 2020 2020 2077 6974 6820 7365 6c66 2e66       with self.f
-000213f0: 735f 6576 656e 7473 2e69 676e 6f72 6528  s_events.ignore(
-00021400: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00021410: 2046 696c 654d 6f64 6966 6965 6445 7665   FileModifiedEve
-00021420: 6e74 2865 7665 6e74 2e6c 6f63 616c 5f70  nt(event.local_p
-00021430: 6174 6829 2c20 2023 204d 6179 2062 6520  ath),  # May be 
-00021440: 656d 6974 7465 6420 6f6e 206d 6163 4f53  emitted on macOS
-00021450: 2e0a 2020 2020 2020 2020 2020 2020 2020  ..              
-00021460: 2020 4669 6c65 4465 6c65 7465 6445 7665    FileDeletedEve
-00021470: 6e74 2865 7665 6e74 2e6c 6f63 616c 5f70  nt(event.local_p
-00021480: 6174 6829 2c0a 2020 2020 2020 2020 2020  ath),.          
-00021490: 2020 293a 0a20 2020 2020 2020 2020 2020    ):.           
-000214a0: 2020 2020 2064 656c 6574 6528 0a20 2020       delete(.   
-000214b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000214c0: 2065 7665 6e74 2e6c 6f63 616c 5f70 6174   event.local_pat
-000214d0: 682c 2066 6f72 6365 5f63 6173 655f 7365  h, force_case_se
-000214e0: 6e73 6974 6976 653d 6e6f 7420 7365 6c66  nsitive=not self
-000214f0: 2e69 735f 6673 5f63 6173 655f 7365 6e73  .is_fs_case_sens
-00021500: 6974 6976 650a 2020 2020 2020 2020 2020  itive.          
-00021510: 2020 2020 2020 290a 0a20 2020 2020 2020        )..       
-00021520: 2074 7279 3a0a 2020 2020 2020 2020 2020   try:.          
-00021530: 2020 7769 7468 2073 656c 662e 6673 5f65    with self.fs_e
-00021540: 7665 6e74 732e 6967 6e6f 7265 280a 2020  vents.ignore(.  
-00021550: 2020 2020 2020 2020 2020 2020 2020 4469                Di
-00021560: 7243 7265 6174 6564 4576 656e 7428 6576  rCreatedEvent(ev
-00021570: 656e 742e 6c6f 6361 6c5f 7061 7468 292c  ent.local_path),
-00021580: 2072 6563 7572 7369 7665 3d46 616c 7365   recursive=False
-00021590: 0a20 2020 2020 2020 2020 2020 2029 3a0a  .            ):.
-000215a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000215b0: 6f73 2e6d 6b64 6972 2865 7665 6e74 2e6c  os.mkdir(event.l
-000215c0: 6f63 616c 5f70 6174 6829 0a20 2020 2020  ocal_path).     
-000215d0: 2020 2065 7863 6570 7420 4669 6c65 4578     except FileEx
-000215e0: 6973 7473 4572 726f 723a 0a20 2020 2020  istsError:.     
-000215f0: 2020 2020 2020 2073 7461 7475 7320 3d20         status = 
-00021600: 5379 6e63 5374 6174 7573 2e53 6b69 7070  SyncStatus.Skipp
-00021610: 6564 0a20 2020 2020 2020 2065 7863 6570  ed.        excep
-00021620: 7420 4f53 4572 726f 7220 6173 2065 7272  t OSError as err
-00021630: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
-00021640: 6c66 2e65 6e73 7572 655f 6472 6f70 626f  lf.ensure_dropbo
-00021650: 785f 666f 6c64 6572 5f70 7265 7365 6e74  x_folder_present
-00021660: 2829 0a20 2020 2020 2020 2020 2020 2072  ().            r
-00021670: 6169 7365 206f 735f 746f 5f6d 6165 7374  aise os_to_maest
-00021680: 7261 6c5f 6572 726f 7228 6572 722c 2064  ral_error(err, d
-00021690: 6278 5f70 6174 683d 6576 656e 742e 6462  bx_path=event.db
-000216a0: 785f 7061 7468 290a 0a20 2020 2020 2020  x_path)..       
-000216b0: 2073 656c 662e 7570 6461 7465 5f69 6e64   self.update_ind
-000216c0: 6578 5f66 726f 6d5f 7379 6e63 5f65 7665  ex_from_sync_eve
-000216d0: 6e74 2865 7665 6e74 290a 0a20 2020 2020  nt(event)..     
-000216e0: 2020 2073 656c 662e 5f6c 6f67 6765 722e     self._logger.
-000216f0: 6465 6275 6728 2743 7265 6174 6564 206c  debug('Created l
-00021700: 6f63 616c 2066 6f6c 6465 7220 2225 7322  ocal folder "%s"
-00021710: 272c 2065 7665 6e74 2e64 6278 5f70 6174  ', event.dbx_pat
-00021720: 6829 0a0a 2020 2020 2020 2020 7265 7475  h)..        retu
-00021730: 726e 2073 7461 7475 730a 0a20 2020 2064  rn status..    d
-00021740: 6566 205f 6f6e 5f72 656d 6f74 655f 6465  ef _on_remote_de
-00021750: 6c65 7465 6428 7365 6c66 2c20 6576 656e  leted(self, even
-00021760: 743a 2053 796e 6345 7665 6e74 2920 2d3e  t: SyncEvent) ->
-00021770: 2053 796e 6353 7461 7475 733a 0a20 2020   SyncStatus:.   
-00021780: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
-00021790: 2041 7070 6c69 6573 2061 2072 656d 6f74   Applies a remot
-000217a0: 6520 6465 6c65 7469 6f6e 206c 6f63 616c  e deletion local
-000217b0: 6c79 2e0a 0a20 2020 2020 2020 203a 7061  ly...        :pa
-000217c0: 7261 6d20 6576 656e 743a 2044 726f 7062  ram event: Dropb
-000217d0: 6f78 2064 656c 6574 6564 206d 6574 6164  ox deleted metad
-000217e0: 6174 612e 0a20 2020 2020 2020 203a 7265  ata..        :re
-000217f0: 7475 726e 733a 2053 796e 6345 7665 6e74  turns: SyncEvent
-00021800: 2063 6f72 7265 7370 6f6e 6469 6e67 2074   corresponding t
-00021810: 6f20 6c6f 6361 6c20 6465 6c65 7469 6f6e  o local deletion
-00021820: 206f 7220 4e6f 6e65 2069 6620 6e6f 206c   or None if no l
-00021830: 6f63 616c 2063 6861 6e67 6573 0a20 2020  ocal changes.   
-00021840: 2020 2020 2020 2020 2061 7265 206d 6164           are mad
-00021850: 652e 0a20 2020 2020 2020 2022 2222 0a20  e..        """. 
-00021860: 2020 2020 2020 2073 656c 662e 5f61 7070         self._app
-00021870: 6c79 5f63 6173 655f 6368 616e 6765 2865  ly_case_change(e
-00021880: 7665 6e74 290a 0a20 2020 2020 2020 2023  vent)..        #
-00021890: 2049 6620 796f 7572 206c 6f63 616c 2073   If your local s
-000218a0: 7461 7465 2068 6173 2073 6f6d 6574 6869  tate has somethi
-000218b0: 6e67 2061 7420 7468 6520 6769 7665 6e20  ng at the given 
-000218c0: 7061 7468 2c20 7265 6d6f 7665 2069 7420  path, remove it 
-000218d0: 616e 6420 616c 6c20 6974 730a 2020 2020  and all its.    
-000218e0: 2020 2020 2320 6368 696c 6472 656e 2e20      # children. 
-000218f0: 4966 2074 6865 7265 e280 9973 206e 6f74  If there...s not
-00021900: 6869 6e67 2061 7420 7468 6520 6769 7665  hing at the give
-00021910: 6e20 7061 7468 2c20 6967 6e6f 7265 2074  n path, ignore t
-00021920: 6869 7320 656e 7472 792e 0a0a 2020 2020  his entry...    
-00021930: 2020 2020 636f 6e66 6c69 6374 5f63 6865      conflict_che
-00021940: 636b 203d 2073 656c 662e 5f63 6865 636b  ck = self._check
-00021950: 5f64 6f77 6e6c 6f61 645f 636f 6e66 6c69  _download_confli
-00021960: 6374 2865 7665 6e74 290a 0a20 2020 2020  ct(event)..     
-00021970: 2020 2069 6620 636f 6e66 6c69 6374 5f63     if conflict_c
-00021980: 6865 636b 2069 7320 436f 6e66 6c69 6374  heck is Conflict
-00021990: 2e49 6465 6e74 6963 616c 3a0a 2020 2020  .Identical:.    
-000219a0: 2020 2020 2020 2020 7365 6c66 2e75 7064          self.upd
-000219b0: 6174 655f 696e 6465 785f 6672 6f6d 5f73  ate_index_from_s
-000219c0: 796e 635f 6576 656e 7428 6576 656e 7429  ync_event(event)
-000219d0: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-000219e0: 7572 6e20 5379 6e63 5374 6174 7573 2e53  urn SyncStatus.S
-000219f0: 6b69 7070 6564 0a20 2020 2020 2020 2065  kipped.        e
-00021a00: 6c69 6620 636f 6e66 6c69 6374 5f63 6865  lif conflict_che
-00021a10: 636b 2069 7320 436f 6e66 6c69 6374 2e4c  ck is Conflict.L
-00021a20: 6f63 616c 4e65 7765 724f 7249 6465 6e74  ocalNewerOrIdent
-00021a30: 6963 616c 3a0a 2020 2020 2020 2020 2020  ical:.          
-00021a40: 2020 7265 7475 726e 2053 796e 6353 7461    return SyncSta
-00021a50: 7475 732e 536b 6970 7065 640a 0a20 2020  tus.Skipped..   
-00021a60: 2020 2020 2065 7665 6e74 5f63 6c73 203d       event_cls =
-00021a70: 2044 6972 4465 6c65 7465 6445 7665 6e74   DirDeletedEvent
-00021a80: 2069 6620 6973 6469 7228 6576 656e 742e   if isdir(event.
-00021a90: 6c6f 6361 6c5f 7061 7468 2920 656c 7365  local_path) else
-00021aa0: 2046 696c 6544 656c 6574 6564 4576 656e   FileDeletedEven
-00021ab0: 740a 2020 2020 2020 2020 7769 7468 2073  t.        with s
-00021ac0: 656c 662e 6673 5f65 7665 6e74 732e 6967  elf.fs_events.ig
-00021ad0: 6e6f 7265 2865 7665 6e74 5f63 6c73 2865  nore(event_cls(e
-00021ae0: 7665 6e74 2e6c 6f63 616c 5f70 6174 6829  vent.local_path)
-00021af0: 293a 0a20 2020 2020 2020 2020 2020 2065  ):.            e
-00021b00: 7863 203d 2064 656c 6574 6528 0a20 2020  xc = delete(.   
-00021b10: 2020 2020 2020 2020 2020 2020 2065 7665               eve
-00021b20: 6e74 2e6c 6f63 616c 5f70 6174 682c 2066  nt.local_path, f
-00021b30: 6f72 6365 5f63 6173 655f 7365 6e73 6974  orce_case_sensit
-00021b40: 6976 653d 6e6f 7420 7365 6c66 2e69 735f  ive=not self.is_
-00021b50: 6673 5f63 6173 655f 7365 6e73 6974 6976  fs_case_sensitiv
-00021b60: 650a 2020 2020 2020 2020 2020 2020 290a  e.            ).
-00021b70: 0a20 2020 2020 2020 2069 6620 6e6f 7420  .        if not 
-00021b80: 6578 633a 0a20 2020 2020 2020 2020 2020  exc:.           
-00021b90: 2073 656c 662e 7570 6461 7465 5f69 6e64   self.update_ind
-00021ba0: 6578 5f66 726f 6d5f 7379 6e63 5f65 7665  ex_from_sync_eve
-00021bb0: 6e74 2865 7665 6e74 290a 2020 2020 2020  nt(event).      
-00021bc0: 2020 2020 2020 7365 6c66 2e5f 6c6f 6767        self._logg
-00021bd0: 6572 2e64 6562 7567 2827 4465 6c65 7465  er.debug('Delete
-00021be0: 6420 6c6f 6361 6c20 6974 656d 2022 2573  d local item "%s
-00021bf0: 2227 2c20 6576 656e 742e 6c6f 6361 6c5f  "', event.local_
-00021c00: 7061 7468 290a 2020 2020 2020 2020 2020  path).          
-00021c10: 2020 7265 7475 726e 2053 796e 6353 7461    return SyncSta
-00021c20: 7475 732e 446f 6e65 0a20 2020 2020 2020  tus.Done.       
-00021c30: 2065 6c69 6620 6973 696e 7374 616e 6365   elif isinstance
-00021c40: 2865 7863 2c20 2846 696c 654e 6f74 466f  (exc, (FileNotFo
-00021c50: 756e 6445 7272 6f72 2c20 4e6f 7441 4469  undError, NotADi
-00021c60: 7265 6374 6f72 7945 7272 6f72 2929 3a0a  rectoryError)):.
-00021c70: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-00021c80: 2e75 7064 6174 655f 696e 6465 785f 6672  .update_index_fr
-00021c90: 6f6d 5f73 796e 635f 6576 656e 7428 6576  om_sync_event(ev
-00021ca0: 656e 7429 0a20 2020 2020 2020 2020 2020  ent).           
-00021cb0: 2073 656c 662e 5f6c 6f67 6765 722e 6465   self._logger.de
-00021cc0: 6275 6728 2744 656c 6574 696f 6e20 6661  bug('Deletion fa
-00021cd0: 696c 6564 3a20 2225 7322 206e 6f74 2066  iled: "%s" not f
-00021ce0: 6f75 6e64 272c 2065 7665 6e74 2e64 6278  ound', event.dbx
-00021cf0: 5f70 6174 6829 0a20 2020 2020 2020 2020  _path).         
-00021d00: 2020 2072 6574 7572 6e20 5379 6e63 5374     return SyncSt
-00021d10: 6174 7573 2e53 6b69 7070 6564 0a20 2020  atus.Skipped.   
-00021d20: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-00021d30: 2020 2020 2020 2072 6169 7365 206f 735f         raise os_
-00021d40: 746f 5f6d 6165 7374 7261 6c5f 6572 726f  to_maestral_erro
-00021d50: 7228 6578 632c 2064 6278 5f70 6174 683d  r(exc, dbx_path=
-00021d60: 6576 656e 742e 6462 785f 7061 7468 290a  event.dbx_path).
-00021d70: 0a20 2020 2064 6566 205f 6170 706c 795f  .    def _apply_
-00021d80: 6361 7365 5f63 6861 6e67 6528 7365 6c66  case_change(self
-00021d90: 2c20 6576 656e 743a 2053 796e 6345 7665  , event: SyncEve
-00021da0: 6e74 2920 2d3e 204e 6f6e 653a 0a20 2020  nt) -> None:.   
-00021db0: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
-00021dc0: 2041 7070 6c69 6573 2061 6e79 2063 6861   Applies any cha
-00021dd0: 6e67 6573 2069 6e20 6361 7369 6e67 206f  nges in casing o
-00021de0: 6620 7468 6520 7265 6d6f 7465 2069 7465  f the remote ite
-00021df0: 6d20 6c6f 6361 6c6c 792e 2054 6869 7320  m locally. This 
-00021e00: 7368 6f75 6c64 2062 6520 6361 6c6c 6564  should be called
-00021e10: 0a20 2020 2020 2020 2062 6566 6f72 6520  .        before 
-00021e20: 616e 7920 7379 7374 656d 2063 616c 6c73  any system calls
-00021e30: 2075 7369 6e67 2060 606c 6f63 616c 5f70   using ``local_p
-00021e40: 6174 6860 6020 6265 6361 7573 6520 7468  ath`` because th
-00021e50: 6520 6163 7475 616c 2070 6174 6820 6f6e  e actual path on
-00021e60: 2074 6865 2066 696c 650a 2020 2020 2020   the file.      
-00021e70: 2020 7379 7374 656d 206d 6179 2068 6176    system may hav
-00021e80: 6520 6120 6469 6666 6572 656e 7420 6361  e a different ca
-00021e90: 7369 6e67 206f 6e20 6361 7365 2d73 656e  sing on case-sen
-00021ea0: 7369 7469 7665 2066 696c 6520 7379 7374  sitive file syst
-00021eb0: 656d 732e 204f 6e20 6361 7365 2d0a 2020  ems. On case-.  
-00021ec0: 2020 2020 2020 696e 7365 6e73 6974 6976        insensitiv
-00021ed0: 6520 6669 6c65 2073 7973 7465 6d73 2c20  e file systems, 
-00021ee0: 7468 6973 2063 6175 7365 7320 6f6e 6c79  this causes only
-00021ef0: 2061 2063 6f73 6d65 7469 6320 6368 616e   a cosmetic chan
-00021f00: 6765 2e0a 0a20 2020 2020 2020 203a 7061  ge...        :pa
-00021f10: 7261 6d20 6576 656e 743a 2044 6f77 6e6c  ram event: Downl
-00021f20: 6f61 6420 5379 6e63 4576 656e 742e 0a20  oad SyncEvent.. 
-00021f30: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
-00021f40: 2020 2077 6974 6820 7365 6c66 2e5f 6461     with self._da
-00021f50: 7461 6261 7365 5f61 6363 6573 7328 293a  tabase_access():
-00021f60: 0a20 2020 2020 2020 2020 2020 2065 6e74  .            ent
-00021f70: 7279 203d 2073 656c 662e 6765 745f 696e  ry = self.get_in
-00021f80: 6465 785f 656e 7472 7928 6576 656e 742e  dex_entry(event.
-00021f90: 6462 785f 7061 7468 5f6c 6f77 6572 290a  dbx_path_lower).
-00021fa0: 0a20 2020 2020 2020 2069 6620 656e 7472  .        if entr
-00021fb0: 7920 616e 6420 656e 7472 792e 6462 785f  y and entry.dbx_
-00021fc0: 7061 7468 5f63 6173 6564 2021 3d20 6576  path_cased != ev
-00021fd0: 656e 742e 6462 785f 7061 7468 3a0a 2020  ent.dbx_path:.  
-00021fe0: 2020 2020 2020 2020 2020 6c6f 6361 6c5f            local_
-00021ff0: 7061 7468 5f6f 6c64 203d 2073 656c 662e  path_old = self.
-00022000: 746f 5f6c 6f63 616c 5f70 6174 685f 6672  to_local_path_fr
-00022010: 6f6d 5f63 6173 6564 2865 6e74 7279 2e64  om_cased(entry.d
-00022020: 6278 5f70 6174 685f 6361 7365 6429 0a0a  bx_path_cased)..
-00022030: 2020 2020 2020 2020 2020 2020 6576 656e              even
-00022040: 745f 636c 7320 3d20 4469 724d 6f76 6564  t_cls = DirMoved
-00022050: 4576 656e 7420 6966 2069 7364 6972 286c  Event if isdir(l
-00022060: 6f63 616c 5f70 6174 685f 6f6c 6429 2065  ocal_path_old) e
-00022070: 6c73 6520 4669 6c65 4d6f 7665 6445 7665  lse FileMovedEve
-00022080: 6e74 0a20 2020 2020 2020 2020 2020 2077  nt.            w
-00022090: 6974 6820 7365 6c66 2e66 735f 6576 656e  ith self.fs_even
-000220a0: 7473 2e69 676e 6f72 6528 6576 656e 745f  ts.ignore(event_
-000220b0: 636c 7328 6c6f 6361 6c5f 7061 7468 5f6f  cls(local_path_o
-000220c0: 6c64 2c20 6576 656e 742e 6c6f 6361 6c5f  ld, event.local_
-000220d0: 7061 7468 2929 3a0a 2020 2020 2020 2020  path)):.        
-000220e0: 2020 2020 2020 2020 6d6f 7665 286c 6f63          move(loc
-000220f0: 616c 5f70 6174 685f 6f6c 642c 2065 7665  al_path_old, eve
-00022100: 6e74 2e6c 6f63 616c 5f70 6174 6829 0a0a  nt.local_path)..
-00022110: 2020 2020 2020 2020 2020 2020 7769 7468              with
-00022120: 2073 656c 662e 5f64 6174 6162 6173 655f   self._database_
-00022130: 6163 6365 7373 2829 3a0a 2020 2020 2020  access():.      
-00022140: 2020 2020 2020 2020 2020 656e 7472 792e            entry.
-00022150: 6462 785f 7061 7468 5f63 6173 6564 203d  dbx_path_cased =
-00022160: 2065 7665 6e74 2e64 6278 5f70 6174 680a   event.dbx_path.
-00022170: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022180: 7365 6c66 2e5f 696e 6465 785f 7461 626c  self._index_tabl
-00022190: 652e 7570 6461 7465 2865 6e74 7279 290a  e.update(entry).
-000221a0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-000221b0: 662e 5f6c 6f67 6765 722e 6465 6275 6728  f._logger.debug(
-000221c0: 2752 656e 616d 6564 2022 2573 2220 746f  'Renamed "%s" to
-000221d0: 2022 2573 2227 2c20 6c6f 6361 6c5f 7061   "%s"', local_pa
-000221e0: 7468 5f6f 6c64 2c20 6576 656e 742e 6c6f  th_old, event.lo
-000221f0: 6361 6c5f 7061 7468 290a 0a20 2020 2064  cal_path)..    d
-00022200: 6566 2072 6573 6361 6e28 7365 6c66 2c20  ef rescan(self, 
-00022210: 6c6f 6361 6c5f 7061 7468 3a20 7374 7229  local_path: str)
-00022220: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2020   -> None:.      
-00022230: 2020 2222 220a 2020 2020 2020 2020 466f    """.        Fo
-00022240: 7263 6573 2061 2072 6573 6361 6e20 6f66  rces a rescan of
-00022250: 2061 206c 6f63 616c 2070 6174 683a 2073   a local path: s
-00022260: 6368 6564 756c 6573 2063 7265 6174 6564  chedules created
-00022270: 2065 7665 6e74 7320 666f 7220 6576 6572   events for ever
-00022280: 7920 666f 6c64 6572 2c0a 2020 2020 2020  y folder,.      
-00022290: 2020 6d6f 6469 6669 6564 2065 7665 6e74    modified event
-000222a0: 7320 666f 7220 6576 6572 7920 6669 6c65  s for every file
-000222b0: 2061 6e64 2064 656c 6574 6564 2065 7665   and deleted eve
-000222c0: 6e74 7320 666f 7220 6576 6572 7920 6465  nts for every de
-000222d0: 6c65 7465 6420 6974 656d 0a20 2020 2020  leted item.     
-000222e0: 2020 2028 636f 6d70 6172 6564 2074 6f20     (compared to 
-000222f0: 6f75 7220 696e 6465 7829 2e0a 0a20 2020  our index)...   
-00022300: 2020 2020 203a 7061 7261 6d20 6c6f 6361       :param loca
-00022310: 6c5f 7061 7468 3a20 5061 7468 2074 6f20  l_path: Path to 
-00022320: 7265 7363 616e 2e0a 2020 2020 2020 2020  rescan..        
-00022330: 2222 220a 2020 2020 2020 2020 7365 6c66  """.        self
-00022340: 2e5f 6c6f 6767 6572 2e64 6562 7567 2827  ._logger.debug('
-00022350: 5265 7363 616e 6e69 6e67 2022 2573 2227  Rescanning "%s"'
-00022360: 2c20 6c6f 6361 6c5f 7061 7468 290a 0a20  , local_path).. 
-00022370: 2020 2020 2020 2069 6620 6973 6669 6c65         if isfile
-00022380: 286c 6f63 616c 5f70 6174 6829 3a0a 2020  (local_path):.  
-00022390: 2020 2020 2020 2020 2020 7365 6c66 2e66            self.f
-000223a0: 735f 6576 656e 7473 2e71 7565 7565 5f65  s_events.queue_e
-000223b0: 7665 6e74 2846 696c 654d 6f64 6966 6965  vent(FileModifie
-000223c0: 6445 7665 6e74 286c 6f63 616c 5f70 6174  dEvent(local_pat
-000223d0: 6829 290a 0a20 2020 2020 2020 2065 6c69  h))..        eli
-000223e0: 6620 6973 6469 7228 6c6f 6361 6c5f 7061  f isdir(local_pa
-000223f0: 7468 293a 0a20 2020 2020 2020 2020 2020  th):.           
-00022400: 2073 656c 662e 6673 5f65 7665 6e74 732e   self.fs_events.
-00022410: 7175 6575 655f 6576 656e 7428 4469 7243  queue_event(DirC
-00022420: 7265 6174 6564 4576 656e 7428 6c6f 6361  reatedEvent(loca
-00022430: 6c5f 7061 7468 2929 0a0a 2020 2020 2020  l_path))..      
-00022440: 2020 2020 2020 2320 4164 6420 6372 6561        # Add crea
-00022450: 7465 6420 616e 6420 6d6f 6469 6669 6564  ted and modified
-00022460: 2065 7665 6e74 7320 666f 7220 6368 696c   events for chil
-00022470: 6472 656e 2061 7320 6170 7072 6f70 7269  dren as appropri
-00022480: 6174 652e 0a0a 2020 2020 2020 2020 2020  ate...          
-00022490: 2020 666f 7220 7061 7468 2c20 7374 6174    for path, stat
-000224a0: 2069 6e20 7761 6c6b 286c 6f63 616c 5f70   in walk(local_p
-000224b0: 6174 682c 2073 656c 662e 5f73 6361 6e64  ath, self._scand
-000224c0: 6972 5f77 6974 685f 6967 6e6f 7265 293a  ir_with_ignore):
-000224d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000224e0: 2069 6620 535f 4953 4449 5228 7374 6174   if S_ISDIR(stat
-000224f0: 2e73 745f 6d6f 6465 293a 0a20 2020 2020  .st_mode):.     
-00022500: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-00022510: 656c 662e 6673 5f65 7665 6e74 732e 7175  elf.fs_events.qu
-00022520: 6575 655f 6576 656e 7428 4469 7243 7265  eue_event(DirCre
-00022530: 6174 6564 4576 656e 7428 7061 7468 2929  atedEvent(path))
-00022540: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00022550: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-00022560: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-00022570: 6673 5f65 7665 6e74 732e 7175 6575 655f  fs_events.queue_
-00022580: 6576 656e 7428 4669 6c65 4d6f 6469 6669  event(FileModifi
-00022590: 6564 4576 656e 7428 7061 7468 2929 0a0a  edEvent(path))..
-000225a0: 2020 2020 2020 2020 2020 2020 2320 4164              # Ad
-000225b0: 6420 6465 6c65 7465 6420 6576 656e 7473  d deleted events
-000225c0: 2066 6f72 2063 6869 6c64 7265 6e2e 0a0a   for children...
-000225d0: 2020 2020 2020 2020 2020 2020 6462 785f              dbx_
-000225e0: 7061 7468 5f6c 6f77 6572 203d 2073 656c  path_lower = sel
-000225f0: 662e 746f 5f64 6278 5f70 6174 685f 6c6f  f.to_dbx_path_lo
-00022600: 7765 7228 6c6f 6361 6c5f 7061 7468 290a  wer(local_path).
-00022610: 0a20 2020 2020 2020 2020 2020 2077 6974  .            wit
-00022620: 6820 7365 6c66 2e5f 6461 7461 6261 7365  h self._database
-00022630: 5f61 6363 6573 7328 293a 0a20 2020 2020  _access():.     
-00022640: 2020 2020 2020 2020 2020 2071 7565 7279             query
-00022650: 203d 2050 6174 6854 7265 6551 7565 7279   = PathTreeQuery
-00022660: 2849 6e64 6578 456e 7472 792e 6462 785f  (IndexEntry.dbx_
-00022670: 7061 7468 5f6c 6f77 6572 2c20 6462 785f  path_lower, dbx_
-00022680: 7061 7468 5f6c 6f77 6572 290a 2020 2020  path_lower).    
-00022690: 2020 2020 2020 2020 2020 2020 656e 7472              entr
-000226a0: 6965 7320 3d20 7365 6c66 2e5f 696e 6465  ies = self._inde
-000226b0: 785f 7461 626c 652e 7365 6c65 6374 2871  x_table.select(q
-000226c0: 7565 7279 290a 0a20 2020 2020 2020 2020  uery)..         
-000226d0: 2020 2066 6f72 2065 6e74 7279 2069 6e20     for entry in 
-000226e0: 656e 7472 6965 733a 0a20 2020 2020 2020  entries:.       
-000226f0: 2020 2020 2020 2020 2063 6869 6c64 5f70           child_p
-00022700: 6174 6820 3d20 7365 6c66 2e74 6f5f 6c6f  ath = self.to_lo
-00022710: 6361 6c5f 7061 7468 5f66 726f 6d5f 6361  cal_path_from_ca
-00022720: 7365 6428 656e 7472 792e 6462 785f 7061  sed(entry.dbx_pa
-00022730: 7468 5f63 6173 6564 290a 2020 2020 2020  th_cased).      
-00022740: 2020 2020 2020 2020 2020 6966 206e 6f74            if not
-00022750: 2065 7869 7374 7328 6368 696c 645f 7061   exists(child_pa
-00022760: 7468 293a 0a20 2020 2020 2020 2020 2020  th):.           
-00022770: 2020 2020 2020 2020 2069 6620 656e 7472           if entr
-00022780: 792e 6973 5f64 6972 6563 746f 7279 3a0a  y.is_directory:.
-00022790: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000227a0: 2020 2020 2020 2020 7365 6c66 2e66 735f          self.fs_
-000227b0: 6576 656e 7473 2e71 7565 7565 5f65 7665  events.queue_eve
-000227c0: 6e74 2844 6972 4465 6c65 7465 6445 7665  nt(DirDeletedEve
-000227d0: 6e74 2863 6869 6c64 5f70 6174 6829 290a  nt(child_path)).
-000227e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000227f0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-00022800: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022810: 2020 7365 6c66 2e66 735f 6576 656e 7473    self.fs_events
-00022820: 2e71 7565 7565 5f65 7665 6e74 2846 696c  .queue_event(Fil
-00022830: 6544 656c 6574 6564 4576 656e 7428 6368  eDeletedEvent(ch
-00022840: 696c 645f 7061 7468 2929 0a0a 2020 2020  ild_path))..    
-00022850: 2020 2020 656c 6966 206e 6f74 2065 7869      elif not exi
-00022860: 7374 7328 6c6f 6361 6c5f 7061 7468 293a  sts(local_path):
-00022870: 0a20 2020 2020 2020 2020 2020 2064 6278  .            dbx
-00022880: 5f70 6174 685f 6c6f 7765 7220 3d20 7365  _path_lower = se
-00022890: 6c66 2e74 6f5f 6462 785f 7061 7468 5f6c  lf.to_dbx_path_l
-000228a0: 6f77 6572 286c 6f63 616c 5f70 6174 6829  ower(local_path)
-000228b0: 0a20 2020 2020 2020 2020 2020 206c 6f63  .            loc
-000228c0: 616c 5f65 6e74 7279 203d 2073 656c 662e  al_entry = self.
-000228d0: 6765 745f 696e 6465 785f 656e 7472 7928  get_index_entry(
-000228e0: 6462 785f 7061 7468 5f6c 6f77 6572 290a  dbx_path_lower).
-000228f0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-00022900: 6c6f 6361 6c5f 656e 7472 793a 0a20 2020  local_entry:.   
-00022910: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-00022920: 6c6f 6361 6c5f 656e 7472 792e 6973 5f64  local_entry.is_d
-00022930: 6972 6563 746f 7279 3a0a 2020 2020 2020  irectory:.      
-00022940: 2020 2020 2020 2020 2020 2020 2020 7365                se
-00022950: 6c66 2e66 735f 6576 656e 7473 2e71 7565  lf.fs_events.que
-00022960: 7565 5f65 7665 6e74 2844 6972 4465 6c65  ue_event(DirDele
-00022970: 7465 6445 7665 6e74 286c 6f63 616c 5f70  tedEvent(local_p
-00022980: 6174 6829 290a 2020 2020 2020 2020 2020  ath)).          
-00022990: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-000229a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000229b0: 7365 6c66 2e66 735f 6576 656e 7473 2e71  self.fs_events.q
-000229c0: 7565 7565 5f65 7665 6e74 2846 696c 6544  ueue_event(FileD
-000229d0: 656c 6574 6564 4576 656e 7428 6c6f 6361  eletedEvent(loca
-000229e0: 6c5f 7061 7468 2929 0a0a 2020 2020 6465  l_path))..    de
-000229f0: 6620 5f63 6c65 616e 5f68 6973 746f 7279  f _clean_history
-00022a00: 2873 656c 6629 202d 3e20 4e6f 6e65 3a0a  (self) -> None:.
-00022a10: 2020 2020 2020 2020 2222 2243 6f6d 6d69          """Commi
-00022a20: 7473 206e 6577 2065 7665 6e74 7320 616e  ts new events an
-00022a30: 6420 7265 6d6f 7665 7320 616c 6c20 6576  d removes all ev
-00022a40: 656e 7473 206f 6c64 6572 2074 6861 6e20  ents older than 
-00022a50: 6060 5f6b 6565 705f 6869 7374 6f72 7960  ``_keep_history`
-00022a60: 6020 6672 6f6d 0a20 2020 2020 2020 2068  ` from.        h
-00022a70: 6973 746f 7279 2e22 2222 0a20 2020 2020  istory.""".     
-00022a80: 2020 2077 6974 6820 7365 6c66 2e5f 6461     with self._da
-00022a90: 7461 6261 7365 5f61 6363 6573 7328 293a  tabase_access():
-00022aa0: 0a20 2020 2020 2020 2020 2020 2023 2044  .            # D
-00022ab0: 726f 7020 616c 6c20 656e 7472 6965 7320  rop all entries 
-00022ac0: 6f6c 6465 7220 7468 616e 206b 6565 705f  older than keep_
-00022ad0: 6869 7374 6f72 792e 0a20 2020 2020 2020  history..       
-00022ae0: 2020 2020 206e 6f77 203d 2074 696d 652e       now = time.
-00022af0: 7469 6d65 2829 0a20 2020 2020 2020 2020  time().         
-00022b00: 2020 206b 6565 705f 6869 7374 6f72 7920     keep_history 
-00022b10: 3d20 7365 6c66 2e5f 636f 6e66 2e67 6574  = self._conf.get
-00022b20: 2822 7379 6e63 222c 2022 6b65 6570 5f68  ("sync", "keep_h
-00022b30: 6973 746f 7279 2229 0a0a 2020 2020 2020  istory")..      
-00022b40: 2020 2020 2020 7365 6c66 2e5f 6462 2e65        self._db.e
-00022b50: 7865 6375 7465 280a 2020 2020 2020 2020  xecute(.        
-00022b60: 2020 2020 2020 2020 2244 454c 4554 4520          "DELETE 
-00022b70: 4652 4f4d 2068 6973 746f 7279 2057 4845  FROM history WHE
-00022b80: 5245 2049 464e 554c 4c28 6368 616e 6765  RE IFNULL(change
-00022b90: 5f74 696d 652c 2073 796e 635f 7469 6d65  _time, sync_time
-00022ba0: 2920 3c20 3f22 2c0a 2020 2020 2020 2020  ) < ?",.        
-00022bb0: 2020 2020 2020 2020 6e6f 7720 2d20 6b65          now - ke
-00022bc0: 6570 5f68 6973 746f 7279 2c0a 2020 2020  ep_history,.    
-00022bd0: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-00022be0: 2020 2020 2020 7365 6c66 2e5f 6869 7374        self._hist
-00022bf0: 6f72 795f 7461 626c 652e 636c 6561 725f  ory_table.clear_
-00022c00: 6361 6368 6528 290a 0a20 2020 2064 6566  cache()..    def
-00022c10: 205f 7363 616e 6469 725f 7769 7468 5f69   _scandir_with_i
-00022c20: 676e 6f72 6528 0a20 2020 2020 2020 2073  gnore(.        s
-00022c30: 656c 662c 2070 6174 683a 2073 7472 207c  elf, path: str |
-00022c40: 206f 732e 5061 7468 4c69 6b65 5b73 7472   os.PathLike[str
-00022c50: 5d0a 2020 2020 2920 2d3e 2049 7465 7261  ].    ) -> Itera
-00022c60: 746f 725b 6f73 2e44 6972 456e 7472 795b  tor[os.DirEntry[
-00022c70: 7374 725d 5d3a 0a20 2020 2020 2020 2077  str]]:.        w
-00022c80: 6974 6820 6f73 2e73 6361 6e64 6972 2870  ith os.scandir(p
-00022c90: 6174 6829 2061 7320 6974 3a0a 2020 2020  ath) as it:.    
-00022ca0: 2020 2020 2020 2020 666f 7220 656e 7472          for entr
-00022cb0: 7920 696e 2069 743a 0a20 2020 2020 2020  y in it:.       
-00022cc0: 2020 2020 2020 2020 2064 6278 5f70 6174           dbx_pat
-00022cd0: 6820 3d20 7365 6c66 2e74 6f5f 6462 785f  h = self.to_dbx_
-00022ce0: 7061 7468 2865 6e74 7279 2e70 6174 6829  path(entry.path)
-00022cf0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00022d00: 2069 6620 6e6f 7420 7365 6c66 2e69 735f   if not self.is_
-00022d10: 6578 636c 7564 6564 2865 6e74 7279 2e70  excluded(entry.p
-00022d20: 6174 6829 2061 6e64 206e 6f74 2073 656c  ath) and not sel
-00022d30: 662e 5f69 735f 6d69 676e 6f72 655f 7061  f._is_mignore_pa
-00022d40: 7468 280a 2020 2020 2020 2020 2020 2020  th(.            
-00022d50: 2020 2020 2020 2020 6462 785f 7061 7468          dbx_path
-00022d60: 2c20 656e 7472 792e 6973 5f64 6972 2866  , entry.is_dir(f
-00022d70: 6f6c 6c6f 775f 7379 6d6c 696e 6b73 3d46  ollow_symlinks=F
-00022d80: 616c 7365 290a 2020 2020 2020 2020 2020  alse).          
-00022d90: 2020 2020 2020 293a 0a20 2020 2020 2020        ):.       
-00022da0: 2020 2020 2020 2020 2020 2020 2079 6965               yie
-00022db0: 6c64 2065 6e74 7279 0a0a 0a23 203d 3d3d  ld entry...# ===
-00022dc0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00022dd0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00022de0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00022df0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00022e00: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00022e10: 3d3d 3d0a 2320 4865 6c70 6572 2066 756e  ===.# Helper fun
-00022e20: 6374 696f 6e73 0a23 203d 3d3d 3d3d 3d3d  ctions.# =======
-00022e30: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00022e40: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00022e50: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00022e60: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00022e70: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d0a  ===============.
-00022e80: 0a0a 6465 6620 646f 5f70 6172 616c 6c65  ..def do_paralle
-00022e90: 6c28 0a20 2020 2066 756e 633a 2043 616c  l(.    func: Cal
-00022ea0: 6c61 626c 655b 502c 2054 5d2c 0a20 2020  lable[P, T],.   
-00022eb0: 202a 6974 6572 6162 6c65 3a20 436f 6c6c   *iterable: Coll
-00022ec0: 6563 7469 6f6e 5b50 2e61 7267 735d 2c0a  ection[P.args],.
-00022ed0: 2020 2020 7468 7265 6164 5f6e 616d 655f      thread_name_
-00022ee0: 7072 6566 6978 3a20 7374 7220 3d20 2222  prefix: str = ""
-00022ef0: 2c0a 2020 2020 6f6e 5f70 726f 6772 6573  ,.    on_progres
-00022f00: 733a 2043 616c 6c61 626c 655b 5b69 6e74  s: Callable[[int
-00022f10: 2c20 696e 745d 2c20 416e 795d 207c 204e  , int], Any] | N
-00022f20: 6f6e 6520 3d20 4e6f 6e65 2c0a 2920 2d3e  one = None,.) ->
-00022f30: 2049 7465 7261 626c 655b 545d 3a0a 2020   Iterable[T]:.  
-00022f40: 2020 2222 220a 2020 2020 5369 6d69 6c61    """.    Simila
-00022f50: 7220 746f 2060 6054 6872 6561 6450 6f6f  r to ``ThreadPoo
-00022f60: 6c45 7865 6375 746f 722e 6d61 7028 2960  lExecutor.map()`
-00022f70: 6020 6275 7420 7969 656c 6473 2072 6573  ` but yields res
-00022f80: 756c 7473 2061 7320 7468 6579 2062 6563  ults as they bec
-00022f90: 6f6d 6520 6176 6169 6c61 626c 652e 0a0a  ome available...
-00022fa0: 2020 2020 3a70 6172 616d 2066 756e 633a      :param func:
-00022fb0: 2041 7070 6c79 2074 6869 7320 6361 6c6c   Apply this call
-00022fc0: 6162 6c65 2074 6f20 6576 6572 7920 6974  able to every it
-00022fd0: 656d 206f 6620 6060 6974 6572 6162 6c65  em of ``iterable
-00022fe0: 6060 2e0a 2020 2020 3a70 6172 616d 2069  ``..    :param i
-00022ff0: 7465 7261 626c 653a 2049 7465 7261 626c  terable: Iterabl
-00023000: 6520 7769 7468 2061 7267 756d 656e 7473  e with arguments
-00023010: 2074 6f20 7061 7373 2074 6f20 6060 6675   to pass to ``fu
-00023020: 6e63 6060 2e0a 2020 2020 3a70 6172 616d  nc``..    :param
-00023030: 2074 6872 6561 645f 6e61 6d65 5f70 7265   thread_name_pre
-00023040: 6669 783a 2055 7365 6420 666f 7220 696e  fix: Used for in
-00023050: 7465 726e 616c 2054 6872 6561 6450 6f6f  ternal ThreadPoo
-00023060: 6c45 7865 6375 746f 722e 0a20 2020 203a  lExecutor..    :
-00023070: 7061 7261 6d20 6f6e 5f70 726f 6772 6573  param on_progres
-00023080: 733a 2043 616c 6c62 6163 6b20 7768 656e  s: Callback when
-00023090: 2065 6163 6820 7461 736b 2069 7320 636f   each task is co
-000230a0: 6d70 6c65 7465 642e 2054 616b 6573 2074  mpleted. Takes t
-000230b0: 6865 206e 756d 6265 7220 6f66 0a20 2020  he number of.   
-000230c0: 2020 2020 2063 6f6d 706c 6574 6564 2069       completed i
-000230d0: 7465 6d73 2061 6e64 2074 6865 2074 6f74  tems and the tot
-000230e0: 616c 206e 756d 6265 7220 6f66 2069 7465  al number of ite
-000230f0: 6d73 2061 7320 6172 6775 6d65 6e74 732e  ms as arguments.
-00023100: 0a20 2020 2022 2222 0a20 2020 2077 6974  .    """.    wit
-00023110: 6820 5468 7265 6164 506f 6f6c 4578 6563  h ThreadPoolExec
-00023120: 7574 6f72 280a 2020 2020 2020 2020 6d61  utor(.        ma
-00023130: 785f 776f 726b 6572 733d 4e55 4d5f 5448  x_workers=NUM_TH
-00023140: 5245 4144 532c 2074 6872 6561 645f 6e61  READS, thread_na
-00023150: 6d65 5f70 7265 6669 783d 7468 7265 6164  me_prefix=thread
-00023160: 5f6e 616d 655f 7072 6566 6978 0a20 2020  _name_prefix.   
-00023170: 2029 2061 7320 7470 653a 0a20 2020 2020   ) as tpe:.     
-00023180: 2020 2066 7320 3d20 5b74 7065 2e73 7562     fs = [tpe.sub
-00023190: 6d69 7428 6675 6e63 2c20 2a61 7267 7329  mit(func, *args)
-000231a0: 2066 6f72 2061 7267 7320 696e 207a 6970   for args in zip
-000231b0: 282a 6974 6572 6162 6c65 295d 0a0a 2020  (*iterable)]..  
-000231c0: 2020 2020 2020 6e5f 646f 6e65 203d 2030        n_done = 0
-000231d0: 0a20 2020 2020 2020 2066 6f72 2066 2069  .        for f i
-000231e0: 6e20 6173 5f63 6f6d 706c 6574 6564 2866  n as_completed(f
-000231f0: 7329 3a0a 2020 2020 2020 2020 2020 2020  s):.            
-00023200: 6e5f 646f 6e65 202b 3d20 310a 2020 2020  n_done += 1.    
-00023210: 2020 2020 2020 2020 6966 206f 6e5f 7072          if on_pr
-00023220: 6f67 7265 7373 3a0a 2020 2020 2020 2020  ogress:.        
-00023230: 2020 2020 2020 2020 6f6e 5f70 726f 6772          on_progr
-00023240: 6573 7328 6e5f 646f 6e65 2c20 6c65 6e28  ess(n_done, len(
-00023250: 6974 6572 6162 6c65 5b30 5d29 290a 2020  iterable[0])).  
-00023260: 2020 2020 2020 2020 2020 7969 656c 6420            yield 
-00023270: 662e 7265 7375 6c74 2829 0a0a 0a64 6566  f.result()...def
-00023280: 2069 735f 6d6f 7665 6428 6576 656e 743a   is_moved(event:
-00023290: 2046 696c 6553 7973 7465 6d45 7665 6e74   FileSystemEvent
-000232a0: 2920 2d3e 2054 7970 6547 7561 7264 5b46  ) -> TypeGuard[F
-000232b0: 696c 654d 6f76 6564 4576 656e 7420 7c20  ileMovedEvent | 
-000232c0: 4469 724d 6f76 6564 4576 656e 745d 3a0a  DirMovedEvent]:.
-000232d0: 2020 2020 7265 7475 726e 2065 7665 6e74      return event
-000232e0: 2e65 7665 6e74 5f74 7970 6520 3d3d 2045  .event_type == E
-000232f0: 5645 4e54 5f54 5950 455f 4d4f 5645 440a  VENT_TYPE_MOVED.
-00023300: 0a0a 6465 6620 6973 5f64 656c 6574 6564  ..def is_deleted
-00023310: 2865 7665 6e74 3a20 4669 6c65 5379 7374  (event: FileSyst
-00023320: 656d 4576 656e 7429 202d 3e20 5479 7065  emEvent) -> Type
-00023330: 4775 6172 645b 4669 6c65 4465 6c65 7465  Guard[FileDelete
-00023340: 6445 7665 6e74 207c 2044 6972 4465 6c65  dEvent | DirDele
-00023350: 7465 6445 7665 6e74 5d3a 0a20 2020 2072  tedEvent]:.    r
-00023360: 6574 7572 6e20 6576 656e 742e 6576 656e  eturn event.even
-00023370: 745f 7479 7065 203d 3d20 4556 454e 545f  t_type == EVENT_
-00023380: 5459 5045 5f44 454c 4554 4544 0a0a 0a64  TYPE_DELETED...d
-00023390: 6566 2069 735f 6372 6561 7465 6428 6576  ef is_created(ev
-000233a0: 656e 743a 2046 696c 6553 7973 7465 6d45  ent: FileSystemE
-000233b0: 7665 6e74 2920 2d3e 2054 7970 6547 7561  vent) -> TypeGua
-000233c0: 7264 5b46 696c 6543 7265 6174 6564 4576  rd[FileCreatedEv
-000233d0: 656e 7420 7c20 4469 7243 7265 6174 6564  ent | DirCreated
-000233e0: 4576 656e 745d 3a0a 2020 2020 7265 7475  Event]:.    retu
-000233f0: 726e 2065 7665 6e74 2e65 7665 6e74 5f74  rn event.event_t
-00023400: 7970 6520 3d3d 2045 5645 4e54 5f54 5950  ype == EVENT_TYP
-00023410: 455f 4352 4541 5445 440a 0a0a 6465 6620  E_CREATED...def 
-00023420: 6765 745f 6465 7374 5f70 6174 6828 6576  get_dest_path(ev
-00023430: 656e 743a 2046 696c 6553 7973 7465 6d45  ent: FileSystemE
-00023440: 7665 6e74 2920 2d3e 2073 7472 3a0a 2020  vent) -> str:.  
-00023450: 2020 2222 220a 2020 2020 5265 7475 726e    """.    Return
-00023460: 7320 7468 6520 6465 7374 5f70 6174 6820  s the dest_path 
-00023470: 6f66 2061 2066 696c 6520 7379 7374 656d  of a file system
-00023480: 2065 7665 6e74 2069 6620 7072 6573 656e   event if presen
-00023490: 7420 286d 6f76 6564 2065 7665 6e74 7320  t (moved events 
-000234a0: 6f6e 6c79 290a 2020 2020 6f74 6865 7277  only).    otherw
-000234b0: 6973 6520 7265 7475 726e 7320 7468 6520  ise returns the 
-000234c0: 7372 635f 7061 7468 2028 7768 6963 6820  src_path (which 
-000234d0: 6973 2061 6c73 6f20 7468 6520 2264 6573  is also the "des
-000234e0: 7469 6e61 7469 6f6e 2229 2e0a 0a20 2020  tination")...   
-000234f0: 203a 7061 7261 6d20 6576 656e 743a 2057   :param event: W
-00023500: 6174 6368 646f 6720 6669 6c65 2073 7973  atchdog file sys
-00023510: 7465 6d20 6576 656e 742e 0a20 2020 203a  tem event..    :
-00023520: 7265 7475 726e 733a 2044 6573 7469 6e61  returns: Destina
-00023530: 7469 6f6e 2070 6174 6820 666f 7220 6d6f  tion path for mo
-00023540: 7665 6420 6576 656e 742c 2073 6f75 7263  ved event, sourc
-00023550: 6520 7061 7468 206f 7468 6572 7769 7365  e path otherwise
-00023560: 2e0a 2020 2020 2222 220a 2020 2020 6966  ..    """.    if
-00023570: 2069 7369 6e73 7461 6e63 6528 6576 656e   isinstance(even
-00023580: 742c 2028 4669 6c65 4d6f 7665 6445 7665  t, (FileMovedEve
-00023590: 6e74 2c20 4469 724d 6f76 6564 4576 656e  nt, DirMovedEven
-000235a0: 7429 293a 0a20 2020 2020 2020 2072 6574  t)):.        ret
-000235b0: 7572 6e20 6576 656e 742e 6465 7374 5f70  urn event.dest_p
-000235c0: 6174 680a 2020 2020 7265 7475 726e 2065  ath.    return e
-000235d0: 7665 6e74 2e73 7263 5f70 6174 680a 0a0a  vent.src_path...
-000235e0: 406f 7665 726c 6f61 640a 6465 6620 7370  @overload.def sp
-000235f0: 6c69 745f 6d6f 7665 645f 6576 656e 7428  lit_moved_event(
-00023600: 0a20 2020 2065 7665 6e74 3a20 4669 6c65  .    event: File
-00023610: 4d6f 7665 6445 7665 6e74 2c0a 2920 2d3e  MovedEvent,.) ->
-00023620: 2074 7570 6c65 5b46 696c 6544 656c 6574   tuple[FileDelet
-00023630: 6564 4576 656e 742c 2046 696c 6543 7265  edEvent, FileCre
-00023640: 6174 6564 4576 656e 745d 3a0a 2020 2020  atedEvent]:.    
-00023650: 2e2e 2e0a 0a0a 406f 7665 726c 6f61 640a  ......@overload.
-00023660: 6465 6620 7370 6c69 745f 6d6f 7665 645f  def split_moved_
-00023670: 6576 656e 7428 6576 656e 743a 2044 6972  event(event: Dir
-00023680: 4d6f 7665 6445 7665 6e74 2920 2d3e 2074  MovedEvent) -> t
-00023690: 7570 6c65 5b44 6972 4465 6c65 7465 6445  uple[DirDeletedE
-000236a0: 7665 6e74 2c20 4469 7243 7265 6174 6564  vent, DirCreated
-000236b0: 4576 656e 745d 3a0a 2020 2020 2e2e 2e0a  Event]:.    ....
-000236c0: 0a0a 6465 6620 7370 6c69 745f 6d6f 7665  ..def split_move
-000236d0: 645f 6576 656e 7428 0a20 2020 2065 7665  d_event(.    eve
-000236e0: 6e74 3a20 4669 6c65 4d6f 7665 6445 7665  nt: FileMovedEve
-000236f0: 6e74 207c 2044 6972 4d6f 7665 6445 7665  nt | DirMovedEve
-00023700: 6e74 2c0a 2920 2d3e 2074 7570 6c65 5b46  nt,.) -> tuple[F
-00023710: 696c 6553 7973 7465 6d45 7665 6e74 2c20  ileSystemEvent, 
-00023720: 4669 6c65 5379 7374 656d 4576 656e 745d  FileSystemEvent]
-00023730: 3a0a 2020 2020 2222 220a 2020 2020 5370  :.    """.    Sp
-00023740: 6c69 7473 2061 2046 696c 654d 6f76 6564  lits a FileMoved
-00023750: 4576 656e 7420 6f72 2044 6972 4d6f 7665  Event or DirMove
-00023760: 6445 7665 6e74 2069 6e74 6f20 2264 656c  dEvent into "del
-00023770: 6574 6564 2220 616e 6420 2263 7265 6174  eted" and "creat
-00023780: 6564 2220 6576 656e 7473 206f 6620 7468  ed" events of th
-00023790: 650a 2020 2020 7361 6d65 2074 7970 652e  e.    same type.
-000237a0: 2041 206e 6577 2061 7474 7269 6275 7465   A new attribute
-000237b0: 2060 606d 6f76 655f 6964 6060 2069 7320   ``move_id`` is 
-000237c0: 6164 6465 6420 746f 2062 6f74 6820 696e  added to both in
-000237d0: 7374 616e 6365 732e 0a0a 2020 2020 3a70  stances...    :p
-000237e0: 6172 616d 2065 7665 6e74 3a20 4f72 6967  aram event: Orig
-000237f0: 696e 616c 2065 7665 6e74 2e0a 2020 2020  inal event..    
-00023800: 3a72 6574 7572 6e73 3a20 5475 706c 6520  :returns: Tuple 
-00023810: 6f66 2064 656c 6574 6564 2061 6e64 2063  of deleted and c
-00023820: 7265 6174 6564 2065 7665 6e74 732e 0a20  reated events.. 
-00023830: 2020 2022 2222 0a20 2020 2063 7265 6174     """.    creat
-00023840: 6564 5f65 7665 6e74 5f63 6c73 3a20 5479  ed_event_cls: Ty
-00023850: 7065 5b46 696c 6553 7973 7465 6d45 7665  pe[FileSystemEve
-00023860: 6e74 5d0a 2020 2020 6465 6c65 7465 645f  nt].    deleted_
-00023870: 6576 656e 745f 636c 733a 2054 7970 655b  event_cls: Type[
-00023880: 4669 6c65 5379 7374 656d 4576 656e 745d  FileSystemEvent]
-00023890: 0a20 2020 2069 6620 6576 656e 742e 6973  .    if event.is
-000238a0: 5f64 6972 6563 746f 7279 3a0a 2020 2020  _directory:.    
-000238b0: 2020 2020 6372 6561 7465 645f 6576 656e      created_even
-000238c0: 745f 636c 7320 3d20 4469 7243 7265 6174  t_cls = DirCreat
-000238d0: 6564 4576 656e 740a 2020 2020 2020 2020  edEvent.        
-000238e0: 6465 6c65 7465 645f 6576 656e 745f 636c  deleted_event_cl
-000238f0: 7320 3d20 4469 7244 656c 6574 6564 4576  s = DirDeletedEv
-00023900: 656e 740a 2020 2020 656c 7365 3a0a 2020  ent.    else:.  
-00023910: 2020 2020 2020 6372 6561 7465 645f 6576        created_ev
-00023920: 656e 745f 636c 7320 3d20 4669 6c65 4372  ent_cls = FileCr
-00023930: 6561 7465 6445 7665 6e74 0a20 2020 2020  eatedEvent.     
-00023940: 2020 2064 656c 6574 6564 5f65 7665 6e74     deleted_event
-00023950: 5f63 6c73 203d 2046 696c 6544 656c 6574  _cls = FileDelet
-00023960: 6564 4576 656e 740a 0a20 2020 2064 656c  edEvent..    del
-00023970: 6574 6564 5f65 7665 6e74 203d 2064 656c  eted_event = del
-00023980: 6574 6564 5f65 7665 6e74 5f63 6c73 2865  eted_event_cls(e
-00023990: 7665 6e74 2e73 7263 5f70 6174 6829 0a20  vent.src_path). 
-000239a0: 2020 2063 7265 6174 6564 5f65 7665 6e74     created_event
-000239b0: 203d 2063 7265 6174 6564 5f65 7665 6e74   = created_event
-000239c0: 5f63 6c73 2865 7665 6e74 2e64 6573 745f  _cls(event.dest_
-000239d0: 7061 7468 290a 0a20 2020 2072 6574 7572  path)..    retur
-000239e0: 6e20 6465 6c65 7465 645f 6576 656e 742c  n deleted_event,
-000239f0: 2063 7265 6174 6564 5f65 7665 6e74 0a0a   created_event..
-00023a00: 0a63 6c61 7373 2070 665f 7265 7072 3a0a  .class pf_repr:.
-00023a10: 2020 2020 2222 220a 2020 2020 436c 6173      """.    Clas
-00023a20: 7320 7468 6174 2077 7261 7073 2061 6e20  s that wraps an 
-00023a30: 6f62 6a65 6374 2061 6e64 2063 7265 6174  object and creat
-00023a40: 6573 2061 2070 7265 7474 7920 666f 726d  es a pretty form
-00023a50: 6174 7465 6420 7265 7072 6573 656e 7461  atted representa
-00023a60: 7469 6f6e 2066 6f72 2069 742e 0a20 2020  tion for it..   
-00023a70: 2054 6869 7320 6361 6e20 6265 2075 7365   This can be use
-00023a80: 6420 746f 2067 6574 2070 7265 7474 7920  d to get pretty 
-00023a90: 666f 726d 6174 7469 6e67 2069 6e20 6c6f  formatting in lo
-00023aa0: 6720 6d65 7373 6167 6573 2077 6869 6c65  g messages while
-00023ab0: 2064 6566 6572 7269 6e67 2074 6865 2061   deferring the a
-00023ac0: 6374 7561 6c0a 2020 2020 666f 726d 6174  ctual.    format
-00023ad0: 7469 6e67 2075 6e74 696c 2074 6865 206d  ting until the m
-00023ae0: 6573 7361 6765 2069 7320 6372 6561 7465  essage is create
-00023af0: 642e 0a0a 2020 2020 3a70 6172 616d 206f  d...    :param o
-00023b00: 626a 3a20 4f62 6a65 6374 2074 6f20 7772  bj: Object to wr
-00023b10: 6170 2e0a 2020 2020 2222 220a 0a20 2020  ap..    """..   
-00023b20: 2064 6566 205f 5f69 6e69 745f 5f28 7365   def __init__(se
-00023b30: 6c66 2c20 6f62 6a3a 2041 6e79 2920 2d3e  lf, obj: Any) ->
-00023b40: 204e 6f6e 653a 0a20 2020 2020 2020 2073   None:.        s
-00023b50: 656c 662e 6f62 6a20 3d20 6f62 6a0a 0a20  elf.obj = obj.. 
-00023b60: 2020 2064 6566 205f 5f72 6570 725f 5f28     def __repr__(
-00023b70: 7365 6c66 2920 2d3e 2073 7472 3a0a 2020  self) -> str:.  
-00023b80: 2020 2020 2020 7265 7475 726e 2070 666f        return pfo
-00023b90: 726d 6174 2873 656c 662e 6f62 6a29 0a0a  rmat(self.obj)..
-00023ba0: 0a64 6566 2063 6865 636b 5f65 6e63 6f64  .def check_encod
-00023bb0: 696e 6728 6c6f 6361 6c5f 7061 7468 3a20  ing(local_path: 
-00023bc0: 7374 7229 202d 3e20 4e6f 6e65 3a0a 2020  str) -> None:.  
-00023bd0: 2020 2222 220a 2020 2020 5661 6c69 6461    """.    Valida
-00023be0: 7465 2074 6861 7420 7468 6520 7061 7468  te that the path
-00023bf0: 2063 6f6e 7461 696e 7320 6f6e 6c79 2063   contains only c
-00023c00: 6861 7261 6374 6572 7320 696e 2074 6865  haracters in the
-00023c10: 2072 6570 6f72 7465 6420 6669 6c65 2073   reported file s
-00023c20: 7973 7465 6d0a 2020 2020 656e 636f 6469  ystem.    encodi
-00023c30: 6e67 2e20 4f6e 2055 6e69 782c 2070 6174  ng. On Unix, pat
-00023c40: 6873 2061 7265 2066 756e 6461 6d65 6e74  hs are fundament
-00023c50: 616c 6c79 2062 7974 6573 2061 6e64 2073  ally bytes and s
-00023c60: 6f6d 6520 706c 6174 666f 726d 7320 646f  ome platforms do
-00023c70: 206e 6f74 2065 6e66 6f72 6365 0a20 2020   not enforce.   
-00023c80: 2061 2075 6e69 666f 726d 2065 6e63 6f64   a uniform encod
-00023c90: 696e 6720 6f66 2066 696c 6520 6e61 6d65  ing of file name
-00023ca0: 7320 6465 7370 6974 6520 7265 706f 7274  s despite report
-00023cb0: 696e 6720 6120 6669 6c65 2073 7973 7465  ing a file syste
-00023cc0: 6d20 656e 636f 6469 6e67 2e20 5375 6368  m encoding. Such
-00023cd0: 0a20 2020 2070 6174 6873 2077 696c 6c20  .    paths will 
-00023ce0: 6265 2068 616e 6465 6420 746f 2075 7320  be handed to us 
-00023cf0: 696e 2050 7974 686f 6e20 7769 7468 2022  in Python with "
-00023d00: 7375 7272 6f67 6174 6520 6573 6361 7065  surrogate escape
-00023d10: 7322 2069 6e20 706c 6163 6520 6f66 2074  s" in place of t
-00023d20: 6865 0a20 2020 2075 6e6b 6e6f 776e 2063  he.    unknown c
-00023d30: 6861 7261 6374 6572 732e 0a0a 2020 2020  haracters...    
-00023d40: 5369 6e63 6520 7468 6520 4472 6f70 626f  Since the Dropbo
-00023d50: 7820 4150 4920 616e 6420 6f75 7220 6461  x API and our da
-00023d60: 7461 6261 7365 2062 6f74 6820 7265 7175  tabase both requ
-00023d70: 6972 6520 7574 662d 3820 656e 636f 6465  ire utf-8 encode
-00023d80: 6420 7061 7468 732c 2077 6520 7573 6520  d paths, we use 
-00023d90: 7468 6973 0a20 2020 206d 6574 686f 6420  this.    method 
-00023da0: 746f 2063 6865 636b 2061 6e64 2066 6169  to check and fai
-00023db0: 6c20 6561 726c 7920 6f6e 2075 6e6b 6e6f  l early on unkno
-00023dc0: 776e 2063 6861 7261 6374 6572 732e 0a0a  wn characters...
-00023dd0: 2020 2020 3a70 6172 616d 206c 6f63 616c      :param local
-00023de0: 5f70 6174 683a 2050 6174 6820 746f 2063  _path: Path to c
-00023df0: 6865 636b 2e0a 2020 2020 3a72 6169 7365  heck..    :raise
-00023e00: 7320 5061 7468 4572 726f 723a 2069 6620  s PathError: if 
-00023e10: 7468 6520 7061 7468 2063 6f6e 7461 696e  the path contain
-00023e20: 7320 6368 6172 6163 7465 7273 2077 6974  s characters wit
-00023e30: 6820 616e 2075 6e6b 6e6f 776e 2065 6e63  h an unknown enc
-00023e40: 6f64 696e 672e 0a20 2020 2022 2222 0a20  oding..    """. 
-00023e50: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
-00023e60: 6c6f 6361 6c5f 7061 7468 2e65 6e63 6f64  local_path.encod
-00023e70: 6528 290a 2020 2020 6578 6365 7074 2055  e().    except U
-00023e80: 6e69 636f 6465 456e 636f 6465 4572 726f  nicodeEncodeErro
-00023e90: 723a 0a20 2020 2020 2020 2066 735f 656e  r:.        fs_en
-00023ea0: 636f 6469 6e67 203d 2073 7973 2e67 6574  coding = sys.get
-00023eb0: 6669 6c65 7379 7374 656d 656e 636f 6469  filesystemencodi
-00023ec0: 6e67 2829 0a20 2020 2020 2020 2065 7272  ng().        err
-00023ed0: 6f72 203d 2050 6174 6845 7272 6f72 280a  or = PathError(.
-00023ee0: 2020 2020 2020 2020 2020 2020 2243 6f75              "Cou
-00023ef0: 6c64 206e 6f74 2075 706c 6f61 6420 6974  ld not upload it
-00023f00: 656d 222c 0a20 2020 2020 2020 2020 2020  em",.           
-00023f10: 2066 2254 6865 2066 696c 6520 6e61 6d65   f"The file name
-00023f20: 2063 6f6e 7461 696e 7320 6368 6172 6163   contains charac
-00023f30: 7465 7273 206f 7574 7369 6465 2074 6865  ters outside the
-00023f40: 2022 0a20 2020 2020 2020 2020 2020 2066   ".            f
-00023f50: 227b 6673 5f65 6e63 6f64 696e 677d 2065  "{fs_encoding} e
-00023f60: 6e63 6f64 696e 6720 6f66 2079 6f75 7220  ncoding of your 
-00023f70: 6669 6c65 2073 7973 7465 6d22 2c0a 2020  file system",.  
-00023f80: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-00023f90: 6572 726f 722e 6c6f 6361 6c5f 7061 7468  error.local_path
-00023fa0: 203d 206c 6f63 616c 5f70 6174 680a 2020   = local_path.  
-00023fb0: 2020 2020 2020 7261 6973 6520 6572 726f        raise erro
-00023fc0: 720a 0a0a 6465 6620 6368 6563 6b5f 6368  r...def check_ch
-00023fd0: 616e 6765 5f74 7970 6528 6576 656e 743a  ange_type(event:
-00023fe0: 2053 796e 6345 7665 6e74 2c20 616c 6c6f   SyncEvent, allo
-00023ff0: 7765 645f 6368 616e 6765 5f74 7970 6573  wed_change_types
-00024000: 3a20 7365 745b 4368 616e 6765 5479 7065  : set[ChangeType
-00024010: 5d29 202d 3e20 4e6f 6e65 3a0a 2020 2020  ]) -> None:.    
-00024020: 2222 220a 2020 2020 4368 6563 6b20 6966  """.    Check if
-00024030: 2074 6865 2073 796e 6320 6576 656e 7420   the sync event 
-00024040: 6861 7320 6f6e 6520 6f66 2070 6173 7365  has one of passe
-00024050: 6420 616c 6c6f 7765 645f 6368 616e 6765  d allowed_change
-00024060: 5f74 7970 6573 2e0a 0a20 2020 203a 7061  _types...    :pa
-00024070: 7261 6d20 6576 656e 743a 2053 796e 6345  ram event: SyncE
-00024080: 7665 6e74 2074 6f20 6368 6563 6b2e 0a20  vent to check.. 
-00024090: 2020 203a 7061 7261 6d20 616c 6c6f 7765     :param allowe
-000240a0: 645f 6368 616e 6765 5f74 7970 6573 3a20  d_change_types: 
-000240b0: 5365 7420 6f66 2061 6c6c 6f77 6564 2063  Set of allowed c
-000240c0: 6861 6e67 6520 7479 7065 732e 0a20 2020  hange types..   
-000240d0: 203a 7261 6973 6573 2056 616c 7565 4572   :raises ValueEr
-000240e0: 726f 723a 2049 6620 7468 6520 6368 616e  ror: If the chan
-000240f0: 6765 2074 7970 6520 6973 206e 6f74 2069  ge type is not i
-00024100: 6e20 7468 6520 616c 6c6f 7720 6c69 7374  n the allow list
-00024110: 2e0a 2020 2020 2222 220a 2020 2020 6966  ..    """.    if
-00024120: 2065 7665 6e74 2e63 6861 6e67 655f 7479   event.change_ty
-00024130: 7065 206e 6f74 2069 6e20 616c 6c6f 7765  pe not in allowe
-00024140: 645f 6368 616e 6765 5f74 7970 6573 3a0a  d_change_types:.
-00024150: 2020 2020 2020 2020 7261 6973 6520 5661          raise Va
-00024160: 6c75 6545 7272 6f72 280a 2020 2020 2020  lueError(.      
-00024170: 2020 2020 2020 6622 5265 7175 6972 6520        f"Require 
-00024180: 6368 616e 6765 5f74 7970 6520 696e 207b  change_type in {
-00024190: 616c 6c6f 7765 645f 6368 616e 6765 5f74  allowed_change_t
-000241a0: 7970 6573 7d20 6275 7420 220a 2020 2020  ypes} but ".    
-000241b0: 2020 2020 2020 2020 6622 666f 756e 6420          f"found 
-000241c0: 7b65 7665 6e74 2e63 6861 6e67 655f 7479  {event.change_ty
-000241d0: 7065 7d22 0a20 2020 2020 2020 2029 0a    pe}".        ).
+0001fe90: 7365 6c66 2e5f 6c6f 6767 6572 2e64 6562  self._logger.deb
+0001fea0: 7567 280a 2020 2020 2020 2020 2020 2020  ug(.            
+0001feb0: 2020 2020 2020 2020 6622 5061 7265 6e74          f"Parent
+0001fec0: 2066 6f6c 6465 7220 7b64 6278 5f70 6174   folder {dbx_pat
+0001fed0: 685f 6c6f 7765 725f 6469 726e 616d 657d  h_lower_dirname}
+0001fee0: 2069 7320 6e6f 7420 696e 2069 6e64 6578   is not in index
+0001fef0: 2e20 220a 2020 2020 2020 2020 2020 2020  . ".            
+0001ff00: 2020 2020 2020 2020 6622 5379 6e63 696e          f"Syncin
+0001ff10: 6720 6974 206e 6f77 2062 6566 6f72 6520  g it now before 
+0001ff20: 7379 6e63 696e 6720 616e 7920 6368 696c  syncing any chil
+0001ff30: 6472 656e 2e22 0a20 2020 2020 2020 2020  dren.".         
+0001ff40: 2020 2020 2020 2029 0a0a 2020 2020 2020         )..      
+0001ff50: 2020 2020 2020 2020 2020 7061 7265 6e74            parent
+0001ff60: 5f6d 6420 3d20 7365 6c66 2e63 6c69 656e  _md = self.clien
+0001ff70: 742e 6765 745f 6d65 7461 6461 7461 2864  t.get_metadata(d
+0001ff80: 6278 5f70 6174 685f 6c6f 7765 725f 6469  bx_path_lower_di
+0001ff90: 726e 616d 6529 0a0a 2020 2020 2020 2020  rname)..        
+0001ffa0: 2020 2020 2020 2020 6966 2070 6172 656e          if paren
+0001ffb0: 745f 6d64 3a20 2023 2049 6620 7468 6520  t_md:  # If the 
+0001ffc0: 7061 7265 6e74 206e 6f20 6c6f 6e67 6572  parent no longer
+0001ffd0: 2065 7869 7374 732c 2077 6520 646f 6e27   exists, we don'
+0001ffe0: 7420 646f 2061 6e79 7468 696e 672e 0a20  t do anything.. 
+0001fff0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020000: 2020 2070 6172 656e 745f 6576 656e 7420     parent_event 
+00020010: 3d20 5379 6e63 4576 656e 742e 6672 6f6d  = SyncEvent.from
+00020020: 5f6d 6574 6164 6174 6128 7061 7265 6e74  _metadata(parent
+00020030: 5f6d 642c 2073 656c 6629 0a20 2020 2020  _md, self).     
+00020040: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00020050: 656c 662e 5f6f 6e5f 7265 6d6f 7465 5f66  elf._on_remote_f
+00020060: 6f6c 6465 7228 7061 7265 6e74 5f65 7665  older(parent_eve
+00020070: 6e74 290a 0a20 2020 2064 6566 205f 6c6f  nt)..    def _lo
+00020080: 6361 6c5f 6363 5f66 696c 656e 616d 6528  cal_cc_filename(
+00020090: 7365 6c66 2c20 6c6f 6361 6c5f 7061 7468  self, local_path
+000200a0: 3a20 7374 722c 2064 6269 643a 2073 7472  : str, dbid: str
+000200b0: 207c 204e 6f6e 6529 202d 3e20 7374 723a   | None) -> str:
+000200c0: 0a20 2020 2020 2020 2063 6861 6e67 655f  .        change_
+000200d0: 6f77 6e65 7220 3d20 7365 6c66 2e5f 6469  owner = self._di
+000200e0: 7370 6c61 795f 6e61 6d65 5f66 6f72 5f61  splay_name_for_a
+000200f0: 6363 6f75 6e74 2864 6269 6429 0a20 2020  ccount(dbid).   
+00020100: 2020 2020 2064 6174 6520 3d20 6461 7465       date = date
+00020110: 7469 6d65 2e6e 6f77 2829 2e73 7472 6674  time.now().strft
+00020120: 696d 6528 2225 592d 256d 2d25 6422 290a  ime("%Y-%m-%d").
+00020130: 2020 2020 2020 2020 6966 2063 6861 6e67          if chang
+00020140: 655f 6f77 6e65 723a 0a20 2020 2020 2020  e_owner:.       
+00020150: 2020 2020 2073 7566 6669 7820 3d20 6622       suffix = f"
+00020160: 7b63 6861 6e67 655f 6f77 6e65 727d 2773  {change_owner}'s
+00020170: 2063 6f6e 666c 6963 7465 6420 636f 7079   conflicted copy
+00020180: 207b 6461 7465 7d22 0a20 2020 2020 2020   {date}".       
+00020190: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+000201a0: 2020 2073 7566 6669 7820 3d20 6622 636f     suffix = f"co
+000201b0: 6e66 6c69 6374 6564 2063 6f70 7920 7b64  nflicted copy {d
+000201c0: 6174 657d 220a 2020 2020 2020 2020 7265  ate}".        re
+000201d0: 7475 726e 2067 656e 6572 6174 655f 6363  turn generate_cc
+000201e0: 5f6e 616d 6528 6c6f 6361 6c5f 7061 7468  _name(local_path
+000201f0: 2c20 7375 6666 6978 290a 0a20 2020 2064  , suffix)..    d
+00020200: 6566 205f 6f6e 5f72 656d 6f74 655f 6669  ef _on_remote_fi
+00020210: 6c65 2873 656c 662c 2065 7665 6e74 3a20  le(self, event: 
+00020220: 5379 6e63 4576 656e 7429 202d 3e20 5379  SyncEvent) -> Sy
+00020230: 6e63 5374 6174 7573 3a0a 2020 2020 2020  ncStatus:.      
+00020240: 2020 2222 220a 2020 2020 2020 2020 4170    """.        Ap
+00020250: 706c 6965 7320 6120 7265 6d6f 7465 2066  plies a remote f
+00020260: 696c 6520 6368 616e 6765 206f 7220 6372  ile change or cr
+00020270: 6561 7469 6f6e 206c 6f63 616c 6c79 2e0a  eation locally..
+00020280: 0a20 2020 2020 2020 203a 7061 7261 6d20  .        :param 
+00020290: 6576 656e 743a 2053 796e 6345 7665 6e74  event: SyncEvent
+000202a0: 2066 6f72 2066 696c 6520 646f 776e 6c6f   for file downlo
+000202b0: 6164 2e0a 2020 2020 2020 2020 3a72 6574  ad..        :ret
+000202c0: 7572 6e73 3a20 5379 6e63 4576 656e 7420  urns: SyncEvent 
+000202d0: 636f 7272 6573 706f 6e64 696e 6720 746f  corresponding to
+000202e0: 206c 6f63 616c 2069 7465 6d20 6f72 204e   local item or N
+000202f0: 6f6e 6520 6966 206e 6f20 6c6f 6361 6c20  one if no local 
+00020300: 6368 616e 6765 730a 2020 2020 2020 2020  changes.        
+00020310: 2020 2020 6172 6520 6d61 6465 2e0a 2020      are made..  
+00020320: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
+00020330: 2020 7365 6c66 2e5f 6170 706c 795f 6361    self._apply_ca
+00020340: 7365 5f63 6861 6e67 6528 6576 656e 7429  se_change(event)
+00020350: 0a0a 2020 2020 2020 2020 2320 5374 6f72  ..        # Stor
+00020360: 6520 7468 6520 6e65 7720 656e 7472 7920  e the new entry 
+00020370: 6174 2074 6865 2067 6976 656e 2070 6174  at the given pat
+00020380: 6820 696e 2079 6f75 7220 6c6f 6361 6c20  h in your local 
+00020390: 7374 6174 652e 2049 6620 7468 6520 7265  state. If the re
+000203a0: 7175 6972 6564 0a20 2020 2020 2020 2023  quired.        #
+000203b0: 2070 6172 656e 7420 666f 6c64 6572 7320   parent folders 
+000203c0: 646f 6ee2 8099 7420 6578 6973 7420 7965  don...t exist ye
+000203d0: 742c 2063 7265 6174 6520 7468 656d 2e20  t, create them. 
+000203e0: 4966 2074 6865 7265 e280 9973 2061 6c72  If there...s alr
+000203f0: 6561 6479 2073 6f6d 6574 6869 6e67 2065  eady something e
+00020400: 6c73 650a 2020 2020 2020 2020 2320 6174  lse.        # at
+00020410: 2074 6865 2067 6976 656e 2070 6174 682c   the given path,
+00020420: 2072 6570 6c61 6365 2069 7420 616e 6420   replace it and 
+00020430: 7265 6d6f 7665 2061 6c6c 2069 7473 2063  remove all its c
+00020440: 6869 6c64 7265 6e2e 0a0a 2020 2020 2020  hildren...      
+00020450: 2020 636f 6e66 6c69 6374 5f63 6865 636b    conflict_check
+00020460: 203d 2073 656c 662e 5f63 6865 636b 5f64   = self._check_d
+00020470: 6f77 6e6c 6f61 645f 636f 6e66 6c69 6374  ownload_conflict
+00020480: 2865 7665 6e74 290a 0a20 2020 2020 2020  (event)..       
+00020490: 2069 6620 636f 6e66 6c69 6374 5f63 6865   if conflict_che
+000204a0: 636b 2069 7320 436f 6e66 6c69 6374 2e49  ck is Conflict.I
+000204b0: 6465 6e74 6963 616c 3a0a 2020 2020 2020  dentical:.      
+000204c0: 2020 2020 2020 7365 6c66 2e75 7064 6174        self.updat
+000204d0: 655f 696e 6465 785f 6672 6f6d 5f73 796e  e_index_from_syn
+000204e0: 635f 6576 656e 7428 6576 656e 7429 0a20  c_event(event). 
+000204f0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+00020500: 6e20 5379 6e63 5374 6174 7573 2e53 6b69  n SyncStatus.Ski
+00020510: 7070 6564 0a20 2020 2020 2020 2065 6c69  pped.        eli
+00020520: 6620 636f 6e66 6c69 6374 5f63 6865 636b  f conflict_check
+00020530: 2069 7320 436f 6e66 6c69 6374 2e4c 6f63   is Conflict.Loc
+00020540: 616c 4e65 7765 724f 7249 6465 6e74 6963  alNewerOrIdentic
+00020550: 616c 3a0a 2020 2020 2020 2020 2020 2020  al:.            
+00020560: 7265 7475 726e 2053 796e 6353 7461 7475  return SyncStatu
+00020570: 732e 536b 6970 7065 640a 0a20 2020 2020  s.Skipped..     
+00020580: 2020 2023 2045 6e73 7572 6520 7468 6174     # Ensure that
+00020590: 2070 6172 656e 7420 666f 6c64 6572 7320   parent folders 
+000205a0: 6172 6520 7379 6e63 6564 2e0a 2020 2020  are synced..    
+000205b0: 2020 2020 7365 6c66 2e5f 656e 7375 7265      self._ensure
+000205c0: 5f70 6172 656e 7428 6576 656e 7429 0a0a  _parent(event)..
+000205d0: 2020 2020 2020 2020 6966 2065 7665 6e74          if event
+000205e0: 2e73 796d 6c69 6e6b 5f74 6172 6765 7420  .symlink_target 
+000205f0: 6973 206e 6f74 204e 6f6e 653a 0a20 2020  is not None:.   
+00020600: 2020 2020 2020 2020 2023 2044 6f6e 2774           # Don't
+00020610: 2064 6f77 6e6c 6f61 6420 6275 7420 7265   download but re
+00020620: 7072 6f64 7563 6520 7379 6d6c 696e 6b20  produce symlink 
+00020630: 6c6f 6361 6c6c 792e 0a20 2020 2020 2020  locally..       
+00020640: 2020 2020 2077 6974 6820 7365 6c66 2e66       with self.f
+00020650: 735f 6576 656e 7473 2e69 676e 6f72 6528  s_events.ignore(
+00020660: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00020670: 2046 696c 6543 7265 6174 6564 4576 656e   FileCreatedEven
+00020680: 7428 6576 656e 742e 6c6f 6361 6c5f 7061  t(event.local_pa
+00020690: 7468 292c 2072 6563 7572 7369 7665 3d46  th), recursive=F
+000206a0: 616c 7365 0a20 2020 2020 2020 2020 2020  alse.           
+000206b0: 2029 3a0a 2020 2020 2020 2020 2020 2020   ):.            
+000206c0: 2020 2020 7769 7468 2063 6f6e 7665 7274      with convert
+000206d0: 5f61 7069 5f65 7272 6f72 7328 6462 785f  _api_errors(dbx_
+000206e0: 7061 7468 3d65 7665 6e74 2e64 6278 5f70  path=event.dbx_p
+000206f0: 6174 6829 3a0a 2020 2020 2020 2020 2020  ath):.          
+00020700: 2020 2020 2020 2020 2020 6f73 2e73 796d            os.sym
+00020710: 6c69 6e6b 2865 7665 6e74 2e73 796d 6c69  link(event.symli
+00020720: 6e6b 5f74 6172 6765 742c 2065 7665 6e74  nk_target, event
+00020730: 2e6c 6f63 616c 5f70 6174 6829 0a20 2020  .local_path).   
+00020740: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020750: 2073 7461 7420 3d20 6f73 2e6c 7374 6174   stat = os.lstat
+00020760: 2865 7665 6e74 2e6c 6f63 616c 5f70 6174  (event.local_pat
+00020770: 6829 0a20 2020 2020 2020 2020 2020 2073  h).            s
+00020780: 7461 7475 7320 3d20 5379 6e63 5374 6174  tatus = SyncStat
+00020790: 7573 2e44 6f6e 650a 2020 2020 2020 2020  us.Done.        
+000207a0: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+000207b0: 2020 2320 5765 2064 6f77 6e6c 6f61 6420    # We download 
+000207c0: 746f 2061 2074 656d 706f 7261 7279 2066  to a temporary f
+000207d0: 696c 6520 6669 7273 7420 2874 6869 7320  ile first (this 
+000207e0: 6d61 7920 7461 6b65 2073 6f6d 6520 7469  may take some ti
+000207f0: 6d65 292e 0a20 2020 2020 2020 2020 2020  me)..           
+00020800: 2074 6d70 5f66 6e61 6d65 203d 2073 656c   tmp_fname = sel
+00020810: 662e 5f6e 6577 5f74 6d70 5f66 696c 6528  f._new_tmp_file(
+00020820: 290a 0a20 2020 2020 2020 2020 2020 2074  )..            t
+00020830: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
+00020840: 2020 2020 7769 7468 2073 656c 662e 5f70      with self._p
+00020850: 6172 616c 6c65 6c5f 646f 776e 5f73 656d  arallel_down_sem
+00020860: 6170 686f 7265 3a0a 2020 2020 2020 2020  aphore:.        
+00020870: 2020 2020 2020 2020 2020 2020 6d64 203d              md =
+00020880: 2073 656c 662e 636c 6965 6e74 2e64 6f77   self.client.dow
+00020890: 6e6c 6f61 6428 0a20 2020 2020 2020 2020  nload(.         
+000208a0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+000208b0: 2272 6576 3a7b 6576 656e 742e 7265 767d  "rev:{event.rev}
+000208c0: 222c 2074 6d70 5f66 6e61 6d65 2c20 7379  ", tmp_fname, sy
+000208d0: 6e63 5f65 7665 6e74 3d65 7665 6e74 0a20  nc_event=event. 
+000208e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000208f0: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
+00020900: 2020 2020 2065 7665 6e74 203d 2053 796e       event = Syn
+00020910: 6345 7665 6e74 2e66 726f 6d5f 6d65 7461  cEvent.from_meta
+00020920: 6461 7461 286d 642c 2073 656c 6629 0a20  data(md, self). 
+00020930: 2020 2020 2020 2020 2020 2065 7863 6570             excep
+00020940: 7420 5379 6e63 4572 726f 7220 6173 2065  t SyncError as e
+00020950: 7272 3a0a 2020 2020 2020 2020 2020 2020  rr:.            
+00020960: 2020 2020 2320 5265 706c 6163 6520 7265      # Replace re
+00020970: 7620 6e75 6d62 6572 2077 6974 6820 7061  v number with pa
+00020980: 7468 2e0a 2020 2020 2020 2020 2020 2020  th..            
+00020990: 2020 2020 6572 722e 6462 785f 7061 7468      err.dbx_path
+000209a0: 203d 2065 7665 6e74 2e64 6278 5f70 6174   = event.dbx_pat
+000209b0: 680a 2020 2020 2020 2020 2020 2020 2020  h.              
+000209c0: 2020 7261 6973 6520 6572 720a 0a20 2020    raise err..   
+000209d0: 2020 2020 2020 2020 2023 2052 652d 6368           # Re-ch
+000209e0: 6563 6b20 666f 7220 636f 6e66 6c69 6374  eck for conflict
+000209f0: 2061 6e64 206d 6f76 6520 7468 6520 636f   and move the co
+00020a00: 6e66 6c69 6374 0a20 2020 2020 2020 2020  nflict.         
+00020a10: 2020 2023 206f 7574 206f 6620 7468 6520     # out of the 
+00020a20: 7761 7920 6966 2061 6e79 7468 696e 6720  way if anything 
+00020a30: 6861 7320 6368 616e 6765 642e 0a20 2020  has changed..   
+00020a40: 2020 2020 2020 2020 2069 6620 7365 6c66           if self
+00020a50: 2e5f 6368 6563 6b5f 646f 776e 6c6f 6164  ._check_download
+00020a60: 5f63 6f6e 666c 6963 7428 6576 656e 7429  _conflict(event)
+00020a70: 203d 3d20 436f 6e66 6c69 6374 2e43 6f6e   == Conflict.Con
+00020a80: 666c 6963 743a 0a20 2020 2020 2020 2020  flict:.         
+00020a90: 2020 2020 2020 2063 635f 6c6f 6361 6c5f         cc_local_
+00020aa0: 7061 7468 203d 2073 656c 662e 5f6c 6f63  path = self._loc
+00020ab0: 616c 5f63 635f 6669 6c65 6e61 6d65 280a  al_cc_filename(.
+00020ac0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020ad0: 2020 2020 6576 656e 742e 6c6f 6361 6c5f      event.local_
+00020ae0: 7061 7468 2c20 6576 656e 742e 6368 616e  path, event.chan
+00020af0: 6765 5f64 6269 640a 2020 2020 2020 2020  ge_dbid.        
+00020b00: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+00020b10: 2020 2020 2020 2020 2020 6576 656e 745f            event_
+00020b20: 636c 7320 3d20 4469 724d 6f76 6564 4576  cls = DirMovedEv
+00020b30: 656e 7420 6966 2069 7364 6972 2865 7665  ent if isdir(eve
+00020b40: 6e74 2e6c 6f63 616c 5f70 6174 6829 2065  nt.local_path) e
+00020b50: 6c73 6520 4669 6c65 4d6f 7665 6445 7665  lse FileMovedEve
+00020b60: 6e74 0a20 2020 2020 2020 2020 2020 2020  nt.             
+00020b70: 2020 2077 6974 6820 7365 6c66 2e66 735f     with self.fs_
+00020b80: 6576 656e 7473 2e69 676e 6f72 6528 6576  events.ignore(ev
+00020b90: 656e 745f 636c 7328 6576 656e 742e 6c6f  ent_cls(event.lo
+00020ba0: 6361 6c5f 7061 7468 2c20 6363 5f6c 6f63  cal_path, cc_loc
+00020bb0: 616c 5f70 6174 6829 293a 0a20 2020 2020  al_path)):.     
+00020bc0: 2020 2020 2020 2020 2020 2020 2020 2077                 w
+00020bd0: 6974 6820 636f 6e76 6572 745f 6170 695f  ith convert_api_
+00020be0: 6572 726f 7273 2829 3a0a 2020 2020 2020  errors():.      
+00020bf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020c00: 2020 6d6f 7665 2865 7665 6e74 2e6c 6f63    move(event.loc
+00020c10: 616c 5f70 6174 682c 2063 635f 6c6f 6361  al_path, cc_loca
+00020c20: 6c5f 7061 7468 2c20 7261 6973 655f 6572  l_path, raise_er
+00020c30: 726f 723d 5472 7565 290a 0a20 2020 2020  ror=True)..     
+00020c40: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+00020c50: 5f6c 6f67 6765 722e 6465 6275 6728 0a20  _logger.debug(. 
+00020c60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020c70: 2020 2027 446f 776e 6c6f 6164 2063 6f6e     'Download con
+00020c80: 666c 6963 743a 2072 656e 616d 6564 2022  flict: renamed "
+00020c90: 2573 2220 746f 2022 2573 2227 2c0a 2020  %s" to "%s"',.  
+00020ca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020cb0: 2020 6576 656e 742e 6c6f 6361 6c5f 7061    event.local_pa
+00020cc0: 7468 2c0a 2020 2020 2020 2020 2020 2020  th,.            
+00020cd0: 2020 2020 2020 2020 6363 5f6c 6f63 616c          cc_local
+00020ce0: 5f70 6174 682c 0a20 2020 2020 2020 2020  _path,.         
+00020cf0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+00020d00: 2020 2020 2020 2020 2073 656c 662e 7265           self.re
+00020d10: 7363 616e 2863 635f 6c6f 6361 6c5f 7061  scan(cc_local_pa
+00020d20: 7468 290a 2020 2020 2020 2020 2020 2020  th).            
+00020d30: 2020 2020 7374 6174 7573 203d 2053 796e      status = Syn
+00020d40: 6353 7461 7475 732e 436f 6e66 6c69 6374  cStatus.Conflict
+00020d50: 0a20 2020 2020 2020 2020 2020 2065 6c73  .            els
+00020d60: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+00020d70: 2020 2073 7461 7475 7320 3d20 5379 6e63     status = Sync
+00020d80: 5374 6174 7573 2e44 6f6e 650a 0a20 2020  Status.Done..   
+00020d90: 2020 2020 2020 2020 2069 6620 6973 6469           if isdi
+00020da0: 7228 6576 656e 742e 6c6f 6361 6c5f 7061  r(event.local_pa
+00020db0: 7468 293a 0a20 2020 2020 2020 2020 2020  th):.           
+00020dc0: 2020 2020 2077 6974 6820 7365 6c66 2e66       with self.f
+00020dd0: 735f 6576 656e 7473 2e69 676e 6f72 6528  s_events.ignore(
+00020de0: 4469 7244 656c 6574 6564 4576 656e 7428  DirDeletedEvent(
+00020df0: 6576 656e 742e 6c6f 6361 6c5f 7061 7468  event.local_path
+00020e00: 2929 3a0a 2020 2020 2020 2020 2020 2020  )):.            
+00020e10: 2020 2020 2020 2020 6465 6c65 7465 280a          delete(.
+00020e20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020e30: 2020 2020 2020 2020 6576 656e 742e 6c6f          event.lo
+00020e40: 6361 6c5f 7061 7468 2c0a 2020 2020 2020  cal_path,.      
+00020e50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020e60: 2020 666f 7263 655f 6361 7365 5f73 656e    force_case_sen
+00020e70: 7369 7469 7665 3d6e 6f74 2073 656c 662e  sitive=not self.
+00020e80: 6973 5f66 735f 6361 7365 5f73 656e 7369  is_fs_case_sensi
+00020e90: 7469 7665 2c0a 2020 2020 2020 2020 2020  tive,.          
+00020ea0: 2020 2020 2020 2020 2020 290a 0a20 2020            )..   
+00020eb0: 2020 2020 2020 2020 2069 676e 6f72 655f           ignore_
+00020ec0: 6576 656e 7473 3a20 6c69 7374 5b46 696c  events: list[Fil
+00020ed0: 6553 7973 7465 6d45 7665 6e74 5d20 3d20  eSystemEvent] = 
+00020ee0: 5b0a 2020 2020 2020 2020 2020 2020 2020  [.              
+00020ef0: 2020 4669 6c65 4d6f 7665 6445 7665 6e74    FileMovedEvent
+00020f00: 2874 6d70 5f66 6e61 6d65 2c20 6576 656e  (tmp_fname, even
+00020f10: 742e 6c6f 6361 6c5f 7061 7468 290a 2020  t.local_path).  
+00020f20: 2020 2020 2020 2020 2020 5d0a 0a20 2020            ]..   
+00020f30: 2020 2020 2020 2020 2023 2050 7265 7365           # Prese
+00020f40: 7276 6520 7065 726d 6973 7369 6f6e 7320  rve permissions 
+00020f50: 6f66 2074 6865 2064 6573 7469 6e61 7469  of the destinati
+00020f60: 6f6e 2066 696c 6520 6966 2077 6520 6172  on file if we ar
+00020f70: 6520 6f6e 6c79 2073 796e 6369 6e67 2061  e only syncing a
+00020f80: 6e0a 2020 2020 2020 2020 2020 2020 2320  n.            # 
+00020f90: 7570 6461 7465 2074 6f20 7468 6520 6669  update to the fi
+00020fa0: 6c65 2063 6f6e 7465 6e74 2028 4472 6f70  le content (Drop
+00020fb0: 626f 7820 4944 206f 6620 7468 6520 6669  box ID of the fi
+00020fc0: 6c65 2072 656d 6169 6e73 2074 6865 2073  le remains the s
+00020fd0: 616d 6529 2e0a 2020 2020 2020 2020 2020  ame)..          
+00020fe0: 2020 6f6c 645f 656e 7472 7920 3d20 7365    old_entry = se
+00020ff0: 6c66 2e67 6574 5f69 6e64 6578 5f65 6e74  lf.get_index_ent
+00021000: 7279 2865 7665 6e74 2e64 6278 5f70 6174  ry(event.dbx_pat
+00021010: 685f 6c6f 7765 7229 0a20 2020 2020 2020  h_lower).       
+00021020: 2020 2020 2070 7265 7365 7276 655f 7065       preserve_pe
+00021030: 726d 6973 7369 6f6e 7320 3d20 626f 6f6c  rmissions = bool
+00021040: 286f 6c64 5f65 6e74 7279 2061 6e64 2065  (old_entry and e
+00021050: 7665 6e74 2e64 6278 5f69 6420 3d3d 206f  vent.dbx_id == o
+00021060: 6c64 5f65 6e74 7279 2e64 6278 5f69 6429  ld_entry.dbx_id)
+00021070: 0a0a 2020 2020 2020 2020 2020 2020 6966  ..            if
+00021080: 2070 7265 7365 7276 655f 7065 726d 6973   preserve_permis
+00021090: 7369 6f6e 733a 0a20 2020 2020 2020 2020  sions:.         
+000210a0: 2020 2020 2020 2023 2049 676e 6f72 6520         # Ignore 
+000210b0: 4669 6c65 4d6f 6469 6669 6564 4576 656e  FileModifiedEven
+000210c0: 7420 7768 656e 2063 6861 6e67 696e 6720  t when changing 
+000210d0: 7065 726d 6973 7369 6f6e 732e 0a20 2020  permissions..   
+000210e0: 2020 2020 2020 2020 2020 2020 2023 204e               # N
+000210f0: 6f74 6520 7468 6174 2074 776f 2046 696c  ote that two Fil
+00021100: 654d 6f64 6966 6965 6445 7665 6e74 7320  eModifiedEvents 
+00021110: 6d61 7920 6265 2065 6d69 7474 6564 206f  may be emitted o
+00021120: 6e20 6d61 634f 532e 0a20 2020 2020 2020  n macOS..       
+00021130: 2020 2020 2020 2020 2069 676e 6f72 655f           ignore_
+00021140: 6576 656e 7473 2e61 7070 656e 6428 4669  events.append(Fi
+00021150: 6c65 4d6f 6469 6669 6564 4576 656e 7428  leModifiedEvent(
+00021160: 6576 656e 742e 6c6f 6361 6c5f 7061 7468  event.local_path
+00021170: 2929 0a20 2020 2020 2020 2020 2020 2020  )).             
+00021180: 2020 2069 6620 4953 5f4d 4143 4f53 3a0a     if IS_MACOS:.
+00021190: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000211a0: 2020 2020 6967 6e6f 7265 5f65 7665 6e74      ignore_event
+000211b0: 732e 6170 7065 6e64 2846 696c 654d 6f64  s.append(FileMod
+000211c0: 6966 6965 6445 7665 6e74 2865 7665 6e74  ifiedEvent(event
+000211d0: 2e6c 6f63 616c 5f70 6174 6829 290a 0a20  .local_path)).. 
+000211e0: 2020 2020 2020 2020 2020 2069 6620 6973             if is
+000211f0: 6669 6c65 2865 7665 6e74 2e6c 6f63 616c  file(event.local
+00021200: 5f70 6174 6829 3a0a 2020 2020 2020 2020  _path):.        
+00021210: 2020 2020 2020 2020 2320 4967 6e6f 7265          # Ignore
+00021220: 2046 696c 6544 656c 6574 6564 4576 656e   FileDeletedEven
+00021230: 7420 7768 656e 2072 6570 6c61 6369 6e67  t when replacing
+00021240: 206f 6c64 2066 696c 652e 0a20 2020 2020   old file..     
+00021250: 2020 2020 2020 2020 2020 2069 676e 6f72             ignor
+00021260: 655f 6576 656e 7473 2e61 7070 656e 6428  e_events.append(
+00021270: 4669 6c65 4465 6c65 7465 6445 7665 6e74  FileDeletedEvent
+00021280: 2865 7665 6e74 2e6c 6f63 616c 5f70 6174  (event.local_pat
+00021290: 6829 290a 0a20 2020 2020 2020 2020 2020  h))..           
+000212a0: 2023 204d 6f76 6520 7468 6520 646f 776e   # Move the down
+000212b0: 6c6f 6164 6564 2066 696c 6520 746f 2069  loaded file to i
+000212c0: 7473 2064 6573 7469 6e61 7469 6f6e 2e0a  ts destination..
+000212d0: 2020 2020 2020 2020 2020 2020 7769 7468              with
+000212e0: 2073 656c 662e 6673 5f65 7665 6e74 732e   self.fs_events.
+000212f0: 6967 6e6f 7265 282a 6967 6e6f 7265 5f65  ignore(*ignore_e
+00021300: 7665 6e74 732c 2072 6563 7572 7369 7665  vents, recursive
+00021310: 3d46 616c 7365 293a 0a20 2020 2020 2020  =False):.       
+00021320: 2020 2020 2020 2020 2077 6974 6820 636f           with co
+00021330: 6e76 6572 745f 6170 695f 6572 726f 7273  nvert_api_errors
+00021340: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00021350: 2020 2020 2020 6462 785f 7061 7468 3d65        dbx_path=e
+00021360: 7665 6e74 2e64 6278 5f70 6174 682c 206c  vent.dbx_path, l
+00021370: 6f63 616c 5f70 6174 683d 6576 656e 742e  ocal_path=event.
+00021380: 6c6f 6361 6c5f 7061 7468 0a20 2020 2020  local_path.     
+00021390: 2020 2020 2020 2020 2020 2029 3a0a 2020             ):.  
+000213a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000213b0: 2020 7374 6174 203d 206f 732e 6c73 7461    stat = os.lsta
+000213c0: 7428 746d 705f 666e 616d 6529 0a20 2020  t(tmp_fname).   
+000213d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000213e0: 206d 6f76 6528 0a20 2020 2020 2020 2020   move(.         
+000213f0: 2020 2020 2020 2020 2020 2020 2020 2074                 t
+00021400: 6d70 5f66 6e61 6d65 2c0a 2020 2020 2020  mp_fname,.      
+00021410: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021420: 2020 6576 656e 742e 6c6f 6361 6c5f 7061    event.local_pa
+00021430: 7468 2c0a 2020 2020 2020 2020 2020 2020  th,.            
+00021440: 2020 2020 2020 2020 2020 2020 7072 6573              pres
+00021450: 6572 7665 5f64 6573 745f 7065 726d 6973  erve_dest_permis
+00021460: 7369 6f6e 733d 7072 6573 6572 7665 5f70  sions=preserve_p
+00021470: 6572 6d69 7373 696f 6e73 2c0a 2020 2020  ermissions,.    
+00021480: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021490: 2020 2020 7261 6973 655f 6572 726f 723d      raise_error=
+000214a0: 5472 7565 2c0a 2020 2020 2020 2020 2020  True,.          
+000214b0: 2020 2020 2020 2020 2020 290a 0a20 2020            )..   
+000214c0: 2020 2020 2073 656c 662e 7570 6461 7465       self.update
+000214d0: 5f69 6e64 6578 5f66 726f 6d5f 7379 6e63  _index_from_sync
+000214e0: 5f65 7665 6e74 2865 7665 6e74 290a 2020  _event(event).  
+000214f0: 2020 2020 2020 7365 6c66 2e5f 7361 7665        self._save
+00021500: 5f6c 6f63 616c 5f68 6173 6828 0a20 2020  _local_hash(.   
+00021510: 2020 2020 2020 2020 2073 7461 742e 7374           stat.st
+00021520: 5f69 6e6f 2c20 6576 656e 742e 6c6f 6361  _ino, event.loca
+00021530: 6c5f 7061 7468 2c20 6576 656e 742e 636f  l_path, event.co
+00021540: 6e74 656e 745f 6861 7368 2c20 7374 6174  ntent_hash, stat
+00021550: 2e73 745f 6d74 696d 650a 2020 2020 2020  .st_mtime.      
+00021560: 2020 290a 0a20 2020 2020 2020 2073 656c    )..        sel
+00021570: 662e 5f6c 6f67 6765 722e 6465 6275 6728  f._logger.debug(
+00021580: 2743 7265 6174 6564 206c 6f63 616c 2066  'Created local f
+00021590: 696c 6520 2225 7322 272c 2065 7665 6e74  ile "%s"', event
+000215a0: 2e64 6278 5f70 6174 6829 0a0a 2020 2020  .dbx_path)..    
+000215b0: 2020 2020 7265 7475 726e 2073 7461 7475      return statu
+000215c0: 730a 0a20 2020 2064 6566 205f 6f6e 5f72  s..    def _on_r
+000215d0: 656d 6f74 655f 666f 6c64 6572 2873 656c  emote_folder(sel
+000215e0: 662c 2065 7665 6e74 3a20 5379 6e63 4576  f, event: SyncEv
+000215f0: 656e 7429 202d 3e20 5379 6e63 5374 6174  ent) -> SyncStat
+00021600: 7573 3a0a 2020 2020 2020 2020 2222 220a  us:.        """.
+00021610: 2020 2020 2020 2020 4170 706c 6965 7320          Applies 
+00021620: 6120 7265 6d6f 7465 2066 6f6c 6465 7220  a remote folder 
+00021630: 6372 6561 7469 6f6e 206c 6f63 616c 6c79  creation locally
+00021640: 2e0a 0a20 2020 2020 2020 203a 7061 7261  ...        :para
+00021650: 6d20 6576 656e 743a 2053 796e 6345 7665  m event: SyncEve
+00021660: 6e74 2066 6f72 2066 6f6c 6465 7220 646f  nt for folder do
+00021670: 776e 6c6f 6164 2e0a 2020 2020 2020 2020  wnload..        
+00021680: 3a72 6574 7572 6e73 3a20 5379 6e63 4576  :returns: SyncEv
+00021690: 656e 7420 636f 7272 6573 706f 6e64 696e  ent correspondin
+000216a0: 6720 746f 206c 6f63 616c 2069 7465 6d20  g to local item 
+000216b0: 6f72 204e 6f6e 6520 6966 206e 6f20 6c6f  or None if no lo
+000216c0: 6361 6c20 6368 616e 6765 730a 2020 2020  cal changes.    
+000216d0: 2020 2020 2020 2020 6172 6520 6d61 6465          are made
+000216e0: 2e0a 2020 2020 2020 2020 2222 220a 2020  ..        """.  
+000216f0: 2020 2020 2020 7365 6c66 2e5f 6170 706c        self._appl
+00021700: 795f 6361 7365 5f63 6861 6e67 6528 6576  y_case_change(ev
+00021710: 656e 7429 0a0a 2020 2020 2020 2020 2320  ent)..        # 
+00021720: 5374 6f72 6520 7468 6520 6e65 7720 656e  Store the new en
+00021730: 7472 7920 6174 2074 6865 2067 6976 656e  try at the given
+00021740: 2070 6174 6820 696e 2079 6f75 7220 6c6f   path in your lo
+00021750: 6361 6c20 7374 6174 652e 2049 6620 7468  cal state. If th
+00021760: 6520 7265 7175 6972 6564 0a20 2020 2020  e required.     
+00021770: 2020 2023 2070 6172 656e 7420 666f 6c64     # parent fold
+00021780: 6572 7320 646f 6ee2 8099 7420 6578 6973  ers don...t exis
+00021790: 7420 7965 742c 2063 7265 6174 6520 7468  t yet, create th
+000217a0: 656d 2e20 4966 2074 6865 7265 e280 9973  em. If there...s
+000217b0: 2061 6c72 6561 6479 2073 6f6d 6574 6869   already somethi
+000217c0: 6e67 2065 6c73 650a 2020 2020 2020 2020  ng else.        
+000217d0: 2320 6174 2074 6865 2067 6976 656e 2070  # at the given p
+000217e0: 6174 682c 2072 6570 6c61 6365 2069 7420  ath, replace it 
+000217f0: 6275 7420 6c65 6176 6520 7468 6520 6368  but leave the ch
+00021800: 696c 6472 656e 2061 7320 7468 6579 2061  ildren as they a
+00021810: 7265 2e0a 0a20 2020 2020 2020 2063 6f6e  re...        con
+00021820: 666c 6963 745f 6368 6563 6b20 3d20 7365  flict_check = se
+00021830: 6c66 2e5f 6368 6563 6b5f 646f 776e 6c6f  lf._check_downlo
+00021840: 6164 5f63 6f6e 666c 6963 7428 6576 656e  ad_conflict(even
+00021850: 7429 0a0a 2020 2020 2020 2020 6966 2063  t)..        if c
+00021860: 6f6e 666c 6963 745f 6368 6563 6b20 6973  onflict_check is
+00021870: 2043 6f6e 666c 6963 742e 4964 656e 7469   Conflict.Identi
+00021880: 6361 6c3a 0a20 2020 2020 2020 2020 2020  cal:.           
+00021890: 2073 656c 662e 7570 6461 7465 5f69 6e64   self.update_ind
+000218a0: 6578 5f66 726f 6d5f 7379 6e63 5f65 7665  ex_from_sync_eve
+000218b0: 6e74 2865 7665 6e74 290a 2020 2020 2020  nt(event).      
+000218c0: 2020 2020 2020 7265 7475 726e 2053 796e        return Syn
+000218d0: 6353 7461 7475 732e 536b 6970 7065 640a  cStatus.Skipped.
+000218e0: 2020 2020 2020 2020 656c 6966 2063 6f6e          elif con
+000218f0: 666c 6963 745f 6368 6563 6b20 6973 2043  flict_check is C
+00021900: 6f6e 666c 6963 742e 4c6f 6361 6c4e 6577  onflict.LocalNew
+00021910: 6572 4f72 4964 656e 7469 6361 6c3a 0a20  erOrIdentical:. 
+00021920: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+00021930: 6e20 5379 6e63 5374 6174 7573 2e53 6b69  n SyncStatus.Ski
+00021940: 7070 6564 0a0a 2020 2020 2020 2020 6966  pped..        if
+00021950: 2063 6f6e 666c 6963 745f 6368 6563 6b20   conflict_check 
+00021960: 3d3d 2043 6f6e 666c 6963 742e 436f 6e66  == Conflict.Conf
+00021970: 6c69 6374 3a0a 2020 2020 2020 2020 2020  lict:.          
+00021980: 2020 6363 5f6c 6f63 616c 5f70 6174 6820    cc_local_path 
+00021990: 3d20 7365 6c66 2e5f 6c6f 6361 6c5f 6363  = self._local_cc
+000219a0: 5f66 696c 656e 616d 6528 6576 656e 742e  _filename(event.
+000219b0: 6c6f 6361 6c5f 7061 7468 2c20 6576 656e  local_path, even
+000219c0: 742e 6368 616e 6765 5f64 6269 6429 0a20  t.change_dbid). 
+000219d0: 2020 2020 2020 2020 2020 2065 7665 6e74             event
+000219e0: 5f63 6c73 203d 2044 6972 4d6f 7665 6445  _cls = DirMovedE
+000219f0: 7665 6e74 2069 6620 6973 6469 7228 6576  vent if isdir(ev
+00021a00: 656e 742e 6c6f 6361 6c5f 7061 7468 2920  ent.local_path) 
+00021a10: 656c 7365 2046 696c 654d 6f76 6564 4576  else FileMovedEv
+00021a20: 656e 740a 2020 2020 2020 2020 2020 2020  ent.            
+00021a30: 7769 7468 2073 656c 662e 6673 5f65 7665  with self.fs_eve
+00021a40: 6e74 732e 6967 6e6f 7265 2865 7665 6e74  nts.ignore(event
+00021a50: 5f63 6c73 2865 7665 6e74 2e6c 6f63 616c  _cls(event.local
+00021a60: 5f70 6174 682c 2063 635f 6c6f 6361 6c5f  _path, cc_local_
+00021a70: 7061 7468 2929 3a0a 2020 2020 2020 2020  path)):.        
+00021a80: 2020 2020 2020 2020 7769 7468 2063 6f6e          with con
+00021a90: 7665 7274 5f61 7069 5f65 7272 6f72 7328  vert_api_errors(
+00021aa0: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+00021ab0: 2020 2020 2020 206d 6f76 6528 6576 656e         move(even
+00021ac0: 742e 6c6f 6361 6c5f 7061 7468 2c20 6363  t.local_path, cc
+00021ad0: 5f6c 6f63 616c 5f70 6174 682c 2072 6169  _local_path, rai
+00021ae0: 7365 5f65 7272 6f72 3d54 7275 6529 0a0a  se_error=True)..
+00021af0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+00021b00: 2e5f 6c6f 6767 6572 2e64 6562 7567 280a  ._logger.debug(.
+00021b10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021b20: 2744 6f77 6e6c 6f61 6420 636f 6e66 6c69  'Download confli
+00021b30: 6374 3a20 7265 6e61 6d65 6420 2225 7322  ct: renamed "%s"
+00021b40: 2074 6f20 2225 7322 272c 0a20 2020 2020   to "%s"',.     
+00021b50: 2020 2020 2020 2020 2020 2065 7665 6e74             event
+00021b60: 2e6c 6f63 616c 5f70 6174 682c 0a20 2020  .local_path,.   
+00021b70: 2020 2020 2020 2020 2020 2020 2063 635f               cc_
+00021b80: 6c6f 6361 6c5f 7061 7468 2c0a 2020 2020  local_path,.    
+00021b90: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+00021ba0: 2020 2020 2020 7365 6c66 2e72 6573 6361        self.resca
+00021bb0: 6e28 6363 5f6c 6f63 616c 5f70 6174 6829  n(cc_local_path)
+00021bc0: 0a20 2020 2020 2020 2020 2020 2073 7461  .            sta
+00021bd0: 7475 7320 3d20 5379 6e63 5374 6174 7573  tus = SyncStatus
+00021be0: 2e43 6f6e 666c 6963 740a 2020 2020 2020  .Conflict.      
+00021bf0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+00021c00: 2020 2020 7374 6174 7573 203d 2053 796e      status = Syn
+00021c10: 6353 7461 7475 732e 446f 6e65 0a0a 2020  cStatus.Done..  
+00021c20: 2020 2020 2020 2320 456e 7375 7265 2074        # Ensure t
+00021c30: 6861 7420 7061 7265 6e74 2066 6f6c 6465  hat parent folde
+00021c40: 7273 2061 7265 2073 796e 6365 642e 0a20  rs are synced.. 
+00021c50: 2020 2020 2020 2073 656c 662e 5f65 6e73         self._ens
+00021c60: 7572 655f 7061 7265 6e74 2865 7665 6e74  ure_parent(event
+00021c70: 290a 0a20 2020 2020 2020 2069 6620 6973  )..        if is
+00021c80: 6669 6c65 2865 7665 6e74 2e6c 6f63 616c  file(event.local
+00021c90: 5f70 6174 6829 3a0a 2020 2020 2020 2020  _path):.        
+00021ca0: 2020 2020 7769 7468 2073 656c 662e 6673      with self.fs
+00021cb0: 5f65 7665 6e74 732e 6967 6e6f 7265 280a  _events.ignore(.
+00021cc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021cd0: 4669 6c65 4d6f 6469 6669 6564 4576 656e  FileModifiedEven
+00021ce0: 7428 6576 656e 742e 6c6f 6361 6c5f 7061  t(event.local_pa
+00021cf0: 7468 292c 2020 2320 4d61 7920 6265 2065  th),  # May be e
+00021d00: 6d69 7474 6564 206f 6e20 6d61 634f 532e  mitted on macOS.
+00021d10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00021d20: 2046 696c 6544 656c 6574 6564 4576 656e   FileDeletedEven
+00021d30: 7428 6576 656e 742e 6c6f 6361 6c5f 7061  t(event.local_pa
+00021d40: 7468 292c 0a20 2020 2020 2020 2020 2020  th),.           
+00021d50: 2029 3a0a 2020 2020 2020 2020 2020 2020   ):.            
+00021d60: 2020 2020 6465 6c65 7465 280a 2020 2020      delete(.    
+00021d70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021d80: 6576 656e 742e 6c6f 6361 6c5f 7061 7468  event.local_path
+00021d90: 2c20 666f 7263 655f 6361 7365 5f73 656e  , force_case_sen
+00021da0: 7369 7469 7665 3d6e 6f74 2073 656c 662e  sitive=not self.
+00021db0: 6973 5f66 735f 6361 7365 5f73 656e 7369  is_fs_case_sensi
+00021dc0: 7469 7665 0a20 2020 2020 2020 2020 2020  tive.           
+00021dd0: 2020 2020 2029 0a0a 2020 2020 2020 2020       )..        
+00021de0: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
+00021df0: 2077 6974 6820 7365 6c66 2e66 735f 6576   with self.fs_ev
+00021e00: 656e 7473 2e69 676e 6f72 6528 0a20 2020  ents.ignore(.   
+00021e10: 2020 2020 2020 2020 2020 2020 2044 6972               Dir
+00021e20: 4372 6561 7465 6445 7665 6e74 2865 7665  CreatedEvent(eve
+00021e30: 6e74 2e6c 6f63 616c 5f70 6174 6829 2c20  nt.local_path), 
+00021e40: 7265 6375 7273 6976 653d 4661 6c73 650a  recursive=False.
+00021e50: 2020 2020 2020 2020 2020 2020 293a 0a20              ):. 
+00021e60: 2020 2020 2020 2020 2020 2020 2020 206f                 o
+00021e70: 732e 6d6b 6469 7228 6576 656e 742e 6c6f  s.mkdir(event.lo
+00021e80: 6361 6c5f 7061 7468 290a 2020 2020 2020  cal_path).      
+00021e90: 2020 6578 6365 7074 2046 696c 6545 7869    except FileExi
+00021ea0: 7374 7345 7272 6f72 3a0a 2020 2020 2020  stsError:.      
+00021eb0: 2020 2020 2020 7374 6174 7573 203d 2053        status = S
+00021ec0: 796e 6353 7461 7475 732e 536b 6970 7065  yncStatus.Skippe
+00021ed0: 640a 2020 2020 2020 2020 6578 6365 7074  d.        except
+00021ee0: 204f 5345 7272 6f72 2061 7320 6572 723a   OSError as err:
+00021ef0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+00021f00: 662e 656e 7375 7265 5f64 726f 7062 6f78  f.ensure_dropbox
+00021f10: 5f66 6f6c 6465 725f 7072 6573 656e 7428  _folder_present(
+00021f20: 290a 2020 2020 2020 2020 2020 2020 7261  ).            ra
+00021f30: 6973 6520 6f73 5f74 6f5f 6d61 6573 7472  ise os_to_maestr
+00021f40: 616c 5f65 7272 6f72 2865 7272 2c20 6462  al_error(err, db
+00021f50: 785f 7061 7468 3d65 7665 6e74 2e64 6278  x_path=event.dbx
+00021f60: 5f70 6174 6829 0a0a 2020 2020 2020 2020  _path)..        
+00021f70: 7365 6c66 2e75 7064 6174 655f 696e 6465  self.update_inde
+00021f80: 785f 6672 6f6d 5f73 796e 635f 6576 656e  x_from_sync_even
+00021f90: 7428 6576 656e 7429 0a0a 2020 2020 2020  t(event)..      
+00021fa0: 2020 7365 6c66 2e5f 6c6f 6767 6572 2e64    self._logger.d
+00021fb0: 6562 7567 2827 4372 6561 7465 6420 6c6f  ebug('Created lo
+00021fc0: 6361 6c20 666f 6c64 6572 2022 2573 2227  cal folder "%s"'
+00021fd0: 2c20 6576 656e 742e 6462 785f 7061 7468  , event.dbx_path
+00021fe0: 290a 0a20 2020 2020 2020 2072 6574 7572  )..        retur
+00021ff0: 6e20 7374 6174 7573 0a0a 2020 2020 6465  n status..    de
+00022000: 6620 5f6f 6e5f 7265 6d6f 7465 5f64 656c  f _on_remote_del
+00022010: 6574 6564 2873 656c 662c 2065 7665 6e74  eted(self, event
+00022020: 3a20 5379 6e63 4576 656e 7429 202d 3e20  : SyncEvent) -> 
+00022030: 5379 6e63 5374 6174 7573 3a0a 2020 2020  SyncStatus:.    
+00022040: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
+00022050: 4170 706c 6965 7320 6120 7265 6d6f 7465  Applies a remote
+00022060: 2064 656c 6574 696f 6e20 6c6f 6361 6c6c   deletion locall
+00022070: 792e 0a0a 2020 2020 2020 2020 3a70 6172  y...        :par
+00022080: 616d 2065 7665 6e74 3a20 4472 6f70 626f  am event: Dropbo
+00022090: 7820 6465 6c65 7465 6420 6d65 7461 6461  x deleted metada
+000220a0: 7461 2e0a 2020 2020 2020 2020 3a72 6574  ta..        :ret
+000220b0: 7572 6e73 3a20 5379 6e63 4576 656e 7420  urns: SyncEvent 
+000220c0: 636f 7272 6573 706f 6e64 696e 6720 746f  corresponding to
+000220d0: 206c 6f63 616c 2064 656c 6574 696f 6e20   local deletion 
+000220e0: 6f72 204e 6f6e 6520 6966 206e 6f20 6c6f  or None if no lo
+000220f0: 6361 6c20 6368 616e 6765 730a 2020 2020  cal changes.    
+00022100: 2020 2020 2020 2020 6172 6520 6d61 6465          are made
+00022110: 2e0a 2020 2020 2020 2020 2222 220a 2020  ..        """.  
+00022120: 2020 2020 2020 7365 6c66 2e5f 6170 706c        self._appl
+00022130: 795f 6361 7365 5f63 6861 6e67 6528 6576  y_case_change(ev
+00022140: 656e 7429 0a0a 2020 2020 2020 2020 2320  ent)..        # 
+00022150: 4966 2079 6f75 7220 6c6f 6361 6c20 7374  If your local st
+00022160: 6174 6520 6861 7320 736f 6d65 7468 696e  ate has somethin
+00022170: 6720 6174 2074 6865 2067 6976 656e 2070  g at the given p
+00022180: 6174 682c 2072 656d 6f76 6520 6974 2061  ath, remove it a
+00022190: 6e64 2061 6c6c 2069 7473 0a20 2020 2020  nd all its.     
+000221a0: 2020 2023 2063 6869 6c64 7265 6e2e 2049     # children. I
+000221b0: 6620 7468 6572 65e2 8099 7320 6e6f 7468  f there...s noth
+000221c0: 696e 6720 6174 2074 6865 2067 6976 656e  ing at the given
+000221d0: 2070 6174 682c 2069 676e 6f72 6520 7468   path, ignore th
+000221e0: 6973 2065 6e74 7279 2e0a 0a20 2020 2020  is entry...     
+000221f0: 2020 2063 6f6e 666c 6963 745f 6368 6563     conflict_chec
+00022200: 6b20 3d20 7365 6c66 2e5f 6368 6563 6b5f  k = self._check_
+00022210: 646f 776e 6c6f 6164 5f63 6f6e 666c 6963  download_conflic
+00022220: 7428 6576 656e 7429 0a0a 2020 2020 2020  t(event)..      
+00022230: 2020 6966 2063 6f6e 666c 6963 745f 6368    if conflict_ch
+00022240: 6563 6b20 6973 2043 6f6e 666c 6963 742e  eck is Conflict.
+00022250: 4964 656e 7469 6361 6c3a 0a20 2020 2020  Identical:.     
+00022260: 2020 2020 2020 2073 656c 662e 7570 6461         self.upda
+00022270: 7465 5f69 6e64 6578 5f66 726f 6d5f 7379  te_index_from_sy
+00022280: 6e63 5f65 7665 6e74 2865 7665 6e74 290a  nc_event(event).
+00022290: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+000222a0: 726e 2053 796e 6353 7461 7475 732e 536b  rn SyncStatus.Sk
+000222b0: 6970 7065 640a 2020 2020 2020 2020 656c  ipped.        el
+000222c0: 6966 2063 6f6e 666c 6963 745f 6368 6563  if conflict_chec
+000222d0: 6b20 6973 2043 6f6e 666c 6963 742e 4c6f  k is Conflict.Lo
+000222e0: 6361 6c4e 6577 6572 4f72 4964 656e 7469  calNewerOrIdenti
+000222f0: 6361 6c3a 0a20 2020 2020 2020 2020 2020  cal:.           
+00022300: 2072 6574 7572 6e20 5379 6e63 5374 6174   return SyncStat
+00022310: 7573 2e53 6b69 7070 6564 0a0a 2020 2020  us.Skipped..    
+00022320: 2020 2020 6576 656e 745f 636c 7320 3d20      event_cls = 
+00022330: 4469 7244 656c 6574 6564 4576 656e 7420  DirDeletedEvent 
+00022340: 6966 2069 7364 6972 2865 7665 6e74 2e6c  if isdir(event.l
+00022350: 6f63 616c 5f70 6174 6829 2065 6c73 6520  ocal_path) else 
+00022360: 4669 6c65 4465 6c65 7465 6445 7665 6e74  FileDeletedEvent
+00022370: 0a20 2020 2020 2020 2077 6974 6820 7365  .        with se
+00022380: 6c66 2e66 735f 6576 656e 7473 2e69 676e  lf.fs_events.ign
+00022390: 6f72 6528 6576 656e 745f 636c 7328 6576  ore(event_cls(ev
+000223a0: 656e 742e 6c6f 6361 6c5f 7061 7468 2929  ent.local_path))
+000223b0: 3a0a 2020 2020 2020 2020 2020 2020 6578  :.            ex
+000223c0: 6320 3d20 6465 6c65 7465 280a 2020 2020  c = delete(.    
+000223d0: 2020 2020 2020 2020 2020 2020 6576 656e              even
+000223e0: 742e 6c6f 6361 6c5f 7061 7468 2c20 666f  t.local_path, fo
+000223f0: 7263 655f 6361 7365 5f73 656e 7369 7469  rce_case_sensiti
+00022400: 7665 3d6e 6f74 2073 656c 662e 6973 5f66  ve=not self.is_f
+00022410: 735f 6361 7365 5f73 656e 7369 7469 7665  s_case_sensitive
+00022420: 0a20 2020 2020 2020 2020 2020 2029 0a0a  .            )..
+00022430: 2020 2020 2020 2020 6966 206e 6f74 2065          if not e
+00022440: 7863 3a0a 2020 2020 2020 2020 2020 2020  xc:.            
+00022450: 7365 6c66 2e75 7064 6174 655f 696e 6465  self.update_inde
+00022460: 785f 6672 6f6d 5f73 796e 635f 6576 656e  x_from_sync_even
+00022470: 7428 6576 656e 7429 0a20 2020 2020 2020  t(event).       
+00022480: 2020 2020 2073 656c 662e 5f6c 6f67 6765       self._logge
+00022490: 722e 6465 6275 6728 2744 656c 6574 6564  r.debug('Deleted
+000224a0: 206c 6f63 616c 2069 7465 6d20 2225 7322   local item "%s"
+000224b0: 272c 2065 7665 6e74 2e6c 6f63 616c 5f70  ', event.local_p
+000224c0: 6174 6829 0a20 2020 2020 2020 2020 2020  ath).           
+000224d0: 2072 6574 7572 6e20 5379 6e63 5374 6174   return SyncStat
+000224e0: 7573 2e44 6f6e 650a 2020 2020 2020 2020  us.Done.        
+000224f0: 656c 6966 2069 7369 6e73 7461 6e63 6528  elif isinstance(
+00022500: 6578 632c 2028 4669 6c65 4e6f 7446 6f75  exc, (FileNotFou
+00022510: 6e64 4572 726f 722c 204e 6f74 4144 6972  ndError, NotADir
+00022520: 6563 746f 7279 4572 726f 7229 293a 0a20  ectoryError)):. 
+00022530: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+00022540: 7570 6461 7465 5f69 6e64 6578 5f66 726f  update_index_fro
+00022550: 6d5f 7379 6e63 5f65 7665 6e74 2865 7665  m_sync_event(eve
+00022560: 6e74 290a 2020 2020 2020 2020 2020 2020  nt).            
+00022570: 7365 6c66 2e5f 6c6f 6767 6572 2e64 6562  self._logger.deb
+00022580: 7567 2827 4465 6c65 7469 6f6e 2066 6169  ug('Deletion fai
+00022590: 6c65 643a 2022 2573 2220 6e6f 7420 666f  led: "%s" not fo
+000225a0: 756e 6427 2c20 6576 656e 742e 6462 785f  und', event.dbx_
+000225b0: 7061 7468 290a 2020 2020 2020 2020 2020  path).          
+000225c0: 2020 7265 7475 726e 2053 796e 6353 7461    return SyncSta
+000225d0: 7475 732e 536b 6970 7065 640a 2020 2020  tus.Skipped.    
+000225e0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+000225f0: 2020 2020 2020 7261 6973 6520 6f73 5f74        raise os_t
+00022600: 6f5f 6d61 6573 7472 616c 5f65 7272 6f72  o_maestral_error
+00022610: 2865 7863 2c20 6462 785f 7061 7468 3d65  (exc, dbx_path=e
+00022620: 7665 6e74 2e64 6278 5f70 6174 6829 0a0a  vent.dbx_path)..
+00022630: 2020 2020 6465 6620 5f61 7070 6c79 5f63      def _apply_c
+00022640: 6173 655f 6368 616e 6765 2873 656c 662c  ase_change(self,
+00022650: 2065 7665 6e74 3a20 5379 6e63 4576 656e   event: SyncEven
+00022660: 7429 202d 3e20 4e6f 6e65 3a0a 2020 2020  t) -> None:.    
+00022670: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
+00022680: 4170 706c 6965 7320 616e 7920 6368 616e  Applies any chan
+00022690: 6765 7320 696e 2063 6173 696e 6720 6f66  ges in casing of
+000226a0: 2074 6865 2072 656d 6f74 6520 6974 656d   the remote item
+000226b0: 206c 6f63 616c 6c79 2e20 5468 6973 2073   locally. This s
+000226c0: 686f 756c 6420 6265 2063 616c 6c65 640a  hould be called.
+000226d0: 2020 2020 2020 2020 6265 666f 7265 2061          before a
+000226e0: 6e79 2073 7973 7465 6d20 6361 6c6c 7320  ny system calls 
+000226f0: 7573 696e 6720 6060 6c6f 6361 6c5f 7061  using ``local_pa
+00022700: 7468 6060 2062 6563 6175 7365 2074 6865  th`` because the
+00022710: 2061 6374 7561 6c20 7061 7468 206f 6e20   actual path on 
+00022720: 7468 6520 6669 6c65 0a20 2020 2020 2020  the file.       
+00022730: 2073 7973 7465 6d20 6d61 7920 6861 7665   system may have
+00022740: 2061 2064 6966 6665 7265 6e74 2063 6173   a different cas
+00022750: 696e 6720 6f6e 2063 6173 652d 7365 6e73  ing on case-sens
+00022760: 6974 6976 6520 6669 6c65 2073 7973 7465  itive file syste
+00022770: 6d73 2e20 4f6e 2063 6173 652d 0a20 2020  ms. On case-.   
+00022780: 2020 2020 2069 6e73 656e 7369 7469 7665       insensitive
+00022790: 2066 696c 6520 7379 7374 656d 732c 2074   file systems, t
+000227a0: 6869 7320 6361 7573 6573 206f 6e6c 7920  his causes only 
+000227b0: 6120 636f 736d 6574 6963 2063 6861 6e67  a cosmetic chang
+000227c0: 652e 0a0a 2020 2020 2020 2020 3a70 6172  e...        :par
+000227d0: 616d 2065 7665 6e74 3a20 446f 776e 6c6f  am event: Downlo
+000227e0: 6164 2053 796e 6345 7665 6e74 2e0a 2020  ad SyncEvent..  
+000227f0: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
+00022800: 2020 7769 7468 2073 656c 662e 5f64 6174    with self._dat
+00022810: 6162 6173 655f 6163 6365 7373 2829 3a0a  abase_access():.
+00022820: 2020 2020 2020 2020 2020 2020 656e 7472              entr
+00022830: 7920 3d20 7365 6c66 2e67 6574 5f69 6e64  y = self.get_ind
+00022840: 6578 5f65 6e74 7279 2865 7665 6e74 2e64  ex_entry(event.d
+00022850: 6278 5f70 6174 685f 6c6f 7765 7229 0a0a  bx_path_lower)..
+00022860: 2020 2020 2020 2020 6966 2065 6e74 7279          if entry
+00022870: 2061 6e64 2065 6e74 7279 2e64 6278 5f70   and entry.dbx_p
+00022880: 6174 685f 6361 7365 6420 213d 2065 7665  ath_cased != eve
+00022890: 6e74 2e64 6278 5f70 6174 683a 0a20 2020  nt.dbx_path:.   
+000228a0: 2020 2020 2020 2020 206c 6f63 616c 5f70           local_p
+000228b0: 6174 685f 6f6c 6420 3d20 7365 6c66 2e74  ath_old = self.t
+000228c0: 6f5f 6c6f 6361 6c5f 7061 7468 5f66 726f  o_local_path_fro
+000228d0: 6d5f 6361 7365 6428 656e 7472 792e 6462  m_cased(entry.db
+000228e0: 785f 7061 7468 5f63 6173 6564 290a 0a20  x_path_cased).. 
+000228f0: 2020 2020 2020 2020 2020 2065 7665 6e74             event
+00022900: 5f63 6c73 203d 2044 6972 4d6f 7665 6445  _cls = DirMovedE
+00022910: 7665 6e74 2069 6620 6973 6469 7228 6c6f  vent if isdir(lo
+00022920: 6361 6c5f 7061 7468 5f6f 6c64 2920 656c  cal_path_old) el
+00022930: 7365 2046 696c 654d 6f76 6564 4576 656e  se FileMovedEven
+00022940: 740a 2020 2020 2020 2020 2020 2020 7769  t.            wi
+00022950: 7468 2073 656c 662e 6673 5f65 7665 6e74  th self.fs_event
+00022960: 732e 6967 6e6f 7265 2865 7665 6e74 5f63  s.ignore(event_c
+00022970: 6c73 286c 6f63 616c 5f70 6174 685f 6f6c  ls(local_path_ol
+00022980: 642c 2065 7665 6e74 2e6c 6f63 616c 5f70  d, event.local_p
+00022990: 6174 6829 293a 0a20 2020 2020 2020 2020  ath)):.         
+000229a0: 2020 2020 2020 206d 6f76 6528 6c6f 6361         move(loca
+000229b0: 6c5f 7061 7468 5f6f 6c64 2c20 6576 656e  l_path_old, even
+000229c0: 742e 6c6f 6361 6c5f 7061 7468 290a 0a20  t.local_path).. 
+000229d0: 2020 2020 2020 2020 2020 2077 6974 6820             with 
+000229e0: 7365 6c66 2e5f 6461 7461 6261 7365 5f61  self._database_a
+000229f0: 6363 6573 7328 293a 0a20 2020 2020 2020  ccess():.       
+00022a00: 2020 2020 2020 2020 2065 6e74 7279 2e64           entry.d
+00022a10: 6278 5f70 6174 685f 6361 7365 6420 3d20  bx_path_cased = 
+00022a20: 6576 656e 742e 6462 785f 7061 7468 0a20  event.dbx_path. 
+00022a30: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00022a40: 656c 662e 5f69 6e64 6578 5f74 6162 6c65  elf._index_table
+00022a50: 2e75 7064 6174 6528 656e 7472 7929 0a0a  .update(entry)..
+00022a60: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+00022a70: 2e5f 6c6f 6767 6572 2e64 6562 7567 2827  ._logger.debug('
+00022a80: 5265 6e61 6d65 6420 2225 7322 2074 6f20  Renamed "%s" to 
+00022a90: 2225 7322 272c 206c 6f63 616c 5f70 6174  "%s"', local_pat
+00022aa0: 685f 6f6c 642c 2065 7665 6e74 2e6c 6f63  h_old, event.loc
+00022ab0: 616c 5f70 6174 6829 0a0a 2020 2020 6465  al_path)..    de
+00022ac0: 6620 7265 7363 616e 2873 656c 662c 206c  f rescan(self, l
+00022ad0: 6f63 616c 5f70 6174 683a 2073 7472 2920  ocal_path: str) 
+00022ae0: 2d3e 204e 6f6e 653a 0a20 2020 2020 2020  -> None:.       
+00022af0: 2022 2222 0a20 2020 2020 2020 2046 6f72   """.        For
+00022b00: 6365 7320 6120 7265 7363 616e 206f 6620  ces a rescan of 
+00022b10: 6120 6c6f 6361 6c20 7061 7468 3a20 7363  a local path: sc
+00022b20: 6865 6475 6c65 7320 6372 6561 7465 6420  hedules created 
+00022b30: 6576 656e 7473 2066 6f72 2065 7665 7279  events for every
+00022b40: 2066 6f6c 6465 722c 0a20 2020 2020 2020   folder,.       
+00022b50: 206d 6f64 6966 6965 6420 6576 656e 7473   modified events
+00022b60: 2066 6f72 2065 7665 7279 2066 696c 6520   for every file 
+00022b70: 616e 6420 6465 6c65 7465 6420 6576 656e  and deleted even
+00022b80: 7473 2066 6f72 2065 7665 7279 2064 656c  ts for every del
+00022b90: 6574 6564 2069 7465 6d0a 2020 2020 2020  eted item.      
+00022ba0: 2020 2863 6f6d 7061 7265 6420 746f 206f    (compared to o
+00022bb0: 7572 2069 6e64 6578 292e 0a0a 2020 2020  ur index)...    
+00022bc0: 2020 2020 3a70 6172 616d 206c 6f63 616c      :param local
+00022bd0: 5f70 6174 683a 2050 6174 6820 746f 2072  _path: Path to r
+00022be0: 6573 6361 6e2e 0a20 2020 2020 2020 2022  escan..        "
+00022bf0: 2222 0a20 2020 2020 2020 2073 656c 662e  "".        self.
+00022c00: 5f6c 6f67 6765 722e 6465 6275 6728 2752  _logger.debug('R
+00022c10: 6573 6361 6e6e 696e 6720 2225 7322 272c  escanning "%s"',
+00022c20: 206c 6f63 616c 5f70 6174 6829 0a0a 2020   local_path)..  
+00022c30: 2020 2020 2020 6966 2069 7366 696c 6528        if isfile(
+00022c40: 6c6f 6361 6c5f 7061 7468 293a 0a20 2020  local_path):.   
+00022c50: 2020 2020 2020 2020 2073 656c 662e 6673           self.fs
+00022c60: 5f65 7665 6e74 732e 7175 6575 655f 6576  _events.queue_ev
+00022c70: 656e 7428 4669 6c65 4d6f 6469 6669 6564  ent(FileModified
+00022c80: 4576 656e 7428 6c6f 6361 6c5f 7061 7468  Event(local_path
+00022c90: 2929 0a0a 2020 2020 2020 2020 656c 6966  ))..        elif
+00022ca0: 2069 7364 6972 286c 6f63 616c 5f70 6174   isdir(local_pat
+00022cb0: 6829 3a0a 2020 2020 2020 2020 2020 2020  h):.            
+00022cc0: 7365 6c66 2e66 735f 6576 656e 7473 2e71  self.fs_events.q
+00022cd0: 7565 7565 5f65 7665 6e74 2844 6972 4372  ueue_event(DirCr
+00022ce0: 6561 7465 6445 7665 6e74 286c 6f63 616c  eatedEvent(local
+00022cf0: 5f70 6174 6829 290a 0a20 2020 2020 2020  _path))..       
+00022d00: 2020 2020 2023 2041 6464 2063 7265 6174       # Add creat
+00022d10: 6564 2061 6e64 206d 6f64 6966 6965 6420  ed and modified 
+00022d20: 6576 656e 7473 2066 6f72 2063 6869 6c64  events for child
+00022d30: 7265 6e20 6173 2061 7070 726f 7072 6961  ren as appropria
+00022d40: 7465 2e0a 0a20 2020 2020 2020 2020 2020  te...           
+00022d50: 2066 6f72 2070 6174 682c 2073 7461 7420   for path, stat 
+00022d60: 696e 2077 616c 6b28 6c6f 6361 6c5f 7061  in walk(local_pa
+00022d70: 7468 2c20 7365 6c66 2e5f 7363 616e 6469  th, self._scandi
+00022d80: 725f 7769 7468 5f69 676e 6f72 6529 3a0a  r_with_ignore):.
+00022d90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022da0: 6966 2053 5f49 5344 4952 2873 7461 742e  if S_ISDIR(stat.
+00022db0: 7374 5f6d 6f64 6529 3a0a 2020 2020 2020  st_mode):.      
+00022dc0: 2020 2020 2020 2020 2020 2020 2020 7365                se
+00022dd0: 6c66 2e66 735f 6576 656e 7473 2e71 7565  lf.fs_events.que
+00022de0: 7565 5f65 7665 6e74 2844 6972 4372 6561  ue_event(DirCrea
+00022df0: 7465 6445 7665 6e74 2870 6174 6829 290a  tedEvent(path)).
+00022e00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022e10: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+00022e20: 2020 2020 2020 2020 2020 7365 6c66 2e66            self.f
+00022e30: 735f 6576 656e 7473 2e71 7565 7565 5f65  s_events.queue_e
+00022e40: 7665 6e74 2846 696c 654d 6f64 6966 6965  vent(FileModifie
+00022e50: 6445 7665 6e74 2870 6174 6829 290a 0a20  dEvent(path)).. 
+00022e60: 2020 2020 2020 2020 2020 2023 2041 6464             # Add
+00022e70: 2064 656c 6574 6564 2065 7665 6e74 7320   deleted events 
+00022e80: 666f 7220 6368 696c 6472 656e 2e0a 0a20  for children... 
+00022e90: 2020 2020 2020 2020 2020 2064 6278 5f70             dbx_p
+00022ea0: 6174 685f 6c6f 7765 7220 3d20 7365 6c66  ath_lower = self
+00022eb0: 2e74 6f5f 6462 785f 7061 7468 5f6c 6f77  .to_dbx_path_low
+00022ec0: 6572 286c 6f63 616c 5f70 6174 6829 0a0a  er(local_path)..
+00022ed0: 2020 2020 2020 2020 2020 2020 7769 7468              with
+00022ee0: 2073 656c 662e 5f64 6174 6162 6173 655f   self._database_
+00022ef0: 6163 6365 7373 2829 3a0a 2020 2020 2020  access():.      
+00022f00: 2020 2020 2020 2020 2020 7175 6572 7920            query 
+00022f10: 3d20 5061 7468 5472 6565 5175 6572 7928  = PathTreeQuery(
+00022f20: 496e 6465 7845 6e74 7279 2e64 6278 5f70  IndexEntry.dbx_p
+00022f30: 6174 685f 6c6f 7765 722c 2064 6278 5f70  ath_lower, dbx_p
+00022f40: 6174 685f 6c6f 7765 7229 0a20 2020 2020  ath_lower).     
+00022f50: 2020 2020 2020 2020 2020 2065 6e74 7269             entri
+00022f60: 6573 203d 2073 656c 662e 5f69 6e64 6578  es = self._index
+00022f70: 5f74 6162 6c65 2e73 656c 6563 7428 7175  _table.select(qu
+00022f80: 6572 7929 0a0a 2020 2020 2020 2020 2020  ery)..          
+00022f90: 2020 666f 7220 656e 7472 7920 696e 2065    for entry in e
+00022fa0: 6e74 7269 6573 3a0a 2020 2020 2020 2020  ntries:.        
+00022fb0: 2020 2020 2020 2020 6368 696c 645f 7061          child_pa
+00022fc0: 7468 203d 2073 656c 662e 746f 5f6c 6f63  th = self.to_loc
+00022fd0: 616c 5f70 6174 685f 6672 6f6d 5f63 6173  al_path_from_cas
+00022fe0: 6564 2865 6e74 7279 2e64 6278 5f70 6174  ed(entry.dbx_pat
+00022ff0: 685f 6361 7365 6429 0a20 2020 2020 2020  h_cased).       
+00023000: 2020 2020 2020 2020 2069 6620 6e6f 7420           if not 
+00023010: 6578 6973 7473 2863 6869 6c64 5f70 6174  exists(child_pat
+00023020: 6829 3a0a 2020 2020 2020 2020 2020 2020  h):.            
+00023030: 2020 2020 2020 2020 6966 2065 6e74 7279          if entry
+00023040: 2e69 735f 6469 7265 6374 6f72 793a 0a20  .is_directory:. 
+00023050: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023060: 2020 2020 2020 2073 656c 662e 6673 5f65         self.fs_e
+00023070: 7665 6e74 732e 7175 6575 655f 6576 656e  vents.queue_even
+00023080: 7428 4469 7244 656c 6574 6564 4576 656e  t(DirDeletedEven
+00023090: 7428 6368 696c 645f 7061 7468 2929 0a20  t(child_path)). 
+000230a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000230b0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+000230c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000230d0: 2073 656c 662e 6673 5f65 7665 6e74 732e   self.fs_events.
+000230e0: 7175 6575 655f 6576 656e 7428 4669 6c65  queue_event(File
+000230f0: 4465 6c65 7465 6445 7665 6e74 2863 6869  DeletedEvent(chi
+00023100: 6c64 5f70 6174 6829 290a 0a20 2020 2020  ld_path))..     
+00023110: 2020 2065 6c69 6620 6e6f 7420 6578 6973     elif not exis
+00023120: 7473 286c 6f63 616c 5f70 6174 6829 3a0a  ts(local_path):.
+00023130: 2020 2020 2020 2020 2020 2020 6462 785f              dbx_
+00023140: 7061 7468 5f6c 6f77 6572 203d 2073 656c  path_lower = sel
+00023150: 662e 746f 5f64 6278 5f70 6174 685f 6c6f  f.to_dbx_path_lo
+00023160: 7765 7228 6c6f 6361 6c5f 7061 7468 290a  wer(local_path).
+00023170: 2020 2020 2020 2020 2020 2020 6c6f 6361              loca
+00023180: 6c5f 656e 7472 7920 3d20 7365 6c66 2e67  l_entry = self.g
+00023190: 6574 5f69 6e64 6578 5f65 6e74 7279 2864  et_index_entry(d
+000231a0: 6278 5f70 6174 685f 6c6f 7765 7229 0a0a  bx_path_lower)..
+000231b0: 2020 2020 2020 2020 2020 2020 6966 206c              if l
+000231c0: 6f63 616c 5f65 6e74 7279 3a0a 2020 2020  ocal_entry:.    
+000231d0: 2020 2020 2020 2020 2020 2020 6966 206c              if l
+000231e0: 6f63 616c 5f65 6e74 7279 2e69 735f 6469  ocal_entry.is_di
+000231f0: 7265 6374 6f72 793a 0a20 2020 2020 2020  rectory:.       
+00023200: 2020 2020 2020 2020 2020 2020 2073 656c               sel
+00023210: 662e 6673 5f65 7665 6e74 732e 7175 6575  f.fs_events.queu
+00023220: 655f 6576 656e 7428 4469 7244 656c 6574  e_event(DirDelet
+00023230: 6564 4576 656e 7428 6c6f 6361 6c5f 7061  edEvent(local_pa
+00023240: 7468 2929 0a20 2020 2020 2020 2020 2020  th)).           
+00023250: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+00023260: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00023270: 656c 662e 6673 5f65 7665 6e74 732e 7175  elf.fs_events.qu
+00023280: 6575 655f 6576 656e 7428 4669 6c65 4465  eue_event(FileDe
+00023290: 6c65 7465 6445 7665 6e74 286c 6f63 616c  letedEvent(local
+000232a0: 5f70 6174 6829 290a 0a20 2020 2064 6566  _path))..    def
+000232b0: 205f 636c 6561 6e5f 6869 7374 6f72 7928   _clean_history(
+000232c0: 7365 6c66 2920 2d3e 204e 6f6e 653a 0a20  self) -> None:. 
+000232d0: 2020 2020 2020 2022 2222 436f 6d6d 6974         """Commit
+000232e0: 7320 6e65 7720 6576 656e 7473 2061 6e64  s new events and
+000232f0: 2072 656d 6f76 6573 2061 6c6c 2065 7665   removes all eve
+00023300: 6e74 7320 6f6c 6465 7220 7468 616e 2060  nts older than `
+00023310: 605f 6b65 6570 5f68 6973 746f 7279 6060  `_keep_history``
+00023320: 2066 726f 6d0a 2020 2020 2020 2020 6869   from.        hi
+00023330: 7374 6f72 792e 2222 220a 2020 2020 2020  story.""".      
+00023340: 2020 7769 7468 2073 656c 662e 5f64 6174    with self._dat
+00023350: 6162 6173 655f 6163 6365 7373 2829 3a0a  abase_access():.
+00023360: 2020 2020 2020 2020 2020 2020 2320 4472              # Dr
+00023370: 6f70 2061 6c6c 2065 6e74 7269 6573 206f  op all entries o
+00023380: 6c64 6572 2074 6861 6e20 6b65 6570 5f68  lder than keep_h
+00023390: 6973 746f 7279 2e0a 2020 2020 2020 2020  istory..        
+000233a0: 2020 2020 6e6f 7720 3d20 7469 6d65 2e74      now = time.t
+000233b0: 696d 6528 290a 2020 2020 2020 2020 2020  ime().          
+000233c0: 2020 6b65 6570 5f68 6973 746f 7279 203d    keep_history =
+000233d0: 2073 656c 662e 5f63 6f6e 662e 6765 7428   self._conf.get(
+000233e0: 2273 796e 6322 2c20 226b 6565 705f 6869  "sync", "keep_hi
+000233f0: 7374 6f72 7922 290a 0a20 2020 2020 2020  story")..       
+00023400: 2020 2020 2073 656c 662e 5f64 622e 6578       self._db.ex
+00023410: 6563 7574 6528 0a20 2020 2020 2020 2020  ecute(.         
+00023420: 2020 2020 2020 2022 4445 4c45 5445 2046         "DELETE F
+00023430: 524f 4d20 6869 7374 6f72 7920 5748 4552  ROM history WHER
+00023440: 4520 4946 4e55 4c4c 2863 6861 6e67 655f  E IFNULL(change_
+00023450: 7469 6d65 2c20 7379 6e63 5f74 696d 6529  time, sync_time)
+00023460: 203c 203f 222c 0a20 2020 2020 2020 2020   < ?",.         
+00023470: 2020 2020 2020 206e 6f77 202d 206b 6565         now - kee
+00023480: 705f 6869 7374 6f72 792c 0a20 2020 2020  p_history,.     
+00023490: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+000234a0: 2020 2020 2073 656c 662e 5f68 6973 746f       self._histo
+000234b0: 7279 5f74 6162 6c65 2e63 6c65 6172 5f63  ry_table.clear_c
+000234c0: 6163 6865 2829 0a0a 2020 2020 6465 6620  ache()..    def 
+000234d0: 5f73 6361 6e64 6972 5f77 6974 685f 6967  _scandir_with_ig
+000234e0: 6e6f 7265 280a 2020 2020 2020 2020 7365  nore(.        se
+000234f0: 6c66 2c20 7061 7468 3a20 7374 7220 7c20  lf, path: str | 
+00023500: 6f73 2e50 6174 684c 696b 655b 7374 725d  os.PathLike[str]
+00023510: 0a20 2020 2029 202d 3e20 4974 6572 6174  .    ) -> Iterat
+00023520: 6f72 5b6f 732e 4469 7245 6e74 7279 5b73  or[os.DirEntry[s
+00023530: 7472 5d5d 3a0a 2020 2020 2020 2020 7769  tr]]:.        wi
+00023540: 7468 206f 732e 7363 616e 6469 7228 7061  th os.scandir(pa
+00023550: 7468 2920 6173 2069 743a 0a20 2020 2020  th) as it:.     
+00023560: 2020 2020 2020 2066 6f72 2065 6e74 7279         for entry
+00023570: 2069 6e20 6974 3a0a 2020 2020 2020 2020   in it:.        
+00023580: 2020 2020 2020 2020 6462 785f 7061 7468          dbx_path
+00023590: 203d 2073 656c 662e 746f 5f64 6278 5f70   = self.to_dbx_p
+000235a0: 6174 6828 656e 7472 792e 7061 7468 290a  ath(entry.path).
+000235b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000235c0: 6966 206e 6f74 2073 656c 662e 6973 5f65  if not self.is_e
+000235d0: 7863 6c75 6465 6428 656e 7472 792e 7061  xcluded(entry.pa
+000235e0: 7468 2920 616e 6420 6e6f 7420 7365 6c66  th) and not self
+000235f0: 2e5f 6973 5f6d 6967 6e6f 7265 5f70 6174  ._is_mignore_pat
+00023600: 6828 0a20 2020 2020 2020 2020 2020 2020  h(.             
+00023610: 2020 2020 2020 2064 6278 5f70 6174 682c         dbx_path,
+00023620: 2065 6e74 7279 2e69 735f 6469 7228 666f   entry.is_dir(fo
+00023630: 6c6c 6f77 5f73 796d 6c69 6e6b 733d 4661  llow_symlinks=Fa
+00023640: 6c73 6529 0a20 2020 2020 2020 2020 2020  lse).           
+00023650: 2020 2020 2029 3a0a 2020 2020 2020 2020       ):.        
+00023660: 2020 2020 2020 2020 2020 2020 7969 656c              yiel
+00023670: 6420 656e 7472 790a 0a0a 2320 3d3d 3d3d  d entry...# ====
+00023680: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00023690: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+000236a0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+000236b0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+000236c0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+000236d0: 3d3d 0a23 2048 656c 7065 7220 6675 6e63  ==.# Helper func
+000236e0: 7469 6f6e 730a 2320 3d3d 3d3d 3d3d 3d3d  tions.# ========
+000236f0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00023700: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00023710: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00023720: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00023730: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 0a0a  ==============..
+00023740: 0a64 6566 2064 6f5f 7061 7261 6c6c 656c  .def do_parallel
+00023750: 280a 2020 2020 6675 6e63 3a20 4361 6c6c  (.    func: Call
+00023760: 6162 6c65 5b50 2c20 545d 2c0a 2020 2020  able[P, T],.    
+00023770: 2a69 7465 7261 626c 653a 2043 6f6c 6c65  *iterable: Colle
+00023780: 6374 696f 6e5b 502e 6172 6773 5d2c 0a20  ction[P.args],. 
+00023790: 2020 2074 6872 6561 645f 6e61 6d65 5f70     thread_name_p
+000237a0: 7265 6669 783a 2073 7472 203d 2022 222c  refix: str = "",
+000237b0: 0a20 2020 206f 6e5f 7072 6f67 7265 7373  .    on_progress
+000237c0: 3a20 4361 6c6c 6162 6c65 5b5b 696e 742c  : Callable[[int,
+000237d0: 2069 6e74 5d2c 2041 6e79 5d20 7c20 4e6f   int], Any] | No
+000237e0: 6e65 203d 204e 6f6e 652c 0a29 202d 3e20  ne = None,.) -> 
+000237f0: 4974 6572 6162 6c65 5b54 5d3a 0a20 2020  Iterable[T]:.   
+00023800: 2022 2222 0a20 2020 2053 696d 696c 6172   """.    Similar
+00023810: 2074 6f20 6060 5468 7265 6164 506f 6f6c   to ``ThreadPool
+00023820: 4578 6563 7574 6f72 2e6d 6170 2829 6060  Executor.map()``
+00023830: 2062 7574 2079 6965 6c64 7320 7265 7375   but yields resu
+00023840: 6c74 7320 6173 2074 6865 7920 6265 636f  lts as they beco
+00023850: 6d65 2061 7661 696c 6162 6c65 2e0a 0a20  me available... 
+00023860: 2020 203a 7061 7261 6d20 6675 6e63 3a20     :param func: 
+00023870: 4170 706c 7920 7468 6973 2063 616c 6c61  Apply this calla
+00023880: 626c 6520 746f 2065 7665 7279 2069 7465  ble to every ite
+00023890: 6d20 6f66 2060 6069 7465 7261 626c 6560  m of ``iterable`
+000238a0: 602e 0a20 2020 203a 7061 7261 6d20 6974  `..    :param it
+000238b0: 6572 6162 6c65 3a20 4974 6572 6162 6c65  erable: Iterable
+000238c0: 2077 6974 6820 6172 6775 6d65 6e74 7320   with arguments 
+000238d0: 746f 2070 6173 7320 746f 2060 6066 756e  to pass to ``fun
+000238e0: 6360 602e 0a20 2020 203a 7061 7261 6d20  c``..    :param 
+000238f0: 7468 7265 6164 5f6e 616d 655f 7072 6566  thread_name_pref
+00023900: 6978 3a20 5573 6564 2066 6f72 2069 6e74  ix: Used for int
+00023910: 6572 6e61 6c20 5468 7265 6164 506f 6f6c  ernal ThreadPool
+00023920: 4578 6563 7574 6f72 2e0a 2020 2020 3a70  Executor..    :p
+00023930: 6172 616d 206f 6e5f 7072 6f67 7265 7373  aram on_progress
+00023940: 3a20 4361 6c6c 6261 636b 2077 6865 6e20  : Callback when 
+00023950: 6561 6368 2074 6173 6b20 6973 2063 6f6d  each task is com
+00023960: 706c 6574 6564 2e20 5461 6b65 7320 7468  pleted. Takes th
+00023970: 6520 6e75 6d62 6572 206f 660a 2020 2020  e number of.    
+00023980: 2020 2020 636f 6d70 6c65 7465 6420 6974      completed it
+00023990: 656d 7320 616e 6420 7468 6520 746f 7461  ems and the tota
+000239a0: 6c20 6e75 6d62 6572 206f 6620 6974 656d  l number of item
+000239b0: 7320 6173 2061 7267 756d 656e 7473 2e0a  s as arguments..
+000239c0: 2020 2020 2222 220a 2020 2020 7769 7468      """.    with
+000239d0: 2054 6872 6561 6450 6f6f 6c45 7865 6375   ThreadPoolExecu
+000239e0: 746f 7228 0a20 2020 2020 2020 206d 6178  tor(.        max
+000239f0: 5f77 6f72 6b65 7273 3d4e 554d 5f54 4852  _workers=NUM_THR
+00023a00: 4541 4453 2c20 7468 7265 6164 5f6e 616d  EADS, thread_nam
+00023a10: 655f 7072 6566 6978 3d74 6872 6561 645f  e_prefix=thread_
+00023a20: 6e61 6d65 5f70 7265 6669 780a 2020 2020  name_prefix.    
+00023a30: 2920 6173 2074 7065 3a0a 2020 2020 2020  ) as tpe:.      
+00023a40: 2020 6673 203d 205b 7470 652e 7375 626d    fs = [tpe.subm
+00023a50: 6974 2866 756e 632c 202a 6172 6773 2920  it(func, *args) 
+00023a60: 666f 7220 6172 6773 2069 6e20 7a69 7028  for args in zip(
+00023a70: 2a69 7465 7261 626c 6529 5d0a 0a20 2020  *iterable)]..   
+00023a80: 2020 2020 206e 5f64 6f6e 6520 3d20 300a       n_done = 0.
+00023a90: 2020 2020 2020 2020 666f 7220 6620 696e          for f in
+00023aa0: 2061 735f 636f 6d70 6c65 7465 6428 6673   as_completed(fs
+00023ab0: 293a 0a20 2020 2020 2020 2020 2020 206e  ):.            n
+00023ac0: 5f64 6f6e 6520 2b3d 2031 0a20 2020 2020  _done += 1.     
+00023ad0: 2020 2020 2020 2069 6620 6f6e 5f70 726f         if on_pro
+00023ae0: 6772 6573 733a 0a20 2020 2020 2020 2020  gress:.         
+00023af0: 2020 2020 2020 206f 6e5f 7072 6f67 7265         on_progre
+00023b00: 7373 286e 5f64 6f6e 652c 206c 656e 2869  ss(n_done, len(i
+00023b10: 7465 7261 626c 655b 305d 2929 0a20 2020  terable[0])).   
+00023b20: 2020 2020 2020 2020 2079 6965 6c64 2066           yield f
+00023b30: 2e72 6573 756c 7428 290a 0a0a 6465 6620  .result()...def 
+00023b40: 6973 5f6d 6f76 6564 2865 7665 6e74 3a20  is_moved(event: 
+00023b50: 4669 6c65 5379 7374 656d 4576 656e 7429  FileSystemEvent)
+00023b60: 202d 3e20 5479 7065 4775 6172 645b 4669   -> TypeGuard[Fi
+00023b70: 6c65 4d6f 7665 6445 7665 6e74 207c 2044  leMovedEvent | D
+00023b80: 6972 4d6f 7665 6445 7665 6e74 5d3a 0a20  irMovedEvent]:. 
+00023b90: 2020 2072 6574 7572 6e20 6576 656e 742e     return event.
+00023ba0: 6576 656e 745f 7479 7065 203d 3d20 4556  event_type == EV
+00023bb0: 454e 545f 5459 5045 5f4d 4f56 4544 0a0a  ENT_TYPE_MOVED..
+00023bc0: 0a64 6566 2069 735f 6465 6c65 7465 6428  .def is_deleted(
+00023bd0: 6576 656e 743a 2046 696c 6553 7973 7465  event: FileSyste
+00023be0: 6d45 7665 6e74 2920 2d3e 2054 7970 6547  mEvent) -> TypeG
+00023bf0: 7561 7264 5b46 696c 6544 656c 6574 6564  uard[FileDeleted
+00023c00: 4576 656e 7420 7c20 4469 7244 656c 6574  Event | DirDelet
+00023c10: 6564 4576 656e 745d 3a0a 2020 2020 7265  edEvent]:.    re
+00023c20: 7475 726e 2065 7665 6e74 2e65 7665 6e74  turn event.event
+00023c30: 5f74 7970 6520 3d3d 2045 5645 4e54 5f54  _type == EVENT_T
+00023c40: 5950 455f 4445 4c45 5445 440a 0a0a 6465  YPE_DELETED...de
+00023c50: 6620 6973 5f63 7265 6174 6564 2865 7665  f is_created(eve
+00023c60: 6e74 3a20 4669 6c65 5379 7374 656d 4576  nt: FileSystemEv
+00023c70: 656e 7429 202d 3e20 5479 7065 4775 6172  ent) -> TypeGuar
+00023c80: 645b 4669 6c65 4372 6561 7465 6445 7665  d[FileCreatedEve
+00023c90: 6e74 207c 2044 6972 4372 6561 7465 6445  nt | DirCreatedE
+00023ca0: 7665 6e74 5d3a 0a20 2020 2072 6574 7572  vent]:.    retur
+00023cb0: 6e20 6576 656e 742e 6576 656e 745f 7479  n event.event_ty
+00023cc0: 7065 203d 3d20 4556 454e 545f 5459 5045  pe == EVENT_TYPE
+00023cd0: 5f43 5245 4154 4544 0a0a 0a64 6566 2067  _CREATED...def g
+00023ce0: 6574 5f64 6573 745f 7061 7468 2865 7665  et_dest_path(eve
+00023cf0: 6e74 3a20 4669 6c65 5379 7374 656d 4576  nt: FileSystemEv
+00023d00: 656e 7429 202d 3e20 7374 723a 0a20 2020  ent) -> str:.   
+00023d10: 2022 2222 0a20 2020 2052 6574 7572 6e73   """.    Returns
+00023d20: 2074 6865 2064 6573 745f 7061 7468 206f   the dest_path o
+00023d30: 6620 6120 6669 6c65 2073 7973 7465 6d20  f a file system 
+00023d40: 6576 656e 7420 6966 2070 7265 7365 6e74  event if present
+00023d50: 2028 6d6f 7665 6420 6576 656e 7473 206f   (moved events o
+00023d60: 6e6c 7929 0a20 2020 206f 7468 6572 7769  nly).    otherwi
+00023d70: 7365 2072 6574 7572 6e73 2074 6865 2073  se returns the s
+00023d80: 7263 5f70 6174 6820 2877 6869 6368 2069  rc_path (which i
+00023d90: 7320 616c 736f 2074 6865 2022 6465 7374  s also the "dest
+00023da0: 696e 6174 696f 6e22 292e 0a0a 2020 2020  ination")...    
+00023db0: 3a70 6172 616d 2065 7665 6e74 3a20 5761  :param event: Wa
+00023dc0: 7463 6864 6f67 2066 696c 6520 7379 7374  tchdog file syst
+00023dd0: 656d 2065 7665 6e74 2e0a 2020 2020 3a72  em event..    :r
+00023de0: 6574 7572 6e73 3a20 4465 7374 696e 6174  eturns: Destinat
+00023df0: 696f 6e20 7061 7468 2066 6f72 206d 6f76  ion path for mov
+00023e00: 6564 2065 7665 6e74 2c20 736f 7572 6365  ed event, source
+00023e10: 2070 6174 6820 6f74 6865 7277 6973 652e   path otherwise.
+00023e20: 0a20 2020 2022 2222 0a20 2020 2069 6620  .    """.    if 
+00023e30: 6973 696e 7374 616e 6365 2865 7665 6e74  isinstance(event
+00023e40: 2c20 2846 696c 654d 6f76 6564 4576 656e  , (FileMovedEven
+00023e50: 742c 2044 6972 4d6f 7665 6445 7665 6e74  t, DirMovedEvent
+00023e60: 2929 3a0a 2020 2020 2020 2020 7265 7475  )):.        retu
+00023e70: 726e 2065 7665 6e74 2e64 6573 745f 7061  rn event.dest_pa
+00023e80: 7468 0a20 2020 2072 6574 7572 6e20 6576  th.    return ev
+00023e90: 656e 742e 7372 635f 7061 7468 0a0a 0a40  ent.src_path...@
+00023ea0: 6f76 6572 6c6f 6164 0a64 6566 2073 706c  overload.def spl
+00023eb0: 6974 5f6d 6f76 6564 5f65 7665 6e74 280a  it_moved_event(.
+00023ec0: 2020 2020 6576 656e 743a 2046 696c 654d      event: FileM
+00023ed0: 6f76 6564 4576 656e 742c 0a29 202d 3e20  ovedEvent,.) -> 
+00023ee0: 7475 706c 655b 4669 6c65 4465 6c65 7465  tuple[FileDelete
+00023ef0: 6445 7665 6e74 2c20 4669 6c65 4372 6561  dEvent, FileCrea
+00023f00: 7465 6445 7665 6e74 5d3a 0a20 2020 202e  tedEvent]:.    .
+00023f10: 2e2e 0a0a 0a40 6f76 6572 6c6f 6164 0a64  .....@overload.d
+00023f20: 6566 2073 706c 6974 5f6d 6f76 6564 5f65  ef split_moved_e
+00023f30: 7665 6e74 2865 7665 6e74 3a20 4469 724d  vent(event: DirM
+00023f40: 6f76 6564 4576 656e 7429 202d 3e20 7475  ovedEvent) -> tu
+00023f50: 706c 655b 4469 7244 656c 6574 6564 4576  ple[DirDeletedEv
+00023f60: 656e 742c 2044 6972 4372 6561 7465 6445  ent, DirCreatedE
+00023f70: 7665 6e74 5d3a 0a20 2020 202e 2e2e 0a0a  vent]:.    .....
+00023f80: 0a64 6566 2073 706c 6974 5f6d 6f76 6564  .def split_moved
+00023f90: 5f65 7665 6e74 280a 2020 2020 6576 656e  _event(.    even
+00023fa0: 743a 2046 696c 654d 6f76 6564 4576 656e  t: FileMovedEven
+00023fb0: 7420 7c20 4469 724d 6f76 6564 4576 656e  t | DirMovedEven
+00023fc0: 742c 0a29 202d 3e20 7475 706c 655b 4669  t,.) -> tuple[Fi
+00023fd0: 6c65 5379 7374 656d 4576 656e 742c 2046  leSystemEvent, F
+00023fe0: 696c 6553 7973 7465 6d45 7665 6e74 5d3a  ileSystemEvent]:
+00023ff0: 0a20 2020 2022 2222 0a20 2020 2053 706c  .    """.    Spl
+00024000: 6974 7320 6120 4669 6c65 4d6f 7665 6445  its a FileMovedE
+00024010: 7665 6e74 206f 7220 4469 724d 6f76 6564  vent or DirMoved
+00024020: 4576 656e 7420 696e 746f 2022 6465 6c65  Event into "dele
+00024030: 7465 6422 2061 6e64 2022 6372 6561 7465  ted" and "create
+00024040: 6422 2065 7665 6e74 7320 6f66 2074 6865  d" events of the
+00024050: 0a20 2020 2073 616d 6520 7479 7065 2e20  .    same type. 
+00024060: 4120 6e65 7720 6174 7472 6962 7574 6520  A new attribute 
+00024070: 6060 6d6f 7665 5f69 6460 6020 6973 2061  ``move_id`` is a
+00024080: 6464 6564 2074 6f20 626f 7468 2069 6e73  dded to both ins
+00024090: 7461 6e63 6573 2e0a 0a20 2020 203a 7061  tances...    :pa
+000240a0: 7261 6d20 6576 656e 743a 204f 7269 6769  ram event: Origi
+000240b0: 6e61 6c20 6576 656e 742e 0a20 2020 203a  nal event..    :
+000240c0: 7265 7475 726e 733a 2054 7570 6c65 206f  returns: Tuple o
+000240d0: 6620 6465 6c65 7465 6420 616e 6420 6372  f deleted and cr
+000240e0: 6561 7465 6420 6576 656e 7473 2e0a 2020  eated events..  
+000240f0: 2020 2222 220a 2020 2020 6372 6561 7465    """.    create
+00024100: 645f 6576 656e 745f 636c 733a 2054 7970  d_event_cls: Typ
+00024110: 655b 4669 6c65 5379 7374 656d 4576 656e  e[FileSystemEven
+00024120: 745d 0a20 2020 2064 656c 6574 6564 5f65  t].    deleted_e
+00024130: 7665 6e74 5f63 6c73 3a20 5479 7065 5b46  vent_cls: Type[F
+00024140: 696c 6553 7973 7465 6d45 7665 6e74 5d0a  ileSystemEvent].
+00024150: 2020 2020 6966 2065 7665 6e74 2e69 735f      if event.is_
+00024160: 6469 7265 6374 6f72 793a 0a20 2020 2020  directory:.     
+00024170: 2020 2063 7265 6174 6564 5f65 7665 6e74     created_event
+00024180: 5f63 6c73 203d 2044 6972 4372 6561 7465  _cls = DirCreate
+00024190: 6445 7665 6e74 0a20 2020 2020 2020 2064  dEvent.        d
+000241a0: 656c 6574 6564 5f65 7665 6e74 5f63 6c73  eleted_event_cls
+000241b0: 203d 2044 6972 4465 6c65 7465 6445 7665   = DirDeletedEve
+000241c0: 6e74 0a20 2020 2065 6c73 653a 0a20 2020  nt.    else:.   
+000241d0: 2020 2020 2063 7265 6174 6564 5f65 7665       created_eve
+000241e0: 6e74 5f63 6c73 203d 2046 696c 6543 7265  nt_cls = FileCre
+000241f0: 6174 6564 4576 656e 740a 2020 2020 2020  atedEvent.      
+00024200: 2020 6465 6c65 7465 645f 6576 656e 745f    deleted_event_
+00024210: 636c 7320 3d20 4669 6c65 4465 6c65 7465  cls = FileDelete
+00024220: 6445 7665 6e74 0a0a 2020 2020 6465 6c65  dEvent..    dele
+00024230: 7465 645f 6576 656e 7420 3d20 6465 6c65  ted_event = dele
+00024240: 7465 645f 6576 656e 745f 636c 7328 6576  ted_event_cls(ev
+00024250: 656e 742e 7372 635f 7061 7468 290a 2020  ent.src_path).  
+00024260: 2020 6372 6561 7465 645f 6576 656e 7420    created_event 
+00024270: 3d20 6372 6561 7465 645f 6576 656e 745f  = created_event_
+00024280: 636c 7328 6576 656e 742e 6465 7374 5f70  cls(event.dest_p
+00024290: 6174 6829 0a0a 2020 2020 7265 7475 726e  ath)..    return
+000242a0: 2064 656c 6574 6564 5f65 7665 6e74 2c20   deleted_event, 
+000242b0: 6372 6561 7465 645f 6576 656e 740a 0a0a  created_event...
+000242c0: 636c 6173 7320 7066 5f72 6570 723a 0a20  class pf_repr:. 
+000242d0: 2020 2022 2222 0a20 2020 2043 6c61 7373     """.    Class
+000242e0: 2074 6861 7420 7772 6170 7320 616e 206f   that wraps an o
+000242f0: 626a 6563 7420 616e 6420 6372 6561 7465  bject and create
+00024300: 7320 6120 7072 6574 7479 2066 6f72 6d61  s a pretty forma
+00024310: 7474 6564 2072 6570 7265 7365 6e74 6174  tted representat
+00024320: 696f 6e20 666f 7220 6974 2e0a 2020 2020  ion for it..    
+00024330: 5468 6973 2063 616e 2062 6520 7573 6564  This can be used
+00024340: 2074 6f20 6765 7420 7072 6574 7479 2066   to get pretty f
+00024350: 6f72 6d61 7474 696e 6720 696e 206c 6f67  ormatting in log
+00024360: 206d 6573 7361 6765 7320 7768 696c 6520   messages while 
+00024370: 6465 6665 7272 696e 6720 7468 6520 6163  deferring the ac
+00024380: 7475 616c 0a20 2020 2066 6f72 6d61 7474  tual.    formatt
+00024390: 696e 6720 756e 7469 6c20 7468 6520 6d65  ing until the me
+000243a0: 7373 6167 6520 6973 2063 7265 6174 6564  ssage is created
+000243b0: 2e0a 0a20 2020 203a 7061 7261 6d20 6f62  ...    :param ob
+000243c0: 6a3a 204f 626a 6563 7420 746f 2077 7261  j: Object to wra
+000243d0: 702e 0a20 2020 2022 2222 0a0a 2020 2020  p..    """..    
+000243e0: 6465 6620 5f5f 696e 6974 5f5f 2873 656c  def __init__(sel
+000243f0: 662c 206f 626a 3a20 416e 7929 202d 3e20  f, obj: Any) -> 
+00024400: 4e6f 6e65 3a0a 2020 2020 2020 2020 7365  None:.        se
+00024410: 6c66 2e6f 626a 203d 206f 626a 0a0a 2020  lf.obj = obj..  
+00024420: 2020 6465 6620 5f5f 7265 7072 5f5f 2873    def __repr__(s
+00024430: 656c 6629 202d 3e20 7374 723a 0a20 2020  elf) -> str:.   
+00024440: 2020 2020 2072 6574 7572 6e20 7066 6f72       return pfor
+00024450: 6d61 7428 7365 6c66 2e6f 626a 290a 0a0a  mat(self.obj)...
+00024460: 6465 6620 6368 6563 6b5f 656e 636f 6469  def check_encodi
+00024470: 6e67 286c 6f63 616c 5f70 6174 683a 2073  ng(local_path: s
+00024480: 7472 2920 2d3e 204e 6f6e 653a 0a20 2020  tr) -> None:.   
+00024490: 2022 2222 0a20 2020 2056 616c 6964 6174   """.    Validat
+000244a0: 6520 7468 6174 2074 6865 2070 6174 6820  e that the path 
+000244b0: 636f 6e74 6169 6e73 206f 6e6c 7920 6368  contains only ch
+000244c0: 6172 6163 7465 7273 2069 6e20 7468 6520  aracters in the 
+000244d0: 7265 706f 7274 6564 2066 696c 6520 7379  reported file sy
+000244e0: 7374 656d 0a20 2020 2065 6e63 6f64 696e  stem.    encodin
+000244f0: 672e 204f 6e20 556e 6978 2c20 7061 7468  g. On Unix, path
+00024500: 7320 6172 6520 6675 6e64 616d 656e 7461  s are fundamenta
+00024510: 6c6c 7920 6279 7465 7320 616e 6420 736f  lly bytes and so
+00024520: 6d65 2070 6c61 7466 6f72 6d73 2064 6f20  me platforms do 
+00024530: 6e6f 7420 656e 666f 7263 650a 2020 2020  not enforce.    
+00024540: 6120 756e 6966 6f72 6d20 656e 636f 6469  a uniform encodi
+00024550: 6e67 206f 6620 6669 6c65 206e 616d 6573  ng of file names
+00024560: 2064 6573 7069 7465 2072 6570 6f72 7469   despite reporti
+00024570: 6e67 2061 2066 696c 6520 7379 7374 656d  ng a file system
+00024580: 2065 6e63 6f64 696e 672e 2053 7563 680a   encoding. Such.
+00024590: 2020 2020 7061 7468 7320 7769 6c6c 2062      paths will b
+000245a0: 6520 6861 6e64 6564 2074 6f20 7573 2069  e handed to us i
+000245b0: 6e20 5079 7468 6f6e 2077 6974 6820 2273  n Python with "s
+000245c0: 7572 726f 6761 7465 2065 7363 6170 6573  urrogate escapes
+000245d0: 2220 696e 2070 6c61 6365 206f 6620 7468  " in place of th
+000245e0: 650a 2020 2020 756e 6b6e 6f77 6e20 6368  e.    unknown ch
+000245f0: 6172 6163 7465 7273 2e0a 0a20 2020 2053  aracters...    S
+00024600: 696e 6365 2074 6865 2044 726f 7062 6f78  ince the Dropbox
+00024610: 2041 5049 2061 6e64 206f 7572 2064 6174   API and our dat
+00024620: 6162 6173 6520 626f 7468 2072 6571 7569  abase both requi
+00024630: 7265 2075 7466 2d38 2065 6e63 6f64 6564  re utf-8 encoded
+00024640: 2070 6174 6873 2c20 7765 2075 7365 2074   paths, we use t
+00024650: 6869 730a 2020 2020 6d65 7468 6f64 2074  his.    method t
+00024660: 6f20 6368 6563 6b20 616e 6420 6661 696c  o check and fail
+00024670: 2065 6172 6c79 206f 6e20 756e 6b6e 6f77   early on unknow
+00024680: 6e20 6368 6172 6163 7465 7273 2e0a 0a20  n characters... 
+00024690: 2020 203a 7061 7261 6d20 6c6f 6361 6c5f     :param local_
+000246a0: 7061 7468 3a20 5061 7468 2074 6f20 6368  path: Path to ch
+000246b0: 6563 6b2e 0a20 2020 203a 7261 6973 6573  eck..    :raises
+000246c0: 2050 6174 6845 7272 6f72 3a20 6966 2074   PathError: if t
+000246d0: 6865 2070 6174 6820 636f 6e74 6169 6e73  he path contains
+000246e0: 2063 6861 7261 6374 6572 7320 7769 7468   characters with
+000246f0: 2061 6e20 756e 6b6e 6f77 6e20 656e 636f   an unknown enco
+00024700: 6469 6e67 2e0a 2020 2020 2222 220a 2020  ding..    """.  
+00024710: 2020 7472 793a 0a20 2020 2020 2020 206c    try:.        l
+00024720: 6f63 616c 5f70 6174 682e 656e 636f 6465  ocal_path.encode
+00024730: 2829 0a20 2020 2065 7863 6570 7420 556e  ().    except Un
+00024740: 6963 6f64 6545 6e63 6f64 6545 7272 6f72  icodeEncodeError
+00024750: 3a0a 2020 2020 2020 2020 6673 5f65 6e63  :.        fs_enc
+00024760: 6f64 696e 6720 3d20 7379 732e 6765 7466  oding = sys.getf
+00024770: 696c 6573 7973 7465 6d65 6e63 6f64 696e  ilesystemencodin
+00024780: 6728 290a 2020 2020 2020 2020 6572 726f  g().        erro
+00024790: 7220 3d20 5061 7468 4572 726f 7228 0a20  r = PathError(. 
+000247a0: 2020 2020 2020 2020 2020 2022 436f 756c             "Coul
+000247b0: 6420 6e6f 7420 7570 6c6f 6164 2069 7465  d not upload ite
+000247c0: 6d22 2c0a 2020 2020 2020 2020 2020 2020  m",.            
+000247d0: 6622 5468 6520 6669 6c65 206e 616d 6520  f"The file name 
+000247e0: 636f 6e74 6169 6e73 2063 6861 7261 6374  contains charact
+000247f0: 6572 7320 6f75 7473 6964 6520 7468 6520  ers outside the 
+00024800: 220a 2020 2020 2020 2020 2020 2020 6622  ".            f"
+00024810: 7b66 735f 656e 636f 6469 6e67 7d20 656e  {fs_encoding} en
+00024820: 636f 6469 6e67 206f 6620 796f 7572 2066  coding of your f
+00024830: 696c 6520 7379 7374 656d 222c 0a20 2020  ile system",.   
+00024840: 2020 2020 2029 0a20 2020 2020 2020 2065       ).        e
+00024850: 7272 6f72 2e6c 6f63 616c 5f70 6174 6820  rror.local_path 
+00024860: 3d20 6c6f 6361 6c5f 7061 7468 0a20 2020  = local_path.   
+00024870: 2020 2020 2072 6169 7365 2065 7272 6f72       raise error
+00024880: 0a0a 0a64 6566 2063 6865 636b 5f63 6861  ...def check_cha
+00024890: 6e67 655f 7479 7065 2865 7665 6e74 3a20  nge_type(event: 
+000248a0: 5379 6e63 4576 656e 742c 2061 6c6c 6f77  SyncEvent, allow
+000248b0: 6564 5f63 6861 6e67 655f 7479 7065 733a  ed_change_types:
+000248c0: 2073 6574 5b43 6861 6e67 6554 7970 655d   set[ChangeType]
+000248d0: 2920 2d3e 204e 6f6e 653a 0a20 2020 2022  ) -> None:.    "
+000248e0: 2222 0a20 2020 2043 6865 636b 2069 6620  "".    Check if 
+000248f0: 7468 6520 7379 6e63 2065 7665 6e74 2068  the sync event h
+00024900: 6173 206f 6e65 206f 6620 7061 7373 6564  as one of passed
+00024910: 2061 6c6c 6f77 6564 5f63 6861 6e67 655f   allowed_change_
+00024920: 7479 7065 732e 0a0a 2020 2020 3a70 6172  types...    :par
+00024930: 616d 2065 7665 6e74 3a20 5379 6e63 4576  am event: SyncEv
+00024940: 656e 7420 746f 2063 6865 636b 2e0a 2020  ent to check..  
+00024950: 2020 3a70 6172 616d 2061 6c6c 6f77 6564    :param allowed
+00024960: 5f63 6861 6e67 655f 7479 7065 733a 2053  _change_types: S
+00024970: 6574 206f 6620 616c 6c6f 7765 6420 6368  et of allowed ch
+00024980: 616e 6765 2074 7970 6573 2e0a 2020 2020  ange types..    
+00024990: 3a72 6169 7365 7320 5661 6c75 6545 7272  :raises ValueErr
+000249a0: 6f72 3a20 4966 2074 6865 2063 6861 6e67  or: If the chang
+000249b0: 6520 7479 7065 2069 7320 6e6f 7420 696e  e type is not in
+000249c0: 2074 6865 2061 6c6c 6f77 206c 6973 742e   the allow list.
+000249d0: 0a20 2020 2022 2222 0a20 2020 2069 6620  .    """.    if 
+000249e0: 6576 656e 742e 6368 616e 6765 5f74 7970  event.change_typ
+000249f0: 6520 6e6f 7420 696e 2061 6c6c 6f77 6564  e not in allowed
+00024a00: 5f63 6861 6e67 655f 7479 7065 733a 0a20  _change_types:. 
+00024a10: 2020 2020 2020 2072 6169 7365 2056 616c         raise Val
+00024a20: 7565 4572 726f 7228 0a20 2020 2020 2020  ueError(.       
+00024a30: 2020 2020 2066 2252 6571 7569 7265 2063       f"Require c
+00024a40: 6861 6e67 655f 7479 7065 2069 6e20 7b61  hange_type in {a
+00024a50: 6c6c 6f77 6564 5f63 6861 6e67 655f 7479  llowed_change_ty
+00024a60: 7065 737d 2062 7574 2022 0a20 2020 2020  pes} but ".     
+00024a70: 2020 2020 2020 2066 2266 6f75 6e64 207b         f"found {
+00024a80: 6576 656e 742e 6368 616e 6765 5f74 7970  event.change_typ
+00024a90: 657d 220a 2020 2020 2020 2020 290a       e}".        ).
```

### Comparing `maestral-1.7.3.dev2/src/maestral/utils/__init__.py` & `maestral-1.7.3.dev3/src/maestral/utils/__init__.py`

 * *Files 8% similar despite different names*

```diff
@@ -4,28 +4,30 @@
 
 import os
 from types import TracebackType
 from typing import Iterator, TypeVar, Optional, Iterable, Tuple, Type
 
 from packaging.version import Version
 
+from .path import normalize
+
 
 _N = TypeVar("_N", float, int)
 _T = TypeVar("_T")
 _ExecInfoType = Tuple[Type[BaseException], BaseException, Optional[TracebackType]]
 
 
 def natural_size(num: float, unit: str = "B", sep: bool = True) -> str:
     """
     Convert number to a human-readable string with decimal prefix.
 
     :param float num: Value in given unit.
     :param unit: Unit suffix.
     :param sep: Whether to separate unit and value with a space.
-    :returns: Human readable string with decimal prefixes.
+    :returns: Human-readable string with decimal prefixes.
     """
     sep_char = " " if sep else ""
 
     for prefix in ("", "K", "M", "G"):
         if abs(num) < 1000.0:
             return f"{num:3.1f}{sep_char}{prefix}{unit}"
         num /= 1000.0
@@ -82,29 +84,37 @@
     releases = [r for r in releases if not Version(r).is_prerelease]
     releases.sort(key=Version)
     latest_release = releases[-1]
 
     return latest_release if Version(version) < Version(latest_release) else None
 
 
-def removeprefix(string: str, prefix: str) -> str:
+def removeprefix(string: str, prefix: str, case_sensitive: bool = True) -> str:
     """
     Removes the given prefix from a string. Only the first instance of the prefix is
     removed. The original string is returned if it does not start with the given prefix.
 
     This follows the Python 3.9 implementation of ``str.removeprefix``.
 
     :param string: Original string.
     :param prefix: Prefix to remove.
+    :param case_sensitive: Whether to do case-sensitive prefix removal.
     :returns: String without prefix.
     """
-    if string.startswith(prefix):
+    if case_sensitive:
+        string_lower = string
+        prefix_lower = prefix
+    else:
+        string_lower = normalize(string)
+        prefix_lower = normalize(prefix)
+
+    if string_lower.startswith(prefix_lower):
         return string[len(prefix) :]
     else:
-        return string[:]
+        raise ValueError(f'"{string}" does not start with "{prefix}"')
 
 
 def sanitize_string(string: str) -> str:
     """
     Converts a string provided by file system APIs, which may contain surrogate escapes
     for bytes with unknown encoding, to a string which can always be displayed or
     printed. This is done by replacing invalid characters with "�".
```

### Comparing `maestral-1.7.3.dev2/src/maestral/utils/appdirs.py` & `maestral-1.7.3.dev3/src/maestral/utils/appdirs.py`

 * *Files identical despite different names*

### Comparing `maestral-1.7.3.dev2/src/maestral/utils/caches.py` & `maestral-1.7.3.dev3/src/maestral/utils/caches.py`

 * *Files identical despite different names*

### Comparing `maestral-1.7.3.dev2/src/maestral/utils/hashing.py` & `maestral-1.7.3.dev3/src/maestral/utils/hashing.py`

 * *Files identical despite different names*

### Comparing `maestral-1.7.3.dev2/src/maestral/utils/integration.py` & `maestral-1.7.3.dev3/src/maestral/utils/integration.py`

 * *Files identical despite different names*

### Comparing `maestral-1.7.3.dev2/src/maestral/utils/path.py` & `maestral-1.7.3.dev3/src/maestral/utils/path.py`

 * *Files 3% similar despite different names*

```diff
@@ -26,39 +26,49 @@
 
 
 _AnyPath = Union[str, bytes, "os.PathLike[str]", "os.PathLike[bytes]"]
 
 # ==== path relationships ==============================================================
 
 
-def is_child(path: str, parent: str) -> bool:
+def is_child(path: str, parent: str, case_sensitive: bool = True) -> bool:
     """
     Checks if ``path`` semantically is inside ``parent``. Neither path needs to
     refer to an actual item on the drive. This function is case-sensitive.
 
     :param path: Item path.
     :param parent: Parent path.
+    :param case_sensitive: Whether to do case-sensitive checks.
     :returns: Whether ``path`` semantically lies inside ``parent``.
     """
+    if not case_sensitive:
+        path = normalize(path)
+        parent = normalize(parent)
+
     parent = parent.rstrip(osp.sep) + osp.sep
     path = path.rstrip(osp.sep)
 
     return path.startswith(parent)
 
 
-def is_equal_or_child(path: str, parent: str) -> bool:
+def is_equal_or_child(path: str, parent: str, case_sensitive: bool = True) -> bool:
     """
     Checks if ``path`` semantically is inside ``parent`` or equals ``parent``. Neither
     path needs to refer to an actual item on the drive. This function is case-sensitive.
 
     :param path: Item path.
     :param parent: Parent path.
+    :param case_sensitive: Whether to do case-sensitive checks.
     :returns: ``True`` if ``path`` semantically lies inside ``parent`` or
         ``path == parent``.
     """
+    if not case_sensitive:
+        path = normalize(path)
+        parent = normalize(parent)
+
     return is_child(path, parent) or path == parent
 
 
 # ==== case sensitivity and normalization ==============================================
 
 
 def normalize_case(string: str) -> str:
@@ -215,14 +225,18 @@
     Returns a cased version of the given path if corresponding nodes (with arbitrary
     casing) exist in the given root directory. If multiple matches are found, only one
     is returned.
 
     This is similar to :func:`get_existing_equivalent_paths` but returns only the first
     candidate or raises a :class:`FileNotFoundError` if no candidates can be found.
 
+    If the file system is not case-sensitive but case-preserving, this function
+    effectively returns the "displayed" version of a path, as used for example in file
+    managers.
+
     On macOS, we use fcntl F_GETPATH for a more efficient implementation.
 
     :param path: Original path relative to ``root``.
     :param root: Parent directory to search in. There are significant performance
         improvements if a root directory with a small tree is given.
     :param norm_func: Normalization function to use. Defaults to :func:`normalize`.
     :returns: Absolute and cased version of given path.
```

### Comparing `maestral-1.7.3.dev2/src/maestral.egg-info/PKG-INFO` & `maestral-1.7.3.dev3/src/maestral.egg-info/PKG-INFO`

 * *Files 0% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 Metadata-Version: 2.1
 Name: maestral
-Version: 1.7.3.dev2
+Version: 1.7.3.dev3
 Summary: Open-source Dropbox client for macOS and Linux.
 Author-email: Sam Schott <sam.schott@outlook.com>
 License: MIT
 Project-URL: Homepage, https://maestral.app
 Classifier: License :: OSI Approved :: MIT License
 Classifier: Operating System :: Unix
 Classifier: Programming Language :: Python
```

### Comparing `maestral-1.7.3.dev2/src/maestral.egg-info/SOURCES.txt` & `maestral-1.7.3.dev3/src/maestral.egg-info/SOURCES.txt`

 * *Files identical despite different names*

### Comparing `maestral-1.7.3.dev2/src/maestral.egg-info/requires.txt` & `maestral-1.7.3.dev3/src/maestral.egg-info/requires.txt`

 * *Files 8% similar despite different names*

```diff
@@ -19,27 +19,27 @@
 rubicon-objc>=0.4.1
 
 [dev]
 bump2version
 maestral[lint,test]
 
 [docs]
-sphinx
-sphinxext-opengraph
-sphinx-autoapi
-sphinx-mdinclude
-sphinx_rtd_theme
+furo==2023.5.20
+sphinx==7.0.1
+sphinxext-opengraph==0.8.2
+sphinx-autoapi==2.1.0
+sphinx-mdinclude==0.5.3
 
 [gui]
 
 [gui:sys_platform == "darwin"]
-maestral-cocoa>=1.7.3.dev2
+maestral-cocoa>=1.7.3.dev3
 
 [gui:sys_platform == "linux"]
-maestral-qt>=1.7.3.dev2
+maestral-qt>=1.7.3.dev3
 
 [lint]
 black
 flake8
 flake8-pyproject
 mypy
 pyupgrade
```

